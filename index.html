<html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitzball FFX Remastered</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700;900&display=swap');

:root {
    /* --- THE SPIRAN PALETTE --- */
    --ffx-blue-deep: #010205;       /* Void */
    --ffx-blue-dark: #081226;       /* Midnight Depth */
    --ffx-blue-mid: #16325B;        /* Zanarkand Sea */
    --ffx-blue-light: #3b75ba;      /* Sphere Water */
    
    --ffx-cyan: #00f2ff;            /* Spirit Energy */
    --ffx-cyan-glow: #a2f9ff;       /* Pyrefly Core */
    --ffx-cyan-dim: #005f73;        /* Deep Magic */

    --ffx-gold: #c5a059;            /* Yevon Script */
    --ffx-gold-light: #fceeb5;      /* Holy Aura */
    --ffx-gold-dark: #7a5c22;       /* Aged Relic */
    
    --ffx-glass-bg: rgba(6, 12, 24, 0.85);
    --ffx-glass-border: rgba(0, 242, 255, 0.25);
    
    /* Typography */
    --font-title: 'Cinzel', 'Garamond', serif;
    --font-data: 'Impact', 'Arial Narrow', sans-serif;
    --font-ui: 'Courier New', monospace;
    --font-spira: 'Spira', 'Impact', sans-serif;
}

@font-face {
    font-family: 'Spira';
    src: url('https://files.catbox.moe/zyn7s3.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

html, body {
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    width: 100vw;
    height: 100%;
    position: fixed; 
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    font-family: var(--font-data);
    color: white;
    user-select: none;
    -webkit-user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

* {
    box-sizing: border-box;
}
/* --- SPIRAN UTILITIES --- */

/* Global Keyframes */
@keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
}

@keyframes pulse-glow {
    0% { box-shadow: 0 0 5px var(--ffx-cyan-dim); }
    50% { box-shadow: 0 0 20px var(--ffx-cyan), 0 0 10px var(--ffx-blue-light); }
    100% { box-shadow: 0 0 5px var(--ffx-cyan-dim); }
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
}

@keyframes holographic-flicker {
    0% { opacity: 0.95; }
    5% { opacity: 0.8; }
    10% { opacity: 0.95; }
    100% { opacity: 0.95; }
}

/* Glass Panel Utility - The Foundation of the UI */
.glass-panel {
    background: linear-gradient(160deg, rgba(6, 12, 24, 0.9) 0%, rgba(10, 25, 50, 0.8) 100%);
    backdrop-filter: blur(16px) saturate(120%);
    -webkit-backdrop-filter: blur(16px) saturate(120%);
    
    border: 1px solid rgba(0, 242, 255, 0.1);
    border-top: 1px solid rgba(0, 242, 255, 0.3);
    border-bottom: 1px solid rgba(0, 242, 255, 0.05);
    
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.6),
        inset 0 0 30px rgba(0, 242, 255, 0.05);
        
    position: relative;
    overflow: hidden;
    
    /* Asymmetric Cut - FFX Style */
    clip-path: polygon(
        0 0, 
        100% 0, 
        100% 85%, 
        95% 100%, 
        0 100%
    );
}

/* Shimmer Effect for Glass Panels */
.glass-panel::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(
        105deg, 
        transparent 20%, 
        rgba(255, 255, 255, 0.05) 40%, 
        rgba(0, 242, 255, 0.1) 45%, 
        rgba(255, 255, 255, 0.05) 50%, 
        transparent 70%
    );
    background-size: 200% 100%;
    animation: shimmer 8s infinite linear;
    pointer-events: none;
    mix-blend-mode: overlay;
}

/* Decorative Corner Accent */
.glass-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--ffx-cyan), transparent);
    opacity: 0.7;
    box-shadow: 0 0 10px var(--ffx-cyan);
}
/* --- MAIN GAME CONTAINER --- */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    background: #000510;
    box-shadow: none;
    overflow: hidden;
    transition: filter 0.05s;
    z-index: 1;
    contain: strict;
}

/* --- IMPACT FX --- */
/* --- IMPACT FX (JUICED) --- */
#game-container.impact-fx {
    animation: impactShake 0.15s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(1.3) brightness(1.2) saturate(1.2);
    will-change: transform, filter;
}

#game-container.impact-heavy {
    animation: impactHeavy 0.25s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(1.5) brightness(1.3) saturate(1.5) sepia(0.2);
    will-change: transform, filter;
}

#game-container.impact-shatter {
    animation: impactShatter 0.5s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(2.0) brightness(1.5) saturate(2.0) invert(0.05);
    will-change: transform, filter;
}

@keyframes impactShake {
    0% { transform: translate3d(0, 0, 0); }
    25% { transform: translate3d(-3px, 2px, 0) scale(1.01); }
    50% { transform: translate3d(3px, -2px, 0) scale(1.01); }
    75% { transform: translate3d(-3px, -2px, 0) scale(1.01); }
    100% { transform: translate3d(0, 0, 0) scale(1); }
}

@keyframes impactHeavy {
    0% { transform: translate3d(0, 0, 0) scale(1); }
    10% { transform: translate3d(-6px, 4px, 0) scale(1.02); }
    30% { transform: translate3d(6px, -4px, 0) scale(1.02); }
    50% { transform: translate3d(-4px, -2px, 0) scale(1.04); filter: contrast(1.8) brightness(1.5); }
    70% { transform: translate3d(4px, 2px, 0) scale(1.02); }
    100% { transform: translate3d(0, 0, 0) scale(1); }
}

@keyframes impactShatter {
    0% { transform: translate3d(0, 0, 0) scale(1); filter: hue-rotate(0deg); }
    10% { transform: translate3d(-10px, 5px, 0) scale(1.05) skewX(2deg); filter: hue-rotate(45deg) contrast(2.5); }
    20% { transform: translate3d(10px, -5px, 0) scale(1.05) skewX(-2deg); filter: hue-rotate(-45deg); }
    40% { transform: translate3d(0, 0, 0) scale(1.1); filter: invert(0.2); }
    60% { transform: translate3d(-5px, 0, 0) scale(1.05); }
    100% { transform: translate3d(0, 0, 0) scale(1); filter: hue-rotate(0deg); }
}

/* --- CANVAS & RENDER --- */
canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    image-rendering: pixelated; 
    z-index: 0;
}

/* --- GIF OVERLAY --- */
#screen-overlay-gif {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    mix-blend-mode: overlay;
    opacity: 1.0;
    pointer-events: none;
    z-index: 950;
    image-rendering: pixelated;
}

#ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1000;
    contain: strict;
}

/* --- CINEMATIC BARS --- */
#cinematic-bars .bar {
    position: absolute;
    left: 0; width: 100%; height: 0;
    background: black;
    transition: height 0.5s ease;
    z-index: 800;
}
#cinematic-bars .bar.top { top: 0; }
#cinematic-bars .bar.bottom { bottom: 0; }

/* --- TECH FLASH OVERLAY --- */
/* --- TECH FLASH OVERLAY (LIMIT BREAK STYLE) --- */
#tech-flash-overlay {
    position: absolute;
    top: 25%; left: 0; width: 100%; height: 150px;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* Limit Break Gradient */
    background: linear-gradient(90deg, 
        rgba(0,0,0,0) 0%, 
        rgba(50, 0, 0, 0.8) 20%, 
        rgba(100, 20, 0, 0.9) 50%, 
        rgba(50, 0, 0, 0.8) 80%, 
        rgba(0,0,0,0) 100%
    );
    z-index: 2200;
    backdrop-filter: blur(4px);
    border-top: 2px solid rgba(255, 100, 0, 0.5);
    border-bottom: 2px solid rgba(255, 100, 0, 0.5);
    transform: skewX(-15deg);
    box-shadow: 0 0 50px rgba(255, 50, 0, 0.3);
    animation: limitBreakEnter 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes limitBreakEnter {
    0% { transform: skewX(-15deg) scaleY(0); opacity: 0; }
    100% { transform: skewX(-15deg) scaleY(1); opacity: 1; }
}

/* Shatter Lines (Pseudo-elements) */
#tech-flash-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: repeating-linear-gradient(
        45deg,
        transparent 0,
        transparent 10px,
        rgba(255, 255, 255, 0.05) 10px,
        rgba(255, 255, 255, 0.05) 20px
    );
    pointer-events: none;
    mix-blend-mode: overlay;
}

.tech-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: skewX(15deg); /* Counter-skew text */
    position: relative;
    z-index: 2;
}

.tech-text {
    font-family: var(--font-title); /* Cinzel */
    font-weight: 900;
    font-size: clamp(40px, 12vw, 64px);
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 5px;
    line-height: 1.0;
    
    /* Limit Break Gold/White Gradient */
    background: linear-gradient(to bottom, #ffffff 0%, #ffffaa 40%, #ffaa00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8)) drop-shadow(0 0 20px rgba(255, 0, 0, 0.4));
    
    animation: limitTextPulse 0.1s infinite alternate;
    text-align: center;
    margin-bottom: 5px;
}

@keyframes limitTextPulse {
    0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8)); }
    100% { transform: scale(1.05); filter: drop-shadow(0 0 20px rgba(255, 200, 0, 1.0)); }
}

.tech-sub-text {
    font-family: var(--font-spira);
    font-size: 16px;
    color: #00ffff;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 10px;
    text-shadow: 0 0 10px #00ffff;
    background: rgba(0, 0, 0, 0.5);
    padding: 2px 10px;
    border: 1px solid rgba(0, 255, 255, 0.3);
}

.tech-timer-track {
    width: 300px;
    height: 12px;
    background: rgba(20, 0, 0, 0.8);
    border: 1px solid #ff4400;
    border-radius: 2px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(255, 68, 0, 0.4);
    position: relative;
}

.tech-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffaa00, #ffff00, #ffffff);
    width: 100%;
    transform-origin: left;
    box-shadow: 0 0 20px #ffaa00;
    position: relative;
}

/* Shimmer on bar */
.tech-timer-fill::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    animation: shimmer 0.5s infinite linear;
}

/* --- HUD TOP --- */
/* --- HUD TOP (CRYSTAL HUD) --- */
#hud-top {
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    padding: 10px 20px;
    padding-top: max(10px, env(safe-area-inset-top));
    padding-left: max(20px, env(safe-area-inset-left));
    padding-right: max(20px, env(safe-area-inset-right));
    box-sizing: border-box;
    background: none; /* Removed flat gradient */
    pointer-events: none;
    transition: opacity 0.5s;
    overflow: visible;
    z-index: 1000;
}

/* Mist Layer */
.hud-mist {
    position: absolute;
    top: -50px; left: 0; width: 100%; height: 200px;
    background: radial-gradient(50% 100% at 50% 0%, rgba(0, 242, 255, 0.15) 0%, transparent 100%);
    filter: blur(20px);
    z-index: -1;
    animation: mistPulse 6s ease-in-out infinite alternate;
    pointer-events: none;
}

@keyframes mistPulse {
    0% { opacity: 0.4; transform: scaleY(1); }
    100% { opacity: 0.7; transform: scaleY(1.2); }
}

/* Team Wing (Crystal Shard) */
.team-wing {
    position: relative;
    width: 180px; height: 65px;
    background: linear-gradient(160deg, rgba(6, 12, 24, 0.9) 0%, rgba(22, 50, 91, 0.8) 100%);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    
    /* Asymmetric Shard Shape */
    clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%);
    
    display: flex;
    align-items: center;
    padding: 0 15px 0 25px;
    margin-top: 10px;
    
    /* Glow */
    filter: drop-shadow(0 0 8px rgba(0, 242, 255, 0.4));
    transform: translateZ(0); /* Force GPU */
}

/* Inner Shine */
.team-wing::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(105deg, transparent 30%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.2) 50%, transparent 60%);
    mix-blend-mode: overlay;
    animation: shimmer 5s infinite linear;
}

/* Top Glowing Border */
.crystal-border {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--ffx-cyan), transparent);
    z-index: 2;
    box-shadow: 0 0 10px var(--ffx-cyan);
}

/* Away Team Mirror */
.team-wing.away {
    flex-direction: row-reverse;
    background: linear-gradient(200deg, rgba(6, 12, 24, 0.9) 0%, rgba(60, 10, 10, 0.8) 100%);
    clip-path: polygon(0 0, 100% 0, 100% 100%, 15% 100%);
    padding: 0 25px 0 15px;
    filter: drop-shadow(0 0 8px rgba(255, 68, 68, 0.4));
}

.team-wing.away .crystal-border {
    background: linear-gradient(90deg, transparent, #ff4444, transparent);
    box-shadow: 0 0 10px #ff4444;
}

.team-data {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-grow: 1;
}
.team-wing.away .team-data { text-align: right; }

.team-name {
    font-family: var(--font-title);
    font-size: 18px;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 200, 255, 0.8);
    margin-bottom: -2px;
}
.team-sub {
    font-family: var(--font-spira);
    font-size: 10px;
    color: var(--ffx-cyan);
    opacity: 0.9;
    letter-spacing: 3px;
    text-transform: uppercase;
}
.team-wing.away .team-sub { color: #ffaaaa; }

.score-box {
    font-family: var(--font-data);
    font-size: 46px;
    color: white;
    text-shadow: 0 0 20px var(--ffx-cyan-glow);
    min-width: 40px;
    text-align: center;
    line-height: 1.0;
    z-index: 5;
}
.team-wing.away .score-box { text-shadow: 0 0 20px #ff4444; }

/* Timer (Sphere Grid Node) */
.timer-complex {
    position: relative;
    width: 80px; height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 5px;
    
    /* Sphere Look */
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, rgba(40, 80, 120, 0.9) 0%, rgba(5, 10, 20, 0.95) 80%);
    box-shadow: 
        0 0 25px rgba(0, 150, 255, 0.4),
        inset 0 0 15px rgba(0, 242, 255, 0.2);
    border: 1px solid rgba(0, 242, 255, 0.3);
    backdrop-filter: blur(5px);
    z-index: 10;
}

/* Floating Ring */
.timer-crystal-ring {
    position: absolute;
    top: -8px; left: -8px; right: -8px; bottom: -8px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-top: 2px solid var(--ffx-gold);
    border-bottom: 2px solid var(--ffx-gold);
    animation: sphereSpin 8s linear infinite;
    box-shadow: 0 0 10px var(--ffx-gold);
    z-index: -1;
    background: none;
}

@keyframes sphereSpin { 
    from { transform: rotate(0deg); } 
    to { transform: rotate(360deg); } 
}

.timer-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
}

#half-indicator {
    font-family: var(--font-spira);
    font-size: 10px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    margin-bottom: 0;
    text-shadow: 0 0 5px var(--ffx-gold-dark);
    text-transform: uppercase;
}

#timer-display {
    font-family: var(--font-data);
    font-size: 26px;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    letter-spacing: 1px;
    line-height: 1.0;
    margin-top: 2px;
}
/* --- PLAYER STATUS PANEL (LIQUID LIGHT) --- */
#player-status-panel {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 40px);
    left: max(20px, env(safe-area-inset-left));
    width: 200px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(0, 10, 30, 0.85) 0%, rgba(0, 20, 40, 0.6) 100%);
    border: 1px solid rgba(100, 200, 255, 0.2);
    border-left: 4px solid var(--ffx-cyan);
    border-radius: 0 15px 0 15px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transform: skewX(-10deg);
    pointer-events: none;
    display: none; /* Managed by JS */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    overflow: hidden;
}

/* Decorative background shard */
#player-status-panel::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.03) 50%, transparent 55%);
    animation: shimmer 6s infinite linear;
    pointer-events: none;
}

.char-name {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-transform: uppercase;
    margin-bottom: 8px;
    transform: skewX(10deg);
    text-shadow: 0 0 10px var(--ffx-blue-light);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 2px;
    display: flex;
    justify-content: space-between;
}

.hp-gauge-container {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    transform: skewX(10deg);
    position: relative;
}
.hp-label { 
    font-family: var(--font-ui);
    font-size: 10px; 
    color: var(--ffx-cyan); 
    width: 25px; 
    text-shadow: 0 0 5px var(--ffx-cyan);
}
.hp-bar-track {
    flex-grow: 1;
    height: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #334455;
    margin: 0 8px;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
}
.hp-bar-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #00aa44, #44ff88, #00aa44);
    background-size: 200% 100%;
    animation: liquidFlow 3s linear infinite;
    box-shadow: 0 0 10px #00ff44;
    border-radius: 2px;
    transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0);
}
.hp-value { 
    font-family: var(--font-data);
    font-size: 12px; 
    color: #fff; 
    width: 55px; 
    text-align: right; 
    letter-spacing: 1px;
}

.tech-gauge-container {
    display: flex;
    align-items: center;
    transform: skewX(10deg);
}
.tech-label { 
    font-family: var(--font-ui);
    font-size: 10px; 
    color: var(--ffx-gold); 
    width: 25px; 
    text-shadow: 0 0 5px var(--ffx-gold);
}
.tech-bar-track {
    flex-grow: 1;
    height: 4px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #443322;
    margin: 0 8px;
    border-radius: 2px;
    overflow: hidden;
}
.tech-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #aa6600, #ffcc00, #aa6600);
    background-size: 200% 100%;
    animation: liquidFlow 4s linear infinite;
    box-shadow: 0 0 5px #ffaa00;
}

@keyframes liquidFlow {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}
/* --- MINIMAP --- */
#minimap-container {
    position: absolute;
    top: max(80px, env(safe-area-inset-top) + 60px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    height: 110px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.radar-rim {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid var(--ffx-blue-light);
    box-shadow: 0 0 15px var(--ffx-blue-mid), inset 0 0 20px rgba(0,0,0,0.8);
    background: radial-gradient(circle, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    z-index: 5;
}

#minimap {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    z-index: 6;
    overflow: hidden;
}

.radar-label {
    position: absolute;
    bottom: -15px;
    width: 140%;
    left: -20%;
    text-align: center;
    font-family: var(--font-spira);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--ffx-cyan);
}

.map-dot {
    position: absolute;
    width: 6px; height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px currentColor;
}
.map-dot.home { background: var(--ffx-cyan); color: var(--ffx-cyan); }
.map-dot.away { background: #ff4444; color: #ff4444; }
.map-dot.ball { 
    background: #ff00cc;
    color: #ff00cc; 
    width: 12px; height: 12px;
    border: 2px solid #ffffff;
    z-index: 20;
    animation: blinkBall 0.3s infinite alternate;
    box-shadow: 0 0 6px #ff00cc;
}
.map-dot.nap { background: #333; color: #000; border: 1px solid #555; }
.map-dot.active-player { 
    background: #00ff00 !important; 
    color: #00ff00 !important; 
    box-shadow: 0 0 8px #00ff00;
    z-index: 15;
    transform: translate(-50%, -50%) scale(1.2);
}
.map-dot.ball-carrier {
    box-shadow: 0 0 15px #fff, 0 0 30px #ffaa00;
    border: 2px solid #ffffff;
    background-color: #ffaa00 !important;
    z-index: 100;
    width: 10px; height: 10px;
    animation: carrierPulse 0.8s infinite alternate;
}
@keyframes carrierPulse {
    from { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px #fff; opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 25px #ffcc00; opacity: 1.0; }
}
@keyframes blinkBall { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.5; transform: translate(-50%, -50%) scale(1.3); } }

/* --- ANNOUNCEMENTS --- */
#announcement {
    position: absolute;
    top: 40%; 
    left: 5%; 
    width: 90%;
    text-align: center;
    font-family: var(--font-data);
    font-size: clamp(40px, 12vw, 72px);
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.0;
    white-space: normal;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 40%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)) drop-shadow(3px 3px 0 #000);
    display: none;
    z-index: 2000;
    animation: announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    will-change: transform, opacity;
}

@keyframes announceSlide {
    from { transform: scale(0) rotate(-5deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
}

/* --- JOYSTICK (ETHEREAL INTERFACE) --- */
#joystick-hit-zone {
    position: absolute;
    bottom: 0; left: 0;
    width: 50%; height: 50%;
    z-index: 1000;
    background: rgba(0,0,0,0); 
    touch-action: none;
    pointer-events: auto;
}

#joystick-visual-container {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 140px; height: 140px;
    border-radius: 50%;
    /* Ethereal Ring */
    border: 1px dashed rgba(0, 242, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 242, 255, 0.1), inset 0 0 20px rgba(0, 242, 255, 0.05);
    background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0, 242, 255, 0.05) 100%);
    animation: etherealSpin 10s linear infinite;
}

#joystick-base::after {
    content: '';
    position: absolute;
    top: 10%; left: 10%; width: 80%; height: 80%;
    border-radius: 50%;
    border: 1px solid rgba(0, 242, 255, 0.1);
    animation: etherealSpin 5s linear infinite reverse;
}

@keyframes etherealSpin {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

#joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    /* Pyrefly Light */
    background: radial-gradient(circle at 30% 30%, #ffffff 0%, #a2f9ff 40%, #00f2ff 100%);
    box-shadow: 0 0 15px #00f2ff, 0 0 30px #00f2ff;
    transition: transform 0.05s linear;
    will-change: transform;
    opacity: 0.8;
}

#joystick-knob::after {
    content: "";
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.5);
    opacity: 0.5;
    animation: pulse-glow 2s infinite;
}

.touch-ripple {
    position: absolute;
    border-radius: 50%;
    border: 2px solid rgba(0, 242, 255, 0.5);
    background: transparent;
    transform: translate(-50%, -50%) scale(0);
    animation: rippleAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 9000;
    box-shadow: 0 0 10px var(--ffx-cyan);
    will-change: transform, opacity;
}

@keyframes rippleAnim {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 5px; }
    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; border-width: 0px; }
}

#camera-zone {
    position: absolute;
    top: 0; right: 0; width: 50%; height: 100%;
    pointer-events: auto;
    touch-action: none;
    z-index: 50;
}

/* --- ACTION BUTTON (SPHERE GRID NODE) --- */
#action-container {
    position: absolute;
    bottom: max(40px, env(safe-area-inset-bottom)); 
    right: max(40px, env(safe-area-inset-right));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
z-index: 1500;
}
.command-menu-bg {
    position: absolute;
    width: 220px; height: 100px;
    bottom: 20px;
    background: radial-gradient(ellipse at center, rgba(0, 20, 60, 0.8) 0%, transparent 70%);
    z-index: -1;
    pointer-events: none;
}

.command-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 140px; height: 140px;
    border-radius: 50%;
    border: 1px dashed rgba(0, 242, 255, 0.3);
    border-top: 2px solid var(--ffx-cyan);
    border-bottom: 2px solid var(--ffx-cyan);
    animation: spinReverse 20s linear infinite;
    pointer-events: none;
    box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
}
.command-ring::before {
    content: '';
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border-radius: 50%;
    border: 1px dotted rgba(255, 255, 255, 0.2);
    animation: spinReverse 10s linear infinite reverse;
}

@keyframes spinReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

#action-label {
    font-family: var(--font-spira);
    font-size: 14px;
    color: #fff;
    background: rgba(0, 0, 0, 0.6);
    padding: 4px 16px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 12px;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 3px;
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
    text-shadow: 0 0 5px var(--ffx-cyan);
    transition: all 0.3s;
    z-index: 20;
}

/* --- ACTION BUTTON (HERCULEAN SPHERE GRID NODE) --- */
/* --- ACTION BUTTON (HERCULEAN SPHERE GRID NODE) --- */
#action-button {
    position: absolute;
    top: 0; left: 0;
    width: 140px; height: 140px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    /* Deep Shadow & 3D Context */
    box-shadow: 
        0 30px 60px rgba(0, 0, 0, 0.9),
        0 0 0 2px rgba(0, 0, 0, 1.0);
    background: none;
    border: none;
    perspective: 1000px;
    transform-style: preserve-3d;
}

#action-button:active {
    transform: scale(0.95);
}

/* Keyframes for Living UI */
@keyframes ring-gyro-z {
    0% { transform: rotateZ(0deg); }
    100% { transform: rotateZ(360deg); }
}

@keyframes ring-wobble {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    25% { transform: rotateX(10deg) rotateY(5deg); }
    50% { transform: rotateX(0deg) rotateY(10deg); }
    75% { transform: rotateX(-10deg) rotateY(5deg); }
    100% { transform: rotateX(0deg) rotateY(0deg); }
}

@keyframes rune-spin-glow {
    0% { transform: rotate(0deg) scale(1); filter: drop-shadow(0 0 2px var(--ffx-cyan)); opacity: 0.8; }
    50% { transform: rotate(180deg) scale(1.05); filter: drop-shadow(0 0 8px var(--ffx-cyan-glow)); opacity: 1.0; }
    100% { transform: rotate(360deg) scale(1); filter: drop-shadow(0 0 2px var(--ffx-cyan)); opacity: 0.8; }
}

@keyframes liquid-surge-complex {
    0% { transform: scale(0.98); background-position: 0% 50%; border-radius: 50%; box-shadow: 0 0 30px #00aaff, inset 0 0 20px rgba(255, 255, 255, 0.5); }
    50% { transform: scale(1.02); background-position: 100% 50%; border-radius: 49%; box-shadow: 0 0 50px #00ffff, inset 0 0 40px rgba(255, 255, 255, 0.8); }
    100% { transform: scale(0.98); background-position: 0% 50%; border-radius: 50%; box-shadow: 0 0 30px #00aaff, inset 0 0 20px rgba(255, 255, 255, 0.5); }
}

@keyframes crystal-breathe {
    0%, 100% { border-color: rgba(0, 200, 255, 0.3); box-shadow: inset 0 0 20px #000000; }
    50% { border-color: rgba(0, 255, 255, 0.6); box-shadow: inset 0 0 30px #001133, 0 0 15px rgba(0, 255, 255, 0.2); }
}

/* Layer 1: Outer Ornate Ring (Metal/Gold) - The Gyro */
.ab-outer-ring {
    position: absolute;
    top: -8px; left: -8px; right: -8px; bottom: -8px;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        #b8860b, #ffd700, #fffacd, #ffd700, #b8860b, #8b4500, #b8860b
    );
    box-shadow: 
        inset 0 0 10px rgba(0,0,0,0.8),
        0 0 25px rgba(255, 215, 0, 0.3);
    z-index: 1;
    border: 1px solid #553300;
    /* Complex rotation */
    animation: ring-gyro-z 20s linear infinite;
}

/* Pseudo-element for 3D depth/wobble effect on the ring */
.ab-outer-ring::before {
    content: '';
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%;
    border: 2px dashed rgba(255, 215, 0, 0.5);
    animation: ring-wobble 8s ease-in-out infinite;
    pointer-events: none;
}

/* Layer 2: Rune Ring (Spinning) */
.ab-rune-ring {
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%;
    border: 2px dashed rgba(0, 255, 255, 0.6);
    /* box-shadow handled by animation */
    z-index: 2;
    animation: rune-spin-glow 15s linear infinite;
    pointer-events: none;
}

/* Layer 3: Inner Crystal Housing (Dark Glass) */
.ab-inner-crystal {
    position: absolute;
    top: 6px; left: 6px; right: 6px; bottom: 6px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, rgba(0, 10, 30, 0.95) 60%, #000000 100%);
    border: 2px solid rgba(0, 200, 255, 0.3);
    z-index: 3;
    overflow: hidden;
    pointer-events: none;
    animation: crystal-breathe 4s ease-in-out infinite;
}

/* Layer 4: Liquid Core (Animated Surface) */
.ab-liquid-core {
    position: absolute;
    top: 12px; left: 12px; right: 12px; bottom: 12px;
    border-radius: 50%;
    /* Complex Gradient for liquid motion */
    background: radial-gradient(circle at 40% 40%, #00ffff 0%, #0088ff 40%, #002266 100%);
    background-size: 150% 150%;
    z-index: 4;
    animation: liquid-surge-complex 3s ease-in-out infinite;
    pointer-events: none;
}

/* Liquid movement effect (Internal reflection) */
.ab-liquid-core::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.5) 0%, transparent 25%);
    animation: liquidMove 5s infinite ease-in-out;
    mix-blend-mode: overlay;
}

/* Layer 5: Limit Break Ring (Hidden by default) */
.limit-ring {
    position: absolute;
    top: -22px; left: -22px; right: -22px; bottom: -22px;
    border-radius: 50%;
    border: 4px solid transparent;
    border-top-color: #ff4400;
    border-bottom-color: #ffaa00;
    border-left-color: transparent;
    border-right-color: transparent;
    box-shadow: 0 0 40px #ff4400;
    z-index: 0;
    opacity: 0;
    animation: limitSpin 1.5s linear infinite;
    transition: opacity 0.5s;
    pointer-events: none;
}

@keyframes limitSpin {
    0% { transform: rotate(0deg) scale(1); filter: hue-rotate(0deg); }
    50% { transform: rotate(180deg) scale(1.1); filter: hue-rotate(15deg); }
    100% { transform: rotate(360deg) scale(1); filter: hue-rotate(0deg); }
}

/* Layer 6: Text Label */
#action-button .btn-text {
    font-family: var(--font-title);
    font-size: 28px;
    font-weight: 900;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 
        0 2px 0 #000,
        0 0 15px rgba(0, 255, 255, 1.0),
        0 0 30px #0088ff;
    z-index: 6;
    pointer-events: none;
    position: relative;
    top: 1px;
    animation: textFloat 3s ease-in-out infinite;
}

@keyframes textFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

/* Layer 7: Glare */
#action-button .btn-glare {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, transparent 45%, transparent 100%);
    z-index: 7;
    pointer-events: none;
    mix-blend-mode: soft-light;
}

/* STATE: SHOOT MODE (Orange/Red) */
#action-button.shoot-mode .ab-outer-ring {
    background: conic-gradient(
        from 0deg,
        #8b0000, #ff4400, #ffaa00, #ff4400, #8b0000, #440000, #8b0000
    );
    box-shadow: 0 0 50px rgba(255, 68, 0, 0.9);
    animation: ring-gyro-z 5s linear infinite; /* Faster spin */
}

#action-button.shoot-mode .ab-liquid-core {
    background: radial-gradient(circle at 40% 40%, #ffff00 0%, #ff4400 50%, #660000 100%);
    animation: corePulseRed 0.4s ease-in-out infinite alternate;
}

@keyframes corePulseRed {
    0% { transform: scale(0.95); box-shadow: 0 0 40px #ff4400; filter: brightness(1); }
    100% { transform: scale(1.08); box-shadow: 0 0 80px #ffaa00, 0 0 20px #fff; filter: brightness(1.3); }
}

#action-button.shoot-mode .btn-text {
    text-shadow: 0 2px 0 #000, 0 0 20px #ff4400;
}

/* STATE: LIMIT READY (Herculean Gold) */
#action-button.limit-ready .limit-ring {
    opacity: 1;
    border-width: 6px;
    border-top-color: #fff;
    border-bottom-color: #ffd700;
    box-shadow: 0 0 60px #ffaa00, inset 0 0 20px #ff4400;
    animation: limitSpin 0.8s linear infinite, limitPulse 0.3s ease-in-out infinite alternate;
    filter: drop-shadow(0 0 10px #ffffff);
}

@keyframes limitPulse {
    from { opacity: 0.8; box-shadow: 0 0 40px #ff4400, inset 0 0 20px #ffaa00; }
    to { opacity: 1.0; box-shadow: 0 0 80px #ffaa00, inset 0 0 40px #ffff00; }
}

#action-button.limit-ready .ab-outer-ring {
    background: conic-gradient(
        from 0deg,
        #ffd700, #ffffff, #ffaa00, #ffffff, #ffd700, #b8860b, #ffd700
    );
    box-shadow: 0 0 80px rgba(255, 215, 0, 0.8);
    animation: ring-gyro-z 2s linear infinite;
    border: 2px solid #ffffff;
}

#action-button.limit-ready .ab-rune-ring {
    border-color: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 40px #00ffff;
    animation: rune-spin-glow 3s linear infinite reverse;
}

#action-button.limit-ready .ab-liquid-core {
    background: radial-gradient(circle at 50% 50%, #ffffff 0%, #ffff00 20%, #ff8800 60%, #ff0000 100%);
    animation: liquid-surge-complex 0.5s ease-in-out infinite;
    filter: brightness(1.2);
}

#action-button.limit-ready .btn-text {
    color: #ffffff;
    text-shadow: 0 0 10px #ff0000, 0 0 20px #ffff00, 0 0 40px #ffffff;
    animation: textFloat 0.2s ease-in-out infinite alternate;
}

/* STATE: ACTIVE (Charging/Pressed) */
#action-button.active {
    transform: scale(0.95);
}

#action-button.active .ab-liquid-core {
    background: radial-gradient(circle at 50% 50%, #ffffff 40%, #ffffaa 70%, #ffaa00 100%);
    box-shadow: 0 0 80px #ffffff, inset 0 0 50px #ffffff;
    filter: brightness(2.0) contrast(1.2);
    animation: none; /* Solid intense light */
}

#action-button.active .ab-outer-ring {
    animation: ring-gyro-z 0.2s linear infinite; /* Hyper spin */
    filter: brightness(1.5);
    box-shadow: 0 0 100px #ffffff;
}

#action-button.active .limit-ring {
    border-color: #ffffff;
    box-shadow: 0 0 100px #ffffff;
    animation: limitSpin 0.1s linear infinite;
    opacity: 1;
}
/* --- AUTO TOGGLE --- */
#auto-toggle {
    position: absolute;
    top: max(200px, env(safe-area-inset-top) + 60px); 
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 10px 0;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--ffx-cyan);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 5, 10, 0.9) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 1px solid var(--ffx-cyan);
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
z-index: 1500;
}
#auto-toggle:hover {
    background: rgba(0, 40, 80, 0.9);
    box-shadow: 0 0 15px var(--ffx-cyan);
    color: white;
}
#auto-toggle.active {
    background: linear-gradient(135deg, rgba(100, 20, 0, 0.8) 0%, rgba(40, 0, 0, 0.9) 100%);
    border-color: #ff4400;
    color: #ffaa00;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff4400; } 100% { box-shadow: 0 0 5px #ff0000; } }

/* --- FLOATING TEXT --- */
.floating-text-wrapper {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    z-index: 2000;
    will-change: transform;
    contain: layout style;
}

.floating-text-inner {
    display: block;
    font-family: var(--font-data);
    font-weight: 900;
    text-transform: uppercase;
    white-space: nowrap;
    text-align: center;
    font-size: 24px; 
    text-shadow: 1px 1px 0 #000;
    opacity: 0.9;
}

.floating-text-inner.damage {
    font-size: 42px;
    font-style: italic;
    background: linear-gradient(to bottom, #ffffff 0%, #ffcc00 40%, #ff4400 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    animation: popDamage 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.floating-text-inner.heal {
    font-size: 36px;
    color: #44ff44;
    text-shadow: 0 0 10px #00ff00;
    animation: floatUp 1s ease-out forwards;
}

.floating-text-inner.venom {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #aaff00;
    text-shadow: 0 0 10px #448800, 2px 2px 0 #002200;
    background: linear-gradient(to bottom, #ccff66 0%, #66cc00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(100, 255, 0, 0.5));
    animation: dripStatus 2s infinite;
}

.floating-text-inner.sleep {
    font-family: var(--font-title);
    font-size: 42px;
    color: #ffffff;
    text-shadow: 0 0 15px #0044ff, 0 0 30px #0000ff;
    opacity: 0.9;
    animation: driftStatus 3s ease-in-out infinite;
}

.floating-text-inner.wither {
    font-family: var(--font-data);
    font-size: 38px;
    color: #cccccc;
    text-shadow: 2px 2px 0 #444444;
    background: linear-gradient(to bottom, #eeeeee 0%, #888888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.tech {
    font-family: var(--font-title);
    font-size: 32px;
    color: #00ffff;
    background: rgba(0, 10, 30, 0.7);
    padding: 2px 10px;
    border: 1px solid #00ffff;
    border-radius: 4px;
    box-shadow: 0 0 10px #0088ff;
    text-shadow: 0 0 5px #fff;
    animation: shakeTech 0.6s ease-in-out, flashTech 0.3s;
    transform-origin: center;
}

.floating-text-inner.save, .floating-text-inner.block {
    font-size: 48px;
    font-weight: 900;
    color: #ffffff;
    -webkit-text-stroke: 1px #004488;
    text-shadow: 0 0 20px #0088ff;
    animation: popDamage 0.5s ease-out forwards;
}

@keyframes popDamage {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.5); opacity: 1; }
    40% { transform: scale(1.0); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

@keyframes dripStatus {
    0% { transform: scaleY(1); filter: blur(0px); }
    50% { transform: scaleY(1.1) translateY(5px); filter: blur(1px); }
    100% { transform: scaleY(1); filter: blur(0px); }
}

@keyframes driftStatus {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    50% { transform: translateX(15px) translateY(-20px) rotate(10deg); }
    100% { transform: translateX(-15px) translateY(-50px) rotate(-10deg); opacity: 0; }
}

@keyframes witherStatus {
    0% { transform: scale(1); filter: grayscale(0%); opacity: 1; }
    100% { transform: scale(0.6); filter: grayscale(100%); opacity: 0; }
}

@keyframes shakeTech {
    0% { transform: scale(0.8); }
    10%, 30%, 50%, 70%, 90% { transform: scale(1.1) translate(-2px, 2px); }
    20%, 40%, 60%, 80% { transform: scale(1.1) translate(2px, -2px); }
    100% { transform: scale(1.0); }
}

@keyframes flashTech {
    0% { background-color: #fff; color: #000; border-color: #fff; }
    100% { background-color: rgba(0, 10, 30, 0.85); color: #00ffff; border-color: #00ffff; }
}

#loading {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 5px;
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0.5; } }

#controls-hint {
    position: absolute;
    top: 130px; width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    pointer-events: none;
}

.floating-text-inner.comic-impact {
    font-family: 'Impact', sans-serif;
    font-size: 42px;
    color: #ffff00; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 3px 3px 0 #ff0000;
    font-style: italic;
    transform-origin: center;
    white-space: nowrap;
    animation: comicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    z-index: 2500;
}

.floating-text-inner.comic-action {
    font-family: 'Arial Black', sans-serif;
    font-size: 28px;
    color: #00ffff; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 2px 2px 0 #0044aa;
    font-style: italic;
    white-space: nowrap;
    animation: comicSlide 0.4s ease-out forwards;
    z-index: 2500;
}

@keyframes comicPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    60% { transform: scale(1.0) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
}

@keyframes comicSlide {
    0% { transform: translate(-20px, 20px) scale(0.5); opacity: 0; }
    100% { transform: translate(20px, -20px) scale(1.2); opacity: 0; }
}

/* --- MAIN MENU --- */
/* --- MAIN MENU & END GAME (FFX STYLE) --- */
/* --- MAIN MENU (FAYTH INTERFACE) --- */
#main-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-end; /* Asymmetric Right Align */
    padding-right: 10%;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    
    /* Deep Void Background */
    background: radial-gradient(circle at 30% 50%, #051020 0%, #000000 100%);
    overflow: hidden;
}

#main-menu.active {
    opacity: 1;
    pointer-events: auto;
}

/* Scanlines & Vignette */
.menu-bg-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    background: 
        repeating-linear-gradient(
            0deg,
            transparent 0px,
            transparent 2px,
            rgba(0, 255, 255, 0.02) 3px,
            rgba(0, 255, 255, 0.02) 4px
        );
    pointer-events: none;
}
.menu-bg-overlay::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.8) 100%);
}

/* LOGO STYLING */
.ffx-logo-container {
    margin-bottom: 60px;
    text-align: right;
    transform: skewX(-10deg);
    position: relative;
    margin-right: 20px;
}

.ffx-logo-main {
    font-family: var(--font-title);
    font-size: clamp(60px, 12vw, 100px);
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 10px;
    line-height: 0.9;
    
    /* Crystal Gradient */
    background: linear-gradient(180deg, #ffffff 0%, #aaccff 45%, #0088ff 55%, #002266 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    filter: drop-shadow(0 0 20px rgba(0, 150, 255, 0.6));
    animation: logoFloat 4s ease-in-out infinite;
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 20px rgba(0, 150, 255, 0.6)); }
    50% { transform: translateY(-10px); filter: drop-shadow(0 0 30px rgba(0, 200, 255, 0.8)); }
}

.ffx-logo-sub {
    font-family: var(--font-spira);
    font-size: clamp(18px, 4vw, 32px);
    color: var(--ffx-gold);
    letter-spacing: 12px;
    margin-top: 5px;
    text-shadow: 0 0 10px #ffaa00;
    opacity: 0.9;
    text-align: right;
}

/* MENU OPTIONS (Asymmetric List) */
.menu-options {
    display: flex;
    flex-direction: column;
/* MENU OPTIONS (Asymmetric List) */
    width: 400px;
    align-items: flex-end; /* Align items to right */
}

.menu-item {
    position: relative;
    width: 100%;
    padding: 15px 40px 15px 20px;
    
    /* Glass Shard Look */
    background: linear-gradient(270deg, rgba(0, 40, 80, 0.8) 0%, rgba(0, 10, 20, 0.0) 100%);
    border-right: 3px solid rgba(100, 200, 255, 0.3);
    
    cursor: pointer;
/* Glass Shard Look */
    transform: skewX(-15deg);
    
    display: flex;
    justify-content: flex-end;
    align-items: center;
    overflow: visible;
}

.menu-item:hover {
    background: linear-gradient(270deg, rgba(0, 100, 200, 0.9) 0%, rgba(0, 20, 40, 0.2) 100%);
    border-right-color: #00ffff;
    padding-right: 60px; /* Slide left effect */
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
}

.menu-item .label {
    font-family: var(--font-title);
    font-size: 24px;
    color: #aaaaaa;
    letter-spacing: 4px;
    text-transform: uppercase;
    transform: skewX(15deg); /* Counter skew text */
    transition: color 0.2s, text-shadow 0.2s;
}

.menu-item:hover .label {
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0088ff;
}

/* PYREFLY CURSOR */
.menu-item .cursor {
    position: absolute;
    right: 15px;
    width: 12px; height: 12px;
    background: #ffd700;
    border-radius: 50%;
    opacity: 0;
    transform: skewX(15deg) scale(0);
    transition: all 0.3s;
    box-shadow: 
        0 0 10px #ffd700,
        0 0 20px #ffaa00,
        0 0 40px #ff4400;
    pointer-events: none;
}

.menu-item:hover .cursor {
    opacity: 1;
    right: 30px;
    transform: skewX(15deg) scale(1);
    animation: pyreflyWiggle 1s infinite ease-in-out;
}

@keyframes pyreflyWiggle {
    0%, 100% { transform: skewX(15deg) scale(1) translate(0, 0); }
    50% { transform: skewX(15deg) scale(1.2) translate(-2px, -2px); }
}

/* Particle trail for cursor (Pseudo element) */
.menu-item:hover .cursor::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background: inherit;
    opacity: 0.5;
    animation: pyreflyTrail 1s infinite;
}

@keyframes pyreflyTrail {
    0% { transform: scale(1); opacity: 0.5; }
    100% { transform: scale(2.5); opacity: 0; }
}

.menu-footer {
    position: absolute;
    bottom: 30px;
    right: 40px;
    font-family: var(--font-ui);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 4px;
    text-transform: uppercase;
    text-align: right;
}
/* END GAME SPECIFIC */
#end-game-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    background: rgba(0, 5, 15, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

#end-game-menu.active {
    opacity: 1;
    pointer-events: auto;
}

.result-header {
    text-align: center;
    margin-bottom: 40px;
    transform: skewX(-10deg);
}

.result-title {
    font-family: var(--font-title);
    font-size: 72px;
    color: #fff;
    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
    letter-spacing: 5px;
    line-height: 1.0;
}

.result-subtitle {
    font-family: var(--font-spira);
    font-size: 18px;
    color: var(--ffx-gold);
    letter-spacing: 8px;
    margin-top: 5px;
}

.final-score-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    margin-bottom: 50px;
    background: linear-gradient(90deg, transparent, rgba(0, 20, 50, 0.8), transparent);
    padding: 20px 0;
    width: 100%;
}

.final-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 120px;
}

.final-score-digit {
    font-family: var(--font-data);
    font-size: 80px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    line-height: 1.0;
}

.final-team.home .final-score-digit { color: #00ffff; text-shadow: 0 0 20px #00ffff; }
.final-team.away .final-score-digit { color: #ff4444; text-shadow: 0 0 20px #ff4444; }

.final-team-name {
    font-family: var(--font-title);
    font-size: 14px;
    color: #aaa;
    letter-spacing: 2px;
    margin-top: 5px;
}

.final-vs {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.6;
}

.final-vs span {
    font-family: var(--font-spira);
    font-size: 24px;
    color: var(--ffx-gold);
    margin: 5px 0;
}

.vs-line {
    width: 2px; height: 30px;
    background: linear-gradient(to bottom, transparent, var(--ffx-gold), transparent);
}
/* --- PRACTICE OVERLAY --- */
/* --- PRACTICE OVERLAY (SPHERE POOL TERMINAL) --- */
#practice-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 5, 10, 0.4);
    backdrop-filter: blur(2px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    pointer-events: none;
}

#practice-overlay.active {
    display: flex;
}

.practice-panel {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    width: 300px;
    
    /* Holographic Glass */
    background: linear-gradient(160deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 10, 20, 0.95) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    
    /* Tech Shape */
    clip-path: polygon(
        20px 0, 100% 0, 
        100% calc(100% - 20px), calc(100% - 20px) 100%, 
        0 100%, 0 20px
    );
    
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-left: 2px solid var(--ffx-cyan);
    
    box-shadow: 
        0 0 30px rgba(0, 100, 255, 0.2),
        inset 0 0 50px rgba(0, 20, 60, 0.5);
        
    padding: 20px;
    pointer-events: auto;
    
    /* Grid Pattern Overlay */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
    
    animation: panelFloat 4s ease-in-out infinite;
}

@keyframes panelFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.panel-header {
    margin-bottom: 20px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    padding-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.panel-title-group {
    display: flex;
    flex-direction: column;
}

.panel-title {
    font-family: var(--font-title);
    font-size: 22px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    letter-spacing: 2px;
}

.panel-subtitle {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-cyan);
    letter-spacing: 2px;
    opacity: 0.8;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.section-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-gold);
    margin-bottom: 8px;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-shadow: 0 0 5px rgba(255, 200, 0, 0.5);
}

.drill-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.drill-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    background: rgba(0, 20, 40, 0.6);
    border: 1px solid rgba(0, 255, 255, 0.1);
    cursor: pointer;
    font-family: var(--font-data);
    font-size: 11px;
    color: #88aacc;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.drill-btn:hover {
    background: rgba(0, 40, 80, 0.8);
    border-color: var(--ffx-cyan);
    color: #fff;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
}

.drill-btn.active {
    background: linear-gradient(135deg, rgba(0, 100, 200, 0.8) 0%, rgba(0, 40, 80, 0.8) 100%);
    border-color: #00ffff;
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3);
}

.drill-btn .icon {
    display: none; /* Hide icons for cleaner grid */
}

.option-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-toggle {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    font-size: 12px;
    color: #aaa;
    transition: all 0.2s;
}

.option-toggle:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
}

.option-toggle.active {
    border-color: #00ff00;
    color: #fff;
    background: rgba(0, 50, 0, 0.3);
    box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
}

.option-toggle .checkbox {
    margin-right: 10px;
    color: inherit;
    font-family: monospace;
}

.action-btn {
    text-align: center;
    background: linear-gradient(90deg, rgba(50, 0, 0, 0.6), rgba(20, 0, 0, 0.8));
    border: 1px solid #ff4444;
    padding: 8px;
    font-size: 12px;
    color: #ffaaaa;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: var(--font-title);
}

.action-btn:hover {
    background: #ff4444;
    color: #fff;
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
}

#p-reset-ball {
    background: linear-gradient(90deg, rgba(0, 50, 100, 0.6), rgba(0, 20, 40, 0.8));
    border-color: #00ffff;
    color: #00ffff;
}
#p-reset-ball:hover {
    background: #00ffff;
    color: #000;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

.panel-footer {
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

#offscreen-indicator {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    display: none;
    z-index: 1000;
    pointer-events: none;
}
#offscreen-indicator .arrow {
    width: 0; 
    height: 0; 
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 15px solid #00ffff;
    filter: drop-shadow(0 0 5px #00ffff);
}

#drill-instruction {
    font-size: 11px;
    color: #88aacc;
    margin-bottom: 8px;
    font-style: italic;
    font-family: var(--font-ui);
}

#drill-score {
    font-family: var(--font-data);
    font-size: 32px;
    color: var(--ffx-gold);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    letter-spacing: 2px;
}

.panel-minimize-btn {
    width: 24px; height: 24px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 22px;
    cursor: pointer;
    font-size: 16px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 10px var(--ffx-cyan);
}
.panel-minimize-btn {
    position: absolute;
    top: 10px; right: 10px;
    width: 20px; height: 20px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 14px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 5px var(--ffx-cyan);
}

#practice-restore-btn {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    padding: 8px 15px;
    background: linear-gradient(90deg, rgba(0, 20, 50, 0.9) 0%, rgba(0, 10, 20, 0.9) 100%);
    border: 1px solid var(--ffx-cyan);
    border-left: 3px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    font-family: var(--font-data);
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    z-index: 2400;
    display: none;
    pointer-events: auto;
    transform: skewX(-10deg);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.2);
    text-transform: uppercase;
}
#practice-restore-btn:hover {
    background: rgba(0, 40, 80, 0.9);
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

/* --- AIM JOYSTICK --- */
#aim-joystick-zone {
    position: absolute;
    bottom: max(150px, env(safe-area-inset-bottom));
    right: 0;
    width: 40%;
    height: 35%;
    z-index: 1000;
    background: rgba(0,0,0,0);
    touch-action: none;
    pointer-events: auto;
}

#aim-joystick-visual {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#aim-joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100px; height: 100px;
    border-radius: 50%;
    /* Ethereal Orange Ring */
    border: 1px dashed rgba(255, 150, 50, 0.4);
    box-shadow: 0 0 15px rgba(255, 100, 0, 0.2), inset 0 0 20px rgba(255, 50, 0, 0.1);
    background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(255, 100, 0, 0.05) 100%);
    animation: etherealSpin 12s linear infinite reverse;
}

#aim-joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 30px; height: 30px;
    border-radius: 50%;
    /* Firefly Light */
    background: radial-gradient(circle at 30% 30%, #fff 0%, #ffaa00 40%, #ff4400 100%);
    box-shadow: 0 0 15px #ff6600;
    transition: transform 0.05s linear;
    will-change: transform;
}

#aim-joystick-knob::after {
    content: "AIM";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8px;
    color: white;
    font-family: var(--font-data);
    text-shadow: 0 0 3px #000;
    opacity: 0.8;
}
/* --- TACKLE BUTTON --- */
#tackle-button {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 100px);
    right: max(40px, env(safe-area-inset-right));
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
z-index: 1500;
    border: 3px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.6), inset 0 0 15px rgba(255, 200, 200, 0.3);
    transition: transform 0.1s, filter 0.2s;
}

#tackle-button:active {
    transform: scale(0.9);
    filter: brightness(1.2);
}

#tackle-button.active {
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ff4444 40%, #aa0000 80%, #440000 100%);
    box-shadow: 0 0 25px rgba(255, 100, 100, 0.9);
}

#tackle-button .btn-text {
    font-family: var(--font-data);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#tackle-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
    pointer-events: none;
    border-radius: 50%;
    animation: glarePass 4s infinite;
}

#tackle-button.urgent {
    animation: urgentPulse 0.5s infinite alternate;
    background: radial-gradient(circle at 35% 35%, #ff5555 0%, #ff0000 40%, #880000 100%);
    border-color: #ffaaaa;
    box-shadow: 0 0 20px #ff0000;
}

@keyframes urgentPulse {
    from { transform: scale(1.0); }
    to { transform: scale(1.15); }
}

/* --- CHARGE POWER METER --- */
#charge-meter-container {
    position: absolute;
    bottom: max(250px, env(safe-area-inset-bottom) + 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 2000;
    background: rgba(0, 10, 30, 0.8);
    padding: 10px 15px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
}

.charge-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.charge-meter-track {
    width: 100%;
    height: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
}

#charge-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0af, #0f0);
    box-shadow: 0 0 10px #0f0;
    transition: width 0.05s linear, background 0.1s;
    border-radius: 5px;
}

.charge-hint {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    margin-top: 5px;
    opacity: 0.8;
    animation: blink 0.5s infinite;
}

/* --- GOAL DISTANCE INDICATOR --- */
#goal-distance-container {
    position: absolute;
    top: max(75px, env(safe-area-inset-top) + 55px);
    left: max(20px, env(safe-area-inset-left));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 100;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.7) 0%, transparent 100%);
    padding: 5px 15px 5px 10px;
    border-left: 2px solid var(--ffx-gold);
}

.distance-label {
    font-family: var(--font-spira);
    font-size: 8px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#goal-distance {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-gold);
}

/* --- SETTINGS BUTTON --- */
#settings-button {
    position: absolute;
    top: max(240px, env(safe-area-inset-top) + 100px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 8px 0;
    text-align: center;
    font-size: 10px;
    font-weight: bold;
    color: #888;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
z-index: 1500;
}
#settings-button:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: #888;
    color: #fff;
}

/* --- SETTINGS PANEL --- */
#settings-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.98) 0%, rgba(0, 10, 20, 0.99) 100%);
    border: 2px solid var(--ffx-cyan);
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(0, 100, 255, 0.4);
    z-index: 3500;
    pointer-events: auto;
    backdrop-filter: blur(10px);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(100, 200, 255, 0.3);
    background: rgba(0, 30, 60, 0.5);
}

.settings-header span {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-cyan);
    letter-spacing: 3px;
}

#settings-close {
    width: 30px;
    height: 30px;
    border: 1px solid #ff4444;
    background: rgba(50, 0, 0, 0.5);
    color: #ff4444;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
}

#settings-close:hover {
    background: #ff4444;
    color: white;
}

.settings-content {
    padding: 20px;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.setting-row label {
    font-family: var(--font-data);
    font-size: 14px;
    color: #ccc;
}

.setting-row input[type="range"] {
    width: 100px;
    accent-color: var(--ffx-cyan);
}

.setting-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--ffx-cyan);
    cursor: pointer;
}

/* --- GLARE ANIMATION --- */
@keyframes glarePass {
    0% { transform: translateX(-100%) rotate(45deg); }
    30% { transform: translateX(100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* --- STATUS TYPE FLOATING TEXT --- */
.floating-text-inner.status {
    font-family: var(--font-data);
    font-size: 28px;
    font-style: italic;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 2px 2px 0 #000;
    animation: statusPop 1.2s ease-out forwards;
}

@keyframes statusPop {
    0% { transform: scale(0.5) translateY(0); opacity: 0; }
    20% { transform: scale(1.3) translateY(-10px); opacity: 1; }
    100% { transform: scale(1.0) translateY(-40px); opacity: 0; }
}

.floating-text-inner.blind {
    font-family: var(--font-data);
    font-size: 32px;
    color: #333333;
    text-shadow: 0 0 10px #000000, 2px 2px 0 #111;
    background: linear-gradient(to bottom, #666 0%, #000 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 2s forwards;
}

.floating-text-inner.silence {
    font-family: var(--font-title);
    font-size: 32px;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff;
    opacity: 0.9;
    animation: shakeTech 0.5s ease-in-out;
}

.floating-text-inner.shield {
    font-family: var(--font-data);
    font-size: 36px;
    color: #00ffff;
    text-shadow: 0 0 15px #00ffff;
    border: 2px solid #00ffff;
    border-radius: 50%;
    padding: 5px 10px;
    background: rgba(0, 50, 100, 0.5);
    animation: popDamage 0.5s ease-out forwards;
}

.floating-text-inner.haste {
    font-family: var(--font-data);
    font-size: 36px;
    font-style: italic;
    color: #ffff00;
    text-shadow: 2px 2px 0 #ff8800;
    animation: floatUp 0.5s ease-out forwards;
}

.floating-text-inner.slow {
    font-family: var(--font-data);
    font-size: 36px;
    font-weight: 900;
    color: #885522;
    text-shadow: 2px 2px 0 #000;
    animation: witherStatus 1.5s forwards;
}

/* --- GOAL TYPE FLOATING TEXT --- */
.floating-text-inner.goal {
    font-family: var(--font-data);
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #ff8800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.9));
    animation: goalPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes goalPop {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    100% { transform: scale(1.2) rotate(0deg); opacity: 0; }
}

/* --- DEFAULT TYPE FLOATING TEXT --- */
.floating-text-inner.default {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    animation: floatUp 0.8s ease-out forwards;
}

/* --- MOBILE PORTRAIT OPTIMIZATIONS --- */
/* --- MOBILE PORTRAIT OPTIMIZATIONS (9:16 First) --- */
@media screen and (orientation: portrait), screen and (max-aspect-ratio: 1/1) {
    /* HUD Top: Compact Layout */
    #hud-top {
        padding: max(10px, env(safe-area-inset-top)) 5px 0 5px;
        align-items: flex-start;
    }

    .team-wing { 
        width: 32%; 
        height: 45px;
        padding: 0 5px; 
        clip-path: polygon(0 0, 100% 0, 100% 85%, 0% 100%);
    }
    .team-wing.away {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 85%);
    }

    .score-box { 
        font-size: 28px; 
        min-width: 20px; 
    }
    
    .team-name { 
        font-size: 10px; 
        letter-spacing: 0px; 
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .team-sub { display: none; }
    
    /* Timer Compact */
    .timer-complex { 
        width: 55px; height: 55px; 
        margin-top: 0;
    }
    .timer-crystal-ring { 
        width: 48px; height: 48px; 
        top: -3px; left: -3px; right: -3px; bottom: -3px; 
    }
    #timer-display { font-size: 18px; margin-top: 0; }
    #half-indicator { font-size: 8px; letter-spacing: 1px; }
    
    /* MiniMap: Top Right, below HUD */
    #minimap-container { 
        width: 80px; height: 80px; 
        top: max(60px, env(safe-area-inset-top) + 50px);
        right: 10px;
    }
    #minimap { width: 70px; height: 70px; }
    .radar-label { display: none; }
    
    /* Goal Distance: Top Left, below HUD */
    #goal-distance-container { 
        left: 10px; 
        top: max(60px, env(safe-area-inset-top) + 50px); 
        padding: 2px 8px;
    }
    #goal-distance { font-size: 16px; }
    .distance-label { font-size: 8px; }

    /* Player Status: Move to Top Left (below Goal Distance) to free up bottom-left for joystick */
    #player-status-panel { 
        top: max(100px, env(safe-area-inset-top) + 90px);
        left: 10px;
        bottom: auto;
        width: 140px; 
        padding: 8px;
        transform: skewX(-5deg);
    }
    .char-name { font-size: 12px; margin-bottom: 2px; }
    .hp-gauge-container { margin-bottom: 2px; }
    .hp-label, .tech-label { font-size: 8px; width: 15px; }
    .hp-value { font-size: 10px; width: 40px; }

    /* Tech Flash: Full width, smaller text */
    #tech-flash-overlay {
        height: 100px;
        top: 25%;
    }
    .tech-text { font-size: 32px; letter-spacing: 2px; }
    .tech-timer-track { width: 180px; }
    
    /* Action Button: Bottom Right */
/* Action Button: Bottom Right - UPSCALED FOR 9:16 */
    #action-container {
        bottom: max(50px, env(safe-area-inset-bottom));
        right: max(30px, env(safe-area-inset-right));
    }
    #action-button { width: 130px; height: 130px; }
    #action-button .btn-text { font-size: 28px; }
    .command-ring { width: 130px; height: 130px; }
    #action-label { font-size: 12px; padding: 4px 12px; margin-bottom: 10px; }
    
    /* Tackle Button: Left of Action Button (Ergonomic arc) */
    #tackle-button {
        width: 80px; height: 80px;
        bottom: max(60px, env(safe-area-inset-bottom));
        right: max(180px, env(safe-area-inset-right)); /* Shifted left to clear larger action btn */
    }
    #tackle-button .btn-text { font-size: 12px; }
    
    /* Controls / Settings Buttons: Top Right column */
    #auto-toggle {
        width: 80px;
        font-size: 9px;
        top: max(150px, env(safe-area-inset-top) + 140px);
        right: 10px;
        padding: 6px 0;
    }
    #settings-button {
        width: 80px;
        font-size: 9px;
        top: max(190px, env(safe-area-inset-top) + 180px);
        right: 10px;
        padding: 6px 0;
    }
    #practice-restore-btn {
        width: 80px;
        font-size: 9px;
        top: max(150px, env(safe-area-inset-top) + 140px);
        right: 10px;
    }
    
    /* Joystick Zones */
    #joystick-hit-zone {
        height: 40%; /* Lower half only */
        width: 50%;
        bottom: 0; left: 0;
    }
    #aim-joystick-zone {
        height: 40%;
        width: 50%;
        bottom: 0;
        right: 0;
    }

    /* Announcements: Ensure they wrap */
    #announcement {
        font-size: clamp(36px, 10vw, 50px);
        width: 90%;
        left: 5%;
        white-space: normal;
        line-height: 1.0;
        top: 30%;
    }
    .announcement-slam {
        font-size: clamp(48px, 12vw, 70px) !important;
    }

    /* Menus */
    .ffx-logo-main { font-size: 42px; letter-spacing: 5px; }
    .ffx-logo-sub { font-size: 14px; letter-spacing: 6px; }
    .menu-options { width: 220px; }
    .menu-item { padding: 10px 15px; }
    .menu-item .label { font-size: 16px; }
    
    /* Settings Panel */
    #settings-panel {
        width: 90%;
        max-width: 320px;
    }
    
    /* Practice Panel */
    .practice-panel {
        width: 90%;
        top: max(80px, env(safe-area-inset-top));
        right: 5%;
    }
}</style>

    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
    <!-- Lil-GUI -->
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
<script type="importmap">{"imports":{"style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAtLS0gKi8KLyogLS0tIEhVRCBUT1AgKENSWVNUQUwgSFVEKSAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcGFkZGluZy10b3A6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IG5vbmU7IC8qIFJlbW92ZWQgZmxhdCBncmFkaWVudCAqLwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHotaW5kZXg6IDEwMDA7Cn0KCi8qIE1pc3QgTGF5ZXIgKi8KLmh1ZC1taXN0IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwcHg7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDIwMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KDUwJSAxMDAlIGF0IDUwJSAwJSwgcmdiYSgwLCAyNDIsIDI1NSwgMC4xNSkgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgZmlsdGVyOiBibHVyKDIwcHgpOwogICAgei1pbmRleDogLTE7CiAgICBhbmltYXRpb246IG1pc3RQdWxzZSA2cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBtaXN0UHVsc2UgewogICAgMCUgeyBvcGFjaXR5OiAwLjQ7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyB9CiAgICAxMDAlIHsgb3BhY2l0eTogMC43OyB0cmFuc2Zvcm06IHNjYWxlWSgxLjIpOyB9Cn0KCi8qIFRlYW0gV2luZyAoQ3J5c3RhbCBTaGFyZCkgKi8KLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTgwcHg7IGhlaWdodDogNjVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoNiwgMTIsIDI0LCAwLjkpIDAlLCByZ2JhKDIyLCA1MCwgOTEsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTJweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxMnB4KTsKICAgIAogICAgLyogQXN5bW1ldHJpYyBTaGFyZCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCA4NSUgMTAwJSwgMCUgMTAwJSk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMCAxNXB4IDAgMjVweDsKICAgIG1hcmdpbi10b3A6IDEwcHg7CiAgICAKICAgIC8qIEdsb3cgKi8KICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDhweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjQpKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWigwKTsgLyogRm9yY2UgR1BVICovCn0KCi8qIElubmVyIFNoaW5lICovCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEwNWRlZywgdHJhbnNwYXJlbnQgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMikgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICBhbmltYXRpb246IHNoaW1tZXIgNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiBUb3AgR2xvd2luZyBCb3JkZXIgKi8KLmNyeXN0YWwtYm9yZGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWN5YW4pLCB0cmFuc3BhcmVudCk7CiAgICB6LWluZGV4OiAyOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9CgovKiBBd2F5IFRlYW0gTWlycm9yICovCi50ZWFtLXdpbmcuYXdheSB7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjAwZGVnLCByZ2JhKDYsIDEyLCAyNCwgMC45KSAwJSwgcmdiYSg2MCwgMTAsIDEwLCAwLjgpIDEwMCUpOwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCAxMDAlIDEwMCUsIDE1JSAxMDAlKTsKICAgIHBhZGRpbmc6IDAgMjVweCAwIDE1cHg7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggcmdiYSgyNTUsIDY4LCA2OCwgMC40KSk7Cn0KCi50ZWFtLXdpbmcuYXdheSAuY3J5c3RhbC1ib3JkZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgI2ZmNDQ0NCwgdHJhbnNwYXJlbnQpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQ0NDsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCi50ZWFtLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpOwogICAgbWFyZ2luLWJvdHRvbTogLTJweDsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDZweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIG1pbi13aWR0aDogNDBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiA1Owp9Ci50ZWFtLXdpbmcuYXdheSAuc2NvcmUtYm94IHsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0NDQ7IH0KCi8qIFRpbWVyIChTcGhlcmUgR3JpZCBOb2RlKSAqLwoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAKICAgIC8qIFNwaGVyZSBMb29rICovCiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsIHJnYmEoNDAsIDgwLCAxMjAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSA4MCUpOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDI1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC40KSwKICAgICAgICBpbnNldCAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjIpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwogICAgei1pbmRleDogMTA7Cn0KCi8qIEZsb2F0aW5nIFJpbmcgKi8KLnRpbWVyLWNyeXN0YWwtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC04cHg7IGxlZnQ6IC04cHg7IHJpZ2h0OiAtOHB4OyBib3R0b206IC04cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYW5pbWF0aW9uOiBzcGhlcmVTcGluIDhzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogbm9uZTsKfQoKQGtleWZyYW1lcyBzcGhlcmVTcGluIHsgCiAgICBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gCiAgICB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gCn0KCi50aW1lci1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICBtYXJnaW4tdG9wOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgKExJUVVJRCBMSUdIVCkgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44NSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjYpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjIpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDE1cHggMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOyAvKiBNYW5hZ2VkIGJ5IEpTICovCiAgICBib3gtc2hhZG93OiAwIDEwcHggMzBweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgovKiBEZWNvcmF0aXZlIGJhY2tncm91bmQgc2hhcmQgKi8KI3BsYXllci1zdGF0dXMtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMDMpIDUwJSwgdHJhbnNwYXJlbnQgNTUlKTsKICAgIGFuaW1hdGlvbjogc2hpbW1lciA2cyBpbmZpbml0ZSBsaW5lYXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmNoYXItbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNnB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KLmhwLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMzMzQ0NTU7CiAgICBtYXJnaW46IDAgOHB4OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IGluc2V0IDAgMCA1cHggcmdiYSgwLDAsMCwwLjgpOwp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwYWE0NCwgIzQ0ZmY4OCwgIzAwYWE0NCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyAzcyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZjQ0OwogICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKfQouaHAtdmFsdWUgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OyAKICAgIGNvbG9yOiAjZmZmOyAKICAgIHdpZHRoOiA1NXB4OyAKICAgIHRleHQtYWxpZ246IHJpZ2h0OyAKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi50ZWNoLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci50ZWNoLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0MzMyMjsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2FhNjYwMCwgI2ZmY2MwMCwgI2FhNjYwMCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyA0cyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICNmZmFhMDA7Cn0KCkBrZXlmcmFtZXMgbGlxdWlkRmxvdyB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDEwMCUgMDsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0xMDAlIDA7IH0KfQovKiAtLS0gTUlOSU1BUCAtLS0gKi8KI21pbmltYXAtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBoZWlnaHQ6IDExMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnJhZGFyLXJpbSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWJsdWUtbWlkKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICB6LWluZGV4OiA1Owp9CgojbWluaW1hcCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwcHg7CiAgICBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogNjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5yYWRhci1sYWJlbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0xNXB4OwogICAgd2lkdGg6IDE0MCU7CiAgICBsZWZ0OiAtMjAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCi5tYXAtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiA2cHg7IGhlaWdodDogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgNHB4IGN1cnJlbnRDb2xvcjsKfQoubWFwLWRvdC5ob21lIHsgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB9Ci5tYXAtZG90LmF3YXkgeyBiYWNrZ3JvdW5kOiAjZmY0NDQ0OyBjb2xvcjogI2ZmNDQ0NDsgfQoubWFwLWRvdC5iYWxsIHsgCiAgICBiYWNrZ3JvdW5kOiAjZmYwMGNjOwogICAgY29sb3I6ICNmZjAwY2M7IAogICAgd2lkdGg6IDEycHg7IGhlaWdodDogMTJweDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICB6LWluZGV4OiAyMDsKICAgIGFuaW1hdGlvbjogYmxpbmtCYWxsIDAuM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYm94LXNoYWRvdzogMCAwIDZweCAjZmYwMGNjOwp9Ci5tYXAtZG90Lm5hcCB7IGJhY2tncm91bmQ6ICMzMzM7IGNvbG9yOiAjMDAwOyBib3JkZXI6IDFweCBzb2xpZCAjNTU1OyB9Ci5tYXAtZG90LmFjdGl2ZS1wbGF5ZXIgeyAKICAgIGJhY2tncm91bmQ6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBjb2xvcjogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGJveC1zaGFkb3c6IDAgMCA4cHggIzAwZmYwMDsKICAgIHotaW5kZXg6IDE1OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsKfQoubWFwLWRvdC5iYWxsLWNhcnJpZXIgewogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmZiwgMCAwIDMwcHggI2ZmYWEwMDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB6LWluZGV4OiAxMDA7CiAgICB3aWR0aDogMTBweDsgaGVpZ2h0OiAxMHB4OwogICAgYW5pbWF0aW9uOiBjYXJyaWVyUHVsc2UgMC44cyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KQGtleWZyYW1lcyBjYXJyaWVyUHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmY7IG9wYWNpdHk6IDAuODsgfQogICAgdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjgpOyBib3gtc2hhZG93OiAwIDAgMjVweCAjZmZjYzAwOyBvcGFjaXR5OiAxLjA7IH0KfQpAa2V5ZnJhbWVzIGJsaW5rQmFsbCB7IGZyb20geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfSB0byB7IG9wYWNpdHk6IDAuNTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4zKTsgfSB9CgovKiAtLS0gQU5OT1VOQ0VNRU5UUyAtLS0gKi8KI2Fubm91bmNlbWVudCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDQwJTsgCiAgICBsZWZ0OiA1JTsgCiAgICB3aWR0aDogOTAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IGNsYW1wKDQwcHgsIDEydncsIDcycHgpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDQwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpKSBkcm9wLXNoYWRvdygzcHggM3B4IDAgIzAwMCk7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGFuaW1hdGlvbjogYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIChFVEhFUkVBTCBJTlRFUkZBQ0UpIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgUmluZyAqLwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEwcyBsaW5lYXIgaW5maW5pdGU7Cn0KCiNqb3lzdGljay1iYXNlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTAlOyBsZWZ0OiAxMCU7IHdpZHRoOiA4MCU7IGhlaWdodDogODAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDVzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIGV0aGVyZWFsU3BpbiB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBQeXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmZmZmYgMCUsICNhMmY5ZmYgNDAlLCAjMDBmMmZmIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZjJmZiwgMCAwIDMwcHggIzAwZjJmZjsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgb3BhY2l0eTogMC44Owp9Cgojam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIiI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB1bHNlLWdsb3cgMnMgaW5maW5pdGU7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC41KTsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7CiAgICBhbmltYXRpb246IHJpcHBsZUFuaW0gMC42cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgcmlwcGxlQW5pbSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOyBvcGFjaXR5OiAxOyBib3JkZXItd2lkdGg6IDVweDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IGJvcmRlci13aWR0aDogMHB4OyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAoU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7IAogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKei1pbmRleDogMTUwMDsKfQouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAyMjBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvdHRvbTogMjBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuOCkgMCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICB6LWluZGV4OiAtMTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY29tbWFuZC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDIwcyBsaW5lYXIgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSk7Cn0KLmNvbW1hbmQtcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMTBweDsgbGVmdDogLTEwcHg7IHJpZ2h0OiAtMTBweDsgYm90dG9tOiAtMTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRvdHRlZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDEwcyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKQGtleWZyYW1lcyBzcGluUmV2ZXJzZSB7IGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMzYwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgwZGVnKTsgfSB9CgojYWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgcGFkZGluZzogNHB4IDE2cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgei1pbmRleDogMjA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIC8qIERlZXAgU2hhZG93ICYgM0QgQ29udGV4dCAqLwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAzMHB4IDYwcHggcmdiYSgwLCAwLCAwLCAwLjkpLAogICAgICAgIDAgMCAwIDJweCByZ2JhKDAsIDAsIDAsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiBub25lOwogICAgYm9yZGVyOiBub25lOwogICAgcGVyc3BlY3RpdmU6IDEwMDBweDsKICAgIHRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOwp9CgovKiBLZXlmcmFtZXMgZm9yIExpdmluZyBVSSAqLwpAa2V5ZnJhbWVzIHJpbmctZ3lyby16IHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDM2MGRlZyk7IH0KfQoKQGtleWZyYW1lcyByaW5nLXdvYmJsZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoMTBkZWcpIHJvdGF0ZVkoNWRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDEwZGVnKTsgfQogICAgNzUlIHsgdHJhbnNmb3JtOiByb3RhdGVYKC0xMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9Cn0KCkBrZXlmcmFtZXMgcnVuZS1zcGluLWdsb3cgewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKSBzY2FsZSgxLjA1KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgOHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpKTsgb3BhY2l0eTogMS4wOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQp9CgpAa2V5ZnJhbWVzIGxpcXVpZC1zdXJnZS1jb21wbGV4IHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjAyKTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDQ5JTsgYm94LXNoYWRvdzogMCAwIDUwcHggIzAwZmZmZiwgaW5zZXQgMCAwIDQwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQp9CgpAa2V5ZnJhbWVzIGNyeXN0YWwtYnJlYXRoZSB7CiAgICAwJSwgMTAwJSB7IGJvcmRlci1jb2xvcjogcmdiYSgwLCAyMDAsIDI1NSwgMC4zKTsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDIwcHggIzAwMDAwMDsgfQogICAgNTAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMzBweCAjMDAxMTMzLCAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOyB9Cn0KCi8qIExheWVyIDE6IE91dGVyIE9ybmF0ZSBSaW5nIChNZXRhbC9Hb2xkKSAtIFRoZSBHeXJvICovCi5hYi1vdXRlci1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLThweDsgbGVmdDogLThweDsgcmlnaHQ6IC04cHg7IGJvdHRvbTogLThweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjYjg4NjBiLCAjZmZkNzAwLCAjZmZmYWNkLCAjZmZkNzAwLCAjYjg4NjBiLCAjOGI0NTAwLCAjYjg4NjBiCiAgICApOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgaW5zZXQgMCAwIDEwcHggcmdiYSgwLDAsMCwwLjgpLAogICAgICAgIDAgMCAyNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuMyk7CiAgICB6LWluZGV4OiAxOwogICAgYm9yZGVyOiAxcHggc29saWQgIzU1MzMwMDsKICAgIC8qIENvbXBsZXggcm90YXRpb24gKi8KICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMjBzIGxpbmVhciBpbmZpbml0ZTsKfQoKLyogUHNldWRvLWVsZW1lbnQgZm9yIDNEIGRlcHRoL3dvYmJsZSBlZmZlY3Qgb24gdGhlIHJpbmcgKi8KLmFiLW91dGVyLXJpbmc6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjUpOwogICAgYW5pbWF0aW9uOiByaW5nLXdvYmJsZSA4cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAyOiBSdW5lIFJpbmcgKFNwaW5uaW5nKSAqLwouYWItcnVuZS1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgLyogYm94LXNoYWRvdyBoYW5kbGVkIGJ5IGFuaW1hdGlvbiAqLwogICAgei1pbmRleDogMjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAzOiBJbm5lciBDcnlzdGFsIEhvdXNpbmcgKERhcmsgR2xhc3MpICovCi5hYi1pbm5lci1jcnlzdGFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNnB4OyBsZWZ0OiA2cHg7IHJpZ2h0OiA2cHg7IGJvdHRvbTogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgMCUsIHJnYmEoMCwgMTAsIDMwLCAwLjk1KSA2MCUsICMwMDAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogMzsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGFuaW1hdGlvbjogY3J5c3RhbC1icmVhdGhlIDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgovKiBMYXllciA0OiBMaXF1aWQgQ29yZSAoQW5pbWF0ZWQgU3VyZmFjZSkgKi8KLmFiLWxpcXVpZC1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTJweDsgbGVmdDogMTJweDsgcmlnaHQ6IDEycHg7IGJvdHRvbTogMTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIENvbXBsZXggR3JhZGllbnQgZm9yIGxpcXVpZCBtb3Rpb24gKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNDAlIDQwJSwgIzAwZmZmZiAwJSwgIzAwODhmZiA0MCUsICMwMDIyNjYgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDE1MCUgMTUwJTsKICAgIHotaW5kZXg6IDQ7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExpcXVpZCBtb3ZlbWVudCBlZmZlY3QgKEludGVybmFsIHJlZmxlY3Rpb24pICovCi5hYi1saXF1aWQtY29yZTo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC41KSAwJSwgdHJhbnNwYXJlbnQgMjUlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkTW92ZSA1cyBpbmZpbml0ZSBlYXNlLWluLW91dDsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5Owp9CgovKiBMYXllciA1OiBMaW1pdCBCcmVhayBSaW5nIChIaWRkZW4gYnkgZGVmYXVsdCkgKi8KLmxpbWl0LXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjJweDsgbGVmdDogLTIycHg7IHJpZ2h0OiAtMjJweDsgYm90dG9tOiAtMjJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogNHB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmNDQwMDsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmFhMDA7CiAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsKICAgIHotaW5kZXg6IDA7CiAgICBvcGFjaXR5OiAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMS41cyBsaW5lYXIgaW5maW5pdGU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBsaW1pdFNwaW4gewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBodWUtcm90YXRlKDBkZWcpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgxNWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogTGF5ZXIgNjogVGV4dCBMYWJlbCAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXNoYWRvdzogCiAgICAgICAgMCAycHggMCAjMDAwLAogICAgICAgIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDEuMCksCiAgICAgICAgMCAwIDMwcHggIzAwODhmZjsKICAgIHotaW5kZXg6IDY7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHRvcDogMXB4OwogICAgYW5pbWF0aW9uOiB0ZXh0RmxvYXQgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgdGV4dEZsb2F0IHsKICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7IH0KfQoKLyogTGF5ZXIgNzogR2xhcmUgKi8KI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDI1NSwyNTUsMjU1LDAuNikgMCUsIHRyYW5zcGFyZW50IDQ1JSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICB6LWluZGV4OiA3OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogc29mdC1saWdodDsKfQoKLyogU1RBVEU6IFNIT09UIE1PREUgKE9yYW5nZS9SZWQpICovCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICM4YjAwMDAsICNmZjQ0MDAsICNmZmFhMDAsICNmZjQ0MDAsICM4YjAwMDAsICM0NDAwMDAsICM4YjAwMDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgNTBweCByZ2JhKDI1NSwgNjgsIDAsIDAuOSk7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDVzIGxpbmVhciBpbmZpbml0ZTsgLyogRmFzdGVyIHNwaW4gKi8KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjZmZmZjAwIDAlLCAjZmY0NDAwIDUwJSwgIzY2MDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogY29yZVB1bHNlUmVkIDAuNHMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgpAa2V5ZnJhbWVzIGNvcmVQdWxzZVJlZCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC45NSk7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDA7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wOCk7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIDAgMCAyMHB4ICNmZmY7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjMpOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmJ0bi10ZXh0IHsKICAgIHRleHQtc2hhZG93OiAwIDJweCAwICMwMDAsIDAgMCAyMHB4ICNmZjQ0MDA7Cn0KCi8qIFNUQVRFOiBMSU1JVCBSRUFEWSAoSGVyY3VsZWFuIEdvbGQpICovCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIG9wYWNpdHk6IDE7CiAgICBib3JkZXItd2lkdGg6IDZweDsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZmY7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiAjZmZkNzAwOwogICAgYm94LXNoYWRvdzogMCAwIDYwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDIwcHggI2ZmNDQwMDsKICAgIGFuaW1hdGlvbjogbGltaXRTcGluIDAuOHMgbGluZWFyIGluZmluaXRlLCBsaW1pdFB1bHNlIDAuM3MgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCAjZmZmZmZmKTsKfQoKQGtleWZyYW1lcyBsaW1pdFB1bHNlIHsKICAgIGZyb20geyBvcGFjaXR5OiAwLjg7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDAsIGluc2V0IDAgMCAyMHB4ICNmZmFhMDA7IH0KICAgIHRvIHsgb3BhY2l0eTogMS4wOyBib3gtc2hhZG93OiAwIDAgODBweCAjZmZhYTAwLCBpbnNldCAwIDAgNDBweCAjZmZmZjAwOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1vdXRlci1yaW5nIHsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjZmZkNzAwLCAjZmZmZmZmLCAjZmZhYTAwLCAjZmZmZmZmLCAjZmZkNzAwLCAjYjg4NjBiLCAjZmZkNzAwCiAgICApOwogICAgYm94LXNoYWRvdzogMCAwIDgwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC44KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMnMgbGluZWFyIGluZmluaXRlOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLXJ1bmUtcmluZyB7CiAgICBib3JkZXItY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCA0MHB4ICMwMGZmZmY7CiAgICBhbmltYXRpb246IHJ1bmUtc3Bpbi1nbG93IDNzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDIwJSwgI2ZmODgwMCA2MCUsICNmZjAwMDAgMTAwJSk7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDAuNXMgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmJ0bi10ZXh0IHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwMDAsIDAgMCAyMHB4ICNmZmZmMDAsIDAgMCA0MHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAwLjJzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLyogU1RBVEU6IEFDVElWRSAoQ2hhcmdpbmcvUHJlc3NlZCkgKi8KI2FjdGlvbi1idXR0b24uYWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDQwJSwgI2ZmZmZhYSA3MCUsICNmZmFhMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCAjZmZmZmZmLCBpbnNldCAwIDAgNTBweCAjZmZmZmZmOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDIuMCkgY29udHJhc3QoMS4yKTsKICAgIGFuaW1hdGlvbjogbm9uZTsgLyogU29saWQgaW50ZW5zZSBsaWdodCAqLwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmFiLW91dGVyLXJpbmcgewogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAwLjJzIGxpbmVhciBpbmZpbml0ZTsgLyogSHlwZXIgc3BpbiAqLwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTAwcHggI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC4xcyBsaW5lYXIgaW5maW5pdGU7CiAgICBvcGFjaXR5OiAxOwp9Ci8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CiNhdXRvLXRvZ2dsZS5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgxMDAsIDIwLCAwLCAwLjgpIDAlLCByZ2JhKDQwLCAwLCAwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDAwOwogICAgY29sb3I6ICNmZmFhMDA7CiAgICBhbmltYXRpb246IHB1bHNlUmVkIDJzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgcHVsc2VSZWQgeyAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSA1MCUgeyBib3gtc2hhZG93OiAwIDAgMjBweCAjZmY0NDAwOyB9IDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gfQoKLyogLS0tIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LXdyYXBwZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKICAgIGNvbnRhaW46IGxheW91dCBzdHlsZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMjRweDsgCiAgICB0ZXh0LXNoYWRvdzogMXB4IDFweCAwICMwMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmRhbWFnZSB7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZjYzAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuOHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oZWFsIHsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjNDRmZjQ0OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmMDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnZlbm9tIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNhYWZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzQ0ODgwMCwgMnB4IDJweCAwICMwMDIyMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjY2NmZjY2IDAlLCAjNjZjYzAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggcmdiYSgxMDAsIDI1NSwgMCwgMC41KSk7CiAgICBhbmltYXRpb246IGRyaXBTdGF0dXMgMnMgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsZWVwIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMDQ0ZmYsIDAgMCAzMHB4ICMwMDAwZmY7CiAgICBvcGFjaXR5OiAwLjk7CiAgICBhbmltYXRpb246IGRyaWZ0U3RhdHVzIDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci53aXRoZXIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM4cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzQ0NDQ0NDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNlZWVlZWUgMCUsICM4ODg4ODggMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnRlY2ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC43KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgIzAwZmZmZjsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMDg4ZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjZmZmOwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC42cyBlYXNlLWluLW91dCwgZmxhc2hUZWNoIDAuM3M7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNhdmUsIC5mbG9hdGluZy10ZXh0LWlubmVyLmJsb2NrIHsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDA0NDg4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMDg4ZmY7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHBvcERhbWFnZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOyBvcGFjaXR5OiAxOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBmbG9hdFVwIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MHB4KTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGRyaXBTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEuMSkgdHJhbnNsYXRlWSg1cHgpOyBmaWx0ZXI6IGJsdXIoMXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGRyaWZ0U3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDE1cHgpIHRyYW5zbGF0ZVkoLTIwcHgpIHJvdGF0ZSgxMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTE1cHgpIHRyYW5zbGF0ZVkoLTUwcHgpIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgd2l0aGVyU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBncmF5c2NhbGUoMCUpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjYpOyBmaWx0ZXI6IGdyYXlzY2FsZSgxMDAlKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHNoYWtlVGVjaCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC44KTsgfQogICAgMTAlLCAzMCUsIDUwJSwgNzAlLCA5MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKC0ycHgsIDJweCk7IH0KICAgIDIwJSwgNDAlLCA2MCUsIDgwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoMnB4LCAtMnB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQp9CgpAa2V5ZnJhbWVzIGZsYXNoVGVjaCB7CiAgICAwJSB7IGJhY2tncm91bmQtY29sb3I6ICNmZmY7IGNvbG9yOiAjMDAwOyBib3JkZXItY29sb3I6ICNmZmY7IH0KICAgIDEwMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDEwLCAzMCwgMC44NSk7IGNvbG9yOiAjMDBmZmZmOyBib3JkZXItY29sb3I6ICMwMGZmZmY7IH0KfQoKI2xvYWRpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgYW5pbWF0aW9uOiBibGluayAxcyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIGJsaW5rIHsgNTAlIHsgb3BhY2l0eTogMC41OyB9IH0KCiNjb250cm9scy1oaW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTMwcHg7IHdpZHRoOiAxMDAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC40KTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtaW1wYWN0IHsKICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZjAwOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDNweCAzcHggMCAjZmYwMDAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNQb3AgMC40cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1hY3Rpb24gewogICAgZm9udC1mYW1pbHk6ICdBcmlhbCBCbGFjaycsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogIzAwZmZmZjsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwNDRhYTsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljU2xpZGUgMC40cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCkBrZXlmcmFtZXMgY29taWNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMjBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICA2MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBjb21pY1NsaWRlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTIwcHgsIDIwcHgpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMjBweCkgc2NhbGUoMS4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gTUFJTiBNRU5VIC0tLSAqLwovKiAtLS0gTUFJTiBNRU5VICYgRU5EIEdBTUUgKEZGWCBTVFlMRSkgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgKEZBWVRIIElOVEVSRkFDRSkgLS0tICovCiNtYWluLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQXN5bW1ldHJpYyBSaWdodCBBbGlnbiAqLwogICAgcGFkZGluZy1yaWdodDogMTAlOwogICAgei1pbmRleDogMzAwMDsKICAgIG9wYWNpdHk6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC44cyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKICAgIAogICAgLyogRGVlcCBWb2lkIEJhY2tncm91bmQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDUwJSwgIzA1MTAyMCAwJSwgIzAwMDAwMCAxMDAlKTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNtYWluLW1lbnUuYWN0aXZlIHsKICAgIG9wYWNpdHk6IDE7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKLyogU2NhbmxpbmVzICYgVmlnbmV0dGUgKi8KLm1lbnUtYmctb3ZlcmxheSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoCiAgICAgICAgICAgIDBkZWcsCiAgICAgICAgICAgIHRyYW5zcGFyZW50IDBweCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMnB4LAogICAgICAgICAgICByZ2JhKDAsIDI1NSwgMjU1LCAwLjAyKSAzcHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDRweAogICAgICAgICk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoubWVudS1iZy1vdmVybGF5OjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMCwwLDAsMC44KSAxMDAlKTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IHJpZ2h0OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgouZmZ4LWxvZ28tbWFpbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDYwcHgsIDEydncsIDEwMHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxMHB4OwogICAgbGluZS1oZWlnaHQ6IDAuOTsKICAgIAogICAgLyogQ3J5c3RhbCBHcmFkaWVudCAqLwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0NSUsICMwMDg4ZmYgNTUlLCAjMDAyMjY2IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7CiAgICBhbmltYXRpb246IGxvZ29GbG9hdCA0cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBsb2dvRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMTBweCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgwLCAyMDAsIDI1NSwgMC44KSk7IH0KfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDR2dywgMzJweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMDsKICAgIG9wYWNpdHk6IDAuOTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9CgovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKLyogTUVOVSBPUFRJT05TIChBc3ltbWV0cmljIExpc3QpICovCiAgICB3aWR0aDogNDAwcHg7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7IC8qIEFsaWduIGl0ZW1zIHRvIHJpZ2h0ICovCn0KCi5tZW51LWl0ZW0gewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4IDQwcHggMTVweCAyMHB4OwogICAgCiAgICAvKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDQwLCA4MCwgMC44KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMCkgMTAwJSk7CiAgICBib3JkZXItcmlnaHQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICAKICAgIGN1cnNvcjogcG9pbnRlcjsKLyogR2xhc3MgU2hhcmQgTG9vayAqLwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgCiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKfQoKLm1lbnUtaXRlbTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDEwMCwgMjAwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogIzAwZmZmZjsKICAgIHBhZGRpbmctcmlnaHQ6IDYwcHg7IC8qIFNsaWRlIGxlZnQgZWZmZWN0ICovCiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2FhYWFhYTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7IC8qIENvdW50ZXIgc2tldyB0ZXh0ICovCiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzLCB0ZXh0LXNoYWRvdyAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmLCAwIDAgMjBweCAjMDA4OGZmOwp9CgovKiBQWVJFRkxZIENVUlNPUiAqLwoubWVudS1pdGVtIC5jdXJzb3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgcmlnaHQ6IDE1cHg7CiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogI2ZmZDcwMDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgwKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDEwcHggI2ZmZDcwMCwKICAgICAgICAwIDAgMjBweCAjZmZhYTAwLAogICAgICAgIDAgMCA0MHB4ICNmZjQ0MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICByaWdodDogMzBweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpOwogICAgYW5pbWF0aW9uOiBweXJlZmx5V2lnZ2xlIDFzIGluZmluaXRlIGVhc2UtaW4tb3V0Owp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlXaWdnbGUgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgxKSB0cmFuc2xhdGUoMCwgMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEuMikgdHJhbnNsYXRlKC0ycHgsIC0ycHgpOyB9Cn0KCi8qIFBhcnRpY2xlIHRyYWlsIGZvciBjdXJzb3IgKFBzZXVkbyBlbGVtZW50KSAqLwoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3I6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGluaGVyaXQ7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB5cmVmbHlUcmFpbCAxcyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBweXJlZmx5VHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDIuNSk7IG9wYWNpdHk6IDA7IH0KfQoKLm1lbnUtZm9vdGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogMzBweDsKICAgIHJpZ2h0OiA0MHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KLyogRU5EIEdBTUUgU1BFQ0lGSUMgKi8KI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzNTAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjVzOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxNSwgMC45KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9CgojZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCi8qIC0tLSBQUkFDVElDRSBPVkVSTEFZIChTUEhFUkUgUE9PTCBURVJNSU5BTCkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNCk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMzAwcHg7CiAgICAKICAgIC8qIEhvbG9ncmFwaGljIEdsYXNzICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA0MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE1cHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAKICAgIC8qIFRlY2ggU2hhcGUgKi8KICAgIGNsaXAtcGF0aDogcG9seWdvbigKICAgICAgICAyMHB4IDAsIDEwMCUgMCwgCiAgICAgICAgMTAwJSBjYWxjKDEwMCUgLSAyMHB4KSwgY2FsYygxMDAlIC0gMjBweCkgMTAwJSwgCiAgICAgICAgMCAxMDAlLCAwIDIwcHgKICAgICk7CiAgICAKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIAogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwKICAgICAgICBpbnNldCAwIDAgNTBweCByZ2JhKDAsIDIwLCA2MCwgMC41KTsKICAgICAgICAKICAgIHBhZGRpbmc6IDIwcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIAogICAgLyogR3JpZCBQYXR0ZXJuIE92ZXJsYXkgKi8KICAgIGJhY2tncm91bmQtaW1hZ2U6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCksCiAgICAgICAgbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwcHggMjBweDsKICAgIAogICAgYW5pbWF0aW9uOiBwYW5lbEZsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHBhbmVsRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNXB4KTsgfQp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7CiAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKfQoKLnBhbmVsLXRpdGxlLWdyb3VwIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9CgoucGFuZWwtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5wYW5lbC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG9wYWNpdHk6IDAuODsKfQoKLnBhbmVsLWNvbnRlbnQgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDIwcHg7Cn0KCi5zZWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHJnYmEoMjU1LCAyMDAsIDAsIDAuNSk7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7CiAgICBnYXA6IDhweDsKfQoKLmRyaWxsLWJ0biB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgcGFkZGluZzogMTBweCA1cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDIwLCA0MCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouZHJpbGwtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjgpOwogICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5kcmlsbC1idG4uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOCkgMCUsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIGljb25zIGZvciBjbGVhbmVyIGdyaWQgKi8KfQoKLm9wdGlvbi1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA4cHg7Cn0KCi5vcHRpb24tdG9nZ2xlIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogI2FhYTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpOwogICAgY29sb3I6ICNmZmY7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBib3JkZXItY29sb3I6ICMwMGZmMDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDAsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHJnYmEoMCwgMjU1LCAwLCAwLjIpOwp9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6IGluaGVyaXQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoNTAsIDAsIDAsIDAuNiksIHJnYmEoMjAsIDAsIDAsIDAuOCkpOwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIHBhZGRpbmc6IDhweDsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjZmZhYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCA2OCwgMC41KTsKfQoKI3AtcmVzZXQtYmFsbCB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNTAsIDEwMCwgMC42KSwgcmdiYSgwLCAyMCwgNDAsIDAuOCkpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMGZmZmY7Cn0KI3AtcmVzZXQtYmFsbDpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDIwcHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTAwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgCiAgICBoZWlnaHQ6IDA7IAogICAgYm9yZGVyLWxlZnQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAxNXB4IHNvbGlkICMwMGZmZmY7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBjb2xvcjogIzg4YWFjYzsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKfQoKI2RyaWxsLXNjb3JlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjYpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICB3aWR0aDogMjRweDsgaGVpZ2h0OiAyNHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAyMnB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKfQoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTBweDsgcmlnaHQ6IDEwcHg7CiAgICB3aWR0aDogMjBweDsgaGVpZ2h0OiAyMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxOHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgojcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBwYWRkaW5nOiA4cHggMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgei1pbmRleDogMjQwMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CiNwcmFjdGljZS1yZXN0b3JlLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7Cn0KCi8qIC0tLSBBSU0gSk9ZU1RJQ0sgLS0tICovCiNhaW0tam95c3RpY2stem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgIHJpZ2h0OiAwOwogICAgd2lkdGg6IDQwJTsKICAgIGhlaWdodDogMzUlOwogICAgei1pbmRleDogMTAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMCk7CiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2FpbS1qb3lzdGljay12aXN1YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2FpbS1qb3lzdGljay1iYXNlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIEV0aGVyZWFsIE9yYW5nZSBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgyNTUsIDE1MCwgNTAsIDAuNCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjIpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgNTAsIDAsIDAuMSk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsMCwwLDApIDYwJSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4wNSkgMTAwJSk7CiAgICBhbmltYXRpb246IGV0aGVyZWFsU3BpbiAxMnMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhaW0tam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMzBweDsgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRmlyZWZseSBMaWdodCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZmZmIDAlLCAjZmZhYTAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZjY2MDA7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwogICAgb3BhY2l0eTogMC44Owp9Ci8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwp9CiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5ibGluZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMzMzMzMzOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMDAwMDAsIDJweCAycHggMCAjMTExOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgIzY2NiAwJSwgIzAwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMnMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNpbGVuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNXMgZWFzZS1pbi1vdXQ7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNoaWVsZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMGZmZmY7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogNXB4IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUwLCAxMDAsIDAuNSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oYXN0ZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjZmY4ODAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsb3cgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICM4ODU1MjI7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAoOToxNiBGaXJzdCkgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpLCBzY3JlZW4gYW5kIChtYXgtYXNwZWN0LXJhdGlvOiAxLzEpIHsKICAgIC8qIEhVRCBUb3A6IENvbXBhY3QgTGF5b3V0ICovCiAgICAjaHVkLXRvcCB7CiAgICAgICAgcGFkZGluZzogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSkgNXB4IDAgNXB4OwogICAgICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgfQoKICAgIC50ZWFtLXdpbmcgeyAKICAgICAgICB3aWR0aDogMzIlOyAKICAgICAgICBoZWlnaHQ6IDQ1cHg7CiAgICAgICAgcGFkZGluZzogMCA1cHg7IAogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSA4NSUsIDAlIDEwMCUpOwogICAgfQogICAgLnRlYW0td2luZy5hd2F5IHsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgMTAwJSwgMCUgODUlKTsKICAgIH0KCiAgICAuc2NvcmUtYm94IHsgCiAgICAgICAgZm9udC1zaXplOiAyOHB4OyAKICAgICAgICBtaW4td2lkdGg6IDIwcHg7IAogICAgfQogICAgCiAgICAudGVhbS1uYW1lIHsgCiAgICAgICAgZm9udC1zaXplOiAxMHB4OyAKICAgICAgICBsZXR0ZXItc3BhY2luZzogMHB4OyAKICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC8qIFRpbWVyIENvbXBhY3QgKi8KICAgIC50aW1lci1jb21wbGV4IHsgCiAgICAgICAgd2lkdGg6IDU1cHg7IGhlaWdodDogNTVweDsgCiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyAKICAgICAgICB3aWR0aDogNDhweDsgaGVpZ2h0OiA0OHB4OyAKICAgICAgICB0b3A6IC0zcHg7IGxlZnQ6IC0zcHg7IHJpZ2h0OiAtM3B4OyBib3R0b206IC0zcHg7IAogICAgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDE4cHg7IG1hcmdpbi10b3A6IDA7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogOHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAKICAgIC8qIE1pbmlNYXA6IFRvcCBSaWdodCwgYmVsb3cgSFVEICovCiAgICAjbWluaW1hcC1jb250YWluZXIgeyAKICAgICAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgIH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAvKiBHb2FsIERpc3RhbmNlOiBUb3AgTGVmdCwgYmVsb3cgSFVEICovCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyAKICAgICAgICBsZWZ0OiAxMHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgCiAgICAgICAgcGFkZGluZzogMnB4IDhweDsKICAgIH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuZGlzdGFuY2UtbGFiZWwgeyBmb250LXNpemU6IDhweDsgfQoKICAgIC8qIFBsYXllciBTdGF0dXM6IE1vdmUgdG8gVG9wIExlZnQgKGJlbG93IEdvYWwgRGlzdGFuY2UpIHRvIGZyZWUgdXAgYm90dG9tLWxlZnQgZm9yIGpveXN0aWNrICovCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IAogICAgICAgIHRvcDogbWF4KDEwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA5MHB4KTsKICAgICAgICBsZWZ0OiAxMHB4OwogICAgICAgIGJvdHRvbTogYXV0bzsKICAgICAgICB3aWR0aDogMTQwcHg7IAogICAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgICB0cmFuc2Zvcm06IHNrZXdYKC01ZGVnKTsKICAgIH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDEycHg7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWdhdWdlLWNvbnRhaW5lciB7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWxhYmVsLCAudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogOHB4OyB3aWR0aDogMTVweDsgfQogICAgLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyB3aWR0aDogNDBweDsgfQoKICAgIC8qIFRlY2ggRmxhc2g6IEZ1bGwgd2lkdGgsIHNtYWxsZXIgdGV4dCAqLwogICAgI3RlY2gtZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgaGVpZ2h0OiAxMDBweDsKICAgICAgICB0b3A6IDI1JTsKICAgIH0KICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDMycHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC50ZWNoLXRpbWVyLXRyYWNrIHsgd2lkdGg6IDE4MHB4OyB9CiAgICAKICAgIC8qIEFjdGlvbiBCdXR0b246IEJvdHRvbSBSaWdodCAqLwovKiBBY3Rpb24gQnV0dG9uOiBCb3R0b20gUmlnaHQgLSBVUFNDQUxFRCBGT1IgOToxNiAqLwogICAgI2FjdGlvbi1jb250YWluZXIgewogICAgICAgIGJvdHRvbTogbWF4KDUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICAgICAgcmlnaHQ6IG1heCgzMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CiAgICAjYWN0aW9uLWJ1dHRvbiB7IHdpZHRoOiAxMzBweDsgaGVpZ2h0OiAxMzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMnB4OyBwYWRkaW5nOiA0cHggMTJweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAvKiBUYWNrbGUgQnV0dG9uOiBMZWZ0IG9mIEFjdGlvbiBCdXR0b24gKEVyZ29ub21pYyBhcmMpICovCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsKICAgICAgICBib3R0b206IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMTgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsgLyogU2hpZnRlZCBsZWZ0IHRvIGNsZWFyIGxhcmdlciBhY3Rpb24gYnRuICovCiAgICB9CiAgICAjdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgeyBmb250LXNpemU6IDEycHg7IH0KICAgIAogICAgLyogQ29udHJvbHMgLyBTZXR0aW5ncyBCdXR0b25zOiBUb3AgUmlnaHQgY29sdW1uICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHdpZHRoOiA4MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHRvcDogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxNDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxOTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTgwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHBhZGRpbmc6IDZweCAwOwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgfQogICAgCiAgICAvKiBKb3lzdGljayBab25lcyAqLwogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsgLyogTG93ZXIgaGFsZiBvbmx5ICovCiAgICAgICAgd2lkdGg6IDUwJTsKICAgICAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB9CiAgICAjYWltLWpveXN0aWNrLXpvbmUgewogICAgICAgIGhlaWdodDogNDAlOwogICAgICAgIHdpZHRoOiA1MCU7CiAgICAgICAgYm90dG9tOiAwOwogICAgICAgIHJpZ2h0OiAwOwogICAgfQoKICAgIC8qIEFubm91bmNlbWVudHM6IEVuc3VyZSB0aGV5IHdyYXAgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzZweCwgMTB2dywgNTBweCk7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICBsZWZ0OiA1JTsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAgICAgdG9wOiAzMCU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTJ2dywgNzBweCkgIWltcG9ydGFudDsKICAgIH0KCiAgICAvKiBNZW51cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IDQycHg7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgIC5mZngtbG9nby1zdWIgeyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiA2cHg7IH0KICAgIC5tZW51LW9wdGlvbnMgeyB3aWR0aDogMjIwcHg7IH0KICAgIC5tZW51LWl0ZW0geyBwYWRkaW5nOiAxMHB4IDE1cHg7IH0KICAgIC5tZW51LWl0ZW0gLmxhYmVsIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzIFBhbmVsICovCiAgICAjc2V0dGluZ3MtcGFuZWwgewogICAgICAgIHdpZHRoOiA5MCU7CiAgICAgICAgbWF4LXdpZHRoOiAzMjBweDsKICAgIH0KICAgIAogICAgLyogUHJhY3RpY2UgUGFuZWwgKi8KICAgIC5wcmFjdGljZS1wYW5lbCB7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgICAgIHJpZ2h0OiA1JTsKICAgIH0KfQ==","./style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAtLS0gKi8KLyogLS0tIEhVRCBUT1AgKENSWVNUQUwgSFVEKSAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcGFkZGluZy10b3A6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IG5vbmU7IC8qIFJlbW92ZWQgZmxhdCBncmFkaWVudCAqLwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHotaW5kZXg6IDEwMDA7Cn0KCi8qIE1pc3QgTGF5ZXIgKi8KLmh1ZC1taXN0IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwcHg7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDIwMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KDUwJSAxMDAlIGF0IDUwJSAwJSwgcmdiYSgwLCAyNDIsIDI1NSwgMC4xNSkgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgZmlsdGVyOiBibHVyKDIwcHgpOwogICAgei1pbmRleDogLTE7CiAgICBhbmltYXRpb246IG1pc3RQdWxzZSA2cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBtaXN0UHVsc2UgewogICAgMCUgeyBvcGFjaXR5OiAwLjQ7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyB9CiAgICAxMDAlIHsgb3BhY2l0eTogMC43OyB0cmFuc2Zvcm06IHNjYWxlWSgxLjIpOyB9Cn0KCi8qIFRlYW0gV2luZyAoQ3J5c3RhbCBTaGFyZCkgKi8KLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTgwcHg7IGhlaWdodDogNjVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoNiwgMTIsIDI0LCAwLjkpIDAlLCByZ2JhKDIyLCA1MCwgOTEsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTJweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxMnB4KTsKICAgIAogICAgLyogQXN5bW1ldHJpYyBTaGFyZCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCA4NSUgMTAwJSwgMCUgMTAwJSk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMCAxNXB4IDAgMjVweDsKICAgIG1hcmdpbi10b3A6IDEwcHg7CiAgICAKICAgIC8qIEdsb3cgKi8KICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDhweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjQpKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWigwKTsgLyogRm9yY2UgR1BVICovCn0KCi8qIElubmVyIFNoaW5lICovCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEwNWRlZywgdHJhbnNwYXJlbnQgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMikgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICBhbmltYXRpb246IHNoaW1tZXIgNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiBUb3AgR2xvd2luZyBCb3JkZXIgKi8KLmNyeXN0YWwtYm9yZGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWN5YW4pLCB0cmFuc3BhcmVudCk7CiAgICB6LWluZGV4OiAyOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9CgovKiBBd2F5IFRlYW0gTWlycm9yICovCi50ZWFtLXdpbmcuYXdheSB7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjAwZGVnLCByZ2JhKDYsIDEyLCAyNCwgMC45KSAwJSwgcmdiYSg2MCwgMTAsIDEwLCAwLjgpIDEwMCUpOwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCAxMDAlIDEwMCUsIDE1JSAxMDAlKTsKICAgIHBhZGRpbmc6IDAgMjVweCAwIDE1cHg7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggcmdiYSgyNTUsIDY4LCA2OCwgMC40KSk7Cn0KCi50ZWFtLXdpbmcuYXdheSAuY3J5c3RhbC1ib3JkZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgI2ZmNDQ0NCwgdHJhbnNwYXJlbnQpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQ0NDsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCi50ZWFtLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpOwogICAgbWFyZ2luLWJvdHRvbTogLTJweDsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDZweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIG1pbi13aWR0aDogNDBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiA1Owp9Ci50ZWFtLXdpbmcuYXdheSAuc2NvcmUtYm94IHsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0NDQ7IH0KCi8qIFRpbWVyIChTcGhlcmUgR3JpZCBOb2RlKSAqLwoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAKICAgIC8qIFNwaGVyZSBMb29rICovCiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsIHJnYmEoNDAsIDgwLCAxMjAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSA4MCUpOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDI1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC40KSwKICAgICAgICBpbnNldCAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjIpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwogICAgei1pbmRleDogMTA7Cn0KCi8qIEZsb2F0aW5nIFJpbmcgKi8KLnRpbWVyLWNyeXN0YWwtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC04cHg7IGxlZnQ6IC04cHg7IHJpZ2h0OiAtOHB4OyBib3R0b206IC04cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYW5pbWF0aW9uOiBzcGhlcmVTcGluIDhzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogbm9uZTsKfQoKQGtleWZyYW1lcyBzcGhlcmVTcGluIHsgCiAgICBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gCiAgICB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gCn0KCi50aW1lci1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICBtYXJnaW4tdG9wOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgKExJUVVJRCBMSUdIVCkgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44NSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjYpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjIpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDE1cHggMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOyAvKiBNYW5hZ2VkIGJ5IEpTICovCiAgICBib3gtc2hhZG93OiAwIDEwcHggMzBweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgovKiBEZWNvcmF0aXZlIGJhY2tncm91bmQgc2hhcmQgKi8KI3BsYXllci1zdGF0dXMtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMDMpIDUwJSwgdHJhbnNwYXJlbnQgNTUlKTsKICAgIGFuaW1hdGlvbjogc2hpbW1lciA2cyBpbmZpbml0ZSBsaW5lYXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmNoYXItbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNnB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KLmhwLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMzMzQ0NTU7CiAgICBtYXJnaW46IDAgOHB4OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IGluc2V0IDAgMCA1cHggcmdiYSgwLDAsMCwwLjgpOwp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwYWE0NCwgIzQ0ZmY4OCwgIzAwYWE0NCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyAzcyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZjQ0OwogICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKfQouaHAtdmFsdWUgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OyAKICAgIGNvbG9yOiAjZmZmOyAKICAgIHdpZHRoOiA1NXB4OyAKICAgIHRleHQtYWxpZ246IHJpZ2h0OyAKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi50ZWNoLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci50ZWNoLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0MzMyMjsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2FhNjYwMCwgI2ZmY2MwMCwgI2FhNjYwMCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyA0cyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICNmZmFhMDA7Cn0KCkBrZXlmcmFtZXMgbGlxdWlkRmxvdyB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDEwMCUgMDsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0xMDAlIDA7IH0KfQovKiAtLS0gTUlOSU1BUCAtLS0gKi8KI21pbmltYXAtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBoZWlnaHQ6IDExMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnJhZGFyLXJpbSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWJsdWUtbWlkKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICB6LWluZGV4OiA1Owp9CgojbWluaW1hcCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwcHg7CiAgICBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogNjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5yYWRhci1sYWJlbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0xNXB4OwogICAgd2lkdGg6IDE0MCU7CiAgICBsZWZ0OiAtMjAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCi5tYXAtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiA2cHg7IGhlaWdodDogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgNHB4IGN1cnJlbnRDb2xvcjsKfQoubWFwLWRvdC5ob21lIHsgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB9Ci5tYXAtZG90LmF3YXkgeyBiYWNrZ3JvdW5kOiAjZmY0NDQ0OyBjb2xvcjogI2ZmNDQ0NDsgfQoubWFwLWRvdC5iYWxsIHsgCiAgICBiYWNrZ3JvdW5kOiAjZmYwMGNjOwogICAgY29sb3I6ICNmZjAwY2M7IAogICAgd2lkdGg6IDEycHg7IGhlaWdodDogMTJweDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICB6LWluZGV4OiAyMDsKICAgIGFuaW1hdGlvbjogYmxpbmtCYWxsIDAuM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYm94LXNoYWRvdzogMCAwIDZweCAjZmYwMGNjOwp9Ci5tYXAtZG90Lm5hcCB7IGJhY2tncm91bmQ6ICMzMzM7IGNvbG9yOiAjMDAwOyBib3JkZXI6IDFweCBzb2xpZCAjNTU1OyB9Ci5tYXAtZG90LmFjdGl2ZS1wbGF5ZXIgeyAKICAgIGJhY2tncm91bmQ6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBjb2xvcjogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGJveC1zaGFkb3c6IDAgMCA4cHggIzAwZmYwMDsKICAgIHotaW5kZXg6IDE1OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsKfQoubWFwLWRvdC5iYWxsLWNhcnJpZXIgewogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmZiwgMCAwIDMwcHggI2ZmYWEwMDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB6LWluZGV4OiAxMDA7CiAgICB3aWR0aDogMTBweDsgaGVpZ2h0OiAxMHB4OwogICAgYW5pbWF0aW9uOiBjYXJyaWVyUHVsc2UgMC44cyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KQGtleWZyYW1lcyBjYXJyaWVyUHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmY7IG9wYWNpdHk6IDAuODsgfQogICAgdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjgpOyBib3gtc2hhZG93OiAwIDAgMjVweCAjZmZjYzAwOyBvcGFjaXR5OiAxLjA7IH0KfQpAa2V5ZnJhbWVzIGJsaW5rQmFsbCB7IGZyb20geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfSB0byB7IG9wYWNpdHk6IDAuNTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4zKTsgfSB9CgovKiAtLS0gQU5OT1VOQ0VNRU5UUyAtLS0gKi8KI2Fubm91bmNlbWVudCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDQwJTsgCiAgICBsZWZ0OiA1JTsgCiAgICB3aWR0aDogOTAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IGNsYW1wKDQwcHgsIDEydncsIDcycHgpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDQwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpKSBkcm9wLXNoYWRvdygzcHggM3B4IDAgIzAwMCk7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGFuaW1hdGlvbjogYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIChFVEhFUkVBTCBJTlRFUkZBQ0UpIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgUmluZyAqLwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEwcyBsaW5lYXIgaW5maW5pdGU7Cn0KCiNqb3lzdGljay1iYXNlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTAlOyBsZWZ0OiAxMCU7IHdpZHRoOiA4MCU7IGhlaWdodDogODAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDVzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIGV0aGVyZWFsU3BpbiB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBQeXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmZmZmYgMCUsICNhMmY5ZmYgNDAlLCAjMDBmMmZmIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZjJmZiwgMCAwIDMwcHggIzAwZjJmZjsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgb3BhY2l0eTogMC44Owp9Cgojam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIiI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB1bHNlLWdsb3cgMnMgaW5maW5pdGU7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC41KTsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7CiAgICBhbmltYXRpb246IHJpcHBsZUFuaW0gMC42cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgcmlwcGxlQW5pbSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOyBvcGFjaXR5OiAxOyBib3JkZXItd2lkdGg6IDVweDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IGJvcmRlci13aWR0aDogMHB4OyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAoU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7IAogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKei1pbmRleDogMTUwMDsKfQouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAyMjBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvdHRvbTogMjBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuOCkgMCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICB6LWluZGV4OiAtMTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY29tbWFuZC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDIwcyBsaW5lYXIgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSk7Cn0KLmNvbW1hbmQtcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMTBweDsgbGVmdDogLTEwcHg7IHJpZ2h0OiAtMTBweDsgYm90dG9tOiAtMTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRvdHRlZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDEwcyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKQGtleWZyYW1lcyBzcGluUmV2ZXJzZSB7IGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMzYwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgwZGVnKTsgfSB9CgojYWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgcGFkZGluZzogNHB4IDE2cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgei1pbmRleDogMjA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIC8qIERlZXAgU2hhZG93ICYgM0QgQ29udGV4dCAqLwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAzMHB4IDYwcHggcmdiYSgwLCAwLCAwLCAwLjkpLAogICAgICAgIDAgMCAwIDJweCByZ2JhKDAsIDAsIDAsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiBub25lOwogICAgYm9yZGVyOiBub25lOwogICAgcGVyc3BlY3RpdmU6IDEwMDBweDsKICAgIHRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOwp9CgovKiBLZXlmcmFtZXMgZm9yIExpdmluZyBVSSAqLwpAa2V5ZnJhbWVzIHJpbmctZ3lyby16IHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDM2MGRlZyk7IH0KfQoKQGtleWZyYW1lcyByaW5nLXdvYmJsZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoMTBkZWcpIHJvdGF0ZVkoNWRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDEwZGVnKTsgfQogICAgNzUlIHsgdHJhbnNmb3JtOiByb3RhdGVYKC0xMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9Cn0KCkBrZXlmcmFtZXMgcnVuZS1zcGluLWdsb3cgewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKSBzY2FsZSgxLjA1KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgOHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpKTsgb3BhY2l0eTogMS4wOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQp9CgpAa2V5ZnJhbWVzIGxpcXVpZC1zdXJnZS1jb21wbGV4IHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjAyKTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDQ5JTsgYm94LXNoYWRvdzogMCAwIDUwcHggIzAwZmZmZiwgaW5zZXQgMCAwIDQwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQp9CgpAa2V5ZnJhbWVzIGNyeXN0YWwtYnJlYXRoZSB7CiAgICAwJSwgMTAwJSB7IGJvcmRlci1jb2xvcjogcmdiYSgwLCAyMDAsIDI1NSwgMC4zKTsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDIwcHggIzAwMDAwMDsgfQogICAgNTAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMzBweCAjMDAxMTMzLCAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOyB9Cn0KCi8qIExheWVyIDE6IE91dGVyIE9ybmF0ZSBSaW5nIChNZXRhbC9Hb2xkKSAtIFRoZSBHeXJvICovCi5hYi1vdXRlci1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLThweDsgbGVmdDogLThweDsgcmlnaHQ6IC04cHg7IGJvdHRvbTogLThweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjYjg4NjBiLCAjZmZkNzAwLCAjZmZmYWNkLCAjZmZkNzAwLCAjYjg4NjBiLCAjOGI0NTAwLCAjYjg4NjBiCiAgICApOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgaW5zZXQgMCAwIDEwcHggcmdiYSgwLDAsMCwwLjgpLAogICAgICAgIDAgMCAyNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuMyk7CiAgICB6LWluZGV4OiAxOwogICAgYm9yZGVyOiAxcHggc29saWQgIzU1MzMwMDsKICAgIC8qIENvbXBsZXggcm90YXRpb24gKi8KICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMjBzIGxpbmVhciBpbmZpbml0ZTsKfQoKLyogUHNldWRvLWVsZW1lbnQgZm9yIDNEIGRlcHRoL3dvYmJsZSBlZmZlY3Qgb24gdGhlIHJpbmcgKi8KLmFiLW91dGVyLXJpbmc6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjUpOwogICAgYW5pbWF0aW9uOiByaW5nLXdvYmJsZSA4cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAyOiBSdW5lIFJpbmcgKFNwaW5uaW5nKSAqLwouYWItcnVuZS1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgLyogYm94LXNoYWRvdyBoYW5kbGVkIGJ5IGFuaW1hdGlvbiAqLwogICAgei1pbmRleDogMjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAzOiBJbm5lciBDcnlzdGFsIEhvdXNpbmcgKERhcmsgR2xhc3MpICovCi5hYi1pbm5lci1jcnlzdGFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNnB4OyBsZWZ0OiA2cHg7IHJpZ2h0OiA2cHg7IGJvdHRvbTogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgMCUsIHJnYmEoMCwgMTAsIDMwLCAwLjk1KSA2MCUsICMwMDAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogMzsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGFuaW1hdGlvbjogY3J5c3RhbC1icmVhdGhlIDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgovKiBMYXllciA0OiBMaXF1aWQgQ29yZSAoQW5pbWF0ZWQgU3VyZmFjZSkgKi8KLmFiLWxpcXVpZC1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTJweDsgbGVmdDogMTJweDsgcmlnaHQ6IDEycHg7IGJvdHRvbTogMTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIENvbXBsZXggR3JhZGllbnQgZm9yIGxpcXVpZCBtb3Rpb24gKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNDAlIDQwJSwgIzAwZmZmZiAwJSwgIzAwODhmZiA0MCUsICMwMDIyNjYgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDE1MCUgMTUwJTsKICAgIHotaW5kZXg6IDQ7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExpcXVpZCBtb3ZlbWVudCBlZmZlY3QgKEludGVybmFsIHJlZmxlY3Rpb24pICovCi5hYi1saXF1aWQtY29yZTo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC41KSAwJSwgdHJhbnNwYXJlbnQgMjUlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkTW92ZSA1cyBpbmZpbml0ZSBlYXNlLWluLW91dDsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5Owp9CgovKiBMYXllciA1OiBMaW1pdCBCcmVhayBSaW5nIChIaWRkZW4gYnkgZGVmYXVsdCkgKi8KLmxpbWl0LXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjJweDsgbGVmdDogLTIycHg7IHJpZ2h0OiAtMjJweDsgYm90dG9tOiAtMjJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogNHB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmNDQwMDsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmFhMDA7CiAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsKICAgIHotaW5kZXg6IDA7CiAgICBvcGFjaXR5OiAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMS41cyBsaW5lYXIgaW5maW5pdGU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBsaW1pdFNwaW4gewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBodWUtcm90YXRlKDBkZWcpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgxNWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogTGF5ZXIgNjogVGV4dCBMYWJlbCAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXNoYWRvdzogCiAgICAgICAgMCAycHggMCAjMDAwLAogICAgICAgIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDEuMCksCiAgICAgICAgMCAwIDMwcHggIzAwODhmZjsKICAgIHotaW5kZXg6IDY7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHRvcDogMXB4OwogICAgYW5pbWF0aW9uOiB0ZXh0RmxvYXQgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgdGV4dEZsb2F0IHsKICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7IH0KfQoKLyogTGF5ZXIgNzogR2xhcmUgKi8KI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDI1NSwyNTUsMjU1LDAuNikgMCUsIHRyYW5zcGFyZW50IDQ1JSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICB6LWluZGV4OiA3OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogc29mdC1saWdodDsKfQoKLyogU1RBVEU6IFNIT09UIE1PREUgKE9yYW5nZS9SZWQpICovCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICM4YjAwMDAsICNmZjQ0MDAsICNmZmFhMDAsICNmZjQ0MDAsICM4YjAwMDAsICM0NDAwMDAsICM4YjAwMDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgNTBweCByZ2JhKDI1NSwgNjgsIDAsIDAuOSk7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDVzIGxpbmVhciBpbmZpbml0ZTsgLyogRmFzdGVyIHNwaW4gKi8KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjZmZmZjAwIDAlLCAjZmY0NDAwIDUwJSwgIzY2MDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogY29yZVB1bHNlUmVkIDAuNHMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgpAa2V5ZnJhbWVzIGNvcmVQdWxzZVJlZCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC45NSk7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDA7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wOCk7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIDAgMCAyMHB4ICNmZmY7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjMpOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmJ0bi10ZXh0IHsKICAgIHRleHQtc2hhZG93OiAwIDJweCAwICMwMDAsIDAgMCAyMHB4ICNmZjQ0MDA7Cn0KCi8qIFNUQVRFOiBMSU1JVCBSRUFEWSAoSGVyY3VsZWFuIEdvbGQpICovCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIG9wYWNpdHk6IDE7CiAgICBib3JkZXItd2lkdGg6IDZweDsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZmY7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiAjZmZkNzAwOwogICAgYm94LXNoYWRvdzogMCAwIDYwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDIwcHggI2ZmNDQwMDsKICAgIGFuaW1hdGlvbjogbGltaXRTcGluIDAuOHMgbGluZWFyIGluZmluaXRlLCBsaW1pdFB1bHNlIDAuM3MgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCAjZmZmZmZmKTsKfQoKQGtleWZyYW1lcyBsaW1pdFB1bHNlIHsKICAgIGZyb20geyBvcGFjaXR5OiAwLjg7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDAsIGluc2V0IDAgMCAyMHB4ICNmZmFhMDA7IH0KICAgIHRvIHsgb3BhY2l0eTogMS4wOyBib3gtc2hhZG93OiAwIDAgODBweCAjZmZhYTAwLCBpbnNldCAwIDAgNDBweCAjZmZmZjAwOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1vdXRlci1yaW5nIHsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjZmZkNzAwLCAjZmZmZmZmLCAjZmZhYTAwLCAjZmZmZmZmLCAjZmZkNzAwLCAjYjg4NjBiLCAjZmZkNzAwCiAgICApOwogICAgYm94LXNoYWRvdzogMCAwIDgwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC44KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMnMgbGluZWFyIGluZmluaXRlOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLXJ1bmUtcmluZyB7CiAgICBib3JkZXItY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCA0MHB4ICMwMGZmZmY7CiAgICBhbmltYXRpb246IHJ1bmUtc3Bpbi1nbG93IDNzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDIwJSwgI2ZmODgwMCA2MCUsICNmZjAwMDAgMTAwJSk7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDAuNXMgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmJ0bi10ZXh0IHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwMDAsIDAgMCAyMHB4ICNmZmZmMDAsIDAgMCA0MHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAwLjJzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLyogU1RBVEU6IEFDVElWRSAoQ2hhcmdpbmcvUHJlc3NlZCkgKi8KI2FjdGlvbi1idXR0b24uYWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDQwJSwgI2ZmZmZhYSA3MCUsICNmZmFhMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCAjZmZmZmZmLCBpbnNldCAwIDAgNTBweCAjZmZmZmZmOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDIuMCkgY29udHJhc3QoMS4yKTsKICAgIGFuaW1hdGlvbjogbm9uZTsgLyogU29saWQgaW50ZW5zZSBsaWdodCAqLwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmFiLW91dGVyLXJpbmcgewogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAwLjJzIGxpbmVhciBpbmZpbml0ZTsgLyogSHlwZXIgc3BpbiAqLwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTAwcHggI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC4xcyBsaW5lYXIgaW5maW5pdGU7CiAgICBvcGFjaXR5OiAxOwp9Ci8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CiNhdXRvLXRvZ2dsZS5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgxMDAsIDIwLCAwLCAwLjgpIDAlLCByZ2JhKDQwLCAwLCAwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDAwOwogICAgY29sb3I6ICNmZmFhMDA7CiAgICBhbmltYXRpb246IHB1bHNlUmVkIDJzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgcHVsc2VSZWQgeyAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSA1MCUgeyBib3gtc2hhZG93OiAwIDAgMjBweCAjZmY0NDAwOyB9IDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gfQoKLyogLS0tIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LXdyYXBwZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKICAgIGNvbnRhaW46IGxheW91dCBzdHlsZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMjRweDsgCiAgICB0ZXh0LXNoYWRvdzogMXB4IDFweCAwICMwMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmRhbWFnZSB7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZjYzAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuOHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oZWFsIHsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjNDRmZjQ0OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmMDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnZlbm9tIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNhYWZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzQ0ODgwMCwgMnB4IDJweCAwICMwMDIyMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjY2NmZjY2IDAlLCAjNjZjYzAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggcmdiYSgxMDAsIDI1NSwgMCwgMC41KSk7CiAgICBhbmltYXRpb246IGRyaXBTdGF0dXMgMnMgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsZWVwIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMDQ0ZmYsIDAgMCAzMHB4ICMwMDAwZmY7CiAgICBvcGFjaXR5OiAwLjk7CiAgICBhbmltYXRpb246IGRyaWZ0U3RhdHVzIDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci53aXRoZXIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM4cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzQ0NDQ0NDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNlZWVlZWUgMCUsICM4ODg4ODggMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnRlY2ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC43KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgIzAwZmZmZjsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMDg4ZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjZmZmOwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC42cyBlYXNlLWluLW91dCwgZmxhc2hUZWNoIDAuM3M7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNhdmUsIC5mbG9hdGluZy10ZXh0LWlubmVyLmJsb2NrIHsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDA0NDg4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMDg4ZmY7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHBvcERhbWFnZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOyBvcGFjaXR5OiAxOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBmbG9hdFVwIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MHB4KTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGRyaXBTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEuMSkgdHJhbnNsYXRlWSg1cHgpOyBmaWx0ZXI6IGJsdXIoMXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGRyaWZ0U3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDE1cHgpIHRyYW5zbGF0ZVkoLTIwcHgpIHJvdGF0ZSgxMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTE1cHgpIHRyYW5zbGF0ZVkoLTUwcHgpIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgd2l0aGVyU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBncmF5c2NhbGUoMCUpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjYpOyBmaWx0ZXI6IGdyYXlzY2FsZSgxMDAlKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHNoYWtlVGVjaCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC44KTsgfQogICAgMTAlLCAzMCUsIDUwJSwgNzAlLCA5MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKC0ycHgsIDJweCk7IH0KICAgIDIwJSwgNDAlLCA2MCUsIDgwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoMnB4LCAtMnB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQp9CgpAa2V5ZnJhbWVzIGZsYXNoVGVjaCB7CiAgICAwJSB7IGJhY2tncm91bmQtY29sb3I6ICNmZmY7IGNvbG9yOiAjMDAwOyBib3JkZXItY29sb3I6ICNmZmY7IH0KICAgIDEwMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDEwLCAzMCwgMC44NSk7IGNvbG9yOiAjMDBmZmZmOyBib3JkZXItY29sb3I6ICMwMGZmZmY7IH0KfQoKI2xvYWRpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgYW5pbWF0aW9uOiBibGluayAxcyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIGJsaW5rIHsgNTAlIHsgb3BhY2l0eTogMC41OyB9IH0KCiNjb250cm9scy1oaW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTMwcHg7IHdpZHRoOiAxMDAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC40KTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtaW1wYWN0IHsKICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZjAwOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDNweCAzcHggMCAjZmYwMDAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNQb3AgMC40cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1hY3Rpb24gewogICAgZm9udC1mYW1pbHk6ICdBcmlhbCBCbGFjaycsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogIzAwZmZmZjsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwNDRhYTsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljU2xpZGUgMC40cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCkBrZXlmcmFtZXMgY29taWNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMjBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICA2MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBjb21pY1NsaWRlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTIwcHgsIDIwcHgpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMjBweCkgc2NhbGUoMS4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gTUFJTiBNRU5VIC0tLSAqLwovKiAtLS0gTUFJTiBNRU5VICYgRU5EIEdBTUUgKEZGWCBTVFlMRSkgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgKEZBWVRIIElOVEVSRkFDRSkgLS0tICovCiNtYWluLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQXN5bW1ldHJpYyBSaWdodCBBbGlnbiAqLwogICAgcGFkZGluZy1yaWdodDogMTAlOwogICAgei1pbmRleDogMzAwMDsKICAgIG9wYWNpdHk6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC44cyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKICAgIAogICAgLyogRGVlcCBWb2lkIEJhY2tncm91bmQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDUwJSwgIzA1MTAyMCAwJSwgIzAwMDAwMCAxMDAlKTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNtYWluLW1lbnUuYWN0aXZlIHsKICAgIG9wYWNpdHk6IDE7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKLyogU2NhbmxpbmVzICYgVmlnbmV0dGUgKi8KLm1lbnUtYmctb3ZlcmxheSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoCiAgICAgICAgICAgIDBkZWcsCiAgICAgICAgICAgIHRyYW5zcGFyZW50IDBweCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMnB4LAogICAgICAgICAgICByZ2JhKDAsIDI1NSwgMjU1LCAwLjAyKSAzcHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDRweAogICAgICAgICk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoubWVudS1iZy1vdmVybGF5OjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMCwwLDAsMC44KSAxMDAlKTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IHJpZ2h0OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgouZmZ4LWxvZ28tbWFpbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDYwcHgsIDEydncsIDEwMHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxMHB4OwogICAgbGluZS1oZWlnaHQ6IDAuOTsKICAgIAogICAgLyogQ3J5c3RhbCBHcmFkaWVudCAqLwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0NSUsICMwMDg4ZmYgNTUlLCAjMDAyMjY2IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7CiAgICBhbmltYXRpb246IGxvZ29GbG9hdCA0cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBsb2dvRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMTBweCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgwLCAyMDAsIDI1NSwgMC44KSk7IH0KfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDR2dywgMzJweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMDsKICAgIG9wYWNpdHk6IDAuOTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9CgovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKLyogTUVOVSBPUFRJT05TIChBc3ltbWV0cmljIExpc3QpICovCiAgICB3aWR0aDogNDAwcHg7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7IC8qIEFsaWduIGl0ZW1zIHRvIHJpZ2h0ICovCn0KCi5tZW51LWl0ZW0gewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4IDQwcHggMTVweCAyMHB4OwogICAgCiAgICAvKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDQwLCA4MCwgMC44KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMCkgMTAwJSk7CiAgICBib3JkZXItcmlnaHQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICAKICAgIGN1cnNvcjogcG9pbnRlcjsKLyogR2xhc3MgU2hhcmQgTG9vayAqLwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgCiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKfQoKLm1lbnUtaXRlbTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDEwMCwgMjAwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogIzAwZmZmZjsKICAgIHBhZGRpbmctcmlnaHQ6IDYwcHg7IC8qIFNsaWRlIGxlZnQgZWZmZWN0ICovCiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2FhYWFhYTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7IC8qIENvdW50ZXIgc2tldyB0ZXh0ICovCiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzLCB0ZXh0LXNoYWRvdyAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmLCAwIDAgMjBweCAjMDA4OGZmOwp9CgovKiBQWVJFRkxZIENVUlNPUiAqLwoubWVudS1pdGVtIC5jdXJzb3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgcmlnaHQ6IDE1cHg7CiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogI2ZmZDcwMDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgwKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDEwcHggI2ZmZDcwMCwKICAgICAgICAwIDAgMjBweCAjZmZhYTAwLAogICAgICAgIDAgMCA0MHB4ICNmZjQ0MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICByaWdodDogMzBweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpOwogICAgYW5pbWF0aW9uOiBweXJlZmx5V2lnZ2xlIDFzIGluZmluaXRlIGVhc2UtaW4tb3V0Owp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlXaWdnbGUgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgxKSB0cmFuc2xhdGUoMCwgMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEuMikgdHJhbnNsYXRlKC0ycHgsIC0ycHgpOyB9Cn0KCi8qIFBhcnRpY2xlIHRyYWlsIGZvciBjdXJzb3IgKFBzZXVkbyBlbGVtZW50KSAqLwoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3I6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGluaGVyaXQ7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB5cmVmbHlUcmFpbCAxcyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBweXJlZmx5VHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDIuNSk7IG9wYWNpdHk6IDA7IH0KfQoKLm1lbnUtZm9vdGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogMzBweDsKICAgIHJpZ2h0OiA0MHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KLyogRU5EIEdBTUUgU1BFQ0lGSUMgKi8KI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzNTAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjVzOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxNSwgMC45KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9CgojZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCi8qIC0tLSBQUkFDVElDRSBPVkVSTEFZIChTUEhFUkUgUE9PTCBURVJNSU5BTCkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNCk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMzAwcHg7CiAgICAKICAgIC8qIEhvbG9ncmFwaGljIEdsYXNzICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA0MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE1cHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAKICAgIC8qIFRlY2ggU2hhcGUgKi8KICAgIGNsaXAtcGF0aDogcG9seWdvbigKICAgICAgICAyMHB4IDAsIDEwMCUgMCwgCiAgICAgICAgMTAwJSBjYWxjKDEwMCUgLSAyMHB4KSwgY2FsYygxMDAlIC0gMjBweCkgMTAwJSwgCiAgICAgICAgMCAxMDAlLCAwIDIwcHgKICAgICk7CiAgICAKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIAogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwKICAgICAgICBpbnNldCAwIDAgNTBweCByZ2JhKDAsIDIwLCA2MCwgMC41KTsKICAgICAgICAKICAgIHBhZGRpbmc6IDIwcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIAogICAgLyogR3JpZCBQYXR0ZXJuIE92ZXJsYXkgKi8KICAgIGJhY2tncm91bmQtaW1hZ2U6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCksCiAgICAgICAgbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwcHggMjBweDsKICAgIAogICAgYW5pbWF0aW9uOiBwYW5lbEZsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHBhbmVsRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNXB4KTsgfQp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7CiAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKfQoKLnBhbmVsLXRpdGxlLWdyb3VwIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9CgoucGFuZWwtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5wYW5lbC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG9wYWNpdHk6IDAuODsKfQoKLnBhbmVsLWNvbnRlbnQgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDIwcHg7Cn0KCi5zZWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHJnYmEoMjU1LCAyMDAsIDAsIDAuNSk7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7CiAgICBnYXA6IDhweDsKfQoKLmRyaWxsLWJ0biB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgcGFkZGluZzogMTBweCA1cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDIwLCA0MCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouZHJpbGwtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjgpOwogICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5kcmlsbC1idG4uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOCkgMCUsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIGljb25zIGZvciBjbGVhbmVyIGdyaWQgKi8KfQoKLm9wdGlvbi1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA4cHg7Cn0KCi5vcHRpb24tdG9nZ2xlIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogI2FhYTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpOwogICAgY29sb3I6ICNmZmY7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBib3JkZXItY29sb3I6ICMwMGZmMDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDAsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHJnYmEoMCwgMjU1LCAwLCAwLjIpOwp9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6IGluaGVyaXQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoNTAsIDAsIDAsIDAuNiksIHJnYmEoMjAsIDAsIDAsIDAuOCkpOwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIHBhZGRpbmc6IDhweDsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjZmZhYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCA2OCwgMC41KTsKfQoKI3AtcmVzZXQtYmFsbCB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNTAsIDEwMCwgMC42KSwgcmdiYSgwLCAyMCwgNDAsIDAuOCkpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMGZmZmY7Cn0KI3AtcmVzZXQtYmFsbDpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDIwcHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTAwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgCiAgICBoZWlnaHQ6IDA7IAogICAgYm9yZGVyLWxlZnQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAxNXB4IHNvbGlkICMwMGZmZmY7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBjb2xvcjogIzg4YWFjYzsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKfQoKI2RyaWxsLXNjb3JlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjYpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICB3aWR0aDogMjRweDsgaGVpZ2h0OiAyNHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAyMnB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKfQoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTBweDsgcmlnaHQ6IDEwcHg7CiAgICB3aWR0aDogMjBweDsgaGVpZ2h0OiAyMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxOHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgojcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBwYWRkaW5nOiA4cHggMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgei1pbmRleDogMjQwMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CiNwcmFjdGljZS1yZXN0b3JlLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7Cn0KCi8qIC0tLSBBSU0gSk9ZU1RJQ0sgLS0tICovCiNhaW0tam95c3RpY2stem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgIHJpZ2h0OiAwOwogICAgd2lkdGg6IDQwJTsKICAgIGhlaWdodDogMzUlOwogICAgei1pbmRleDogMTAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMCk7CiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2FpbS1qb3lzdGljay12aXN1YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2FpbS1qb3lzdGljay1iYXNlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIEV0aGVyZWFsIE9yYW5nZSBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgyNTUsIDE1MCwgNTAsIDAuNCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjIpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgNTAsIDAsIDAuMSk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsMCwwLDApIDYwJSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4wNSkgMTAwJSk7CiAgICBhbmltYXRpb246IGV0aGVyZWFsU3BpbiAxMnMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhaW0tam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMzBweDsgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRmlyZWZseSBMaWdodCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZmZmIDAlLCAjZmZhYTAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZjY2MDA7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwogICAgb3BhY2l0eTogMC44Owp9Ci8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwp9CiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5ibGluZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMzMzMzMzOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMDAwMDAsIDJweCAycHggMCAjMTExOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgIzY2NiAwJSwgIzAwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMnMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNpbGVuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNXMgZWFzZS1pbi1vdXQ7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNoaWVsZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMGZmZmY7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogNXB4IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUwLCAxMDAsIDAuNSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oYXN0ZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjZmY4ODAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsb3cgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICM4ODU1MjI7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAoOToxNiBGaXJzdCkgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpLCBzY3JlZW4gYW5kIChtYXgtYXNwZWN0LXJhdGlvOiAxLzEpIHsKICAgIC8qIEhVRCBUb3A6IENvbXBhY3QgTGF5b3V0ICovCiAgICAjaHVkLXRvcCB7CiAgICAgICAgcGFkZGluZzogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSkgNXB4IDAgNXB4OwogICAgICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgfQoKICAgIC50ZWFtLXdpbmcgeyAKICAgICAgICB3aWR0aDogMzIlOyAKICAgICAgICBoZWlnaHQ6IDQ1cHg7CiAgICAgICAgcGFkZGluZzogMCA1cHg7IAogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSA4NSUsIDAlIDEwMCUpOwogICAgfQogICAgLnRlYW0td2luZy5hd2F5IHsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgMTAwJSwgMCUgODUlKTsKICAgIH0KCiAgICAuc2NvcmUtYm94IHsgCiAgICAgICAgZm9udC1zaXplOiAyOHB4OyAKICAgICAgICBtaW4td2lkdGg6IDIwcHg7IAogICAgfQogICAgCiAgICAudGVhbS1uYW1lIHsgCiAgICAgICAgZm9udC1zaXplOiAxMHB4OyAKICAgICAgICBsZXR0ZXItc3BhY2luZzogMHB4OyAKICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC8qIFRpbWVyIENvbXBhY3QgKi8KICAgIC50aW1lci1jb21wbGV4IHsgCiAgICAgICAgd2lkdGg6IDU1cHg7IGhlaWdodDogNTVweDsgCiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyAKICAgICAgICB3aWR0aDogNDhweDsgaGVpZ2h0OiA0OHB4OyAKICAgICAgICB0b3A6IC0zcHg7IGxlZnQ6IC0zcHg7IHJpZ2h0OiAtM3B4OyBib3R0b206IC0zcHg7IAogICAgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDE4cHg7IG1hcmdpbi10b3A6IDA7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogOHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAKICAgIC8qIE1pbmlNYXA6IFRvcCBSaWdodCwgYmVsb3cgSFVEICovCiAgICAjbWluaW1hcC1jb250YWluZXIgeyAKICAgICAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgIH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAvKiBHb2FsIERpc3RhbmNlOiBUb3AgTGVmdCwgYmVsb3cgSFVEICovCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyAKICAgICAgICBsZWZ0OiAxMHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgCiAgICAgICAgcGFkZGluZzogMnB4IDhweDsKICAgIH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuZGlzdGFuY2UtbGFiZWwgeyBmb250LXNpemU6IDhweDsgfQoKICAgIC8qIFBsYXllciBTdGF0dXM6IE1vdmUgdG8gVG9wIExlZnQgKGJlbG93IEdvYWwgRGlzdGFuY2UpIHRvIGZyZWUgdXAgYm90dG9tLWxlZnQgZm9yIGpveXN0aWNrICovCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IAogICAgICAgIHRvcDogbWF4KDEwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA5MHB4KTsKICAgICAgICBsZWZ0OiAxMHB4OwogICAgICAgIGJvdHRvbTogYXV0bzsKICAgICAgICB3aWR0aDogMTQwcHg7IAogICAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgICB0cmFuc2Zvcm06IHNrZXdYKC01ZGVnKTsKICAgIH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDEycHg7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWdhdWdlLWNvbnRhaW5lciB7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWxhYmVsLCAudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogOHB4OyB3aWR0aDogMTVweDsgfQogICAgLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyB3aWR0aDogNDBweDsgfQoKICAgIC8qIFRlY2ggRmxhc2g6IEZ1bGwgd2lkdGgsIHNtYWxsZXIgdGV4dCAqLwogICAgI3RlY2gtZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgaGVpZ2h0OiAxMDBweDsKICAgICAgICB0b3A6IDI1JTsKICAgIH0KICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDMycHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC50ZWNoLXRpbWVyLXRyYWNrIHsgd2lkdGg6IDE4MHB4OyB9CiAgICAKICAgIC8qIEFjdGlvbiBCdXR0b246IEJvdHRvbSBSaWdodCAqLwovKiBBY3Rpb24gQnV0dG9uOiBCb3R0b20gUmlnaHQgLSBVUFNDQUxFRCBGT1IgOToxNiAqLwogICAgI2FjdGlvbi1jb250YWluZXIgewogICAgICAgIGJvdHRvbTogbWF4KDUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICAgICAgcmlnaHQ6IG1heCgzMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CiAgICAjYWN0aW9uLWJ1dHRvbiB7IHdpZHRoOiAxMzBweDsgaGVpZ2h0OiAxMzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMnB4OyBwYWRkaW5nOiA0cHggMTJweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAvKiBUYWNrbGUgQnV0dG9uOiBMZWZ0IG9mIEFjdGlvbiBCdXR0b24gKEVyZ29ub21pYyBhcmMpICovCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsKICAgICAgICBib3R0b206IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMTgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsgLyogU2hpZnRlZCBsZWZ0IHRvIGNsZWFyIGxhcmdlciBhY3Rpb24gYnRuICovCiAgICB9CiAgICAjdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgeyBmb250LXNpemU6IDEycHg7IH0KICAgIAogICAgLyogQ29udHJvbHMgLyBTZXR0aW5ncyBCdXR0b25zOiBUb3AgUmlnaHQgY29sdW1uICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHdpZHRoOiA4MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHRvcDogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxNDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxOTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTgwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHBhZGRpbmc6IDZweCAwOwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgfQogICAgCiAgICAvKiBKb3lzdGljayBab25lcyAqLwogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsgLyogTG93ZXIgaGFsZiBvbmx5ICovCiAgICAgICAgd2lkdGg6IDUwJTsKICAgICAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB9CiAgICAjYWltLWpveXN0aWNrLXpvbmUgewogICAgICAgIGhlaWdodDogNDAlOwogICAgICAgIHdpZHRoOiA1MCU7CiAgICAgICAgYm90dG9tOiAwOwogICAgICAgIHJpZ2h0OiAwOwogICAgfQoKICAgIC8qIEFubm91bmNlbWVudHM6IEVuc3VyZSB0aGV5IHdyYXAgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzZweCwgMTB2dywgNTBweCk7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICBsZWZ0OiA1JTsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAgICAgdG9wOiAzMCU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTJ2dywgNzBweCkgIWltcG9ydGFudDsKICAgIH0KCiAgICAvKiBNZW51cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IDQycHg7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgIC5mZngtbG9nby1zdWIgeyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiA2cHg7IH0KICAgIC5tZW51LW9wdGlvbnMgeyB3aWR0aDogMjIwcHg7IH0KICAgIC5tZW51LWl0ZW0geyBwYWRkaW5nOiAxMHB4IDE1cHg7IH0KICAgIC5tZW51LWl0ZW0gLmxhYmVsIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzIFBhbmVsICovCiAgICAjc2V0dGluZ3MtcGFuZWwgewogICAgICAgIHdpZHRoOiA5MCU7CiAgICAgICAgbWF4LXdpZHRoOiAzMjBweDsKICAgIH0KICAgIAogICAgLyogUHJhY3RpY2UgUGFuZWwgKi8KICAgIC5wcmFjdGljZS1wYW5lbCB7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgICAgIHJpZ2h0OiA1JTsKICAgIH0KfQ==","/style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAtLS0gKi8KLyogLS0tIEhVRCBUT1AgKENSWVNUQUwgSFVEKSAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcGFkZGluZy10b3A6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IG5vbmU7IC8qIFJlbW92ZWQgZmxhdCBncmFkaWVudCAqLwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHotaW5kZXg6IDEwMDA7Cn0KCi8qIE1pc3QgTGF5ZXIgKi8KLmh1ZC1taXN0IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwcHg7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDIwMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KDUwJSAxMDAlIGF0IDUwJSAwJSwgcmdiYSgwLCAyNDIsIDI1NSwgMC4xNSkgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgZmlsdGVyOiBibHVyKDIwcHgpOwogICAgei1pbmRleDogLTE7CiAgICBhbmltYXRpb246IG1pc3RQdWxzZSA2cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBtaXN0UHVsc2UgewogICAgMCUgeyBvcGFjaXR5OiAwLjQ7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyB9CiAgICAxMDAlIHsgb3BhY2l0eTogMC43OyB0cmFuc2Zvcm06IHNjYWxlWSgxLjIpOyB9Cn0KCi8qIFRlYW0gV2luZyAoQ3J5c3RhbCBTaGFyZCkgKi8KLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTgwcHg7IGhlaWdodDogNjVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoNiwgMTIsIDI0LCAwLjkpIDAlLCByZ2JhKDIyLCA1MCwgOTEsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTJweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxMnB4KTsKICAgIAogICAgLyogQXN5bW1ldHJpYyBTaGFyZCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCA4NSUgMTAwJSwgMCUgMTAwJSk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMCAxNXB4IDAgMjVweDsKICAgIG1hcmdpbi10b3A6IDEwcHg7CiAgICAKICAgIC8qIEdsb3cgKi8KICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDhweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjQpKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWigwKTsgLyogRm9yY2UgR1BVICovCn0KCi8qIElubmVyIFNoaW5lICovCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEwNWRlZywgdHJhbnNwYXJlbnQgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMikgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICBhbmltYXRpb246IHNoaW1tZXIgNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiBUb3AgR2xvd2luZyBCb3JkZXIgKi8KLmNyeXN0YWwtYm9yZGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWN5YW4pLCB0cmFuc3BhcmVudCk7CiAgICB6LWluZGV4OiAyOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9CgovKiBBd2F5IFRlYW0gTWlycm9yICovCi50ZWFtLXdpbmcuYXdheSB7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjAwZGVnLCByZ2JhKDYsIDEyLCAyNCwgMC45KSAwJSwgcmdiYSg2MCwgMTAsIDEwLCAwLjgpIDEwMCUpOwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKDAgMCwgMTAwJSAwLCAxMDAlIDEwMCUsIDE1JSAxMDAlKTsKICAgIHBhZGRpbmc6IDAgMjVweCAwIDE1cHg7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggcmdiYSgyNTUsIDY4LCA2OCwgMC40KSk7Cn0KCi50ZWFtLXdpbmcuYXdheSAuY3J5c3RhbC1ib3JkZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgI2ZmNDQ0NCwgdHJhbnNwYXJlbnQpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQ0NDsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCi50ZWFtLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpOwogICAgbWFyZ2luLWJvdHRvbTogLTJweDsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDZweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIG1pbi13aWR0aDogNDBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiA1Owp9Ci50ZWFtLXdpbmcuYXdheSAuc2NvcmUtYm94IHsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0NDQ7IH0KCi8qIFRpbWVyIChTcGhlcmUgR3JpZCBOb2RlKSAqLwoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAKICAgIC8qIFNwaGVyZSBMb29rICovCiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsIHJnYmEoNDAsIDgwLCAxMjAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSA4MCUpOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDI1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC40KSwKICAgICAgICBpbnNldCAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjIpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwogICAgei1pbmRleDogMTA7Cn0KCi8qIEZsb2F0aW5nIFJpbmcgKi8KLnRpbWVyLWNyeXN0YWwtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC04cHg7IGxlZnQ6IC04cHg7IHJpZ2h0OiAtOHB4OyBib3R0b206IC04cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYW5pbWF0aW9uOiBzcGhlcmVTcGluIDhzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogbm9uZTsKfQoKQGtleWZyYW1lcyBzcGhlcmVTcGluIHsgCiAgICBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gCiAgICB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gCn0KCi50aW1lci1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICBtYXJnaW4tdG9wOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgKExJUVVJRCBMSUdIVCkgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44NSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjYpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjIpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDE1cHggMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOyAvKiBNYW5hZ2VkIGJ5IEpTICovCiAgICBib3gtc2hhZG93OiAwIDEwcHggMzBweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgovKiBEZWNvcmF0aXZlIGJhY2tncm91bmQgc2hhcmQgKi8KI3BsYXllci1zdGF0dXMtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDUlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMDMpIDUwJSwgdHJhbnNwYXJlbnQgNTUlKTsKICAgIGFuaW1hdGlvbjogc2hpbW1lciA2cyBpbmZpbml0ZSBsaW5lYXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmNoYXItbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNnB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KLmhwLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMzMzQ0NTU7CiAgICBtYXJnaW46IDAgOHB4OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IGluc2V0IDAgMCA1cHggcmdiYSgwLDAsMCwwLjgpOwp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwYWE0NCwgIzQ0ZmY4OCwgIzAwYWE0NCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyAzcyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZjQ0OwogICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKfQouaHAtdmFsdWUgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OyAKICAgIGNvbG9yOiAjZmZmOyAKICAgIHdpZHRoOiA1NXB4OyAKICAgIHRleHQtYWxpZ246IHJpZ2h0OyAKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi50ZWNoLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci50ZWNoLWxhYmVsIHsgCiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7IAogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgCiAgICB3aWR0aDogMjVweDsgCiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0MzMyMjsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2FhNjYwMCwgI2ZmY2MwMCwgI2FhNjYwMCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwMCUgMTAwJTsKICAgIGFuaW1hdGlvbjogbGlxdWlkRmxvdyA0cyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICNmZmFhMDA7Cn0KCkBrZXlmcmFtZXMgbGlxdWlkRmxvdyB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDEwMCUgMDsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0xMDAlIDA7IH0KfQovKiAtLS0gTUlOSU1BUCAtLS0gKi8KI21pbmltYXAtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBoZWlnaHQ6IDExMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnJhZGFyLXJpbSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWJsdWUtbWlkKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICB6LWluZGV4OiA1Owp9CgojbWluaW1hcCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwcHg7CiAgICBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogNjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5yYWRhci1sYWJlbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0xNXB4OwogICAgd2lkdGg6IDE0MCU7CiAgICBsZWZ0OiAtMjAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCi5tYXAtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiA2cHg7IGhlaWdodDogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgNHB4IGN1cnJlbnRDb2xvcjsKfQoubWFwLWRvdC5ob21lIHsgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB9Ci5tYXAtZG90LmF3YXkgeyBiYWNrZ3JvdW5kOiAjZmY0NDQ0OyBjb2xvcjogI2ZmNDQ0NDsgfQoubWFwLWRvdC5iYWxsIHsgCiAgICBiYWNrZ3JvdW5kOiAjZmYwMGNjOwogICAgY29sb3I6ICNmZjAwY2M7IAogICAgd2lkdGg6IDEycHg7IGhlaWdodDogMTJweDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICB6LWluZGV4OiAyMDsKICAgIGFuaW1hdGlvbjogYmxpbmtCYWxsIDAuM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYm94LXNoYWRvdzogMCAwIDZweCAjZmYwMGNjOwp9Ci5tYXAtZG90Lm5hcCB7IGJhY2tncm91bmQ6ICMzMzM7IGNvbG9yOiAjMDAwOyBib3JkZXI6IDFweCBzb2xpZCAjNTU1OyB9Ci5tYXAtZG90LmFjdGl2ZS1wbGF5ZXIgeyAKICAgIGJhY2tncm91bmQ6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBjb2xvcjogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGJveC1zaGFkb3c6IDAgMCA4cHggIzAwZmYwMDsKICAgIHotaW5kZXg6IDE1OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsKfQoubWFwLWRvdC5iYWxsLWNhcnJpZXIgewogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmZiwgMCAwIDMwcHggI2ZmYWEwMDsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmZmZmY7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB6LWluZGV4OiAxMDA7CiAgICB3aWR0aDogMTBweDsgaGVpZ2h0OiAxMHB4OwogICAgYW5pbWF0aW9uOiBjYXJyaWVyUHVsc2UgMC44cyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KQGtleWZyYW1lcyBjYXJyaWVyUHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmY7IG9wYWNpdHk6IDAuODsgfQogICAgdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjgpOyBib3gtc2hhZG93OiAwIDAgMjVweCAjZmZjYzAwOyBvcGFjaXR5OiAxLjA7IH0KfQpAa2V5ZnJhbWVzIGJsaW5rQmFsbCB7IGZyb20geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfSB0byB7IG9wYWNpdHk6IDAuNTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4zKTsgfSB9CgovKiAtLS0gQU5OT1VOQ0VNRU5UUyAtLS0gKi8KI2Fubm91bmNlbWVudCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDQwJTsgCiAgICBsZWZ0OiA1JTsgCiAgICB3aWR0aDogOTAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IGNsYW1wKDQwcHgsIDEydncsIDcycHgpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDQwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpKSBkcm9wLXNoYWRvdygzcHggM3B4IDAgIzAwMCk7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGFuaW1hdGlvbjogYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIChFVEhFUkVBTCBJTlRFUkZBQ0UpIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgUmluZyAqLwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEwcyBsaW5lYXIgaW5maW5pdGU7Cn0KCiNqb3lzdGljay1iYXNlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTAlOyBsZWZ0OiAxMCU7IHdpZHRoOiA4MCU7IGhlaWdodDogODAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDVzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIGV0aGVyZWFsU3BpbiB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBQeXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmZmZmYgMCUsICNhMmY5ZmYgNDAlLCAjMDBmMmZmIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZjJmZiwgMCAwIDMwcHggIzAwZjJmZjsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgb3BhY2l0eTogMC44Owp9Cgojam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIiI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB1bHNlLWdsb3cgMnMgaW5maW5pdGU7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC41KTsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7CiAgICBhbmltYXRpb246IHJpcHBsZUFuaW0gMC42cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgcmlwcGxlQW5pbSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOyBvcGFjaXR5OiAxOyBib3JkZXItd2lkdGg6IDVweDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IGJvcmRlci13aWR0aDogMHB4OyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAoU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7IAogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKei1pbmRleDogMTUwMDsKfQouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAyMjBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvdHRvbTogMjBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuOCkgMCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICB6LWluZGV4OiAtMTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY29tbWFuZC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDIwcyBsaW5lYXIgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSk7Cn0KLmNvbW1hbmQtcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMTBweDsgbGVmdDogLTEwcHg7IHJpZ2h0OiAtMTBweDsgYm90dG9tOiAtMTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IGRvdHRlZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMik7CiAgICBhbmltYXRpb246IHNwaW5SZXZlcnNlIDEwcyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKQGtleWZyYW1lcyBzcGluUmV2ZXJzZSB7IGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMzYwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgwZGVnKTsgfSB9CgojYWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgcGFkZGluZzogNHB4IDE2cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgei1pbmRleDogMjA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChIRVJDVUxFQU4gU1BIRVJFIEdSSUQgTk9ERSkgLS0tICovCiNhY3Rpb24tYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxNDBweDsgaGVpZ2h0OiAxNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKICAgIC8qIERlZXAgU2hhZG93ICYgM0QgQ29udGV4dCAqLwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAzMHB4IDYwcHggcmdiYSgwLCAwLCAwLCAwLjkpLAogICAgICAgIDAgMCAwIDJweCByZ2JhKDAsIDAsIDAsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiBub25lOwogICAgYm9yZGVyOiBub25lOwogICAgcGVyc3BlY3RpdmU6IDEwMDBweDsKICAgIHRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOwp9CgovKiBLZXlmcmFtZXMgZm9yIExpdmluZyBVSSAqLwpAa2V5ZnJhbWVzIHJpbmctZ3lyby16IHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVaKDM2MGRlZyk7IH0KfQoKQGtleWZyYW1lcyByaW5nLXdvYmJsZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoMTBkZWcpIHJvdGF0ZVkoNWRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDEwZGVnKTsgfQogICAgNzUlIHsgdHJhbnNmb3JtOiByb3RhdGVYKC0xMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlWCgwZGVnKSByb3RhdGVZKDBkZWcpOyB9Cn0KCkBrZXlmcmFtZXMgcnVuZS1zcGluLWdsb3cgewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKSBzY2FsZSgxLjA1KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgOHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpKTsgb3BhY2l0eTogMS4wOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMnB4IHZhcigtLWZmeC1jeWFuKSk7IG9wYWNpdHk6IDAuODsgfQp9CgpAa2V5ZnJhbWVzIGxpcXVpZC1zdXJnZS1jb21wbGV4IHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjAyKTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDQ5JTsgYm94LXNoYWRvdzogMCAwIDUwcHggIzAwZmZmZiwgaW5zZXQgMCAwIDQwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk4KTsgYmFja2dyb3VuZC1wb3NpdGlvbjogMCUgNTAlOyBib3JkZXItcmFkaXVzOiA1MCU7IGJveC1zaGFkb3c6IDAgMCAzMHB4ICMwMGFhZmYsIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsgfQp9CgpAa2V5ZnJhbWVzIGNyeXN0YWwtYnJlYXRoZSB7CiAgICAwJSwgMTAwJSB7IGJvcmRlci1jb2xvcjogcmdiYSgwLCAyMDAsIDI1NSwgMC4zKTsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDIwcHggIzAwMDAwMDsgfQogICAgNTAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMzBweCAjMDAxMTMzLCAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOyB9Cn0KCi8qIExheWVyIDE6IE91dGVyIE9ybmF0ZSBSaW5nIChNZXRhbC9Hb2xkKSAtIFRoZSBHeXJvICovCi5hYi1vdXRlci1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLThweDsgbGVmdDogLThweDsgcmlnaHQ6IC04cHg7IGJvdHRvbTogLThweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjYjg4NjBiLCAjZmZkNzAwLCAjZmZmYWNkLCAjZmZkNzAwLCAjYjg4NjBiLCAjOGI0NTAwLCAjYjg4NjBiCiAgICApOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgaW5zZXQgMCAwIDEwcHggcmdiYSgwLDAsMCwwLjgpLAogICAgICAgIDAgMCAyNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuMyk7CiAgICB6LWluZGV4OiAxOwogICAgYm9yZGVyOiAxcHggc29saWQgIzU1MzMwMDsKICAgIC8qIENvbXBsZXggcm90YXRpb24gKi8KICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMjBzIGxpbmVhciBpbmZpbml0ZTsKfQoKLyogUHNldWRvLWVsZW1lbnQgZm9yIDNEIGRlcHRoL3dvYmJsZSBlZmZlY3Qgb24gdGhlIHJpbmcgKi8KLmFiLW91dGVyLXJpbmc6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjUpOwogICAgYW5pbWF0aW9uOiByaW5nLXdvYmJsZSA4cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAyOiBSdW5lIFJpbmcgKFNwaW5uaW5nKSAqLwouYWItcnVuZS1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTJweDsgbGVmdDogLTJweDsgcmlnaHQ6IC0ycHg7IGJvdHRvbTogLTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IGRhc2hlZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgLyogYm94LXNoYWRvdyBoYW5kbGVkIGJ5IGFuaW1hdGlvbiAqLwogICAgei1pbmRleDogMjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgovKiBMYXllciAzOiBJbm5lciBDcnlzdGFsIEhvdXNpbmcgKERhcmsgR2xhc3MpICovCi5hYi1pbm5lci1jcnlzdGFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNnB4OyBsZWZ0OiA2cHg7IHJpZ2h0OiA2cHg7IGJvdHRvbTogNnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMSkgMCUsIHJnYmEoMCwgMTAsIDMwLCAwLjk1KSA2MCUsICMwMDAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogMzsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGFuaW1hdGlvbjogY3J5c3RhbC1icmVhdGhlIDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgovKiBMYXllciA0OiBMaXF1aWQgQ29yZSAoQW5pbWF0ZWQgU3VyZmFjZSkgKi8KLmFiLWxpcXVpZC1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTJweDsgbGVmdDogMTJweDsgcmlnaHQ6IDEycHg7IGJvdHRvbTogMTJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIENvbXBsZXggR3JhZGllbnQgZm9yIGxpcXVpZCBtb3Rpb24gKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNDAlIDQwJSwgIzAwZmZmZiAwJSwgIzAwODhmZiA0MCUsICMwMDIyNjYgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDE1MCUgMTUwJTsKICAgIHotaW5kZXg6IDQ7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExpcXVpZCBtb3ZlbWVudCBlZmZlY3QgKEludGVybmFsIHJlZmxlY3Rpb24pICovCi5hYi1saXF1aWQtY29yZTo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC41KSAwJSwgdHJhbnNwYXJlbnQgMjUlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkTW92ZSA1cyBpbmZpbml0ZSBlYXNlLWluLW91dDsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5Owp9CgovKiBMYXllciA1OiBMaW1pdCBCcmVhayBSaW5nIChIaWRkZW4gYnkgZGVmYXVsdCkgKi8KLmxpbWl0LXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjJweDsgbGVmdDogLTIycHg7IHJpZ2h0OiAtMjJweDsgYm90dG9tOiAtMjJweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogNHB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmNDQwMDsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmFhMDA7CiAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsKICAgIHotaW5kZXg6IDA7CiAgICBvcGFjaXR5OiAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMS41cyBsaW5lYXIgaW5maW5pdGU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBsaW1pdFNwaW4gewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKSBzY2FsZSgxKTsgZmlsdGVyOiBodWUtcm90YXRlKDBkZWcpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgxNWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogTGF5ZXIgNjogVGV4dCBMYWJlbCAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXNoYWRvdzogCiAgICAgICAgMCAycHggMCAjMDAwLAogICAgICAgIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDEuMCksCiAgICAgICAgMCAwIDMwcHggIzAwODhmZjsKICAgIHotaW5kZXg6IDY7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHRvcDogMXB4OwogICAgYW5pbWF0aW9uOiB0ZXh0RmxvYXQgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgdGV4dEZsb2F0IHsKICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7IH0KfQoKLyogTGF5ZXIgNzogR2xhcmUgKi8KI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDI1NSwyNTUsMjU1LDAuNikgMCUsIHRyYW5zcGFyZW50IDQ1JSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICB6LWluZGV4OiA3OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogc29mdC1saWdodDsKfQoKLyogU1RBVEU6IFNIT09UIE1PREUgKE9yYW5nZS9SZWQpICovCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICM4YjAwMDAsICNmZjQ0MDAsICNmZmFhMDAsICNmZjQ0MDAsICM4YjAwMDAsICM0NDAwMDAsICM4YjAwMDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgNTBweCByZ2JhKDI1NSwgNjgsIDAsIDAuOSk7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDVzIGxpbmVhciBpbmZpbml0ZTsgLyogRmFzdGVyIHNwaW4gKi8KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjZmZmZjAwIDAlLCAjZmY0NDAwIDUwJSwgIzY2MDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogY29yZVB1bHNlUmVkIDAuNHMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgpAa2V5ZnJhbWVzIGNvcmVQdWxzZVJlZCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC45NSk7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDA7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wOCk7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIDAgMCAyMHB4ICNmZmY7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjMpOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgLmJ0bi10ZXh0IHsKICAgIHRleHQtc2hhZG93OiAwIDJweCAwICMwMDAsIDAgMCAyMHB4ICNmZjQ0MDA7Cn0KCi8qIFNUQVRFOiBMSU1JVCBSRUFEWSAoSGVyY3VsZWFuIEdvbGQpICovCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIG9wYWNpdHk6IDE7CiAgICBib3JkZXItd2lkdGg6IDZweDsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZmY7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiAjZmZkNzAwOwogICAgYm94LXNoYWRvdzogMCAwIDYwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDIwcHggI2ZmNDQwMDsKICAgIGFuaW1hdGlvbjogbGltaXRTcGluIDAuOHMgbGluZWFyIGluZmluaXRlLCBsaW1pdFB1bHNlIDAuM3MgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCAjZmZmZmZmKTsKfQoKQGtleWZyYW1lcyBsaW1pdFB1bHNlIHsKICAgIGZyb20geyBvcGFjaXR5OiAwLjg7IGJveC1zaGFkb3c6IDAgMCA0MHB4ICNmZjQ0MDAsIGluc2V0IDAgMCAyMHB4ICNmZmFhMDA7IH0KICAgIHRvIHsgb3BhY2l0eTogMS4wOyBib3gtc2hhZG93OiAwIDAgODBweCAjZmZhYTAwLCBpbnNldCAwIDAgNDBweCAjZmZmZjAwOyB9Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1vdXRlci1yaW5nIHsKICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KAogICAgICAgIGZyb20gMGRlZywKICAgICAgICAjZmZkNzAwLCAjZmZmZmZmLCAjZmZhYTAwLCAjZmZmZmZmLCAjZmZkNzAwLCAjYjg4NjBiLCAjZmZkNzAwCiAgICApOwogICAgYm94LXNoYWRvdzogMCAwIDgwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC44KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogMnMgbGluZWFyIGluZmluaXRlOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLXJ1bmUtcmluZyB7CiAgICBib3JkZXItY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCA0MHB4ICMwMGZmZmY7CiAgICBhbmltYXRpb246IHJ1bmUtc3Bpbi1nbG93IDNzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDIwJSwgI2ZmODgwMCA2MCUsICNmZjAwMDAgMTAwJSk7CiAgICBhbmltYXRpb246IGxpcXVpZC1zdXJnZS1jb21wbGV4IDAuNXMgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmJ0bi10ZXh0IHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwMDAsIDAgMCAyMHB4ICNmZmZmMDAsIDAgMCA0MHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAwLjJzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLyogU1RBVEU6IEFDVElWRSAoQ2hhcmdpbmcvUHJlc3NlZCkgKi8KI2FjdGlvbi1idXR0b24uYWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItbGlxdWlkLWNvcmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA1MCUgNTAlLCAjZmZmZmZmIDQwJSwgI2ZmZmZhYSA3MCUsICNmZmFhMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCAjZmZmZmZmLCBpbnNldCAwIDAgNTBweCAjZmZmZmZmOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDIuMCkgY29udHJhc3QoMS4yKTsKICAgIGFuaW1hdGlvbjogbm9uZTsgLyogU29saWQgaW50ZW5zZSBsaWdodCAqLwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmFiLW91dGVyLXJpbmcgewogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAwLjJzIGxpbmVhciBpbmZpbml0ZTsgLyogSHlwZXIgc3BpbiAqLwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTAwcHggI2ZmZmZmZjsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC4xcyBsaW5lYXIgaW5maW5pdGU7CiAgICBvcGFjaXR5OiAxOwp9Ci8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CiNhdXRvLXRvZ2dsZS5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgxMDAsIDIwLCAwLCAwLjgpIDAlLCByZ2JhKDQwLCAwLCAwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDAwOwogICAgY29sb3I6ICNmZmFhMDA7CiAgICBhbmltYXRpb246IHB1bHNlUmVkIDJzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgcHVsc2VSZWQgeyAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSA1MCUgeyBib3gtc2hhZG93OiAwIDAgMjBweCAjZmY0NDAwOyB9IDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gfQoKLyogLS0tIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LXdyYXBwZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKICAgIGNvbnRhaW46IGxheW91dCBzdHlsZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMjRweDsgCiAgICB0ZXh0LXNoYWRvdzogMXB4IDFweCAwICMwMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmRhbWFnZSB7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZjYzAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuOHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oZWFsIHsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjNDRmZjQ0OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmMDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnZlbm9tIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNhYWZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzQ0ODgwMCwgMnB4IDJweCAwICMwMDIyMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjY2NmZjY2IDAlLCAjNjZjYzAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggcmdiYSgxMDAsIDI1NSwgMCwgMC41KSk7CiAgICBhbmltYXRpb246IGRyaXBTdGF0dXMgMnMgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsZWVwIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMDQ0ZmYsIDAgMCAzMHB4ICMwMDAwZmY7CiAgICBvcGFjaXR5OiAwLjk7CiAgICBhbmltYXRpb246IGRyaWZ0U3RhdHVzIDNzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci53aXRoZXIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM4cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzQ0NDQ0NDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNlZWVlZWUgMCUsICM4ODg4ODggMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnRlY2ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC43KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgIzAwZmZmZjsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMDg4ZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjZmZmOwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC42cyBlYXNlLWluLW91dCwgZmxhc2hUZWNoIDAuM3M7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNhdmUsIC5mbG9hdGluZy10ZXh0LWlubmVyLmJsb2NrIHsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDA0NDg4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMDg4ZmY7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHBvcERhbWFnZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOyBvcGFjaXR5OiAxOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBmbG9hdFVwIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MHB4KTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGRyaXBTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEuMSkgdHJhbnNsYXRlWSg1cHgpOyBmaWx0ZXI6IGJsdXIoMXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGRyaWZ0U3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDE1cHgpIHRyYW5zbGF0ZVkoLTIwcHgpIHJvdGF0ZSgxMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTE1cHgpIHRyYW5zbGF0ZVkoLTUwcHgpIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgd2l0aGVyU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBncmF5c2NhbGUoMCUpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjYpOyBmaWx0ZXI6IGdyYXlzY2FsZSgxMDAlKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHNoYWtlVGVjaCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC44KTsgfQogICAgMTAlLCAzMCUsIDUwJSwgNzAlLCA5MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKC0ycHgsIDJweCk7IH0KICAgIDIwJSwgNDAlLCA2MCUsIDgwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoMnB4LCAtMnB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQp9CgpAa2V5ZnJhbWVzIGZsYXNoVGVjaCB7CiAgICAwJSB7IGJhY2tncm91bmQtY29sb3I6ICNmZmY7IGNvbG9yOiAjMDAwOyBib3JkZXItY29sb3I6ICNmZmY7IH0KICAgIDEwMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDEwLCAzMCwgMC44NSk7IGNvbG9yOiAjMDBmZmZmOyBib3JkZXItY29sb3I6ICMwMGZmZmY7IH0KfQoKI2xvYWRpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgYW5pbWF0aW9uOiBibGluayAxcyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIGJsaW5rIHsgNTAlIHsgb3BhY2l0eTogMC41OyB9IH0KCiNjb250cm9scy1oaW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTMwcHg7IHdpZHRoOiAxMDAlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC40KTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtaW1wYWN0IHsKICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiAjZmZmZjAwOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDNweCAzcHggMCAjZmYwMDAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNQb3AgMC40cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1hY3Rpb24gewogICAgZm9udC1mYW1pbHk6ICdBcmlhbCBCbGFjaycsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogIzAwZmZmZjsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwNDRhYTsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljU2xpZGUgMC40cyBlYXNlLW91dCBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCkBrZXlmcmFtZXMgY29taWNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMjBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICA2MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBjb21pY1NsaWRlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTIwcHgsIDIwcHgpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMjBweCkgc2NhbGUoMS4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gTUFJTiBNRU5VIC0tLSAqLwovKiAtLS0gTUFJTiBNRU5VICYgRU5EIEdBTUUgKEZGWCBTVFlMRSkgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgKEZBWVRIIElOVEVSRkFDRSkgLS0tICovCiNtYWluLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQXN5bW1ldHJpYyBSaWdodCBBbGlnbiAqLwogICAgcGFkZGluZy1yaWdodDogMTAlOwogICAgei1pbmRleDogMzAwMDsKICAgIG9wYWNpdHk6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC44cyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKTsKICAgIAogICAgLyogRGVlcCBWb2lkIEJhY2tncm91bmQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDUwJSwgIzA1MTAyMCAwJSwgIzAwMDAwMCAxMDAlKTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNtYWluLW1lbnUuYWN0aXZlIHsKICAgIG9wYWNpdHk6IDE7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKLyogU2NhbmxpbmVzICYgVmlnbmV0dGUgKi8KLm1lbnUtYmctb3ZlcmxheSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoCiAgICAgICAgICAgIDBkZWcsCiAgICAgICAgICAgIHRyYW5zcGFyZW50IDBweCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMnB4LAogICAgICAgICAgICByZ2JhKDAsIDI1NSwgMjU1LCAwLjAyKSAzcHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDRweAogICAgICAgICk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoubWVudS1iZy1vdmVybGF5OjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMCwwLDAsMC44KSAxMDAlKTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IHJpZ2h0OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgouZmZ4LWxvZ28tbWFpbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDYwcHgsIDEydncsIDEwMHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxMHB4OwogICAgbGluZS1oZWlnaHQ6IDAuOTsKICAgIAogICAgLyogQ3J5c3RhbCBHcmFkaWVudCAqLwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0NSUsICMwMDg4ZmYgNTUlLCAjMDAyMjY2IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7CiAgICBhbmltYXRpb246IGxvZ29GbG9hdCA0cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBsb2dvRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC42KSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMTBweCk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgwLCAyMDAsIDI1NSwgMC44KSk7IH0KfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDR2dywgMzJweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMDsKICAgIG9wYWNpdHk6IDAuOTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9CgovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKLyogTUVOVSBPUFRJT05TIChBc3ltbWV0cmljIExpc3QpICovCiAgICB3aWR0aDogNDAwcHg7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7IC8qIEFsaWduIGl0ZW1zIHRvIHJpZ2h0ICovCn0KCi5tZW51LWl0ZW0gewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4IDQwcHggMTVweCAyMHB4OwogICAgCiAgICAvKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDQwLCA4MCwgMC44KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMCkgMTAwJSk7CiAgICBib3JkZXItcmlnaHQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICAKICAgIGN1cnNvcjogcG9pbnRlcjsKLyogR2xhc3MgU2hhcmQgTG9vayAqLwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgCiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKfQoKLm1lbnUtaXRlbTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMjcwZGVnLCByZ2JhKDAsIDEwMCwgMjAwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogIzAwZmZmZjsKICAgIHBhZGRpbmctcmlnaHQ6IDYwcHg7IC8qIFNsaWRlIGxlZnQgZWZmZWN0ICovCiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2FhYWFhYTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7IC8qIENvdW50ZXIgc2tldyB0ZXh0ICovCiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzLCB0ZXh0LXNoYWRvdyAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmLCAwIDAgMjBweCAjMDA4OGZmOwp9CgovKiBQWVJFRkxZIENVUlNPUiAqLwoubWVudS1pdGVtIC5jdXJzb3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgcmlnaHQ6IDE1cHg7CiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogI2ZmZDcwMDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgwKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDEwcHggI2ZmZDcwMCwKICAgICAgICAwIDAgMjBweCAjZmZhYTAwLAogICAgICAgIDAgMCA0MHB4ICNmZjQ0MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICByaWdodDogMzBweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpOwogICAgYW5pbWF0aW9uOiBweXJlZmx5V2lnZ2xlIDFzIGluZmluaXRlIGVhc2UtaW4tb3V0Owp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlXaWdnbGUgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKSBzY2FsZSgxKSB0cmFuc2xhdGUoMCwgMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEuMikgdHJhbnNsYXRlKC0ycHgsIC0ycHgpOyB9Cn0KCi8qIFBhcnRpY2xlIHRyYWlsIGZvciBjdXJzb3IgKFBzZXVkbyBlbGVtZW50KSAqLwoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3I6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGluaGVyaXQ7CiAgICBvcGFjaXR5OiAwLjU7CiAgICBhbmltYXRpb246IHB5cmVmbHlUcmFpbCAxcyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyBweXJlZmx5VHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDIuNSk7IG9wYWNpdHk6IDA7IH0KfQoKLm1lbnUtZm9vdGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogMzBweDsKICAgIHJpZ2h0OiA0MHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KLyogRU5EIEdBTUUgU1BFQ0lGSUMgKi8KI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzNTAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjVzOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxNSwgMC45KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9CgojZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCi8qIC0tLSBQUkFDVElDRSBPVkVSTEFZIChTUEhFUkUgUE9PTCBURVJNSU5BTCkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNCk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMzAwcHg7CiAgICAKICAgIC8qIEhvbG9ncmFwaGljIEdsYXNzICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA0MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE1cHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAKICAgIC8qIFRlY2ggU2hhcGUgKi8KICAgIGNsaXAtcGF0aDogcG9seWdvbigKICAgICAgICAyMHB4IDAsIDEwMCUgMCwgCiAgICAgICAgMTAwJSBjYWxjKDEwMCUgLSAyMHB4KSwgY2FsYygxMDAlIC0gMjBweCkgMTAwJSwgCiAgICAgICAgMCAxMDAlLCAwIDIwcHgKICAgICk7CiAgICAKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIAogICAgYm94LXNoYWRvdzogCiAgICAgICAgMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwKICAgICAgICBpbnNldCAwIDAgNTBweCByZ2JhKDAsIDIwLCA2MCwgMC41KTsKICAgICAgICAKICAgIHBhZGRpbmc6IDIwcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIAogICAgLyogR3JpZCBQYXR0ZXJuIE92ZXJsYXkgKi8KICAgIGJhY2tncm91bmQtaW1hZ2U6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCksCiAgICAgICAgbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjAzKSAxcHgsIHRyYW5zcGFyZW50IDFweCk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDIwcHggMjBweDsKICAgIAogICAgYW5pbWF0aW9uOiBwYW5lbEZsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHBhbmVsRmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNXB4KTsgfQp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7CiAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKfQoKLnBhbmVsLXRpdGxlLWdyb3VwIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9CgoucGFuZWwtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5wYW5lbC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG9wYWNpdHk6IDAuODsKfQoKLnBhbmVsLWNvbnRlbnQgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDIwcHg7Cn0KCi5zZWN0aW9uLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHJnYmEoMjU1LCAyMDAsIDAsIDAuNSk7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7CiAgICBnYXA6IDhweDsKfQoKLmRyaWxsLWJ0biB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgcGFkZGluZzogMTBweCA1cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDIwLCA0MCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouZHJpbGwtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjgpOwogICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5kcmlsbC1idG4uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOCkgMCUsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIGljb25zIGZvciBjbGVhbmVyIGdyaWQgKi8KfQoKLm9wdGlvbi1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA4cHg7Cn0KCi5vcHRpb24tdG9nZ2xlIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogI2FhYTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpOwogICAgY29sb3I6ICNmZmY7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBib3JkZXItY29sb3I6ICMwMGZmMDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDAsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHJnYmEoMCwgMjU1LCAwLCAwLjIpOwp9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6IGluaGVyaXQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoNTAsIDAsIDAsIDAuNiksIHJnYmEoMjAsIDAsIDAsIDAuOCkpOwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIHBhZGRpbmc6IDhweDsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjZmZhYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCA2OCwgMC41KTsKfQoKI3AtcmVzZXQtYmFsbCB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNTAsIDEwMCwgMC42KSwgcmdiYSgwLCAyMCwgNDAsIDAuOCkpOwogICAgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMGZmZmY7Cn0KI3AtcmVzZXQtYmFsbDpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjMDBmZmZmOwogICAgY29sb3I6ICMwMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDIwcHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTAwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgCiAgICBoZWlnaHQ6IDA7IAogICAgYm9yZGVyLWxlZnQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDEwcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAxNXB4IHNvbGlkICMwMGZmZmY7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBjb2xvcjogIzg4YWFjYzsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKfQoKI2RyaWxsLXNjb3JlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjYpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICB3aWR0aDogMjRweDsgaGVpZ2h0OiAyNHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAyMnB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuKTsKfQoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMTBweDsgcmlnaHQ6IDEwcHg7CiAgICB3aWR0aDogMjBweDsgaGVpZ2h0OiAyMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGxpbmUtaGVpZ2h0OiAxOHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KLnBhbmVsLW1pbmltaXplLWJ0bjpob3ZlciB7IAogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIGNvbG9yOiAjMDAwOyAKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgojcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBwYWRkaW5nOiA4cHggMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgei1pbmRleDogMjQwMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CiNwcmFjdGljZS1yZXN0b3JlLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyk7Cn0KCi8qIC0tLSBBSU0gSk9ZU1RJQ0sgLS0tICovCiNhaW0tam95c3RpY2stem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgIHJpZ2h0OiAwOwogICAgd2lkdGg6IDQwJTsKICAgIGhlaWdodDogMzUlOwogICAgei1pbmRleDogMTAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMCk7CiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2FpbS1qb3lzdGljay12aXN1YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2FpbS1qb3lzdGljay1iYXNlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIEV0aGVyZWFsIE9yYW5nZSBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgyNTUsIDE1MCwgNTAsIDAuNCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjIpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgNTAsIDAsIDAuMSk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsMCwwLDApIDYwJSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4wNSkgMTAwJSk7CiAgICBhbmltYXRpb246IGV0aGVyZWFsU3BpbiAxMnMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhaW0tam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMzBweDsgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRmlyZWZseSBMaWdodCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZmZmIDAlLCAjZmZhYTAwIDQwJSwgI2ZmNDQwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZjY2MDA7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwogICAgb3BhY2l0eTogMC44Owp9Ci8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwp9CiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5ibGluZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMzMzMzMzOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMDAwMDAsIDJweCAycHggMCAjMTExOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgIzY2NiAwJSwgIzAwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMnMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNpbGVuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNXMgZWFzZS1pbi1vdXQ7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNoaWVsZCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICMwMGZmZmY7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogNXB4IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUwLCAxMDAsIDAuNSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjVzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5oYXN0ZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjZmY4ODAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNsb3cgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICM4ODU1MjI7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAoOToxNiBGaXJzdCkgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpLCBzY3JlZW4gYW5kIChtYXgtYXNwZWN0LXJhdGlvOiAxLzEpIHsKICAgIC8qIEhVRCBUb3A6IENvbXBhY3QgTGF5b3V0ICovCiAgICAjaHVkLXRvcCB7CiAgICAgICAgcGFkZGluZzogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSkgNXB4IDAgNXB4OwogICAgICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgfQoKICAgIC50ZWFtLXdpbmcgeyAKICAgICAgICB3aWR0aDogMzIlOyAKICAgICAgICBoZWlnaHQ6IDQ1cHg7CiAgICAgICAgcGFkZGluZzogMCA1cHg7IAogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSA4NSUsIDAlIDEwMCUpOwogICAgfQogICAgLnRlYW0td2luZy5hd2F5IHsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgMTAwJSwgMCUgODUlKTsKICAgIH0KCiAgICAuc2NvcmUtYm94IHsgCiAgICAgICAgZm9udC1zaXplOiAyOHB4OyAKICAgICAgICBtaW4td2lkdGg6IDIwcHg7IAogICAgfQogICAgCiAgICAudGVhbS1uYW1lIHsgCiAgICAgICAgZm9udC1zaXplOiAxMHB4OyAKICAgICAgICBsZXR0ZXItc3BhY2luZzogMHB4OyAKICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC8qIFRpbWVyIENvbXBhY3QgKi8KICAgIC50aW1lci1jb21wbGV4IHsgCiAgICAgICAgd2lkdGg6IDU1cHg7IGhlaWdodDogNTVweDsgCiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyAKICAgICAgICB3aWR0aDogNDhweDsgaGVpZ2h0OiA0OHB4OyAKICAgICAgICB0b3A6IC0zcHg7IGxlZnQ6IC0zcHg7IHJpZ2h0OiAtM3B4OyBib3R0b206IC0zcHg7IAogICAgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDE4cHg7IG1hcmdpbi10b3A6IDA7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogOHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAKICAgIC8qIE1pbmlNYXA6IFRvcCBSaWdodCwgYmVsb3cgSFVEICovCiAgICAjbWluaW1hcC1jb250YWluZXIgeyAKICAgICAgICB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgIH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAvKiBHb2FsIERpc3RhbmNlOiBUb3AgTGVmdCwgYmVsb3cgSFVEICovCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyAKICAgICAgICBsZWZ0OiAxMHB4OyAKICAgICAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgCiAgICAgICAgcGFkZGluZzogMnB4IDhweDsKICAgIH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuZGlzdGFuY2UtbGFiZWwgeyBmb250LXNpemU6IDhweDsgfQoKICAgIC8qIFBsYXllciBTdGF0dXM6IE1vdmUgdG8gVG9wIExlZnQgKGJlbG93IEdvYWwgRGlzdGFuY2UpIHRvIGZyZWUgdXAgYm90dG9tLWxlZnQgZm9yIGpveXN0aWNrICovCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IAogICAgICAgIHRvcDogbWF4KDEwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA5MHB4KTsKICAgICAgICBsZWZ0OiAxMHB4OwogICAgICAgIGJvdHRvbTogYXV0bzsKICAgICAgICB3aWR0aDogMTQwcHg7IAogICAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgICB0cmFuc2Zvcm06IHNrZXdYKC01ZGVnKTsKICAgIH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDEycHg7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWdhdWdlLWNvbnRhaW5lciB7IG1hcmdpbi1ib3R0b206IDJweDsgfQogICAgLmhwLWxhYmVsLCAudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogOHB4OyB3aWR0aDogMTVweDsgfQogICAgLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyB3aWR0aDogNDBweDsgfQoKICAgIC8qIFRlY2ggRmxhc2g6IEZ1bGwgd2lkdGgsIHNtYWxsZXIgdGV4dCAqLwogICAgI3RlY2gtZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgaGVpZ2h0OiAxMDBweDsKICAgICAgICB0b3A6IDI1JTsKICAgIH0KICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDMycHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC50ZWNoLXRpbWVyLXRyYWNrIHsgd2lkdGg6IDE4MHB4OyB9CiAgICAKICAgIC8qIEFjdGlvbiBCdXR0b246IEJvdHRvbSBSaWdodCAqLwovKiBBY3Rpb24gQnV0dG9uOiBCb3R0b20gUmlnaHQgLSBVUFNDQUxFRCBGT1IgOToxNiAqLwogICAgI2FjdGlvbi1jb250YWluZXIgewogICAgICAgIGJvdHRvbTogbWF4KDUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICAgICAgcmlnaHQ6IG1heCgzMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CiAgICAjYWN0aW9uLWJ1dHRvbiB7IHdpZHRoOiAxMzBweDsgaGVpZ2h0OiAxMzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMnB4OyBwYWRkaW5nOiA0cHggMTJweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAvKiBUYWNrbGUgQnV0dG9uOiBMZWZ0IG9mIEFjdGlvbiBCdXR0b24gKEVyZ29ub21pYyBhcmMpICovCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsKICAgICAgICBib3R0b206IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMTgwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsgLyogU2hpZnRlZCBsZWZ0IHRvIGNsZWFyIGxhcmdlciBhY3Rpb24gYnRuICovCiAgICB9CiAgICAjdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgeyBmb250LXNpemU6IDEycHg7IH0KICAgIAogICAgLyogQ29udHJvbHMgLyBTZXR0aW5ncyBCdXR0b25zOiBUb3AgUmlnaHQgY29sdW1uICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHdpZHRoOiA4MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHRvcDogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxNDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxOTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTgwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHBhZGRpbmc6IDZweCAwOwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogODBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICB0b3A6IG1heCgxNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgfQogICAgCiAgICAvKiBKb3lzdGljayBab25lcyAqLwogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsgLyogTG93ZXIgaGFsZiBvbmx5ICovCiAgICAgICAgd2lkdGg6IDUwJTsKICAgICAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB9CiAgICAjYWltLWpveXN0aWNrLXpvbmUgewogICAgICAgIGhlaWdodDogNDAlOwogICAgICAgIHdpZHRoOiA1MCU7CiAgICAgICAgYm90dG9tOiAwOwogICAgICAgIHJpZ2h0OiAwOwogICAgfQoKICAgIC8qIEFubm91bmNlbWVudHM6IEVuc3VyZSB0aGV5IHdyYXAgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzZweCwgMTB2dywgNTBweCk7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICBsZWZ0OiA1JTsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAgICAgdG9wOiAzMCU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTJ2dywgNzBweCkgIWltcG9ydGFudDsKICAgIH0KCiAgICAvKiBNZW51cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IDQycHg7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgIC5mZngtbG9nby1zdWIgeyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiA2cHg7IH0KICAgIC5tZW51LW9wdGlvbnMgeyB3aWR0aDogMjIwcHg7IH0KICAgIC5tZW51LWl0ZW0geyBwYWRkaW5nOiAxMHB4IDE1cHg7IH0KICAgIC5tZW51LWl0ZW0gLmxhYmVsIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzIFBhbmVsICovCiAgICAjc2V0dGluZ3MtcGFuZWwgewogICAgICAgIHdpZHRoOiA5MCU7CiAgICAgICAgbWF4LXdpZHRoOiAzMjBweDsKICAgIH0KICAgIAogICAgLyogUHJhY3RpY2UgUGFuZWwgKi8KICAgIC5wcmFjdGljZS1wYW5lbCB7CiAgICAgICAgd2lkdGg6IDkwJTsKICAgICAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgICAgIHJpZ2h0OiA1JTsKICAgIH0KfQ==","AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","./AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","/AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQogICAgICAgICAgICB0aGlzLmJvbmVzID0gewogICAgICAgICAgICAgICAgaGlwczogbnVsbCwKICAgICAgICAgICAgICAgIHNwaW5lOiBudWxsLAogICAgICAgICAgICAgICAgY2hlc3Q6IG51bGwsCiAgICAgICAgICAgICAgICBuZWNrOiBudWxsLAogICAgICAgICAgICAgICAgaGVhZDogbnVsbCwKICAgICAgICAgICAgICAgIHJVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIHJGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckhhbmQ6IG51bGwsCiAgICAgICAgICAgICAgICBsVXBwZXJBcm06IG51bGwsCiAgICAgICAgICAgICAgICBsRm9yZUFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxIYW5kOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCnRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9LAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKICAgICAgICAgICAgdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CnZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwLAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwgVGltZXIKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnNsb3cgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zbG93LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5oYXN0ZSA9IDA7IC8vIE92ZXJ3cml0ZSBoYXN0ZQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xPVyIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwoKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gNS4wICsgKHNwIC8gMTUuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgIH0KCiAgICAgICAgc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwppZiAoa2V5ID09PSAnc3dpbScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC44NSwgMS43MCwgc3BlZWROb3JtKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleSA9PT0gJ2Rhc2gnKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEuMTAsIDIuMjAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdpZGxlJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgwLjk1LCAxLjA1LCBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgICAgIC8vIEhhc3RlL1Nsb3cgQW5pbWF0aW9uIFNjYWxpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGEudGltZVNjYWxlICo9IDEuNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgYS50aW1lU2NhbGUgKj0gMC42Owp9OwoKYXBwbHlSYXRlKHRhcmdldCk7CgogICAgICAgICAgICBpZiAodGhpcy5fbGFzdExvY29tb3Rpb24gIT09IHRhcmdldCkgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIWEpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIC8vIFVzZSB0aGUgbmV3IHBsYXkgbWV0aG9kIHdoaWNoIGhhbmRsZXMgbGF5ZXJpbmcKICAgICAgICAgICAgdGhpcy5wbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmxlcnAodG9NYXRlLCBhc3Npc3RGYWN0b3IpOwpmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgovLyBCbGluZCBSYW5kb21pemF0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC44OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1BWCBQT1dFUiBCT05VUzogSWYgaGVsZCBuZWFyIG1heCwgc2lnbmlmaWNhbnQgYm9vc3QKICAgICAgICAgICAgaWYgKHJhdGlvID4gKFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPIDogMC45NSkpIHsKICAgICAgICAgICAgICAgIG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSIDogMi41KTsgLy8gQ3JpdGljYWwgUG93ZXIKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTUFYIFBPV0VSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgLy8gQWltIFZlY3RvciBDYWxjdWxhdGlvbgogICAgICAgICAgICBsZXQgYWltVmVjID0gbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpcGVMZW4gPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoc3dpcGVMZW4gPiAoVEMuU1dJUEVfTUlOX1BYICE9PSB1bmRlZmluZWQgPyBUQy5TV0lQRV9NSU5fUFggOiAyMCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmE7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmIChjYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oZndkKTsKICAgICAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIGZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMoZndkLCBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IocmlnaHQsIGR4ICogKFRDLkFJTV9EWF9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RYX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKGZ3ZCwgLWR5ICogKFRDLkFJTV9EWV9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RZX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IHdvcmxkVmVjOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBhaW1WZWM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIC0tLSBBTkFMT0cgQ1VSVkUgTE9HSUMgLS0tCiAgICAgICAgICAgIC8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQovLyBEZXRlY3QgTE9CIChWZXJ0aWNhbCBVcCBTd2lwZSkKICAgICAgICAgICAgbGV0IGlzTG9iID0gZmFsc2U7CiAgICAgICAgICAgIC8qIERJU0FCTEVEOiBVc2VyIGZlZWRiYWNrIGluZGljYXRlcyBhY2NpZGVudGFsIHRyaWdnZXJzIHByZXZlbnRpbmcgZm9yd2FyZCB0aHJvd3MuCiAgICAgICAgICAgIGlmIChkeSA8IC04MCAmJiBNYXRoLmFicyhkeCkgPCBNYXRoLmFicyhkeSkgKiAwLjYpIHsKICAgICAgICAgICAgICAgIGlzTG9iID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTE9CISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKEhlcmN1bGVhbiBCb29zdCkKICAgICAgICAgICAgICAgIGxldCBzcGluTWFnID0gcmF3SW50ZW5zaXR5ICogKFRDLkNVUlZFX1NQSU5fU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fU0NBTEUgOiAxMDAwLjApOwoKICAgICAgICAgICAgICAgIC8vIDIuIFNwZWVkIEJvbnVzIChRdWlja25lc3MgYWRkcyBSUE0pCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEJvbnVzID0gTWF0aC5tYXgoMS4wLCBzd2lwZVNwZWVkICogKFRDLkNVUlZFX1NQRUVEX01VTFQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQRUVEX01VTFQgOiAxLjUpKTsKICAgICAgICAgICAgICAgIHNwaW5NYWcgKj0gc3BlZWRCb251czsKCiAgICAgICAgICAgICAgICAvLyBDYXAgKEluY3JlYXNlZCB0byAxNTAwIGZvciBtYXNzaXZlIGFyY3MpCiAgICAgICAgICAgICAgICBzcGluTWFnID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX0NBUCA6IDE1MDAuMCksIHNwaW5NYWcpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4KICAgICAgICAgICAgICAgIC8vIFJpZ2h0IEh1bXAgKFBvc2l0aXZlIEludGVuc2l0eSkgLT4gTGVmdCBDdXJ2ZSAoUG9zaXRpdmUgU3BpbiBZKQogICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5NYWcgKiBzaWduLCAwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBpZiAoaXNMb2IpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnTE9CJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkb3RHb2FsID4gMC44ICYmIGRpc3RUb0dvYWwgPCAzNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21hcnQgUGFzcyBPdmVycmlkZQogICAgICAgICAgICBjb25zdCB0YXJnZXRNYXRlID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltVmVjKTsKICAgICAgICAgICAgaWYgKHRhcmdldE1hdGUgJiYgdHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdE1hdGUgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RNYXRlIDwgMTIuMCkgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIH0KCmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBORVc6IENoYXJnZSBVSSBtZXRob2RzCiAgICAgICAgX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKSB7CiAgICAgICAgICAgIGNvbnN0IG1ldGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1maWxsJyk7CiAgICAgICAgICAgIGlmIChtZXRlcikgewogICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUud2lkdGggPSBgJHtyYXRpbyAqIDEwMH0lYDsKICAgICAgICAgICAgICAgIGlmIChyYXRpbyA+IDAuOSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmYwLCAjZjgwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhdGlvID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwZjAsICNmZjApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZUNoYXJnZVVJKCkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgogICAgICAgIHNldE92ZXJyaWRlQWltKHgsIHopIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci5zZXQoeCwgMCwgeikubm9ybWFsaXplKCk7CiAgICAgICAgfQoKbG9zZUJhbGwoY29vbGRvd24gPSAxLjApIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5mb3JjZSBjb29sZG93biB0byBwcmV2ZW50IGluc3RhbnQgcmUtZ3JhYgogICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gPSBjb29sZG93bjsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9Cgp1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTYWZldHk6IE5hTiBDaGVjawogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGxheWVyIHBvc2l0aW9uIE5hTiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIsIHRoaXMucm9sZSk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uY29weSh0aGlzLmhvbWVQb3NpdGlvbiB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgTG9naWMgKFBoeXNpY3MgcGFydCAtIFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHBoeXNpY3MgcHJvcHMgdGhhdCBtaWdodCBoYXZlIGJlZW4gYWx0ZXJlZAogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCByZXNldCBoYXBwZW5zIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIC8vIEFVVE8tUkVMRUFTRTogSWYgaGVsZCB0b28gbG9uZyAoM3MpLCBmb3JjZSByZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgppZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlQ29vbGRvd24gPiAwKSB0aGlzLmV2YWRlQ29vbGRvd24gLT0gZHQ7CgogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXZhc2lvbiBMb2dpYyAoU3BpbiBNb3ZlKQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHZpc3VhbCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMsIGJ1dCB3ZSBhcHBseSBtb3ZlbWVudCBoZXJlCiAgICAgICAgICAgICAgICAvLyBGcmljdGlvbmxlc3MgbW92ZW1lbnQgZHVyaW5nIGV2YWRlCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbGlnaHQgZHJhZwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk1KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5ldmFkZVRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjUpOyAvLyBTbG93IGRvd24gYWZ0ZXIgc3BpbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIG5vcm1hbCBwaHlzaWNzCiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVDaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgLy8gQXV0by1yZWxlYXNlIGlmIGhlbGQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPiB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgKyAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBUQUNLTEUgU1RBVEUgKFNsaWRlICYgQ29tbWl0KSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzOiBIaWdoIERyYWcgKFNsaWRlIHRvIHN0b3ApCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgzLjAgKiBkdCkpKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgLy8gQ29sbGlzaW9uIENoZWNrCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjI7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS4yOyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCksIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwgbW9tZW50dW1TY2FsZTogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBMZWFuIGZvciBEYXNoCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDAsIHlhdyA9IDAsIHJvbGwgPSAwLCBsdW5nZUFtdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgIT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IHlhdyA9IDAuOCAqIGxlYW47IHJvbGwgPSAtMC42ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCBsdW5nZUFtdCkuYXBwbHlRdWF0ZXJuaW9uKF9wUXVhdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJhcGlkIFNwaW4KICAgICAgICAgICAgICAgIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IDI1LjAgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVHJhaWwKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjAsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMudGFja2xlQ2hhcmdlVGltZSAvIHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgIC8vIFNoYWtlIG1lc2gKLy8gUmVkIHRpbnQgcHVsc2UKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4ZmYwMDAwKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gSEVSQ1VMRUFOOiBHYXRoZXIgUGFydGljbGVzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuMykgeyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gaW4gYSBzcGhlcmUgYXJvdW5kIHBsYXllcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gTWF0aC5hY29zKDIgKiBNYXRoLnJhbmRvbSgpIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguY29zKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IHIgKiBNYXRoLnNpbihwaGkpICogTWF0aC5zaW4odGhldGEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gciAqIE1hdGguY29zKHBoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMyh4LCB5ICsgMS4wLCB6KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlclBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjAsIDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IHRvd2FyZHMgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGNlbnRlclBvcy5zdWIoc3Bhd25Qb3MpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKDQuMCk7IC8vIFN1Y2sgaW4gc3BlZWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdnYXRoZXInLCBzcGF3blBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCB0cmFpbCBmb3IgdGFja2xlIChUaGUgTHVuZ2UpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNCbG9ja2luZykgewogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgLy8gVmlzdWFsIHRyYWlsIGZvciB0YWNrbGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAxKSAqIDAuMyArIDAuNzsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZiksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgIC8vIFJlc2V0IGNvbG9yIGlmIG5vdCBjaGFyZ2luZy9kYXNoaW5nL2ZsYXNoaW5nL2Jsb2NraW5nCiAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcihkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CgogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgIG9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4yCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSB0aGlzLnN0YXR1cy5ibGluZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB0aGlzLnN0YXR1cy5zaWxlbmNlIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hpZWxkID4gMCkgdGhpcy5zdGF0dXMuc2hpZWxkIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB0aGlzLnN0YXR1cy5oYXN0ZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB0aGlzLnN0YXR1cy5zbG93IC09IGR0Owp9CgogICAgICAgIF91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSBpc1dpdGhlcmluZyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyID0gMC4yOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3NpbGVuY2UnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNpbGVuY2UgPSAwLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSB8fCAwKSAtIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignaGFzdGUnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlID0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Nsb3cnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgPSAwLjQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIDEuIEZMQVNIIEVGRkVDVCAtLS0KICAgICAgICAgICAgbGV0IGZsYXNoUmF0aW8gPSAwOwogICAgICAgICAgICBpZiAodGhpcy5mbGFzaFRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHBhc3NlZCBkdCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBhc3N1bWUgMTZtcyAoc2FmZXR5KQogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIHRoaXMuZmxhc2hUaW1lciAtPSBkZWx0YTsKICAgICAgICAgICAgICAgIGZsYXNoUmF0aW8gPSBNYXRoLm1heCgwLCB0aGlzLmZsYXNoVGltZXIgLyB0aGlzLmZsYXNoRHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgaWYgKGZsYXNoUmF0aW8gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCB0b3dhcmRzIGZsYXNoIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIHRoaXMuZmxhc2hDb2xvciwgZmxhc2hSYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAtLS0gMi4gUFJPQ0VEVVJBTCBTUVVBU0ggJiBTVFJFVENIIChTcHJpbmcgUGh5c2ljcykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gZHQgfHwgMC4wMTY7CiAgICAgICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAyMDAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IGRhbXBpbmcgPSAxNS4wOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gMS4wOwoKICAgICAgICAgICAgICAgIC8vIFggQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VYID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC54KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCArPSBmb3JjZVggKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnggKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS54ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gWSBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVkgPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLnkpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICs9IGZvcmNlWSAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueSArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBaIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWiA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueikgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKz0gZm9yY2VaICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC56ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIE1lc2ggU2NhbGUgKE11bHRpcGxpY2F0aXZlIHdpdGggYmFzZVNjYWxlKQogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC54LAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLnksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2guegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZmxhc2goY29sb3JIZXgsIGR1cmF0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuZmxhc2hDb2xvci5zZXRIZXgoY29sb3JIZXgpOwogICAgICAgICAgICB0aGlzLmZsYXNoRHVyYXRpb24gPSBkdXJhdGlvbjsKICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gZHVyYXRpb247CiAgICAgICAgfQoKICAgICAgICBzcXVhc2goeCwgeSwgeikgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2guc2V0KHgsIHksIHopOwogICAgICAgICAgICAvLyBSZXNldCB2ZWxvY2l0eSBmb3Igc25hcCBmZWVsCiAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IgKEVuaGFuY2VkIFJldGljbGUpCiAgICAgICAgX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gMS4gR3JvdW5kIFJldGljbGUgKFJvdGF0aW5nKQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBfcmV0aWNsZVRleHR1cmUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZjAwIC8vIEdyZWVuIGZvciBwYXNzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgzLjAsIDMuMCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVNZXNoKTsKCiAgICAgICAgICAgIC8vIDIuIFZlcnRpY2FsIFBpbGxhciAoTGlnaHQgU2hhZnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEuMCwgMS4wLCA2LCAxNiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGZmNDQsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMTUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucG9zaXRpb24ueSA9IDMuMDsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVQaWxsYXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gRmxvYXRpbmcgSWNvbiAoQWJvdmUgSGVhZCkKICAgICAgICAgICAgY29uc3QgaWNvbkdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMCwgMS4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbiA9IG5ldyBUSFJFRS5NZXNoKGljb25HZW8sIG1hdCk7IC8vIFJldXNlIHRleHR1cmUKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5wb3NpdGlvbi55ID0gNC41OwogICAgICAgICAgICAvLyBCaWxsYm9hcmQgYmVoYXZpb3IgaGFuZGxlZCBpbiB1cGRhdGUKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVJY29uKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgIXRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbmQgYmVzdCBwYXNzIHRhcmdldAogICAgICAgICAgICBjb25zdCBhaW1EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1EaXIpOwoKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RobHkgbW92ZSB0byB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IGRlc3QgPSB0YXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBkaXN0YW5jZSBpcyBsYXJnZSAoc3dpdGNoZWQgdGFyZ2V0KSwgc25hcC4gRWxzZSBsZXJwLgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uZGlzdGFuY2VUbyhkZXN0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uY29weShkZXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ubGVycChkZXN0LCAwLjMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBLZWVwIFkgYXQgZ3JvdW5kIGxldmVsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjA1OwoKICAgICAgICAgICAgICAgICAgICAvLyBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNwaW4gZ3JvdW5kIHJldGljbGUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnJvdGF0aW9uLnogPSAtdGltZSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKHRpbWUgKiA1LjApICogMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUHVsc2UgcGlsbGFyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmV0aWNsZVBpbGxhcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIubWF0ZXJpYWwub3BhY2l0eSA9IDAuMSArIE1hdGguc2luKHRpbWUgKiA4LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyLnJvdGF0aW9uLnkgPSB0aW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQmlsbGJvYXJkIEljb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlSWNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ucm90YXRpb24ueiA9IHRpbWUgKiAzLjA7IC8vIFNwaW4gaWNvbgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2FwcGx5U29mdENvbGxpc2lvbihkdCkgewogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCAhZ2FtZSB8fCAhZ2FtZS50ZWFtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwogICAgICAgICAgICBjb25zdCByZXB1bHNpb25SYWRpdXMgPSAwLjU7IC8vIFJlZHVjZWQgdG8gMC41IHRvIGZpeCBpbnZpc2libGUgd2FsbCBpc3N1ZXMKICAgICAgICAgICAgY29uc3Qgc3RpZmZuZXNzID0gMTUuMDsKCiAgICAgICAgICAgIHRlYW1zLmZvckVhY2godGVhbSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKG90aGVyID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXIgPT09IHRoaXMgfHwgIW90aGVyLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIG90aGVyLm1lc2gucG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeSA9IHRoaXMubWVzaC5wb3NpdGlvbi55IC0gb3RoZXIubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBvdGhlci5tZXNoLnBvc2l0aW9uLno7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHkqZHkgKyBkeipkejsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtaW5EaXN0ID0gcmVwdWxzaW9uUmFkaXVzICogMi4wOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgbWluRGlzdCAqIG1pbkRpc3QgJiYgZGlzdFNxID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IG1pbkRpc3QgLSBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBvdmVybGFwICogc3RpZmZuZXNzOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnggPSBkeCAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG55ID0gZHkgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueiA9IGR6IC8gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBueCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBueSAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IGlzSW5wdXRBY3RpdmUgPSBpbnB1dExlblNxID4gMC4wMTsKCiAgICAgICAgICAgIGxldCBjdXJyZW50TWF4U3BlZWQgPSB0aGlzLm1heFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU1RSVUdHTEUgU1RBVEU6IEhpbmRlciBtb3ZlbWVudCBiYXNlZCBvbiBwcmVzc3VyZQogICAgICAgICAgICAvLyBJbnN0ZWFkIG9mIGEgYmluYXJ5IDAuOCBtdWx0aXBsaWVyLCB3ZSBzY2FsZSBiYXNlZCBvbiBpbnRlbnNpdHkuCiAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSAoMS4wKSByZWR1Y2VzIHNwZWVkIHRvIDQwJS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gKDEuMCAtICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC42KSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHNsaWdodCByZWR1Y3Rpb24gaWYgZW5nYWdlZCBidXQgbG93IHByZXNzdXJlCiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuaXNUYWNrbGVDaGFyZ2luZyB8fCB0aGlzLmlzQmxvY2tpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjQ7IC8vIFNsb3cgZG93biB3aGVuIGNoYXJnaW5nL2Jsb2NraW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYXN0ZSAvIFNsb3cKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgY3VycmVudE1heFNwZWVkICo9IDEuNTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSBjdXJyZW50TWF4U3BlZWQgKj0gMC41OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3RydWdnbGUgSml0dGVyIHRvIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHdyZXN0bGluZyBmb3IgY29udHJvbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC44OwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnggKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnogKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFggPSBfcFZlYy54ICogY3VycmVudE1heFNwZWVkOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWiA9IF9wVmVjLnogKiBjdXJyZW50TWF4U3BlZWQ7CgogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIGN1cnJlbnRTcGVlZCAvIHRoaXMubWF4U3BlZWQpOwoKICAgICAgICAgICAgICAgIC8vIEFnaWxpdHkgaXMgcmVkdWNlZCB3aGVuIHN0cnVnZ2xpbmcKICAgICAgICAgICAgICAgIGxldCBhZ2lsaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMTAuMCwgMi4wLCBzcGVlZFJhdGlvKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgYWdpbGl0eSAqPSAwLjU7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSk7CgogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgfQoKX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwogICAgICAgIF91cGRhdGVCYW5raW5nKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IHZlbExlblNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgbGV0IHRhcmdldFlhdyA9IHRoaXMudGFyZ2V0WWF3OwogICAgICAgICAgICBsZXQgc2hvdWxkVXBkYXRlWWF3ID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQUklPUklUWSAxOiBFeHBsaWNpdCBBaW0gKEFpbSBTdGljayAvIFN3aXBlKQogICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLm92ZXJyaWRlQWltVmVjdG9yLngsIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDI6IE1vdmVtZW50IElucHV0CiAgICAgICAgICAgIGVsc2UgaWYgKGlucHV0TGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLmlucHV0VmVjdG9yLngsIHRoaXMuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQUklPUklUWSAzOiBWZWxvY2l0eSAoRHJpZnRpbmcpCiAgICAgICAgICAgIGVsc2UgaWYgKHZlbExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS54LCB0aGlzLnZlbG9jaXR5LnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgd2Ugc2hvdWxkIHVwZGF0ZSwgZG8gc28uIE90aGVyd2lzZSBrZWVwIGxhc3QgdmFsaWQgeWF3CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGVZYXcpIHsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGFyZ2V0WWF3OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gdGhpcy5sYXN0VmFsaWRZYXc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtb290aCBZYXcgd2l0aCB3cmFwLWFyb3VuZCBoYW5kbGluZwogICAgICAgICAgICBsZXQgZGlmZiA9IHRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgdGhpcy52ZWxvY2l0eS5sZW5ndGgoKSAvIHRoaXMubWF4U3BlZWQpOwogICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSBUSFJFRS5NYXRoVXRpbHMubGVycCg4LjAsIDQuMCwgc3BlZWRSYXRpbyk7IC8vIFJlZHVjZWQgZnJvbSAxMi4wLzYuMCB0byByZWR1Y2UgZmxpcHBpbmcKCiAgICAgICAgICAgIC8vIFByZXZlbnQgc3VkZGVuIHNuYXBzIHdoZW4gZGlmZiBpcyB2ZXJ5IGxhcmdlICh0ZWxlcG9ydC9yZXNldCBzY2VuYXJpb3MpCiAgICAgICAgICAgIGNvbnN0IG1heFlhd0NoYW5nZSA9IE1hdGguUEkgKiBkdCAqIHR1cm5TcGVlZDsKICAgICAgICAgICAgY29uc3QgeWF3Q2hhbmdlID0gTWF0aC5tYXgoLW1heFlhd0NoYW5nZSwgTWF0aC5taW4obWF4WWF3Q2hhbmdlLCBkaWZmICogZHQgKiB0dXJuU3BlZWQpKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSB5YXdDaGFuZ2U7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGFyZ2V0WWF3OwoKICAgICAgICAgICAgLy8gQmFua2luZwogICAgICAgICAgICBjb25zdCBiYW5rU2Vuc2l0aXZpdHkgPSAwLjg7CiAgICAgICAgICAgIGNvbnN0IG1heEJhbmsgPSAwLjc1OwoKICAgICAgICAgICAgbGV0IHRhcmdldEJhbmsgPSAtZGlmZiAqIGJhbmtTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0QmFuayA9IE1hdGgubWF4KC1tYXhCYW5rLCBNYXRoLm1pbihtYXhCYW5rLCB0YXJnZXRCYW5rKSk7CgogICAgICAgICAgICBjb25zdCBiYW5rTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDIsIGR0KTsKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9ICh0YXJnZXRCYW5rIC0gdGhpcy5iYW5raW5nQW1vdW50KSAqIGJhbmtMZXJwOwoKICAgICAgICAgICAgLy8gUGl0Y2gKICAgICAgICAgICAgY29uc3QgcGl0Y2hTZW5zaXRpdml0eSA9IDAuMTsKICAgICAgICAgICAgY29uc3QgbWF4UGl0Y2ggPSAxLjA7CgogICAgICAgICAgICBsZXQgdGFyZ2V0UGl0Y2ggPSAtdGhpcy52ZWxvY2l0eS55ICogcGl0Y2hTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0UGl0Y2ggPSBNYXRoLm1heCgtbWF4UGl0Y2gsIE1hdGgubWluKG1heFBpdGNoLCB0YXJnZXRQaXRjaCkpOwoKICAgICAgICAgICAgY29uc3QgcGl0Y2hMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wNSwgZHQpOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9ICh0YXJnZXRQaXRjaCAtIHRoaXMucGl0Y2hBbW91bnQpICogcGl0Y2hMZXJwOwoKICAgICAgICAgICAgLy8gQXBwbHkgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxZYXcgPSB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0OwoKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCBmaW5hbFlhdyk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKSwgdGhpcy5waXRjaEFtb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKSwgdGhpcy5iYW5raW5nQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIC8vIElkbGUgQm9iCiAgICAgICAgICAgIGlmICh2ZWxMZW5TcSA8IDAuMSAmJiAhdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE1OwogICAgICAgICAgICAgICAgY29uc3QgYm9iUGl0Y2ggPSBNYXRoLnNpbih0aW1lKSAqIDAuMDM7CiAgICAgICAgICAgICAgICBjb25zdCBib2JSb2xsID0gTWF0aC5jb3ModGltZSAqIDAuNykgKiAwLjAyOwoKICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tUYWNrbGVQcmVzc3VyZShkdCkgewogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zIHx8ICF0aGlzLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRvdGFsUHJlc3N1cmUgPSAwOwogICAgICAgICAgICBsZXQgZW5nYWdlZENvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy50YWNrbGVSYWRpdXM7IAoKICAgICAgICAgICAgLy8gRm9yd2FyZCB2ZWN0b3IgZm9yIHNoaWVsZGluZyBjaGVjawogICAgICAgICAgICBfcFZlYy5jb3B5KF9wQXhpc1opLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZWZmZWN0aXZlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgZW5nYWdlZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eSAoMCB0byAxIGJhc2VkIG9uIGRpc3RhbmNlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3hpbWl0eSA9IDEuMCAtIChkaXN0IC8gZWZmZWN0aXZlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIFByZXNzdXJlIGZyb20gQVQgc3RhdAogICAgICAgICAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IGVudGl0eS5nZXRTdGF0KCdBVCcpICogcHJveGltaXR5OwoKICAgICAgICAgICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcgKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBlbnRpdHkubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgb3Bwb25lbnQgaXMgQkVISU5EIChkb3QgPCAtMC4yKSwgcHJlc3N1cmUgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKQogICAgICAgICAgICAgICAgICAgIGxldCBpc1NoaWVsZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBpc1NoaWVsZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFRlY2ggTW9kaWZpZXJzIChDb250aW51b3VzIGFwcGxpY2F0aW9uIGNoYW5jZSkKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogMC41KSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDUuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDUuMCwgJ0VOJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZHJhaW5BbXQgPSBwcmVzc3VyZSAqIGR0ICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRyYWluQW10OwogICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuc3RhdHMuSFAgKz0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0b3RhbFByZXNzdXJlICs9IHByZXNzdXJlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBTcGFya3Mgb2NjYXNpb25hbGx5IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDQuMCAqIHByb3hpbWl0eSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAoZW50aXR5Lm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnNwYXduQ2xhc2gobWlkLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IChlbmdhZ2VkQ291bnQgPiAwKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFTiBEcmFpbiAoQ29udGludW91cykKICAgICAgICAgICAgICAgIC8vIFNjYWxpbmc6IDIwIEFUIHByZXNzdXJlIC0+IGFwcHJveCAxMCBFTiBsb3N0IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWluUmF0ZSA9IHRvdGFsUHJlc3N1cmUgKiAwLjU7IAogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTdHJ1Z2dsZSBJbnRlbnNpdHkgZm9yIFBoeXNpY3MgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgYXQgcm91Z2hseSAzMCBwcmVzc3VyZQogICAgICAgICAgICAgICAgdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA9IE1hdGgubWluKDEuMCwgdG90YWxQcmVzc3VyZSAvIDMwLjApOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgRHJhaW4gKEFjY3VtdWxhdGUgdG8gYXZvaWQgc3BhbSkKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlICs9IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHtNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlKX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBIaW50IGZvciBwbGF5ZXIgaWYgZW5nYWdlZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW5jb3VudGVyVGltZXIgPiAxLjAgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA8IDEuMSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3BlcmZvcm1KZWNodEtub2NrYmFjaygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2LjA7CiAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gMjUuMDsKCiAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkpFQ0hUIFNIT1QhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYW5nZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQoZGlyLm11bHRpcGx5U2NhbGFyKGZvcmNlKSk7CgogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOyAvLyBFbnN1cmUgdGhleSBzdGF5IGRvd24KICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWN0QWN0aW9uID0gcC5hY3Rpb25zICYmIHAuYWN0aW9uc1sncmVhY3QnXTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVhY3RBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb3NlQmFsbCgpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX3BWZWMubXVsdGlwbHlTY2FsYXIoMTAuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wIGZvciByZWFsaXNtCgogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQocHVzaERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuMik7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVFVOISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZSBCdXJzdCAoQnJlYWsgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgKE1hdGgucmFuZG9tKCktMC41KSoyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgLy8gSG9sb2dyYXBoaWMgSFAgQmFyIFNoYWRlciB3aXRoIEp1aWNlIChTaGFrZSAmIEZsYXNoKQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuNCwgMC4xOCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVGaWxsOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmYwMCkgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuOSB9LAogICAgICAgICAgICAgICAgICAgIHVTaGFrZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUZsYXNoOiB7IHZhbHVlOiAwLjAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IFNoYWtlIEVmZmVjdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodVNoYWtlID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSBzaW4odCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBjb3ModCAqIDAuOCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZpbGw7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1Rmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGcmFtZSBkaW1lbnNpb25zIChVViBzcGFjZSkKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9yZGVyWSA9IDAuMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclggPSAwLjAyOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5uZXIgY29udGVudCBtYXNrCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWSA9IHN0ZXAoYm9yZGVyWSwgdlV2LnkpICogc3RlcCh2VXYueSwgMS4wIC0gYm9yZGVyWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWCA9IHN0ZXAoYm9yZGVyWCwgdlV2LngpICogc3RlcCh2VXYueCwgMS4wIC0gYm9yZGVyWCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGNvbnRlbnRNYXNrID0gaW5ZICogaW5YOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFja2dyb3VuZCAoVGVjaCBHcmlkKQogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJnQ29sID0gdmVjMygwLjAsIDAuMSwgMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JpZCA9IHN0ZXAoMC45LCBmcmFjdCh2VXYueCAqIDIwLjAgKyB2VXYueSAqIDEwLjApKSAqIDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgYmdDb2wgKz0gZ3JpZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbGwgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmlsbE1hc2sgPSBzdGVwKHZVdi54LCB1RmlsbCkgKiBjb250ZW50TWFzazsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuZXJneSBQdWxzZSBQYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gc2luKHZVdi54ICogMTAuMCAtIHVUaW1lICogMy4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiYXJDb2wgPSBtaXgodUNvbG9yLCB1Q29sb3IgKyB2ZWMzKDAuNCksIHB1bHNlICogMC42KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvdCBFZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBzbW9vdGhzdGVwKHVGaWxsIC0gMC4wNSwgdUZpbGwsIHZVdi54KSAqIGZpbGxNYXNrOwogICAgICAgICAgICAgICAgICAgICAgICBiYXJDb2wgKz0gdmVjMygxLjApICogZWRnZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNjYW5saW5lIChIb2xvZ3JhbSBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odlV2LnkgKiA4MC4wICsgdVRpbWUgKiA1LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvcmRlciBHbG93CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlck1hc2sgPSAoMS4wIC0gY29udGVudE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJvcmRlckNvbCA9IHZlYzMoMC4wLCAwLjYsIDEuMCkgKiAwLjY7IC8vIEN5YW4gdGVjaCBib3JkZXIKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IG1peChiZ0NvbCwgYmFyQ29sLCBmaWxsTWFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCBib3JkZXJDb2wsIGJvcmRlck1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IEZsYXNoIChEYW1hZ2UvSW1wYWN0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodUZsYXNoID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCB2ZWMzKDEuMCwgMS4wLCAxLjApLCB1Rmxhc2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFja2dyb3VuZCBhcmVhcyBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbE1hc2sgPCAwLjUgJiYgYm9yZGVyTWFzayA8IDAuNSkgYWxwaGEgKj0gMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChmaW5hbENvbCwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsIC8vIFJlbmRlciBvbiB0b3AKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucmVuZGVyT3JkZXIgPSA5MDA7IC8vIEVuc3VyZSBpdCByZW5kZXJzIGFib3ZlIG1vc3QgdGhpbmdzCiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuaHBCYXIpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhQQmFyKGR0ID0gMC4wMTYpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFZpc2liaWxpdHkgQ2hlY2s6IE9ubHkgc2hvdyBpZiBtZXNoIGlzIHZpc2libGUgQU5EIGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRTdGF0ZSA9IGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuc3RhdGUgPT09ICdraWNrb2ZmJyB8fCBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBKVUlDRTogRGFtYWdlIFJlYWN0aW9uIC0tLQogICAgICAgICAgICAvLyBJbml0aWFsaXplIF9sYXN0SFAgaWYgdW5kZWZpbmVkIChmaXJzdCBydW4pCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXN0SFAgPT09IHVuZGVmaW5lZCkgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gdGhpcy5fbGFzdEhQIC0gdGhpcy5zdGF0cy5IUDsKICAgICAgICAgICAgaWYgKGRlbHRhID4gMC4xKSB7CiAgICAgICAgICAgICAgICAvLyBIUCBEZWNyZWFzZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcgfHwgdGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVm9sdW50YXJ5IGV4ZXJ0aW9uIChBYmlsaXR5IGNvc3QpIC0+IFNtYWxsIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gTWF0aC5taW4odGhpcy5ocEZsYXNoICsgMC40LCAwLjYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnZvbHVudGFyeSBkYW1hZ2UgKFZlbm9tLCBEcmFpbiwgZXRjKSAtPiBTaGFrZSArIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gTWF0aC5taW4odGhpcy5ocFNoYWtlICsgMC4wNSwgMC4xNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2xhc3RIUCA9IHRoaXMuc3RhdHMuSFA7CgogICAgICAgICAgICAvLyBEZWNheSBGWAogICAgICAgICAgICB0aGlzLmhwU2hha2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA4LjApOwogICAgICAgICAgICB0aGlzLmhwRmxhc2ggKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA1LjApOwoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFNoYWRlciBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLmhwQmFyLm1hdGVyaWFsOwogICAgICAgICAgICBpZiAobWF0LnVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZpbGwudmFsdWUgPSBwY3Q7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVNoYWtlLnZhbHVlID0gdGhpcy5ocFNoYWtlOwogICAgICAgICAgICAgICAgbWF0LnVuaWZvcm1zLnVGbGFzaC52YWx1ZSA9IHRoaXMuaHBGbGFzaDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY29sID0gbWF0LnVuaWZvcm1zLnVDb2xvci52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIGNvbC5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgY29sLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGNvbC5zZXRIZXgoMHhmZjAwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIaWRlIGlmIGZ1bGwgSFAgdG8gcmVkdWNlIGNsdXR0ZXIsIHVubGVzcyBpbiBwcmFjdGljZSBtb2RlCiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IChwY3QgPCAwLjk4IHx8IGFsd2F5c1Nob3cgfHwgdGhpcy5ocEZsYXNoID4gMC4xKTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IGFzIHRhY2tsZSBkaXJlY3Rpb24gKHNpbmNlIHRhY2tsZSBpbXBhcnRzIHZlbG9jaXR5KQogICAgICAgICAgICAvLyBGYWxsYmFjayB0byBmYWNpbmcgaWYgdmVsb2NpdHkgaXMgbmVnbGlnaWJsZQogICAgICAgICAgICBsZXQgdGFja2xlRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICB0YWNrbGVEaXIueSA9IDA7CiAgICAgICAgICAgIGlmICh0YWNrbGVEaXIubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgdGFja2xlRGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhY2tsZURpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcG9uZW50VGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIHRvIG9wcG9uZW50CiAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0b09wcC55ID0gMDsgLy8gSWdub3JlIGhlaWdodCBkaWZmZXJlbmNlIGZvciBoaXQgZGV0ZWN0aW9uIGN5bGluZGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b09wcC5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlYWNoID0gMy41OyAvLyBEZXRlY3Rpb24gcmFkaXVzCgogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByZWFjaCkgewogICAgICAgICAgICAgICAgICAgIHRvT3BwLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IHRhY2tsZURpci5kb3QodG9PcHApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbmUgQ2hlY2s6IH40NSBkZWdyZWVzIChkb3QgPiAwLjcpCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyByZXF1aXJlcyB0aGUgcGxheWVyIHRvIGFjdHVhbGx5IGFpbSB0aGUgdGFja2xlCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC43KSAvIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydFRhY2tsZShkeCwgZHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLmlzRGFzaGluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY29zdCA9IDE1OwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwoKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOw==","./Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQogICAgICAgICAgICB0aGlzLmJvbmVzID0gewogICAgICAgICAgICAgICAgaGlwczogbnVsbCwKICAgICAgICAgICAgICAgIHNwaW5lOiBudWxsLAogICAgICAgICAgICAgICAgY2hlc3Q6IG51bGwsCiAgICAgICAgICAgICAgICBuZWNrOiBudWxsLAogICAgICAgICAgICAgICAgaGVhZDogbnVsbCwKICAgICAgICAgICAgICAgIHJVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIHJGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckhhbmQ6IG51bGwsCiAgICAgICAgICAgICAgICBsVXBwZXJBcm06IG51bGwsCiAgICAgICAgICAgICAgICBsRm9yZUFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxIYW5kOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCnRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9LAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKICAgICAgICAgICAgdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CnZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwLAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwgVGltZXIKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnNsb3cgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zbG93LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5oYXN0ZSA9IDA7IC8vIE92ZXJ3cml0ZSBoYXN0ZQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xPVyIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwoKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gNS4wICsgKHNwIC8gMTUuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgIH0KCiAgICAgICAgc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwppZiAoa2V5ID09PSAnc3dpbScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC44NSwgMS43MCwgc3BlZWROb3JtKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleSA9PT0gJ2Rhc2gnKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEuMTAsIDIuMjAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdpZGxlJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgwLjk1LCAxLjA1LCBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgICAgIC8vIEhhc3RlL1Nsb3cgQW5pbWF0aW9uIFNjYWxpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGEudGltZVNjYWxlICo9IDEuNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgYS50aW1lU2NhbGUgKj0gMC42Owp9OwoKYXBwbHlSYXRlKHRhcmdldCk7CgogICAgICAgICAgICBpZiAodGhpcy5fbGFzdExvY29tb3Rpb24gIT09IHRhcmdldCkgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIWEpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIC8vIFVzZSB0aGUgbmV3IHBsYXkgbWV0aG9kIHdoaWNoIGhhbmRsZXMgbGF5ZXJpbmcKICAgICAgICAgICAgdGhpcy5wbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmxlcnAodG9NYXRlLCBhc3Npc3RGYWN0b3IpOwpmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgovLyBCbGluZCBSYW5kb21pemF0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC44OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1BWCBQT1dFUiBCT05VUzogSWYgaGVsZCBuZWFyIG1heCwgc2lnbmlmaWNhbnQgYm9vc3QKICAgICAgICAgICAgaWYgKHJhdGlvID4gKFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPIDogMC45NSkpIHsKICAgICAgICAgICAgICAgIG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSIDogMi41KTsgLy8gQ3JpdGljYWwgUG93ZXIKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTUFYIFBPV0VSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgLy8gQWltIFZlY3RvciBDYWxjdWxhdGlvbgogICAgICAgICAgICBsZXQgYWltVmVjID0gbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpcGVMZW4gPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoc3dpcGVMZW4gPiAoVEMuU1dJUEVfTUlOX1BYICE9PSB1bmRlZmluZWQgPyBUQy5TV0lQRV9NSU5fUFggOiAyMCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmE7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmIChjYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oZndkKTsKICAgICAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIGZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMoZndkLCBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IocmlnaHQsIGR4ICogKFRDLkFJTV9EWF9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RYX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKGZ3ZCwgLWR5ICogKFRDLkFJTV9EWV9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RZX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IHdvcmxkVmVjOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBhaW1WZWM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIC0tLSBBTkFMT0cgQ1VSVkUgTE9HSUMgLS0tCiAgICAgICAgICAgIC8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQovLyBEZXRlY3QgTE9CIChWZXJ0aWNhbCBVcCBTd2lwZSkKICAgICAgICAgICAgbGV0IGlzTG9iID0gZmFsc2U7CiAgICAgICAgICAgIC8qIERJU0FCTEVEOiBVc2VyIGZlZWRiYWNrIGluZGljYXRlcyBhY2NpZGVudGFsIHRyaWdnZXJzIHByZXZlbnRpbmcgZm9yd2FyZCB0aHJvd3MuCiAgICAgICAgICAgIGlmIChkeSA8IC04MCAmJiBNYXRoLmFicyhkeCkgPCBNYXRoLmFicyhkeSkgKiAwLjYpIHsKICAgICAgICAgICAgICAgIGlzTG9iID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTE9CISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKEhlcmN1bGVhbiBCb29zdCkKICAgICAgICAgICAgICAgIGxldCBzcGluTWFnID0gcmF3SW50ZW5zaXR5ICogKFRDLkNVUlZFX1NQSU5fU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fU0NBTEUgOiAxMDAwLjApOwoKICAgICAgICAgICAgICAgIC8vIDIuIFNwZWVkIEJvbnVzIChRdWlja25lc3MgYWRkcyBSUE0pCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEJvbnVzID0gTWF0aC5tYXgoMS4wLCBzd2lwZVNwZWVkICogKFRDLkNVUlZFX1NQRUVEX01VTFQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQRUVEX01VTFQgOiAxLjUpKTsKICAgICAgICAgICAgICAgIHNwaW5NYWcgKj0gc3BlZWRCb251czsKCiAgICAgICAgICAgICAgICAvLyBDYXAgKEluY3JlYXNlZCB0byAxNTAwIGZvciBtYXNzaXZlIGFyY3MpCiAgICAgICAgICAgICAgICBzcGluTWFnID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX0NBUCA6IDE1MDAuMCksIHNwaW5NYWcpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4KICAgICAgICAgICAgICAgIC8vIFJpZ2h0IEh1bXAgKFBvc2l0aXZlIEludGVuc2l0eSkgLT4gTGVmdCBDdXJ2ZSAoUG9zaXRpdmUgU3BpbiBZKQogICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5NYWcgKiBzaWduLCAwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBpZiAoaXNMb2IpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnTE9CJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkb3RHb2FsID4gMC44ICYmIGRpc3RUb0dvYWwgPCAzNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21hcnQgUGFzcyBPdmVycmlkZQogICAgICAgICAgICBjb25zdCB0YXJnZXRNYXRlID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltVmVjKTsKICAgICAgICAgICAgaWYgKHRhcmdldE1hdGUgJiYgdHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdE1hdGUgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RNYXRlIDwgMTIuMCkgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIH0KCmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBORVc6IENoYXJnZSBVSSBtZXRob2RzCiAgICAgICAgX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKSB7CiAgICAgICAgICAgIGNvbnN0IG1ldGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1maWxsJyk7CiAgICAgICAgICAgIGlmIChtZXRlcikgewogICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUud2lkdGggPSBgJHtyYXRpbyAqIDEwMH0lYDsKICAgICAgICAgICAgICAgIGlmIChyYXRpbyA+IDAuOSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmYwLCAjZjgwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhdGlvID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwZjAsICNmZjApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZUNoYXJnZVVJKCkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgogICAgICAgIHNldE92ZXJyaWRlQWltKHgsIHopIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci5zZXQoeCwgMCwgeikubm9ybWFsaXplKCk7CiAgICAgICAgfQoKbG9zZUJhbGwoY29vbGRvd24gPSAxLjApIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5mb3JjZSBjb29sZG93biB0byBwcmV2ZW50IGluc3RhbnQgcmUtZ3JhYgogICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gPSBjb29sZG93bjsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9Cgp1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTYWZldHk6IE5hTiBDaGVjawogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGxheWVyIHBvc2l0aW9uIE5hTiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIsIHRoaXMucm9sZSk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uY29weSh0aGlzLmhvbWVQb3NpdGlvbiB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgTG9naWMgKFBoeXNpY3MgcGFydCAtIFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHBoeXNpY3MgcHJvcHMgdGhhdCBtaWdodCBoYXZlIGJlZW4gYWx0ZXJlZAogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCByZXNldCBoYXBwZW5zIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIC8vIEFVVE8tUkVMRUFTRTogSWYgaGVsZCB0b28gbG9uZyAoM3MpLCBmb3JjZSByZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgppZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlQ29vbGRvd24gPiAwKSB0aGlzLmV2YWRlQ29vbGRvd24gLT0gZHQ7CgogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXZhc2lvbiBMb2dpYyAoU3BpbiBNb3ZlKQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHZpc3VhbCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMsIGJ1dCB3ZSBhcHBseSBtb3ZlbWVudCBoZXJlCiAgICAgICAgICAgICAgICAvLyBGcmljdGlvbmxlc3MgbW92ZW1lbnQgZHVyaW5nIGV2YWRlCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbGlnaHQgZHJhZwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk1KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5ldmFkZVRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjUpOyAvLyBTbG93IGRvd24gYWZ0ZXIgc3BpbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIG5vcm1hbCBwaHlzaWNzCiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVDaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgLy8gQXV0by1yZWxlYXNlIGlmIGhlbGQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPiB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgKyAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBUQUNLTEUgU1RBVEUgKFNsaWRlICYgQ29tbWl0KSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzOiBIaWdoIERyYWcgKFNsaWRlIHRvIHN0b3ApCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgzLjAgKiBkdCkpKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgLy8gQ29sbGlzaW9uIENoZWNrCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjI7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS4yOyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCksIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwgbW9tZW50dW1TY2FsZTogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBMZWFuIGZvciBEYXNoCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDAsIHlhdyA9IDAsIHJvbGwgPSAwLCBsdW5nZUFtdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgIT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IHlhdyA9IDAuOCAqIGxlYW47IHJvbGwgPSAtMC42ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCBsdW5nZUFtdCkuYXBwbHlRdWF0ZXJuaW9uKF9wUXVhdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJhcGlkIFNwaW4KICAgICAgICAgICAgICAgIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IDI1LjAgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVHJhaWwKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjAsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMudGFja2xlQ2hhcmdlVGltZSAvIHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgIC8vIFNoYWtlIG1lc2gKLy8gUmVkIHRpbnQgcHVsc2UKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4ZmYwMDAwKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gSEVSQ1VMRUFOOiBHYXRoZXIgUGFydGljbGVzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuMykgeyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gaW4gYSBzcGhlcmUgYXJvdW5kIHBsYXllcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gTWF0aC5hY29zKDIgKiBNYXRoLnJhbmRvbSgpIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguY29zKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IHIgKiBNYXRoLnNpbihwaGkpICogTWF0aC5zaW4odGhldGEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gciAqIE1hdGguY29zKHBoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMyh4LCB5ICsgMS4wLCB6KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlclBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjAsIDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IHRvd2FyZHMgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGNlbnRlclBvcy5zdWIoc3Bhd25Qb3MpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKDQuMCk7IC8vIFN1Y2sgaW4gc3BlZWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdnYXRoZXInLCBzcGF3blBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCB0cmFpbCBmb3IgdGFja2xlIChUaGUgTHVuZ2UpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNCbG9ja2luZykgewogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgLy8gVmlzdWFsIHRyYWlsIGZvciB0YWNrbGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAxKSAqIDAuMyArIDAuNzsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZiksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgIC8vIFJlc2V0IGNvbG9yIGlmIG5vdCBjaGFyZ2luZy9kYXNoaW5nL2ZsYXNoaW5nL2Jsb2NraW5nCiAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcihkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CgogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgIG9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4yCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSB0aGlzLnN0YXR1cy5ibGluZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB0aGlzLnN0YXR1cy5zaWxlbmNlIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hpZWxkID4gMCkgdGhpcy5zdGF0dXMuc2hpZWxkIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB0aGlzLnN0YXR1cy5oYXN0ZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB0aGlzLnN0YXR1cy5zbG93IC09IGR0Owp9CgogICAgICAgIF91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSBpc1dpdGhlcmluZyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyID0gMC4yOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3NpbGVuY2UnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNpbGVuY2UgPSAwLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSB8fCAwKSAtIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignaGFzdGUnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlID0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Nsb3cnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgPSAwLjQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIDEuIEZMQVNIIEVGRkVDVCAtLS0KICAgICAgICAgICAgbGV0IGZsYXNoUmF0aW8gPSAwOwogICAgICAgICAgICBpZiAodGhpcy5mbGFzaFRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHBhc3NlZCBkdCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBhc3N1bWUgMTZtcyAoc2FmZXR5KQogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIHRoaXMuZmxhc2hUaW1lciAtPSBkZWx0YTsKICAgICAgICAgICAgICAgIGZsYXNoUmF0aW8gPSBNYXRoLm1heCgwLCB0aGlzLmZsYXNoVGltZXIgLyB0aGlzLmZsYXNoRHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgaWYgKGZsYXNoUmF0aW8gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCB0b3dhcmRzIGZsYXNoIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIHRoaXMuZmxhc2hDb2xvciwgZmxhc2hSYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAtLS0gMi4gUFJPQ0VEVVJBTCBTUVVBU0ggJiBTVFJFVENIIChTcHJpbmcgUGh5c2ljcykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gZHQgfHwgMC4wMTY7CiAgICAgICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAyMDAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IGRhbXBpbmcgPSAxNS4wOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gMS4wOwoKICAgICAgICAgICAgICAgIC8vIFggQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VYID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC54KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCArPSBmb3JjZVggKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnggKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS54ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gWSBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVkgPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLnkpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICs9IGZvcmNlWSAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueSArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBaIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWiA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueikgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKz0gZm9yY2VaICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC56ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIE1lc2ggU2NhbGUgKE11bHRpcGxpY2F0aXZlIHdpdGggYmFzZVNjYWxlKQogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC54LAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLnksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2guegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZmxhc2goY29sb3JIZXgsIGR1cmF0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuZmxhc2hDb2xvci5zZXRIZXgoY29sb3JIZXgpOwogICAgICAgICAgICB0aGlzLmZsYXNoRHVyYXRpb24gPSBkdXJhdGlvbjsKICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gZHVyYXRpb247CiAgICAgICAgfQoKICAgICAgICBzcXVhc2goeCwgeSwgeikgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2guc2V0KHgsIHksIHopOwogICAgICAgICAgICAvLyBSZXNldCB2ZWxvY2l0eSBmb3Igc25hcCBmZWVsCiAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IgKEVuaGFuY2VkIFJldGljbGUpCiAgICAgICAgX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gMS4gR3JvdW5kIFJldGljbGUgKFJvdGF0aW5nKQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBfcmV0aWNsZVRleHR1cmUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZjAwIC8vIEdyZWVuIGZvciBwYXNzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgzLjAsIDMuMCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVNZXNoKTsKCiAgICAgICAgICAgIC8vIDIuIFZlcnRpY2FsIFBpbGxhciAoTGlnaHQgU2hhZnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEuMCwgMS4wLCA2LCAxNiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGZmNDQsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMTUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucG9zaXRpb24ueSA9IDMuMDsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVQaWxsYXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gRmxvYXRpbmcgSWNvbiAoQWJvdmUgSGVhZCkKICAgICAgICAgICAgY29uc3QgaWNvbkdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMCwgMS4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbiA9IG5ldyBUSFJFRS5NZXNoKGljb25HZW8sIG1hdCk7IC8vIFJldXNlIHRleHR1cmUKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5wb3NpdGlvbi55ID0gNC41OwogICAgICAgICAgICAvLyBCaWxsYm9hcmQgYmVoYXZpb3IgaGFuZGxlZCBpbiB1cGRhdGUKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVJY29uKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgIXRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbmQgYmVzdCBwYXNzIHRhcmdldAogICAgICAgICAgICBjb25zdCBhaW1EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1EaXIpOwoKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RobHkgbW92ZSB0byB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IGRlc3QgPSB0YXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBkaXN0YW5jZSBpcyBsYXJnZSAoc3dpdGNoZWQgdGFyZ2V0KSwgc25hcC4gRWxzZSBsZXJwLgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uZGlzdGFuY2VUbyhkZXN0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uY29weShkZXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ubGVycChkZXN0LCAwLjMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBLZWVwIFkgYXQgZ3JvdW5kIGxldmVsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjA1OwoKICAgICAgICAgICAgICAgICAgICAvLyBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNwaW4gZ3JvdW5kIHJldGljbGUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnJvdGF0aW9uLnogPSAtdGltZSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKHRpbWUgKiA1LjApICogMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUHVsc2UgcGlsbGFyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmV0aWNsZVBpbGxhcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIubWF0ZXJpYWwub3BhY2l0eSA9IDAuMSArIE1hdGguc2luKHRpbWUgKiA4LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyLnJvdGF0aW9uLnkgPSB0aW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQmlsbGJvYXJkIEljb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlSWNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ucm90YXRpb24ueiA9IHRpbWUgKiAzLjA7IC8vIFNwaW4gaWNvbgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2FwcGx5U29mdENvbGxpc2lvbihkdCkgewogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCAhZ2FtZSB8fCAhZ2FtZS50ZWFtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwogICAgICAgICAgICBjb25zdCByZXB1bHNpb25SYWRpdXMgPSAwLjU7IC8vIFJlZHVjZWQgdG8gMC41IHRvIGZpeCBpbnZpc2libGUgd2FsbCBpc3N1ZXMKICAgICAgICAgICAgY29uc3Qgc3RpZmZuZXNzID0gMTUuMDsKCiAgICAgICAgICAgIHRlYW1zLmZvckVhY2godGVhbSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKG90aGVyID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXIgPT09IHRoaXMgfHwgIW90aGVyLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIG90aGVyLm1lc2gucG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeSA9IHRoaXMubWVzaC5wb3NpdGlvbi55IC0gb3RoZXIubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBvdGhlci5tZXNoLnBvc2l0aW9uLno7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHkqZHkgKyBkeipkejsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtaW5EaXN0ID0gcmVwdWxzaW9uUmFkaXVzICogMi4wOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgbWluRGlzdCAqIG1pbkRpc3QgJiYgZGlzdFNxID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IG1pbkRpc3QgLSBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBvdmVybGFwICogc3RpZmZuZXNzOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnggPSBkeCAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG55ID0gZHkgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueiA9IGR6IC8gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBueCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBueSAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IGlzSW5wdXRBY3RpdmUgPSBpbnB1dExlblNxID4gMC4wMTsKCiAgICAgICAgICAgIGxldCBjdXJyZW50TWF4U3BlZWQgPSB0aGlzLm1heFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU1RSVUdHTEUgU1RBVEU6IEhpbmRlciBtb3ZlbWVudCBiYXNlZCBvbiBwcmVzc3VyZQogICAgICAgICAgICAvLyBJbnN0ZWFkIG9mIGEgYmluYXJ5IDAuOCBtdWx0aXBsaWVyLCB3ZSBzY2FsZSBiYXNlZCBvbiBpbnRlbnNpdHkuCiAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSAoMS4wKSByZWR1Y2VzIHNwZWVkIHRvIDQwJS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gKDEuMCAtICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC42KSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHNsaWdodCByZWR1Y3Rpb24gaWYgZW5nYWdlZCBidXQgbG93IHByZXNzdXJlCiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuaXNUYWNrbGVDaGFyZ2luZyB8fCB0aGlzLmlzQmxvY2tpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjQ7IC8vIFNsb3cgZG93biB3aGVuIGNoYXJnaW5nL2Jsb2NraW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYXN0ZSAvIFNsb3cKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgY3VycmVudE1heFNwZWVkICo9IDEuNTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSBjdXJyZW50TWF4U3BlZWQgKj0gMC41OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3RydWdnbGUgSml0dGVyIHRvIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHdyZXN0bGluZyBmb3IgY29udHJvbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC44OwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnggKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnogKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFggPSBfcFZlYy54ICogY3VycmVudE1heFNwZWVkOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWiA9IF9wVmVjLnogKiBjdXJyZW50TWF4U3BlZWQ7CgogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIGN1cnJlbnRTcGVlZCAvIHRoaXMubWF4U3BlZWQpOwoKICAgICAgICAgICAgICAgIC8vIEFnaWxpdHkgaXMgcmVkdWNlZCB3aGVuIHN0cnVnZ2xpbmcKICAgICAgICAgICAgICAgIGxldCBhZ2lsaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMTAuMCwgMi4wLCBzcGVlZFJhdGlvKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgYWdpbGl0eSAqPSAwLjU7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSk7CgogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgfQoKX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwogICAgICAgIF91cGRhdGVCYW5raW5nKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IHZlbExlblNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgbGV0IHRhcmdldFlhdyA9IHRoaXMudGFyZ2V0WWF3OwogICAgICAgICAgICBsZXQgc2hvdWxkVXBkYXRlWWF3ID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQUklPUklUWSAxOiBFeHBsaWNpdCBBaW0gKEFpbSBTdGljayAvIFN3aXBlKQogICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLm92ZXJyaWRlQWltVmVjdG9yLngsIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDI6IE1vdmVtZW50IElucHV0CiAgICAgICAgICAgIGVsc2UgaWYgKGlucHV0TGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLmlucHV0VmVjdG9yLngsIHRoaXMuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQUklPUklUWSAzOiBWZWxvY2l0eSAoRHJpZnRpbmcpCiAgICAgICAgICAgIGVsc2UgaWYgKHZlbExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS54LCB0aGlzLnZlbG9jaXR5LnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgd2Ugc2hvdWxkIHVwZGF0ZSwgZG8gc28uIE90aGVyd2lzZSBrZWVwIGxhc3QgdmFsaWQgeWF3CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGVZYXcpIHsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGFyZ2V0WWF3OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gdGhpcy5sYXN0VmFsaWRZYXc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtb290aCBZYXcgd2l0aCB3cmFwLWFyb3VuZCBoYW5kbGluZwogICAgICAgICAgICBsZXQgZGlmZiA9IHRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgdGhpcy52ZWxvY2l0eS5sZW5ndGgoKSAvIHRoaXMubWF4U3BlZWQpOwogICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSBUSFJFRS5NYXRoVXRpbHMubGVycCg4LjAsIDQuMCwgc3BlZWRSYXRpbyk7IC8vIFJlZHVjZWQgZnJvbSAxMi4wLzYuMCB0byByZWR1Y2UgZmxpcHBpbmcKCiAgICAgICAgICAgIC8vIFByZXZlbnQgc3VkZGVuIHNuYXBzIHdoZW4gZGlmZiBpcyB2ZXJ5IGxhcmdlICh0ZWxlcG9ydC9yZXNldCBzY2VuYXJpb3MpCiAgICAgICAgICAgIGNvbnN0IG1heFlhd0NoYW5nZSA9IE1hdGguUEkgKiBkdCAqIHR1cm5TcGVlZDsKICAgICAgICAgICAgY29uc3QgeWF3Q2hhbmdlID0gTWF0aC5tYXgoLW1heFlhd0NoYW5nZSwgTWF0aC5taW4obWF4WWF3Q2hhbmdlLCBkaWZmICogZHQgKiB0dXJuU3BlZWQpKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSB5YXdDaGFuZ2U7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGFyZ2V0WWF3OwoKICAgICAgICAgICAgLy8gQmFua2luZwogICAgICAgICAgICBjb25zdCBiYW5rU2Vuc2l0aXZpdHkgPSAwLjg7CiAgICAgICAgICAgIGNvbnN0IG1heEJhbmsgPSAwLjc1OwoKICAgICAgICAgICAgbGV0IHRhcmdldEJhbmsgPSAtZGlmZiAqIGJhbmtTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0QmFuayA9IE1hdGgubWF4KC1tYXhCYW5rLCBNYXRoLm1pbihtYXhCYW5rLCB0YXJnZXRCYW5rKSk7CgogICAgICAgICAgICBjb25zdCBiYW5rTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDIsIGR0KTsKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9ICh0YXJnZXRCYW5rIC0gdGhpcy5iYW5raW5nQW1vdW50KSAqIGJhbmtMZXJwOwoKICAgICAgICAgICAgLy8gUGl0Y2gKICAgICAgICAgICAgY29uc3QgcGl0Y2hTZW5zaXRpdml0eSA9IDAuMTsKICAgICAgICAgICAgY29uc3QgbWF4UGl0Y2ggPSAxLjA7CgogICAgICAgICAgICBsZXQgdGFyZ2V0UGl0Y2ggPSAtdGhpcy52ZWxvY2l0eS55ICogcGl0Y2hTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0UGl0Y2ggPSBNYXRoLm1heCgtbWF4UGl0Y2gsIE1hdGgubWluKG1heFBpdGNoLCB0YXJnZXRQaXRjaCkpOwoKICAgICAgICAgICAgY29uc3QgcGl0Y2hMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wNSwgZHQpOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9ICh0YXJnZXRQaXRjaCAtIHRoaXMucGl0Y2hBbW91bnQpICogcGl0Y2hMZXJwOwoKICAgICAgICAgICAgLy8gQXBwbHkgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxZYXcgPSB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0OwoKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCBmaW5hbFlhdyk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKSwgdGhpcy5waXRjaEFtb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKSwgdGhpcy5iYW5raW5nQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIC8vIElkbGUgQm9iCiAgICAgICAgICAgIGlmICh2ZWxMZW5TcSA8IDAuMSAmJiAhdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE1OwogICAgICAgICAgICAgICAgY29uc3QgYm9iUGl0Y2ggPSBNYXRoLnNpbih0aW1lKSAqIDAuMDM7CiAgICAgICAgICAgICAgICBjb25zdCBib2JSb2xsID0gTWF0aC5jb3ModGltZSAqIDAuNykgKiAwLjAyOwoKICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tUYWNrbGVQcmVzc3VyZShkdCkgewogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zIHx8ICF0aGlzLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRvdGFsUHJlc3N1cmUgPSAwOwogICAgICAgICAgICBsZXQgZW5nYWdlZENvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy50YWNrbGVSYWRpdXM7IAoKICAgICAgICAgICAgLy8gRm9yd2FyZCB2ZWN0b3IgZm9yIHNoaWVsZGluZyBjaGVjawogICAgICAgICAgICBfcFZlYy5jb3B5KF9wQXhpc1opLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZWZmZWN0aXZlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgZW5nYWdlZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eSAoMCB0byAxIGJhc2VkIG9uIGRpc3RhbmNlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3hpbWl0eSA9IDEuMCAtIChkaXN0IC8gZWZmZWN0aXZlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIFByZXNzdXJlIGZyb20gQVQgc3RhdAogICAgICAgICAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IGVudGl0eS5nZXRTdGF0KCdBVCcpICogcHJveGltaXR5OwoKICAgICAgICAgICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcgKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBlbnRpdHkubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgb3Bwb25lbnQgaXMgQkVISU5EIChkb3QgPCAtMC4yKSwgcHJlc3N1cmUgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKQogICAgICAgICAgICAgICAgICAgIGxldCBpc1NoaWVsZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBpc1NoaWVsZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFRlY2ggTW9kaWZpZXJzIChDb250aW51b3VzIGFwcGxpY2F0aW9uIGNoYW5jZSkKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogMC41KSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDUuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDUuMCwgJ0VOJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZHJhaW5BbXQgPSBwcmVzc3VyZSAqIGR0ICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRyYWluQW10OwogICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuc3RhdHMuSFAgKz0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0b3RhbFByZXNzdXJlICs9IHByZXNzdXJlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBTcGFya3Mgb2NjYXNpb25hbGx5IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDQuMCAqIHByb3hpbWl0eSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAoZW50aXR5Lm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnNwYXduQ2xhc2gobWlkLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IChlbmdhZ2VkQ291bnQgPiAwKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFTiBEcmFpbiAoQ29udGludW91cykKICAgICAgICAgICAgICAgIC8vIFNjYWxpbmc6IDIwIEFUIHByZXNzdXJlIC0+IGFwcHJveCAxMCBFTiBsb3N0IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWluUmF0ZSA9IHRvdGFsUHJlc3N1cmUgKiAwLjU7IAogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTdHJ1Z2dsZSBJbnRlbnNpdHkgZm9yIFBoeXNpY3MgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgYXQgcm91Z2hseSAzMCBwcmVzc3VyZQogICAgICAgICAgICAgICAgdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA9IE1hdGgubWluKDEuMCwgdG90YWxQcmVzc3VyZSAvIDMwLjApOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgRHJhaW4gKEFjY3VtdWxhdGUgdG8gYXZvaWQgc3BhbSkKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlICs9IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHtNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlKX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBIaW50IGZvciBwbGF5ZXIgaWYgZW5nYWdlZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW5jb3VudGVyVGltZXIgPiAxLjAgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA8IDEuMSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3BlcmZvcm1KZWNodEtub2NrYmFjaygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2LjA7CiAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gMjUuMDsKCiAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkpFQ0hUIFNIT1QhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYW5nZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQoZGlyLm11bHRpcGx5U2NhbGFyKGZvcmNlKSk7CgogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOyAvLyBFbnN1cmUgdGhleSBzdGF5IGRvd24KICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWN0QWN0aW9uID0gcC5hY3Rpb25zICYmIHAuYWN0aW9uc1sncmVhY3QnXTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVhY3RBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb3NlQmFsbCgpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX3BWZWMubXVsdGlwbHlTY2FsYXIoMTAuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wIGZvciByZWFsaXNtCgogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQocHVzaERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuMik7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVFVOISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZSBCdXJzdCAoQnJlYWsgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgKE1hdGgucmFuZG9tKCktMC41KSoyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgLy8gSG9sb2dyYXBoaWMgSFAgQmFyIFNoYWRlciB3aXRoIEp1aWNlIChTaGFrZSAmIEZsYXNoKQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuNCwgMC4xOCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVGaWxsOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmYwMCkgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuOSB9LAogICAgICAgICAgICAgICAgICAgIHVTaGFrZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUZsYXNoOiB7IHZhbHVlOiAwLjAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IFNoYWtlIEVmZmVjdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodVNoYWtlID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSBzaW4odCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBjb3ModCAqIDAuOCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZpbGw7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1Rmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGcmFtZSBkaW1lbnNpb25zIChVViBzcGFjZSkKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9yZGVyWSA9IDAuMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclggPSAwLjAyOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5uZXIgY29udGVudCBtYXNrCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWSA9IHN0ZXAoYm9yZGVyWSwgdlV2LnkpICogc3RlcCh2VXYueSwgMS4wIC0gYm9yZGVyWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWCA9IHN0ZXAoYm9yZGVyWCwgdlV2LngpICogc3RlcCh2VXYueCwgMS4wIC0gYm9yZGVyWCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGNvbnRlbnRNYXNrID0gaW5ZICogaW5YOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFja2dyb3VuZCAoVGVjaCBHcmlkKQogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJnQ29sID0gdmVjMygwLjAsIDAuMSwgMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JpZCA9IHN0ZXAoMC45LCBmcmFjdCh2VXYueCAqIDIwLjAgKyB2VXYueSAqIDEwLjApKSAqIDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgYmdDb2wgKz0gZ3JpZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbGwgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmlsbE1hc2sgPSBzdGVwKHZVdi54LCB1RmlsbCkgKiBjb250ZW50TWFzazsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuZXJneSBQdWxzZSBQYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gc2luKHZVdi54ICogMTAuMCAtIHVUaW1lICogMy4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiYXJDb2wgPSBtaXgodUNvbG9yLCB1Q29sb3IgKyB2ZWMzKDAuNCksIHB1bHNlICogMC42KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvdCBFZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBzbW9vdGhzdGVwKHVGaWxsIC0gMC4wNSwgdUZpbGwsIHZVdi54KSAqIGZpbGxNYXNrOwogICAgICAgICAgICAgICAgICAgICAgICBiYXJDb2wgKz0gdmVjMygxLjApICogZWRnZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNjYW5saW5lIChIb2xvZ3JhbSBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odlV2LnkgKiA4MC4wICsgdVRpbWUgKiA1LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvcmRlciBHbG93CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlck1hc2sgPSAoMS4wIC0gY29udGVudE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJvcmRlckNvbCA9IHZlYzMoMC4wLCAwLjYsIDEuMCkgKiAwLjY7IC8vIEN5YW4gdGVjaCBib3JkZXIKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IG1peChiZ0NvbCwgYmFyQ29sLCBmaWxsTWFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCBib3JkZXJDb2wsIGJvcmRlck1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IEZsYXNoIChEYW1hZ2UvSW1wYWN0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodUZsYXNoID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCB2ZWMzKDEuMCwgMS4wLCAxLjApLCB1Rmxhc2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFja2dyb3VuZCBhcmVhcyBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbE1hc2sgPCAwLjUgJiYgYm9yZGVyTWFzayA8IDAuNSkgYWxwaGEgKj0gMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChmaW5hbENvbCwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsIC8vIFJlbmRlciBvbiB0b3AKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucmVuZGVyT3JkZXIgPSA5MDA7IC8vIEVuc3VyZSBpdCByZW5kZXJzIGFib3ZlIG1vc3QgdGhpbmdzCiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuaHBCYXIpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhQQmFyKGR0ID0gMC4wMTYpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFZpc2liaWxpdHkgQ2hlY2s6IE9ubHkgc2hvdyBpZiBtZXNoIGlzIHZpc2libGUgQU5EIGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRTdGF0ZSA9IGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuc3RhdGUgPT09ICdraWNrb2ZmJyB8fCBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBKVUlDRTogRGFtYWdlIFJlYWN0aW9uIC0tLQogICAgICAgICAgICAvLyBJbml0aWFsaXplIF9sYXN0SFAgaWYgdW5kZWZpbmVkIChmaXJzdCBydW4pCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXN0SFAgPT09IHVuZGVmaW5lZCkgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gdGhpcy5fbGFzdEhQIC0gdGhpcy5zdGF0cy5IUDsKICAgICAgICAgICAgaWYgKGRlbHRhID4gMC4xKSB7CiAgICAgICAgICAgICAgICAvLyBIUCBEZWNyZWFzZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcgfHwgdGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVm9sdW50YXJ5IGV4ZXJ0aW9uIChBYmlsaXR5IGNvc3QpIC0+IFNtYWxsIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gTWF0aC5taW4odGhpcy5ocEZsYXNoICsgMC40LCAwLjYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnZvbHVudGFyeSBkYW1hZ2UgKFZlbm9tLCBEcmFpbiwgZXRjKSAtPiBTaGFrZSArIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gTWF0aC5taW4odGhpcy5ocFNoYWtlICsgMC4wNSwgMC4xNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2xhc3RIUCA9IHRoaXMuc3RhdHMuSFA7CgogICAgICAgICAgICAvLyBEZWNheSBGWAogICAgICAgICAgICB0aGlzLmhwU2hha2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA4LjApOwogICAgICAgICAgICB0aGlzLmhwRmxhc2ggKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA1LjApOwoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFNoYWRlciBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLmhwQmFyLm1hdGVyaWFsOwogICAgICAgICAgICBpZiAobWF0LnVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZpbGwudmFsdWUgPSBwY3Q7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVNoYWtlLnZhbHVlID0gdGhpcy5ocFNoYWtlOwogICAgICAgICAgICAgICAgbWF0LnVuaWZvcm1zLnVGbGFzaC52YWx1ZSA9IHRoaXMuaHBGbGFzaDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY29sID0gbWF0LnVuaWZvcm1zLnVDb2xvci52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIGNvbC5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgY29sLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGNvbC5zZXRIZXgoMHhmZjAwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIaWRlIGlmIGZ1bGwgSFAgdG8gcmVkdWNlIGNsdXR0ZXIsIHVubGVzcyBpbiBwcmFjdGljZSBtb2RlCiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IChwY3QgPCAwLjk4IHx8IGFsd2F5c1Nob3cgfHwgdGhpcy5ocEZsYXNoID4gMC4xKTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IGFzIHRhY2tsZSBkaXJlY3Rpb24gKHNpbmNlIHRhY2tsZSBpbXBhcnRzIHZlbG9jaXR5KQogICAgICAgICAgICAvLyBGYWxsYmFjayB0byBmYWNpbmcgaWYgdmVsb2NpdHkgaXMgbmVnbGlnaWJsZQogICAgICAgICAgICBsZXQgdGFja2xlRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICB0YWNrbGVEaXIueSA9IDA7CiAgICAgICAgICAgIGlmICh0YWNrbGVEaXIubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgdGFja2xlRGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhY2tsZURpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcG9uZW50VGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIHRvIG9wcG9uZW50CiAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0b09wcC55ID0gMDsgLy8gSWdub3JlIGhlaWdodCBkaWZmZXJlbmNlIGZvciBoaXQgZGV0ZWN0aW9uIGN5bGluZGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b09wcC5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlYWNoID0gMy41OyAvLyBEZXRlY3Rpb24gcmFkaXVzCgogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByZWFjaCkgewogICAgICAgICAgICAgICAgICAgIHRvT3BwLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IHRhY2tsZURpci5kb3QodG9PcHApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbmUgQ2hlY2s6IH40NSBkZWdyZWVzIChkb3QgPiAwLjcpCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyByZXF1aXJlcyB0aGUgcGxheWVyIHRvIGFjdHVhbGx5IGFpbSB0aGUgdGFja2xlCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC43KSAvIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydFRhY2tsZShkeCwgZHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLmlzRGFzaGluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY29zdCA9IDE1OwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwoKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOw==","/Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQogICAgICAgICAgICB0aGlzLmJvbmVzID0gewogICAgICAgICAgICAgICAgaGlwczogbnVsbCwKICAgICAgICAgICAgICAgIHNwaW5lOiBudWxsLAogICAgICAgICAgICAgICAgY2hlc3Q6IG51bGwsCiAgICAgICAgICAgICAgICBuZWNrOiBudWxsLAogICAgICAgICAgICAgICAgaGVhZDogbnVsbCwKICAgICAgICAgICAgICAgIHJVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIHJGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckhhbmQ6IG51bGwsCiAgICAgICAgICAgICAgICBsVXBwZXJBcm06IG51bGwsCiAgICAgICAgICAgICAgICBsRm9yZUFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxIYW5kOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCnRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9LAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKICAgICAgICAgICAgdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CnZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwLAogICAgICAgICAgICAgICAgYmxpbmQ6IDAsCiAgICAgICAgICAgICAgICBzaWxlbmNlOiAwLAogICAgICAgICAgICAgICAgc2hpZWxkOiAwLAogICAgICAgICAgICAgICAgaGFzdGU6IDAsCiAgICAgICAgICAgICAgICBzbG93OiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwgVGltZXIKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnNsb3cgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zbG93LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5oYXN0ZSA9IDA7IC8vIE92ZXJ3cml0ZSBoYXN0ZQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xPVyIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwoKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gNS4wICsgKHNwIC8gMTUuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgIH0KCiAgICAgICAgc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwppZiAoa2V5ID09PSAnc3dpbScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC44NSwgMS43MCwgc3BlZWROb3JtKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleSA9PT0gJ2Rhc2gnKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEuMTAsIDIuMjAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdpZGxlJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgwLjk1LCAxLjA1LCBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgICAgIC8vIEhhc3RlL1Nsb3cgQW5pbWF0aW9uIFNjYWxpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGEudGltZVNjYWxlICo9IDEuNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgYS50aW1lU2NhbGUgKj0gMC42Owp9OwoKYXBwbHlSYXRlKHRhcmdldCk7CgogICAgICAgICAgICBpZiAodGhpcy5fbGFzdExvY29tb3Rpb24gIT09IHRhcmdldCkgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIWEpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIC8vIFVzZSB0aGUgbmV3IHBsYXkgbWV0aG9kIHdoaWNoIGhhbmRsZXMgbGF5ZXJpbmcKICAgICAgICAgICAgdGhpcy5wbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmxlcnAodG9NYXRlLCBhc3Npc3RGYWN0b3IpOwpmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgovLyBCbGluZCBSYW5kb21pemF0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC44OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1BWCBQT1dFUiBCT05VUzogSWYgaGVsZCBuZWFyIG1heCwgc2lnbmlmaWNhbnQgYm9vc3QKICAgICAgICAgICAgaWYgKHJhdGlvID4gKFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPIDogMC45NSkpIHsKICAgICAgICAgICAgICAgIG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSIDogMi41KTsgLy8gQ3JpdGljYWwgUG93ZXIKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTUFYIFBPV0VSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgLy8gQWltIFZlY3RvciBDYWxjdWxhdGlvbgogICAgICAgICAgICBsZXQgYWltVmVjID0gbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpcGVMZW4gPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoc3dpcGVMZW4gPiAoVEMuU1dJUEVfTUlOX1BYICE9PSB1bmRlZmluZWQgPyBUQy5TV0lQRV9NSU5fUFggOiAyMCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmE7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmIChjYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oZndkKTsKICAgICAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIGZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMoZndkLCBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IocmlnaHQsIGR4ICogKFRDLkFJTV9EWF9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RYX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKGZ3ZCwgLWR5ICogKFRDLkFJTV9EWV9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQUlNX0RZX1NDQUxFIDogMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IHdvcmxkVmVjOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBhaW1WZWM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIC0tLSBBTkFMT0cgQ1VSVkUgTE9HSUMgLS0tCiAgICAgICAgICAgIC8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQovLyBEZXRlY3QgTE9CIChWZXJ0aWNhbCBVcCBTd2lwZSkKICAgICAgICAgICAgbGV0IGlzTG9iID0gZmFsc2U7CiAgICAgICAgICAgIC8qIERJU0FCTEVEOiBVc2VyIGZlZWRiYWNrIGluZGljYXRlcyBhY2NpZGVudGFsIHRyaWdnZXJzIHByZXZlbnRpbmcgZm9yd2FyZCB0aHJvd3MuCiAgICAgICAgICAgIGlmIChkeSA8IC04MCAmJiBNYXRoLmFicyhkeCkgPCBNYXRoLmFicyhkeSkgKiAwLjYpIHsKICAgICAgICAgICAgICAgIGlzTG9iID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiTE9CISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKEhlcmN1bGVhbiBCb29zdCkKICAgICAgICAgICAgICAgIGxldCBzcGluTWFnID0gcmF3SW50ZW5zaXR5ICogKFRDLkNVUlZFX1NQSU5fU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fU0NBTEUgOiAxMDAwLjApOwoKICAgICAgICAgICAgICAgIC8vIDIuIFNwZWVkIEJvbnVzIChRdWlja25lc3MgYWRkcyBSUE0pCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEJvbnVzID0gTWF0aC5tYXgoMS4wLCBzd2lwZVNwZWVkICogKFRDLkNVUlZFX1NQRUVEX01VTFQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQRUVEX01VTFQgOiAxLjUpKTsKICAgICAgICAgICAgICAgIHNwaW5NYWcgKj0gc3BlZWRCb251czsKCiAgICAgICAgICAgICAgICAvLyBDYXAgKEluY3JlYXNlZCB0byAxNTAwIGZvciBtYXNzaXZlIGFyY3MpCiAgICAgICAgICAgICAgICBzcGluTWFnID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX0NBUCA6IDE1MDAuMCksIHNwaW5NYWcpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4KICAgICAgICAgICAgICAgIC8vIFJpZ2h0IEh1bXAgKFBvc2l0aXZlIEludGVuc2l0eSkgLT4gTGVmdCBDdXJ2ZSAoUG9zaXRpdmUgU3BpbiBZKQogICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5NYWcgKiBzaWduLCAwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBpZiAoaXNMb2IpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnTE9CJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkb3RHb2FsID4gMC44ICYmIGRpc3RUb0dvYWwgPCAzNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21hcnQgUGFzcyBPdmVycmlkZQogICAgICAgICAgICBjb25zdCB0YXJnZXRNYXRlID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltVmVjKTsKICAgICAgICAgICAgaWYgKHRhcmdldE1hdGUgJiYgdHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdE1hdGUgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RNYXRlIDwgMTIuMCkgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIH0KCmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBORVc6IENoYXJnZSBVSSBtZXRob2RzCiAgICAgICAgX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKSB7CiAgICAgICAgICAgIGNvbnN0IG1ldGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1maWxsJyk7CiAgICAgICAgICAgIGlmIChtZXRlcikgewogICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUud2lkdGggPSBgJHtyYXRpbyAqIDEwMH0lYDsKICAgICAgICAgICAgICAgIGlmIChyYXRpbyA+IDAuOSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmYwLCAjZjgwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhdGlvID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwZjAsICNmZjApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZUNoYXJnZVVJKCkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyKSBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgogICAgICAgIHNldE92ZXJyaWRlQWltKHgsIHopIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci5zZXQoeCwgMCwgeikubm9ybWFsaXplKCk7CiAgICAgICAgfQoKbG9zZUJhbGwoY29vbGRvd24gPSAxLjApIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5mb3JjZSBjb29sZG93biB0byBwcmV2ZW50IGluc3RhbnQgcmUtZ3JhYgogICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gPSBjb29sZG93bjsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9Cgp1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTYWZldHk6IE5hTiBDaGVjawogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGxheWVyIHBvc2l0aW9uIE5hTiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIsIHRoaXMucm9sZSk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uY29weSh0aGlzLmhvbWVQb3NpdGlvbiB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgTG9naWMgKFBoeXNpY3MgcGFydCAtIFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHBoeXNpY3MgcHJvcHMgdGhhdCBtaWdodCBoYXZlIGJlZW4gYWx0ZXJlZAogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCByZXNldCBoYXBwZW5zIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIC8vIEFVVE8tUkVMRUFTRTogSWYgaGVsZCB0b28gbG9uZyAoM3MpLCBmb3JjZSByZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgppZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlQ29vbGRvd24gPiAwKSB0aGlzLmV2YWRlQ29vbGRvd24gLT0gZHQ7CgogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXZhc2lvbiBMb2dpYyAoU3BpbiBNb3ZlKQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHZpc3VhbCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMsIGJ1dCB3ZSBhcHBseSBtb3ZlbWVudCBoZXJlCiAgICAgICAgICAgICAgICAvLyBGcmljdGlvbmxlc3MgbW92ZW1lbnQgZHVyaW5nIGV2YWRlCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbGlnaHQgZHJhZwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk1KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5ldmFkZVRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjUpOyAvLyBTbG93IGRvd24gYWZ0ZXIgc3BpbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIG5vcm1hbCBwaHlzaWNzCiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVDaGFyZ2VUaW1lICs9IGR0OwogICAgICAgICAgICAgICAgLy8gQXV0by1yZWxlYXNlIGlmIGhlbGQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPiB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgKyAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBUQUNLTEUgU1RBVEUgKFNsaWRlICYgQ29tbWl0KSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzOiBIaWdoIERyYWcgKFNsaWRlIHRvIHN0b3ApCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgzLjAgKiBkdCkpKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgLy8gQ29sbGlzaW9uIENoZWNrCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjI7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS4yOyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCksIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwgbW9tZW50dW1TY2FsZTogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBMZWFuIGZvciBEYXNoCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDAsIHlhdyA9IDAsIHJvbGwgPSAwLCBsdW5nZUFtdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgIT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IHlhdyA9IDAuOCAqIGxlYW47IHJvbGwgPSAtMC42ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCBsdW5nZUFtdCkuYXBwbHlRdWF0ZXJuaW9uKF9wUXVhdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc0V2YWRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJhcGlkIFNwaW4KICAgICAgICAgICAgICAgIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IDI1LjAgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVHJhaWwKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCktMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjAsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCi8vIFRhY2tsZSBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMudGFja2xlQ2hhcmdlVGltZSAvIHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgIC8vIFNoYWtlIG1lc2gKLy8gUmVkIHRpbnQgcHVsc2UKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4ZmYwMDAwKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gSEVSQ1VMRUFOOiBHYXRoZXIgUGFydGljbGVzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuMykgeyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gaW4gYSBzcGhlcmUgYXJvdW5kIHBsYXllcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aGV0YSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gTWF0aC5hY29zKDIgKiBNYXRoLnJhbmRvbSgpIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguY29zKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IHIgKiBNYXRoLnNpbihwaGkpICogTWF0aC5zaW4odGhldGEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gciAqIE1hdGguY29zKHBoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMyh4LCB5ICsgMS4wLCB6KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlclBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjAsIDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IHRvd2FyZHMgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGNlbnRlclBvcy5zdWIoc3Bhd25Qb3MpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKDQuMCk7IC8vIFN1Y2sgaW4gc3BlZWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdnYXRoZXInLCBzcGF3blBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCB0cmFpbCBmb3IgdGFja2xlIChUaGUgTHVuZ2UpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNCbG9ja2luZykgewogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNUYWNrbGluZykgewogICAgICAgICAgICAgICAgLy8gVmlzdWFsIHRyYWlsIGZvciB0YWNrbGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMiB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAxKSAqIDAuMyArIDAuNzsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZiksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgIC8vIFJlc2V0IGNvbG9yIGlmIG5vdCBjaGFyZ2luZy9kYXNoaW5nL2ZsYXNoaW5nL2Jsb2NraW5nCiAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcihkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CgogICAgICAgICAgICAvLyBCdWJibGUgVHJhaWwKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgIG9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4yCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSB0aGlzLnN0YXR1cy5ibGluZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB0aGlzLnN0YXR1cy5zaWxlbmNlIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hpZWxkID4gMCkgdGhpcy5zdGF0dXMuc2hpZWxkIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB0aGlzLnN0YXR1cy5oYXN0ZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB0aGlzLnN0YXR1cy5zbG93IC09IGR0Owp9CgogICAgICAgIF91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy52ZW5vbSA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSBpc1dpdGhlcmluZyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyID0gMC4yOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNpbGVuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3NpbGVuY2UnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNpbGVuY2UgPSAwLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSB8fCAwKSAtIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignaGFzdGUnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLmhhc3RlID0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Nsb3cnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgPSAwLjQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIDEuIEZMQVNIIEVGRkVDVCAtLS0KICAgICAgICAgICAgbGV0IGZsYXNoUmF0aW8gPSAwOwogICAgICAgICAgICBpZiAodGhpcy5mbGFzaFRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHBhc3NlZCBkdCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBhc3N1bWUgMTZtcyAoc2FmZXR5KQogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIHRoaXMuZmxhc2hUaW1lciAtPSBkZWx0YTsKICAgICAgICAgICAgICAgIGZsYXNoUmF0aW8gPSBNYXRoLm1heCgwLCB0aGlzLmZsYXNoVGltZXIgLyB0aGlzLmZsYXNoRHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgaWYgKGZsYXNoUmF0aW8gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCB0b3dhcmRzIGZsYXNoIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIHRoaXMuZmxhc2hDb2xvciwgZmxhc2hSYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAtLS0gMi4gUFJPQ0VEVVJBTCBTUVVBU0ggJiBTVFJFVENIIChTcHJpbmcgUGh5c2ljcykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gZHQgfHwgMC4wMTY7CiAgICAgICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAyMDAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IGRhbXBpbmcgPSAxNS4wOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gMS4wOwoKICAgICAgICAgICAgICAgIC8vIFggQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VYID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC54KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCArPSBmb3JjZVggKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnggKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS54ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gWSBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVkgPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLnkpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICs9IGZvcmNlWSAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueSArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBaIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWiA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueikgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKz0gZm9yY2VaICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnogKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC56ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIE1lc2ggU2NhbGUgKE11bHRpcGxpY2F0aXZlIHdpdGggYmFzZVNjYWxlKQogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC54LAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLnksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2guegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZmxhc2goY29sb3JIZXgsIGR1cmF0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuZmxhc2hDb2xvci5zZXRIZXgoY29sb3JIZXgpOwogICAgICAgICAgICB0aGlzLmZsYXNoRHVyYXRpb24gPSBkdXJhdGlvbjsKICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gZHVyYXRpb247CiAgICAgICAgfQoKICAgICAgICBzcXVhc2goeCwgeSwgeikgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2guc2V0KHgsIHksIHopOwogICAgICAgICAgICAvLyBSZXNldCB2ZWxvY2l0eSBmb3Igc25hcCBmZWVsCiAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IgKEVuaGFuY2VkIFJldGljbGUpCiAgICAgICAgX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gMS4gR3JvdW5kIFJldGljbGUgKFJvdGF0aW5nKQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBfcmV0aWNsZVRleHR1cmUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZjAwIC8vIEdyZWVuIGZvciBwYXNzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgzLjAsIDMuMCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVNZXNoKTsKCiAgICAgICAgICAgIC8vIDIuIFZlcnRpY2FsIFBpbGxhciAoTGlnaHQgU2hhZnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEuMCwgMS4wLCA2LCAxNiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGZmNDQsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMTUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucG9zaXRpb24ueSA9IDMuMDsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVQaWxsYXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gRmxvYXRpbmcgSWNvbiAoQWJvdmUgSGVhZCkKICAgICAgICAgICAgY29uc3QgaWNvbkdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMCwgMS4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbiA9IG5ldyBUSFJFRS5NZXNoKGljb25HZW8sIG1hdCk7IC8vIFJldXNlIHRleHR1cmUKICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5wb3NpdGlvbi55ID0gNC41OwogICAgICAgICAgICAvLyBCaWxsYm9hcmQgYmVoYXZpb3IgaGFuZGxlZCBpbiB1cGRhdGUKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLmFkZCh0aGlzLnJldGljbGVJY29uKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgIXRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbmQgYmVzdCBwYXNzIHRhcmdldAogICAgICAgICAgICBjb25zdCBhaW1EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1EaXIpOwoKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RobHkgbW92ZSB0byB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IGRlc3QgPSB0YXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBkaXN0YW5jZSBpcyBsYXJnZSAoc3dpdGNoZWQgdGFyZ2V0KSwgc25hcC4gRWxzZSBsZXJwLgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uZGlzdGFuY2VUbyhkZXN0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24uY29weShkZXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ubGVycChkZXN0LCAwLjMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBLZWVwIFkgYXQgZ3JvdW5kIGxldmVsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjA1OwoKICAgICAgICAgICAgICAgICAgICAvLyBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNwaW4gZ3JvdW5kIHJldGljbGUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnJvdGF0aW9uLnogPSAtdGltZSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKHRpbWUgKiA1LjApICogMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVNZXNoLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUHVsc2UgcGlsbGFyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmV0aWNsZVBpbGxhcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIubWF0ZXJpYWwub3BhY2l0eSA9IDAuMSArIE1hdGguc2luKHRpbWUgKiA4LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlUGlsbGFyLnJvdGF0aW9uLnkgPSB0aW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQmlsbGJvYXJkIEljb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlSWNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZUljb24ucm90YXRpb24ueiA9IHRpbWUgKiAzLjA7IC8vIFNwaW4gaWNvbgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2FwcGx5U29mdENvbGxpc2lvbihkdCkgewogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCAhZ2FtZSB8fCAhZ2FtZS50ZWFtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwogICAgICAgICAgICBjb25zdCByZXB1bHNpb25SYWRpdXMgPSAwLjU7IC8vIFJlZHVjZWQgdG8gMC41IHRvIGZpeCBpbnZpc2libGUgd2FsbCBpc3N1ZXMKICAgICAgICAgICAgY29uc3Qgc3RpZmZuZXNzID0gMTUuMDsKCiAgICAgICAgICAgIHRlYW1zLmZvckVhY2godGVhbSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKG90aGVyID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3RoZXIgPT09IHRoaXMgfHwgIW90aGVyLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIG90aGVyLm1lc2gucG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeSA9IHRoaXMubWVzaC5wb3NpdGlvbi55IC0gb3RoZXIubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBvdGhlci5tZXNoLnBvc2l0aW9uLno7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHkqZHkgKyBkeipkejsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtaW5EaXN0ID0gcmVwdWxzaW9uUmFkaXVzICogMi4wOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgbWluRGlzdCAqIG1pbkRpc3QgJiYgZGlzdFNxID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IG1pbkRpc3QgLSBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBvdmVybGFwICogc3RpZmZuZXNzOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnggPSBkeCAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG55ID0gZHkgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueiA9IGR6IC8gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBueCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBueSAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IGlzSW5wdXRBY3RpdmUgPSBpbnB1dExlblNxID4gMC4wMTsKCiAgICAgICAgICAgIGxldCBjdXJyZW50TWF4U3BlZWQgPSB0aGlzLm1heFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU1RSVUdHTEUgU1RBVEU6IEhpbmRlciBtb3ZlbWVudCBiYXNlZCBvbiBwcmVzc3VyZQogICAgICAgICAgICAvLyBJbnN0ZWFkIG9mIGEgYmluYXJ5IDAuOCBtdWx0aXBsaWVyLCB3ZSBzY2FsZSBiYXNlZCBvbiBpbnRlbnNpdHkuCiAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSAoMS4wKSByZWR1Y2VzIHNwZWVkIHRvIDQwJS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gKDEuMCAtICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC42KSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHNsaWdodCByZWR1Y3Rpb24gaWYgZW5nYWdlZCBidXQgbG93IHByZXNzdXJlCiAgICAgICAgICAgICAgICBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuaXNUYWNrbGVDaGFyZ2luZyB8fCB0aGlzLmlzQmxvY2tpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjQ7IC8vIFNsb3cgZG93biB3aGVuIGNoYXJnaW5nL2Jsb2NraW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYXN0ZSAvIFNsb3cKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgY3VycmVudE1heFNwZWVkICo9IDEuNTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSBjdXJyZW50TWF4U3BlZWQgKj0gMC41OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3RydWdnbGUgSml0dGVyIHRvIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHdyZXN0bGluZyBmb3IgY29udHJvbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ICogMC44OwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnggKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnogKz0gaml0dGVyOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFggPSBfcFZlYy54ICogY3VycmVudE1heFNwZWVkOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWiA9IF9wVmVjLnogKiBjdXJyZW50TWF4U3BlZWQ7CgogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIGN1cnJlbnRTcGVlZCAvIHRoaXMubWF4U3BlZWQpOwoKICAgICAgICAgICAgICAgIC8vIEFnaWxpdHkgaXMgcmVkdWNlZCB3aGVuIHN0cnVnZ2xpbmcKICAgICAgICAgICAgICAgIGxldCBhZ2lsaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMTAuMCwgMi4wLCBzcGVlZFJhdGlvKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgYWdpbGl0eSAqPSAwLjU7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSk7CgogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgfQoKX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwogICAgICAgIF91cGRhdGVCYW5raW5nKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGlucHV0TGVuU3EgPSB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGNvbnN0IHZlbExlblNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgbGV0IHRhcmdldFlhdyA9IHRoaXMudGFyZ2V0WWF3OwogICAgICAgICAgICBsZXQgc2hvdWxkVXBkYXRlWWF3ID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQUklPUklUWSAxOiBFeHBsaWNpdCBBaW0gKEFpbSBTdGljayAvIFN3aXBlKQogICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLm92ZXJyaWRlQWltVmVjdG9yLngsIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDI6IE1vdmVtZW50IElucHV0CiAgICAgICAgICAgIGVsc2UgaWYgKGlucHV0TGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLmlucHV0VmVjdG9yLngsIHRoaXMuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQUklPUklUWSAzOiBWZWxvY2l0eSAoRHJpZnRpbmcpCiAgICAgICAgICAgIGVsc2UgaWYgKHZlbExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS54LCB0aGlzLnZlbG9jaXR5LnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgd2Ugc2hvdWxkIHVwZGF0ZSwgZG8gc28uIE90aGVyd2lzZSBrZWVwIGxhc3QgdmFsaWQgeWF3CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGVZYXcpIHsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGFyZ2V0WWF3OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gdGhpcy5sYXN0VmFsaWRZYXc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtb290aCBZYXcgd2l0aCB3cmFwLWFyb3VuZCBoYW5kbGluZwogICAgICAgICAgICBsZXQgZGlmZiA9IHRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgdGhpcy52ZWxvY2l0eS5sZW5ndGgoKSAvIHRoaXMubWF4U3BlZWQpOwogICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSBUSFJFRS5NYXRoVXRpbHMubGVycCg4LjAsIDQuMCwgc3BlZWRSYXRpbyk7IC8vIFJlZHVjZWQgZnJvbSAxMi4wLzYuMCB0byByZWR1Y2UgZmxpcHBpbmcKCiAgICAgICAgICAgIC8vIFByZXZlbnQgc3VkZGVuIHNuYXBzIHdoZW4gZGlmZiBpcyB2ZXJ5IGxhcmdlICh0ZWxlcG9ydC9yZXNldCBzY2VuYXJpb3MpCiAgICAgICAgICAgIGNvbnN0IG1heFlhd0NoYW5nZSA9IE1hdGguUEkgKiBkdCAqIHR1cm5TcGVlZDsKICAgICAgICAgICAgY29uc3QgeWF3Q2hhbmdlID0gTWF0aC5tYXgoLW1heFlhd0NoYW5nZSwgTWF0aC5taW4obWF4WWF3Q2hhbmdlLCBkaWZmICogZHQgKiB0dXJuU3BlZWQpKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSB5YXdDaGFuZ2U7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGFyZ2V0WWF3OwoKICAgICAgICAgICAgLy8gQmFua2luZwogICAgICAgICAgICBjb25zdCBiYW5rU2Vuc2l0aXZpdHkgPSAwLjg7CiAgICAgICAgICAgIGNvbnN0IG1heEJhbmsgPSAwLjc1OwoKICAgICAgICAgICAgbGV0IHRhcmdldEJhbmsgPSAtZGlmZiAqIGJhbmtTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0QmFuayA9IE1hdGgubWF4KC1tYXhCYW5rLCBNYXRoLm1pbihtYXhCYW5rLCB0YXJnZXRCYW5rKSk7CgogICAgICAgICAgICBjb25zdCBiYW5rTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDIsIGR0KTsKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9ICh0YXJnZXRCYW5rIC0gdGhpcy5iYW5raW5nQW1vdW50KSAqIGJhbmtMZXJwOwoKICAgICAgICAgICAgLy8gUGl0Y2gKICAgICAgICAgICAgY29uc3QgcGl0Y2hTZW5zaXRpdml0eSA9IDAuMTsKICAgICAgICAgICAgY29uc3QgbWF4UGl0Y2ggPSAxLjA7CgogICAgICAgICAgICBsZXQgdGFyZ2V0UGl0Y2ggPSAtdGhpcy52ZWxvY2l0eS55ICogcGl0Y2hTZW5zaXRpdml0eTsKICAgICAgICAgICAgdGFyZ2V0UGl0Y2ggPSBNYXRoLm1heCgtbWF4UGl0Y2gsIE1hdGgubWluKG1heFBpdGNoLCB0YXJnZXRQaXRjaCkpOwoKICAgICAgICAgICAgY29uc3QgcGl0Y2hMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wNSwgZHQpOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9ICh0YXJnZXRQaXRjaCAtIHRoaXMucGl0Y2hBbW91bnQpICogcGl0Y2hMZXJwOwoKICAgICAgICAgICAgLy8gQXBwbHkgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxZYXcgPSB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0OwoKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCBmaW5hbFlhdyk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKSwgdGhpcy5waXRjaEFtb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKSwgdGhpcy5iYW5raW5nQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIC8vIElkbGUgQm9iCiAgICAgICAgICAgIGlmICh2ZWxMZW5TcSA8IDAuMSAmJiAhdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE1OwogICAgICAgICAgICAgICAgY29uc3QgYm9iUGl0Y2ggPSBNYXRoLnNpbih0aW1lKSAqIDAuMDM7CiAgICAgICAgICAgICAgICBjb25zdCBib2JSb2xsID0gTWF0aC5jb3ModGltZSAqIDAuNykgKiAwLjAyOwoKICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tUYWNrbGVQcmVzc3VyZShkdCkgewogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zIHx8ICF0aGlzLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRvdGFsUHJlc3N1cmUgPSAwOwogICAgICAgICAgICBsZXQgZW5nYWdlZENvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy50YWNrbGVSYWRpdXM7IAoKICAgICAgICAgICAgLy8gRm9yd2FyZCB2ZWN0b3IgZm9yIHNoaWVsZGluZyBjaGVjawogICAgICAgICAgICBfcFZlYy5jb3B5KF9wQXhpc1opLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZWZmZWN0aXZlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgZW5nYWdlZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eSAoMCB0byAxIGJhc2VkIG9uIGRpc3RhbmNlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3hpbWl0eSA9IDEuMCAtIChkaXN0IC8gZWZmZWN0aXZlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIFByZXNzdXJlIGZyb20gQVQgc3RhdAogICAgICAgICAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IGVudGl0eS5nZXRTdGF0KCdBVCcpICogcHJveGltaXR5OwoKICAgICAgICAgICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcgKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBlbnRpdHkubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgb3Bwb25lbnQgaXMgQkVISU5EIChkb3QgPCAtMC4yKSwgcHJlc3N1cmUgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKQogICAgICAgICAgICAgICAgICAgIGxldCBpc1NoaWVsZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBpc1NoaWVsZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFRlY2ggTW9kaWZpZXJzIChDb250aW51b3VzIGFwcGxpY2F0aW9uIGNoYW5jZSkKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogMC41KSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDUuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDUuMCwgJ0VOJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICo9IDEuMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVudGl0eS50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZHJhaW5BbXQgPSBwcmVzc3VyZSAqIGR0ICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRyYWluQW10OwogICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuc3RhdHMuSFAgKz0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0b3RhbFByZXNzdXJlICs9IHByZXNzdXJlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBTcGFya3Mgb2NjYXNpb25hbGx5IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDQuMCAqIHByb3hpbWl0eSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAoZW50aXR5Lm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnNwYXduQ2xhc2gobWlkLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IChlbmdhZ2VkQ291bnQgPiAwKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFTiBEcmFpbiAoQ29udGludW91cykKICAgICAgICAgICAgICAgIC8vIFNjYWxpbmc6IDIwIEFUIHByZXNzdXJlIC0+IGFwcHJveCAxMCBFTiBsb3N0IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWluUmF0ZSA9IHRvdGFsUHJlc3N1cmUgKiAwLjU7IAogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTdHJ1Z2dsZSBJbnRlbnNpdHkgZm9yIFBoeXNpY3MgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgYXQgcm91Z2hseSAzMCBwcmVzc3VyZQogICAgICAgICAgICAgICAgdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA9IE1hdGgubWluKDEuMCwgdG90YWxQcmVzc3VyZSAvIDMwLjApOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgRHJhaW4gKEFjY3VtdWxhdGUgdG8gYXZvaWQgc3BhbSkKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlICs9IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHtNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlKX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBIaW50IGZvciBwbGF5ZXIgaWYgZW5nYWdlZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW5jb3VudGVyVGltZXIgPiAxLjAgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA8IDEuMSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3BlcmZvcm1KZWNodEtub2NrYmFjaygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2LjA7CiAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gMjUuMDsKCiAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkpFQ0hUIFNIT1QhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYW5nZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQoZGlyLm11bHRpcGx5U2NhbGFyKGZvcmNlKSk7CgogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOyAvLyBFbnN1cmUgdGhleSBzdGF5IGRvd24KICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWN0QWN0aW9uID0gcC5hY3Rpb25zICYmIHAuYWN0aW9uc1sncmVhY3QnXTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVhY3RBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb3NlQmFsbCgpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX3BWZWMubXVsdGlwbHlTY2FsYXIoMTAuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wIGZvciByZWFsaXNtCgogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgICAgICBvcHBvbmVudFRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5hZGQocHVzaERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuMik7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVFVOISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZSBCdXJzdCAoQnJlYWsgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgKE1hdGgucmFuZG9tKCktMC41KSoyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgLy8gSG9sb2dyYXBoaWMgSFAgQmFyIFNoYWRlciB3aXRoIEp1aWNlIChTaGFrZSAmIEZsYXNoKQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuNCwgMC4xOCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVGaWxsOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmYwMCkgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuOSB9LAogICAgICAgICAgICAgICAgICAgIHVTaGFrZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUZsYXNoOiB7IHZhbHVlOiAwLjAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IFNoYWtlIEVmZmVjdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodVNoYWtlID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSBzaW4odCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBjb3ModCAqIDAuOCkgKiB1U2hha2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZpbGw7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1Rmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGcmFtZSBkaW1lbnNpb25zIChVViBzcGFjZSkKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9yZGVyWSA9IDAuMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclggPSAwLjAyOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5uZXIgY29udGVudCBtYXNrCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWSA9IHN0ZXAoYm9yZGVyWSwgdlV2LnkpICogc3RlcCh2VXYueSwgMS4wIC0gYm9yZGVyWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGluWCA9IHN0ZXAoYm9yZGVyWCwgdlV2LngpICogc3RlcCh2VXYueCwgMS4wIC0gYm9yZGVyWCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGNvbnRlbnRNYXNrID0gaW5ZICogaW5YOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFja2dyb3VuZCAoVGVjaCBHcmlkKQogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJnQ29sID0gdmVjMygwLjAsIDAuMSwgMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JpZCA9IHN0ZXAoMC45LCBmcmFjdCh2VXYueCAqIDIwLjAgKyB2VXYueSAqIDEwLjApKSAqIDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgYmdDb2wgKz0gZ3JpZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbGwgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmlsbE1hc2sgPSBzdGVwKHZVdi54LCB1RmlsbCkgKiBjb250ZW50TWFzazsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuZXJneSBQdWxzZSBQYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gc2luKHZVdi54ICogMTAuMCAtIHVUaW1lICogMy4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiYXJDb2wgPSBtaXgodUNvbG9yLCB1Q29sb3IgKyB2ZWMzKDAuNCksIHB1bHNlICogMC42KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvdCBFZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBzbW9vdGhzdGVwKHVGaWxsIC0gMC4wNSwgdUZpbGwsIHZVdi54KSAqIGZpbGxNYXNrOwogICAgICAgICAgICAgICAgICAgICAgICBiYXJDb2wgKz0gdmVjMygxLjApICogZWRnZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNjYW5saW5lIChIb2xvZ3JhbSBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odlV2LnkgKiA4MC4wICsgdVRpbWUgKiA1LjApICogMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvcmRlciBHbG93CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlck1hc2sgPSAoMS4wIC0gY29udGVudE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGJvcmRlckNvbCA9IHZlYzMoMC4wLCAwLjYsIDEuMCkgKiAwLjY7IC8vIEN5YW4gdGVjaCBib3JkZXIKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IG1peChiZ0NvbCwgYmFyQ29sLCBmaWxsTWFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCBib3JkZXJDb2wsIGJvcmRlck1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVpY2U6IEZsYXNoIChEYW1hZ2UvSW1wYWN0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodUZsYXNoID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sID0gbWl4KGZpbmFsQ29sLCB2ZWMzKDEuMCwgMS4wLCAxLjApLCB1Rmxhc2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFja2dyb3VuZCBhcmVhcyBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbE1hc2sgPCAwLjUgJiYgYm9yZGVyTWFzayA8IDAuNSkgYWxwaGEgKj0gMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChmaW5hbENvbCwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsIC8vIFJlbmRlciBvbiB0b3AKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucmVuZGVyT3JkZXIgPSA5MDA7IC8vIEVuc3VyZSBpdCByZW5kZXJzIGFib3ZlIG1vc3QgdGhpbmdzCiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuaHBCYXIpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhQQmFyKGR0ID0gMC4wMTYpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFZpc2liaWxpdHkgQ2hlY2s6IE9ubHkgc2hvdyBpZiBtZXNoIGlzIHZpc2libGUgQU5EIGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRTdGF0ZSA9IGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuc3RhdGUgPT09ICdraWNrb2ZmJyB8fCBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBKVUlDRTogRGFtYWdlIFJlYWN0aW9uIC0tLQogICAgICAgICAgICAvLyBJbml0aWFsaXplIF9sYXN0SFAgaWYgdW5kZWZpbmVkIChmaXJzdCBydW4pCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXN0SFAgPT09IHVuZGVmaW5lZCkgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIGNvbnN0IGRlbHRhID0gdGhpcy5fbGFzdEhQIC0gdGhpcy5zdGF0cy5IUDsKICAgICAgICAgICAgaWYgKGRlbHRhID4gMC4xKSB7CiAgICAgICAgICAgICAgICAvLyBIUCBEZWNyZWFzZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcgfHwgdGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVm9sdW50YXJ5IGV4ZXJ0aW9uIChBYmlsaXR5IGNvc3QpIC0+IFNtYWxsIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gTWF0aC5taW4odGhpcy5ocEZsYXNoICsgMC40LCAwLjYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnZvbHVudGFyeSBkYW1hZ2UgKFZlbm9tLCBEcmFpbiwgZXRjKSAtPiBTaGFrZSArIEZsYXNoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gTWF0aC5taW4odGhpcy5ocFNoYWtlICsgMC4wNSwgMC4xNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2xhc3RIUCA9IHRoaXMuc3RhdHMuSFA7CgogICAgICAgICAgICAvLyBEZWNheSBGWAogICAgICAgICAgICB0aGlzLmhwU2hha2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA4LjApOwogICAgICAgICAgICB0aGlzLmhwRmxhc2ggKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA1LjApOwoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFNoYWRlciBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLmhwQmFyLm1hdGVyaWFsOwogICAgICAgICAgICBpZiAobWF0LnVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZpbGwudmFsdWUgPSBwY3Q7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudVNoYWtlLnZhbHVlID0gdGhpcy5ocFNoYWtlOwogICAgICAgICAgICAgICAgbWF0LnVuaWZvcm1zLnVGbGFzaC52YWx1ZSA9IHRoaXMuaHBGbGFzaDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY29sID0gbWF0LnVuaWZvcm1zLnVDb2xvci52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIGNvbC5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgY29sLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGNvbC5zZXRIZXgoMHhmZjAwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIaWRlIGlmIGZ1bGwgSFAgdG8gcmVkdWNlIGNsdXR0ZXIsIHVubGVzcyBpbiBwcmFjdGljZSBtb2RlCiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IChwY3QgPCAwLjk4IHx8IGFsd2F5c1Nob3cgfHwgdGhpcy5ocEZsYXNoID4gMC4xKTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IGFzIHRhY2tsZSBkaXJlY3Rpb24gKHNpbmNlIHRhY2tsZSBpbXBhcnRzIHZlbG9jaXR5KQogICAgICAgICAgICAvLyBGYWxsYmFjayB0byBmYWNpbmcgaWYgdmVsb2NpdHkgaXMgbmVnbGlnaWJsZQogICAgICAgICAgICBsZXQgdGFja2xlRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICB0YWNrbGVEaXIueSA9IDA7CiAgICAgICAgICAgIGlmICh0YWNrbGVEaXIubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgdGFja2xlRGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhY2tsZURpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcG9uZW50VGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIHRvIG9wcG9uZW50CiAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0b09wcC55ID0gMDsgLy8gSWdub3JlIGhlaWdodCBkaWZmZXJlbmNlIGZvciBoaXQgZGV0ZWN0aW9uIGN5bGluZGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b09wcC5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlYWNoID0gMy41OyAvLyBEZXRlY3Rpb24gcmFkaXVzCgogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByZWFjaCkgewogICAgICAgICAgICAgICAgICAgIHRvT3BwLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IHRhY2tsZURpci5kb3QodG9PcHApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbmUgQ2hlY2s6IH40NSBkZWdyZWVzIChkb3QgPiAwLjcpCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyByZXF1aXJlcyB0aGUgcGxheWVyIHRvIGFjdHVhbGx5IGFpbSB0aGUgdGFja2xlCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC43KSAvIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydFRhY2tsZShkeCwgZHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLmlzRGFzaGluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY29zdCA9IDE1OwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwoKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOw==","main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CgogICAgbGV0IF9hdWRpb01hbmFnZXI7CiAgICBsZXQgX3Bvc3RQcm9jZXNzaW5nOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBEZWJ1ZyBJTyBCcmlkZ2UgKGV4cG9zZWQgZm9yIERldlRvb2xzIEpTT04gc25hcHNob3RzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBfZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICBfZGVidWdJTy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgIF9kZWJ1Z0lPLmlucHV0ID0gX2RlYnVnSU8uaW5wdXQgfHwge307CiAgICBfZGVidWdJTy5wZXJmID0gX2RlYnVnSU8ucGVyZiB8fCB7IGZyYW1lOiAwLCByYXdEdDogMCwgZHQ6IDAsIGZwczogMCwgYXZnRnBzOiAwIH07CgoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gVG91Y2ggaGVscGVycyAobXVsdGktdG91Y2ggc2FmZSkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgZnVuY3Rpb24gX2ZpbmRUb3VjaEJ5SWQodG91Y2hMaXN0LCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIXRvdWNoTGlzdCkgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3VjaExpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IHRvdWNoTGlzdFtpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIF9lbmRlZFRvdWNoQnlJZChjaGFuZ2VkVG91Y2hlcywgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCFjaGFuZ2VkVG91Y2hlcykgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gY2hhbmdlZFRvdWNoZXNbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgICBfY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CgogICAgICAgIC8vIDEuIFNjZW5lCiAgICAgICAgX3NjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7CiAgICAgICAgX3NjZW5lLmJhY2tncm91bmQgPSBuZXcgVEhSRUUuQ29sb3IoX2NvbmZpZy5iZ0NvbG9yKTsKICAgICAgICBfc2NlbmUuZm9nID0gbmV3IFRIUkVFLkZvZ0V4cDIoX2NvbmZpZy5mb2dDb2xvciwgX2NvbmZpZy5mb2dEZW5zaXR5KTsKCiAgICAgICAgLy8gMi4gQ2FtZXJhCiAgICAgICAgY29uc3QgYXNwZWN0ID0gX2NvbmZpZy5pbnRlcm5hbFdpZHRoIC8gX2NvbmZpZy5pbnRlcm5hbEhlaWdodDsKX2NhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg2NSwgYXNwZWN0LCAwLjEsIDUwMCk7Cl9jYW1lcmEucG9zaXRpb24uc2V0KDAsIDEwLCAxNSk7CiAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgX3NjZW5lLmFkZChfY2FtZXJhKTsgLy8gRW5zdXJlIGNhbWVyYSBpcyBpbiBzY2VuZSBmb3IgY2hpbGRyZW4gdG8gcmVuZGVyCgogICAgICAgIC8vIDMuIFJlbmRlcmVyCi8vIDMuIFJlbmRlcmVyCiAgICAgICAgX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoewogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAplbHNlIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHsgcmVuZGVyZXI6IF9yZW5kZXJlciwgZW50aXRpZXM6IHt9LCB0ZWFtczogeyBob21lOiBudWxsLCBhd2F5OiBudWxsIH0gfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0gX2dhbWVNYW5hZ2VyOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwpfZ2FtZU1hbmFnZXIuYXVkaW9NYW5hZ2VyID0gX2F1ZGlvTWFuYWdlcjsKCiAgICAgICAgLy8gNS41LjIgUG9zdCBQcm9jZXNzaW5nCl9wb3N0UHJvY2Vzc2luZyA9IG5ldyB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyhfcmVuZGVyZXIsIF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLmVuYWJsZWQgPSBmYWxzZTsgLy8gRGlzYWJsZWQgYnkgZGVmYXVsdCBmb3IgcGVyZm9ybWFuY2UKICAgICAgICBfZ2FtZU1hbmFnZXIucG9zdFByb2Nlc3NpbmcgPSBfcG9zdFByb2Nlc3Npbmc7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMjAwOyAvLyBPcHRpbWl6ZWQgZm9yIHBlcmZvcm1hbmNlICh3YXMgMTUwMCkKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgLy8gR3JvdXAgZm9yIHJvdGF0aW9uCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgIF9zY2VuZS5hZGQod2luZG93LmZsdXguYXJlbmFHcm91cCk7CgogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgLy8gLS0tIDEuIEJhc2UgU3BoZXJlIChGYWludCBHcmlkKSAtLS0KICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFyZW5hVGV4LAogICAgICAgICAgICBjb2xvcjogMHg0NDY2ODgsCiAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjE1LCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IGRpc3QgLyByYWRpdXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJ1bGdlID0gKDEuMCAtIHQpICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIG5vcm1hbCA9IG5vcm1hbGl6ZShwb3MpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogKGJ1bGdlICogdUltcGFjdFN0cik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE1hcDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlMkQodE1hcCwgdlV2KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5ICogdGV4Q29sb3IuYTsKICAgICAgICAgICAgICAgICAgICBhbHBoYSArPSB1SW1wYWN0U3RyICogMC4wMjsgCiAgICAgICAgICAgICAgICAgICAgdmVjMyBjb2xvciA9IHRleENvbG9yLnJnYiAqIHZlYzMoMC4yLCAwLjgsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChjb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IGFyZW5hMiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbDIpOwogICAgICAgIGFyZW5hMi5zY2FsZS5zZXRTY2FsYXIoMC45OCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwoKICAgICAgICAvLyAtLS0gMy4gRVFVQVRPUiBCQU5EUyAoQmx1ZSBhbmQgR29sZCAtIHBvc3Nlc3Npb24gYmFzZWQpIC0tLQogICAgICAgIGNvbnN0IGJhbmRUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwoKICAgICAgICAvLyBCbHVlIEJhbmQgKHNob3duIHdoZW4gaG9tZSB0ZWFtIGhhcyBiYWxsKSAtIHRoaW4gYmFuZCwgbm8gdmVydGljYWwgc3RyZXRjaAogICAgICAgIGNvbnN0IGJsdWVCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9TUW5GcERITi9CbHVlLWJhbmQucG5nJyk7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBibHVlQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsgLy8gU2luZ2xlIHdyYXAsIGltYWdlIHRpbGVzIG5hdHVyYWxseQoKICAgICAgICBjb25zdCBibHVlQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogYmx1ZUJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7Ci8vIFRoaW4gYmFuZCAtIGhlaWdodCBvZiAzIHRvIGF2b2lkIHN0cmV0Y2hpbmcKICAgICAgICBjb25zdCBibHVlQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGJsdWVCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGJsdWVCYW5kR2VvLCBibHVlQmFuZE1hdCk7CiAgICAgICAgYmx1ZUJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGJsdWVCYW5kTWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICBfc2NlbmUuYWRkKGJsdWVCYW5kTWVzaCk7CgogICAgICAgIC8vIEdvbGQgQmFuZCAoc2hvd24gd2hlbiBhd2F5IHRlYW0gaGFzIGJhbGwpCiAgICAgICAgY29uc3QgZ29sZEJhbmRUZXggPSBiYW5kVGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL01abjI4ZGdxL0dvbGQtYmFuZC5wbmcnKTsKICAgICAgICBnb2xkQmFuZFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGdvbGRCYW5kVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC5yZXBlYXQuc2V0KDEsIDEpOwoKICAgICAgICBjb25zdCBnb2xkQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogZ29sZEJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CmNvbnN0IGdvbGRCYW5kR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCAzLCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgZ29sZEJhbmRNZXNoID0gbmV3IFRIUkVFLk1lc2goZ29sZEJhbmRHZW8sIGdvbGRCYW5kTWF0KTsKICAgICAgICBnb2xkQmFuZE1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgZ29sZEJhbmRNZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICBfc2NlbmUuYWRkKGdvbGRCYW5kTWVzaCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPSBibHVlQmFuZE1lc2g7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID0gZ29sZEJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0ID0gYmx1ZUJhbmRNYXQ7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNYXQgPSBnb2xkQmFuZE1hdDsKCiAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gPSBmdW5jdGlvbihob21lSGFzQmFsbCkgewogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNZXNoICYmIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSBob21lSGFzQmFsbDsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaC52aXNpYmxlID0gIWhvbWVIYXNCYWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMgPSB7CiAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gLS0tIDQuIFZFUlRJQ0FMIEFSUk9XIFNUUklQUyAoQXJvdW5kIHNwaGVyZSwgYWJvdmUgJiBiZWxvdyBiYW5kKSAtLS0KICAgICAgICBjb25zdCBhcnJvd1RleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgYXJyb3dUZXggPSBhcnJvd1RleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9kUWhQSzRnUS9ZZWxsb3dhcnJvd3MucG5nJyk7CiAgICAgICAgYXJyb3dUZXgud3JhcFMgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGFycm93VGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ3JlYXRlIHZlcnRpY2FsIGFycm93IHN0cmlwcyBhcm91bmQgdGhlIHNwaGVyZSAoY3VydmVkIHRvIG1hdGNoIHNwaGVyZSBzdXJmYWNlKQogICAgICAgIGNvbnN0IGFycm93R3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBjb25zdCBudW1BcnJvd3MgPSAxNjsgICAvLyBOdW1iZXIgb2YgYXJyb3cgc3RyaXBzIGFyb3VuZCBjaXJjdW1mZXJlbmNlCiAgICAgICAgY29uc3QgYXJyb3dIZWlnaHQgPSAzMDsgLy8gSGVpZ2h0IG9mIGVhY2ggYXJyb3cgc3RyaXAKICAgICAgICBjb25zdCBhcnJvd1dpZHRoID0gNjsgICAvLyBXaWR0aCBvZiBlYWNoIHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dSYWRpdXMgPSBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NDsKCiAgICAgICAgY29uc3QgbWFrZUN1cnZlZFN0cmlwID0gKGJhc2VBbmdsZSwgeUNlbnRlciwgZmxpcFYgPSBmYWxzZSkgPT4gewogICAgICAgICAgICAvLyBNb3JlIHNlZ21lbnRzID0gc21vb3RoZXIgY3VydmF0dXJlIChrZWVwIG1vZGVzdCBmb3IgbW9iaWxlKQogICAgICAgICAgICBjb25zdCBzZWdXID0gNjsgICAvLyBjdXJ2YXR1cmUgcmVzb2x1dGlvbiAod2lkdGgpCiAgICAgICAgICAgIGNvbnN0IHNlZ0ggPSAxODsgIC8vIHZlcnRpY2FsIHJlc29sdXRpb24gKGhlaWdodCkKCiAgICAgICAgICAgIC8vIENvbnZlcnQgZGVzaXJlZCB3b3JsZC1zcGFjZSB3aWR0aCBpbnRvIGFuIGFuZ3VsYXIgc3BhbiBvbiB0aGUgc3BoZXJlCiAgICAgICAgICAgIGNvbnN0IHBoaVNwYW4gPSBhcnJvd1dpZHRoIC8gYXJyb3dSYWRpdXM7IC8vIHJhZGlhbnMgKGFwcHJveCBhdCBlcXVhdG9yKQogICAgICAgICAgICBjb25zdCBwaGkwID0gYmFzZUFuZ2xlIC0gcGhpU3BhbiAqIDAuNTsKICAgICAgICAgICAgY29uc3QgcGhpMSA9IGJhc2VBbmdsZSArIHBoaVNwYW4gKiAwLjU7CgogICAgICAgICAgICBjb25zdCB5MCA9IHlDZW50ZXIgLSBhcnJvd0hlaWdodCAqIDAuNTsKICAgICAgICAgICAgY29uc3QgeTEgPSB5Q2VudGVyICsgYXJyb3dIZWlnaHQgKiAwLjU7CgogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICAgICAgY29uc3Qgbm9ybWFscyA9IFtdOwogICAgICAgICAgICBjb25zdCB1dnMgPSBbXTsKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8PSBzZWdIOyBpeSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2ID0gaXkgLyBzZWdIOwogICAgICAgICAgICAgICAgY29uc3QgeSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHkwLCB5MSwgdik7CgogICAgICAgICAgICAgICAgLy8gQ2lyY2xlIHJhZGl1cyBhdCB0aGlzIGhlaWdodCBvbiB0aGUgc3BoZXJlICh4L3ogc2hyaW5rIGFzIHx5fCBncm93cykKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdSID0gTWF0aC5zcXJ0KE1hdGgubWF4KDAuMDAwMDEsIGFycm93UmFkaXVzICogYXJyb3dSYWRpdXMgLSB5ICogeSkpOwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPD0gc2VnVzsgaXgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHUgPSBpeCAvIHNlZ1c7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAocGhpMCwgcGhpMSwgdSk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLnNpbihwaGkpICogcmluZ1I7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguY29zKHBoaSkgKiByaW5nUjsKCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2goeCwgeSwgeik7CgogICAgICAgICAgICAgICAgICAgIC8vIE91dHdhcmQgbm9ybWFsIGZvciBhIHNwaGVyZSBjZW50ZXJlZCBhdCBvcmlnaW4KICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnZMZW4gPSAxLjAgLyBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgICAgICAgICAgICAgICAgICBub3JtYWxzLnB1c2goeCAqIGludkxlbiwgeSAqIGludkxlbiwgeiAqIGludkxlbik7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZ2ID0gZmxpcFYgPyAoMSAtIHYpIDogdjsKICAgICAgICAgICAgICAgICAgICB1dnMucHVzaCh1LCB2dik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHNlZ1cgKyAxOwogICAgICAgICAgICBmb3IgKGxldCBpeSA9IDA7IGl5IDwgc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IHNlZ1c7IGl4KyspIHsKY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGl5ICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYyA9IChpeSArIDEpICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZCA9IChpeSArIDEpICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCA6IC0xOC4wOwoKICAgICAgICAgICAgY29uc3QgZ29hbFNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFIDogNDUuMDsKICAgICAgICAgICAgY29uc3Qgc3ggPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9YIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1opICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWiA6IDEuMDsKICAgICAgICAgICAgCmdvYWxBLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCmdvYWxCLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgZ29hbERpc3QpOwppZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxCLnNjYWxlLnNldChnb2FsU2NhbGUgKiBzeCwgZ29hbFNjYWxlICogc3ksIGdvYWxTY2FsZSAqIHN6KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9Ci8vIE5FVzogVGFja2xlL1NwcmludCBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBPZmZlbnNlOiBTcHJpbnQvQnJlYWsgKEluc3RhbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zZTogU3RhcnQgQ2hhcmdlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5pc1RhY2tsZUNoYXJnaW5nICYmICFwLmlzVGFja2xpbmcgJiYgIXAuaXNSZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBFdmFkZSBvbiAnRScKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0tleUUnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLmV2YWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgCiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IGZhbHNlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5FVzogUmVsZWFzZSBUYWNrbGUgb24gU2hpZnQgVXAKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmIHAuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7IAogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwpjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcyA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGwpIHAudGhyb3dCYWxsKGJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQoKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7Cgpjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gREVGRU5TRTogQmxvY2sKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmICFwLmlzRGFzaGluZyAmJiAhcC5pc0V2YWRpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDAgJiYgcC5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgpsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrOiBJbnB1dCBSaXBwbGUKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQovLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CmhhbmRsZUFpbUVuZCgpOwppZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCi8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKICAgICAgICBsZXQgaG9sZFRpbWVyID0gbnVsbDsKICAgICAgICBsZXQgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IGxhc3RUYXBUaW1lID0gMDsKICAgICAgICBjb25zdCBIT0xEX1RIUkVTSE9MRCA9IDIwMDsgLy8gbXMKICAgICAgICBjb25zdCBET1VCTEVfVEFQX1RIUkVTSE9MRCA9IDMwMDsgLy8gbXMKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgYnViYmxpbmcgdG8gam95c3RpY2sKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjazogSW5wdXQgUmlwcGxlCiAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNsaWVudFggPSBlLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjbGllbnRZID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEhvbGQgU3RhdGUKICAgICAgICAgICAgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChob2xkVGltZXIpIGNsZWFyVGltZW91dChob2xkVGltZXIpOwoKICAgICAgICAgICAgLy8gU3RhcnQgSG9sZCBUaW1lcgogICAgICAgICAgICBob2xkVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBPbmx5IGNoYXJnZSBpZiB3ZSBkb24ndCBoYXZlIHRoZSBiYWxsIChEZWZlbnNpdmUgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOyAvLyBWaXN1YWwgY3VlIGZvciBjaGFyZ2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgSE9MRF9USFJFU0hPTEQpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgaWYgKGlzSG9sZGluZykgewogICAgICAgICAgICAgICAgLy8gLS0tIEhPTEQgUkVMRUFTRSAoQ2hhcmdlZCBUYWNrbGUpIC0tLQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIFRBUCAoVGFja2xlIC8gRXZhZGUpIC0tLQogICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVTaW5jZUxhc3QgPSBub3cgLSBsYXN0VGFwVGltZTsKCiAgICAgICAgICAgICAgICBpZiAodGltZVNpbmNlTGFzdCA8IERPVUJMRV9UQVBfVEhSRVNIT0xEKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIERPVUJMRSBUQVA6IEVWQURFIC0tLQogICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIGNhbmNlbCBkYXNoIGlmIGFjdGl2ZSB0byBhbGxvdyBpbW1lZGlhdGUgZXZhZGUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcgfHwgcC5kYXNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcC5ldmFkZSgpOwogICAgICAgICAgICAgICAgICAgIGxhc3RUYXBUaW1lID0gMDsgLy8gUmVzZXQgdG8gcHJldmVudCB0cmlwbGUtdGFwIGlzc3VlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gU0lOR0xFIFRBUDogVEFDS0xFIC8gQlJFQUsgLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zaXZlIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vdCBtb3ZpbmcsIGRhc2ggZm9yd2FyZCByZWxhdGl2ZSB0byBwbGF5ZXIgZmFjaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChkYXNoWCwgZGFzaFopOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgcC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9mZmVuc2l2ZSBCcmVhayBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGFzdFRhcFRpbWUgPSBub3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoaXNIb2xkaW5nIHx8IGhvbGRUaW1lcikgaGFuZGxlRW5kKGUpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwpfYXVkaW9NYW5hZ2VyLnNldE1hc3RlclZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUlucHV0VmVjdG9yKCkgewogICAgICAgIGxldCB4ID0gX2lucHV0LnggfHwgMDsKICAgICAgICBsZXQgeiA9IF9pbnB1dC55IHx8IDA7CgogICAgICAgIGlmIChfa2V5c1sndyddIHx8IF9rZXlzWydBcnJvd1VwJ10pIHogLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ3MnXSB8fCBfa2V5c1snQXJyb3dEb3duJ10pIHogKz0gMTsKICAgICAgICBpZiAoX2tleXNbJ2EnXSB8fCBfa2V5c1snQXJyb3dMZWZ0J10pIHggLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ2QnXSB8fCBfa2V5c1snQXJyb3dSaWdodCddKSB4ICs9IDE7CgogICAgICAgIGNvbnN0IGxlblNxID0geCp4ICsgeip6OwogICAgICAgIGlmIChsZW5TcSA+IDEpIHsKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KGxlblNxKTsKICAgICAgICAgICAgeCAvPSBsZW47CiAgICAgICAgICAgIHogLz0gbGVuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzTmFOKHgpKSB4ID0gMDsKICAgICAgICBpZiAoaXNOYU4oeikpIHogPSAwOwoKICAgICAgICBpZiAoX2NhbWVyYSkgewogICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwoKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LnNldCgxLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIGxldCB3b3JsZFggPSAoX2NhbUZ3ZC54ICogLXopICsgKF9jYW1SaWdodC54ICogeCk7CiAgICAgICAgbGV0IHdvcmxkWiA9IChfY2FtRndkLnogKiAteikgKyAoX2NhbVJpZ2h0LnogKiB4KTsKCiAgICAgICAgaWYgKGlzTmFOKHdvcmxkWCkgfHwgaXNOYU4od29ybGRaKSkgewogICAgICAgICAgICB3b3JsZFggPSAwOwogICAgICAgICAgICB3b3JsZFogPSAwOwogICAgICAgIH0KCmlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAvLyBGSVg6IE9ubHkgYWxsb3cgbW92ZW1lbnQgaWYgZ2FtZSBpcyBhY3RpdmUgb3IgaW4gcHJhY3RpY2UKICAgICAgICAgICAgY29uc3QgZ20gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGNhbk1vdmUgPSBnbSAmJiAhZ20uaXNEZW1vTW9kZSAmJiAoZ20uc3RhdGUgPT09ICdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChjYW5Nb3ZlKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cn0KCiAgICBmdW5jdGlvbiBjcmVhdGVSaXBwbGUoeCwgeSkgewogICAgICAgIGNvbnN0IHJpcHBsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJpcHBsZS5jbGFzc05hbWUgPSAndG91Y2gtcmlwcGxlJzsKICAgICAgICByaXBwbGUuc3R5bGUubGVmdCA9IGAke3h9cHhgOwogICAgICAgIHJpcHBsZS5zdHlsZS50b3AgPSBgJHt5fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChyaXBwbGUpOwoKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKHJpcHBsZS5wYXJlbnROb2RlKSByaXBwbGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyaXBwbGUpOwogICAgICAgIH0sIDYwMCk7CgogICAgfQoKICAgIC8vIE5FVzogVmlzdWFsIFN3aXBlIFRyYWlsCiAgICBmdW5jdGlvbiBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpIHsKICAgICAgICBjb25zdCBkb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkb3QuY2xhc3NOYW1lID0gJ3N3aXBlLXRyYWlsLWRvdCc7CiAgICAgICAgZG90LnN0eWxlLmxlZnQgPSBgJHt4IC0gNn1weGA7IC8vIENlbnRlciAoMTJweCB3aWR0aCkKICAgICAgICBkb3Quc3R5bGUudG9wID0gYCR7eSAtIDZ9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgCiAgICAgICAgLy8gQ1NTIGFuaW1hdGlvbiBoYW5kbGVzIHJlbW92YWwsIGJ1dCB3ZSBjbGVhbiB1cCBET00gdG8gYmUgc2FmZQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoZG90LnBhcmVudE5vZGUpIGRvdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRvdCk7CiAgICAgICAgfSwgNTAwKTsKICAgIH0KCmZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgICAgICAvLyBGb3JjZSBpbW1lZGlhdGUgY2FtZXJhIHVwZGF0ZSB0byBwcmV2ZW50IGp1bXAKICAgICAgICAgICAgaWYgKF9jYW1lcmFNYW5hZ2VyKSBfY2FtZXJhTWFuYWdlci51cGRhdGUoMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkIGZvciBwZXJmb3JtYW5jZQovLyBQZXJmb3JtYW5jZSBPcHRpbWl6YXRpb246IENhcCByZXNvbHV0aW9uCmNvbnN0IG1heERpbWVuc2lvbiA9IDQ4MDsgLy8gSGFyZCBjYXAgb24gaW50ZXJuYWwgcmVuZGVyIHJlc29sdXRpb24gKFJlZHVjZWQgZm9yIHBlcmZvcm1hbmNlKQogICAgICAgIGNvbnN0IGN1cnJlbnRNYXggPSBNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBsZXQgcmVzU2NhbGUgPSAwLjUwOyAvLyBCYXNlIHNjYWxlCiAgICAgICAgCiAgICAgICAgaWYgKGN1cnJlbnRNYXggKiByZXNTY2FsZSA+IG1heERpbWVuc2lvbikgewogICAgICAgICAgICByZXNTY2FsZSA9IG1heERpbWVuc2lvbiAvIGN1cnJlbnRNYXg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwppZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgICAgICBpZiAoX3Bvc3RQcm9jZXNzaW5nKSBfcG9zdFByb2Nlc3Npbmcuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQpOwogICAgICAgIH0KICAgIH0KCi8vIC0tLSBGSVhFRCBUSU1FU1RFUCBWQVJJQUJMRVMgLS0tCiAgICBsZXQgX2FjY3VtdWxhdG9yID0gMDsKICAgIGNvbnN0IF9maXhlZFN0ZXAgPSAxIC8gNjA7CgogICAgZnVuY3Rpb24gYW5pbWF0ZSgpIHsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIGNvbnN0IHJhd0R0ID0gX2Nsb2NrLmdldERlbHRhKCk7CiAgICAgICAgLy8gQ2xhbXAgZHQgdG8gcHJldmVudCBzcGlyYWxzIChtYXggMC4xcykKICAgICAgICBjb25zdCBkdCA9IE1hdGgubWluKHJhd0R0LCAwLjEpICogKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXgudGltZVNjYWxlIDogMC44KTsKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KCiAgICAgICAgLy8gSW1wYWN0IEZyYW1lcyAoRnJlZXplIEZyYW1lIEVmZmVjdCkKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRklYRUQgVVBEQVRFIExPT1AgKFBoeXNpY3MgJiBHYW1lIExvZ2ljKSAtLS0KICAgICAgICBfYWNjdW11bGF0b3IgKz0gZHQ7CiAgICAgICAgLy8gU2FmZXR5IENhcDogUHJldmVudCBzcGlyYWwgb2YgZGVhdGggaWYgZnJhbWUgdGFrZXMgdG9vIGxvbmcKaWYgKF9hY2N1bXVsYXRvciA+IDAuMSkgX2FjY3VtdWxhdG9yID0gMC4xOyAvLyBDYXAgYXQgMTAwbXMgdG8gcHJldmVudCBzcGlyYWwgb2YgZGVhdGgKCiAgICAgICAgd2hpbGUgKF9hY2N1bXVsYXRvciA+PSBfZml4ZWRTdGVwKSB7CiAgICAgICAgICAgIGNvbnN0IF9zZHQgPSBfZml4ZWRTdGVwOwoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIElmIGluIEFzc2V0IEZvcmdlIG1vZGUsIHNraXAgZ2FtZSBsb2dpYwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0ZvcmdlTW9kZSkgewogICAgICAgICAgICAgICAgX2FjY3VtdWxhdG9yID0gMDsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcyAoUGh5c2ljcy9BSSkKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYmFsbC51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwgTGFiCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5iYWxsTGFiICYmIHR5cGVvZiB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgVXBkYXRlcnMgKGUuZy4gUmluZ3MgbG9naWMpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCB1aSA9IDA7IHVpIDwgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGg7IHVpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmbiA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnNbdWldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpIGZuKF9zZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBfYWNjdW11bGF0b3IgLT0gX2ZpeGVkU3RlcDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIExPT1AgKE9uY2UgUGVyIEZyYW1lKSAtLS0KICAgICAgICAvLyBUaGVzZSBzeXN0ZW1zIGRvbid0IGFmZmVjdCBnYW1lcGxheSBvdXRjb21lLCBzbyB3ZSB1cGRhdGUgdGhlbSB3aXRoIHRoZSB2aXN1YWwgZGVsdGEgYGR0YAogICAgICAgIC8vIHRvIGVuc3VyZSBzbW9vdGggYW5pbWF0aW9uIGF0IGhpZ2ggcmVmcmVzaCByYXRlcyAoOTAvMTIwSHopIHdpdGhvdXQgd2FzdGluZyBDUFUgb24gcGh5c2ljcy4KCiAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgLy8gQ2FtZXJhCiAgICAgICAgaWYgKCFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgdXBkYXRlQ2FtZXJhTG9naWMoZHQpOwogICAgICAgIH0KCiAgICAgICAgLy8gVmlzdWFsIEZYIFN5c3RlbXMKICAgICAgICBpZiAoX3dhdGVyT3ZlcmxheSkgX3dhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfbGlnaHRTaGFmdHMpIF9saWdodFNoYWZ0cy51cGRhdGUoZHQpOwogICAgICAgIGlmIChfc3RhZGl1bSkgX3N0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwoKaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogNC4wKTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYUdyb3VwKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAucm90YXRpb24ueSArPSBkdCAqIDAuMDU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7CiAgICAgICAgICAgIGlmIChfYmFsbCAmJiBfYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIudGVhbSAmJiBfYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudUNvbG9yLnZhbHVlLmxlcnAodGFyZ2V0Q29sb3IsIGR0ICogMi4wKTsKICAgICAgICB9CgogICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICBfcGFydGljbGVVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICB9CgogICAgICAgIC8vIFJlbmRlcgovLyBSZW5kZXIKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIF9wb3N0UHJvY2Vzc2luZy5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhLCBkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVVSSgpIHsKICAgICAgICAvLyBQcmV2ZW50IFVJIHVwZGF0ZXMgZHVyaW5nIGludHJvIHRvIGtlZXAgdGhpbmdzIGhpZGRlbgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSByZXR1cm47CgogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkJMT0NLIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJCTE9DSyI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgLy8gRW5zdXJlIHZpc3VhbCBmZWVkYmFjawogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIkRFRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKZnVuY3Rpb24gY2hlY2tCYWxsR3JhYihlbnRpdHkpIHsKICAgICAgICBpZiAoIWVudGl0eS5jYW5DYXRjaCkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbCAmJiAhX2JhbGwuaXNDYXRjaGFibGUoKSkgcmV0dXJuOwogICAgICAgIGlmIChlbnRpdHkuc3R1blRpbWVyID4gMCB8fCAoZW50aXR5LnN0YXR1cyAmJiBlbnRpdHkuc3RhdHVzLm5hcCA+IDApKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsLnN0YXRlICE9PSAnZnJlZScpIHJldHVybjsKICAgICAgICBpZiAoIV9iYWxsLm1lc2ggfHwgIWVudGl0eS5tZXNoKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJhbGxQb3MgPSBfYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGVudFBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwoKICAgICAgICBjb25zdCBkeCA9IGJhbGxQb3MueCAtIGVudFBvcy54OwogICAgICAgIGNvbnN0IGR6ID0gYmFsbFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopOwogICAgICAgIGNvbnN0IGRpc3RZID0gTWF0aC5hYnMoYmFsbFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICAvLyAtLS0gUkVMQVhFRCBUT0xFUkFOQ0VTIEZPUiBFQVNJRVIgUElDS1VQIC0tLQogICAgICAgIGNvbnN0IHRvdWNoUmFkaXVzID0gMS41OyAvLyBJbmNyZWFzZWQgZnJvbSAxLjAgKEF1dG8tZ3JhYiByYWRpdXMpCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDMuNTsgIC8vIEluY3JlYXNlZCBmcm9tIDEuOCAoTWFnbmV0aWMgcmFkaXVzKQogICAgICAgIGxldCBpbnRlcmFjdGlvblJhZGl1cyA9IDYuMDsgLy8gSW5jcmVhc2VkIGZyb20gMy41IChUdXJuLXRvIHJhZGl1cykKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSA2LjA7ICAgLy8gSW5jcmVhc2VkIGZyb20gMy4wIChWZXJ0aWNhbCByZWFjaCkKCiAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgbWFnbmV0UmFkaXVzID0gNC41OwogICAgICAgICAgICBpbnRlcmFjdGlvblJhZGl1cyA9IDcuMDsKICAgICAgICAgICAgY2F0Y2hIZWlnaHQgPSA3LjA7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlzdFhaID4gaW50ZXJhY3Rpb25SYWRpdXMgfHwgZGlzdFkgPiBjYXRjaEhlaWdodCkgcmV0dXJuOwoKICAgICAgICAvLyBPcHRpbWl6YXRpb246IFVzZSBzaGFyZWQgdmVjdG9ycyB0byBhdm9pZCBHQwogICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGxQb3MpLnN1YihlbnRQb3MpLm5vcm1hbGl6ZSgpOyAvLyB0b0JhbGwKICAgICAgICBfdGVtcFZlYzIuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihlbnRpdHkubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsgLy8gcGxheWVyRm9yd2FyZAoKICAgICAgICBjb25zdCBmYWNpbmdEb3QgPSBfdGVtcFZlYzIuZG90KF90ZW1wVmVjMSk7CgogICAgICAgIGNvbnN0IGNvbmVUaHJlc2hvbGQgPSAtMC40OyAvLyBNb3JlIGdlbmVyb3VzIGNvbmUgKHdhcyAtMC4yKQogICAgICAgIGNvbnN0IGlzSW5Db25lID0gZmFjaW5nRG90ID4gY29uZVRocmVzaG9sZDsKICAgICAgICAKICAgICAgICAvLyBBVVRPLVRVUk46IElmIG5lYXIgYnV0IGZhY2luZyB3cm9uZyB3YXksIHR1cm4gdG93YXJkcyBiYWxsCiAgICAgICAgaWYgKGRpc3RYWiA8IGludGVyYWN0aW9uUmFkaXVzICYmICFpc0luQ29uZSkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRBbmdsZSA9IE1hdGguYXRhbjIoX3RlbXBWZWMxLngsIF90ZW1wVmVjMS56KTsKICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIHRhcmdldEFuZ2xlKTsKICAgICAgICAgICAgZW50aXR5Lm1lc2gucXVhdGVybmlvbi5zbGVycChxLCAwLjIpOyAvLyBGYXN0ZXIgdHVybiAod2FzIDAuMSkKICAgICAgICAgICAgaWYgKGVudGl0eS5zeW5jUm90YXRpb24pIGVudGl0eS5zeW5jUm90YXRpb24oKTsKICAgICAgICB9CgogICAgICAgIC8vIEdSQUIgTE9HSUMKICAgICAgICAvLyAxLiBUb3VjaDogVmVyeSBjbG9zZSAoaWdub3JlIGZhY2luZyAtIHByZXZlbnRzIHJ1bm5pbmcgb3ZlciBiYWxsKQogICAgICAgIC8vIDIuIE1hZ25ldDogQ2xvc2UgYW5kIGZhY2luZwogICAgICAgIGNvbnN0IGlzVG91Y2ggPSBkaXN0WFogPCB0b3VjaFJhZGl1czsKICAgICAgICBjb25zdCBpc01hZ25ldCA9IGRpc3RYWiA8IG1hZ25ldFJhZGl1cyAmJiBpc0luQ29uZTsKCiAgICAgICAgaWYgKGlzVG91Y2ggfHwgaXNNYWduZXQpIHsKICAgICAgICAgICAgLy8gQkxBU1QgVEhST1VHSCBMT0dJQwogICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSBfYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgbGV0IGNhdGNoQ2hhbmNlID0gMS4wOwoKICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCAoZS5nLiA+IDIwKSwgY2hlY2sgQ0EKICAgICAgICAgICAgaWYgKGJhbGxTcGVlZCA+IDIwLjApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICAvLyBEaWZmaWN1bHR5IHNjYWxlcyB3aXRoIHNwZWVkLiAKICAgICAgICAgICAgICAgIGNvbnN0IGRpZmZpY3VsdHkgPSBiYWxsU3BlZWQgKiAxLjI7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlmZmljdWx0eSA+IGNhKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAwLjQgKyAoY2EgLyBkaWZmaWN1bHR5KSAqIDAuNjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQb2ludCBCbGFuayBQZW5hbHR5OiBIYXJkZXIgdG8gcmVhY3QgaWYgYmFsbCBpcyByaWdodCBvbiB0b3Agb2YgeW91IG1vdmluZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA8IDEuMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSAqPSAwLjY7IC8vIEJsYXN0IHRocm91Z2ggbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSBjYXRjaENoYW5jZSArPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoX2JhbGwucG93ZXJUeXBlID09PSAnU0gnICYmIF9iYWxsLnBvd2VyID4gMTUuMCkgewogICAgICAgICAgICAgICAgLy8gU2hvdCBwb3dlciBjaGVjawogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5wb3dlciA+IGNhICogMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gTWF0aC5taW4oMC43LCAoX2JhbGwucG93ZXIgLSBjYSkgKiAwLjA0KTsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDEuMCAtIGNoYW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGZ1bWJsZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IGNhdGNoQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICBmdW1ibGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnVtYmxlKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBmZWVkYmFjayBmb3IgYmxhc3QgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMQVNUIFRIUk9VR0ghIiwgZW50UG9zLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKZW50aXR5LmNhdGNoQ29vbGRvd24gPSAxLjA7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","./main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CgogICAgbGV0IF9hdWRpb01hbmFnZXI7CiAgICBsZXQgX3Bvc3RQcm9jZXNzaW5nOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBEZWJ1ZyBJTyBCcmlkZ2UgKGV4cG9zZWQgZm9yIERldlRvb2xzIEpTT04gc25hcHNob3RzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBfZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICBfZGVidWdJTy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgIF9kZWJ1Z0lPLmlucHV0ID0gX2RlYnVnSU8uaW5wdXQgfHwge307CiAgICBfZGVidWdJTy5wZXJmID0gX2RlYnVnSU8ucGVyZiB8fCB7IGZyYW1lOiAwLCByYXdEdDogMCwgZHQ6IDAsIGZwczogMCwgYXZnRnBzOiAwIH07CgoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gVG91Y2ggaGVscGVycyAobXVsdGktdG91Y2ggc2FmZSkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgZnVuY3Rpb24gX2ZpbmRUb3VjaEJ5SWQodG91Y2hMaXN0LCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIXRvdWNoTGlzdCkgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3VjaExpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IHRvdWNoTGlzdFtpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIF9lbmRlZFRvdWNoQnlJZChjaGFuZ2VkVG91Y2hlcywgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCFjaGFuZ2VkVG91Y2hlcykgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gY2hhbmdlZFRvdWNoZXNbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgICBfY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CgogICAgICAgIC8vIDEuIFNjZW5lCiAgICAgICAgX3NjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7CiAgICAgICAgX3NjZW5lLmJhY2tncm91bmQgPSBuZXcgVEhSRUUuQ29sb3IoX2NvbmZpZy5iZ0NvbG9yKTsKICAgICAgICBfc2NlbmUuZm9nID0gbmV3IFRIUkVFLkZvZ0V4cDIoX2NvbmZpZy5mb2dDb2xvciwgX2NvbmZpZy5mb2dEZW5zaXR5KTsKCiAgICAgICAgLy8gMi4gQ2FtZXJhCiAgICAgICAgY29uc3QgYXNwZWN0ID0gX2NvbmZpZy5pbnRlcm5hbFdpZHRoIC8gX2NvbmZpZy5pbnRlcm5hbEhlaWdodDsKX2NhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg2NSwgYXNwZWN0LCAwLjEsIDUwMCk7Cl9jYW1lcmEucG9zaXRpb24uc2V0KDAsIDEwLCAxNSk7CiAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgX3NjZW5lLmFkZChfY2FtZXJhKTsgLy8gRW5zdXJlIGNhbWVyYSBpcyBpbiBzY2VuZSBmb3IgY2hpbGRyZW4gdG8gcmVuZGVyCgogICAgICAgIC8vIDMuIFJlbmRlcmVyCi8vIDMuIFJlbmRlcmVyCiAgICAgICAgX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoewogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAplbHNlIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHsgcmVuZGVyZXI6IF9yZW5kZXJlciwgZW50aXRpZXM6IHt9LCB0ZWFtczogeyBob21lOiBudWxsLCBhd2F5OiBudWxsIH0gfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0gX2dhbWVNYW5hZ2VyOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwpfZ2FtZU1hbmFnZXIuYXVkaW9NYW5hZ2VyID0gX2F1ZGlvTWFuYWdlcjsKCiAgICAgICAgLy8gNS41LjIgUG9zdCBQcm9jZXNzaW5nCl9wb3N0UHJvY2Vzc2luZyA9IG5ldyB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyhfcmVuZGVyZXIsIF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLmVuYWJsZWQgPSBmYWxzZTsgLy8gRGlzYWJsZWQgYnkgZGVmYXVsdCBmb3IgcGVyZm9ybWFuY2UKICAgICAgICBfZ2FtZU1hbmFnZXIucG9zdFByb2Nlc3NpbmcgPSBfcG9zdFByb2Nlc3Npbmc7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMjAwOyAvLyBPcHRpbWl6ZWQgZm9yIHBlcmZvcm1hbmNlICh3YXMgMTUwMCkKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgLy8gR3JvdXAgZm9yIHJvdGF0aW9uCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgIF9zY2VuZS5hZGQod2luZG93LmZsdXguYXJlbmFHcm91cCk7CgogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgLy8gLS0tIDEuIEJhc2UgU3BoZXJlIChGYWludCBHcmlkKSAtLS0KICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFyZW5hVGV4LAogICAgICAgICAgICBjb2xvcjogMHg0NDY2ODgsCiAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjE1LCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IGRpc3QgLyByYWRpdXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJ1bGdlID0gKDEuMCAtIHQpICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIG5vcm1hbCA9IG5vcm1hbGl6ZShwb3MpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogKGJ1bGdlICogdUltcGFjdFN0cik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE1hcDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlMkQodE1hcCwgdlV2KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5ICogdGV4Q29sb3IuYTsKICAgICAgICAgICAgICAgICAgICBhbHBoYSArPSB1SW1wYWN0U3RyICogMC4wMjsgCiAgICAgICAgICAgICAgICAgICAgdmVjMyBjb2xvciA9IHRleENvbG9yLnJnYiAqIHZlYzMoMC4yLCAwLjgsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChjb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IGFyZW5hMiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbDIpOwogICAgICAgIGFyZW5hMi5zY2FsZS5zZXRTY2FsYXIoMC45OCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwoKICAgICAgICAvLyAtLS0gMy4gRVFVQVRPUiBCQU5EUyAoQmx1ZSBhbmQgR29sZCAtIHBvc3Nlc3Npb24gYmFzZWQpIC0tLQogICAgICAgIGNvbnN0IGJhbmRUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwoKICAgICAgICAvLyBCbHVlIEJhbmQgKHNob3duIHdoZW4gaG9tZSB0ZWFtIGhhcyBiYWxsKSAtIHRoaW4gYmFuZCwgbm8gdmVydGljYWwgc3RyZXRjaAogICAgICAgIGNvbnN0IGJsdWVCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9TUW5GcERITi9CbHVlLWJhbmQucG5nJyk7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBibHVlQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsgLy8gU2luZ2xlIHdyYXAsIGltYWdlIHRpbGVzIG5hdHVyYWxseQoKICAgICAgICBjb25zdCBibHVlQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogYmx1ZUJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7Ci8vIFRoaW4gYmFuZCAtIGhlaWdodCBvZiAzIHRvIGF2b2lkIHN0cmV0Y2hpbmcKICAgICAgICBjb25zdCBibHVlQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGJsdWVCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGJsdWVCYW5kR2VvLCBibHVlQmFuZE1hdCk7CiAgICAgICAgYmx1ZUJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGJsdWVCYW5kTWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICBfc2NlbmUuYWRkKGJsdWVCYW5kTWVzaCk7CgogICAgICAgIC8vIEdvbGQgQmFuZCAoc2hvd24gd2hlbiBhd2F5IHRlYW0gaGFzIGJhbGwpCiAgICAgICAgY29uc3QgZ29sZEJhbmRUZXggPSBiYW5kVGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL01abjI4ZGdxL0dvbGQtYmFuZC5wbmcnKTsKICAgICAgICBnb2xkQmFuZFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGdvbGRCYW5kVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC5yZXBlYXQuc2V0KDEsIDEpOwoKICAgICAgICBjb25zdCBnb2xkQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogZ29sZEJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CmNvbnN0IGdvbGRCYW5kR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCAzLCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgZ29sZEJhbmRNZXNoID0gbmV3IFRIUkVFLk1lc2goZ29sZEJhbmRHZW8sIGdvbGRCYW5kTWF0KTsKICAgICAgICBnb2xkQmFuZE1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgZ29sZEJhbmRNZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICBfc2NlbmUuYWRkKGdvbGRCYW5kTWVzaCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPSBibHVlQmFuZE1lc2g7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID0gZ29sZEJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0ID0gYmx1ZUJhbmRNYXQ7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNYXQgPSBnb2xkQmFuZE1hdDsKCiAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gPSBmdW5jdGlvbihob21lSGFzQmFsbCkgewogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNZXNoICYmIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSBob21lSGFzQmFsbDsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaC52aXNpYmxlID0gIWhvbWVIYXNCYWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMgPSB7CiAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gLS0tIDQuIFZFUlRJQ0FMIEFSUk9XIFNUUklQUyAoQXJvdW5kIHNwaGVyZSwgYWJvdmUgJiBiZWxvdyBiYW5kKSAtLS0KICAgICAgICBjb25zdCBhcnJvd1RleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgYXJyb3dUZXggPSBhcnJvd1RleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9kUWhQSzRnUS9ZZWxsb3dhcnJvd3MucG5nJyk7CiAgICAgICAgYXJyb3dUZXgud3JhcFMgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGFycm93VGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ3JlYXRlIHZlcnRpY2FsIGFycm93IHN0cmlwcyBhcm91bmQgdGhlIHNwaGVyZSAoY3VydmVkIHRvIG1hdGNoIHNwaGVyZSBzdXJmYWNlKQogICAgICAgIGNvbnN0IGFycm93R3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBjb25zdCBudW1BcnJvd3MgPSAxNjsgICAvLyBOdW1iZXIgb2YgYXJyb3cgc3RyaXBzIGFyb3VuZCBjaXJjdW1mZXJlbmNlCiAgICAgICAgY29uc3QgYXJyb3dIZWlnaHQgPSAzMDsgLy8gSGVpZ2h0IG9mIGVhY2ggYXJyb3cgc3RyaXAKICAgICAgICBjb25zdCBhcnJvd1dpZHRoID0gNjsgICAvLyBXaWR0aCBvZiBlYWNoIHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dSYWRpdXMgPSBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NDsKCiAgICAgICAgY29uc3QgbWFrZUN1cnZlZFN0cmlwID0gKGJhc2VBbmdsZSwgeUNlbnRlciwgZmxpcFYgPSBmYWxzZSkgPT4gewogICAgICAgICAgICAvLyBNb3JlIHNlZ21lbnRzID0gc21vb3RoZXIgY3VydmF0dXJlIChrZWVwIG1vZGVzdCBmb3IgbW9iaWxlKQogICAgICAgICAgICBjb25zdCBzZWdXID0gNjsgICAvLyBjdXJ2YXR1cmUgcmVzb2x1dGlvbiAod2lkdGgpCiAgICAgICAgICAgIGNvbnN0IHNlZ0ggPSAxODsgIC8vIHZlcnRpY2FsIHJlc29sdXRpb24gKGhlaWdodCkKCiAgICAgICAgICAgIC8vIENvbnZlcnQgZGVzaXJlZCB3b3JsZC1zcGFjZSB3aWR0aCBpbnRvIGFuIGFuZ3VsYXIgc3BhbiBvbiB0aGUgc3BoZXJlCiAgICAgICAgICAgIGNvbnN0IHBoaVNwYW4gPSBhcnJvd1dpZHRoIC8gYXJyb3dSYWRpdXM7IC8vIHJhZGlhbnMgKGFwcHJveCBhdCBlcXVhdG9yKQogICAgICAgICAgICBjb25zdCBwaGkwID0gYmFzZUFuZ2xlIC0gcGhpU3BhbiAqIDAuNTsKICAgICAgICAgICAgY29uc3QgcGhpMSA9IGJhc2VBbmdsZSArIHBoaVNwYW4gKiAwLjU7CgogICAgICAgICAgICBjb25zdCB5MCA9IHlDZW50ZXIgLSBhcnJvd0hlaWdodCAqIDAuNTsKICAgICAgICAgICAgY29uc3QgeTEgPSB5Q2VudGVyICsgYXJyb3dIZWlnaHQgKiAwLjU7CgogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICAgICAgY29uc3Qgbm9ybWFscyA9IFtdOwogICAgICAgICAgICBjb25zdCB1dnMgPSBbXTsKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8PSBzZWdIOyBpeSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2ID0gaXkgLyBzZWdIOwogICAgICAgICAgICAgICAgY29uc3QgeSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHkwLCB5MSwgdik7CgogICAgICAgICAgICAgICAgLy8gQ2lyY2xlIHJhZGl1cyBhdCB0aGlzIGhlaWdodCBvbiB0aGUgc3BoZXJlICh4L3ogc2hyaW5rIGFzIHx5fCBncm93cykKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdSID0gTWF0aC5zcXJ0KE1hdGgubWF4KDAuMDAwMDEsIGFycm93UmFkaXVzICogYXJyb3dSYWRpdXMgLSB5ICogeSkpOwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPD0gc2VnVzsgaXgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHUgPSBpeCAvIHNlZ1c7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAocGhpMCwgcGhpMSwgdSk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLnNpbihwaGkpICogcmluZ1I7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguY29zKHBoaSkgKiByaW5nUjsKCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2goeCwgeSwgeik7CgogICAgICAgICAgICAgICAgICAgIC8vIE91dHdhcmQgbm9ybWFsIGZvciBhIHNwaGVyZSBjZW50ZXJlZCBhdCBvcmlnaW4KICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnZMZW4gPSAxLjAgLyBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgICAgICAgICAgICAgICAgICBub3JtYWxzLnB1c2goeCAqIGludkxlbiwgeSAqIGludkxlbiwgeiAqIGludkxlbik7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZ2ID0gZmxpcFYgPyAoMSAtIHYpIDogdjsKICAgICAgICAgICAgICAgICAgICB1dnMucHVzaCh1LCB2dik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHNlZ1cgKyAxOwogICAgICAgICAgICBmb3IgKGxldCBpeSA9IDA7IGl5IDwgc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IHNlZ1c7IGl4KyspIHsKY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGl5ICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYyA9IChpeSArIDEpICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZCA9IChpeSArIDEpICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCA6IC0xOC4wOwoKICAgICAgICAgICAgY29uc3QgZ29hbFNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFIDogNDUuMDsKICAgICAgICAgICAgY29uc3Qgc3ggPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9YIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1opICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWiA6IDEuMDsKICAgICAgICAgICAgCmdvYWxBLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCmdvYWxCLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgZ29hbERpc3QpOwppZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxCLnNjYWxlLnNldChnb2FsU2NhbGUgKiBzeCwgZ29hbFNjYWxlICogc3ksIGdvYWxTY2FsZSAqIHN6KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9Ci8vIE5FVzogVGFja2xlL1NwcmludCBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBPZmZlbnNlOiBTcHJpbnQvQnJlYWsgKEluc3RhbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zZTogU3RhcnQgQ2hhcmdlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5pc1RhY2tsZUNoYXJnaW5nICYmICFwLmlzVGFja2xpbmcgJiYgIXAuaXNSZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBFdmFkZSBvbiAnRScKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0tleUUnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLmV2YWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgCiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IGZhbHNlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5FVzogUmVsZWFzZSBUYWNrbGUgb24gU2hpZnQgVXAKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmIHAuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7IAogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwpjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcyA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGwpIHAudGhyb3dCYWxsKGJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQoKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7Cgpjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gREVGRU5TRTogQmxvY2sKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmICFwLmlzRGFzaGluZyAmJiAhcC5pc0V2YWRpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDAgJiYgcC5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgpsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrOiBJbnB1dCBSaXBwbGUKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQovLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CmhhbmRsZUFpbUVuZCgpOwppZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCi8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKICAgICAgICBsZXQgaG9sZFRpbWVyID0gbnVsbDsKICAgICAgICBsZXQgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IGxhc3RUYXBUaW1lID0gMDsKICAgICAgICBjb25zdCBIT0xEX1RIUkVTSE9MRCA9IDIwMDsgLy8gbXMKICAgICAgICBjb25zdCBET1VCTEVfVEFQX1RIUkVTSE9MRCA9IDMwMDsgLy8gbXMKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgYnViYmxpbmcgdG8gam95c3RpY2sKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjazogSW5wdXQgUmlwcGxlCiAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNsaWVudFggPSBlLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjbGllbnRZID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEhvbGQgU3RhdGUKICAgICAgICAgICAgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChob2xkVGltZXIpIGNsZWFyVGltZW91dChob2xkVGltZXIpOwoKICAgICAgICAgICAgLy8gU3RhcnQgSG9sZCBUaW1lcgogICAgICAgICAgICBob2xkVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBPbmx5IGNoYXJnZSBpZiB3ZSBkb24ndCBoYXZlIHRoZSBiYWxsIChEZWZlbnNpdmUgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOyAvLyBWaXN1YWwgY3VlIGZvciBjaGFyZ2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgSE9MRF9USFJFU0hPTEQpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgaWYgKGlzSG9sZGluZykgewogICAgICAgICAgICAgICAgLy8gLS0tIEhPTEQgUkVMRUFTRSAoQ2hhcmdlZCBUYWNrbGUpIC0tLQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIFRBUCAoVGFja2xlIC8gRXZhZGUpIC0tLQogICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVTaW5jZUxhc3QgPSBub3cgLSBsYXN0VGFwVGltZTsKCiAgICAgICAgICAgICAgICBpZiAodGltZVNpbmNlTGFzdCA8IERPVUJMRV9UQVBfVEhSRVNIT0xEKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIERPVUJMRSBUQVA6IEVWQURFIC0tLQogICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIGNhbmNlbCBkYXNoIGlmIGFjdGl2ZSB0byBhbGxvdyBpbW1lZGlhdGUgZXZhZGUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcgfHwgcC5kYXNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcC5ldmFkZSgpOwogICAgICAgICAgICAgICAgICAgIGxhc3RUYXBUaW1lID0gMDsgLy8gUmVzZXQgdG8gcHJldmVudCB0cmlwbGUtdGFwIGlzc3VlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gU0lOR0xFIFRBUDogVEFDS0xFIC8gQlJFQUsgLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zaXZlIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vdCBtb3ZpbmcsIGRhc2ggZm9yd2FyZCByZWxhdGl2ZSB0byBwbGF5ZXIgZmFjaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChkYXNoWCwgZGFzaFopOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgcC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9mZmVuc2l2ZSBCcmVhayBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGFzdFRhcFRpbWUgPSBub3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoaXNIb2xkaW5nIHx8IGhvbGRUaW1lcikgaGFuZGxlRW5kKGUpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwpfYXVkaW9NYW5hZ2VyLnNldE1hc3RlclZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUlucHV0VmVjdG9yKCkgewogICAgICAgIGxldCB4ID0gX2lucHV0LnggfHwgMDsKICAgICAgICBsZXQgeiA9IF9pbnB1dC55IHx8IDA7CgogICAgICAgIGlmIChfa2V5c1sndyddIHx8IF9rZXlzWydBcnJvd1VwJ10pIHogLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ3MnXSB8fCBfa2V5c1snQXJyb3dEb3duJ10pIHogKz0gMTsKICAgICAgICBpZiAoX2tleXNbJ2EnXSB8fCBfa2V5c1snQXJyb3dMZWZ0J10pIHggLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ2QnXSB8fCBfa2V5c1snQXJyb3dSaWdodCddKSB4ICs9IDE7CgogICAgICAgIGNvbnN0IGxlblNxID0geCp4ICsgeip6OwogICAgICAgIGlmIChsZW5TcSA+IDEpIHsKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KGxlblNxKTsKICAgICAgICAgICAgeCAvPSBsZW47CiAgICAgICAgICAgIHogLz0gbGVuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzTmFOKHgpKSB4ID0gMDsKICAgICAgICBpZiAoaXNOYU4oeikpIHogPSAwOwoKICAgICAgICBpZiAoX2NhbWVyYSkgewogICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwoKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LnNldCgxLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIGxldCB3b3JsZFggPSAoX2NhbUZ3ZC54ICogLXopICsgKF9jYW1SaWdodC54ICogeCk7CiAgICAgICAgbGV0IHdvcmxkWiA9IChfY2FtRndkLnogKiAteikgKyAoX2NhbVJpZ2h0LnogKiB4KTsKCiAgICAgICAgaWYgKGlzTmFOKHdvcmxkWCkgfHwgaXNOYU4od29ybGRaKSkgewogICAgICAgICAgICB3b3JsZFggPSAwOwogICAgICAgICAgICB3b3JsZFogPSAwOwogICAgICAgIH0KCmlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAvLyBGSVg6IE9ubHkgYWxsb3cgbW92ZW1lbnQgaWYgZ2FtZSBpcyBhY3RpdmUgb3IgaW4gcHJhY3RpY2UKICAgICAgICAgICAgY29uc3QgZ20gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGNhbk1vdmUgPSBnbSAmJiAhZ20uaXNEZW1vTW9kZSAmJiAoZ20uc3RhdGUgPT09ICdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChjYW5Nb3ZlKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cn0KCiAgICBmdW5jdGlvbiBjcmVhdGVSaXBwbGUoeCwgeSkgewogICAgICAgIGNvbnN0IHJpcHBsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJpcHBsZS5jbGFzc05hbWUgPSAndG91Y2gtcmlwcGxlJzsKICAgICAgICByaXBwbGUuc3R5bGUubGVmdCA9IGAke3h9cHhgOwogICAgICAgIHJpcHBsZS5zdHlsZS50b3AgPSBgJHt5fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChyaXBwbGUpOwoKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKHJpcHBsZS5wYXJlbnROb2RlKSByaXBwbGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyaXBwbGUpOwogICAgICAgIH0sIDYwMCk7CgogICAgfQoKICAgIC8vIE5FVzogVmlzdWFsIFN3aXBlIFRyYWlsCiAgICBmdW5jdGlvbiBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpIHsKICAgICAgICBjb25zdCBkb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkb3QuY2xhc3NOYW1lID0gJ3N3aXBlLXRyYWlsLWRvdCc7CiAgICAgICAgZG90LnN0eWxlLmxlZnQgPSBgJHt4IC0gNn1weGA7IC8vIENlbnRlciAoMTJweCB3aWR0aCkKICAgICAgICBkb3Quc3R5bGUudG9wID0gYCR7eSAtIDZ9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgCiAgICAgICAgLy8gQ1NTIGFuaW1hdGlvbiBoYW5kbGVzIHJlbW92YWwsIGJ1dCB3ZSBjbGVhbiB1cCBET00gdG8gYmUgc2FmZQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoZG90LnBhcmVudE5vZGUpIGRvdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRvdCk7CiAgICAgICAgfSwgNTAwKTsKICAgIH0KCmZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgICAgICAvLyBGb3JjZSBpbW1lZGlhdGUgY2FtZXJhIHVwZGF0ZSB0byBwcmV2ZW50IGp1bXAKICAgICAgICAgICAgaWYgKF9jYW1lcmFNYW5hZ2VyKSBfY2FtZXJhTWFuYWdlci51cGRhdGUoMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkIGZvciBwZXJmb3JtYW5jZQovLyBQZXJmb3JtYW5jZSBPcHRpbWl6YXRpb246IENhcCByZXNvbHV0aW9uCmNvbnN0IG1heERpbWVuc2lvbiA9IDQ4MDsgLy8gSGFyZCBjYXAgb24gaW50ZXJuYWwgcmVuZGVyIHJlc29sdXRpb24gKFJlZHVjZWQgZm9yIHBlcmZvcm1hbmNlKQogICAgICAgIGNvbnN0IGN1cnJlbnRNYXggPSBNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBsZXQgcmVzU2NhbGUgPSAwLjUwOyAvLyBCYXNlIHNjYWxlCiAgICAgICAgCiAgICAgICAgaWYgKGN1cnJlbnRNYXggKiByZXNTY2FsZSA+IG1heERpbWVuc2lvbikgewogICAgICAgICAgICByZXNTY2FsZSA9IG1heERpbWVuc2lvbiAvIGN1cnJlbnRNYXg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwppZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgICAgICBpZiAoX3Bvc3RQcm9jZXNzaW5nKSBfcG9zdFByb2Nlc3Npbmcuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQpOwogICAgICAgIH0KICAgIH0KCi8vIC0tLSBGSVhFRCBUSU1FU1RFUCBWQVJJQUJMRVMgLS0tCiAgICBsZXQgX2FjY3VtdWxhdG9yID0gMDsKICAgIGNvbnN0IF9maXhlZFN0ZXAgPSAxIC8gNjA7CgogICAgZnVuY3Rpb24gYW5pbWF0ZSgpIHsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIGNvbnN0IHJhd0R0ID0gX2Nsb2NrLmdldERlbHRhKCk7CiAgICAgICAgLy8gQ2xhbXAgZHQgdG8gcHJldmVudCBzcGlyYWxzIChtYXggMC4xcykKICAgICAgICBjb25zdCBkdCA9IE1hdGgubWluKHJhd0R0LCAwLjEpICogKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXgudGltZVNjYWxlIDogMC44KTsKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KCiAgICAgICAgLy8gSW1wYWN0IEZyYW1lcyAoRnJlZXplIEZyYW1lIEVmZmVjdCkKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRklYRUQgVVBEQVRFIExPT1AgKFBoeXNpY3MgJiBHYW1lIExvZ2ljKSAtLS0KICAgICAgICBfYWNjdW11bGF0b3IgKz0gZHQ7CiAgICAgICAgLy8gU2FmZXR5IENhcDogUHJldmVudCBzcGlyYWwgb2YgZGVhdGggaWYgZnJhbWUgdGFrZXMgdG9vIGxvbmcKaWYgKF9hY2N1bXVsYXRvciA+IDAuMSkgX2FjY3VtdWxhdG9yID0gMC4xOyAvLyBDYXAgYXQgMTAwbXMgdG8gcHJldmVudCBzcGlyYWwgb2YgZGVhdGgKCiAgICAgICAgd2hpbGUgKF9hY2N1bXVsYXRvciA+PSBfZml4ZWRTdGVwKSB7CiAgICAgICAgICAgIGNvbnN0IF9zZHQgPSBfZml4ZWRTdGVwOwoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIElmIGluIEFzc2V0IEZvcmdlIG1vZGUsIHNraXAgZ2FtZSBsb2dpYwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0ZvcmdlTW9kZSkgewogICAgICAgICAgICAgICAgX2FjY3VtdWxhdG9yID0gMDsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcyAoUGh5c2ljcy9BSSkKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYmFsbC51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwgTGFiCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5iYWxsTGFiICYmIHR5cGVvZiB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgVXBkYXRlcnMgKGUuZy4gUmluZ3MgbG9naWMpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCB1aSA9IDA7IHVpIDwgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGg7IHVpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmbiA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnNbdWldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpIGZuKF9zZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBfYWNjdW11bGF0b3IgLT0gX2ZpeGVkU3RlcDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIExPT1AgKE9uY2UgUGVyIEZyYW1lKSAtLS0KICAgICAgICAvLyBUaGVzZSBzeXN0ZW1zIGRvbid0IGFmZmVjdCBnYW1lcGxheSBvdXRjb21lLCBzbyB3ZSB1cGRhdGUgdGhlbSB3aXRoIHRoZSB2aXN1YWwgZGVsdGEgYGR0YAogICAgICAgIC8vIHRvIGVuc3VyZSBzbW9vdGggYW5pbWF0aW9uIGF0IGhpZ2ggcmVmcmVzaCByYXRlcyAoOTAvMTIwSHopIHdpdGhvdXQgd2FzdGluZyBDUFUgb24gcGh5c2ljcy4KCiAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgLy8gQ2FtZXJhCiAgICAgICAgaWYgKCFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgdXBkYXRlQ2FtZXJhTG9naWMoZHQpOwogICAgICAgIH0KCiAgICAgICAgLy8gVmlzdWFsIEZYIFN5c3RlbXMKICAgICAgICBpZiAoX3dhdGVyT3ZlcmxheSkgX3dhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfbGlnaHRTaGFmdHMpIF9saWdodFNoYWZ0cy51cGRhdGUoZHQpOwogICAgICAgIGlmIChfc3RhZGl1bSkgX3N0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwoKaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogNC4wKTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYUdyb3VwKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAucm90YXRpb24ueSArPSBkdCAqIDAuMDU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7CiAgICAgICAgICAgIGlmIChfYmFsbCAmJiBfYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIudGVhbSAmJiBfYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudUNvbG9yLnZhbHVlLmxlcnAodGFyZ2V0Q29sb3IsIGR0ICogMi4wKTsKICAgICAgICB9CgogICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICBfcGFydGljbGVVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICB9CgogICAgICAgIC8vIFJlbmRlcgovLyBSZW5kZXIKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIF9wb3N0UHJvY2Vzc2luZy5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhLCBkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVVSSgpIHsKICAgICAgICAvLyBQcmV2ZW50IFVJIHVwZGF0ZXMgZHVyaW5nIGludHJvIHRvIGtlZXAgdGhpbmdzIGhpZGRlbgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSByZXR1cm47CgogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkJMT0NLIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJCTE9DSyI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgLy8gRW5zdXJlIHZpc3VhbCBmZWVkYmFjawogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIkRFRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKZnVuY3Rpb24gY2hlY2tCYWxsR3JhYihlbnRpdHkpIHsKICAgICAgICBpZiAoIWVudGl0eS5jYW5DYXRjaCkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbCAmJiAhX2JhbGwuaXNDYXRjaGFibGUoKSkgcmV0dXJuOwogICAgICAgIGlmIChlbnRpdHkuc3R1blRpbWVyID4gMCB8fCAoZW50aXR5LnN0YXR1cyAmJiBlbnRpdHkuc3RhdHVzLm5hcCA+IDApKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsLnN0YXRlICE9PSAnZnJlZScpIHJldHVybjsKICAgICAgICBpZiAoIV9iYWxsLm1lc2ggfHwgIWVudGl0eS5tZXNoKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJhbGxQb3MgPSBfYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGVudFBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwoKICAgICAgICBjb25zdCBkeCA9IGJhbGxQb3MueCAtIGVudFBvcy54OwogICAgICAgIGNvbnN0IGR6ID0gYmFsbFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopOwogICAgICAgIGNvbnN0IGRpc3RZID0gTWF0aC5hYnMoYmFsbFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICAvLyAtLS0gUkVMQVhFRCBUT0xFUkFOQ0VTIEZPUiBFQVNJRVIgUElDS1VQIC0tLQogICAgICAgIGNvbnN0IHRvdWNoUmFkaXVzID0gMS41OyAvLyBJbmNyZWFzZWQgZnJvbSAxLjAgKEF1dG8tZ3JhYiByYWRpdXMpCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDMuNTsgIC8vIEluY3JlYXNlZCBmcm9tIDEuOCAoTWFnbmV0aWMgcmFkaXVzKQogICAgICAgIGxldCBpbnRlcmFjdGlvblJhZGl1cyA9IDYuMDsgLy8gSW5jcmVhc2VkIGZyb20gMy41IChUdXJuLXRvIHJhZGl1cykKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSA2LjA7ICAgLy8gSW5jcmVhc2VkIGZyb20gMy4wIChWZXJ0aWNhbCByZWFjaCkKCiAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgbWFnbmV0UmFkaXVzID0gNC41OwogICAgICAgICAgICBpbnRlcmFjdGlvblJhZGl1cyA9IDcuMDsKICAgICAgICAgICAgY2F0Y2hIZWlnaHQgPSA3LjA7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlzdFhaID4gaW50ZXJhY3Rpb25SYWRpdXMgfHwgZGlzdFkgPiBjYXRjaEhlaWdodCkgcmV0dXJuOwoKICAgICAgICAvLyBPcHRpbWl6YXRpb246IFVzZSBzaGFyZWQgdmVjdG9ycyB0byBhdm9pZCBHQwogICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGxQb3MpLnN1YihlbnRQb3MpLm5vcm1hbGl6ZSgpOyAvLyB0b0JhbGwKICAgICAgICBfdGVtcFZlYzIuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihlbnRpdHkubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsgLy8gcGxheWVyRm9yd2FyZAoKICAgICAgICBjb25zdCBmYWNpbmdEb3QgPSBfdGVtcFZlYzIuZG90KF90ZW1wVmVjMSk7CgogICAgICAgIGNvbnN0IGNvbmVUaHJlc2hvbGQgPSAtMC40OyAvLyBNb3JlIGdlbmVyb3VzIGNvbmUgKHdhcyAtMC4yKQogICAgICAgIGNvbnN0IGlzSW5Db25lID0gZmFjaW5nRG90ID4gY29uZVRocmVzaG9sZDsKICAgICAgICAKICAgICAgICAvLyBBVVRPLVRVUk46IElmIG5lYXIgYnV0IGZhY2luZyB3cm9uZyB3YXksIHR1cm4gdG93YXJkcyBiYWxsCiAgICAgICAgaWYgKGRpc3RYWiA8IGludGVyYWN0aW9uUmFkaXVzICYmICFpc0luQ29uZSkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRBbmdsZSA9IE1hdGguYXRhbjIoX3RlbXBWZWMxLngsIF90ZW1wVmVjMS56KTsKICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIHRhcmdldEFuZ2xlKTsKICAgICAgICAgICAgZW50aXR5Lm1lc2gucXVhdGVybmlvbi5zbGVycChxLCAwLjIpOyAvLyBGYXN0ZXIgdHVybiAod2FzIDAuMSkKICAgICAgICAgICAgaWYgKGVudGl0eS5zeW5jUm90YXRpb24pIGVudGl0eS5zeW5jUm90YXRpb24oKTsKICAgICAgICB9CgogICAgICAgIC8vIEdSQUIgTE9HSUMKICAgICAgICAvLyAxLiBUb3VjaDogVmVyeSBjbG9zZSAoaWdub3JlIGZhY2luZyAtIHByZXZlbnRzIHJ1bm5pbmcgb3ZlciBiYWxsKQogICAgICAgIC8vIDIuIE1hZ25ldDogQ2xvc2UgYW5kIGZhY2luZwogICAgICAgIGNvbnN0IGlzVG91Y2ggPSBkaXN0WFogPCB0b3VjaFJhZGl1czsKICAgICAgICBjb25zdCBpc01hZ25ldCA9IGRpc3RYWiA8IG1hZ25ldFJhZGl1cyAmJiBpc0luQ29uZTsKCiAgICAgICAgaWYgKGlzVG91Y2ggfHwgaXNNYWduZXQpIHsKICAgICAgICAgICAgLy8gQkxBU1QgVEhST1VHSCBMT0dJQwogICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSBfYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgbGV0IGNhdGNoQ2hhbmNlID0gMS4wOwoKICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCAoZS5nLiA+IDIwKSwgY2hlY2sgQ0EKICAgICAgICAgICAgaWYgKGJhbGxTcGVlZCA+IDIwLjApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICAvLyBEaWZmaWN1bHR5IHNjYWxlcyB3aXRoIHNwZWVkLiAKICAgICAgICAgICAgICAgIGNvbnN0IGRpZmZpY3VsdHkgPSBiYWxsU3BlZWQgKiAxLjI7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlmZmljdWx0eSA+IGNhKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAwLjQgKyAoY2EgLyBkaWZmaWN1bHR5KSAqIDAuNjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQb2ludCBCbGFuayBQZW5hbHR5OiBIYXJkZXIgdG8gcmVhY3QgaWYgYmFsbCBpcyByaWdodCBvbiB0b3Agb2YgeW91IG1vdmluZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA8IDEuMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSAqPSAwLjY7IC8vIEJsYXN0IHRocm91Z2ggbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSBjYXRjaENoYW5jZSArPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoX2JhbGwucG93ZXJUeXBlID09PSAnU0gnICYmIF9iYWxsLnBvd2VyID4gMTUuMCkgewogICAgICAgICAgICAgICAgLy8gU2hvdCBwb3dlciBjaGVjawogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5wb3dlciA+IGNhICogMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gTWF0aC5taW4oMC43LCAoX2JhbGwucG93ZXIgLSBjYSkgKiAwLjA0KTsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDEuMCAtIGNoYW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGZ1bWJsZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IGNhdGNoQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICBmdW1ibGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnVtYmxlKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBmZWVkYmFjayBmb3IgYmxhc3QgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMQVNUIFRIUk9VR0ghIiwgZW50UG9zLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKZW50aXR5LmNhdGNoQ29vbGRvd24gPSAxLjA7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","/main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CgogICAgbGV0IF9hdWRpb01hbmFnZXI7CiAgICBsZXQgX3Bvc3RQcm9jZXNzaW5nOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBEZWJ1ZyBJTyBCcmlkZ2UgKGV4cG9zZWQgZm9yIERldlRvb2xzIEpTT04gc25hcHNob3RzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBfZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICBfZGVidWdJTy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgIF9kZWJ1Z0lPLmlucHV0ID0gX2RlYnVnSU8uaW5wdXQgfHwge307CiAgICBfZGVidWdJTy5wZXJmID0gX2RlYnVnSU8ucGVyZiB8fCB7IGZyYW1lOiAwLCByYXdEdDogMCwgZHQ6IDAsIGZwczogMCwgYXZnRnBzOiAwIH07CgoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gVG91Y2ggaGVscGVycyAobXVsdGktdG91Y2ggc2FmZSkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgZnVuY3Rpb24gX2ZpbmRUb3VjaEJ5SWQodG91Y2hMaXN0LCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIXRvdWNoTGlzdCkgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3VjaExpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IHRvdWNoTGlzdFtpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIF9lbmRlZFRvdWNoQnlJZChjaGFuZ2VkVG91Y2hlcywgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCFjaGFuZ2VkVG91Y2hlcykgcmV0dXJuIG51bGw7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gY2hhbmdlZFRvdWNoZXNbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgICBfY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CgogICAgICAgIC8vIDEuIFNjZW5lCiAgICAgICAgX3NjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7CiAgICAgICAgX3NjZW5lLmJhY2tncm91bmQgPSBuZXcgVEhSRUUuQ29sb3IoX2NvbmZpZy5iZ0NvbG9yKTsKICAgICAgICBfc2NlbmUuZm9nID0gbmV3IFRIUkVFLkZvZ0V4cDIoX2NvbmZpZy5mb2dDb2xvciwgX2NvbmZpZy5mb2dEZW5zaXR5KTsKCiAgICAgICAgLy8gMi4gQ2FtZXJhCiAgICAgICAgY29uc3QgYXNwZWN0ID0gX2NvbmZpZy5pbnRlcm5hbFdpZHRoIC8gX2NvbmZpZy5pbnRlcm5hbEhlaWdodDsKX2NhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg2NSwgYXNwZWN0LCAwLjEsIDUwMCk7Cl9jYW1lcmEucG9zaXRpb24uc2V0KDAsIDEwLCAxNSk7CiAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgX3NjZW5lLmFkZChfY2FtZXJhKTsgLy8gRW5zdXJlIGNhbWVyYSBpcyBpbiBzY2VuZSBmb3IgY2hpbGRyZW4gdG8gcmVuZGVyCgogICAgICAgIC8vIDMuIFJlbmRlcmVyCi8vIDMuIFJlbmRlcmVyCiAgICAgICAgX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoewogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAplbHNlIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHsgcmVuZGVyZXI6IF9yZW5kZXJlciwgZW50aXRpZXM6IHt9LCB0ZWFtczogeyBob21lOiBudWxsLCBhd2F5OiBudWxsIH0gfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0gX2dhbWVNYW5hZ2VyOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwpfZ2FtZU1hbmFnZXIuYXVkaW9NYW5hZ2VyID0gX2F1ZGlvTWFuYWdlcjsKCiAgICAgICAgLy8gNS41LjIgUG9zdCBQcm9jZXNzaW5nCl9wb3N0UHJvY2Vzc2luZyA9IG5ldyB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyhfcmVuZGVyZXIsIF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLmVuYWJsZWQgPSBmYWxzZTsgLy8gRGlzYWJsZWQgYnkgZGVmYXVsdCBmb3IgcGVyZm9ybWFuY2UKICAgICAgICBfZ2FtZU1hbmFnZXIucG9zdFByb2Nlc3NpbmcgPSBfcG9zdFByb2Nlc3Npbmc7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMjAwOyAvLyBPcHRpbWl6ZWQgZm9yIHBlcmZvcm1hbmNlICh3YXMgMTUwMCkKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgLy8gR3JvdXAgZm9yIHJvdGF0aW9uCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgIF9zY2VuZS5hZGQod2luZG93LmZsdXguYXJlbmFHcm91cCk7CgogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgLy8gLS0tIDEuIEJhc2UgU3BoZXJlIChGYWludCBHcmlkKSAtLS0KICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFyZW5hVGV4LAogICAgICAgICAgICBjb2xvcjogMHg0NDY2ODgsCiAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjE1LCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IGRpc3QgLyByYWRpdXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJ1bGdlID0gKDEuMCAtIHQpICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIG5vcm1hbCA9IG5vcm1hbGl6ZShwb3MpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogKGJ1bGdlICogdUltcGFjdFN0cik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE1hcDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlMkQodE1hcCwgdlV2KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5ICogdGV4Q29sb3IuYTsKICAgICAgICAgICAgICAgICAgICBhbHBoYSArPSB1SW1wYWN0U3RyICogMC4wMjsgCiAgICAgICAgICAgICAgICAgICAgdmVjMyBjb2xvciA9IHRleENvbG9yLnJnYiAqIHZlYzMoMC4yLCAwLjgsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChjb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IGFyZW5hMiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbDIpOwogICAgICAgIGFyZW5hMi5zY2FsZS5zZXRTY2FsYXIoMC45OCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwoKICAgICAgICAvLyAtLS0gMy4gRVFVQVRPUiBCQU5EUyAoQmx1ZSBhbmQgR29sZCAtIHBvc3Nlc3Npb24gYmFzZWQpIC0tLQogICAgICAgIGNvbnN0IGJhbmRUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwoKICAgICAgICAvLyBCbHVlIEJhbmQgKHNob3duIHdoZW4gaG9tZSB0ZWFtIGhhcyBiYWxsKSAtIHRoaW4gYmFuZCwgbm8gdmVydGljYWwgc3RyZXRjaAogICAgICAgIGNvbnN0IGJsdWVCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9TUW5GcERITi9CbHVlLWJhbmQucG5nJyk7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBibHVlQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsgLy8gU2luZ2xlIHdyYXAsIGltYWdlIHRpbGVzIG5hdHVyYWxseQoKICAgICAgICBjb25zdCBibHVlQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogYmx1ZUJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7Ci8vIFRoaW4gYmFuZCAtIGhlaWdodCBvZiAzIHRvIGF2b2lkIHN0cmV0Y2hpbmcKICAgICAgICBjb25zdCBibHVlQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGJsdWVCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGJsdWVCYW5kR2VvLCBibHVlQmFuZE1hdCk7CiAgICAgICAgYmx1ZUJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGJsdWVCYW5kTWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICBfc2NlbmUuYWRkKGJsdWVCYW5kTWVzaCk7CgogICAgICAgIC8vIEdvbGQgQmFuZCAoc2hvd24gd2hlbiBhd2F5IHRlYW0gaGFzIGJhbGwpCiAgICAgICAgY29uc3QgZ29sZEJhbmRUZXggPSBiYW5kVGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL01abjI4ZGdxL0dvbGQtYmFuZC5wbmcnKTsKICAgICAgICBnb2xkQmFuZFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGdvbGRCYW5kVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC5yZXBlYXQuc2V0KDEsIDEpOwoKICAgICAgICBjb25zdCBnb2xkQmFuZE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogZ29sZEJhbmRUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CmNvbnN0IGdvbGRCYW5kR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCAzLCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgZ29sZEJhbmRNZXNoID0gbmV3IFRIUkVFLk1lc2goZ29sZEJhbmRHZW8sIGdvbGRCYW5kTWF0KTsKICAgICAgICBnb2xkQmFuZE1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgZ29sZEJhbmRNZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICBfc2NlbmUuYWRkKGdvbGRCYW5kTWVzaCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPSBibHVlQmFuZE1lc2g7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID0gZ29sZEJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0ID0gYmx1ZUJhbmRNYXQ7CiAgICAgICAgd2luZG93LmZsdXguZ29sZEJhbmRNYXQgPSBnb2xkQmFuZE1hdDsKCiAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gPSBmdW5jdGlvbihob21lSGFzQmFsbCkgewogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNZXNoICYmIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSBob21lSGFzQmFsbDsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaC52aXNpYmxlID0gIWhvbWVIYXNCYWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMgPSB7CiAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gLS0tIDQuIFZFUlRJQ0FMIEFSUk9XIFNUUklQUyAoQXJvdW5kIHNwaGVyZSwgYWJvdmUgJiBiZWxvdyBiYW5kKSAtLS0KICAgICAgICBjb25zdCBhcnJvd1RleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgYXJyb3dUZXggPSBhcnJvd1RleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9kUWhQSzRnUS9ZZWxsb3dhcnJvd3MucG5nJyk7CiAgICAgICAgYXJyb3dUZXgud3JhcFMgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGFycm93VGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gQ3JlYXRlIHZlcnRpY2FsIGFycm93IHN0cmlwcyBhcm91bmQgdGhlIHNwaGVyZSAoY3VydmVkIHRvIG1hdGNoIHNwaGVyZSBzdXJmYWNlKQogICAgICAgIGNvbnN0IGFycm93R3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBjb25zdCBudW1BcnJvd3MgPSAxNjsgICAvLyBOdW1iZXIgb2YgYXJyb3cgc3RyaXBzIGFyb3VuZCBjaXJjdW1mZXJlbmNlCiAgICAgICAgY29uc3QgYXJyb3dIZWlnaHQgPSAzMDsgLy8gSGVpZ2h0IG9mIGVhY2ggYXJyb3cgc3RyaXAKICAgICAgICBjb25zdCBhcnJvd1dpZHRoID0gNjsgICAvLyBXaWR0aCBvZiBlYWNoIHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dSYWRpdXMgPSBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NDsKCiAgICAgICAgY29uc3QgbWFrZUN1cnZlZFN0cmlwID0gKGJhc2VBbmdsZSwgeUNlbnRlciwgZmxpcFYgPSBmYWxzZSkgPT4gewogICAgICAgICAgICAvLyBNb3JlIHNlZ21lbnRzID0gc21vb3RoZXIgY3VydmF0dXJlIChrZWVwIG1vZGVzdCBmb3IgbW9iaWxlKQogICAgICAgICAgICBjb25zdCBzZWdXID0gNjsgICAvLyBjdXJ2YXR1cmUgcmVzb2x1dGlvbiAod2lkdGgpCiAgICAgICAgICAgIGNvbnN0IHNlZ0ggPSAxODsgIC8vIHZlcnRpY2FsIHJlc29sdXRpb24gKGhlaWdodCkKCiAgICAgICAgICAgIC8vIENvbnZlcnQgZGVzaXJlZCB3b3JsZC1zcGFjZSB3aWR0aCBpbnRvIGFuIGFuZ3VsYXIgc3BhbiBvbiB0aGUgc3BoZXJlCiAgICAgICAgICAgIGNvbnN0IHBoaVNwYW4gPSBhcnJvd1dpZHRoIC8gYXJyb3dSYWRpdXM7IC8vIHJhZGlhbnMgKGFwcHJveCBhdCBlcXVhdG9yKQogICAgICAgICAgICBjb25zdCBwaGkwID0gYmFzZUFuZ2xlIC0gcGhpU3BhbiAqIDAuNTsKICAgICAgICAgICAgY29uc3QgcGhpMSA9IGJhc2VBbmdsZSArIHBoaVNwYW4gKiAwLjU7CgogICAgICAgICAgICBjb25zdCB5MCA9IHlDZW50ZXIgLSBhcnJvd0hlaWdodCAqIDAuNTsKICAgICAgICAgICAgY29uc3QgeTEgPSB5Q2VudGVyICsgYXJyb3dIZWlnaHQgKiAwLjU7CgogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICAgICAgY29uc3Qgbm9ybWFscyA9IFtdOwogICAgICAgICAgICBjb25zdCB1dnMgPSBbXTsKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8PSBzZWdIOyBpeSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2ID0gaXkgLyBzZWdIOwogICAgICAgICAgICAgICAgY29uc3QgeSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHkwLCB5MSwgdik7CgogICAgICAgICAgICAgICAgLy8gQ2lyY2xlIHJhZGl1cyBhdCB0aGlzIGhlaWdodCBvbiB0aGUgc3BoZXJlICh4L3ogc2hyaW5rIGFzIHx5fCBncm93cykKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdSID0gTWF0aC5zcXJ0KE1hdGgubWF4KDAuMDAwMDEsIGFycm93UmFkaXVzICogYXJyb3dSYWRpdXMgLSB5ICogeSkpOwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPD0gc2VnVzsgaXgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHUgPSBpeCAvIHNlZ1c7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGhpID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAocGhpMCwgcGhpMSwgdSk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLnNpbihwaGkpICogcmluZ1I7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguY29zKHBoaSkgKiByaW5nUjsKCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2goeCwgeSwgeik7CgogICAgICAgICAgICAgICAgICAgIC8vIE91dHdhcmQgbm9ybWFsIGZvciBhIHNwaGVyZSBjZW50ZXJlZCBhdCBvcmlnaW4KICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnZMZW4gPSAxLjAgLyBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgICAgICAgICAgICAgICAgICBub3JtYWxzLnB1c2goeCAqIGludkxlbiwgeSAqIGludkxlbiwgeiAqIGludkxlbik7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZ2ID0gZmxpcFYgPyAoMSAtIHYpIDogdjsKICAgICAgICAgICAgICAgICAgICB1dnMucHVzaCh1LCB2dik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHNlZ1cgKyAxOwogICAgICAgICAgICBmb3IgKGxldCBpeSA9IDA7IGl5IDwgc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IHNlZ1c7IGl4KyspIHsKY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGl5ICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYyA9IChpeSArIDEpICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZCA9IChpeSArIDEpICogcm93ICsgKGl4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ZX09GRlNFVCA6IC0xOC4wOwoKICAgICAgICAgICAgY29uc3QgZ29hbFNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFIDogNDUuMDsKICAgICAgICAgICAgY29uc3Qgc3ggPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9YIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1opICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWiA6IDEuMDsKICAgICAgICAgICAgCmdvYWxBLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCmdvYWxCLnBvc2l0aW9uLnNldCgwLCBnb2FsWSwgZ29hbERpc3QpOwppZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxCLnNjYWxlLnNldChnb2FsU2NhbGUgKiBzeCwgZ29hbFNjYWxlICogc3ksIGdvYWxTY2FsZSAqIHN6KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9Ci8vIE5FVzogVGFja2xlL1NwcmludCBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBPZmZlbnNlOiBTcHJpbnQvQnJlYWsgKEluc3RhbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zZTogU3RhcnQgQ2hhcmdlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5pc1RhY2tsZUNoYXJnaW5nICYmICFwLmlzVGFja2xpbmcgJiYgIXAuaXNSZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBFdmFkZSBvbiAnRScKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0tleUUnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLmV2YWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgCiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IGZhbHNlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5FVzogUmVsZWFzZSBUYWNrbGUgb24gU2hpZnQgVXAKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmIHAuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7IAogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwpjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcyA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGwpIHAudGhyb3dCYWxsKGJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQoKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7Cgpjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gREVGRU5TRTogQmxvY2sKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsICYmICFwLmlzRGFzaGluZyAmJiAhcC5pc0V2YWRpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDAgJiYgcC5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgpsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrOiBJbnB1dCBSaXBwbGUKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQovLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CmhhbmRsZUFpbUVuZCgpOwppZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCi8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKICAgICAgICBsZXQgaG9sZFRpbWVyID0gbnVsbDsKICAgICAgICBsZXQgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IGxhc3RUYXBUaW1lID0gMDsKICAgICAgICBjb25zdCBIT0xEX1RIUkVTSE9MRCA9IDIwMDsgLy8gbXMKICAgICAgICBjb25zdCBET1VCTEVfVEFQX1RIUkVTSE9MRCA9IDMwMDsgLy8gbXMKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgYnViYmxpbmcgdG8gam95c3RpY2sKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjazogSW5wdXQgUmlwcGxlCiAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNsaWVudFggPSBlLmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjbGllbnRZID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEhvbGQgU3RhdGUKICAgICAgICAgICAgaXNIb2xkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChob2xkVGltZXIpIGNsZWFyVGltZW91dChob2xkVGltZXIpOwoKICAgICAgICAgICAgLy8gU3RhcnQgSG9sZCBUaW1lcgogICAgICAgICAgICBob2xkVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBPbmx5IGNoYXJnZSBpZiB3ZSBkb24ndCBoYXZlIHRoZSBiYWxsIChEZWZlbnNpdmUgVGFja2xlKQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0VGFja2xlQ2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOyAvLyBWaXN1YWwgY3VlIGZvciBjaGFyZ2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgSE9MRF9USFJFU0hPTEQpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgaWYgKGlzSG9sZGluZykgewogICAgICAgICAgICAgICAgLy8gLS0tIEhPTEQgUkVMRUFTRSAoQ2hhcmdlZCBUYWNrbGUpIC0tLQogICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VUYWNrbGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIFRBUCAoVGFja2xlIC8gRXZhZGUpIC0tLQogICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVTaW5jZUxhc3QgPSBub3cgLSBsYXN0VGFwVGltZTsKCiAgICAgICAgICAgICAgICBpZiAodGltZVNpbmNlTGFzdCA8IERPVUJMRV9UQVBfVEhSRVNIT0xEKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIERPVUJMRSBUQVA6IEVWQURFIC0tLQogICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIGNhbmNlbCBkYXNoIGlmIGFjdGl2ZSB0byBhbGxvdyBpbW1lZGlhdGUgZXZhZGUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcgfHwgcC5kYXNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcC5ldmFkZSgpOwogICAgICAgICAgICAgICAgICAgIGxhc3RUYXBUaW1lID0gMDsgLy8gUmVzZXQgdG8gcHJldmVudCB0cmlwbGUtdGFwIGlzc3VlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gU0lOR0xFIFRBUDogVEFDS0xFIC8gQlJFQUsgLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5zaXZlIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vdCBtb3ZpbmcsIGRhc2ggZm9yd2FyZCByZWxhdGl2ZSB0byBwbGF5ZXIgZmFjaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChkYXNoWCwgZGFzaFopOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgcC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9mZmVuc2l2ZSBCcmVhayBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGFzdFRhcFRpbWUgPSBub3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoaXNIb2xkaW5nIHx8IGhvbGRUaW1lcikgaGFuZGxlRW5kKGUpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwpfYXVkaW9NYW5hZ2VyLnNldE1hc3RlclZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUlucHV0VmVjdG9yKCkgewogICAgICAgIGxldCB4ID0gX2lucHV0LnggfHwgMDsKICAgICAgICBsZXQgeiA9IF9pbnB1dC55IHx8IDA7CgogICAgICAgIGlmIChfa2V5c1sndyddIHx8IF9rZXlzWydBcnJvd1VwJ10pIHogLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ3MnXSB8fCBfa2V5c1snQXJyb3dEb3duJ10pIHogKz0gMTsKICAgICAgICBpZiAoX2tleXNbJ2EnXSB8fCBfa2V5c1snQXJyb3dMZWZ0J10pIHggLT0gMTsKICAgICAgICBpZiAoX2tleXNbJ2QnXSB8fCBfa2V5c1snQXJyb3dSaWdodCddKSB4ICs9IDE7CgogICAgICAgIGNvbnN0IGxlblNxID0geCp4ICsgeip6OwogICAgICAgIGlmIChsZW5TcSA+IDEpIHsKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KGxlblNxKTsKICAgICAgICAgICAgeCAvPSBsZW47CiAgICAgICAgICAgIHogLz0gbGVuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzTmFOKHgpKSB4ID0gMDsKICAgICAgICBpZiAoaXNOYU4oeikpIHogPSAwOwoKICAgICAgICBpZiAoX2NhbWVyYSkgewogICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwoKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LnNldCgxLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIGxldCB3b3JsZFggPSAoX2NhbUZ3ZC54ICogLXopICsgKF9jYW1SaWdodC54ICogeCk7CiAgICAgICAgbGV0IHdvcmxkWiA9IChfY2FtRndkLnogKiAteikgKyAoX2NhbVJpZ2h0LnogKiB4KTsKCiAgICAgICAgaWYgKGlzTmFOKHdvcmxkWCkgfHwgaXNOYU4od29ybGRaKSkgewogICAgICAgICAgICB3b3JsZFggPSAwOwogICAgICAgICAgICB3b3JsZFogPSAwOwogICAgICAgIH0KCmlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAvLyBGSVg6IE9ubHkgYWxsb3cgbW92ZW1lbnQgaWYgZ2FtZSBpcyBhY3RpdmUgb3IgaW4gcHJhY3RpY2UKICAgICAgICAgICAgY29uc3QgZ20gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGNhbk1vdmUgPSBnbSAmJiAhZ20uaXNEZW1vTW9kZSAmJiAoZ20uc3RhdGUgPT09ICdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChjYW5Nb3ZlKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cn0KCiAgICBmdW5jdGlvbiBjcmVhdGVSaXBwbGUoeCwgeSkgewogICAgICAgIGNvbnN0IHJpcHBsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJpcHBsZS5jbGFzc05hbWUgPSAndG91Y2gtcmlwcGxlJzsKICAgICAgICByaXBwbGUuc3R5bGUubGVmdCA9IGAke3h9cHhgOwogICAgICAgIHJpcHBsZS5zdHlsZS50b3AgPSBgJHt5fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChyaXBwbGUpOwoKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKHJpcHBsZS5wYXJlbnROb2RlKSByaXBwbGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyaXBwbGUpOwogICAgICAgIH0sIDYwMCk7CgogICAgfQoKICAgIC8vIE5FVzogVmlzdWFsIFN3aXBlIFRyYWlsCiAgICBmdW5jdGlvbiBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpIHsKICAgICAgICBjb25zdCBkb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkb3QuY2xhc3NOYW1lID0gJ3N3aXBlLXRyYWlsLWRvdCc7CiAgICAgICAgZG90LnN0eWxlLmxlZnQgPSBgJHt4IC0gNn1weGA7IC8vIENlbnRlciAoMTJweCB3aWR0aCkKICAgICAgICBkb3Quc3R5bGUudG9wID0gYCR7eSAtIDZ9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgCiAgICAgICAgLy8gQ1NTIGFuaW1hdGlvbiBoYW5kbGVzIHJlbW92YWwsIGJ1dCB3ZSBjbGVhbiB1cCBET00gdG8gYmUgc2FmZQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoZG90LnBhcmVudE5vZGUpIGRvdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRvdCk7CiAgICAgICAgfSwgNTAwKTsKICAgIH0KCmZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgICAgICAvLyBGb3JjZSBpbW1lZGlhdGUgY2FtZXJhIHVwZGF0ZSB0byBwcmV2ZW50IGp1bXAKICAgICAgICAgICAgaWYgKF9jYW1lcmFNYW5hZ2VyKSBfY2FtZXJhTWFuYWdlci51cGRhdGUoMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkIGZvciBwZXJmb3JtYW5jZQovLyBQZXJmb3JtYW5jZSBPcHRpbWl6YXRpb246IENhcCByZXNvbHV0aW9uCmNvbnN0IG1heERpbWVuc2lvbiA9IDQ4MDsgLy8gSGFyZCBjYXAgb24gaW50ZXJuYWwgcmVuZGVyIHJlc29sdXRpb24gKFJlZHVjZWQgZm9yIHBlcmZvcm1hbmNlKQogICAgICAgIGNvbnN0IGN1cnJlbnRNYXggPSBNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBsZXQgcmVzU2NhbGUgPSAwLjUwOyAvLyBCYXNlIHNjYWxlCiAgICAgICAgCiAgICAgICAgaWYgKGN1cnJlbnRNYXggKiByZXNTY2FsZSA+IG1heERpbWVuc2lvbikgewogICAgICAgICAgICByZXNTY2FsZSA9IG1heERpbWVuc2lvbiAvIGN1cnJlbnRNYXg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwppZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgICAgICBpZiAoX3Bvc3RQcm9jZXNzaW5nKSBfcG9zdFByb2Nlc3Npbmcuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQpOwogICAgICAgIH0KICAgIH0KCi8vIC0tLSBGSVhFRCBUSU1FU1RFUCBWQVJJQUJMRVMgLS0tCiAgICBsZXQgX2FjY3VtdWxhdG9yID0gMDsKICAgIGNvbnN0IF9maXhlZFN0ZXAgPSAxIC8gNjA7CgogICAgZnVuY3Rpb24gYW5pbWF0ZSgpIHsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIGNvbnN0IHJhd0R0ID0gX2Nsb2NrLmdldERlbHRhKCk7CiAgICAgICAgLy8gQ2xhbXAgZHQgdG8gcHJldmVudCBzcGlyYWxzIChtYXggMC4xcykKICAgICAgICBjb25zdCBkdCA9IE1hdGgubWluKHJhd0R0LCAwLjEpICogKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXgudGltZVNjYWxlIDogMC44KTsKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KCiAgICAgICAgLy8gSW1wYWN0IEZyYW1lcyAoRnJlZXplIEZyYW1lIEVmZmVjdCkKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRklYRUQgVVBEQVRFIExPT1AgKFBoeXNpY3MgJiBHYW1lIExvZ2ljKSAtLS0KICAgICAgICBfYWNjdW11bGF0b3IgKz0gZHQ7CiAgICAgICAgLy8gU2FmZXR5IENhcDogUHJldmVudCBzcGlyYWwgb2YgZGVhdGggaWYgZnJhbWUgdGFrZXMgdG9vIGxvbmcKaWYgKF9hY2N1bXVsYXRvciA+IDAuMSkgX2FjY3VtdWxhdG9yID0gMC4xOyAvLyBDYXAgYXQgMTAwbXMgdG8gcHJldmVudCBzcGlyYWwgb2YgZGVhdGgKCiAgICAgICAgd2hpbGUgKF9hY2N1bXVsYXRvciA+PSBfZml4ZWRTdGVwKSB7CiAgICAgICAgICAgIGNvbnN0IF9zZHQgPSBfZml4ZWRTdGVwOwoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIElmIGluIEFzc2V0IEZvcmdlIG1vZGUsIHNraXAgZ2FtZSBsb2dpYwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0ZvcmdlTW9kZSkgewogICAgICAgICAgICAgICAgX2FjY3VtdWxhdG9yID0gMDsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcyAoUGh5c2ljcy9BSSkKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYmFsbC51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwgTGFiCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5iYWxsTGFiICYmIHR5cGVvZiB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgVXBkYXRlcnMgKGUuZy4gUmluZ3MgbG9naWMpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCB1aSA9IDA7IHVpIDwgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGg7IHVpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmbiA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnNbdWldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpIGZuKF9zZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBfYWNjdW11bGF0b3IgLT0gX2ZpeGVkU3RlcDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIExPT1AgKE9uY2UgUGVyIEZyYW1lKSAtLS0KICAgICAgICAvLyBUaGVzZSBzeXN0ZW1zIGRvbid0IGFmZmVjdCBnYW1lcGxheSBvdXRjb21lLCBzbyB3ZSB1cGRhdGUgdGhlbSB3aXRoIHRoZSB2aXN1YWwgZGVsdGEgYGR0YAogICAgICAgIC8vIHRvIGVuc3VyZSBzbW9vdGggYW5pbWF0aW9uIGF0IGhpZ2ggcmVmcmVzaCByYXRlcyAoOTAvMTIwSHopIHdpdGhvdXQgd2FzdGluZyBDUFUgb24gcGh5c2ljcy4KCiAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgIGNvbnN0IGlzTWVudSA9IGdtU3RhdGUgPT09ICdtZW51JzsKCiAgICAgICAgLy8gQ2FtZXJhCiAgICAgICAgaWYgKCFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgdXBkYXRlQ2FtZXJhTG9naWMoZHQpOwogICAgICAgIH0KCiAgICAgICAgLy8gVmlzdWFsIEZYIFN5c3RlbXMKICAgICAgICBpZiAoX3dhdGVyT3ZlcmxheSkgX3dhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfbGlnaHRTaGFmdHMpIF9saWdodFNoYWZ0cy51cGRhdGUoZHQpOwogICAgICAgIGlmIChfc3RhZGl1bSkgX3N0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwoKaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogNC4wKTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYUdyb3VwKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAucm90YXRpb24ueSArPSBkdCAqIDAuMDU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7CiAgICAgICAgICAgIGlmIChfYmFsbCAmJiBfYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIudGVhbSAmJiBfYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMudUNvbG9yLnZhbHVlLmxlcnAodGFyZ2V0Q29sb3IsIGR0ICogMi4wKTsKICAgICAgICB9CgogICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICBfcGFydGljbGVVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICB9CgogICAgICAgIC8vIFJlbmRlcgovLyBSZW5kZXIKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIF9wb3N0UHJvY2Vzc2luZy5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhLCBkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVVSSgpIHsKICAgICAgICAvLyBQcmV2ZW50IFVJIHVwZGF0ZXMgZHVyaW5nIGludHJvIHRvIGtlZXAgdGhpbmdzIGhpZGRlbgogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSByZXR1cm47CgogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkJMT0NLIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJCTE9DSyI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgLy8gRW5zdXJlIHZpc3VhbCBmZWVkYmFjawogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIkRFRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKZnVuY3Rpb24gY2hlY2tCYWxsR3JhYihlbnRpdHkpIHsKICAgICAgICBpZiAoIWVudGl0eS5jYW5DYXRjaCkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbCAmJiAhX2JhbGwuaXNDYXRjaGFibGUoKSkgcmV0dXJuOwogICAgICAgIGlmIChlbnRpdHkuc3R1blRpbWVyID4gMCB8fCAoZW50aXR5LnN0YXR1cyAmJiBlbnRpdHkuc3RhdHVzLm5hcCA+IDApKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsLnN0YXRlICE9PSAnZnJlZScpIHJldHVybjsKICAgICAgICBpZiAoIV9iYWxsLm1lc2ggfHwgIWVudGl0eS5tZXNoKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJhbGxQb3MgPSBfYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGVudFBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwoKICAgICAgICBjb25zdCBkeCA9IGJhbGxQb3MueCAtIGVudFBvcy54OwogICAgICAgIGNvbnN0IGR6ID0gYmFsbFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopOwogICAgICAgIGNvbnN0IGRpc3RZID0gTWF0aC5hYnMoYmFsbFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICAvLyAtLS0gUkVMQVhFRCBUT0xFUkFOQ0VTIEZPUiBFQVNJRVIgUElDS1VQIC0tLQogICAgICAgIGNvbnN0IHRvdWNoUmFkaXVzID0gMS41OyAvLyBJbmNyZWFzZWQgZnJvbSAxLjAgKEF1dG8tZ3JhYiByYWRpdXMpCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDMuNTsgIC8vIEluY3JlYXNlZCBmcm9tIDEuOCAoTWFnbmV0aWMgcmFkaXVzKQogICAgICAgIGxldCBpbnRlcmFjdGlvblJhZGl1cyA9IDYuMDsgLy8gSW5jcmVhc2VkIGZyb20gMy41IChUdXJuLXRvIHJhZGl1cykKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSA2LjA7ICAgLy8gSW5jcmVhc2VkIGZyb20gMy4wIChWZXJ0aWNhbCByZWFjaCkKCiAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgbWFnbmV0UmFkaXVzID0gNC41OwogICAgICAgICAgICBpbnRlcmFjdGlvblJhZGl1cyA9IDcuMDsKICAgICAgICAgICAgY2F0Y2hIZWlnaHQgPSA3LjA7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlzdFhaID4gaW50ZXJhY3Rpb25SYWRpdXMgfHwgZGlzdFkgPiBjYXRjaEhlaWdodCkgcmV0dXJuOwoKICAgICAgICAvLyBPcHRpbWl6YXRpb246IFVzZSBzaGFyZWQgdmVjdG9ycyB0byBhdm9pZCBHQwogICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGxQb3MpLnN1YihlbnRQb3MpLm5vcm1hbGl6ZSgpOyAvLyB0b0JhbGwKICAgICAgICBfdGVtcFZlYzIuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihlbnRpdHkubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsgLy8gcGxheWVyRm9yd2FyZAoKICAgICAgICBjb25zdCBmYWNpbmdEb3QgPSBfdGVtcFZlYzIuZG90KF90ZW1wVmVjMSk7CgogICAgICAgIGNvbnN0IGNvbmVUaHJlc2hvbGQgPSAtMC40OyAvLyBNb3JlIGdlbmVyb3VzIGNvbmUgKHdhcyAtMC4yKQogICAgICAgIGNvbnN0IGlzSW5Db25lID0gZmFjaW5nRG90ID4gY29uZVRocmVzaG9sZDsKICAgICAgICAKICAgICAgICAvLyBBVVRPLVRVUk46IElmIG5lYXIgYnV0IGZhY2luZyB3cm9uZyB3YXksIHR1cm4gdG93YXJkcyBiYWxsCiAgICAgICAgaWYgKGRpc3RYWiA8IGludGVyYWN0aW9uUmFkaXVzICYmICFpc0luQ29uZSkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRBbmdsZSA9IE1hdGguYXRhbjIoX3RlbXBWZWMxLngsIF90ZW1wVmVjMS56KTsKICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIHRhcmdldEFuZ2xlKTsKICAgICAgICAgICAgZW50aXR5Lm1lc2gucXVhdGVybmlvbi5zbGVycChxLCAwLjIpOyAvLyBGYXN0ZXIgdHVybiAod2FzIDAuMSkKICAgICAgICAgICAgaWYgKGVudGl0eS5zeW5jUm90YXRpb24pIGVudGl0eS5zeW5jUm90YXRpb24oKTsKICAgICAgICB9CgogICAgICAgIC8vIEdSQUIgTE9HSUMKICAgICAgICAvLyAxLiBUb3VjaDogVmVyeSBjbG9zZSAoaWdub3JlIGZhY2luZyAtIHByZXZlbnRzIHJ1bm5pbmcgb3ZlciBiYWxsKQogICAgICAgIC8vIDIuIE1hZ25ldDogQ2xvc2UgYW5kIGZhY2luZwogICAgICAgIGNvbnN0IGlzVG91Y2ggPSBkaXN0WFogPCB0b3VjaFJhZGl1czsKICAgICAgICBjb25zdCBpc01hZ25ldCA9IGRpc3RYWiA8IG1hZ25ldFJhZGl1cyAmJiBpc0luQ29uZTsKCiAgICAgICAgaWYgKGlzVG91Y2ggfHwgaXNNYWduZXQpIHsKICAgICAgICAgICAgLy8gQkxBU1QgVEhST1VHSCBMT0dJQwogICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSBfYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgbGV0IGNhdGNoQ2hhbmNlID0gMS4wOwoKICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCAoZS5nLiA+IDIwKSwgY2hlY2sgQ0EKICAgICAgICAgICAgaWYgKGJhbGxTcGVlZCA+IDIwLjApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICAvLyBEaWZmaWN1bHR5IHNjYWxlcyB3aXRoIHNwZWVkLiAKICAgICAgICAgICAgICAgIGNvbnN0IGRpZmZpY3VsdHkgPSBiYWxsU3BlZWQgKiAxLjI7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlmZmljdWx0eSA+IGNhKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAwLjQgKyAoY2EgLyBkaWZmaWN1bHR5KSAqIDAuNjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQb2ludCBCbGFuayBQZW5hbHR5OiBIYXJkZXIgdG8gcmVhY3QgaWYgYmFsbCBpcyByaWdodCBvbiB0b3Agb2YgeW91IG1vdmluZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA8IDEuMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSAqPSAwLjY7IC8vIEJsYXN0IHRocm91Z2ggbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSBjYXRjaENoYW5jZSArPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoX2JhbGwucG93ZXJUeXBlID09PSAnU0gnICYmIF9iYWxsLnBvd2VyID4gMTUuMCkgewogICAgICAgICAgICAgICAgLy8gU2hvdCBwb3dlciBjaGVjawogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIGlmIChfYmFsbC5wb3dlciA+IGNhICogMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gTWF0aC5taW4oMC43LCAoX2JhbGwucG93ZXIgLSBjYSkgKiAwLjA0KTsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDEuMCAtIGNoYW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGZ1bWJsZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IGNhdGNoQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICBmdW1ibGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnVtYmxlKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBmZWVkYmFjayBmb3IgYmxhc3QgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMQVNUIFRIUk9VR0ghIiwgZW50UG9zLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKZW50aXR5LmNhdGNoQ29vbGRvd24gPSAxLjA7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gU3BpbiAmIGN1cnZlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTUElOX0RSQUc6IDAuNCwKICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgTUFHTlVTX0NBUDogNjAsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gRGVwdGggY29uc3RyYWludAogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAsCiAgICAgICAgREVQVEhfU1BSSU5HOiAxLAogICAgICAgIERFUFRIX0RBTVA6IDEuNSwKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBBcmVuYSBib3VuZGFyeQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgQk9VTkRBUllfUkFESVVTOiA0NiwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgU2V0dGluZ3MKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LAogICAgICAgIEdPQUxfWV9PRkZTRVQ6IC0yLjMxLAogICAgICAgIEdPQUxfU0NBTEU6IDQ1LAogICAgICAgIEdPQUxfU0NBTEVfWDogMS4zNDU2LAogICAgICAgIEdPQUxfU0NBTEVfWTogMSwKICAgICAgICBHT0FMX1NDQUxFX1o6IDEsCiAgICAgICAgCiAgICAgICAgLy8gR29hbCBUcmlnZ2VyIChIaXRib3gpCiAgICAgICAgR09BTF9UUklHR0VSX1RPUF9ZOiA5LjE1NTUsCiAgICAgICAgR09BTF9UUklHR0VSX0JPVFRPTV9ZOiAtNC4zNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9XSURUSDogMTcuMSwKICAgICAgICBHT0FMX1RSSUdHRVJfT0ZGU0VUOiAxLAoKICAgICAgICAvLyBHb2FsIFBvY2tldAogICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgR09BTF9QT0NLRVRfWDogMTIsCiAgICAgICAgR09BTF9QT0NLRVRfWjogNDAsCiAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA1NSwKCiAgICAgICAgLy8gV2FsbHMKICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLAogICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAsCiAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMsCiAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gVGhyb3cgbWFwcGluZwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLAogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1CiAgICB9OwoKCiAgICAKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOyAvLyBMb2NhbCBhbGlhcyBmb3IgYnJldml0eQogICAgLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQovLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCiAgICBjbGFzcyBUcmFpbFJlbmRlcmVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSAzMDsgLy8gTW9yZSBzZWdtZW50cyBmb3Igc21vb3RoZXIgY3VydmVzCiAgICAgICAgICAgIHRoaXMucG9pbnRzID0gW107CnRoaXMuYmFzZVdpZHRoID0gMC44OyAvLyBJbmNyZWFzZWQgd2lkdGggZm9yIHZpc2liaWxpdHkKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggPSAwLjg7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHZW9tZXRyeQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCBwb3NEYXRhID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLnNlZ21lbnRzICogMiAqIDMpOwogICAgICAgICAgICBnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShwb3NEYXRhLCAzKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbmRpY2VzCiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHMtMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlID0gaSoyOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UsIGJhc2UrMSwgYmFzZSsyKTsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlKzEsIGJhc2UrMywgYmFzZSsyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyeS5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBhYWZmLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC45LCAvLyBJbmNyZWFzZWQgb3BhY2l0eQogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXQgcG9pbnRzCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHMucHVzaChuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJldXNhYmxlIHRlbXBzIChhdm9pZCBwZXItZnJhbWUgYWxsb2NhdGlvbnMgb24gbW9iaWxlKQogICAgICAgICAgICB0aGlzLl90bXBEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBUb0NhbSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmVzZXQocG9zKSB7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHNbaV0uY29weShwb3MpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNldENvbG9yKGhleCkgewogICAgICAgICAgICB0aGlzLm1hdGVyaWFsLmNvbG9yLnNldEhleChoZXgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoY3VycmVudFBvcywgc3BlZWRSYXRpbyA9IDAuMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgovLyBEeW5hbWljIFdpZHRoIGJhc2VkIG9uIHNwZWVkIEFORCBTUElOIChQb3dlciBWaXN1YWwpCiAgICAgICAgICAgIC8vIEZhc3QgYmFsbCA9IFRoaWNrZXIuIFNwaW5uaW5nIGJhbGwgPSBFdmVuIFRoaWNrZXIuCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHNwaW5SYXRpbyA9IGJhbGwgPyBNYXRoLm1pbigxLjAsIGJhbGwuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpIC8gMzAuMCkgOiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdGFyZ2V0V2lkdGggPSB0aGlzLmJhc2VXaWR0aCAqICgwLjggKyBzcGVlZFJhdGlvICogMS4yICsgc3BpblJhdGlvICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggKz0gKHRhcmdldFdpZHRoIC0gdGhpcy5jdXJyZW50V2lkdGgpICogMC4yOyAvLyBTbW9vdGggdHJhbnNpdGlvbgoKICAgICAgICAgICAgLy8gU2hpZnQgcG9pbnRzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlZ21lbnRzIC0gMTsgaSA+IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5wb2ludHNbaV0uY29weSh0aGlzLnBvaW50c1tpLTFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnBvaW50c1swXS5jb3B5KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGVHZW9tZXRyeSgpIHsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIGNvbnN0IGNhbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEgOiBudWxsOwogICAgICAgICAgICBpZiAoIWNhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjYW1Qb3MgPSBjYW0ucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHRlbXBEaXIgPSB0aGlzLl90bXBEaXI7CiAgICAgICAgICAgIGNvbnN0IHRlbXBUb0NhbSA9IHRoaXMuX3RtcFRvQ2FtOwogICAgICAgICAgICBjb25zdCB0ZW1wUmlnaHQgPSB0aGlzLl90bXBSaWdodDsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9pbnRzW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUYXBlciB3aWR0aCBhbG9uZyB0cmFpbCBsZW5ndGgKICAgICAgICAgICAgICAgIGNvbnN0IHRhcGVyID0gMS4wIC0gTWF0aC5wb3coaSAvIHRoaXMuc2VnbWVudHMsIDIpOyAvLyBRdWFkcmF0aWMgdGFwZXIKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB0aGlzLmN1cnJlbnRXaWR0aCAqIHRhcGVyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBpZiAoaSA8IHRoaXMuc2VnbWVudHMgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ldLCB0aGlzLnBvaW50c1tpKzFdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ktMV0sIHRoaXMucG9pbnRzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlbXBEaXIubGVuZ3RoU3EoKSA8IDAuMDAwMSkgdGVtcERpci5zZXQoMCwgMSwgMCk7CiAgICAgICAgICAgICAgICB0ZW1wRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0ZW1wVG9DYW0uc3ViVmVjdG9ycyhjYW1Qb3MsIHApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGVtcFJpZ2h0LmNyb3NzVmVjdG9ycyh0ZW1wRGlyLCB0ZW1wVG9DYW0pLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDEKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAwXSA9IHAueCAtIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDFdID0gcC55IC0gdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMl0gPSBwLnogLSB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAyCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgM10gPSBwLnggKyB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA0XSA9IHAueSArIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDVdID0gcC56ICsgdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgIH0KdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDIGlzIGFscmVhZHkgZGVmaW5lZCBpbiB0aGUgb3V0ZXIgc2NvcGUKICAgIGNsYXNzIEJhbGwgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsgCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IG51bGw7IC8vIFRyYWNrIHdobyB0aHJldyBpdCBsYXN0IChmb3IgRVhQL0Fzc2lzdHMpCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7IC8vICdmcmVlJywgJ2hlbGQnLCAnbWFnbmV0aXplZCcKICAgICAgICAgICAgdGhpcy5pc0ludmlzaWJsZSA9IGZhbHNlOwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbHNhZmUgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7Cn0KCiAgICAgICAgaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3VwZGF0ZVBhcnRpY2xlcyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5fZ2hvc3QpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgdGhpcy5pc1JpY29jaGV0ID0gKHR5cGUgPT09ICdSSUNPQ0hFVCcgfHwgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ3JpY29jaGV0JykpOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CgovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweDAwZmYwMDsgLy8gR3JlZW4gKFZlbm9tKQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgY29sb3IgPSAweDg4ODg4ODsgLy8gR3JleQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnbmFwJykgY29sb3IgPSAweDAwMDA4ODsgLy8gRGFyayBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgogICAgICAgIApyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgIH0KaXNDYXRjaGFibGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPD0gMDsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFsVHJhbnNmb3JtcyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZGVmb3JtTm9kZSB8fCAhdGhpcy5zcGluTm9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gU3F1YXNoICYgU3RyZXRjaCBiYXNlZCBvbiB2ZWxvY2l0eQogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5zZXRGcm9tVW5pdFZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwwLDEpLCBkaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBmYWN0b3IgPSBNYXRoLm1pbihzcGVlZCAvIDQwLjAsIDEuMCk7IAogICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArIChmYWN0b3IgKiAwLjgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC8gTWF0aC5zcXJ0KHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmlkZW50aXR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBBcHBseSBBY2N1bXVsYXRlZCBTcGluCiAgICAgICAgICAgIGNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKCiAgICAgICAgICAgIC8vIDMuIFZpc3VhbCByb3RhdGlvbiBpbnRlZ3JhdGlvbgogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BpblNxID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BpblNwZWVkID0gTWF0aC5zcXJ0KHNwaW5TcSk7CiAgICAgICAgICAgICAgICBjb25zdCBheGlzID0gX3RlbXBWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKGF4aXMsIHNwaW5TcGVlZCAqIGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkuY3Jvc3MoX2F4aXNZKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cn0KICAgICAgICB9CgogICAgICAgIF9jaGVja0ZhaWxzYWZlcyhkdCkgewoKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IG1heFJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wKSArIDE1LjA7IC8vIEdlbmVyb3VzIGJ1ZmZlcgogICAgICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSAoQy5CT1VOREFSWV9IRUlHSFQgfHwgMjAuMCkgKyAxNS4wOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwb3MueCpwb3MueCArIHBvcy56KnBvcy56OwoKICAgICAgICAgICAgLy8gMS4gT3V0IG9mIEJvdW5kcyBDaGVjawogICAgICAgICAgICBpZiAoZGlzdFNxID4gbWF4UmFkaXVzKm1heFJhZGl1cyB8fCBNYXRoLmFicyhwb3MueSkgPiBtYXhIZWlnaHQpIHsKICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm91dE9mQm91bmRzVGltZXIgPiAxLjApIHsgLy8gMSBzZWNvbmQgT09CCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIE9PQiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBTdHVjayBDaGVjayAoRnJlZSAmIFN0YXRpb25hcnkpCiAgICAgICAgICAgIC8vIE9ubHkgY2hlY2sgaWYgZ2FtZSBpcyBhY3RpdmUgdG8gYXZvaWQgcmVzZXR0aW5nIGR1cmluZyBjdXRzY2VuZXMvbWVudXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiA0LjApIHsgLy8gNCBzZWNvbmRzIHN0YXRpb25hcnkKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgc3RhdGlvbmFyeS4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3JjZVJlc2V0VG9QbGF5KCkgewogICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7CgogICAgICAgICAgICAvLyBGaW5kIG5lYXJlc3QgcGxheWVyIHRvIHJlc2V0IHRvCiAgICAgICAgICAgIGxldCBuZWFyZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBsZXQgdGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7IC8vIERlZmF1bHQgY2VudGVyCgogICAgICAgICAgICBpZiAoZ2FtZSkgewogICAgICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGdhbWUudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lYXJlc3QgPSBwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChuZWFyZXN0ICYmIG5lYXJlc3QubWVzaCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllciBpcyB3aXRoaW4gcmVhc29uYWJsZSBib3VuZHMgYmVmb3JlIHRlbGVwb3J0aW5nIGJhbGwgdG8gdGhlbQogICAgICAgICAgICAgICAgY29uc3QgcFBvcyA9IG5lYXJlc3QubWVzaC5wb3NpdGlvbjsKaWYgKHBQb3MubGVuZ3RoU3EoKSA8IDYwKjYwKSB7IC8vIFdpdGhpbiA2MG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKG5lYXJlc3QubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuY29weShwUG9zKS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDIuMCkpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ID0gTWF0aC5tYXgoMCwgcFBvcy55ICsgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9Cn0KICAgIH0KCndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","./Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gU3BpbiAmIGN1cnZlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTUElOX0RSQUc6IDAuNCwKICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgTUFHTlVTX0NBUDogNjAsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gRGVwdGggY29uc3RyYWludAogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAsCiAgICAgICAgREVQVEhfU1BSSU5HOiAxLAogICAgICAgIERFUFRIX0RBTVA6IDEuNSwKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBBcmVuYSBib3VuZGFyeQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgQk9VTkRBUllfUkFESVVTOiA0NiwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgU2V0dGluZ3MKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LAogICAgICAgIEdPQUxfWV9PRkZTRVQ6IC0yLjMxLAogICAgICAgIEdPQUxfU0NBTEU6IDQ1LAogICAgICAgIEdPQUxfU0NBTEVfWDogMS4zNDU2LAogICAgICAgIEdPQUxfU0NBTEVfWTogMSwKICAgICAgICBHT0FMX1NDQUxFX1o6IDEsCiAgICAgICAgCiAgICAgICAgLy8gR29hbCBUcmlnZ2VyIChIaXRib3gpCiAgICAgICAgR09BTF9UUklHR0VSX1RPUF9ZOiA5LjE1NTUsCiAgICAgICAgR09BTF9UUklHR0VSX0JPVFRPTV9ZOiAtNC4zNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9XSURUSDogMTcuMSwKICAgICAgICBHT0FMX1RSSUdHRVJfT0ZGU0VUOiAxLAoKICAgICAgICAvLyBHb2FsIFBvY2tldAogICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgR09BTF9QT0NLRVRfWDogMTIsCiAgICAgICAgR09BTF9QT0NLRVRfWjogNDAsCiAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA1NSwKCiAgICAgICAgLy8gV2FsbHMKICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLAogICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAsCiAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMsCiAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gVGhyb3cgbWFwcGluZwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLAogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1CiAgICB9OwoKCiAgICAKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOyAvLyBMb2NhbCBhbGlhcyBmb3IgYnJldml0eQogICAgLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQovLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCiAgICBjbGFzcyBUcmFpbFJlbmRlcmVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSAzMDsgLy8gTW9yZSBzZWdtZW50cyBmb3Igc21vb3RoZXIgY3VydmVzCiAgICAgICAgICAgIHRoaXMucG9pbnRzID0gW107CnRoaXMuYmFzZVdpZHRoID0gMC44OyAvLyBJbmNyZWFzZWQgd2lkdGggZm9yIHZpc2liaWxpdHkKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggPSAwLjg7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHZW9tZXRyeQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCBwb3NEYXRhID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLnNlZ21lbnRzICogMiAqIDMpOwogICAgICAgICAgICBnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShwb3NEYXRhLCAzKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbmRpY2VzCiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHMtMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlID0gaSoyOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UsIGJhc2UrMSwgYmFzZSsyKTsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlKzEsIGJhc2UrMywgYmFzZSsyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyeS5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBhYWZmLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC45LCAvLyBJbmNyZWFzZWQgb3BhY2l0eQogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXQgcG9pbnRzCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHMucHVzaChuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJldXNhYmxlIHRlbXBzIChhdm9pZCBwZXItZnJhbWUgYWxsb2NhdGlvbnMgb24gbW9iaWxlKQogICAgICAgICAgICB0aGlzLl90bXBEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBUb0NhbSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmVzZXQocG9zKSB7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHNbaV0uY29weShwb3MpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNldENvbG9yKGhleCkgewogICAgICAgICAgICB0aGlzLm1hdGVyaWFsLmNvbG9yLnNldEhleChoZXgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoY3VycmVudFBvcywgc3BlZWRSYXRpbyA9IDAuMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgovLyBEeW5hbWljIFdpZHRoIGJhc2VkIG9uIHNwZWVkIEFORCBTUElOIChQb3dlciBWaXN1YWwpCiAgICAgICAgICAgIC8vIEZhc3QgYmFsbCA9IFRoaWNrZXIuIFNwaW5uaW5nIGJhbGwgPSBFdmVuIFRoaWNrZXIuCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHNwaW5SYXRpbyA9IGJhbGwgPyBNYXRoLm1pbigxLjAsIGJhbGwuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpIC8gMzAuMCkgOiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdGFyZ2V0V2lkdGggPSB0aGlzLmJhc2VXaWR0aCAqICgwLjggKyBzcGVlZFJhdGlvICogMS4yICsgc3BpblJhdGlvICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggKz0gKHRhcmdldFdpZHRoIC0gdGhpcy5jdXJyZW50V2lkdGgpICogMC4yOyAvLyBTbW9vdGggdHJhbnNpdGlvbgoKICAgICAgICAgICAgLy8gU2hpZnQgcG9pbnRzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlZ21lbnRzIC0gMTsgaSA+IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5wb2ludHNbaV0uY29weSh0aGlzLnBvaW50c1tpLTFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnBvaW50c1swXS5jb3B5KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGVHZW9tZXRyeSgpIHsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIGNvbnN0IGNhbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEgOiBudWxsOwogICAgICAgICAgICBpZiAoIWNhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjYW1Qb3MgPSBjYW0ucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHRlbXBEaXIgPSB0aGlzLl90bXBEaXI7CiAgICAgICAgICAgIGNvbnN0IHRlbXBUb0NhbSA9IHRoaXMuX3RtcFRvQ2FtOwogICAgICAgICAgICBjb25zdCB0ZW1wUmlnaHQgPSB0aGlzLl90bXBSaWdodDsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9pbnRzW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUYXBlciB3aWR0aCBhbG9uZyB0cmFpbCBsZW5ndGgKICAgICAgICAgICAgICAgIGNvbnN0IHRhcGVyID0gMS4wIC0gTWF0aC5wb3coaSAvIHRoaXMuc2VnbWVudHMsIDIpOyAvLyBRdWFkcmF0aWMgdGFwZXIKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB0aGlzLmN1cnJlbnRXaWR0aCAqIHRhcGVyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBpZiAoaSA8IHRoaXMuc2VnbWVudHMgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ldLCB0aGlzLnBvaW50c1tpKzFdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ktMV0sIHRoaXMucG9pbnRzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlbXBEaXIubGVuZ3RoU3EoKSA8IDAuMDAwMSkgdGVtcERpci5zZXQoMCwgMSwgMCk7CiAgICAgICAgICAgICAgICB0ZW1wRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0ZW1wVG9DYW0uc3ViVmVjdG9ycyhjYW1Qb3MsIHApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGVtcFJpZ2h0LmNyb3NzVmVjdG9ycyh0ZW1wRGlyLCB0ZW1wVG9DYW0pLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDEKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAwXSA9IHAueCAtIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDFdID0gcC55IC0gdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMl0gPSBwLnogLSB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAyCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgM10gPSBwLnggKyB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA0XSA9IHAueSArIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDVdID0gcC56ICsgdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgIH0KdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDIGlzIGFscmVhZHkgZGVmaW5lZCBpbiB0aGUgb3V0ZXIgc2NvcGUKICAgIGNsYXNzIEJhbGwgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsgCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IG51bGw7IC8vIFRyYWNrIHdobyB0aHJldyBpdCBsYXN0IChmb3IgRVhQL0Fzc2lzdHMpCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7IC8vICdmcmVlJywgJ2hlbGQnLCAnbWFnbmV0aXplZCcKICAgICAgICAgICAgdGhpcy5pc0ludmlzaWJsZSA9IGZhbHNlOwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbHNhZmUgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7Cn0KCiAgICAgICAgaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3VwZGF0ZVBhcnRpY2xlcyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5fZ2hvc3QpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgdGhpcy5pc1JpY29jaGV0ID0gKHR5cGUgPT09ICdSSUNPQ0hFVCcgfHwgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ3JpY29jaGV0JykpOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CgovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweDAwZmYwMDsgLy8gR3JlZW4gKFZlbm9tKQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgY29sb3IgPSAweDg4ODg4ODsgLy8gR3JleQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnbmFwJykgY29sb3IgPSAweDAwMDA4ODsgLy8gRGFyayBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgogICAgICAgIApyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgIH0KaXNDYXRjaGFibGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPD0gMDsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFsVHJhbnNmb3JtcyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZGVmb3JtTm9kZSB8fCAhdGhpcy5zcGluTm9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gU3F1YXNoICYgU3RyZXRjaCBiYXNlZCBvbiB2ZWxvY2l0eQogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5zZXRGcm9tVW5pdFZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwwLDEpLCBkaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBmYWN0b3IgPSBNYXRoLm1pbihzcGVlZCAvIDQwLjAsIDEuMCk7IAogICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArIChmYWN0b3IgKiAwLjgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC8gTWF0aC5zcXJ0KHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmlkZW50aXR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBBcHBseSBBY2N1bXVsYXRlZCBTcGluCiAgICAgICAgICAgIGNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKCiAgICAgICAgICAgIC8vIDMuIFZpc3VhbCByb3RhdGlvbiBpbnRlZ3JhdGlvbgogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BpblNxID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BpblNwZWVkID0gTWF0aC5zcXJ0KHNwaW5TcSk7CiAgICAgICAgICAgICAgICBjb25zdCBheGlzID0gX3RlbXBWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKGF4aXMsIHNwaW5TcGVlZCAqIGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkuY3Jvc3MoX2F4aXNZKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cn0KICAgICAgICB9CgogICAgICAgIF9jaGVja0ZhaWxzYWZlcyhkdCkgewoKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IG1heFJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wKSArIDE1LjA7IC8vIEdlbmVyb3VzIGJ1ZmZlcgogICAgICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSAoQy5CT1VOREFSWV9IRUlHSFQgfHwgMjAuMCkgKyAxNS4wOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwb3MueCpwb3MueCArIHBvcy56KnBvcy56OwoKICAgICAgICAgICAgLy8gMS4gT3V0IG9mIEJvdW5kcyBDaGVjawogICAgICAgICAgICBpZiAoZGlzdFNxID4gbWF4UmFkaXVzKm1heFJhZGl1cyB8fCBNYXRoLmFicyhwb3MueSkgPiBtYXhIZWlnaHQpIHsKICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm91dE9mQm91bmRzVGltZXIgPiAxLjApIHsgLy8gMSBzZWNvbmQgT09CCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIE9PQiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBTdHVjayBDaGVjayAoRnJlZSAmIFN0YXRpb25hcnkpCiAgICAgICAgICAgIC8vIE9ubHkgY2hlY2sgaWYgZ2FtZSBpcyBhY3RpdmUgdG8gYXZvaWQgcmVzZXR0aW5nIGR1cmluZyBjdXRzY2VuZXMvbWVudXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiA0LjApIHsgLy8gNCBzZWNvbmRzIHN0YXRpb25hcnkKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgc3RhdGlvbmFyeS4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3JjZVJlc2V0VG9QbGF5KCkgewogICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7CgogICAgICAgICAgICAvLyBGaW5kIG5lYXJlc3QgcGxheWVyIHRvIHJlc2V0IHRvCiAgICAgICAgICAgIGxldCBuZWFyZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBsZXQgdGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7IC8vIERlZmF1bHQgY2VudGVyCgogICAgICAgICAgICBpZiAoZ2FtZSkgewogICAgICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGdhbWUudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lYXJlc3QgPSBwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChuZWFyZXN0ICYmIG5lYXJlc3QubWVzaCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllciBpcyB3aXRoaW4gcmVhc29uYWJsZSBib3VuZHMgYmVmb3JlIHRlbGVwb3J0aW5nIGJhbGwgdG8gdGhlbQogICAgICAgICAgICAgICAgY29uc3QgcFBvcyA9IG5lYXJlc3QubWVzaC5wb3NpdGlvbjsKaWYgKHBQb3MubGVuZ3RoU3EoKSA8IDYwKjYwKSB7IC8vIFdpdGhpbiA2MG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKG5lYXJlc3QubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuY29weShwUG9zKS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDIuMCkpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ID0gTWF0aC5tYXgoMCwgcFBvcy55ICsgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9Cn0KICAgIH0KCndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","/Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gU3BpbiAmIGN1cnZlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTUElOX0RSQUc6IDAuNCwKICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgTUFHTlVTX0NBUDogNjAsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gRGVwdGggY29uc3RyYWludAogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAsCiAgICAgICAgREVQVEhfU1BSSU5HOiAxLAogICAgICAgIERFUFRIX0RBTVA6IDEuNSwKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBBcmVuYSBib3VuZGFyeQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgQk9VTkRBUllfUkFESVVTOiA0NiwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgU2V0dGluZ3MKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LAogICAgICAgIEdPQUxfWV9PRkZTRVQ6IC0yLjMxLAogICAgICAgIEdPQUxfU0NBTEU6IDQ1LAogICAgICAgIEdPQUxfU0NBTEVfWDogMS4zNDU2LAogICAgICAgIEdPQUxfU0NBTEVfWTogMSwKICAgICAgICBHT0FMX1NDQUxFX1o6IDEsCiAgICAgICAgCiAgICAgICAgLy8gR29hbCBUcmlnZ2VyIChIaXRib3gpCiAgICAgICAgR09BTF9UUklHR0VSX1RPUF9ZOiA5LjE1NTUsCiAgICAgICAgR09BTF9UUklHR0VSX0JPVFRPTV9ZOiAtNC4zNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9XSURUSDogMTcuMSwKICAgICAgICBHT0FMX1RSSUdHRVJfT0ZGU0VUOiAxLAoKICAgICAgICAvLyBHb2FsIFBvY2tldAogICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgR09BTF9QT0NLRVRfWDogMTIsCiAgICAgICAgR09BTF9QT0NLRVRfWjogNDAsCiAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA1NSwKCiAgICAgICAgLy8gV2FsbHMKICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLAogICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAsCiAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMsCiAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gVGhyb3cgbWFwcGluZwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLAogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1CiAgICB9OwoKCiAgICAKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOyAvLyBMb2NhbCBhbGlhcyBmb3IgYnJldml0eQogICAgLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQovLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCiAgICBjbGFzcyBUcmFpbFJlbmRlcmVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuc2VnbWVudHMgPSAzMDsgLy8gTW9yZSBzZWdtZW50cyBmb3Igc21vb3RoZXIgY3VydmVzCiAgICAgICAgICAgIHRoaXMucG9pbnRzID0gW107CnRoaXMuYmFzZVdpZHRoID0gMC44OyAvLyBJbmNyZWFzZWQgd2lkdGggZm9yIHZpc2liaWxpdHkKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggPSAwLjg7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHZW9tZXRyeQogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCBwb3NEYXRhID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLnNlZ21lbnRzICogMiAqIDMpOwogICAgICAgICAgICBnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShwb3NEYXRhLCAzKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbmRpY2VzCiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHMtMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlID0gaSoyOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UsIGJhc2UrMSwgYmFzZSsyKTsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlKzEsIGJhc2UrMywgYmFzZSsyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyeS5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBhYWZmLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC45LCAvLyBJbmNyZWFzZWQgb3BhY2l0eQogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXQgcG9pbnRzCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHMucHVzaChuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJldXNhYmxlIHRlbXBzIChhdm9pZCBwZXItZnJhbWUgYWxsb2NhdGlvbnMgb24gbW9iaWxlKQogICAgICAgICAgICB0aGlzLl90bXBEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBUb0NhbSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmVzZXQocG9zKSB7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgdGhpcy5wb2ludHNbaV0uY29weShwb3MpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNldENvbG9yKGhleCkgewogICAgICAgICAgICB0aGlzLm1hdGVyaWFsLmNvbG9yLnNldEhleChoZXgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoY3VycmVudFBvcywgc3BlZWRSYXRpbyA9IDAuMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgovLyBEeW5hbWljIFdpZHRoIGJhc2VkIG9uIHNwZWVkIEFORCBTUElOIChQb3dlciBWaXN1YWwpCiAgICAgICAgICAgIC8vIEZhc3QgYmFsbCA9IFRoaWNrZXIuIFNwaW5uaW5nIGJhbGwgPSBFdmVuIFRoaWNrZXIuCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHNwaW5SYXRpbyA9IGJhbGwgPyBNYXRoLm1pbigxLjAsIGJhbGwuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpIC8gMzAuMCkgOiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdGFyZ2V0V2lkdGggPSB0aGlzLmJhc2VXaWR0aCAqICgwLjggKyBzcGVlZFJhdGlvICogMS4yICsgc3BpblJhdGlvICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50V2lkdGggKz0gKHRhcmdldFdpZHRoIC0gdGhpcy5jdXJyZW50V2lkdGgpICogMC4yOyAvLyBTbW9vdGggdHJhbnNpdGlvbgoKICAgICAgICAgICAgLy8gU2hpZnQgcG9pbnRzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlZ21lbnRzIC0gMTsgaSA+IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5wb2ludHNbaV0uY29weSh0aGlzLnBvaW50c1tpLTFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnBvaW50c1swXS5jb3B5KGN1cnJlbnRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGVHZW9tZXRyeSgpIHsKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIGNvbnN0IGNhbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEgOiBudWxsOwogICAgICAgICAgICBpZiAoIWNhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjYW1Qb3MgPSBjYW0ucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHRlbXBEaXIgPSB0aGlzLl90bXBEaXI7CiAgICAgICAgICAgIGNvbnN0IHRlbXBUb0NhbSA9IHRoaXMuX3RtcFRvQ2FtOwogICAgICAgICAgICBjb25zdCB0ZW1wUmlnaHQgPSB0aGlzLl90bXBSaWdodDsKICAgICAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuc2VnbWVudHM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9pbnRzW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUYXBlciB3aWR0aCBhbG9uZyB0cmFpbCBsZW5ndGgKICAgICAgICAgICAgICAgIGNvbnN0IHRhcGVyID0gMS4wIC0gTWF0aC5wb3coaSAvIHRoaXMuc2VnbWVudHMsIDIpOyAvLyBRdWFkcmF0aWMgdGFwZXIKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB0aGlzLmN1cnJlbnRXaWR0aCAqIHRhcGVyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBpZiAoaSA8IHRoaXMuc2VnbWVudHMgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ldLCB0aGlzLnBvaW50c1tpKzFdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcERpci5zdWJWZWN0b3JzKHRoaXMucG9pbnRzW2ktMV0sIHRoaXMucG9pbnRzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlbXBEaXIubGVuZ3RoU3EoKSA8IDAuMDAwMSkgdGVtcERpci5zZXQoMCwgMSwgMCk7CiAgICAgICAgICAgICAgICB0ZW1wRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0ZW1wVG9DYW0uc3ViVmVjdG9ycyhjYW1Qb3MsIHApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGVtcFJpZ2h0LmNyb3NzVmVjdG9ycyh0ZW1wRGlyLCB0ZW1wVG9DYW0pLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDEKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAwXSA9IHAueCAtIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDFdID0gcC55IC0gdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMl0gPSBwLnogLSB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAyCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgM10gPSBwLnggKyB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA0XSA9IHAueSArIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDVdID0gcC56ICsgdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgIH0KdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDIGlzIGFscmVhZHkgZGVmaW5lZCBpbiB0aGUgb3V0ZXIgc2NvcGUKICAgIGNsYXNzIEJhbGwgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsgCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IG51bGw7IC8vIFRyYWNrIHdobyB0aHJldyBpdCBsYXN0IChmb3IgRVhQL0Fzc2lzdHMpCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7IC8vICdmcmVlJywgJ2hlbGQnLCAnbWFnbmV0aXplZCcKICAgICAgICAgICAgdGhpcy5pc0ludmlzaWJsZSA9IGZhbHNlOwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbHNhZmUgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7Cn0KCiAgICAgICAgaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3VwZGF0ZVBhcnRpY2xlcyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5fZ2hvc3QpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgdGhpcy5pc1JpY29jaGV0ID0gKHR5cGUgPT09ICdSSUNPQ0hFVCcgfHwgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ3JpY29jaGV0JykpOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CgovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweDAwZmYwMDsgLy8gR3JlZW4gKFZlbm9tKQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgY29sb3IgPSAweDg4ODg4ODsgLy8gR3JleQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnbmFwJykgY29sb3IgPSAweDAwMDA4ODsgLy8gRGFyayBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgogICAgICAgIApyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgIH0KaXNDYXRjaGFibGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPD0gMDsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFsVHJhbnNmb3JtcyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZGVmb3JtTm9kZSB8fCAhdGhpcy5zcGluTm9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gU3F1YXNoICYgU3RyZXRjaCBiYXNlZCBvbiB2ZWxvY2l0eQogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5zZXRGcm9tVW5pdFZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwwLDEpLCBkaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBmYWN0b3IgPSBNYXRoLm1pbihzcGVlZCAvIDQwLjAsIDEuMCk7IAogICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArIChmYWN0b3IgKiAwLjgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC8gTWF0aC5zcXJ0KHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmlkZW50aXR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBBcHBseSBBY2N1bXVsYXRlZCBTcGluCiAgICAgICAgICAgIGNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKCiAgICAgICAgICAgIC8vIDMuIFZpc3VhbCByb3RhdGlvbiBpbnRlZ3JhdGlvbgogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BpblNxID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BpblNwZWVkID0gTWF0aC5zcXJ0KHNwaW5TcSk7CiAgICAgICAgICAgICAgICBjb25zdCBheGlzID0gX3RlbXBWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKGF4aXMsIHNwaW5TcGVlZCAqIGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkuY3Jvc3MoX2F4aXNZKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cn0KICAgICAgICB9CgogICAgICAgIF9jaGVja0ZhaWxzYWZlcyhkdCkgewoKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IG1heFJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wKSArIDE1LjA7IC8vIEdlbmVyb3VzIGJ1ZmZlcgogICAgICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSAoQy5CT1VOREFSWV9IRUlHSFQgfHwgMjAuMCkgKyAxNS4wOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwb3MueCpwb3MueCArIHBvcy56KnBvcy56OwoKICAgICAgICAgICAgLy8gMS4gT3V0IG9mIEJvdW5kcyBDaGVjawogICAgICAgICAgICBpZiAoZGlzdFNxID4gbWF4UmFkaXVzKm1heFJhZGl1cyB8fCBNYXRoLmFicyhwb3MueSkgPiBtYXhIZWlnaHQpIHsKICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm91dE9mQm91bmRzVGltZXIgPiAxLjApIHsgLy8gMSBzZWNvbmQgT09CCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIE9PQiBkZXRlY3RlZC4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3V0T2ZCb3VuZHNUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBTdHVjayBDaGVjayAoRnJlZSAmIFN0YXRpb25hcnkpCiAgICAgICAgICAgIC8vIE9ubHkgY2hlY2sgaWYgZ2FtZSBpcyBhY3RpdmUgdG8gYXZvaWQgcmVzZXR0aW5nIGR1cmluZyBjdXRzY2VuZXMvbWVudXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiA0LjApIHsgLy8gNCBzZWNvbmRzIHN0YXRpb25hcnkKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgc3RhdGlvbmFyeS4gUmVzZXR0aW5nLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9yY2VSZXNldFRvUGxheSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3JjZVJlc2V0VG9QbGF5KCkgewogICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7CgogICAgICAgICAgICAvLyBGaW5kIG5lYXJlc3QgcGxheWVyIHRvIHJlc2V0IHRvCiAgICAgICAgICAgIGxldCBuZWFyZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBsZXQgdGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7IC8vIERlZmF1bHQgY2VudGVyCgogICAgICAgICAgICBpZiAoZ2FtZSkgewogICAgICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGdhbWUudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lYXJlc3QgPSBwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChuZWFyZXN0ICYmIG5lYXJlc3QubWVzaCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllciBpcyB3aXRoaW4gcmVhc29uYWJsZSBib3VuZHMgYmVmb3JlIHRlbGVwb3J0aW5nIGJhbGwgdG8gdGhlbQogICAgICAgICAgICAgICAgY29uc3QgcFBvcyA9IG5lYXJlc3QubWVzaC5wb3NpdGlvbjsKaWYgKHBQb3MubGVuZ3RoU3EoKSA8IDYwKjYwKSB7IC8vIFdpdGhpbiA2MG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKG5lYXJlc3QubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuY29weShwUG9zKS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDIuMCkpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ID0gTWF0aC5tYXgoMCwgcFBvcy55ICsgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9Cn0KICAgIH0KCndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LlByYWN0aWNlTWFuYWdlcih0aGlzKTsgLy8gSW5pdGlhbGl6ZSBQcmFjdGljZSBNYW5hZ2VyCiAgICAgICAgICAgIHRoaXMuX2luamVjdFN0eWxlcygpOwp0aGlzLl9pbml0VUkoKTsKICAgICAgICB9CgpfaW5pdENpbmVtYXRpY3MoKSB7CiAgICAgICAgICAgIC8vIE1lbnUgQmFja2dyb3VuZCBTaG90cyAoQi1Sb2xsKQogICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90cyA9IFsKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDEwLjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KDYwLCAzNSwgNjApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCksIHQpOyBjYW0ubG9va0F0KDAsIDAsIDApOyB9IH0sCiAgICAgICAgICAgICAgICB7IGR1cmF0aW9uOiA4LjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgLTI1ICsgNTAqdCk7IGNhbS5sb29rQXQoMCwgMiwgKC0yNSArIDUwKnQpKjAuOCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNvbnN0IGEgPSB0KzMuNTsgY2FtLnBvc2l0aW9uLnNldCgtMTArTWF0aC5jb3MoYSkqMTAsIDQsIC0xMCtNYXRoLnNpbihhKSoxMCk7IGNhbS5sb29rQXQoLTEwLCAxLjUsIC0xMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDcuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgLTUsIDMyKS5sZXJwKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKSwgdCk7IGNhbS5sb29rQXQoMCwgMTUsIDQ1KTsgY2FtLnJvdGF0aW9uLnogPSAodC0wLjUpKjAuMTU7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgNTAsIDApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgMTAsIDApLCB0KnQqKDMtMip0KSk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IGNhbS5yb3RhdGlvbi56ID0gdCowLjg7IH0gfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gRXBpYyBJbnRybyBTZXF1ZW5jZSAoIkhlcmN1bGVhbiIpCiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90cyA9IFsKICAgICAgICAgICAgICAgIC8vIDEuICJUaGUgQXdha2VuaW5nIiAtIENsb3NlIG9uIFNwaGVyZSAtPiBab29tIE91dCBVcHNpZGUgRG93biAtPiBMaWdodHMgJiBSb2FyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlRIRSBTUEhFUkUgUE9PTCIsICJzbGFtIik7IAogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5yZXNldExpZ2h0cygpOyAvLyBFbnN1cmUgZGFyayBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgc3RhcnQgc291bmQgKERlZXAgaHVtIC8gVW5kZXJ3YXRlciBmZWVsKQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBFYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IHQgPCAwLjUgPyAyICogdCAqIHQgOiAtMSArICg0IC0gMiAqIHQpICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwVCA9IE1hdGgucG93KHQsIDMuMCk7IC8vIFN0cm9uZyBleHBvbmVudGlhbCB6b29tIG91dAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FtZXJhIE1vdGlvbjogU3RhcnQgSU5TSURFL0NMT1NFICgwLDAsMikgLT4gRW5kIEZBUiBCQUNLL1VQICgwLCA4MCwgMTYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDIpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgODAsIDE2MCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHN0YXJ0UG9zLCBlbmRQb3MsIGV4cFQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRHluYW1pYyBSb2xsOiBUdXJuIHVwc2lkZSBkb3duICgwIC0+IFBJKQogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucm90YXRpb24ueiA9IGVhc2UgKiBNYXRoLlBJOyAKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExpZ2h0IFNlcXVlbmNpbmcgJiBTb3VuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRQcm9ncmVzcyA9IE1hdGgubWF4KDAsICh0IC0gMC4yKSAvIDAuNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVDb3VudCA9IE1hdGguZmxvb3IobGlnaHRQcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciAiUm9hciB0byBMaWZlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpZ2h0UHJvZ3Jlc3MgPiAwLjUgJiYgIXRoaXMuX2hhc1JvYXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNyB9KTsgLy8gRGVlcCByb2FyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC44LCByYXRlOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA8PSBhY3RpdmVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSB0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3ByaXRlICYmICFzcHJpdGUudmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFkaXVtLnR1cm5PbkxpZ2h0KGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmR1c3RyaWFsIExpZ2h0IFNGWAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaCA9IDAuNSArIChpIC8gdG90YWwpICogMC41OyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMC40LCByYXRlOiBwaXRjaCwgdmFyaWFuY2U6IDAuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgUm9hciIgLSBTd2VlcGluZyBjcm93ZCBzaG90CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDQuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTEVHRU5EQVJZIEFSRU5BIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAwLjcgfSk7IC8vIENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IC1NYXRoLlBJLzIgKyAodCAqIE1hdGguUEkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gaXNQb3J0cmFpdCA/IDg1IDogNjU7IC8vIFB1bGwgYmFjayBpbiBwb3J0cmFpdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMTUsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCA1LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIkhvbWUgR2xvcnkiIC0gT3JiaXQgSG9tZSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkVTQUlEIEFVUk9DSFMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2NlbGVicmF0ZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3JiaXQgSG9tZSBUZWFtIChTaWRlIDEsIC1aKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAtMjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguUEkgKyAodCAqIDEuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gMjAgOiAxMjsgLy8gUHVsbCBiYWNrIGlmIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoY2VudGVyLnggKyBNYXRoLmNvcyhhbmdsZSkqciwgNCwgY2VudGVyLnogKyBNYXRoLnNpbihhbmdsZSkqcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoY2VudGVyLngsIDIsIGNlbnRlci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNC4gIkVuZW15IEdhdGVzIiAtIFRyYWNraW5nIEF3YXkgVGVhbQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAzLjUsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkxVQ0EgR09FUlMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2lkbGUnLCAwLjIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC41IH0pOyAvLyBXaG9vc2gKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYWNraW5nIEF3YXkgVGVhbSAoU2lkZSAtMSwgK1opCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gbmV3IFRIUkVFLlZlY3RvcjMoLTE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQb3J0cmFpdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueCAqPSAxLjU7IGVuZC54ICo9IDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0LnogKz0gMTA7IGVuZC56ICs9IDEwOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnQsIGVuZCwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMywgMjUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA1LiAiVGhlIFNwaGVyZSIgLSBab29tIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJywgeyB2b2x1bWU6IDAuOCB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMzAsIGlzUG9ydHJhaXQgPyA3MCA6IDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxNCwgMjIpOyAvLyBHYW1lcGxheSBjYW0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHAxLCBwMiwgc3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIF9pbmplY3RTdHlsZXMoKSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmx1eC1keW5hbWljLXN0eWxlcycpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgICAgICAgICAgc3R5bGUuaWQgPSAnZmx1eC1keW5hbWljLXN0eWxlcyc7CnN0eWxlLnRleHRDb250ZW50ID0gYAogICAgICAgICAgICAgICAgQGtleWZyYW1lcyB0ZXh0U2xhbSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSg0KTsgb3BhY2l0eTogMDsgbGV0dGVyLXNwYWNpbmc6IDUwcHg7IH0KICAgICAgICAgICAgICAgICAgICAxMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgbGV0dGVyLXNwYWNpbmc6IDVweDsgfQogICAgICAgICAgICAgICAgICAgIDE1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMSk7IH0KICAgICAgICAgICAgICAgICAgICAyMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfQogICAgICAgICAgICAgICAgICAgIDgwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJsdXIoMTBweCk7IH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLmFubm91bmNlbWVudC1zbGFtIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgdG9wOiA0NSU7IGxlZnQ6IDUwJTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogOTZweDsKICAgICAgICAgICAgICAgICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZkZDAwIDQ1JSwgI2ZmODgwMCAxMDAlKTsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsMCwwLDEpKSBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjYpKTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMDAwOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogdGV4dFNsYW0gMS44cyBjdWJpYy1iZXppZXIoMC4xLCAwLjgsIDAuMSwgMSkgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMTAsIDI1LCA2MCwgMC45NSkgMCUsIHJnYmEoMCwgMCwgMCwgMC45OCkgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTkwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzOwogICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkuYWN0aXZlIHsgb3BhY2l0eTogMTsgcG9pbnRlci1ldmVudHM6IGF1dG87IH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXRpdGxlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0dhcmFtb25kJywgc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA1MnB4OyBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBhYWZmLCAwIDAgNDBweCAjMDA0NGFhOwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDMwcHg7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkICMwMGFhZmY7CiAgICAgICAgICAgICAgICAgICAgcGFkZGluZy1ib3R0b206IDEwcHg7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDgwJTsgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZS1jb250YWluZXIgewogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogNDBweDsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA4MHB4OyBjb2xvcjogI2ZmZDcwMDsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjYjg4NjBiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXZzIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMjRweDsgY29sb3I6ICMwMGFhZmY7IG9wYWNpdHk6IDAuNzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjEwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMXMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgQGtleWZyYW1lcyBjbGFzaFBvcCB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAxOyB9CiAgICAgICAgICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMC44OyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuY2xhc2gtc3BhcmsgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogNjBweDsgaGVpZ2h0OiA2MHB4OwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsICNmZmZmZmYgMCUsICNmZmZmMDAgNDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxNTAwOwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBzY3JlZW47CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBjbGFzaFBvcCAwLjNzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZmFhMDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMKICAgICAgICAgICAgdGhpcy51aS5zY29yZVBsYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1wbGF5ZXInKTsKICAgICAgICAgICAgdGhpcy51aS5zY29yZUNwdSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1jcHUnKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aW1lci1kaXNwbGF5Jyk7CiAgICAgICAgICAgIHRoaXMudWkuaGFsZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoYWxmLWluZGljYXRvcicpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbm5vdW5jZW1lbnQnKTsKdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29mZnNjcmVlbi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQovLyBJbml0aWFsIFN0YXRlCi8vIEluaXRpYWwgU3RhdGUKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBlbmQgbWVudSBpcyBoaWRkZW4gb24gaW5pdAogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KICAgICAgICBfdXBkYXRlU2NvcmVVSSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVQbGF5ZXIpIHRoaXMudWkuc2NvcmVQbGF5ZXIuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZUNwdSkgdGhpcy51aS5zY29yZUNwdS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucG93ZXJVcE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIC8vIFBsYXllciBXYXJtdXAgQW5pbWF0aW9ucwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSW50cm9XYXJtdXAoZHQpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnRyb1Nob3RzIHx8IHRoaXMuaW50cm9TaG90cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdEluZGV4ID49IHRoaXMuaW50cm9TaG90cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsgLy8gRG9uZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBzaG90IHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFNob3Qub25TdGFydCkgbmV4dFNob3Qub25TdGFydCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGN1cnJlbnQgc2hvdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvU2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEgJiYgc2hvdC51cGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5nZSA9IDYwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlLCAKICAgICAgICAgICAgICAgICAgICAgICAgLTEwICsgTWF0aC5yYW5kb20oKSoyMCwgCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBwb3MsIHsgbGlmZTogMy4wICsgTWF0aC5yYW5kb20oKSoyLjAsIHNjYWxlOiAwLjMgKyBNYXRoLnJhbmRvbSgpKjAuNCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQmFja2dyb3VuZCBTeXN0ZW1zCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUZWNoY29weSBVSQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSAmJiB0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLyB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSkgKiAxMDApOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gYCR7cGN0fSVgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdCBiYXNlZCBvbiB1cmdlbmN5CiAgICAgICAgICAgICAgICBpZiAocGN0IDwgMzApIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJyNmZjAwMDAnOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2VuZXJhbCBWaXN1YWxzIChBbHdheXMgUnVuIGV4Y2VwdCBJbnRyby9NZW51KQovLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIGJhbmQgcG9zc2Vzc2lvbiBkaXNwbGF5CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gJiYgdGhpcy5lbnRpdGllcyAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVIYXNCYWxsID0gYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAmJiBiYWxsLmhvbGRlci50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24oaG9tZUhhc0JhbGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHRoaXMubWluaU1hcC51cGRhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgdGhpcy5mbG9hdGluZ1RleHQudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBVcGRhdGUgcGFydGljbGVzIGR1cmluZyBnYW1lcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQp0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgovLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZSgyMC4wKTsgLy8gSFVEIFNoYWtlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJBUlJJRVIgU0hBVFRFUiBMT0dJQwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgLy8gSG9tZSBzY29yZXMgYXQgLVogKEF3YXkgR29hbCksIEF3YXkgc2NvcmVzIGF0ICtaIChIb21lIEdvYWwpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHNjb3JlciA9PT0gJ2hvbWUnKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgY29uc3QgYmFycmllciA9IChzY29yZXIgPT09ICdob21lJykgPyB0aGlzLnN0YWRpdW0uYmFycmllckEgOiB0aGlzLnN0YWRpdW0uYmFycmllckI7CiAgICAgICAgICAgICAgICBpZiAoYmFycmllcikgYmFycmllci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFZlbCA9IHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IGJhbGxWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFBvaW50IG9uIEdvYWwgUGxhbmUgKFRoZSAiSW52aXNpYmxlIEJhcnJpZXIiKQogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gYmFsbFBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gU25hcCBlZmZlY3QgdG8gdGhlIGJhcnJpZXIgcGxhbmUgKFopIGJ1dCBrZWVwIFgvWSBvZiBlbnRyeQogICAgICAgICAgICAgICAgaW1wYWN0UG9zLnogPSBnb2FsWjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgR2xhc3MgU2hhdHRlciBFZmZlY3QgKFRoZSBIb2xlKQogICAgICAgICAgICAgICAgdGhpcy5fdHJpZ2dlckdsYXNzU2hhdHRlcihpbXBhY3RQb3MsIGJhbGxWZWwpOwoKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVHJpYW5nbGUgRnJhbWUgU2hhdHRlciAoVGhlIEJhcnJpZXIpCiAgICAgICAgICAgICAgICB0aGlzLl9zcGF3blRyaWFuZ2xlU2hhdHRlcihnb2FsWiwgZm9yd2FyZCk7CgogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGltcGFjdFBvcywgeyBzY2FsZTogMjAuMCwgbGlmZTogMC42LCBjb2xvcjogMHgwMGZmZmYgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDEyLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLIChTdWRkZW4gRGVhdGgpCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2xvdyBtb3Rpb24gZmluaXNoCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuMjsKCiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheSAoMC41cyBnYW1lIHRpbWUgYXQgMC4yIHNjYWxlID0gMi41cyByZWFsIHRpbWUpCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvbGRlbl9nb2FsJzsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcyAoMi4wcyBnYW1lIHRpbWUpCiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDIuMDsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gbG9zZXI7CiAgICAgICAgfQoKX3NwYXduVHJpYW5nbGVTaGF0dGVyKHpQb3MsIGZvcndhcmREaXIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVHJpYW5nbGUgVmVydGljZXMgKE1hdGNoZXMgU3RhZGl1bS5qcyBnZW9tZXRyeSkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KY29uc3QgdjEgPSB7IHg6IC0xNCwgeTogOSB9OwogICAgICAgICAgICBjb25zdCB2MiA9IHsgeDogMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjMgPSB7IHg6IDAsIHk6IC02IH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBlZGdlcyA9IFsKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYxLCBlbmQ6IHYyIH0sCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MiwgZW5kOiB2MyB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjMsIGVuZDogdjEgfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdAovLyBJbmNyZWFzZWQgZGVuc2l0eSBmb3IgImFwcGVhcmluZyIgZWZmZWN0CmNvbnN0IHBhcnRpY2xlc1BlckVkZ2UgPSA0OyAvLyBSZWR1Y2VkIGZyb20gMTIgZm9yIGxlc3MgY2x1dHRlcgogICAgICAgICAgICAKICAgICAgICAgICAgZWRnZXMuZm9yRWFjaChlZGdlID0+IHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHBhcnRpY2xlc1BlckVkZ2U7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBpIC8gcGFydGljbGVzUGVyRWRnZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gZWRnZS5zdGFydC54ICsgKGVkZ2UuZW5kLnggLSBlZGdlLnN0YXJ0LngpICogdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gZWRnZS5zdGFydC55ICsgKGVkZ2UuZW5kLnkgLSBlZGdlLnN0YXJ0LnkpICogdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBZGQgc29tZSByYW5kb21uZXNzCiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5OiBPdXR3YXJkIGZyb20gY2VudGVyIG9mIHRyaWFuZ2xlIChhcHByb3ggMCwgNCkgKyBGb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0geyB4OiAwLCB5OiAxLjUgfTsgLy8gUm91Z2ggY2VudGVyIG9mIG1hc3MKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh4IC0gY2VudGVyLngsIHkgLSBjZW50ZXIueSwgMCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKDguMCArIE1hdGgucmFuZG9tKCkgKiAxMi4wKTsKICAgICAgICAgICAgICAgICAgICB2ZWwuYWRkKGZvcndhcmREaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyMC4wKSk7IC8vIFN0cm9uZyBmb3J3YXJkIG1vbWVudHVtCgp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHZlbCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiA2LjAsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjUgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGFhZmYsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjAsIC8vIFNwaW4KICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpIC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIG9uIHBlcmltZXRlciB0byBvdXRsaW5lIHRoZSBzaGFwZSBhcyBpdCBicmVha3MKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDMuMCwgbGlmZTogMC4zLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdHJpZ2dlckdsYXNzU2hhdHRlcihwb3MsIHZlbCkgewogICAgICAgICAgICBpZiAoIXRoaXMucGFydGljbGVNYW5hZ2VyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmb3J3YXJkID0gdmVsLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5tYXgoMjAuMCwgdmVsLmxlbmd0aCgpKTsgLy8gRW5zdXJlIG1pbmltdW0gZXhwbG9zaW9uIHNwZWVkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBUaGUgIlBhbmUiIChSYWRpYWwgYnVyc3Qgb24gdGhlIGdvYWwgcGxhbmUpCiAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB0aGUgYmFycmllciBzaGF0dGVyaW5nIG91dHdhcmQKLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCmNvbnN0IHNoYXJkQ291bnQgPSAxNTsgLy8gUmVkdWNlZCBmcm9tIDUwCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHNoYXJkQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDEwLjA7IC8vIExhcmdlciByYWRpdXMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5jb3MoYW5nbGUpICogciwgTWF0aC5zaW4oYW5nbGUpICogciwgMCk7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IGlzIHJhZGlhbCBvdXR3YXJkIGZyb20gaW1wYWN0IGNlbnRlcgogICAgICAgICAgICAgICAgY29uc3QgcmFkaWFsRGlyID0gb2Zmc2V0LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IHJhZGlhbERpci5tdWx0aXBseVNjYWxhcigxNS4wICsgTWF0aC5yYW5kb20oKSAqIDI1LjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGQgZm9yd2FyZCBtb21lbnR1bSAoVGhlIGJhbGwgcHVuY2hlcyB0aHJvdWdoKQogICAgICAgICAgICAgICAgc2hhcmRWZWwuYWRkKGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqIDAuOCkpOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDYuMCArIE1hdGgucmFuZG9tKCkgKiA4LjAsIAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiArIE1hdGgucmFuZG9tKCkgKiAwLjgsCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMjUuMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhhYWZmZmYsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQovLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDIwCiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IChpbXBhY3Qgem9uZSkKICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA0LjA7CiAgICAgICAgICAgICAgICBwLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogTW9zdGx5IGZvcndhcmQsIHNvbWUgc3ByZWFkCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqICgxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41KSk7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICAKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcCwgewogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBzaGFyZFZlbCwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogNS4wICsgTWF0aC5yYW5kb20oKSAqIDcuMCwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDE1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIwLjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxNS4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBJbXBhY3QgRmxhc2ggJiBTb3VuZAogICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDEwLjAsIGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gSGlnaCBwaXRjaCBpbXBhY3QgdG8gc2ltdWxhdGUgZ2xhc3MgYnJlYWtpbmcKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDIuNSB9KTsgCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC41IH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICB9CiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wb3dlclVwTWFuYWdlcikgdGhpcy5wb3dlclVwTWFuYWdlci5yZXNldCgpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQmFycmllcnMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQSkgdGhpcy5zdGFkaXVtLmJhcnJpZXJBLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQikgdGhpcy5zdGFkaXVtLmJhcnJpZXJCLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC4xOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBwb3NzZXNzaW9uVGVhbUlkOwogICAgICAgIH0KCgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgLy8gSWYgYSB0ZWFtIGhhcyBwb3NzZXNzaW9uIChhZnRlciBnb2FsKSwgc3RhbmRhcmQga2lja29mZgogICAgICAgICAgICBpZiAocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ZWFtID0gdGhpcy50ZWFtc1twb3NzZXNzaW9uVGVhbUlkXTsKICAgICAgICAgICAgICAgIGlmICh0ZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWYgPSB0ZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1mICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0aWVzLmJhbGwuZ3JhYihtZik7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQobWYubWVzaCwgbWYudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCnRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2NoYXJnZSc7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBSZXNldCBCYWxsIHRvIENlbnRlciAoRGVlcCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBiYWxsLmRyb3AoKTsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTUsIDApOyAvLyBTdGFydCBERUVQICgtNW0pIGZvciAiZ3JvdW5kIHVwIiByaXNlCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBvc2l0aW9uIENhcHRhaW5zIChNRnMpCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgIGlmIChob21lTUYgJiYgaG9tZU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA4KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaG9tZU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5TUYgJiYgYXdheU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGF3YXlNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gQ2FtZXJhIEZvY3VzCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQoYmFsbC5tZXNoLCBudWxsKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIC8vIFpvb20gaW4gdGlnaHQKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAtMTI7IAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjQ7IC8vIExvb2sgZG93biBzdGVlcAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCdWlsZCBUZW5zaW9uCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiUkVBRFkuLi4iLCAnbm9ybWFsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAwLjUgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpDaGFyZ2UoZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY2hhcmdlRHVyYXRpb24gPSAyLjA7IC8vIExvbmdlciBidWlsZCB1cCBmb3IgY2luZW1hdGljIGZlZWwKCiAgICAgICAgICAgIC8vIFBIQVNFIDE6IENIQVJHRSAoUmlzaW5nIGZyb20gZGVwdGhzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyIDwgY2hhcmdlRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmJsaXR6VGltZXIgLyBjaGFyZ2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGVhc2VUID0gdCAqIHQ7IC8vIFF1YWRyYXRpYyBlYXNlIGluCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJpc2UgZnJvbSAtNSB0byAwIChHcm91bmQgdXAgZWZmZWN0KQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPSAtNS4wICsgKDUuMCAqIGVhc2VUKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3BpbiB1cCAoRXhwb25lbnRpYWwpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueSArPSAoMTAuMCArIDUwLjAgKiB0KSAqIGR0OwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnggKz0gKDUuMCArIDIwLjAgKiB0KSAqIGR0OwoKICAgICAgICAgICAgICAgIC8vIFNxdWFzaCAoRmxhdHRlbiBsaWtlIGEgZGlzYyBidWlsZGluZyBlbmVyZ3kpCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmVtZSBzcXVhc2ggYXQgdGhlIGVuZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAtICgwLjcgKiBlYXNlVCk7IC8vIEZsYXR0ZW4gWSB0byAwLjMKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKDAuNSAqIGVhc2VUKTsgLy8gRXhwYW5kIFhaCiAgICAgICAgICAgICAgICAgICAgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldChzdHJldGNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhbWVyYSBTaGFrZSBpbmNyZWFzaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4yICogdCk7CgogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzOiBSaXNpbmcgRW5lcmd5IGZyb20gZ3JvdW5kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGVzIHJpc2luZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBNYXRoLmZsb29yKHQgKiA4KSArIDE7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMCAqICgxLjAgLSB0KTsgLy8gUmFkaXVzIHNocmlua3MgYXMgaXQgZ2V0cyBjbG9zZXIgdG8gbGF1bmNoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGJhbGwubWVzaC5wb3NpdGlvbi55IC0gMS4wOyAvLyBCZWxvdyBiYWxsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgeiksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjQsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIHQgKiAwLjUgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUEhBU0UgMjogTEFVTkNICiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2xhdW5jaCc7CiAgICAgICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOyAvLyBSZXNldCBmb3IgbGF1bmNoIHBoYXNlCgogICAgICAgICAgICAgICAgLy8gVElNRUQgQU5OT1VOQ0VNRU5UCiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IDEuMCB9KTsgLy8gQm9vbQogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMS4wIH0pOyAgIC8vIFdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIExhdW5jaCBCYWxsCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAzNSwgMCk7IC8vIFNob290IFVQIEZBU1QKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMC40LCAzLjAsIDAuNCk7IC8vIEV4dHJlbWUgc3RyZXRjaCB2ZXJ0aWNhbAoKICAgICAgICAgICAgICAgIC8vIEZYOiBNYXNzaXZlIEdyb3VuZCBFcnVwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogOC4wIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogNi4wIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIHN0cmVhbQogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnkgKz0gaSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgzLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAxMDsgLy8gWm9vbSBvdXQgZmFzdAogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC4wOyAvLyBMZXZlbCBvdXQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYXB0YWlucyBKdW1wCiAgICAgICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGp1bXBUbyA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIocC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDEuMjsgLy8gU3RlZXAganVtcAogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuY29weShkaXIpLm11bHRpcGx5U2NhbGFyKDE4LjApOyAvLyBGYXN0IGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoX2p1bXAnLCAwLjEpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqdW1wVG8oaG9tZU1GKTsKICAgICAgICAgICAgICAgIGp1bXBUbyhhd2F5TUYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpMYXVuY2goZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZ3Jhdml0eSBtYW51YWxseSBmb3IgY2luZW1hdGljIGZlZWwgKEluY3JlYXNlZCBncmF2aXR5IGZvciBzbmFwcGllciBhcmMpCiAgICAgICAgICAgIGJhbGwudmVsb2NpdHkueSAtPSA0MC4wICogZHQ7IAogICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgIC8vIE1vdmUgUGxheWVycyBtYW51YWxseQogICAgICAgICAgICBjb25zdCB1cGRhdGVKdW1wZXIgPSAocCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkueSAtPSAyNS4wICogZHQ7IC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdChiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGhvbWVNRik7CiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihhd2F5TUYpOwoKICAgICAgICAgICAgLy8gUEhBU0UgMzogR1JBQiAoQXBleCB+MC43cykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA+IDAuNyAmJiB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykgewogICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFdpbm5lciAoNTAvNTAgKyBTdGF0IGJpYXMpCiAgICAgICAgICAgICAgICBjb25zdCBob21lU3AgPSBob21lTUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTcCA9IGF3YXlNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgdG90YWwgPSBob21lU3AgKyBhd2F5U3A7CiAgICAgICAgICAgICAgICBjb25zdCByb2xsID0gTWF0aC5yYW5kb20oKSAqIHRvdGFsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3aW5uZXIgPSAocm9sbCA8IGhvbWVTcCkgPyBob21lTUYgOiBhd2F5TUY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGJhbGwuZ3JhYih3aW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJXT04hIiwgd2lubmVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVHJhbnNpdGlvbiB0byBBY3RpdmUKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gd2lubmVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh3aW5uZXIubWVzaCwgd2lubmVyLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7IC8vIE9wdGlvbmFsOiBLZWVwIHNtb290aCBvciBzbmFwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCi8vIEluaXRpYWwgc3RhcnQKc3RhcnRNYXRjaChtb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgSFVEIFNoYWtlIGJhc2VkIG9uIGltcGFjdCB0eXBlCiAgICAgICAgICAgIGxldCBzaGFrZUFtb3VudCA9IDUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIHNoYWtlQW1vdW50ID0gMTUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgc2hha2VBbW91bnQgPSAzMC4wOwogICAgICAgICAgICB0aGlzLmFkZEhVRFNoYWtlKHNoYWtlQW1vdW50KTsKCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQgdG8gcHJldmVudCBlYXJseSByZW1vdmFsIG9mIG5ldyBjbGFzcwogICAgICAgICAgICBpZiAodGhpcy5faW1wYWN0VGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2ltcGFjdFRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cyAocmVmbG93IHRyaWNrKQogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24gKyBidWZmZXIgZm9yIGFuaW1hdGlvbiB0YWlsCiAgICAgICAgICAgIC8vIFdlIGFkZCBhIGJpdCBtb3JlIHRpbWUgdGhhbiB0aGUgcGF1c2UgZHVyYXRpb24gdG8gbGV0IHRoZSBDU1MgYW5pbWF0aW9uIGZpbmlzaAogICAgICAgICAgICBjb25zdCBhbmltRHVyYXRpb24gPSAodHlwZSA9PT0gJ3NoYXR0ZXInID8gNTAwIDogKHR5cGUgPT09ICdoZWF2eScgPyAyNTAgOiAxNTApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfSwgYW5pbUR1cmF0aW9uKTsKICAgICAgICB9CgogICAgICAgIGFkZEhVRFNoYWtlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5odWRTaGFrZUludGVuc2l0eSArIGFtb3VudCwgNTAuMCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFVEU2hha2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBEZWNheQogICAgICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSAtPSBkdCAqIDYwLjA7IC8vIERlY2F5IGFwcHJveCA2MHB4IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3QgeCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5odWRTaGFrZUludGVuc2l0eTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3gudG9GaXhlZCgxKX1weCwgJHt5LnRvRml4ZWQoMSl9cHgpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gbWFpbiBIVUQgY29udGFpbmVycwogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIGV4aXN0aW5nIHNrZXcKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gYHNrZXdYKC0xMGRlZykgJHt0cmFuc2Zvcm19YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25Db250YWluZXIpIGFjdGlvbkNvbnRhaW5lci5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9odWRTaGFrZURpcnR5KSB7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB0byBjbGVhbiBzdGF0ZQogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS50cmFuc2Zvcm0gPSAnc2tld1goLTEwZGVnKSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVBdWRpb1N0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYXVkaW9NYW5hZ2VyKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdGVuc2lvbiA9IDA7CgogICAgICAgICAgICAvLyAxLiBCYWxsIFRocmVhdAogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnIHx8IHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gYmFsbC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5taW4oTWF0aC5hYnMoeiAtIGdvYWxEaXN0KSwgTWF0aC5hYnMoeiArIGdvYWxEaXN0KSk7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXRSYW5nZSA9IDM1LjA7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsVGhyZWF0ID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3RUb0dvYWwgLyB0aHJlYXRSYW5nZSkpOwogICAgICAgICAgICAgICAgdGVuc2lvbiArPSBiYWxsVGhyZWF0ICogYmFsbFRocmVhdDsgLy8gUXVhZHJhdGljIHJhbXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU2NvcmUgUHJlc3N1cmUgKENsb3NlIGdhbWUpCiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBNYXRoLmFicyh0aGlzLnNjb3JlLmhvbWUgLSB0aGlzLnNjb3JlLmF3YXkpOwogICAgICAgICAgICBpZiAoZGlmZiA8PSAxKSB0ZW5zaW9uICs9IDAuMTU7CgogICAgICAgICAgICAvLyAzLiBUaW1lIFByZXNzdXJlIChMYXN0IG1pbnV0ZSkKICAgICAgICAgICAgY29uc3QgdGltZUxlZnQgPSB0aGlzLmhhbGZEdXJhdGlvbiAtIHRoaXMudGltZTsKICAgICAgICAgICAgaWYgKHRpbWVMZWZ0IDwgNjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2FjdGl2ZScpIHsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gMC4yICogKDEuMCAtICh0aW1lTGVmdCAvIDYwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKHRlbnNpb24sIHRoaXMuaXNPdmVydGltZSk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgaW4gYWN0aXZlIGdhbWUgb3IgbWVudQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5fZW52QnViYmxlVGltZXIgPSAodGhpcy5fZW52QnViYmxlVGltZXIgfHwgMCkgLSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLl9lbnZCdWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gaW50ZXJ2YWw6IDAuMnMgdG8gMC44cyAoRnJlcXVlbnQgc3RyZWFtcykKICAgICAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBhIHJhbmRvbSBzcG90IG9uIHRoZSBmbG9vcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA3MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogOTA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAtMjA7IC8vIERlZXAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBhICJTdHJlYW0iIChCdXJzdCBvZiBidWJibGVzIHJpc2luZyB0b2dldGhlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IDMgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJlYW1TcGVlZCA9IDMuMCArIE1hdGgucmFuZG9tKCkgKiA0LjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeUJhc2UgLSAoTWF0aC5yYW5kb20oKSAqIDUuMCksIC8vIFN0YWdnZXJlZCBzdGFydCBkZXB0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeiArIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGVfbWljcm8nLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiAyLjAsIC8vIExvbmcgbGlmZSB0byByZWFjaCB0b3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA4ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIFNoaW1tZXJ5IHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1TcGVlZCArIChNYXRoLnJhbmRvbSgpICogMi4wKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWc6IDAuMQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl9hZHZhbmNlU3RhdGUoKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5zdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdyZXNldCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydEtpY2tvZmYodGhpcy5uZXh0U3RhdGVQYXlsb2FkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2tpY2tvZmYnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2hhbGZ0aW1lJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYWxmID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIE9UIG9yIEVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvbGRlbl9nb2FsJzoKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuODsgLy8gUmVzdG9yZSBzcGVlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","./GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LlByYWN0aWNlTWFuYWdlcih0aGlzKTsgLy8gSW5pdGlhbGl6ZSBQcmFjdGljZSBNYW5hZ2VyCiAgICAgICAgICAgIHRoaXMuX2luamVjdFN0eWxlcygpOwp0aGlzLl9pbml0VUkoKTsKICAgICAgICB9CgpfaW5pdENpbmVtYXRpY3MoKSB7CiAgICAgICAgICAgIC8vIE1lbnUgQmFja2dyb3VuZCBTaG90cyAoQi1Sb2xsKQogICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90cyA9IFsKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDEwLjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KDYwLCAzNSwgNjApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCksIHQpOyBjYW0ubG9va0F0KDAsIDAsIDApOyB9IH0sCiAgICAgICAgICAgICAgICB7IGR1cmF0aW9uOiA4LjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgLTI1ICsgNTAqdCk7IGNhbS5sb29rQXQoMCwgMiwgKC0yNSArIDUwKnQpKjAuOCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNvbnN0IGEgPSB0KzMuNTsgY2FtLnBvc2l0aW9uLnNldCgtMTArTWF0aC5jb3MoYSkqMTAsIDQsIC0xMCtNYXRoLnNpbihhKSoxMCk7IGNhbS5sb29rQXQoLTEwLCAxLjUsIC0xMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDcuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgLTUsIDMyKS5sZXJwKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKSwgdCk7IGNhbS5sb29rQXQoMCwgMTUsIDQ1KTsgY2FtLnJvdGF0aW9uLnogPSAodC0wLjUpKjAuMTU7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgNTAsIDApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgMTAsIDApLCB0KnQqKDMtMip0KSk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IGNhbS5yb3RhdGlvbi56ID0gdCowLjg7IH0gfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gRXBpYyBJbnRybyBTZXF1ZW5jZSAoIkhlcmN1bGVhbiIpCiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90cyA9IFsKICAgICAgICAgICAgICAgIC8vIDEuICJUaGUgQXdha2VuaW5nIiAtIENsb3NlIG9uIFNwaGVyZSAtPiBab29tIE91dCBVcHNpZGUgRG93biAtPiBMaWdodHMgJiBSb2FyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlRIRSBTUEhFUkUgUE9PTCIsICJzbGFtIik7IAogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5yZXNldExpZ2h0cygpOyAvLyBFbnN1cmUgZGFyayBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgc3RhcnQgc291bmQgKERlZXAgaHVtIC8gVW5kZXJ3YXRlciBmZWVsKQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBFYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IHQgPCAwLjUgPyAyICogdCAqIHQgOiAtMSArICg0IC0gMiAqIHQpICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwVCA9IE1hdGgucG93KHQsIDMuMCk7IC8vIFN0cm9uZyBleHBvbmVudGlhbCB6b29tIG91dAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FtZXJhIE1vdGlvbjogU3RhcnQgSU5TSURFL0NMT1NFICgwLDAsMikgLT4gRW5kIEZBUiBCQUNLL1VQICgwLCA4MCwgMTYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDIpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgODAsIDE2MCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHN0YXJ0UG9zLCBlbmRQb3MsIGV4cFQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRHluYW1pYyBSb2xsOiBUdXJuIHVwc2lkZSBkb3duICgwIC0+IFBJKQogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucm90YXRpb24ueiA9IGVhc2UgKiBNYXRoLlBJOyAKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExpZ2h0IFNlcXVlbmNpbmcgJiBTb3VuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRQcm9ncmVzcyA9IE1hdGgubWF4KDAsICh0IC0gMC4yKSAvIDAuNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVDb3VudCA9IE1hdGguZmxvb3IobGlnaHRQcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciAiUm9hciB0byBMaWZlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpZ2h0UHJvZ3Jlc3MgPiAwLjUgJiYgIXRoaXMuX2hhc1JvYXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNyB9KTsgLy8gRGVlcCByb2FyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC44LCByYXRlOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA8PSBhY3RpdmVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSB0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3ByaXRlICYmICFzcHJpdGUudmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFkaXVtLnR1cm5PbkxpZ2h0KGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmR1c3RyaWFsIExpZ2h0IFNGWAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaCA9IDAuNSArIChpIC8gdG90YWwpICogMC41OyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMC40LCByYXRlOiBwaXRjaCwgdmFyaWFuY2U6IDAuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgUm9hciIgLSBTd2VlcGluZyBjcm93ZCBzaG90CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDQuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTEVHRU5EQVJZIEFSRU5BIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAwLjcgfSk7IC8vIENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IC1NYXRoLlBJLzIgKyAodCAqIE1hdGguUEkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gaXNQb3J0cmFpdCA/IDg1IDogNjU7IC8vIFB1bGwgYmFjayBpbiBwb3J0cmFpdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMTUsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCA1LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIkhvbWUgR2xvcnkiIC0gT3JiaXQgSG9tZSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkVTQUlEIEFVUk9DSFMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2NlbGVicmF0ZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3JiaXQgSG9tZSBUZWFtIChTaWRlIDEsIC1aKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAtMjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguUEkgKyAodCAqIDEuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gMjAgOiAxMjsgLy8gUHVsbCBiYWNrIGlmIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoY2VudGVyLnggKyBNYXRoLmNvcyhhbmdsZSkqciwgNCwgY2VudGVyLnogKyBNYXRoLnNpbihhbmdsZSkqcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoY2VudGVyLngsIDIsIGNlbnRlci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNC4gIkVuZW15IEdhdGVzIiAtIFRyYWNraW5nIEF3YXkgVGVhbQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAzLjUsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkxVQ0EgR09FUlMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2lkbGUnLCAwLjIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC41IH0pOyAvLyBXaG9vc2gKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYWNraW5nIEF3YXkgVGVhbSAoU2lkZSAtMSwgK1opCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gbmV3IFRIUkVFLlZlY3RvcjMoLTE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQb3J0cmFpdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueCAqPSAxLjU7IGVuZC54ICo9IDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0LnogKz0gMTA7IGVuZC56ICs9IDEwOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnQsIGVuZCwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMywgMjUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA1LiAiVGhlIFNwaGVyZSIgLSBab29tIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJywgeyB2b2x1bWU6IDAuOCB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMzAsIGlzUG9ydHJhaXQgPyA3MCA6IDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxNCwgMjIpOyAvLyBHYW1lcGxheSBjYW0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHAxLCBwMiwgc3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIF9pbmplY3RTdHlsZXMoKSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmx1eC1keW5hbWljLXN0eWxlcycpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgICAgICAgICAgc3R5bGUuaWQgPSAnZmx1eC1keW5hbWljLXN0eWxlcyc7CnN0eWxlLnRleHRDb250ZW50ID0gYAogICAgICAgICAgICAgICAgQGtleWZyYW1lcyB0ZXh0U2xhbSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSg0KTsgb3BhY2l0eTogMDsgbGV0dGVyLXNwYWNpbmc6IDUwcHg7IH0KICAgICAgICAgICAgICAgICAgICAxMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgbGV0dGVyLXNwYWNpbmc6IDVweDsgfQogICAgICAgICAgICAgICAgICAgIDE1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMSk7IH0KICAgICAgICAgICAgICAgICAgICAyMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfQogICAgICAgICAgICAgICAgICAgIDgwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJsdXIoMTBweCk7IH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLmFubm91bmNlbWVudC1zbGFtIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgdG9wOiA0NSU7IGxlZnQ6IDUwJTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogOTZweDsKICAgICAgICAgICAgICAgICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZkZDAwIDQ1JSwgI2ZmODgwMCAxMDAlKTsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsMCwwLDEpKSBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjYpKTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMDAwOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogdGV4dFNsYW0gMS44cyBjdWJpYy1iZXppZXIoMC4xLCAwLjgsIDAuMSwgMSkgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMTAsIDI1LCA2MCwgMC45NSkgMCUsIHJnYmEoMCwgMCwgMCwgMC45OCkgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTkwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzOwogICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkuYWN0aXZlIHsgb3BhY2l0eTogMTsgcG9pbnRlci1ldmVudHM6IGF1dG87IH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXRpdGxlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0dhcmFtb25kJywgc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA1MnB4OyBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBhYWZmLCAwIDAgNDBweCAjMDA0NGFhOwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDMwcHg7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkICMwMGFhZmY7CiAgICAgICAgICAgICAgICAgICAgcGFkZGluZy1ib3R0b206IDEwcHg7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDgwJTsgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZS1jb250YWluZXIgewogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogNDBweDsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA4MHB4OyBjb2xvcjogI2ZmZDcwMDsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjYjg4NjBiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXZzIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMjRweDsgY29sb3I6ICMwMGFhZmY7IG9wYWNpdHk6IDAuNzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjEwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMXMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgQGtleWZyYW1lcyBjbGFzaFBvcCB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAxOyB9CiAgICAgICAgICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMC44OyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuY2xhc2gtc3BhcmsgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogNjBweDsgaGVpZ2h0OiA2MHB4OwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsICNmZmZmZmYgMCUsICNmZmZmMDAgNDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxNTAwOwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBzY3JlZW47CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBjbGFzaFBvcCAwLjNzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZmFhMDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMKICAgICAgICAgICAgdGhpcy51aS5zY29yZVBsYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1wbGF5ZXInKTsKICAgICAgICAgICAgdGhpcy51aS5zY29yZUNwdSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1jcHUnKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aW1lci1kaXNwbGF5Jyk7CiAgICAgICAgICAgIHRoaXMudWkuaGFsZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoYWxmLWluZGljYXRvcicpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbm5vdW5jZW1lbnQnKTsKdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29mZnNjcmVlbi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQovLyBJbml0aWFsIFN0YXRlCi8vIEluaXRpYWwgU3RhdGUKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBlbmQgbWVudSBpcyBoaWRkZW4gb24gaW5pdAogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KICAgICAgICBfdXBkYXRlU2NvcmVVSSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVQbGF5ZXIpIHRoaXMudWkuc2NvcmVQbGF5ZXIuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZUNwdSkgdGhpcy51aS5zY29yZUNwdS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucG93ZXJVcE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIC8vIFBsYXllciBXYXJtdXAgQW5pbWF0aW9ucwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSW50cm9XYXJtdXAoZHQpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnRyb1Nob3RzIHx8IHRoaXMuaW50cm9TaG90cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdEluZGV4ID49IHRoaXMuaW50cm9TaG90cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsgLy8gRG9uZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBzaG90IHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFNob3Qub25TdGFydCkgbmV4dFNob3Qub25TdGFydCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGN1cnJlbnQgc2hvdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvU2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEgJiYgc2hvdC51cGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5nZSA9IDYwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlLCAKICAgICAgICAgICAgICAgICAgICAgICAgLTEwICsgTWF0aC5yYW5kb20oKSoyMCwgCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBwb3MsIHsgbGlmZTogMy4wICsgTWF0aC5yYW5kb20oKSoyLjAsIHNjYWxlOiAwLjMgKyBNYXRoLnJhbmRvbSgpKjAuNCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQmFja2dyb3VuZCBTeXN0ZW1zCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUZWNoY29weSBVSQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSAmJiB0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLyB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSkgKiAxMDApOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gYCR7cGN0fSVgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdCBiYXNlZCBvbiB1cmdlbmN5CiAgICAgICAgICAgICAgICBpZiAocGN0IDwgMzApIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJyNmZjAwMDAnOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2VuZXJhbCBWaXN1YWxzIChBbHdheXMgUnVuIGV4Y2VwdCBJbnRyby9NZW51KQovLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIGJhbmQgcG9zc2Vzc2lvbiBkaXNwbGF5CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gJiYgdGhpcy5lbnRpdGllcyAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVIYXNCYWxsID0gYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAmJiBiYWxsLmhvbGRlci50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24oaG9tZUhhc0JhbGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHRoaXMubWluaU1hcC51cGRhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgdGhpcy5mbG9hdGluZ1RleHQudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBVcGRhdGUgcGFydGljbGVzIGR1cmluZyBnYW1lcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQp0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgovLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZSgyMC4wKTsgLy8gSFVEIFNoYWtlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJBUlJJRVIgU0hBVFRFUiBMT0dJQwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgLy8gSG9tZSBzY29yZXMgYXQgLVogKEF3YXkgR29hbCksIEF3YXkgc2NvcmVzIGF0ICtaIChIb21lIEdvYWwpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHNjb3JlciA9PT0gJ2hvbWUnKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgY29uc3QgYmFycmllciA9IChzY29yZXIgPT09ICdob21lJykgPyB0aGlzLnN0YWRpdW0uYmFycmllckEgOiB0aGlzLnN0YWRpdW0uYmFycmllckI7CiAgICAgICAgICAgICAgICBpZiAoYmFycmllcikgYmFycmllci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFZlbCA9IHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IGJhbGxWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFBvaW50IG9uIEdvYWwgUGxhbmUgKFRoZSAiSW52aXNpYmxlIEJhcnJpZXIiKQogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gYmFsbFBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gU25hcCBlZmZlY3QgdG8gdGhlIGJhcnJpZXIgcGxhbmUgKFopIGJ1dCBrZWVwIFgvWSBvZiBlbnRyeQogICAgICAgICAgICAgICAgaW1wYWN0UG9zLnogPSBnb2FsWjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgR2xhc3MgU2hhdHRlciBFZmZlY3QgKFRoZSBIb2xlKQogICAgICAgICAgICAgICAgdGhpcy5fdHJpZ2dlckdsYXNzU2hhdHRlcihpbXBhY3RQb3MsIGJhbGxWZWwpOwoKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVHJpYW5nbGUgRnJhbWUgU2hhdHRlciAoVGhlIEJhcnJpZXIpCiAgICAgICAgICAgICAgICB0aGlzLl9zcGF3blRyaWFuZ2xlU2hhdHRlcihnb2FsWiwgZm9yd2FyZCk7CgogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGltcGFjdFBvcywgeyBzY2FsZTogMjAuMCwgbGlmZTogMC42LCBjb2xvcjogMHgwMGZmZmYgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDEyLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLIChTdWRkZW4gRGVhdGgpCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2xvdyBtb3Rpb24gZmluaXNoCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuMjsKCiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheSAoMC41cyBnYW1lIHRpbWUgYXQgMC4yIHNjYWxlID0gMi41cyByZWFsIHRpbWUpCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvbGRlbl9nb2FsJzsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcyAoMi4wcyBnYW1lIHRpbWUpCiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDIuMDsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gbG9zZXI7CiAgICAgICAgfQoKX3NwYXduVHJpYW5nbGVTaGF0dGVyKHpQb3MsIGZvcndhcmREaXIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVHJpYW5nbGUgVmVydGljZXMgKE1hdGNoZXMgU3RhZGl1bS5qcyBnZW9tZXRyeSkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KY29uc3QgdjEgPSB7IHg6IC0xNCwgeTogOSB9OwogICAgICAgICAgICBjb25zdCB2MiA9IHsgeDogMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjMgPSB7IHg6IDAsIHk6IC02IH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBlZGdlcyA9IFsKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYxLCBlbmQ6IHYyIH0sCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MiwgZW5kOiB2MyB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjMsIGVuZDogdjEgfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdAovLyBJbmNyZWFzZWQgZGVuc2l0eSBmb3IgImFwcGVhcmluZyIgZWZmZWN0CmNvbnN0IHBhcnRpY2xlc1BlckVkZ2UgPSA0OyAvLyBSZWR1Y2VkIGZyb20gMTIgZm9yIGxlc3MgY2x1dHRlcgogICAgICAgICAgICAKICAgICAgICAgICAgZWRnZXMuZm9yRWFjaChlZGdlID0+IHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHBhcnRpY2xlc1BlckVkZ2U7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBpIC8gcGFydGljbGVzUGVyRWRnZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gZWRnZS5zdGFydC54ICsgKGVkZ2UuZW5kLnggLSBlZGdlLnN0YXJ0LngpICogdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gZWRnZS5zdGFydC55ICsgKGVkZ2UuZW5kLnkgLSBlZGdlLnN0YXJ0LnkpICogdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBZGQgc29tZSByYW5kb21uZXNzCiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5OiBPdXR3YXJkIGZyb20gY2VudGVyIG9mIHRyaWFuZ2xlIChhcHByb3ggMCwgNCkgKyBGb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0geyB4OiAwLCB5OiAxLjUgfTsgLy8gUm91Z2ggY2VudGVyIG9mIG1hc3MKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh4IC0gY2VudGVyLngsIHkgLSBjZW50ZXIueSwgMCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKDguMCArIE1hdGgucmFuZG9tKCkgKiAxMi4wKTsKICAgICAgICAgICAgICAgICAgICB2ZWwuYWRkKGZvcndhcmREaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyMC4wKSk7IC8vIFN0cm9uZyBmb3J3YXJkIG1vbWVudHVtCgp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHZlbCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiA2LjAsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjUgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGFhZmYsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjAsIC8vIFNwaW4KICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpIC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIG9uIHBlcmltZXRlciB0byBvdXRsaW5lIHRoZSBzaGFwZSBhcyBpdCBicmVha3MKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDMuMCwgbGlmZTogMC4zLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdHJpZ2dlckdsYXNzU2hhdHRlcihwb3MsIHZlbCkgewogICAgICAgICAgICBpZiAoIXRoaXMucGFydGljbGVNYW5hZ2VyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmb3J3YXJkID0gdmVsLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5tYXgoMjAuMCwgdmVsLmxlbmd0aCgpKTsgLy8gRW5zdXJlIG1pbmltdW0gZXhwbG9zaW9uIHNwZWVkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBUaGUgIlBhbmUiIChSYWRpYWwgYnVyc3Qgb24gdGhlIGdvYWwgcGxhbmUpCiAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB0aGUgYmFycmllciBzaGF0dGVyaW5nIG91dHdhcmQKLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCmNvbnN0IHNoYXJkQ291bnQgPSAxNTsgLy8gUmVkdWNlZCBmcm9tIDUwCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHNoYXJkQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDEwLjA7IC8vIExhcmdlciByYWRpdXMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5jb3MoYW5nbGUpICogciwgTWF0aC5zaW4oYW5nbGUpICogciwgMCk7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IGlzIHJhZGlhbCBvdXR3YXJkIGZyb20gaW1wYWN0IGNlbnRlcgogICAgICAgICAgICAgICAgY29uc3QgcmFkaWFsRGlyID0gb2Zmc2V0LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IHJhZGlhbERpci5tdWx0aXBseVNjYWxhcigxNS4wICsgTWF0aC5yYW5kb20oKSAqIDI1LjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGQgZm9yd2FyZCBtb21lbnR1bSAoVGhlIGJhbGwgcHVuY2hlcyB0aHJvdWdoKQogICAgICAgICAgICAgICAgc2hhcmRWZWwuYWRkKGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqIDAuOCkpOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDYuMCArIE1hdGgucmFuZG9tKCkgKiA4LjAsIAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiArIE1hdGgucmFuZG9tKCkgKiAwLjgsCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMjUuMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhhYWZmZmYsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQovLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDIwCiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IChpbXBhY3Qgem9uZSkKICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA0LjA7CiAgICAgICAgICAgICAgICBwLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogTW9zdGx5IGZvcndhcmQsIHNvbWUgc3ByZWFkCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqICgxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41KSk7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICAKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcCwgewogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBzaGFyZFZlbCwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogNS4wICsgTWF0aC5yYW5kb20oKSAqIDcuMCwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDE1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIwLjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxNS4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBJbXBhY3QgRmxhc2ggJiBTb3VuZAogICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDEwLjAsIGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gSGlnaCBwaXRjaCBpbXBhY3QgdG8gc2ltdWxhdGUgZ2xhc3MgYnJlYWtpbmcKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDIuNSB9KTsgCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC41IH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICB9CiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wb3dlclVwTWFuYWdlcikgdGhpcy5wb3dlclVwTWFuYWdlci5yZXNldCgpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQmFycmllcnMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQSkgdGhpcy5zdGFkaXVtLmJhcnJpZXJBLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQikgdGhpcy5zdGFkaXVtLmJhcnJpZXJCLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC4xOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBwb3NzZXNzaW9uVGVhbUlkOwogICAgICAgIH0KCgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgLy8gSWYgYSB0ZWFtIGhhcyBwb3NzZXNzaW9uIChhZnRlciBnb2FsKSwgc3RhbmRhcmQga2lja29mZgogICAgICAgICAgICBpZiAocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ZWFtID0gdGhpcy50ZWFtc1twb3NzZXNzaW9uVGVhbUlkXTsKICAgICAgICAgICAgICAgIGlmICh0ZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWYgPSB0ZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1mICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0aWVzLmJhbGwuZ3JhYihtZik7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQobWYubWVzaCwgbWYudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCnRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2NoYXJnZSc7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBSZXNldCBCYWxsIHRvIENlbnRlciAoRGVlcCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBiYWxsLmRyb3AoKTsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTUsIDApOyAvLyBTdGFydCBERUVQICgtNW0pIGZvciAiZ3JvdW5kIHVwIiByaXNlCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBvc2l0aW9uIENhcHRhaW5zIChNRnMpCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgIGlmIChob21lTUYgJiYgaG9tZU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA4KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaG9tZU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5TUYgJiYgYXdheU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGF3YXlNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gQ2FtZXJhIEZvY3VzCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQoYmFsbC5tZXNoLCBudWxsKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIC8vIFpvb20gaW4gdGlnaHQKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAtMTI7IAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjQ7IC8vIExvb2sgZG93biBzdGVlcAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCdWlsZCBUZW5zaW9uCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiUkVBRFkuLi4iLCAnbm9ybWFsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAwLjUgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpDaGFyZ2UoZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY2hhcmdlRHVyYXRpb24gPSAyLjA7IC8vIExvbmdlciBidWlsZCB1cCBmb3IgY2luZW1hdGljIGZlZWwKCiAgICAgICAgICAgIC8vIFBIQVNFIDE6IENIQVJHRSAoUmlzaW5nIGZyb20gZGVwdGhzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyIDwgY2hhcmdlRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmJsaXR6VGltZXIgLyBjaGFyZ2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGVhc2VUID0gdCAqIHQ7IC8vIFF1YWRyYXRpYyBlYXNlIGluCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJpc2UgZnJvbSAtNSB0byAwIChHcm91bmQgdXAgZWZmZWN0KQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPSAtNS4wICsgKDUuMCAqIGVhc2VUKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3BpbiB1cCAoRXhwb25lbnRpYWwpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueSArPSAoMTAuMCArIDUwLjAgKiB0KSAqIGR0OwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnggKz0gKDUuMCArIDIwLjAgKiB0KSAqIGR0OwoKICAgICAgICAgICAgICAgIC8vIFNxdWFzaCAoRmxhdHRlbiBsaWtlIGEgZGlzYyBidWlsZGluZyBlbmVyZ3kpCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmVtZSBzcXVhc2ggYXQgdGhlIGVuZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAtICgwLjcgKiBlYXNlVCk7IC8vIEZsYXR0ZW4gWSB0byAwLjMKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKDAuNSAqIGVhc2VUKTsgLy8gRXhwYW5kIFhaCiAgICAgICAgICAgICAgICAgICAgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldChzdHJldGNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhbWVyYSBTaGFrZSBpbmNyZWFzaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4yICogdCk7CgogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzOiBSaXNpbmcgRW5lcmd5IGZyb20gZ3JvdW5kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGVzIHJpc2luZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBNYXRoLmZsb29yKHQgKiA4KSArIDE7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMCAqICgxLjAgLSB0KTsgLy8gUmFkaXVzIHNocmlua3MgYXMgaXQgZ2V0cyBjbG9zZXIgdG8gbGF1bmNoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGJhbGwubWVzaC5wb3NpdGlvbi55IC0gMS4wOyAvLyBCZWxvdyBiYWxsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgeiksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjQsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIHQgKiAwLjUgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUEhBU0UgMjogTEFVTkNICiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2xhdW5jaCc7CiAgICAgICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOyAvLyBSZXNldCBmb3IgbGF1bmNoIHBoYXNlCgogICAgICAgICAgICAgICAgLy8gVElNRUQgQU5OT1VOQ0VNRU5UCiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IDEuMCB9KTsgLy8gQm9vbQogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMS4wIH0pOyAgIC8vIFdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIExhdW5jaCBCYWxsCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAzNSwgMCk7IC8vIFNob290IFVQIEZBU1QKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMC40LCAzLjAsIDAuNCk7IC8vIEV4dHJlbWUgc3RyZXRjaCB2ZXJ0aWNhbAoKICAgICAgICAgICAgICAgIC8vIEZYOiBNYXNzaXZlIEdyb3VuZCBFcnVwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogOC4wIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogNi4wIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIHN0cmVhbQogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnkgKz0gaSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgzLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAxMDsgLy8gWm9vbSBvdXQgZmFzdAogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC4wOyAvLyBMZXZlbCBvdXQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYXB0YWlucyBKdW1wCiAgICAgICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGp1bXBUbyA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIocC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDEuMjsgLy8gU3RlZXAganVtcAogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuY29weShkaXIpLm11bHRpcGx5U2NhbGFyKDE4LjApOyAvLyBGYXN0IGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoX2p1bXAnLCAwLjEpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqdW1wVG8oaG9tZU1GKTsKICAgICAgICAgICAgICAgIGp1bXBUbyhhd2F5TUYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpMYXVuY2goZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZ3Jhdml0eSBtYW51YWxseSBmb3IgY2luZW1hdGljIGZlZWwgKEluY3JlYXNlZCBncmF2aXR5IGZvciBzbmFwcGllciBhcmMpCiAgICAgICAgICAgIGJhbGwudmVsb2NpdHkueSAtPSA0MC4wICogZHQ7IAogICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgIC8vIE1vdmUgUGxheWVycyBtYW51YWxseQogICAgICAgICAgICBjb25zdCB1cGRhdGVKdW1wZXIgPSAocCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkueSAtPSAyNS4wICogZHQ7IC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdChiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGhvbWVNRik7CiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihhd2F5TUYpOwoKICAgICAgICAgICAgLy8gUEhBU0UgMzogR1JBQiAoQXBleCB+MC43cykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA+IDAuNyAmJiB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykgewogICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFdpbm5lciAoNTAvNTAgKyBTdGF0IGJpYXMpCiAgICAgICAgICAgICAgICBjb25zdCBob21lU3AgPSBob21lTUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTcCA9IGF3YXlNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgdG90YWwgPSBob21lU3AgKyBhd2F5U3A7CiAgICAgICAgICAgICAgICBjb25zdCByb2xsID0gTWF0aC5yYW5kb20oKSAqIHRvdGFsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3aW5uZXIgPSAocm9sbCA8IGhvbWVTcCkgPyBob21lTUYgOiBhd2F5TUY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGJhbGwuZ3JhYih3aW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJXT04hIiwgd2lubmVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVHJhbnNpdGlvbiB0byBBY3RpdmUKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gd2lubmVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh3aW5uZXIubWVzaCwgd2lubmVyLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7IC8vIE9wdGlvbmFsOiBLZWVwIHNtb290aCBvciBzbmFwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCi8vIEluaXRpYWwgc3RhcnQKc3RhcnRNYXRjaChtb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgSFVEIFNoYWtlIGJhc2VkIG9uIGltcGFjdCB0eXBlCiAgICAgICAgICAgIGxldCBzaGFrZUFtb3VudCA9IDUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIHNoYWtlQW1vdW50ID0gMTUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgc2hha2VBbW91bnQgPSAzMC4wOwogICAgICAgICAgICB0aGlzLmFkZEhVRFNoYWtlKHNoYWtlQW1vdW50KTsKCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQgdG8gcHJldmVudCBlYXJseSByZW1vdmFsIG9mIG5ldyBjbGFzcwogICAgICAgICAgICBpZiAodGhpcy5faW1wYWN0VGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2ltcGFjdFRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cyAocmVmbG93IHRyaWNrKQogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24gKyBidWZmZXIgZm9yIGFuaW1hdGlvbiB0YWlsCiAgICAgICAgICAgIC8vIFdlIGFkZCBhIGJpdCBtb3JlIHRpbWUgdGhhbiB0aGUgcGF1c2UgZHVyYXRpb24gdG8gbGV0IHRoZSBDU1MgYW5pbWF0aW9uIGZpbmlzaAogICAgICAgICAgICBjb25zdCBhbmltRHVyYXRpb24gPSAodHlwZSA9PT0gJ3NoYXR0ZXInID8gNTAwIDogKHR5cGUgPT09ICdoZWF2eScgPyAyNTAgOiAxNTApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfSwgYW5pbUR1cmF0aW9uKTsKICAgICAgICB9CgogICAgICAgIGFkZEhVRFNoYWtlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5odWRTaGFrZUludGVuc2l0eSArIGFtb3VudCwgNTAuMCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFVEU2hha2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBEZWNheQogICAgICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSAtPSBkdCAqIDYwLjA7IC8vIERlY2F5IGFwcHJveCA2MHB4IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3QgeCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5odWRTaGFrZUludGVuc2l0eTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3gudG9GaXhlZCgxKX1weCwgJHt5LnRvRml4ZWQoMSl9cHgpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gbWFpbiBIVUQgY29udGFpbmVycwogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIGV4aXN0aW5nIHNrZXcKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gYHNrZXdYKC0xMGRlZykgJHt0cmFuc2Zvcm19YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25Db250YWluZXIpIGFjdGlvbkNvbnRhaW5lci5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9odWRTaGFrZURpcnR5KSB7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB0byBjbGVhbiBzdGF0ZQogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS50cmFuc2Zvcm0gPSAnc2tld1goLTEwZGVnKSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVBdWRpb1N0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYXVkaW9NYW5hZ2VyKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdGVuc2lvbiA9IDA7CgogICAgICAgICAgICAvLyAxLiBCYWxsIFRocmVhdAogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnIHx8IHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gYmFsbC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5taW4oTWF0aC5hYnMoeiAtIGdvYWxEaXN0KSwgTWF0aC5hYnMoeiArIGdvYWxEaXN0KSk7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXRSYW5nZSA9IDM1LjA7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsVGhyZWF0ID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3RUb0dvYWwgLyB0aHJlYXRSYW5nZSkpOwogICAgICAgICAgICAgICAgdGVuc2lvbiArPSBiYWxsVGhyZWF0ICogYmFsbFRocmVhdDsgLy8gUXVhZHJhdGljIHJhbXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU2NvcmUgUHJlc3N1cmUgKENsb3NlIGdhbWUpCiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBNYXRoLmFicyh0aGlzLnNjb3JlLmhvbWUgLSB0aGlzLnNjb3JlLmF3YXkpOwogICAgICAgICAgICBpZiAoZGlmZiA8PSAxKSB0ZW5zaW9uICs9IDAuMTU7CgogICAgICAgICAgICAvLyAzLiBUaW1lIFByZXNzdXJlIChMYXN0IG1pbnV0ZSkKICAgICAgICAgICAgY29uc3QgdGltZUxlZnQgPSB0aGlzLmhhbGZEdXJhdGlvbiAtIHRoaXMudGltZTsKICAgICAgICAgICAgaWYgKHRpbWVMZWZ0IDwgNjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2FjdGl2ZScpIHsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gMC4yICogKDEuMCAtICh0aW1lTGVmdCAvIDYwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKHRlbnNpb24sIHRoaXMuaXNPdmVydGltZSk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgaW4gYWN0aXZlIGdhbWUgb3IgbWVudQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5fZW52QnViYmxlVGltZXIgPSAodGhpcy5fZW52QnViYmxlVGltZXIgfHwgMCkgLSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLl9lbnZCdWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gaW50ZXJ2YWw6IDAuMnMgdG8gMC44cyAoRnJlcXVlbnQgc3RyZWFtcykKICAgICAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBhIHJhbmRvbSBzcG90IG9uIHRoZSBmbG9vcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA3MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogOTA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAtMjA7IC8vIERlZXAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBhICJTdHJlYW0iIChCdXJzdCBvZiBidWJibGVzIHJpc2luZyB0b2dldGhlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IDMgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJlYW1TcGVlZCA9IDMuMCArIE1hdGgucmFuZG9tKCkgKiA0LjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeUJhc2UgLSAoTWF0aC5yYW5kb20oKSAqIDUuMCksIC8vIFN0YWdnZXJlZCBzdGFydCBkZXB0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeiArIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGVfbWljcm8nLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiAyLjAsIC8vIExvbmcgbGlmZSB0byByZWFjaCB0b3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA4ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIFNoaW1tZXJ5IHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1TcGVlZCArIChNYXRoLnJhbmRvbSgpICogMi4wKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWc6IDAuMQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl9hZHZhbmNlU3RhdGUoKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5zdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdyZXNldCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydEtpY2tvZmYodGhpcy5uZXh0U3RhdGVQYXlsb2FkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2tpY2tvZmYnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2hhbGZ0aW1lJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYWxmID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIE9UIG9yIEVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvbGRlbl9nb2FsJzoKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuODsgLy8gUmVzdG9yZSBzcGVlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","/GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LlByYWN0aWNlTWFuYWdlcih0aGlzKTsgLy8gSW5pdGlhbGl6ZSBQcmFjdGljZSBNYW5hZ2VyCiAgICAgICAgICAgIHRoaXMuX2luamVjdFN0eWxlcygpOwp0aGlzLl9pbml0VUkoKTsKICAgICAgICB9CgpfaW5pdENpbmVtYXRpY3MoKSB7CiAgICAgICAgICAgIC8vIE1lbnUgQmFja2dyb3VuZCBTaG90cyAoQi1Sb2xsKQogICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1lbnVTaG90cyA9IFsKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDEwLjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KDYwLCAzNSwgNjApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCksIHQpOyBjYW0ubG9va0F0KDAsIDAsIDApOyB9IH0sCiAgICAgICAgICAgICAgICB7IGR1cmF0aW9uOiA4LjAsIHVwZGF0ZTogKHQsIGNhbSkgPT4geyBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgLTI1ICsgNTAqdCk7IGNhbS5sb29rQXQoMCwgMiwgKC0yNSArIDUwKnQpKjAuOCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNvbnN0IGEgPSB0KzMuNTsgY2FtLnBvc2l0aW9uLnNldCgtMTArTWF0aC5jb3MoYSkqMTAsIDQsIC0xMCtNYXRoLnNpbihhKSoxMCk7IGNhbS5sb29rQXQoLTEwLCAxLjUsIC0xMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDcuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgLTUsIDMyKS5sZXJwKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKSwgdCk7IGNhbS5sb29rQXQoMCwgMTUsIDQ1KTsgY2FtLnJvdGF0aW9uLnogPSAodC0wLjUpKjAuMTU7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoMCwgNTAsIDApLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgMTAsIDApLCB0KnQqKDMtMip0KSk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IGNhbS5yb3RhdGlvbi56ID0gdCowLjg7IH0gfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gRXBpYyBJbnRybyBTZXF1ZW5jZSAoIkhlcmN1bGVhbiIpCiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90cyA9IFsKICAgICAgICAgICAgICAgIC8vIDEuICJUaGUgQXdha2VuaW5nIiAtIENsb3NlIG9uIFNwaGVyZSAtPiBab29tIE91dCBVcHNpZGUgRG93biAtPiBMaWdodHMgJiBSb2FyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlRIRSBTUEhFUkUgUE9PTCIsICJzbGFtIik7IAogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5yZXNldExpZ2h0cygpOyAvLyBFbnN1cmUgZGFyayBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgc3RhcnQgc291bmQgKERlZXAgaHVtIC8gVW5kZXJ3YXRlciBmZWVsKQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBFYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IHQgPCAwLjUgPyAyICogdCAqIHQgOiAtMSArICg0IC0gMiAqIHQpICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwVCA9IE1hdGgucG93KHQsIDMuMCk7IC8vIFN0cm9uZyBleHBvbmVudGlhbCB6b29tIG91dAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FtZXJhIE1vdGlvbjogU3RhcnQgSU5TSURFL0NMT1NFICgwLDAsMikgLT4gRW5kIEZBUiBCQUNLL1VQICgwLCA4MCwgMTYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDIpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgODAsIDE2MCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHN0YXJ0UG9zLCBlbmRQb3MsIGV4cFQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRHluYW1pYyBSb2xsOiBUdXJuIHVwc2lkZSBkb3duICgwIC0+IFBJKQogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucm90YXRpb24ueiA9IGVhc2UgKiBNYXRoLlBJOyAKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExpZ2h0IFNlcXVlbmNpbmcgJiBTb3VuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRQcm9ncmVzcyA9IE1hdGgubWF4KDAsICh0IC0gMC4yKSAvIDAuNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVDb3VudCA9IE1hdGguZmxvb3IobGlnaHRQcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciAiUm9hciB0byBMaWZlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpZ2h0UHJvZ3Jlc3MgPiAwLjUgJiYgIXRoaXMuX2hhc1JvYXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNyB9KTsgLy8gRGVlcCByb2FyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC44LCByYXRlOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA8PSBhY3RpdmVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSB0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3ByaXRlICYmICFzcHJpdGUudmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFkaXVtLnR1cm5PbkxpZ2h0KGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmR1c3RyaWFsIExpZ2h0IFNGWAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaCA9IDAuNSArIChpIC8gdG90YWwpICogMC41OyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMC40LCByYXRlOiBwaXRjaCwgdmFyaWFuY2U6IDAuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgUm9hciIgLSBTd2VlcGluZyBjcm93ZCBzaG90CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDQuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTEVHRU5EQVJZIEFSRU5BIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcsIHsgdm9sdW1lOiAwLjcgfSk7IC8vIENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IC1NYXRoLlBJLzIgKyAodCAqIE1hdGguUEkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gaXNQb3J0cmFpdCA/IDg1IDogNjU7IC8vIFB1bGwgYmFjayBpbiBwb3J0cmFpdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMTUsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCA1LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIkhvbWUgR2xvcnkiIC0gT3JiaXQgSG9tZSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkVTQUlEIEFVUk9DSFMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2NlbGVicmF0ZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3JiaXQgSG9tZSBUZWFtIChTaWRlIDEsIC1aKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAtMjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguUEkgKyAodCAqIDEuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gMjAgOiAxMjsgLy8gUHVsbCBiYWNrIGlmIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoY2VudGVyLnggKyBNYXRoLmNvcyhhbmdsZSkqciwgNCwgY2VudGVyLnogKyBNYXRoLnNpbihhbmdsZSkqcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoY2VudGVyLngsIDIsIGNlbnRlci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNC4gIkVuZW15IEdhdGVzIiAtIFRyYWNraW5nIEF3YXkgVGVhbQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAzLjUsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkxVQ0EgR09FUlMiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnBsYXkoJ2lkbGUnLCAwLjIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMC41IH0pOyAvLyBXaG9vc2gKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYWNraW5nIEF3YXkgVGVhbSAoU2lkZSAtMSwgK1opCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gbmV3IFRIUkVFLlZlY3RvcjMoLTE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDE1LCAyLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQb3J0cmFpdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueCAqPSAxLjU7IGVuZC54ICo9IDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0LnogKz0gMTA7IGVuZC56ICs9IDEwOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnQsIGVuZCwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMywgMjUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA1LiAiVGhlIFNwaGVyZSIgLSBab29tIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgb25TdGFydDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJywgeyB2b2x1bWU6IDAuOCB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMzAsIGlzUG9ydHJhaXQgPyA3MCA6IDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxNCwgMjIpOyAvLyBHYW1lcGxheSBjYW0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdDsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLmxlcnBWZWN0b3JzKHAxLCBwMiwgc3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIF9pbmplY3RTdHlsZXMoKSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmx1eC1keW5hbWljLXN0eWxlcycpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgICAgICAgICAgc3R5bGUuaWQgPSAnZmx1eC1keW5hbWljLXN0eWxlcyc7CnN0eWxlLnRleHRDb250ZW50ID0gYAogICAgICAgICAgICAgICAgQGtleWZyYW1lcyB0ZXh0U2xhbSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSg0KTsgb3BhY2l0eTogMDsgbGV0dGVyLXNwYWNpbmc6IDUwcHg7IH0KICAgICAgICAgICAgICAgICAgICAxMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgbGV0dGVyLXNwYWNpbmc6IDVweDsgfQogICAgICAgICAgICAgICAgICAgIDE1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMSk7IH0KICAgICAgICAgICAgICAgICAgICAyMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgfQogICAgICAgICAgICAgICAgICAgIDgwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJsdXIoMTBweCk7IH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLmFubm91bmNlbWVudC1zbGFtIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgdG9wOiA0NSU7IGxlZnQ6IDUwJTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogOTZweDsKICAgICAgICAgICAgICAgICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjZmZkZDAwIDQ1JSwgI2ZmODgwMCAxMDAlKTsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgICAgICAgICAgICAgICAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsMCwwLDEpKSBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjYpKTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMDAwOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogdGV4dFNsYW0gMS44cyBjdWJpYy1iZXppZXIoMC4xLCAwLjgsIDAuMSwgMSkgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMTAsIDI1LCA2MCwgMC45NSkgMCUsIHJnYmEoMCwgMCwgMCwgMC45OCkgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTkwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzOwogICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig4cHgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkuYWN0aXZlIHsgb3BhY2l0eTogMTsgcG9pbnRlci1ldmVudHM6IGF1dG87IH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXRpdGxlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0dhcmFtb25kJywgc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA1MnB4OyBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBhYWZmLCAwIDAgNDBweCAjMDA0NGFhOwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDMwcHg7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkICMwMGFhZmY7CiAgICAgICAgICAgICAgICAgICAgcGFkZGluZy1ib3R0b206IDEwcHg7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDgwJTsgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZS1jb250YWluZXIgewogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogNDBweDsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA4MHB4OyBjb2xvcjogI2ZmZDcwMDsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjYjg4NjBiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLm1vZGFsLXZzIHsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMjRweDsgY29sb3I6ICMwMGFhZmY7IG9wYWNpdHk6IDAuNzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuZmxhc2gtb3ZlcmxheSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjEwMDsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMXMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgQGtleWZyYW1lcyBjbGFzaFBvcCB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAxOyB9CiAgICAgICAgICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMC44OyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDIuMCk7IG9wYWNpdHk6IDA7IH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAuY2xhc2gtc3BhcmsgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogNjBweDsgaGVpZ2h0OiA2MHB4OwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsICNmZmZmZmYgMCUsICNmZmZmMDAgNDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxNTAwOwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBzY3JlZW47CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBjbGFzaFBvcCAwLjNzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZmFhMDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMKICAgICAgICAgICAgdGhpcy51aS5zY29yZVBsYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1wbGF5ZXInKTsKICAgICAgICAgICAgdGhpcy51aS5zY29yZUNwdSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZS1jcHUnKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aW1lci1kaXNwbGF5Jyk7CiAgICAgICAgICAgIHRoaXMudWkuaGFsZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoYWxmLWluZGljYXRvcicpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbm5vdW5jZW1lbnQnKTsKdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29mZnNjcmVlbi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQovLyBJbml0aWFsIFN0YXRlCi8vIEluaXRpYWwgU3RhdGUKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBlbmQgbWVudSBpcyBoaWRkZW4gb24gaW5pdAogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KICAgICAgICBfdXBkYXRlU2NvcmVVSSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVQbGF5ZXIpIHRoaXMudWkuc2NvcmVQbGF5ZXIuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZUNwdSkgdGhpcy51aS5zY29yZUNwdS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucG93ZXJVcE1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIC8vIFBsYXllciBXYXJtdXAgQW5pbWF0aW9ucwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSW50cm9XYXJtdXAoZHQpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnRyb1Nob3RzIHx8IHRoaXMuaW50cm9TaG90cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdEluZGV4ID49IHRoaXMuaW50cm9TaG90cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsgLy8gRG9uZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBzaG90IHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTaG90ID0gdGhpcy5pbnRyb1Nob3RzW3RoaXMuaW50cm9TaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFNob3Qub25TdGFydCkgbmV4dFNob3Qub25TdGFydCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGN1cnJlbnQgc2hvdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvU2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEgJiYgc2hvdC51cGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5nZSA9IDYwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlLCAKICAgICAgICAgICAgICAgICAgICAgICAgLTEwICsgTWF0aC5yYW5kb20oKSoyMCwgCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBwb3MsIHsgbGlmZTogMy4wICsgTWF0aC5yYW5kb20oKSoyLjAsIHNjYWxlOiAwLjMgKyBNYXRoLnJhbmRvbSgpKjAuNCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQmFja2dyb3VuZCBTeXN0ZW1zCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUZWNoY29weSBVSQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSAmJiB0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLyB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSkgKiAxMDApOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gYCR7cGN0fSVgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdCBiYXNlZCBvbiB1cmdlbmN5CiAgICAgICAgICAgICAgICBpZiAocGN0IDwgMzApIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJyNmZjAwMDAnOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2VuZXJhbCBWaXN1YWxzIChBbHdheXMgUnVuIGV4Y2VwdCBJbnRyby9NZW51KQovLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIGJhbmQgcG9zc2Vzc2lvbiBkaXNwbGF5CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24gJiYgdGhpcy5lbnRpdGllcyAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVIYXNCYWxsID0gYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAmJiBiYWxsLmhvbGRlci50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudXBkYXRlQmFuZFBvc3Nlc3Npb24oaG9tZUhhc0JhbGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHRoaXMubWluaU1hcC51cGRhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgdGhpcy5mbG9hdGluZ1RleHQudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBVcGRhdGUgcGFydGljbGVzIGR1cmluZyBnYW1lcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQp0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgovLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZSgyMC4wKTsgLy8gSFVEIFNoYWtlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJBUlJJRVIgU0hBVFRFUiBMT0dJQwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgLy8gSG9tZSBzY29yZXMgYXQgLVogKEF3YXkgR29hbCksIEF3YXkgc2NvcmVzIGF0ICtaIChIb21lIEdvYWwpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHNjb3JlciA9PT0gJ2hvbWUnKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgY29uc3QgYmFycmllciA9IChzY29yZXIgPT09ICdob21lJykgPyB0aGlzLnN0YWRpdW0uYmFycmllckEgOiB0aGlzLnN0YWRpdW0uYmFycmllckI7CiAgICAgICAgICAgICAgICBpZiAoYmFycmllcikgYmFycmllci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFZlbCA9IHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eS5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IGJhbGxWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFBvaW50IG9uIEdvYWwgUGxhbmUgKFRoZSAiSW52aXNpYmxlIEJhcnJpZXIiKQogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gYmFsbFBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gU25hcCBlZmZlY3QgdG8gdGhlIGJhcnJpZXIgcGxhbmUgKFopIGJ1dCBrZWVwIFgvWSBvZiBlbnRyeQogICAgICAgICAgICAgICAgaW1wYWN0UG9zLnogPSBnb2FsWjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgR2xhc3MgU2hhdHRlciBFZmZlY3QgKFRoZSBIb2xlKQogICAgICAgICAgICAgICAgdGhpcy5fdHJpZ2dlckdsYXNzU2hhdHRlcihpbXBhY3RQb3MsIGJhbGxWZWwpOwoKICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVHJpYW5nbGUgRnJhbWUgU2hhdHRlciAoVGhlIEJhcnJpZXIpCiAgICAgICAgICAgICAgICB0aGlzLl9zcGF3blRyaWFuZ2xlU2hhdHRlcihnb2FsWiwgZm9yd2FyZCk7CgogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGltcGFjdFBvcywgeyBzY2FsZTogMjAuMCwgbGlmZTogMC42LCBjb2xvcjogMHgwMGZmZmYgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDEyLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLIChTdWRkZW4gRGVhdGgpCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2xvdyBtb3Rpb24gZmluaXNoCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuMjsKCiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheSAoMC41cyBnYW1lIHRpbWUgYXQgMC4yIHNjYWxlID0gMi41cyByZWFsIHRpbWUpCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvbGRlbl9nb2FsJzsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcyAoMi4wcyBnYW1lIHRpbWUpCiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDIuMDsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gbG9zZXI7CiAgICAgICAgfQoKX3NwYXduVHJpYW5nbGVTaGF0dGVyKHpQb3MsIGZvcndhcmREaXIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVHJpYW5nbGUgVmVydGljZXMgKE1hdGNoZXMgU3RhZGl1bS5qcyBnZW9tZXRyeSkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KY29uc3QgdjEgPSB7IHg6IC0xNCwgeTogOSB9OwogICAgICAgICAgICBjb25zdCB2MiA9IHsgeDogMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjMgPSB7IHg6IDAsIHk6IC02IH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBlZGdlcyA9IFsKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYxLCBlbmQ6IHYyIH0sCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MiwgZW5kOiB2MyB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjMsIGVuZDogdjEgfQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdAovLyBJbmNyZWFzZWQgZGVuc2l0eSBmb3IgImFwcGVhcmluZyIgZWZmZWN0CmNvbnN0IHBhcnRpY2xlc1BlckVkZ2UgPSA0OyAvLyBSZWR1Y2VkIGZyb20gMTIgZm9yIGxlc3MgY2x1dHRlcgogICAgICAgICAgICAKICAgICAgICAgICAgZWRnZXMuZm9yRWFjaChlZGdlID0+IHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHBhcnRpY2xlc1BlckVkZ2U7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBpIC8gcGFydGljbGVzUGVyRWRnZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gZWRnZS5zdGFydC54ICsgKGVkZ2UuZW5kLnggLSBlZGdlLnN0YXJ0LngpICogdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gZWRnZS5zdGFydC55ICsgKGVkZ2UuZW5kLnkgLSBlZGdlLnN0YXJ0LnkpICogdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBZGQgc29tZSByYW5kb21uZXNzCiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5OiBPdXR3YXJkIGZyb20gY2VudGVyIG9mIHRyaWFuZ2xlIChhcHByb3ggMCwgNCkgKyBGb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0geyB4OiAwLCB5OiAxLjUgfTsgLy8gUm91Z2ggY2VudGVyIG9mIG1hc3MKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh4IC0gY2VudGVyLngsIHkgLSBjZW50ZXIueSwgMCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKDguMCArIE1hdGgucmFuZG9tKCkgKiAxMi4wKTsKICAgICAgICAgICAgICAgICAgICB2ZWwuYWRkKGZvcndhcmREaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyMC4wKSk7IC8vIFN0cm9uZyBmb3J3YXJkIG1vbWVudHVtCgp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHZlbCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiA2LjAsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjUgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg0NGFhZmYsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjAsIC8vIFNwaW4KICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpIC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIG9uIHBlcmltZXRlciB0byBvdXRsaW5lIHRoZSBzaGFwZSBhcyBpdCBicmVha3MKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDMuMCwgbGlmZTogMC4zLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdHJpZ2dlckdsYXNzU2hhdHRlcihwb3MsIHZlbCkgewogICAgICAgICAgICBpZiAoIXRoaXMucGFydGljbGVNYW5hZ2VyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmb3J3YXJkID0gdmVsLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5tYXgoMjAuMCwgdmVsLmxlbmd0aCgpKTsgLy8gRW5zdXJlIG1pbmltdW0gZXhwbG9zaW9uIHNwZWVkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBUaGUgIlBhbmUiIChSYWRpYWwgYnVyc3Qgb24gdGhlIGdvYWwgcGxhbmUpCiAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB0aGUgYmFycmllciBzaGF0dGVyaW5nIG91dHdhcmQKLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCmNvbnN0IHNoYXJkQ291bnQgPSAxNTsgLy8gUmVkdWNlZCBmcm9tIDUwCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHNoYXJkQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDEwLjA7IC8vIExhcmdlciByYWRpdXMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5jb3MoYW5nbGUpICogciwgTWF0aC5zaW4oYW5nbGUpICogciwgMCk7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5IGlzIHJhZGlhbCBvdXR3YXJkIGZyb20gaW1wYWN0IGNlbnRlcgogICAgICAgICAgICAgICAgY29uc3QgcmFkaWFsRGlyID0gb2Zmc2V0LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IHJhZGlhbERpci5tdWx0aXBseVNjYWxhcigxNS4wICsgTWF0aC5yYW5kb20oKSAqIDI1LjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGQgZm9yd2FyZCBtb21lbnR1bSAoVGhlIGJhbGwgcHVuY2hlcyB0aHJvdWdoKQogICAgICAgICAgICAgICAgc2hhcmRWZWwuYWRkKGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqIDAuOCkpOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDYuMCArIE1hdGgucmFuZG9tKCkgKiA4LjAsIAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiArIE1hdGgucmFuZG9tKCkgKiAwLjgsCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMjUuMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhhYWZmZmYsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQovLyAyLiBUaGUgIkhvbGUiIChIaWdoIHZlbG9jaXR5IHNoYXJkcyBtb3ZpbmcgZm9yd2FyZCB3aXRoIHRoZSBiYWxsKQogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDIwCiAgICAgICAgICAgICAgICBjb25zdCBwID0gcG9zLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IChpbXBhY3Qgem9uZSkKICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA0LjA7CiAgICAgICAgICAgICAgICBwLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogTW9zdGx5IGZvcndhcmQsIHNvbWUgc3ByZWFkCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZFZlbCA9IGZvcndhcmQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihzcGVlZCAqICgxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41KSk7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICBzaGFyZFZlbC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjA7CiAgICAgICAgICAgICAgICAKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcCwgewogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBzaGFyZFZlbCwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogNS4wICsgTWF0aC5yYW5kb20oKSAqIDcuMCwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAgKyBNYXRoLnJhbmRvbSgpLAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDE1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIwLjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxNS4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBJbXBhY3QgRmxhc2ggJiBTb3VuZAogICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDEwLjAsIGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gSGlnaCBwaXRjaCBpbXBhY3QgdG8gc2ltdWxhdGUgZ2xhc3MgYnJlYWtpbmcKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDIuNSB9KTsgCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC41IH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICB9CiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wb3dlclVwTWFuYWdlcikgdGhpcy5wb3dlclVwTWFuYWdlci5yZXNldCgpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQmFycmllcnMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQSkgdGhpcy5zdGFkaXVtLmJhcnJpZXJBLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bS5iYXJyaWVyQikgdGhpcy5zdGFkaXVtLmJhcnJpZXJCLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC4xOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBwb3NzZXNzaW9uVGVhbUlkOwogICAgICAgIH0KCgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgLy8gSWYgYSB0ZWFtIGhhcyBwb3NzZXNzaW9uIChhZnRlciBnb2FsKSwgc3RhbmRhcmQga2lja29mZgogICAgICAgICAgICBpZiAocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ZWFtID0gdGhpcy50ZWFtc1twb3NzZXNzaW9uVGVhbUlkXTsKICAgICAgICAgICAgICAgIGlmICh0ZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWYgPSB0ZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1mICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0aWVzLmJhbGwuZ3JhYihtZik7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQobWYubWVzaCwgbWYudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCnRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2NoYXJnZSc7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBSZXNldCBCYWxsIHRvIENlbnRlciAoRGVlcCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBiYWxsLmRyb3AoKTsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTUsIDApOyAvLyBTdGFydCBERUVQICgtNW0pIGZvciAiZ3JvdW5kIHVwIiByaXNlCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBvc2l0aW9uIENhcHRhaW5zIChNRnMpCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgIGlmIChob21lTUYgJiYgaG9tZU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA4KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaG9tZU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5TUYgJiYgYXdheU1GLm1lc2gpIHsKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGF3YXlNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGF3YXlNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gQ2FtZXJhIEZvY3VzCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQoYmFsbC5tZXNoLCBudWxsKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIC8vIFpvb20gaW4gdGlnaHQKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAtMTI7IAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjQ7IC8vIExvb2sgZG93biBzdGVlcAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCdWlsZCBUZW5zaW9uCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiUkVBRFkuLi4iLCAnbm9ybWFsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnc3dpbScsIHsgdm9sdW1lOiAwLjUgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpDaGFyZ2UoZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY2hhcmdlRHVyYXRpb24gPSAyLjA7IC8vIExvbmdlciBidWlsZCB1cCBmb3IgY2luZW1hdGljIGZlZWwKCiAgICAgICAgICAgIC8vIFBIQVNFIDE6IENIQVJHRSAoUmlzaW5nIGZyb20gZGVwdGhzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyIDwgY2hhcmdlRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmJsaXR6VGltZXIgLyBjaGFyZ2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGVhc2VUID0gdCAqIHQ7IC8vIFF1YWRyYXRpYyBlYXNlIGluCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJpc2UgZnJvbSAtNSB0byAwIChHcm91bmQgdXAgZWZmZWN0KQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPSAtNS4wICsgKDUuMCAqIGVhc2VUKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3BpbiB1cCAoRXhwb25lbnRpYWwpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueSArPSAoMTAuMCArIDUwLjAgKiB0KSAqIGR0OwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnggKz0gKDUuMCArIDIwLjAgKiB0KSAqIGR0OwoKICAgICAgICAgICAgICAgIC8vIFNxdWFzaCAoRmxhdHRlbiBsaWtlIGEgZGlzYyBidWlsZGluZyBlbmVyZ3kpCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmVtZSBzcXVhc2ggYXQgdGhlIGVuZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAtICgwLjcgKiBlYXNlVCk7IC8vIEZsYXR0ZW4gWSB0byAwLjMKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKDAuNSAqIGVhc2VUKTsgLy8gRXhwYW5kIFhaCiAgICAgICAgICAgICAgICAgICAgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldChzdHJldGNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhbWVyYSBTaGFrZSBpbmNyZWFzaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4yICogdCk7CgogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzOiBSaXNpbmcgRW5lcmd5IGZyb20gZ3JvdW5kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGVzIHJpc2luZyBmYXN0CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBNYXRoLmZsb29yKHQgKiA4KSArIDE7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMCAqICgxLjAgLSB0KTsgLy8gUmFkaXVzIHNocmlua3MgYXMgaXQgZ2V0cyBjbG9zZXIgdG8gbGF1bmNoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGJhbGwubWVzaC5wb3NpdGlvbi55IC0gMS4wOyAvLyBCZWxvdyBiYWxsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgeiksIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjQsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIHQgKiAwLjUgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUEhBU0UgMjogTEFVTkNICiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2JsaXR6X2xhdW5jaCc7CiAgICAgICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOyAvLyBSZXNldCBmb3IgbGF1bmNoIHBoYXNlCgogICAgICAgICAgICAgICAgLy8gVElNRUQgQU5OT1VOQ0VNRU5UCiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IDEuMCB9KTsgLy8gQm9vbQogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnLCB7IHZvbHVtZTogMS4wIH0pOyAgIC8vIFdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIExhdW5jaCBCYWxsCiAgICAgICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnNldCgwLCAzNSwgMCk7IC8vIFNob290IFVQIEZBU1QKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMC40LCAzLjAsIDAuNCk7IC8vIEV4dHJlbWUgc3RyZXRjaCB2ZXJ0aWNhbAoKICAgICAgICAgICAgICAgIC8vIEZYOiBNYXNzaXZlIEdyb3VuZCBFcnVwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogOC4wIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGJhbGwubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogNi4wIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIHN0cmVhbQogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnkgKz0gaSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgzLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5jdXJyZW50UHVsbEJhY2sgPSAxMDsgLy8gWm9vbSBvdXQgZmFzdAogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC4wOyAvLyBMZXZlbCBvdXQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYXB0YWlucyBKdW1wCiAgICAgICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGp1bXBUbyA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIocC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDEuMjsgLy8gU3RlZXAganVtcAogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuY29weShkaXIpLm11bHRpcGx5U2NhbGFyKDE4LjApOyAvLyBGYXN0IGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoX2p1bXAnLCAwLjEpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqdW1wVG8oaG9tZU1GKTsKICAgICAgICAgICAgICAgIGp1bXBUbyhhd2F5TUYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQmxpdHpMYXVuY2goZHQpIHsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyICs9IGR0OwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZ3Jhdml0eSBtYW51YWxseSBmb3IgY2luZW1hdGljIGZlZWwgKEluY3JlYXNlZCBncmF2aXR5IGZvciBzbmFwcGllciBhcmMpCiAgICAgICAgICAgIGJhbGwudmVsb2NpdHkueSAtPSA0MC4wICogZHQ7IAogICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgIC8vIE1vdmUgUGxheWVycyBtYW51YWxseQogICAgICAgICAgICBjb25zdCB1cGRhdGVKdW1wZXIgPSAocCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkueSAtPSAyNS4wICogZHQ7IC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdChiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGhvbWVNRik7CiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihhd2F5TUYpOwoKICAgICAgICAgICAgLy8gUEhBU0UgMzogR1JBQiAoQXBleCB+MC43cykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA+IDAuNyAmJiB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykgewogICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFdpbm5lciAoNTAvNTAgKyBTdGF0IGJpYXMpCiAgICAgICAgICAgICAgICBjb25zdCBob21lU3AgPSBob21lTUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTcCA9IGF3YXlNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgdG90YWwgPSBob21lU3AgKyBhd2F5U3A7CiAgICAgICAgICAgICAgICBjb25zdCByb2xsID0gTWF0aC5yYW5kb20oKSAqIHRvdGFsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3aW5uZXIgPSAocm9sbCA8IGhvbWVTcCkgPyBob21lTUYgOiBhd2F5TUY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGJhbGwuZ3JhYih3aW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJXT04hIiwgd2lubmVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVHJhbnNpdGlvbiB0byBBY3RpdmUKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gd2lubmVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh3aW5uZXIubWVzaCwgd2lubmVyLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7IC8vIE9wdGlvbmFsOiBLZWVwIHNtb290aCBvciBzbmFwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCi8vIEluaXRpYWwgc3RhcnQKc3RhcnRNYXRjaChtb2RlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgSFVEIFNoYWtlIGJhc2VkIG9uIGltcGFjdCB0eXBlCiAgICAgICAgICAgIGxldCBzaGFrZUFtb3VudCA9IDUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIHNoYWtlQW1vdW50ID0gMTUuMDsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgc2hha2VBbW91bnQgPSAzMC4wOwogICAgICAgICAgICB0aGlzLmFkZEhVRFNoYWtlKHNoYWtlQW1vdW50KTsKCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQgdG8gcHJldmVudCBlYXJseSByZW1vdmFsIG9mIG5ldyBjbGFzcwogICAgICAgICAgICBpZiAodGhpcy5faW1wYWN0VGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2ltcGFjdFRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cyAocmVmbG93IHRyaWNrKQogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24gKyBidWZmZXIgZm9yIGFuaW1hdGlvbiB0YWlsCiAgICAgICAgICAgIC8vIFdlIGFkZCBhIGJpdCBtb3JlIHRpbWUgdGhhbiB0aGUgcGF1c2UgZHVyYXRpb24gdG8gbGV0IHRoZSBDU1MgYW5pbWF0aW9uIGZpbmlzaAogICAgICAgICAgICBjb25zdCBhbmltRHVyYXRpb24gPSAodHlwZSA9PT0gJ3NoYXR0ZXInID8gNTAwIDogKHR5cGUgPT09ICdoZWF2eScgPyAyNTAgOiAxNTApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfSwgYW5pbUR1cmF0aW9uKTsKICAgICAgICB9CgogICAgICAgIGFkZEhVRFNoYWtlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5odWRTaGFrZUludGVuc2l0eSArIGFtb3VudCwgNTAuMCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFVEU2hha2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBEZWNheQogICAgICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSAtPSBkdCAqIDYwLjA7IC8vIERlY2F5IGFwcHJveCA2MHB4IHBlciBzZWNvbmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3QgeCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5odWRTaGFrZUludGVuc2l0eTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3gudG9GaXhlZCgxKX1weCwgJHt5LnRvRml4ZWQoMSl9cHgpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gbWFpbiBIVUQgY29udGFpbmVycwogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIGV4aXN0aW5nIHNrZXcKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gYHNrZXdYKC0xMGRlZykgJHt0cmFuc2Zvcm19YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25Db250YWluZXIpIGFjdGlvbkNvbnRhaW5lci5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9odWRTaGFrZURpcnR5KSB7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB0byBjbGVhbiBzdGF0ZQogICAgICAgICAgICAgICAgY29uc3QgaHVkVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKTsKICAgICAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS50cmFuc2Zvcm0gPSAnc2tld1goLTEwZGVnKSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1pbmltYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250YWluZXInKTsKICAgICAgICAgICAgICAgIGlmIChtaW5pbWFwKSBtaW5pbWFwLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVBdWRpb1N0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYXVkaW9NYW5hZ2VyKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdGVuc2lvbiA9IDA7CgogICAgICAgICAgICAvLyAxLiBCYWxsIFRocmVhdAogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnIHx8IHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gYmFsbC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5taW4oTWF0aC5hYnMoeiAtIGdvYWxEaXN0KSwgTWF0aC5hYnMoeiArIGdvYWxEaXN0KSk7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXRSYW5nZSA9IDM1LjA7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsVGhyZWF0ID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3RUb0dvYWwgLyB0aHJlYXRSYW5nZSkpOwogICAgICAgICAgICAgICAgdGVuc2lvbiArPSBiYWxsVGhyZWF0ICogYmFsbFRocmVhdDsgLy8gUXVhZHJhdGljIHJhbXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU2NvcmUgUHJlc3N1cmUgKENsb3NlIGdhbWUpCiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBNYXRoLmFicyh0aGlzLnNjb3JlLmhvbWUgLSB0aGlzLnNjb3JlLmF3YXkpOwogICAgICAgICAgICBpZiAoZGlmZiA8PSAxKSB0ZW5zaW9uICs9IDAuMTU7CgogICAgICAgICAgICAvLyAzLiBUaW1lIFByZXNzdXJlIChMYXN0IG1pbnV0ZSkKICAgICAgICAgICAgY29uc3QgdGltZUxlZnQgPSB0aGlzLmhhbGZEdXJhdGlvbiAtIHRoaXMudGltZTsKICAgICAgICAgICAgaWYgKHRpbWVMZWZ0IDwgNjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2FjdGl2ZScpIHsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gMC4yICogKDEuMCAtICh0aW1lTGVmdCAvIDYwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKHRlbnNpb24sIHRoaXMuaXNPdmVydGltZSk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgaW4gYWN0aXZlIGdhbWUgb3IgbWVudQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5fZW52QnViYmxlVGltZXIgPSAodGhpcy5fZW52QnViYmxlVGltZXIgfHwgMCkgLSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLl9lbnZCdWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gaW50ZXJ2YWw6IDAuMnMgdG8gMC44cyAoRnJlcXVlbnQgc3RyZWFtcykKICAgICAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBhIHJhbmRvbSBzcG90IG9uIHRoZSBmbG9vcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA3MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB6ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogOTA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAtMjA7IC8vIERlZXAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBhICJTdHJlYW0iIChCdXJzdCBvZiBidWJibGVzIHJpc2luZyB0b2dldGhlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IDMgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJlYW1TcGVlZCA9IDMuMCArIE1hdGgucmFuZG9tKCkgKiA0LjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeUJhc2UgLSAoTWF0aC5yYW5kb20oKSAqIDUuMCksIC8vIFN0YWdnZXJlZCBzdGFydCBkZXB0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeiArIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGVfbWljcm8nLCBwb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDQuMCArIE1hdGgucmFuZG9tKCkgKiAyLjAsIC8vIExvbmcgbGlmZSB0byByZWFjaCB0b3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA4ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIFNoaW1tZXJ5IHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1TcGVlZCArIChNYXRoLnJhbmRvbSgpICogMi4wKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWc6IDAuMQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl9hZHZhbmNlU3RhdGUoKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5zdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdyZXNldCc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydEtpY2tvZmYodGhpcy5uZXh0U3RhdGVQYXlsb2FkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2tpY2tvZmYnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2hhbGZ0aW1lJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYWxmID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIE9UIG9yIEVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvbGRlbl9nb2FsJzoKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgpIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IDAuODsgLy8gUmVzdG9yZSBzcGVlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMjU7IC8vIEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjUpCgogICAgICAgICAgICAvLyBTdHVjayBEZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5sYXN0U3R1Y2tQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBTYWZldHk6IEF1dG8tbGluayBiYWxsIGlmIG1pc3NpbmcKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgewogICAgICAgICAgICAgICAgdGhpcy5iYWxsUmVmID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzUHJhY3RpY2UgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gZ2FtZSAmJiBnYW1lLnN0YXRlID09PSAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghaXNBY3RpdmUgJiYgIWlzUHJhY3RpY2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNEZW1vID0gZ2FtZSAmJiBnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgY29uc3QgaXNIdW1hblRlYW0gPSB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlUGxheWVyID0gdGhpcy50ZWFtICYmICh0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKTsKICAgICAgICAgICAgY29uc3Qgc2hvdWxkUnVuQUkgPSAoIWlzSHVtYW5UZWFtIHx8IGlzRGVtbyB8fCAoaXNIdW1hblRlYW0gJiYgIWlzQWN0aXZlUGxheWVyKSk7CiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7IC8vIFJlc2V0IHN0dWNrIGlmIHN0dW5uZWQKICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRSdW5BSSAmJiBpc1RlYW1BSUVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBTVFVDSyBERVRFQ1RJT04gLS0tCiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrQ2hlY2tUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tDaGVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5sYXN0U3R1Y2tQb3MpOwogICAgICAgICAgICAgICAgICAgIC8vIElmIHRyeWluZyB0byBtb3ZlIChpbnB1dCBhY3RpdmUpIGJ1dCBtb3ZlZCB2ZXJ5IGxpdHRsZQogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC41ICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gMC41OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQZXJjZXB0aW9uIFVwZGF0ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lICogMC41KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxwaGEgPSBNYXRoLm1pbigxLjAsIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcy5sZXJwKHJlYWxUYXJnZXQsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBEZWNpc2lvbgogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGlvbgogICAgICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZVN0YXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW50ZXJjZXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNoSW1tdW5pdHlUaW1lciA+IDApIHRoaXMudGVjaEltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIdW1hbiBjb250cm9sbGVkIG9yIGRpc2FibGVkCiAgICAgICAgICAgICAgICBjb25zdCBpc0RyaXZlbkJ5SHVtYW4gPSBpc0h1bWFuVGVhbSAmJiBpc0FjdGl2ZVBsYXllciAmJiAhaXNEZW1vOwogICAgICAgICAgICAgICAgaWYgKCFpc0RyaXZlbkJ5SHVtYW4pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBQb3NzZXNzaW9uCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBVbnN0dWNrIFByaW9yaXR5CiAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdVTlNUVUNLJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIFJvbGUgcmVsYXRpdmUgdG8gQmFsbCAoQW50aS1Td2FybSkKICAgICAgICAgICAgY29uc3QgbXlEaXN0U3EgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvdW50IHRlYW1tYXRlcyBjbG9zZXIgdG8gYmFsbAogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsLm1lc2gucG9zaXRpb24pIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VyQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgICAgICAgICAvLyBBbGxvdyAyIGNoYXNlcnMgbWF4IHRvIHByZXNzCiAgICAgICAgICAgICAgICAgICAgaWYgKGNsb3NlckNvdW50IDwgMikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOyAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgLy8gTWFyayBvciBab25lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBpcyBmcmVlCiAgICAgICAgICAgICAgICAvLyBBbGxvdyAxIGNoYXNlciBtYXggKGNsb3Nlc3QpIHRvIGF2b2lkIGNvbGxpc2lvbiBtZXNzLCBvdGhlcnMgc3VwcG9ydC9kZWZlbmQKICAgICAgICAgICAgICAgIGlmIChjbG9zZXJDb3VudCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CmNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1VOU1RVQ0snOiB0aGlzLl9zdGF0ZVVuc3R1Y2soZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlVW5zdHVjayhkdCkgewogICAgICAgICAgICAgLy8gTW92ZSBpbiBhIHJhbmRvbSBkaXJlY3Rpb24gdG8gYnJlYWsgZnJlZQogICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjEpIHsgCiAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGRhc2ggaWYgc3R1Y2sKICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPiAxMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgfQp9CiAgICAgICAgfQoKX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gZ29hbERpc3QgKiBhdHRhY2tEaXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAyMC4wICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IHRoaXMuY3VycmVudEVOIDwgMTA7CiAgICAgICAgICAgIGNvbnN0IGlzUGxheW1ha2VyID0gdGhpcy5pc01pZGZpZWxkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoKGlzU3Vycm91bmRlZCB8fCBsb3dFTiB8fCBpc1BsYXltYWtlcikgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgY29uc3QgYmVzdE1hdGUgPSB0aGlzLl9maW5kQmVzdFBhc3NUYXJnZXQoKTsKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdQQScpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2lzU3Vycm91bmRlZCgpIHsKICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pIDwgNC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY291bnQgPj0gMjsKICAgICAgICB9CgogICAgICAgIF9zbWFydFRocm93KGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsKSB7CiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CiAgICAgICAgICAgIGxldCB0ZW1wVGVjaCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSAmJiB0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0ICYmIHRoaXMuc3RhdHMuSFAgPj0gYmFzZUNvc3QpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnNob290OwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMuc2hvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnBhc3MgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlKTsKCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGSVg6IEFsbG93IGVudGVyaW5nIGdvYWwgY3JlYXNlIGlmIGJhbGwgaXMgaW5zaWRlIGl0IChwcmV2ZW50IHN0dWNrIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGxJbkNyZWFzZSA9IHRoaXMuX2lzUG9zSW5DcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIGlmICghYmFsbEluQ3JlYXNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVSZXR1cm5Ib21lKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICAvLyBNYWludGFpbiBmb3JtYXRpb24gb3IgbWFyawogICAgICAgICAgICBpZiAodGhpcy5tYXJraW5nICYmIHRoaXMubWFya2luZy5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTdGljayB0byBtYXJrCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrUG9zID0gdGhpcy5tYXJraW5nLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NSA6IC00NTsgLy8gTXkgZ29hbAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBiZXR3ZWVuIG1hcmsgYW5kIGdvYWwgKEdvYWwtc2lkZSBtYXJraW5nKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBnb2FsWiAtIG1hcmtQb3Mueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDIuNSk7IC8vIDIuNW0gZ29hbC1zaWRlIG9mIG1hcmsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgbWFyayBpcyB2ZXJ5IGNsb3NlIHRvIGJhbGwsIHRpZ2h0ZW4gdXAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycChtYXJrUG9zLCAwLjUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQyAoT3Bwb3J0dW5pc3RpYykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUodGhpcy5iYWxsUmVmLmhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gWm9uZSBkZWZlbnNlIChGb3JtYXRpb24gaG9tZSArIHNoaWZ0IHRvd2FyZHMgYmFsbCkKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGJhc2VkIG9uIGJhbGwgWiAoZGVwdGgpIHRvIGNvbXByZXNzIGZpZWxkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFogPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgICAgIC8vIEJsZW5kIGhvbWUgWiBhbmQgYmFsbCBaICgwLjcgaG9tZSwgMC4zIGJhbGwpIHRvIHNoaWZ0IGZvcm1hdGlvbiBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IHRoaXMuaG9tZVBvc2l0aW9uLnogKiAwLjcgKyBiYWxsWiAqIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBzaGlmdCBYIHNsaWdodGx5IHRvd2FyZHMgYmFsbCBzaWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFggPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjggKyBiYWxsWCAqIDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2lzUG9zSW5DcmVhc2UocG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwogICAgICAgICAgICBmb3IgKGxldCBnIG9mIGdvYWxzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHBvcy54IC0gZy54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSBwb3MueiAtIGcuejsKICAgICAgICAgICAgICAgIGlmIChkeCpkeCArIGR6KmR6IDwgY3JlYXNlUmFkaXVzKmNyZWFzZVJhZGl1cykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLWdvYWxEaXN0IH0sIHsgeDogMCwgejogZ29hbERpc3QgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5Owpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF9hdHRlbXB0VGFja2xlKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nIHx8IHRoaXMuaXNSZWNvdmVyaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAxNSkgcmV0dXJuOyAvLyBDb3N0IGNoZWNrCgogICAgICAgICAgICAvLyAxLiBQcmVkaWN0IFRhcmdldCBQb3NpdGlvbiAoTGVhZCB0aGUgdGFyZ2V0KQogICAgICAgICAgICAvLyBUYWNrbGUgc2xpZGUgdGFrZXMgfjAuNXMuIFdlIHdhbnQgdG8gaGl0IHRoZW0gd2hlcmUgdGhleSB3aWxsIGJlLgogICAgICAgICAgICBjb25zdCBsZWFkVGltZSA9IDAuNDsgCiAgICAgICAgICAgIGNvbnN0IHByZWRpY3RlZFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIHByZWRpY3RlZFBvcy5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBWZWN0b3IgdG8gUHJlZGljdGVkIFNwb3QKICAgICAgICAgICAgY29uc3QgdG9QcmVkID0gcHJlZGljdGVkUG9zLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0b1ByZWQueSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b1ByZWQubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBSYW5nZSBDaGVjawogICAgICAgICAgICAvLyBMdW5nZSBjb3ZlcnMgfjEyIHVuaXRzLiBJZGVhbGx5IHRyaWdnZXIgYXJvdW5kIDYtOCB1bml0cyBhd2F5LgogICAgICAgICAgICBpZiAoZGlzdCA8IDguMCAmJiBkaXN0ID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0b1ByZWQubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIEFuZ2xlIENoZWNrIChNdXN0IGJlIGZhY2luZyByb3VnaGx5IHRoZSByaWdodCB3YXkpCiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgZG90ID0gZndkLmRvdCh0b1ByZWQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAwLjg1IGlzIH4zMCBkZWdyZWVzLiBBSSBuZWVkcyB0byBiZSBsaW5lZCB1cC4KICAgICAgICAgICAgICAgIGlmIChkb3QgPiAwLjg1KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gNS4gUmVhY3Rpb24gQ2hlY2sgKERvbid0IHRhY2tsZSBpbnN0YW50bHkgZXZlcnkgZnJhbWUpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjE1KSB7IC8vIDE1JSBjaGFuY2UgcGVyIGRlY2lzaW9uIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUodG9QcmVkLngsIHRvUHJlZC56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQUlQbGF5ZXIgPSBBSVBsYXllcjsKfSkoKTs=","./AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMjU7IC8vIEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjUpCgogICAgICAgICAgICAvLyBTdHVjayBEZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5sYXN0U3R1Y2tQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBTYWZldHk6IEF1dG8tbGluayBiYWxsIGlmIG1pc3NpbmcKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgewogICAgICAgICAgICAgICAgdGhpcy5iYWxsUmVmID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzUHJhY3RpY2UgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gZ2FtZSAmJiBnYW1lLnN0YXRlID09PSAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghaXNBY3RpdmUgJiYgIWlzUHJhY3RpY2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNEZW1vID0gZ2FtZSAmJiBnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgY29uc3QgaXNIdW1hblRlYW0gPSB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlUGxheWVyID0gdGhpcy50ZWFtICYmICh0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKTsKICAgICAgICAgICAgY29uc3Qgc2hvdWxkUnVuQUkgPSAoIWlzSHVtYW5UZWFtIHx8IGlzRGVtbyB8fCAoaXNIdW1hblRlYW0gJiYgIWlzQWN0aXZlUGxheWVyKSk7CiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7IC8vIFJlc2V0IHN0dWNrIGlmIHN0dW5uZWQKICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRSdW5BSSAmJiBpc1RlYW1BSUVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBTVFVDSyBERVRFQ1RJT04gLS0tCiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrQ2hlY2tUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tDaGVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5sYXN0U3R1Y2tQb3MpOwogICAgICAgICAgICAgICAgICAgIC8vIElmIHRyeWluZyB0byBtb3ZlIChpbnB1dCBhY3RpdmUpIGJ1dCBtb3ZlZCB2ZXJ5IGxpdHRsZQogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC41ICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gMC41OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQZXJjZXB0aW9uIFVwZGF0ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lICogMC41KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxwaGEgPSBNYXRoLm1pbigxLjAsIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcy5sZXJwKHJlYWxUYXJnZXQsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBEZWNpc2lvbgogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGlvbgogICAgICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZVN0YXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW50ZXJjZXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNoSW1tdW5pdHlUaW1lciA+IDApIHRoaXMudGVjaEltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIdW1hbiBjb250cm9sbGVkIG9yIGRpc2FibGVkCiAgICAgICAgICAgICAgICBjb25zdCBpc0RyaXZlbkJ5SHVtYW4gPSBpc0h1bWFuVGVhbSAmJiBpc0FjdGl2ZVBsYXllciAmJiAhaXNEZW1vOwogICAgICAgICAgICAgICAgaWYgKCFpc0RyaXZlbkJ5SHVtYW4pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBQb3NzZXNzaW9uCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBVbnN0dWNrIFByaW9yaXR5CiAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdVTlNUVUNLJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIFJvbGUgcmVsYXRpdmUgdG8gQmFsbCAoQW50aS1Td2FybSkKICAgICAgICAgICAgY29uc3QgbXlEaXN0U3EgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvdW50IHRlYW1tYXRlcyBjbG9zZXIgdG8gYmFsbAogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsLm1lc2gucG9zaXRpb24pIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VyQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgICAgICAgICAvLyBBbGxvdyAyIGNoYXNlcnMgbWF4IHRvIHByZXNzCiAgICAgICAgICAgICAgICAgICAgaWYgKGNsb3NlckNvdW50IDwgMikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOyAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgLy8gTWFyayBvciBab25lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBpcyBmcmVlCiAgICAgICAgICAgICAgICAvLyBBbGxvdyAxIGNoYXNlciBtYXggKGNsb3Nlc3QpIHRvIGF2b2lkIGNvbGxpc2lvbiBtZXNzLCBvdGhlcnMgc3VwcG9ydC9kZWZlbmQKICAgICAgICAgICAgICAgIGlmIChjbG9zZXJDb3VudCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CmNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1VOU1RVQ0snOiB0aGlzLl9zdGF0ZVVuc3R1Y2soZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlVW5zdHVjayhkdCkgewogICAgICAgICAgICAgLy8gTW92ZSBpbiBhIHJhbmRvbSBkaXJlY3Rpb24gdG8gYnJlYWsgZnJlZQogICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjEpIHsgCiAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGRhc2ggaWYgc3R1Y2sKICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPiAxMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgfQp9CiAgICAgICAgfQoKX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gZ29hbERpc3QgKiBhdHRhY2tEaXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAyMC4wICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IHRoaXMuY3VycmVudEVOIDwgMTA7CiAgICAgICAgICAgIGNvbnN0IGlzUGxheW1ha2VyID0gdGhpcy5pc01pZGZpZWxkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoKGlzU3Vycm91bmRlZCB8fCBsb3dFTiB8fCBpc1BsYXltYWtlcikgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgY29uc3QgYmVzdE1hdGUgPSB0aGlzLl9maW5kQmVzdFBhc3NUYXJnZXQoKTsKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdQQScpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2lzU3Vycm91bmRlZCgpIHsKICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pIDwgNC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY291bnQgPj0gMjsKICAgICAgICB9CgogICAgICAgIF9zbWFydFRocm93KGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsKSB7CiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CiAgICAgICAgICAgIGxldCB0ZW1wVGVjaCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSAmJiB0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0ICYmIHRoaXMuc3RhdHMuSFAgPj0gYmFzZUNvc3QpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnNob290OwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMuc2hvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnBhc3MgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlKTsKCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGSVg6IEFsbG93IGVudGVyaW5nIGdvYWwgY3JlYXNlIGlmIGJhbGwgaXMgaW5zaWRlIGl0IChwcmV2ZW50IHN0dWNrIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGxJbkNyZWFzZSA9IHRoaXMuX2lzUG9zSW5DcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIGlmICghYmFsbEluQ3JlYXNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVSZXR1cm5Ib21lKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICAvLyBNYWludGFpbiBmb3JtYXRpb24gb3IgbWFyawogICAgICAgICAgICBpZiAodGhpcy5tYXJraW5nICYmIHRoaXMubWFya2luZy5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTdGljayB0byBtYXJrCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrUG9zID0gdGhpcy5tYXJraW5nLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NSA6IC00NTsgLy8gTXkgZ29hbAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBiZXR3ZWVuIG1hcmsgYW5kIGdvYWwgKEdvYWwtc2lkZSBtYXJraW5nKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBnb2FsWiAtIG1hcmtQb3Mueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDIuNSk7IC8vIDIuNW0gZ29hbC1zaWRlIG9mIG1hcmsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgbWFyayBpcyB2ZXJ5IGNsb3NlIHRvIGJhbGwsIHRpZ2h0ZW4gdXAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycChtYXJrUG9zLCAwLjUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQyAoT3Bwb3J0dW5pc3RpYykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUodGhpcy5iYWxsUmVmLmhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gWm9uZSBkZWZlbnNlIChGb3JtYXRpb24gaG9tZSArIHNoaWZ0IHRvd2FyZHMgYmFsbCkKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGJhc2VkIG9uIGJhbGwgWiAoZGVwdGgpIHRvIGNvbXByZXNzIGZpZWxkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFogPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgICAgIC8vIEJsZW5kIGhvbWUgWiBhbmQgYmFsbCBaICgwLjcgaG9tZSwgMC4zIGJhbGwpIHRvIHNoaWZ0IGZvcm1hdGlvbiBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IHRoaXMuaG9tZVBvc2l0aW9uLnogKiAwLjcgKyBiYWxsWiAqIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBzaGlmdCBYIHNsaWdodGx5IHRvd2FyZHMgYmFsbCBzaWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFggPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjggKyBiYWxsWCAqIDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2lzUG9zSW5DcmVhc2UocG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwogICAgICAgICAgICBmb3IgKGxldCBnIG9mIGdvYWxzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHBvcy54IC0gZy54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSBwb3MueiAtIGcuejsKICAgICAgICAgICAgICAgIGlmIChkeCpkeCArIGR6KmR6IDwgY3JlYXNlUmFkaXVzKmNyZWFzZVJhZGl1cykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLWdvYWxEaXN0IH0sIHsgeDogMCwgejogZ29hbERpc3QgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5Owpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF9hdHRlbXB0VGFja2xlKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nIHx8IHRoaXMuaXNSZWNvdmVyaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAxNSkgcmV0dXJuOyAvLyBDb3N0IGNoZWNrCgogICAgICAgICAgICAvLyAxLiBQcmVkaWN0IFRhcmdldCBQb3NpdGlvbiAoTGVhZCB0aGUgdGFyZ2V0KQogICAgICAgICAgICAvLyBUYWNrbGUgc2xpZGUgdGFrZXMgfjAuNXMuIFdlIHdhbnQgdG8gaGl0IHRoZW0gd2hlcmUgdGhleSB3aWxsIGJlLgogICAgICAgICAgICBjb25zdCBsZWFkVGltZSA9IDAuNDsgCiAgICAgICAgICAgIGNvbnN0IHByZWRpY3RlZFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIHByZWRpY3RlZFBvcy5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBWZWN0b3IgdG8gUHJlZGljdGVkIFNwb3QKICAgICAgICAgICAgY29uc3QgdG9QcmVkID0gcHJlZGljdGVkUG9zLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0b1ByZWQueSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b1ByZWQubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBSYW5nZSBDaGVjawogICAgICAgICAgICAvLyBMdW5nZSBjb3ZlcnMgfjEyIHVuaXRzLiBJZGVhbGx5IHRyaWdnZXIgYXJvdW5kIDYtOCB1bml0cyBhd2F5LgogICAgICAgICAgICBpZiAoZGlzdCA8IDguMCAmJiBkaXN0ID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0b1ByZWQubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIEFuZ2xlIENoZWNrIChNdXN0IGJlIGZhY2luZyByb3VnaGx5IHRoZSByaWdodCB3YXkpCiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgZG90ID0gZndkLmRvdCh0b1ByZWQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAwLjg1IGlzIH4zMCBkZWdyZWVzLiBBSSBuZWVkcyB0byBiZSBsaW5lZCB1cC4KICAgICAgICAgICAgICAgIGlmIChkb3QgPiAwLjg1KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gNS4gUmVhY3Rpb24gQ2hlY2sgKERvbid0IHRhY2tsZSBpbnN0YW50bHkgZXZlcnkgZnJhbWUpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjE1KSB7IC8vIDE1JSBjaGFuY2UgcGVyIGRlY2lzaW9uIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUodG9QcmVkLngsIHRvUHJlZC56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQUlQbGF5ZXIgPSBBSVBsYXllcjsKfSkoKTs=","/AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMjU7IC8vIEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjUpCgogICAgICAgICAgICAvLyBTdHVjayBEZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5sYXN0U3R1Y2tQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBTYWZldHk6IEF1dG8tbGluayBiYWxsIGlmIG1pc3NpbmcKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgewogICAgICAgICAgICAgICAgdGhpcy5iYWxsUmVmID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzUHJhY3RpY2UgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gZ2FtZSAmJiBnYW1lLnN0YXRlID09PSAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghaXNBY3RpdmUgJiYgIWlzUHJhY3RpY2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNEZW1vID0gZ2FtZSAmJiBnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgY29uc3QgaXNIdW1hblRlYW0gPSB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW47CiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlUGxheWVyID0gdGhpcy50ZWFtICYmICh0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzKTsKICAgICAgICAgICAgY29uc3Qgc2hvdWxkUnVuQUkgPSAoIWlzSHVtYW5UZWFtIHx8IGlzRGVtbyB8fCAoaXNIdW1hblRlYW0gJiYgIWlzQWN0aXZlUGxheWVyKSk7CiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7IC8vIFJlc2V0IHN0dWNrIGlmIHN0dW5uZWQKICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRSdW5BSSAmJiBpc1RlYW1BSUVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBTVFVDSyBERVRFQ1RJT04gLS0tCiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrQ2hlY2tUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tDaGVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5sYXN0U3R1Y2tQb3MpOwogICAgICAgICAgICAgICAgICAgIC8vIElmIHRyeWluZyB0byBtb3ZlIChpbnB1dCBhY3RpdmUpIGJ1dCBtb3ZlZCB2ZXJ5IGxpdHRsZQogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC41ICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gMC41OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQZXJjZXB0aW9uIFVwZGF0ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lICogMC41KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxwaGEgPSBNYXRoLm1pbigxLjAsIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcy5sZXJwKHJlYWxUYXJnZXQsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBEZWNpc2lvbgogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGlvbgogICAgICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZVN0YXRlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW50ZXJjZXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNoSW1tdW5pdHlUaW1lciA+IDApIHRoaXMudGVjaEltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIdW1hbiBjb250cm9sbGVkIG9yIGRpc2FibGVkCiAgICAgICAgICAgICAgICBjb25zdCBpc0RyaXZlbkJ5SHVtYW4gPSBpc0h1bWFuVGVhbSAmJiBpc0FjdGl2ZVBsYXllciAmJiAhaXNEZW1vOwogICAgICAgICAgICAgICAgaWYgKCFpc0RyaXZlbkJ5SHVtYW4pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBQb3NzZXNzaW9uCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBVbnN0dWNrIFByaW9yaXR5CiAgICAgICAgICAgIGlmICh0aGlzLnN0dWNrVGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdVTlNUVUNLJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIFJvbGUgcmVsYXRpdmUgdG8gQmFsbCAoQW50aS1Td2FybSkKICAgICAgICAgICAgY29uc3QgbXlEaXN0U3EgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvdW50IHRlYW1tYXRlcyBjbG9zZXIgdG8gYmFsbAogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsLm1lc2gucG9zaXRpb24pIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VyQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgICAgICAgICAvLyBBbGxvdyAyIGNoYXNlcnMgbWF4IHRvIHByZXNzCiAgICAgICAgICAgICAgICAgICAgaWYgKGNsb3NlckNvdW50IDwgMikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOyAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgLy8gTWFyayBvciBab25lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBpcyBmcmVlCiAgICAgICAgICAgICAgICAvLyBBbGxvdyAxIGNoYXNlciBtYXggKGNsb3Nlc3QpIHRvIGF2b2lkIGNvbGxpc2lvbiBtZXNzLCBvdGhlcnMgc3VwcG9ydC9kZWZlbmQKICAgICAgICAgICAgICAgIGlmIChjbG9zZXJDb3VudCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CmNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1VOU1RVQ0snOiB0aGlzLl9zdGF0ZVVuc3R1Y2soZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlVW5zdHVjayhkdCkgewogICAgICAgICAgICAgLy8gTW92ZSBpbiBhIHJhbmRvbSBkaXJlY3Rpb24gdG8gYnJlYWsgZnJlZQogICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjEpIHsgCiAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGRhc2ggaWYgc3R1Y2sKICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPiAxMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChNYXRoLmNvcyhhbmdsZSksIE1hdGguc2luKGFuZ2xlKSk7CiAgICAgICAgICAgICAgICAgfQp9CiAgICAgICAgfQoKX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gZ29hbERpc3QgKiBhdHRhY2tEaXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAyMC4wICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IHRoaXMuY3VycmVudEVOIDwgMTA7CiAgICAgICAgICAgIGNvbnN0IGlzUGxheW1ha2VyID0gdGhpcy5pc01pZGZpZWxkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoKGlzU3Vycm91bmRlZCB8fCBsb3dFTiB8fCBpc1BsYXltYWtlcikgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgY29uc3QgYmVzdE1hdGUgPSB0aGlzLl9maW5kQmVzdFBhc3NUYXJnZXQoKTsKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdQQScpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnU0gnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2lzU3Vycm91bmRlZCgpIHsKICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pIDwgNC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY291bnQgPj0gMjsKICAgICAgICB9CgogICAgICAgIF9zbWFydFRocm93KGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsKSB7CiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CiAgICAgICAgICAgIGxldCB0ZW1wVGVjaCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSAmJiB0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0ICYmIHRoaXMuc3RhdHMuSFAgPj0gYmFzZUNvc3QpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnNob290OwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMuc2hvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnBhc3MgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlKTsKCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGSVg6IEFsbG93IGVudGVyaW5nIGdvYWwgY3JlYXNlIGlmIGJhbGwgaXMgaW5zaWRlIGl0IChwcmV2ZW50IHN0dWNrIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGxJbkNyZWFzZSA9IHRoaXMuX2lzUG9zSW5DcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIGlmICghYmFsbEluQ3JlYXNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVSZXR1cm5Ib21lKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICAvLyBNYWludGFpbiBmb3JtYXRpb24gb3IgbWFyawogICAgICAgICAgICBpZiAodGhpcy5tYXJraW5nICYmIHRoaXMubWFya2luZy5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTdGljayB0byBtYXJrCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrUG9zID0gdGhpcy5tYXJraW5nLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NSA6IC00NTsgLy8gTXkgZ29hbAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBiZXR3ZWVuIG1hcmsgYW5kIGdvYWwgKEdvYWwtc2lkZSBtYXJraW5nKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBnb2FsWiAtIG1hcmtQb3Mueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDIuNSk7IC8vIDIuNW0gZ29hbC1zaWRlIG9mIG1hcmsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgbWFyayBpcyB2ZXJ5IGNsb3NlIHRvIGJhbGwsIHRpZ2h0ZW4gdXAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycChtYXJrUG9zLCAwLjUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgICAgIC8vIEFJIFRBQ0tMRSBMT0dJQyAoT3Bwb3J0dW5pc3RpYykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2F0dGVtcHRUYWNrbGUodGhpcy5iYWxsUmVmLmhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gWm9uZSBkZWZlbnNlIChGb3JtYXRpb24gaG9tZSArIHNoaWZ0IHRvd2FyZHMgYmFsbCkKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGJhc2VkIG9uIGJhbGwgWiAoZGVwdGgpIHRvIGNvbXByZXNzIGZpZWxkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFogPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgICAgIC8vIEJsZW5kIGhvbWUgWiBhbmQgYmFsbCBaICgwLjcgaG9tZSwgMC4zIGJhbGwpIHRvIHNoaWZ0IGZvcm1hdGlvbiBzbGlnaHRseQogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IHRoaXMuaG9tZVBvc2l0aW9uLnogKiAwLjcgKyBiYWxsWiAqIDAuMzsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBzaGlmdCBYIHNsaWdodGx5IHRvd2FyZHMgYmFsbCBzaWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFggPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjggKyBiYWxsWCAqIDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2lzUG9zSW5DcmVhc2UocG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwogICAgICAgICAgICBmb3IgKGxldCBnIG9mIGdvYWxzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHBvcy54IC0gZy54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSBwb3MueiAtIGcuejsKICAgICAgICAgICAgICAgIGlmIChkeCpkeCArIGR6KmR6IDwgY3JlYXNlUmFkaXVzKmNyZWFzZVJhZGl1cykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLWdvYWxEaXN0IH0sIHsgeDogMCwgejogZ29hbERpc3QgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5Owpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF9hdHRlbXB0VGFja2xlKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nIHx8IHRoaXMuaXNSZWNvdmVyaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAxNSkgcmV0dXJuOyAvLyBDb3N0IGNoZWNrCgogICAgICAgICAgICAvLyAxLiBQcmVkaWN0IFRhcmdldCBQb3NpdGlvbiAoTGVhZCB0aGUgdGFyZ2V0KQogICAgICAgICAgICAvLyBUYWNrbGUgc2xpZGUgdGFrZXMgfjAuNXMuIFdlIHdhbnQgdG8gaGl0IHRoZW0gd2hlcmUgdGhleSB3aWxsIGJlLgogICAgICAgICAgICBjb25zdCBsZWFkVGltZSA9IDAuNDsgCiAgICAgICAgICAgIGNvbnN0IHByZWRpY3RlZFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIHByZWRpY3RlZFBvcy5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBWZWN0b3IgdG8gUHJlZGljdGVkIFNwb3QKICAgICAgICAgICAgY29uc3QgdG9QcmVkID0gcHJlZGljdGVkUG9zLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0b1ByZWQueSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0b1ByZWQubGVuZ3RoKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBSYW5nZSBDaGVjawogICAgICAgICAgICAvLyBMdW5nZSBjb3ZlcnMgfjEyIHVuaXRzLiBJZGVhbGx5IHRyaWdnZXIgYXJvdW5kIDYtOCB1bml0cyBhd2F5LgogICAgICAgICAgICBpZiAoZGlzdCA8IDguMCAmJiBkaXN0ID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0b1ByZWQubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIEFuZ2xlIENoZWNrIChNdXN0IGJlIGZhY2luZyByb3VnaGx5IHRoZSByaWdodCB3YXkpCiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgZG90ID0gZndkLmRvdCh0b1ByZWQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAwLjg1IGlzIH4zMCBkZWdyZWVzLiBBSSBuZWVkcyB0byBiZSBsaW5lZCB1cC4KICAgICAgICAgICAgICAgIGlmIChkb3QgPiAwLjg1KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gNS4gUmVhY3Rpb24gQ2hlY2sgKERvbid0IHRhY2tsZSBpbnN0YW50bHkgZXZlcnkgZnJhbWUpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjE1KSB7IC8vIDE1JSBjaGFuY2UgcGVyIGRlY2lzaW9uIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUodG9QcmVkLngsIHRvUHJlZC56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQUlQbGF5ZXIgPSBBSVBsYXllcjsKfSkoKTs=","Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","./Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","/Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwoKLy8gUGVyY2VwdGlvbiBTbW9vdGhpbmcgKFJlYWN0aW9uIERlbGF5KQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnJlYWN0aW9uU3BlZWQgPSA0LjA7IC8vIExvd2VyID0gbW9yZSBkZWxheS9zbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDA7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIApjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3QgaXNIdW1hbkNvbnRyb2xsZWQgPSBnYW1lICYmIHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwoKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCi8vIFkgQm91bmRzIChFeHBhbmRlZCBmb3IgZGVlcGVyIGdvYWwpCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDE4LjA7IAogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAoc2lkZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gZ29hbERpc3QgLSAwLjUpIHsgcG9zLnogPSBnb2FsRGlzdCAtIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC1nb2FsRGlzdCArIDAuNSkgeyBwb3MueiA9IC1nb2FsRGlzdCArIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUgYW5kIHJlZHVjZSBsb2Z0CiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwogICAgICAgICAgICBjb25zdCB0eXBlID0gZm9yY2VkVHlwZSB8fCAnUEEnOwogICAgICAgICAgICBjb25zdCBib29zdCA9IDEuMjsKICAgICAgICAgICAgY29uc3QgZmluYWxQb3dlciA9IHBvd2VyTXVsdGlwbGllciAqIGJvb3N0OwoKICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0gKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDogJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiAxLjIgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ0xFQVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgRGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJFRFVDRUQgTE9GVDogR29hbGllIHRocm93cyBmbGF0dGVyICgwLjI1IGluc3RlYWQgb2YgMC44KQogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBTdGF0cwogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gZmluYWxQb3dlcjsKCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJlY29pbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci54ICogMi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0wLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiAyLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUKICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7Cgp0aGlzLmxvc2VCYWxsKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDMwMCk7IC8vIFdpbmR1cCB0aW1lCgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgODAwKTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKaWYgKCF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9ICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFVQREFURSAtLS0KICAgICAgICAgICAgLy8gU21vb3RobHkgaW50ZXJwb2xhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCBiYWxsIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIFRoaXMgY3JlYXRlcyBhIG5hdHVyYWwgcmVhY3Rpb24gZGVsYXkgYW5kIHByZXZlbnRzIGppdHRlcnkgbWlycm9yaW5nCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkQmFsbFBvcy5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFRocmVhdCBTb3VyY2UKICAgICAgICAgICAgbGV0IHRocmVhdFBvcyA9IF9iYWxsUG9zOwogICAgICAgICAgICBsZXQgaXNUaHJlYXQgPSBmYWxzZTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIENhc2UgQTogQmFsbCBpcyBIZWxkIChQcmUtdGhyb3cpCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlID09PSAnaGVsZCcgJiYgYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFjayBob2xkZXIsIGJ1dCB1c2UgcGVyY2VpdmVkIHBvc2l0aW9uIGlmIHdlIHdhbnRlZCB0byBzaW11bGF0ZSByZWFkaW5nIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIEZvciBub3csIHRyYWNraW5nIHRoZSBiYWxsICh3aGljaCBpcyBvbiB0aGUgcGxheWVyKSB2aWEgcGVyY2VpdmVkUG9zIGlzIHN1ZmZpY2llbnQKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNUaHJlYXQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1NJVElPTklORzogQU5HTEUgQ1VUVElORyAtLS0KICAgICAgICAgICAgICAgIF9iYWxsUG9zLmNvcHkodGhyZWF0UG9zKTsgLy8gVXBkYXRlIHJlZmVyZW5jZSBmb3IgbG9va0F0CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlcgovLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIgKEFkanVzdGVkIGZvciBZIG9mZnNldCkKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgbmV3IFkgb2Zmc2V0IC04LjApCiAgICAgICAgICAgICAgICBfZ29hbENlbnRlci5zZXQoMCwgLTguMCwgbXlHb2FsWik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZlY3RvciBmcm9tIEdvYWwgdG8gQmFsbAogICAgICAgICAgICAgICAgX3RlbXBWZWNHLnN1YlZlY3RvcnMoX2JhbGxQb3MsIF9nb2FsQ2VudGVyKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSBfdGVtcFZlY0cubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBfdGVtcFZlY0cubm9ybWFsaXplKCk7IC8vIE5vdyBob2xkcyBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIEV4dGVuc2lvbiAoSG93IGZhciBvdXQgdG8gc3RlcCkKICAgICAgICAgICAgICAgIC8vIEJhc2U6IDEuNW0gb2ZmIGxpbmUuCiAgICAgICAgICAgICAgICAvLyBNYXg6IDYuMG0gb2ZmIGxpbmUgKEN1dHRpbmcgYW5nbGUpLgogICAgICAgICAgICAgICAgLy8gU2NhbGUgYmFzZWQgb24gYmFsbCBwcm94aW1pdHk6IENsb3NlciBiYWxsID0gTW9yZSBleHRlbnNpb24gKHRvIGEgcG9pbnQpCmxldCBleHRlbnNpb24gPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDMwLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IDEuMCAtIChNYXRoLm1heCgwLCBkaXN0VG9CYWxsIC0gNS4wKSAvIDI1LjApOyAKICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24gPSAxLjUgKyAoNC41ICogcmF0aW8pOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBTYWZldHk6IERvbid0IGdvIHBhc3QgdGhlIGJhbGwgKGtlZXAgMW0gYnVmZmVyKQogICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gTWF0aC5taW4oZXh0ZW5zaW9uLCBkaXN0VG9CYWxsIC0gMS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFRhcmdldCBQb3NpdGlvbiAoQmFzZSBJbnRlcmNlcHRpb24pCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KF9nb2FsQ2VudGVyKS5hZGQoX3RlbXBWZWNHLm11bHRpcGx5U2NhbGFyKGV4dGVuc2lvbikpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA1LiBWZXJ0aWNhbCBPdmVycmlkZSAoSnVtcCB0byBtZWV0IGJhbGwpCiAgICAgICAgICAgICAgICAvLyBFeHBsaWNpdGx5IHNldCBZIHRvIG1hdGNoIGJhbGwgaGVpZ2h0IGlmIGl0J3MgaGlnaAogICAgICAgICAgICAgICAgaWYgKF9iYWxsUG9zLnkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gX2JhbGxQb3MueTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IDAuNTsgLy8gRGVmYXVsdCBzdGFuY2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA2LiBDbGFtcCB0byBHb2FsIEJveCBEaW1lbnNpb25zIChMYXRlcmFsL1ZlcnRpY2FsIExpbWl0cykKICAgICAgICAgICAgICAgIC8vIEdvYWwgV2lkdGggMjIgKCsvLSAxMSksIEhlaWdodCAxOCAoKy8tIDkpLgogICAgICAgICAgICAgICAgLy8gQWxsb3cgc2xpZ2h0bHkgb3V0c2lkZSBwb3N0cyB0byBjb3ZlciBhbmdsZXMuCiAgICAgICAgICAgICAgICBjb25zdCBjbGFtcFggPSB0aGlzLmdvYWxXaWR0aCAqIDAuNjsgLy8gKy8tIDEzLjIKY29uc3QgY2xhbXBZID0gMTguMDsgLy8gSW5jcmVhc2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","./Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwoKLy8gUGVyY2VwdGlvbiBTbW9vdGhpbmcgKFJlYWN0aW9uIERlbGF5KQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnJlYWN0aW9uU3BlZWQgPSA0LjA7IC8vIExvd2VyID0gbW9yZSBkZWxheS9zbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDA7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIApjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3QgaXNIdW1hbkNvbnRyb2xsZWQgPSBnYW1lICYmIHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwoKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCi8vIFkgQm91bmRzIChFeHBhbmRlZCBmb3IgZGVlcGVyIGdvYWwpCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDE4LjA7IAogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAoc2lkZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gZ29hbERpc3QgLSAwLjUpIHsgcG9zLnogPSBnb2FsRGlzdCAtIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC1nb2FsRGlzdCArIDAuNSkgeyBwb3MueiA9IC1nb2FsRGlzdCArIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUgYW5kIHJlZHVjZSBsb2Z0CiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwogICAgICAgICAgICBjb25zdCB0eXBlID0gZm9yY2VkVHlwZSB8fCAnUEEnOwogICAgICAgICAgICBjb25zdCBib29zdCA9IDEuMjsKICAgICAgICAgICAgY29uc3QgZmluYWxQb3dlciA9IHBvd2VyTXVsdGlwbGllciAqIGJvb3N0OwoKICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0gKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDogJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiAxLjIgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ0xFQVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgRGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJFRFVDRUQgTE9GVDogR29hbGllIHRocm93cyBmbGF0dGVyICgwLjI1IGluc3RlYWQgb2YgMC44KQogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBTdGF0cwogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gZmluYWxQb3dlcjsKCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJlY29pbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci54ICogMi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0wLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiAyLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUKICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7Cgp0aGlzLmxvc2VCYWxsKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDMwMCk7IC8vIFdpbmR1cCB0aW1lCgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgODAwKTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKaWYgKCF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9ICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFVQREFURSAtLS0KICAgICAgICAgICAgLy8gU21vb3RobHkgaW50ZXJwb2xhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCBiYWxsIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIFRoaXMgY3JlYXRlcyBhIG5hdHVyYWwgcmVhY3Rpb24gZGVsYXkgYW5kIHByZXZlbnRzIGppdHRlcnkgbWlycm9yaW5nCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkQmFsbFBvcy5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFRocmVhdCBTb3VyY2UKICAgICAgICAgICAgbGV0IHRocmVhdFBvcyA9IF9iYWxsUG9zOwogICAgICAgICAgICBsZXQgaXNUaHJlYXQgPSBmYWxzZTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIENhc2UgQTogQmFsbCBpcyBIZWxkIChQcmUtdGhyb3cpCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlID09PSAnaGVsZCcgJiYgYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFjayBob2xkZXIsIGJ1dCB1c2UgcGVyY2VpdmVkIHBvc2l0aW9uIGlmIHdlIHdhbnRlZCB0byBzaW11bGF0ZSByZWFkaW5nIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIEZvciBub3csIHRyYWNraW5nIHRoZSBiYWxsICh3aGljaCBpcyBvbiB0aGUgcGxheWVyKSB2aWEgcGVyY2VpdmVkUG9zIGlzIHN1ZmZpY2llbnQKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNUaHJlYXQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1NJVElPTklORzogQU5HTEUgQ1VUVElORyAtLS0KICAgICAgICAgICAgICAgIF9iYWxsUG9zLmNvcHkodGhyZWF0UG9zKTsgLy8gVXBkYXRlIHJlZmVyZW5jZSBmb3IgbG9va0F0CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlcgovLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIgKEFkanVzdGVkIGZvciBZIG9mZnNldCkKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgbmV3IFkgb2Zmc2V0IC04LjApCiAgICAgICAgICAgICAgICBfZ29hbENlbnRlci5zZXQoMCwgLTguMCwgbXlHb2FsWik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZlY3RvciBmcm9tIEdvYWwgdG8gQmFsbAogICAgICAgICAgICAgICAgX3RlbXBWZWNHLnN1YlZlY3RvcnMoX2JhbGxQb3MsIF9nb2FsQ2VudGVyKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSBfdGVtcFZlY0cubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBfdGVtcFZlY0cubm9ybWFsaXplKCk7IC8vIE5vdyBob2xkcyBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIEV4dGVuc2lvbiAoSG93IGZhciBvdXQgdG8gc3RlcCkKICAgICAgICAgICAgICAgIC8vIEJhc2U6IDEuNW0gb2ZmIGxpbmUuCiAgICAgICAgICAgICAgICAvLyBNYXg6IDYuMG0gb2ZmIGxpbmUgKEN1dHRpbmcgYW5nbGUpLgogICAgICAgICAgICAgICAgLy8gU2NhbGUgYmFzZWQgb24gYmFsbCBwcm94aW1pdHk6IENsb3NlciBiYWxsID0gTW9yZSBleHRlbnNpb24gKHRvIGEgcG9pbnQpCmxldCBleHRlbnNpb24gPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDMwLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IDEuMCAtIChNYXRoLm1heCgwLCBkaXN0VG9CYWxsIC0gNS4wKSAvIDI1LjApOyAKICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24gPSAxLjUgKyAoNC41ICogcmF0aW8pOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBTYWZldHk6IERvbid0IGdvIHBhc3QgdGhlIGJhbGwgKGtlZXAgMW0gYnVmZmVyKQogICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gTWF0aC5taW4oZXh0ZW5zaW9uLCBkaXN0VG9CYWxsIC0gMS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFRhcmdldCBQb3NpdGlvbiAoQmFzZSBJbnRlcmNlcHRpb24pCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KF9nb2FsQ2VudGVyKS5hZGQoX3RlbXBWZWNHLm11bHRpcGx5U2NhbGFyKGV4dGVuc2lvbikpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA1LiBWZXJ0aWNhbCBPdmVycmlkZSAoSnVtcCB0byBtZWV0IGJhbGwpCiAgICAgICAgICAgICAgICAvLyBFeHBsaWNpdGx5IHNldCBZIHRvIG1hdGNoIGJhbGwgaGVpZ2h0IGlmIGl0J3MgaGlnaAogICAgICAgICAgICAgICAgaWYgKF9iYWxsUG9zLnkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gX2JhbGxQb3MueTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IDAuNTsgLy8gRGVmYXVsdCBzdGFuY2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA2LiBDbGFtcCB0byBHb2FsIEJveCBEaW1lbnNpb25zIChMYXRlcmFsL1ZlcnRpY2FsIExpbWl0cykKICAgICAgICAgICAgICAgIC8vIEdvYWwgV2lkdGggMjIgKCsvLSAxMSksIEhlaWdodCAxOCAoKy8tIDkpLgogICAgICAgICAgICAgICAgLy8gQWxsb3cgc2xpZ2h0bHkgb3V0c2lkZSBwb3N0cyB0byBjb3ZlciBhbmdsZXMuCiAgICAgICAgICAgICAgICBjb25zdCBjbGFtcFggPSB0aGlzLmdvYWxXaWR0aCAqIDAuNjsgLy8gKy8tIDEzLjIKY29uc3QgY2xhbXBZID0gMTguMDsgLy8gSW5jcmVhc2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","/Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwoKLy8gUGVyY2VwdGlvbiBTbW9vdGhpbmcgKFJlYWN0aW9uIERlbGF5KQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnJlYWN0aW9uU3BlZWQgPSA0LjA7IC8vIExvd2VyID0gbW9yZSBkZWxheS9zbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDA7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIApjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3QgaXNIdW1hbkNvbnRyb2xsZWQgPSBnYW1lICYmIHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwoKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCi8vIFkgQm91bmRzIChFeHBhbmRlZCBmb3IgZGVlcGVyIGdvYWwpCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDE4LjA7IAogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAoc2lkZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gZ29hbERpc3QgLSAwLjUpIHsgcG9zLnogPSBnb2FsRGlzdCAtIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC1nb2FsRGlzdCArIDAuNSkgeyBwb3MueiA9IC1nb2FsRGlzdCArIDAuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUgYW5kIHJlZHVjZSBsb2Z0CiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwogICAgICAgICAgICBjb25zdCB0eXBlID0gZm9yY2VkVHlwZSB8fCAnUEEnOwogICAgICAgICAgICBjb25zdCBib29zdCA9IDEuMjsKICAgICAgICAgICAgY29uc3QgZmluYWxQb3dlciA9IHBvd2VyTXVsdGlwbGllciAqIGJvb3N0OwoKICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0gKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDogJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiAxLjIgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ0xFQVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgRGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJFRFVDRUQgTE9GVDogR29hbGllIHRocm93cyBmbGF0dGVyICgwLjI1IGluc3RlYWQgb2YgMC44KQogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBTdGF0cwogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gZmluYWxQb3dlcjsKCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJlY29pbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci54ICogMi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0wLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiAyLjAKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUKICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7Cgp0aGlzLmxvc2VCYWxsKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDMwMCk7IC8vIFdpbmR1cCB0aW1lCgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgODAwKTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKaWYgKCF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9ICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFVQREFURSAtLS0KICAgICAgICAgICAgLy8gU21vb3RobHkgaW50ZXJwb2xhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCBiYWxsIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIFRoaXMgY3JlYXRlcyBhIG5hdHVyYWwgcmVhY3Rpb24gZGVsYXkgYW5kIHByZXZlbnRzIGppdHRlcnkgbWlycm9yaW5nCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkQmFsbFBvcy5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFRocmVhdCBTb3VyY2UKICAgICAgICAgICAgbGV0IHRocmVhdFBvcyA9IF9iYWxsUG9zOwogICAgICAgICAgICBsZXQgaXNUaHJlYXQgPSBmYWxzZTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIENhc2UgQTogQmFsbCBpcyBIZWxkIChQcmUtdGhyb3cpCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlID09PSAnaGVsZCcgJiYgYmFsbC5ob2xkZXIgJiYgYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFjayBob2xkZXIsIGJ1dCB1c2UgcGVyY2VpdmVkIHBvc2l0aW9uIGlmIHdlIHdhbnRlZCB0byBzaW11bGF0ZSByZWFkaW5nIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIEZvciBub3csIHRyYWNraW5nIHRoZSBiYWxsICh3aGljaCBpcyBvbiB0aGUgcGxheWVyKSB2aWEgcGVyY2VpdmVkUG9zIGlzIHN1ZmZpY2llbnQKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IHRoaXMucGVyY2VpdmVkQmFsbFBvczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNUaHJlYXQpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1NJVElPTklORzogQU5HTEUgQ1VUVElORyAtLS0KICAgICAgICAgICAgICAgIF9iYWxsUG9zLmNvcHkodGhyZWF0UG9zKTsgLy8gVXBkYXRlIHJlZmVyZW5jZSBmb3IgbG9va0F0CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlcgovLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIgKEFkanVzdGVkIGZvciBZIG9mZnNldCkKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgbmV3IFkgb2Zmc2V0IC04LjApCiAgICAgICAgICAgICAgICBfZ29hbENlbnRlci5zZXQoMCwgLTguMCwgbXlHb2FsWik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZlY3RvciBmcm9tIEdvYWwgdG8gQmFsbAogICAgICAgICAgICAgICAgX3RlbXBWZWNHLnN1YlZlY3RvcnMoX2JhbGxQb3MsIF9nb2FsQ2VudGVyKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSBfdGVtcFZlY0cubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBfdGVtcFZlY0cubm9ybWFsaXplKCk7IC8vIE5vdyBob2xkcyBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gRGV0ZXJtaW5lIEV4dGVuc2lvbiAoSG93IGZhciBvdXQgdG8gc3RlcCkKICAgICAgICAgICAgICAgIC8vIEJhc2U6IDEuNW0gb2ZmIGxpbmUuCiAgICAgICAgICAgICAgICAvLyBNYXg6IDYuMG0gb2ZmIGxpbmUgKEN1dHRpbmcgYW5nbGUpLgogICAgICAgICAgICAgICAgLy8gU2NhbGUgYmFzZWQgb24gYmFsbCBwcm94aW1pdHk6IENsb3NlciBiYWxsID0gTW9yZSBleHRlbnNpb24gKHRvIGEgcG9pbnQpCmxldCBleHRlbnNpb24gPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDMwLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IDEuMCAtIChNYXRoLm1heCgwLCBkaXN0VG9CYWxsIC0gNS4wKSAvIDI1LjApOyAKICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24gPSAxLjUgKyAoNC41ICogcmF0aW8pOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBTYWZldHk6IERvbid0IGdvIHBhc3QgdGhlIGJhbGwgKGtlZXAgMW0gYnVmZmVyKQogICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gTWF0aC5taW4oZXh0ZW5zaW9uLCBkaXN0VG9CYWxsIC0gMS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFRhcmdldCBQb3NpdGlvbiAoQmFzZSBJbnRlcmNlcHRpb24pCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KF9nb2FsQ2VudGVyKS5hZGQoX3RlbXBWZWNHLm11bHRpcGx5U2NhbGFyKGV4dGVuc2lvbikpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA1LiBWZXJ0aWNhbCBPdmVycmlkZSAoSnVtcCB0byBtZWV0IGJhbGwpCiAgICAgICAgICAgICAgICAvLyBFeHBsaWNpdGx5IHNldCBZIHRvIG1hdGNoIGJhbGwgaGVpZ2h0IGlmIGl0J3MgaGlnaAogICAgICAgICAgICAgICAgaWYgKF9iYWxsUG9zLnkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gX2JhbGxQb3MueTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IDAuNTsgLy8gRGVmYXVsdCBzdGFuY2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA2LiBDbGFtcCB0byBHb2FsIEJveCBEaW1lbnNpb25zIChMYXRlcmFsL1ZlcnRpY2FsIExpbWl0cykKICAgICAgICAgICAgICAgIC8vIEdvYWwgV2lkdGggMjIgKCsvLSAxMSksIEhlaWdodCAxOCAoKy8tIDkpLgogICAgICAgICAgICAgICAgLy8gQWxsb3cgc2xpZ2h0bHkgb3V0c2lkZSBwb3N0cyB0byBjb3ZlciBhbmdsZXMuCiAgICAgICAgICAgICAgICBjb25zdCBjbGFtcFggPSB0aGlzLmdvYWxXaWR0aCAqIDAuNjsgLy8gKy8tIDEzLjIKY29uc3QgY2xhbXBZID0gMTguMDsgLy8gSW5jcmVhc2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","./MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","/MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwoKICAgICAgICAgICAgLy8gUGh5c2ljcyBTZXR1cAogICAgICAgICAgICBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZGFtYWdlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnc2F2ZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ2Jsb2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7Ci8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gNi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNwcmVhZCwKICAgICAgICAgICAgICAgICAgICAxNS4wICsgTWF0aC5yYW5kb20oKSAqIDUuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1pbXBhY3QnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoKE1hdGgucmFuZG9tKCktMC41KSoyLCAxLjAsIChNYXRoLnJhbmRvbSgpLTAuNSkqMik7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAwLjQ7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC40OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3RlY2gnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnkgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xlZXAnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0wLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMC41LCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAzLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMy4wOwppbnN0YW5jZS5tYXhMaWZlID0gMy4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2JsaW5kJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaWxlbmNlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaGllbGQnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0xMC4wOyAvLyBGbG9hdCB1cCBmYXN0CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2hhc3RlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMjAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCA1LjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xvdycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMjAuMDsgLy8gSGVhdnkgZHJvcAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIC0yLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","./FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwoKICAgICAgICAgICAgLy8gUGh5c2ljcyBTZXR1cAogICAgICAgICAgICBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZGFtYWdlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnc2F2ZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ2Jsb2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7Ci8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gNi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNwcmVhZCwKICAgICAgICAgICAgICAgICAgICAxNS4wICsgTWF0aC5yYW5kb20oKSAqIDUuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1pbXBhY3QnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoKE1hdGgucmFuZG9tKCktMC41KSoyLCAxLjAsIChNYXRoLnJhbmRvbSgpLTAuNSkqMik7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAwLjQ7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC40OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3RlY2gnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnkgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xlZXAnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0wLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMC41LCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAzLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMy4wOwppbnN0YW5jZS5tYXhMaWZlID0gMy4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2JsaW5kJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaWxlbmNlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaGllbGQnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0xMC4wOyAvLyBGbG9hdCB1cCBmYXN0CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2hhc3RlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMjAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCA1LjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xvdycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMjAuMDsgLy8gSGVhdnkgZHJvcAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIC0yLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","/FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwoKICAgICAgICAgICAgLy8gUGh5c2ljcyBTZXR1cAogICAgICAgICAgICBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZGFtYWdlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnc2F2ZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ2Jsb2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7Ci8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gNi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNwcmVhZCwKICAgICAgICAgICAgICAgICAgICAxNS4wICsgTWF0aC5yYW5kb20oKSAqIDUuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1pbXBhY3QnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoKE1hdGgucmFuZG9tKCktMC41KSoyLCAxLjAsIChNYXRoLnJhbmRvbSgpLTAuNSkqMik7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAwLjQ7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC40OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3RlY2gnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnkgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xlZXAnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0wLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMC41LCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAzLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMy4wOwppbnN0YW5jZS5tYXhMaWZlID0gMy4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2JsaW5kJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaWxlbmNlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDEuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdzaGllbGQnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC0xMC4wOyAvLyBGbG9hdCB1cCBmYXN0CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2hhc3RlJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMjAuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCA1LjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2xvdycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMjAuMDsgLy8gSGVhdnkgZHJvcAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIC0yLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCiAgICAgICAgYWRkUmVjb2lsKHgsIHksIHopIHsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueCArPSB4OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC55ICs9IHk7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnogKz0gejsKdGhpcy5yZWNvaWxPZmZzZXQueiArPSB6OwogICAgICAgIH0KCiAgICAgICAgYWRkQWJlcnJhdGlvbihhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5hYmVycmF0aW9uSW1wdWxzZSA9IE1hdGgubWF4KHRoaXMuYWJlcnJhdGlvbkltcHVsc2UsIGFtb3VudCk7CiAgICAgICAgfQoKc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7Cgp0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChfaWRlYWxMb29rLCBsb29rRmFjdG9yKTsKCiAgICAgICAgICAgIC8vIDQuIFNjcmVlbiBTaGFrZSAoUG9zaXRpb24gJiBSb3RhdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkZWNheSA9IDguMCAqIHNhZmVEdDsgLy8gRmFzdCBkZWNheSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgLT0gZGVjYXk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA8IDApIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlTWFnID0gdGhpcy5zaGFrZUludGVuc2l0eSAqIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJvbGwgU2hha2UKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgLT0gNS4wICogc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsIDwgMCkgdGhpcy5zaGFrZVJvbGwgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc2hha2VSb2xsOwp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEN1cnZlIFRpbHQgKFJvbGwgSW1wdWxzZSkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMucm9sbEltcHVsc2UpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogKz0gdGhpcy5yb2xsSW1wdWxzZTsKdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVjb2lsIERlY2F5CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CnRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CgogICAgICAgICAgICAvLyBBYmVycmF0aW9uIERlY2F5ICYgQXBwbHkKICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFiZXJyYXRpb25JbXB1bHNlIDwgMC4xKSB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIDEuNSArIEltcHVsc2UKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjUgKyB0aGlzLmFiZXJyYXRpb25JbXB1bHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRvIGJhc2UgaWYgbm8gaW1wdWxzZSAoYW5kIG5vdCBkaXJ0eSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPiAxLjYpIHsKICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBvc3RQcm9jZXNzaW5nLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDUuIER5bmFtaWMgRk9WCi8vIDUuIER5bmFtaWMgRk9WCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbihzcGVlZCAvIDI1LjAsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHdhcnAgPSBzcGVlZFJhdGlvICogc3BlZWRSYXRpbzsKCiAgICAgICAgICAgIC8vIFpvb20gaW4gc2xpZ2h0bHkgd2hlbiBhaW1pbmcKICAgICAgICAgICAgY29uc3QgYWltWm9vbSA9IHRoaXMuaXNBaW1pbmcgPyAtMTAgOiAwOwogICAgICAgICAgICBjb25zdCB0YXJnZXRGb3YgPSB0aGlzLmNvbmZpZy5mb3ZCYXNlICsgKHRoaXMuY29uZmlnLmZvdk1heCAtIHRoaXMuY29uZmlnLmZvdkJhc2UpICogd2FycCArIHRoaXMuZm92SW1wdWxzZSArIGFpbVpvb207CgogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDYuMCAqIHNhZmVEdCkpOwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZm92ICs9ICh0YXJnZXRGb3YgLSB0aGlzLmNhbWVyYS5mb3YpICogNC4wICogc2FmZUR0OwogICAgICAgICAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgovLyA2LiBBcHBseSB0byBDYW1lcmEKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcykuYWRkKHRoaXMuc2hha2VPZmZzZXQpLmFkZCh0aGlzLnJlY29pbE9mZnNldCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CiAgICAgICAgfQoKX2NhbGN1bGF0ZUlkZWFsU3RhdGUoZHQpIHsKICAgICAgICAgICAgY29uc3QgdFBvcyA9IF90YXJnZXRXb3JsZFBvczsKCiAgICAgICAgICAgIC8vIC0tLSBBSU0gTU9ERSBPVkVSUklERSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlbGF4ZWQgQWltIE1vZGU6IFpvb20gaW4gYnV0IG1haW50YWluIG9yaWVudGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBhaW1EaXN0ID0gMTQuMDsgCiAgICAgICAgICAgICAgICBjb25zdCBhaW1IZWlnaHQgPSA2LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSBNYW51YWwgT3JiaXQgTG9naWMgKENvbnNpc3RlbnQgd2l0aCBTdGFuZGFyZCBNb2RlKQogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSBhaW1EaXN0OwogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gYWltSGVpZ2h0ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJhc2UgWiBvZmZzZXQgKENhbWVyYSBkZWZhdWx0cyB0byArWikKICAgICAgICAgICAgICAgIGNvbnN0IGNhbVogPSBlZmZlY3RpdmVEaXN0YW5jZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWCA9IGNhbVogKiBNYXRoLnNpbih0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsUG9zLnNldCh0UG9zLnggKyBmaW5hbFgsIHRQb3MueSArIGVmZmVjdGl2ZUhlaWdodCwgdFBvcy56ICsgZmluYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay55ICs9IDEuMDsgLy8gTG9vayBhdCBwbGF5ZXIgY2VudGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpc2FibGUgbG9vay1haGVhZCB0byBrZWVwIGZyYW1pbmcgc3RhYmxlIHdoaWxlIGFpbWluZwogICAgICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZC5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBNT0RFIC0tLQoKICAgICAgICAgICAgLy8gMC4gVGhyZWF0IEFzc2Vzc21lbnQgKER5bmFtaWMgUHVsbC1iYWNrKQogICAgICAgICAgICBsZXQgdGhyZWF0UHVsbGJhY2sgPSAwOwogICAgICAgICAgICBpZiAodGhpcy5jb25maWcudGhyZWF0QXdhcmVuZXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXQgPSB0aGlzLl9jYWxjdWxhdGVUaHJlYXRMZXZlbCh0UG9zKTsKICAgICAgICAgICAgICAgIHRocmVhdFB1bGxiYWNrID0gdGhyZWF0ICogNi4wOyAvLyBQdWxsIGJhY2sgdXAgdG8gNiB1bml0cwogICAgICAgICAgICB9CgovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAogICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB0aGlzLmNhbWVyYS5hc3BlY3Q7CiAgICAgICAgICAgIC8vIDk6MTYgaXMgfjAuNTYuIFdlIHRyaWdnZXIgYWRqdXN0bWVudCBpZiBuYXJyb3dlciB0aGFuIHNxdWFyZS4KICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDAuODU7IAogICAgICAgICAgICBjb25zdCBwb3J0cmFpdE11bHQgPSBpc1BvcnRyYWl0ID8gMS43IDogMS4wOyAvLyBQdWxsIGJhY2sgNzAlIG1vcmUgaW4gcG9ydHJhaXQgdG8gc2VlIHRoZSBmaWVsZAogICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgSWRlYWwgUG9zaXRpb24gd2l0aCBwdWxsLWJhY2sKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSAodGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjaykgKiBwb3J0cmFpdE11bHQ7CiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZUhlaWdodCA9ICh0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aHJlYXRQdWxsYmFjayAqIDAuNSArIHRoaXMubWFudWFsT3JiaXRQaXRjaCAqIDEwKSAqIHBvcnRyYWl0TXVsdDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZS50ZWFtcykgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","./CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCiAgICAgICAgYWRkUmVjb2lsKHgsIHksIHopIHsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueCArPSB4OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC55ICs9IHk7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnogKz0gejsKdGhpcy5yZWNvaWxPZmZzZXQueiArPSB6OwogICAgICAgIH0KCiAgICAgICAgYWRkQWJlcnJhdGlvbihhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5hYmVycmF0aW9uSW1wdWxzZSA9IE1hdGgubWF4KHRoaXMuYWJlcnJhdGlvbkltcHVsc2UsIGFtb3VudCk7CiAgICAgICAgfQoKc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7Cgp0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChfaWRlYWxMb29rLCBsb29rRmFjdG9yKTsKCiAgICAgICAgICAgIC8vIDQuIFNjcmVlbiBTaGFrZSAoUG9zaXRpb24gJiBSb3RhdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkZWNheSA9IDguMCAqIHNhZmVEdDsgLy8gRmFzdCBkZWNheSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgLT0gZGVjYXk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA8IDApIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlTWFnID0gdGhpcy5zaGFrZUludGVuc2l0eSAqIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJvbGwgU2hha2UKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgLT0gNS4wICogc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsIDwgMCkgdGhpcy5zaGFrZVJvbGwgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc2hha2VSb2xsOwp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEN1cnZlIFRpbHQgKFJvbGwgSW1wdWxzZSkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMucm9sbEltcHVsc2UpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogKz0gdGhpcy5yb2xsSW1wdWxzZTsKdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVjb2lsIERlY2F5CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CnRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CgogICAgICAgICAgICAvLyBBYmVycmF0aW9uIERlY2F5ICYgQXBwbHkKICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFiZXJyYXRpb25JbXB1bHNlIDwgMC4xKSB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIDEuNSArIEltcHVsc2UKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjUgKyB0aGlzLmFiZXJyYXRpb25JbXB1bHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRvIGJhc2UgaWYgbm8gaW1wdWxzZSAoYW5kIG5vdCBkaXJ0eSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPiAxLjYpIHsKICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBvc3RQcm9jZXNzaW5nLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDUuIER5bmFtaWMgRk9WCi8vIDUuIER5bmFtaWMgRk9WCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbihzcGVlZCAvIDI1LjAsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHdhcnAgPSBzcGVlZFJhdGlvICogc3BlZWRSYXRpbzsKCiAgICAgICAgICAgIC8vIFpvb20gaW4gc2xpZ2h0bHkgd2hlbiBhaW1pbmcKICAgICAgICAgICAgY29uc3QgYWltWm9vbSA9IHRoaXMuaXNBaW1pbmcgPyAtMTAgOiAwOwogICAgICAgICAgICBjb25zdCB0YXJnZXRGb3YgPSB0aGlzLmNvbmZpZy5mb3ZCYXNlICsgKHRoaXMuY29uZmlnLmZvdk1heCAtIHRoaXMuY29uZmlnLmZvdkJhc2UpICogd2FycCArIHRoaXMuZm92SW1wdWxzZSArIGFpbVpvb207CgogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDYuMCAqIHNhZmVEdCkpOwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZm92ICs9ICh0YXJnZXRGb3YgLSB0aGlzLmNhbWVyYS5mb3YpICogNC4wICogc2FmZUR0OwogICAgICAgICAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgovLyA2LiBBcHBseSB0byBDYW1lcmEKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcykuYWRkKHRoaXMuc2hha2VPZmZzZXQpLmFkZCh0aGlzLnJlY29pbE9mZnNldCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CiAgICAgICAgfQoKX2NhbGN1bGF0ZUlkZWFsU3RhdGUoZHQpIHsKICAgICAgICAgICAgY29uc3QgdFBvcyA9IF90YXJnZXRXb3JsZFBvczsKCiAgICAgICAgICAgIC8vIC0tLSBBSU0gTU9ERSBPVkVSUklERSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlbGF4ZWQgQWltIE1vZGU6IFpvb20gaW4gYnV0IG1haW50YWluIG9yaWVudGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBhaW1EaXN0ID0gMTQuMDsgCiAgICAgICAgICAgICAgICBjb25zdCBhaW1IZWlnaHQgPSA2LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSBNYW51YWwgT3JiaXQgTG9naWMgKENvbnNpc3RlbnQgd2l0aCBTdGFuZGFyZCBNb2RlKQogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSBhaW1EaXN0OwogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gYWltSGVpZ2h0ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJhc2UgWiBvZmZzZXQgKENhbWVyYSBkZWZhdWx0cyB0byArWikKICAgICAgICAgICAgICAgIGNvbnN0IGNhbVogPSBlZmZlY3RpdmVEaXN0YW5jZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWCA9IGNhbVogKiBNYXRoLnNpbih0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsUG9zLnNldCh0UG9zLnggKyBmaW5hbFgsIHRQb3MueSArIGVmZmVjdGl2ZUhlaWdodCwgdFBvcy56ICsgZmluYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay55ICs9IDEuMDsgLy8gTG9vayBhdCBwbGF5ZXIgY2VudGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpc2FibGUgbG9vay1haGVhZCB0byBrZWVwIGZyYW1pbmcgc3RhYmxlIHdoaWxlIGFpbWluZwogICAgICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZC5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBNT0RFIC0tLQoKICAgICAgICAgICAgLy8gMC4gVGhyZWF0IEFzc2Vzc21lbnQgKER5bmFtaWMgUHVsbC1iYWNrKQogICAgICAgICAgICBsZXQgdGhyZWF0UHVsbGJhY2sgPSAwOwogICAgICAgICAgICBpZiAodGhpcy5jb25maWcudGhyZWF0QXdhcmVuZXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXQgPSB0aGlzLl9jYWxjdWxhdGVUaHJlYXRMZXZlbCh0UG9zKTsKICAgICAgICAgICAgICAgIHRocmVhdFB1bGxiYWNrID0gdGhyZWF0ICogNi4wOyAvLyBQdWxsIGJhY2sgdXAgdG8gNiB1bml0cwogICAgICAgICAgICB9CgovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAogICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB0aGlzLmNhbWVyYS5hc3BlY3Q7CiAgICAgICAgICAgIC8vIDk6MTYgaXMgfjAuNTYuIFdlIHRyaWdnZXIgYWRqdXN0bWVudCBpZiBuYXJyb3dlciB0aGFuIHNxdWFyZS4KICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDAuODU7IAogICAgICAgICAgICBjb25zdCBwb3J0cmFpdE11bHQgPSBpc1BvcnRyYWl0ID8gMS43IDogMS4wOyAvLyBQdWxsIGJhY2sgNzAlIG1vcmUgaW4gcG9ydHJhaXQgdG8gc2VlIHRoZSBmaWVsZAogICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgSWRlYWwgUG9zaXRpb24gd2l0aCBwdWxsLWJhY2sKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSAodGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjaykgKiBwb3J0cmFpdE11bHQ7CiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZUhlaWdodCA9ICh0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aHJlYXRQdWxsYmFjayAqIDAuNSArIHRoaXMubWFudWFsT3JiaXRQaXRjaCAqIDEwKSAqIHBvcnRyYWl0TXVsdDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZS50ZWFtcykgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","/CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCiAgICAgICAgYWRkUmVjb2lsKHgsIHksIHopIHsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueCArPSB4OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC55ICs9IHk7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnogKz0gejsKdGhpcy5yZWNvaWxPZmZzZXQueiArPSB6OwogICAgICAgIH0KCiAgICAgICAgYWRkQWJlcnJhdGlvbihhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5hYmVycmF0aW9uSW1wdWxzZSA9IE1hdGgubWF4KHRoaXMuYWJlcnJhdGlvbkltcHVsc2UsIGFtb3VudCk7CiAgICAgICAgfQoKc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7Cgp0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChfaWRlYWxMb29rLCBsb29rRmFjdG9yKTsKCiAgICAgICAgICAgIC8vIDQuIFNjcmVlbiBTaGFrZSAoUG9zaXRpb24gJiBSb3RhdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkZWNheSA9IDguMCAqIHNhZmVEdDsgLy8gRmFzdCBkZWNheSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgLT0gZGVjYXk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA8IDApIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlTWFnID0gdGhpcy5zaGFrZUludGVuc2l0eSAqIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnLAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlTWFnCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJvbGwgU2hha2UKICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgLT0gNS4wICogc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VSb2xsIDwgMCkgdGhpcy5zaGFrZVJvbGwgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc2hha2VSb2xsOwp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEN1cnZlIFRpbHQgKFJvbGwgSW1wdWxzZSkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMucm9sbEltcHVsc2UpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogKz0gdGhpcy5yb2xsSW1wdWxzZTsKdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVjb2lsIERlY2F5CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CnRoaXMucmVjb2lsT2Zmc2V0Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICg4LjAgKiBzYWZlRHQpKSk7CgogICAgICAgICAgICAvLyBBYmVycmF0aW9uIERlY2F5ICYgQXBwbHkKICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFiZXJyYXRpb25JbXB1bHNlIDwgMC4xKSB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIDEuNSArIEltcHVsc2UKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjUgKyB0aGlzLmFiZXJyYXRpb25JbXB1bHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRvIGJhc2UgaWYgbm8gaW1wdWxzZSAoYW5kIG5vdCBkaXJ0eSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPiAxLjYpIHsKICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBvc3RQcm9jZXNzaW5nLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDUuIER5bmFtaWMgRk9WCi8vIDUuIER5bmFtaWMgRk9WCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbihzcGVlZCAvIDI1LjAsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHdhcnAgPSBzcGVlZFJhdGlvICogc3BlZWRSYXRpbzsKCiAgICAgICAgICAgIC8vIFpvb20gaW4gc2xpZ2h0bHkgd2hlbiBhaW1pbmcKICAgICAgICAgICAgY29uc3QgYWltWm9vbSA9IHRoaXMuaXNBaW1pbmcgPyAtMTAgOiAwOwogICAgICAgICAgICBjb25zdCB0YXJnZXRGb3YgPSB0aGlzLmNvbmZpZy5mb3ZCYXNlICsgKHRoaXMuY29uZmlnLmZvdk1heCAtIHRoaXMuY29uZmlnLmZvdkJhc2UpICogd2FycCArIHRoaXMuZm92SW1wdWxzZSArIGFpbVpvb207CgogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDYuMCAqIHNhZmVEdCkpOwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZm92ICs9ICh0YXJnZXRGb3YgLSB0aGlzLmNhbWVyYS5mb3YpICogNC4wICogc2FmZUR0OwogICAgICAgICAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgovLyA2LiBBcHBseSB0byBDYW1lcmEKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcykuYWRkKHRoaXMuc2hha2VPZmZzZXQpLmFkZCh0aGlzLnJlY29pbE9mZnNldCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CiAgICAgICAgfQoKX2NhbGN1bGF0ZUlkZWFsU3RhdGUoZHQpIHsKICAgICAgICAgICAgY29uc3QgdFBvcyA9IF90YXJnZXRXb3JsZFBvczsKCiAgICAgICAgICAgIC8vIC0tLSBBSU0gTU9ERSBPVkVSUklERSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlbGF4ZWQgQWltIE1vZGU6IFpvb20gaW4gYnV0IG1haW50YWluIG9yaWVudGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBhaW1EaXN0ID0gMTQuMDsgCiAgICAgICAgICAgICAgICBjb25zdCBhaW1IZWlnaHQgPSA2LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSBNYW51YWwgT3JiaXQgTG9naWMgKENvbnNpc3RlbnQgd2l0aCBTdGFuZGFyZCBNb2RlKQogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSBhaW1EaXN0OwogICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gYWltSGVpZ2h0ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJhc2UgWiBvZmZzZXQgKENhbWVyYSBkZWZhdWx0cyB0byArWikKICAgICAgICAgICAgICAgIGNvbnN0IGNhbVogPSBlZmZlY3RpdmVEaXN0YW5jZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWCA9IGNhbVogKiBNYXRoLnNpbih0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsUG9zLnNldCh0UG9zLnggKyBmaW5hbFgsIHRQb3MueSArIGVmZmVjdGl2ZUhlaWdodCwgdFBvcy56ICsgZmluYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay55ICs9IDEuMDsgLy8gTG9vayBhdCBwbGF5ZXIgY2VudGVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpc2FibGUgbG9vay1haGVhZCB0byBrZWVwIGZyYW1pbmcgc3RhYmxlIHdoaWxlIGFpbWluZwogICAgICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZC5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBNT0RFIC0tLQoKICAgICAgICAgICAgLy8gMC4gVGhyZWF0IEFzc2Vzc21lbnQgKER5bmFtaWMgUHVsbC1iYWNrKQogICAgICAgICAgICBsZXQgdGhyZWF0UHVsbGJhY2sgPSAwOwogICAgICAgICAgICBpZiAodGhpcy5jb25maWcudGhyZWF0QXdhcmVuZXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYXQgPSB0aGlzLl9jYWxjdWxhdGVUaHJlYXRMZXZlbCh0UG9zKTsKICAgICAgICAgICAgICAgIHRocmVhdFB1bGxiYWNrID0gdGhyZWF0ICogNi4wOyAvLyBQdWxsIGJhY2sgdXAgdG8gNiB1bml0cwogICAgICAgICAgICB9CgovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAovLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0ICYgUG9ydHJhaXQgQWRqdXN0bWVudAogICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB0aGlzLmNhbWVyYS5hc3BlY3Q7CiAgICAgICAgICAgIC8vIDk6MTYgaXMgfjAuNTYuIFdlIHRyaWdnZXIgYWRqdXN0bWVudCBpZiBuYXJyb3dlciB0aGFuIHNxdWFyZS4KICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDAuODU7IAogICAgICAgICAgICBjb25zdCBwb3J0cmFpdE11bHQgPSBpc1BvcnRyYWl0ID8gMS43IDogMS4wOyAvLyBQdWxsIGJhY2sgNzAlIG1vcmUgaW4gcG9ydHJhaXQgdG8gc2VlIHRoZSBmaWVsZAogICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgSWRlYWwgUG9zaXRpb24gd2l0aCBwdWxsLWJhY2sKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlRGlzdGFuY2UgPSAodGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjaykgKiBwb3J0cmFpdE11bHQ7CiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZUhlaWdodCA9ICh0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aHJlYXRQdWxsYmFjayAqIDAuNSArIHRoaXMubWFudWFsT3JiaXRQaXRjaCAqIDEwKSAqIHBvcnRyYWl0TXVsdDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CmNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZS50ZWFtcykgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAtLS0gUEFSVElDTEUgQkFUQ0ggU1lTVEVNIChUSFJFRS5Qb2ludHMpIC0tLQogICAgY2xhc3MgUGFydGljbGVCYXRjaCB7CgogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgZ3JpZCA9IG5ldyBUSFJFRS5WZWN0b3IyKDEsIDEpKSB7CiAgICAgICAgICAgIHRoaXMubWF4UGFydGljbGVzID0gbWF4UGFydGljbGVzOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENQVSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBhcnRpY2xlcyA9IFtdOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxtYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwb3M6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDAsCiAgICAgICAgICAgICAgICAgICAgbWF4TGlmZTogMSwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiAxLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uOiAwLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDAsIC8vIE5FVzogSW5kaXZpZHVhbCByb3RhdGlvbiBzcGVlZAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDEsMSwxKSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiAwIC8vIE5FVzogVGV4dHVyZSBmcmFtZSBpbmRleAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuZnJhbWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOyAvLyBORVcKCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5wb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnc2l6ZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5zaXplcywgMSkpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdyb3RhdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5yb3RhdGlvbnMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnb3BhY2l0eScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5vcGFjaXRpZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnY29sb3InLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuY29sb3JzLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2ZyYW1lJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmZyYW1lcywgMSkpOyAvLyBORVcKCiAgICAgICAgICAgIC8vIFNoYWRlciBNYXRlcmlhbAogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICBtYXA6IHsgdmFsdWU6IHRleHR1cmUgfSwKICAgICAgICAgICAgICAgICAgICB1R3JpZDogeyB2YWx1ZTogZ3JpZCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBmcmFtZTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZSb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2RnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2Um90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdk9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB2Q29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgICAgICAgICAgICAgdkZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpemUgYXR0ZW51YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZSAqICgzMDAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIG1hcDsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzIgdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdGxhcyBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeCA9IG1vZCh2RnJhbWUsIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeSA9IGZsb29yKHZGcmFtZSAvIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIHRvIGdyaWQgY2VsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdGFuZGFyZCBVViAoMCwwIGJvdHRvbS1sZWZ0KS4gV2UgYXNzdW1lIHJvdyAwIGlzIHRvcC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmxpcCByb3cgaW5kZXggZm9yIEdMIGNvb3JkcyBpZiBuZWVkZWQsIGJ1dCBsZXQncyBhc3N1bWUgc3RhbmRhcmQgZ3JpZCBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUm93IDAgPSBUb3AgKEhpZ2ggViksIFJvdyAxID0gQm90dG9tIChMb3cgVikuCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBnbFJvdyA9ICh1R3JpZC55IC0gMS4wKSAtIGZ5OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZWxsVVYgPSByb3RhdGVkIC8gdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgb2Zmc2V0ID0gdmVjMihmeCAvIHVHcmlkLngsIGdsUm93IC8gdUdyaWQueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleCA9IHRleHR1cmUyRChtYXAsIGNlbGxVViArIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHRleC5yZ2IgKiB2Q29sb3IsIHRleC5hICogdk9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IGJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLlBvaW50cyhnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9naWMgaG9vawogICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHBvcywgb3B0aW9ucykgewogICAgICAgICAgICAvLyBGaW5kIGZpcnN0IGluYWN0aXZlCiAgICAgICAgICAgIGxldCBwID0gbnVsbDsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgaWYoIXRoaXMucGFydGljbGVzW2ldLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47IC8vIFBvb2wgZnVsbAoKICAgICAgICAgICAgcC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICBwLnBvcy5jb3B5KHBvcyk7CiAgICAgICAgICAgIHAubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAxLjA7CiAgICAgICAgICAgIHAubWF4TGlmZSA9IHAubGlmZTsKICAgICAgICAgICAgcC5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAxLjA7CiAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGU7CnAucm90YXRpb24gPSBvcHRpb25zLnJvdGF0aW9uIHx8IDA7CiAgICAgICAgICAgIHAucm90YXRpb25TcGVlZCA9IG9wdGlvbnMucm90YXRpb25TcGVlZCB8fCAwOyAvLyBORVcKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgcC5mcmFtZSA9IG9wdGlvbnMuZnJhbWUgfHwgMDsgLy8gTkVXCiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgbGV0IGFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHAubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CnAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSBwLnJvdGF0aW9uU3BlZWQgKiBkdDsgLy8gQXBwbHkgcm90YXRpb24gc3BlZWQKCiAgICAgICAgICAgICAgICAvLyBMb2dpYwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudXBkYXRlTG9naWMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljKHAsIHQsIGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQnVmZmVycwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozXSA9IHAucG9zLng7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMV0gPSBwLnBvcy55OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzJdID0gcC5wb3MuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IHAuc2NhbGU7CiAgICAgICAgICAgICAgICB0aGlzLnJvdGF0aW9uc1tpXSA9IHAucm90YXRpb247CnRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgdGhpcy5mcmFtZXNbaV0gPSBwLmZyYW1lOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqM10gPSBwLmNvbG9yLnI7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMV0gPSBwLmNvbG9yLmc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMl0gPSBwLmNvbG9yLmI7CgogICAgICAgICAgICAgICAgYWN0aXZlQ291bnQrKzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFjdGl2ZUNvdW50ID4gMCB8fCB0aGlzLmFjdGl2ZUNvdW50ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuc2l6ZS5uZWVkc1VwZGF0ZSA9IHRydWU7CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5vcGFjaXR5Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gYWN0aXZlQ291bnQ7CiAgICAgICAgfQogICAgfQoKICAgIGNsYXNzIFBhcnRpY2xlTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmJhdGNoZXMgPSB7fTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQmF0Y2hlcwovLyBJbml0aWFsaXplIEJhdGNoZXMgKE9wdGltaXplZCBDb3VudHMpCnRoaXMuX2NyZWF0ZUJhdGNoKCd2ZW5vbScsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjA1OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdsZWFybmVkJywgX3Zlbm9tVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Nob2Nrd2F2ZScsIF9zaG9ja3dhdmVUZXgsIDUsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogTWF0aC5wb3codCwgMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIE1hdGgucG93KHQsIDIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdmbGFzaCcsIF9mbGFzaFRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ3NoYXJkJywgX2RlYnJpc1RleCwgNTAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgIH0sIG5ldyBUSFJFRS5WZWN0b3IyKDIsIDIpKTsKICAgICAgICAgICAgLy8gLS0tIEhFUkNVTEVBTiBUQUNLTEUgRlggLS0tCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdnYXRoZXInLCBfZmxhc2hUZXgsIDUwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIHN1Y2tpbmcgaW4KICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKTsgLy8gRmFkZSBpbi9vdXQKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC4yICsgdCAqIDAuOCk7IC8vIFNocmluayBhcyB0aGV5IGRpZSAodCBnb2VzIDEtPjA/IE5vLCB0IGlzIDEuMCAtIGxpZmUvbWF4TGlmZS4gV2FpdC4KICAgICAgICAgICAgICAgIC8vIEluIHVwZGF0ZSgpLCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkuIFNvIHQgZ29lcyAwIC0+IDEuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSBsZXQncyBjaGVjayB1cGRhdGUoKTogY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgLy8gWWVzLCB0IGdvZXMgMCB0byAxLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBnYXRoZXIgcGFydGljbGVzIHRvIHN0YXJ0IGZhciBhbmQgbW92ZSBpbi4gUGh5c2ljcyBoYW5kbGVzIHBvcy4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdGhlbSB0byBzaHJpbmsgYXMgdGhleSByZWFjaCBjZW50ZXI/CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQgKiAwLjUpOyAKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICB9KTsKCnRoaXMuX2NyZWF0ZUJhdGNoKCdpbXBhY3Rfc2hhcmQnLCBfZGVicmlzVGV4LCAxMDAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsgLy8gU2hyaW5rIG92ZXIgdGltZQogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOyAvLyAyeDIgR3JpZAogICAgICAgIH0KCl9jcmVhdGVCYXRjaChuYW1lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgbG9naWMsIGdyaWQpIHsKICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSBuZXcgUGFydGljbGVCYXRjaCh0aGlzLnNjZW5lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgZ3JpZCk7CiAgICAgICAgICAgIGlmIChsb2dpYykgYmF0Y2gudXBkYXRlTG9naWMgPSBsb2dpYzsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzW25hbWVdID0gYmF0Y2g7CiAgICAgICAgfQoKICAgICAgICBzcGF3bih0eXBlLCBwb3MsIG9wdGlvbnMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuYmF0Y2hlc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGJhdGNoKSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHBoeXNpY3MgcGFyYW1zIGlmIG5vdCBwcm92aWRlZAogICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgLi4ub3B0aW9ucyB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIGJhc2UgdmVsb2NpdHkgZnJvbSBvcHRpb25zIG9yIHplcm8KICAgICAgICAgICAgICAgIGxldCBiYXNlVmVsID0gKG9wdHMudmVsb2NpdHkpID8gb3B0cy52ZWxvY2l0eS5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjUsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjUpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSBvcHRzLmxpZmUgfHwgMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAzLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwp9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgKiBzcGVlZCAqIDAuNSkgKyAyLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5ncmF2aXR5ID0gMjAuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLmRyYWcgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMykgKiAoMC41ICsgTWF0aC5yYW5kb20oKSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7IC8vIFJhbmRvbSBzcGluCiAgICAgICAgICAgICAgICAgICAgb3B0cy5mcmFtZSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpOyAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIDAuNSArIE1hdGgucmFuZG9tKCkgKiAxLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlX21pY3JvJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkYXNoX3N0cmVhbScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2JsaW5kJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC41OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2lsZW5jZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NoaWVsZCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjg7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gTU9NRU5UVU0gSU5IRVJJVEFOQ0UgLS0tCiAgICAgICAgICAgICAgICBpZiAob3B0cy5lbWl0dGVyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtb21lbnR1bVNjYWxlID0gKG9wdHMubW9tZW50dW1TY2FsZSAhPT0gdW5kZWZpbmVkKSA/IG9wdHMubW9tZW50dW1TY2FsZSA6IDAuMjsKICAgICAgICAgICAgICAgICAgICBpZiAobW9tZW50dW1TY2FsZSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLmFkZFNjYWxlZFZlY3RvcihvcHRzLmVtaXR0ZXJWZWxvY2l0eSwgbW9tZW50dW1TY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBiYXNlVmVsOwoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5iYXRjaGVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhdGNoZXNba2V5XS51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBhcnRpY2xlTWFuYWdlciA9IFBhcnRpY2xlTWFuYWdlcjsKfSkoKTs=","./ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAtLS0gUEFSVElDTEUgQkFUQ0ggU1lTVEVNIChUSFJFRS5Qb2ludHMpIC0tLQogICAgY2xhc3MgUGFydGljbGVCYXRjaCB7CgogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgZ3JpZCA9IG5ldyBUSFJFRS5WZWN0b3IyKDEsIDEpKSB7CiAgICAgICAgICAgIHRoaXMubWF4UGFydGljbGVzID0gbWF4UGFydGljbGVzOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENQVSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBhcnRpY2xlcyA9IFtdOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxtYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwb3M6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDAsCiAgICAgICAgICAgICAgICAgICAgbWF4TGlmZTogMSwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiAxLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uOiAwLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDAsIC8vIE5FVzogSW5kaXZpZHVhbCByb3RhdGlvbiBzcGVlZAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDEsMSwxKSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiAwIC8vIE5FVzogVGV4dHVyZSBmcmFtZSBpbmRleAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuZnJhbWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOyAvLyBORVcKCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5wb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnc2l6ZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5zaXplcywgMSkpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdyb3RhdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5yb3RhdGlvbnMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnb3BhY2l0eScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5vcGFjaXRpZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnY29sb3InLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuY29sb3JzLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2ZyYW1lJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmZyYW1lcywgMSkpOyAvLyBORVcKCiAgICAgICAgICAgIC8vIFNoYWRlciBNYXRlcmlhbAogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICBtYXA6IHsgdmFsdWU6IHRleHR1cmUgfSwKICAgICAgICAgICAgICAgICAgICB1R3JpZDogeyB2YWx1ZTogZ3JpZCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBmcmFtZTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZSb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2RnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2Um90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdk9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB2Q29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgICAgICAgICAgICAgdkZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpemUgYXR0ZW51YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZSAqICgzMDAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIG1hcDsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzIgdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdGxhcyBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeCA9IG1vZCh2RnJhbWUsIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeSA9IGZsb29yKHZGcmFtZSAvIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIHRvIGdyaWQgY2VsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdGFuZGFyZCBVViAoMCwwIGJvdHRvbS1sZWZ0KS4gV2UgYXNzdW1lIHJvdyAwIGlzIHRvcC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmxpcCByb3cgaW5kZXggZm9yIEdMIGNvb3JkcyBpZiBuZWVkZWQsIGJ1dCBsZXQncyBhc3N1bWUgc3RhbmRhcmQgZ3JpZCBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUm93IDAgPSBUb3AgKEhpZ2ggViksIFJvdyAxID0gQm90dG9tIChMb3cgVikuCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBnbFJvdyA9ICh1R3JpZC55IC0gMS4wKSAtIGZ5OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZWxsVVYgPSByb3RhdGVkIC8gdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgb2Zmc2V0ID0gdmVjMihmeCAvIHVHcmlkLngsIGdsUm93IC8gdUdyaWQueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleCA9IHRleHR1cmUyRChtYXAsIGNlbGxVViArIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHRleC5yZ2IgKiB2Q29sb3IsIHRleC5hICogdk9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IGJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLlBvaW50cyhnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9naWMgaG9vawogICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHBvcywgb3B0aW9ucykgewogICAgICAgICAgICAvLyBGaW5kIGZpcnN0IGluYWN0aXZlCiAgICAgICAgICAgIGxldCBwID0gbnVsbDsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgaWYoIXRoaXMucGFydGljbGVzW2ldLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47IC8vIFBvb2wgZnVsbAoKICAgICAgICAgICAgcC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICBwLnBvcy5jb3B5KHBvcyk7CiAgICAgICAgICAgIHAubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAxLjA7CiAgICAgICAgICAgIHAubWF4TGlmZSA9IHAubGlmZTsKICAgICAgICAgICAgcC5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAxLjA7CiAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGU7CnAucm90YXRpb24gPSBvcHRpb25zLnJvdGF0aW9uIHx8IDA7CiAgICAgICAgICAgIHAucm90YXRpb25TcGVlZCA9IG9wdGlvbnMucm90YXRpb25TcGVlZCB8fCAwOyAvLyBORVcKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgcC5mcmFtZSA9IG9wdGlvbnMuZnJhbWUgfHwgMDsgLy8gTkVXCiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgbGV0IGFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHAubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CnAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSBwLnJvdGF0aW9uU3BlZWQgKiBkdDsgLy8gQXBwbHkgcm90YXRpb24gc3BlZWQKCiAgICAgICAgICAgICAgICAvLyBMb2dpYwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudXBkYXRlTG9naWMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljKHAsIHQsIGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQnVmZmVycwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozXSA9IHAucG9zLng7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMV0gPSBwLnBvcy55OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzJdID0gcC5wb3MuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IHAuc2NhbGU7CiAgICAgICAgICAgICAgICB0aGlzLnJvdGF0aW9uc1tpXSA9IHAucm90YXRpb247CnRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgdGhpcy5mcmFtZXNbaV0gPSBwLmZyYW1lOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqM10gPSBwLmNvbG9yLnI7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMV0gPSBwLmNvbG9yLmc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMl0gPSBwLmNvbG9yLmI7CgogICAgICAgICAgICAgICAgYWN0aXZlQ291bnQrKzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFjdGl2ZUNvdW50ID4gMCB8fCB0aGlzLmFjdGl2ZUNvdW50ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuc2l6ZS5uZWVkc1VwZGF0ZSA9IHRydWU7CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5vcGFjaXR5Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gYWN0aXZlQ291bnQ7CiAgICAgICAgfQogICAgfQoKICAgIGNsYXNzIFBhcnRpY2xlTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmJhdGNoZXMgPSB7fTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQmF0Y2hlcwovLyBJbml0aWFsaXplIEJhdGNoZXMgKE9wdGltaXplZCBDb3VudHMpCnRoaXMuX2NyZWF0ZUJhdGNoKCd2ZW5vbScsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjA1OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdsZWFybmVkJywgX3Zlbm9tVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Nob2Nrd2F2ZScsIF9zaG9ja3dhdmVUZXgsIDUsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogTWF0aC5wb3codCwgMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIE1hdGgucG93KHQsIDIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdmbGFzaCcsIF9mbGFzaFRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ3NoYXJkJywgX2RlYnJpc1RleCwgNTAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgIH0sIG5ldyBUSFJFRS5WZWN0b3IyKDIsIDIpKTsKICAgICAgICAgICAgLy8gLS0tIEhFUkNVTEVBTiBUQUNLTEUgRlggLS0tCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdnYXRoZXInLCBfZmxhc2hUZXgsIDUwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIHN1Y2tpbmcgaW4KICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKTsgLy8gRmFkZSBpbi9vdXQKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC4yICsgdCAqIDAuOCk7IC8vIFNocmluayBhcyB0aGV5IGRpZSAodCBnb2VzIDEtPjA/IE5vLCB0IGlzIDEuMCAtIGxpZmUvbWF4TGlmZS4gV2FpdC4KICAgICAgICAgICAgICAgIC8vIEluIHVwZGF0ZSgpLCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkuIFNvIHQgZ29lcyAwIC0+IDEuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSBsZXQncyBjaGVjayB1cGRhdGUoKTogY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgLy8gWWVzLCB0IGdvZXMgMCB0byAxLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBnYXRoZXIgcGFydGljbGVzIHRvIHN0YXJ0IGZhciBhbmQgbW92ZSBpbi4gUGh5c2ljcyBoYW5kbGVzIHBvcy4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdGhlbSB0byBzaHJpbmsgYXMgdGhleSByZWFjaCBjZW50ZXI/CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQgKiAwLjUpOyAKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICB9KTsKCnRoaXMuX2NyZWF0ZUJhdGNoKCdpbXBhY3Rfc2hhcmQnLCBfZGVicmlzVGV4LCAxMDAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsgLy8gU2hyaW5rIG92ZXIgdGltZQogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOyAvLyAyeDIgR3JpZAogICAgICAgIH0KCl9jcmVhdGVCYXRjaChuYW1lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgbG9naWMsIGdyaWQpIHsKICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSBuZXcgUGFydGljbGVCYXRjaCh0aGlzLnNjZW5lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgZ3JpZCk7CiAgICAgICAgICAgIGlmIChsb2dpYykgYmF0Y2gudXBkYXRlTG9naWMgPSBsb2dpYzsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzW25hbWVdID0gYmF0Y2g7CiAgICAgICAgfQoKICAgICAgICBzcGF3bih0eXBlLCBwb3MsIG9wdGlvbnMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuYmF0Y2hlc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGJhdGNoKSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHBoeXNpY3MgcGFyYW1zIGlmIG5vdCBwcm92aWRlZAogICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgLi4ub3B0aW9ucyB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIGJhc2UgdmVsb2NpdHkgZnJvbSBvcHRpb25zIG9yIHplcm8KICAgICAgICAgICAgICAgIGxldCBiYXNlVmVsID0gKG9wdHMudmVsb2NpdHkpID8gb3B0cy52ZWxvY2l0eS5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjUsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjUpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSBvcHRzLmxpZmUgfHwgMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAzLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwp9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgKiBzcGVlZCAqIDAuNSkgKyAyLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5ncmF2aXR5ID0gMjAuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLmRyYWcgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMykgKiAoMC41ICsgTWF0aC5yYW5kb20oKSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7IC8vIFJhbmRvbSBzcGluCiAgICAgICAgICAgICAgICAgICAgb3B0cy5mcmFtZSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpOyAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIDAuNSArIE1hdGgucmFuZG9tKCkgKiAxLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlX21pY3JvJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkYXNoX3N0cmVhbScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2JsaW5kJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC41OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2lsZW5jZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NoaWVsZCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjg7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gTU9NRU5UVU0gSU5IRVJJVEFOQ0UgLS0tCiAgICAgICAgICAgICAgICBpZiAob3B0cy5lbWl0dGVyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtb21lbnR1bVNjYWxlID0gKG9wdHMubW9tZW50dW1TY2FsZSAhPT0gdW5kZWZpbmVkKSA/IG9wdHMubW9tZW50dW1TY2FsZSA6IDAuMjsKICAgICAgICAgICAgICAgICAgICBpZiAobW9tZW50dW1TY2FsZSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLmFkZFNjYWxlZFZlY3RvcihvcHRzLmVtaXR0ZXJWZWxvY2l0eSwgbW9tZW50dW1TY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBiYXNlVmVsOwoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5iYXRjaGVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhdGNoZXNba2V5XS51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBhcnRpY2xlTWFuYWdlciA9IFBhcnRpY2xlTWFuYWdlcjsKfSkoKTs=","/ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAtLS0gUEFSVElDTEUgQkFUQ0ggU1lTVEVNIChUSFJFRS5Qb2ludHMpIC0tLQogICAgY2xhc3MgUGFydGljbGVCYXRjaCB7CgogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgZ3JpZCA9IG5ldyBUSFJFRS5WZWN0b3IyKDEsIDEpKSB7CiAgICAgICAgICAgIHRoaXMubWF4UGFydGljbGVzID0gbWF4UGFydGljbGVzOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENQVSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBhcnRpY2xlcyA9IFtdOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxtYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwb3M6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDAsCiAgICAgICAgICAgICAgICAgICAgbWF4TGlmZTogMSwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiAxLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uOiAwLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDAsIC8vIE5FVzogSW5kaXZpZHVhbCByb3RhdGlvbiBzcGVlZAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDEsMSwxKSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiAwIC8vIE5FVzogVGV4dHVyZSBmcmFtZSBpbmRleAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuZnJhbWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOyAvLyBORVcKCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5wb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnc2l6ZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5zaXplcywgMSkpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdyb3RhdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5yb3RhdGlvbnMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnb3BhY2l0eScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5vcGFjaXRpZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnY29sb3InLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuY29sb3JzLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2ZyYW1lJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmZyYW1lcywgMSkpOyAvLyBORVcKCiAgICAgICAgICAgIC8vIFNoYWRlciBNYXRlcmlhbAogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICBtYXA6IHsgdmFsdWU6IHRleHR1cmUgfSwKICAgICAgICAgICAgICAgICAgICB1R3JpZDogeyB2YWx1ZTogZ3JpZCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBmcmFtZTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZSb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2RnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2Um90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdk9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB2Q29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgICAgICAgICAgICAgdkZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpemUgYXR0ZW51YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZSAqICgzMDAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIG1hcDsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzIgdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdGxhcyBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeCA9IG1vZCh2RnJhbWUsIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBmeSA9IGZsb29yKHZGcmFtZSAvIHVHcmlkLngpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIHRvIGdyaWQgY2VsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdGFuZGFyZCBVViAoMCwwIGJvdHRvbS1sZWZ0KS4gV2UgYXNzdW1lIHJvdyAwIGlzIHRvcC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmxpcCByb3cgaW5kZXggZm9yIEdMIGNvb3JkcyBpZiBuZWVkZWQsIGJ1dCBsZXQncyBhc3N1bWUgc3RhbmRhcmQgZ3JpZCBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUm93IDAgPSBUb3AgKEhpZ2ggViksIFJvdyAxID0gQm90dG9tIChMb3cgVikuCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBnbFJvdyA9ICh1R3JpZC55IC0gMS4wKSAtIGZ5OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZWxsVVYgPSByb3RhdGVkIC8gdUdyaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgb2Zmc2V0ID0gdmVjMihmeCAvIHVHcmlkLngsIGdsUm93IC8gdUdyaWQueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleCA9IHRleHR1cmUyRChtYXAsIGNlbGxVViArIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHRleC5yZ2IgKiB2Q29sb3IsIHRleC5hICogdk9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IGJsZW5kaW5nCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLlBvaW50cyhnZW8sIG1hdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9naWMgaG9vawogICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHBvcywgb3B0aW9ucykgewogICAgICAgICAgICAvLyBGaW5kIGZpcnN0IGluYWN0aXZlCiAgICAgICAgICAgIGxldCBwID0gbnVsbDsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgaWYoIXRoaXMucGFydGljbGVzW2ldLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47IC8vIFBvb2wgZnVsbAoKICAgICAgICAgICAgcC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICBwLnBvcy5jb3B5KHBvcyk7CiAgICAgICAgICAgIHAubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAxLjA7CiAgICAgICAgICAgIHAubWF4TGlmZSA9IHAubGlmZTsKICAgICAgICAgICAgcC5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAxLjA7CiAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGU7CnAucm90YXRpb24gPSBvcHRpb25zLnJvdGF0aW9uIHx8IDA7CiAgICAgICAgICAgIHAucm90YXRpb25TcGVlZCA9IG9wdGlvbnMucm90YXRpb25TcGVlZCB8fCAwOyAvLyBORVcKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgcC5mcmFtZSA9IG9wdGlvbnMuZnJhbWUgfHwgMDsgLy8gTkVXCiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgbGV0IGFjdGl2ZUNvdW50ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHAubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CnAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSBwLnJvdGF0aW9uU3BlZWQgKiBkdDsgLy8gQXBwbHkgcm90YXRpb24gc3BlZWQKCiAgICAgICAgICAgICAgICAvLyBMb2dpYwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudXBkYXRlTG9naWMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxvZ2ljKHAsIHQsIGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQnVmZmVycwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozXSA9IHAucG9zLng7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMV0gPSBwLnBvcy55OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzJdID0gcC5wb3MuejsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IHAuc2NhbGU7CiAgICAgICAgICAgICAgICB0aGlzLnJvdGF0aW9uc1tpXSA9IHAucm90YXRpb247CnRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgdGhpcy5mcmFtZXNbaV0gPSBwLmZyYW1lOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqM10gPSBwLmNvbG9yLnI7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMV0gPSBwLmNvbG9yLmc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjMrMl0gPSBwLmNvbG9yLmI7CgogICAgICAgICAgICAgICAgYWN0aXZlQ291bnQrKzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFjdGl2ZUNvdW50ID4gMCB8fCB0aGlzLmFjdGl2ZUNvdW50ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuc2l6ZS5uZWVkc1VwZGF0ZSA9IHRydWU7CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5vcGFjaXR5Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZUNvdW50ID0gYWN0aXZlQ291bnQ7CiAgICAgICAgfQogICAgfQoKICAgIGNsYXNzIFBhcnRpY2xlTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmJhdGNoZXMgPSB7fTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQmF0Y2hlcwovLyBJbml0aWFsaXplIEJhdGNoZXMgKE9wdGltaXplZCBDb3VudHMpCnRoaXMuX2NyZWF0ZUJhdGNoKCd2ZW5vbScsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjA1OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdsZWFybmVkJywgX3Zlbm9tVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Nob2Nrd2F2ZScsIF9zaG9ja3dhdmVUZXgsIDUsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogTWF0aC5wb3codCwgMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIE1hdGgucG93KHQsIDIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdmbGFzaCcsIF9mbGFzaFRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ3NoYXJkJywgX2RlYnJpc1RleCwgNTAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgIH0sIG5ldyBUSFJFRS5WZWN0b3IyKDIsIDIpKTsKICAgICAgICAgICAgLy8gLS0tIEhFUkNVTEVBTiBUQUNLTEUgRlggLS0tCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdnYXRoZXInLCBfZmxhc2hUZXgsIDUwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIHN1Y2tpbmcgaW4KICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKTsgLy8gRmFkZSBpbi9vdXQKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC4yICsgdCAqIDAuOCk7IC8vIFNocmluayBhcyB0aGV5IGRpZSAodCBnb2VzIDEtPjA/IE5vLCB0IGlzIDEuMCAtIGxpZmUvbWF4TGlmZS4gV2FpdC4KICAgICAgICAgICAgICAgIC8vIEluIHVwZGF0ZSgpLCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkuIFNvIHQgZ29lcyAwIC0+IDEuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSBsZXQncyBjaGVjayB1cGRhdGUoKTogY29uc3QgdCA9IDEuMCAtIChwLmxpZmUgLyBwLm1heExpZmUpOwogICAgICAgICAgICAgICAgLy8gWWVzLCB0IGdvZXMgMCB0byAxLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBnYXRoZXIgcGFydGljbGVzIHRvIHN0YXJ0IGZhciBhbmQgbW92ZSBpbi4gUGh5c2ljcyBoYW5kbGVzIHBvcy4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdGhlbSB0byBzaHJpbmsgYXMgdGhleSByZWFjaCBjZW50ZXI/CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQgKiAwLjUpOyAKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICB9KTsKCnRoaXMuX2NyZWF0ZUJhdGNoKCdpbXBhY3Rfc2hhcmQnLCBfZGVicmlzVGV4LCAxMDAsIFRIUkVFLk5vcm1hbEJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsgLy8gU2hyaW5rIG92ZXIgdGltZQogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOyAvLyAyeDIgR3JpZAogICAgICAgIH0KCl9jcmVhdGVCYXRjaChuYW1lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgbG9naWMsIGdyaWQpIHsKICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSBuZXcgUGFydGljbGVCYXRjaCh0aGlzLnNjZW5lLCB0ZXgsIGNvdW50LCBibGVuZGluZywgZ3JpZCk7CiAgICAgICAgICAgIGlmIChsb2dpYykgYmF0Y2gudXBkYXRlTG9naWMgPSBsb2dpYzsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzW25hbWVdID0gYmF0Y2g7CiAgICAgICAgfQoKICAgICAgICBzcGF3bih0eXBlLCBwb3MsIG9wdGlvbnMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuYmF0Y2hlc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGJhdGNoKSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHBoeXNpY3MgcGFyYW1zIGlmIG5vdCBwcm92aWRlZAogICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgLi4ub3B0aW9ucyB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIGJhc2UgdmVsb2NpdHkgZnJvbSBvcHRpb25zIG9yIHplcm8KICAgICAgICAgICAgICAgIGxldCBiYXNlVmVsID0gKG9wdHMudmVsb2NpdHkpID8gb3B0cy52ZWxvY2l0eS5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjUsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjUpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSBvcHRzLmxpZmUgfHwgMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAzLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwp9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgKiBzcGVlZCAqIDAuNSkgKyAyLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5ncmF2aXR5ID0gMjAuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLmRyYWcgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMykgKiAoMC41ICsgTWF0aC5yYW5kb20oKSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7IC8vIFJhbmRvbSBzcGluCiAgICAgICAgICAgICAgICAgICAgb3B0cy5mcmFtZSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpOyAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIDAuNSArIE1hdGgucmFuZG9tKCkgKiAxLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IChvcHRzLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlX21pY3JvJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkYXNoX3N0cmVhbScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2JsaW5kJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC41OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2lsZW5jZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NoaWVsZCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjg7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2xvdycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gTU9NRU5UVU0gSU5IRVJJVEFOQ0UgLS0tCiAgICAgICAgICAgICAgICBpZiAob3B0cy5lbWl0dGVyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtb21lbnR1bVNjYWxlID0gKG9wdHMubW9tZW50dW1TY2FsZSAhPT0gdW5kZWZpbmVkKSA/IG9wdHMubW9tZW50dW1TY2FsZSA6IDAuMjsKICAgICAgICAgICAgICAgICAgICBpZiAobW9tZW50dW1TY2FsZSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLmFkZFNjYWxlZFZlY3RvcihvcHRzLmVtaXR0ZXJWZWxvY2l0eSwgbW9tZW50dW1TY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBiYXNlVmVsOwoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5iYXRjaGVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhdGNoZXNba2V5XS51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBhcnRpY2xlTWFuYWdlciA9IFBhcnRpY2xlTWFuYWdlcjsKfSkoKTs=","DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CgogICAgICAgIF9zZXR1cFJ1bnRpbWVNb25pdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1J1bnRpbWUgTW9uaXRvcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIERPTSBPdmVybGF5CiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5tb25pdG9yRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICAgICAgICAgICAgdG9wOiAnODBweCcsIAogICAgICAgICAgICAgICAgbGVmdDogJzEwcHgnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzhweCcsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAncmdiYSgwLCAwLCAwLCAwLjgpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzFweCBzb2xpZCAjMDBmZjAwJywKICAgICAgICAgICAgICAgIGNvbG9yOiAnIzAwZmYwMCcsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTFweCcsCiAgICAgICAgICAgICAgICBsaW5lSGVpZ2h0OiAnMS40JywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIG1pbldpZHRoOiAnMTUwcHgnLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnNHB4JywKICAgICAgICAgICAgICAgIHRleHRTaGFkb3c6ICcxcHggMXB4IDAgIzAwMCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5tb25pdG9yRWwpOwoKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgc2hvd092ZXJsYXk6IGZhbHNlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Nob3dPdmVybGF5JykubmFtZSgnU2hvdyBPdmVybGF5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgdXBkYXRlIGxvb3AKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5zaG93T3ZlcmxheSkgdGhpcy5fdXBkYXRlTW9uaXRvcigpOwogICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTW9uaXRvcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSBnbS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgbGV0IGh0bWwgPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkdBTUUgU1RBVEU8L2Rpdj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7Z20uc3RhdGV9PC9zcGFuPjxicj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZSBUaW1lcjogJHtnbS5zdGF0ZVRpbWVyLnRvRml4ZWQoMil9czxicj5gOwogICAgICAgICAgICBodG1sICs9IGBNYXRjaCBUaW1lOiAke01hdGguZmxvb3IoZ20udGltZS82MCl9OiR7TWF0aC5mbG9vcihnbS50aW1lJTYwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsJzAnKX0gKEgke2dtLmhhbGZ9KTxicj5gOwogICAgICAgICAgICAKICAgICAgICAgICAgaHRtbCArPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IG1hcmdpbi10b3A6OHB4OyBmb250LXdlaWdodDpib2xkOyBjb2xvcjojZmZmIj5CQUxMPC9kaXY+YDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0ZUNvbG9yID0gYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnID8gJyMwYWYnIDogKGJhbGwuc3RhdGUgPT09ICdoZWxkJyA/ICcjZmEwJyA6ICcjZjBmJyk7CiAgICAgICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiR7c3RhdGVDb2xvcn0iPiR7YmFsbC5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBob2xkZXJTdHIgPSAnTm9uZSc7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5yb2xlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSBiYWxsLmhvbGRlci50ZWFtID8gYmFsbC5ob2xkZXIudGVhbS5pZC50b1VwcGVyQ2FzZSgpIDogJz8nOwogICAgICAgICAgICAgICAgICAgIGhvbGRlclN0ciA9IGAke25hbWV9ICgke3RlYW19KWA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBodG1sICs9IGBIb2xkZXI6IDxzcGFuIHN0eWxlPSJjb2xvcjojZmZmIj4ke2hvbGRlclN0cn08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBodG1sICs9IGBQb3M6ICR7cC54LnRvRml4ZWQoMSl9LCAke3AueS50b0ZpeGVkKDEpfSwgJHtwLnoudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFNwZWVkOiAke2JhbGwudmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCArPSBgUG93ZXI6ICR7YmFsbC5wb3dlci50b0ZpeGVkKDEpfSAoJHtiYWxsLnBvd2VyVHlwZX0pPGJyPmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sICs9IGBPRkZMSU5FPGJyPmA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9Cn0pOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX1lfT0ZGU0VUJywgLTUwLjAsIDIwLjApLm5hbWUoJ0dvYWwgWSBQb3MnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnkgPSB2OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueSA9IHY7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9TQ0FMRScsIDEuMCwgMTAwLjApLm5hbWUoJ0dvYWwgU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnNjYWxlLnNldFNjYWxhcih2KTsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnNjYWxlLnNldFNjYWxhcih2KTsKICAgIH0pOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfQlVGRkVSJywgMC4wLCAyMC4wKS5uYW1lKCdTb2Z0IEJ1ZmZlcicpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfRk9SQ0UnLCAwLjAsIDIwMC4wKS5uYW1lKCdTb2Z0IEZvcmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEJvdW5jZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0ZSSUNUSU9OJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgRnJpY3Rpb24nKTsKICAgIGFyZW5hLmFkZChDLCAnRkxPT1JfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdDZWlsL0Zsb29yIEJvdW5jZScpOwoKICAgIGNvbnN0IHBvY2tldCA9IGFyZW5hLmFkZEZvbGRlcignR29hbCBQb2NrZXQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9YJywgMC4wLCA0MC4wKS5uYW1lKCdQb2NrZXQgSGFsZi1YJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9aJywgMC4wLCA1MC4wKS5uYW1lKCdQb2NrZXQgU3RhcnQgfFp8Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUG9ja2V0IFJhZGl1cycpOwoKICAgIGNvbnN0IGxhdW5jaCA9IHBoeXMuYWRkRm9sZGVyKCdMYXVuY2ggTWFwcGluZycpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ1NwZWVkIFNjYWxlJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfQ0FQJywgMTAuMCwgMjAwLjApLm5hbWUoJ1NwZWVkIENhcCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUaHJvdyBtYXBwaW5nIChQbGF5ZXIucmVsZWFzZUNoYXJnZSAtPiBCYWxsLnNob290KQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0aHJvd01hcCA9IHJvb3QuYWRkRm9sZGVyKCdUaHJvdyBNYXBwaW5nIChUaHJvd0NvbmZpZyknKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1NXSVBFX01JTl9QWCcsIDAsIDEyMCwgMSkubmFtZSgnU3dpcGUgTWluIFBYJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFhfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFggU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWV9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWSBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfQkFTRScsIDAuMSwgMy4wKS5uYW1lKCdQb3dlciBCYXNlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9SQU5HRScsIDAuMCwgMy4wKS5uYW1lKCdQb3dlciBSYW5nZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX0JPTlVTX1JBVElPJywgMC4wLCAxLjApLm5hbWUoJ01heCBCb251cyBSYXRpbycpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX01VTFRJUExJRVInLCAxLjAsIDYuMCkubmFtZSgnTWF4IE11bHRpcGxpZXInKTsKCiAgICBjb25zdCBjdXJ2ZU1hcCA9IHRocm93TWFwLmFkZEZvbGRlcignQ3VydmUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEJywgMC4wLCAxLjApLm5hbWUoJ0lucHV0IFRocmVzaG9sZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9TQ0FMRScsIDAuMCwgNDAwMC4wKS5uYW1lKCdTcGluIFNjYWxlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUEVFRF9NVUxUJywgMC4wLCA1LjApLm5hbWUoJ1N3aXBlIFNwZWVkIE11bHQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fQ0FQJywgMC4wLCA2MDAwLjApLm5hbWUoJ1NwaW4gQ2FwJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9QRVJGRUNUX1NQSU4nLCAwLjAsIDIwMDAuMCkubmFtZSgnUGVyZmVjdCBUaHJlc2hvbGQnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGVsZXBvcnQgLyBTdGF0ZSB0b29scwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0cCA9IHJvb3QuYWRkRm9sZGVyKCdUZWxlcG9ydCAvIFJlc2V0Jyk7CiAgICBjb25zdCB0cFBhcmFtcyA9IHsKICAgICAgICBUb0NlbnRlcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgYi5yZXNldCgpOyB9LAogICAgICAgIFRvQWN0aXZlUGxheWVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgaWYgKGIgJiYgcCkgYi5ncmFiKHApOyB9LAogICAgICAgIFRvSG9tZUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb0F3YXlHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvU2t5OiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDEwLCAwKTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgQ2xlYXJQcmV2aWV3OiAoKSA9PiBjbGVhclByZXZpZXdMaW5lKCkKICAgIH07CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0NlbnRlcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9BY3RpdmVQbGF5ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvSG9tZUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQXdheUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvU2t5Jyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdDbGVhclByZXZpZXcnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU2hvdCBDYW5ub24gKGZvcmNlIGZpcmUgd2l0aCBwYXJhbXMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5YJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblknLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBZJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWicsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFonKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ2ZpcmVCdXJzdCcsIDEsIDEwLCAxKS5uYW1lKCdCdXJzdCBDb3VudCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3ByZWFkRGVnJywgMCwgMzAsIDAuNSkubmFtZSgnU3ByZWFkIChkZWcpJyk7CgogICAgY29uc3QgZmlyZVBhcmFtcyA9IHsKICAgICAgICBGaXJlOiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGJhc2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoYi5zdGF0ZSA9PT0gJ2hlbGQnICYmIHAgJiYgcC5tZXNoKSA/IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjIsIDApKSA6IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAobGFiLmNhbm5vbi5maXJlQnVyc3QgfHwgMSk7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFzZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgaWYgKGxhYi5jYW5ub24uc3ByZWFkRGVnID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IChsYWIuY2Fubm9uLnNwcmVhZERlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgIGRpci54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBiLmRyb3AoKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHN0YXJ0KTsKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7CgogICAgICAgICAgICAgICAgY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKGxhYi5jYW5ub24uc3BpblggfHwgMCwgbGFiLmNhbm5vbi5zcGluWSB8fCAwLCBsYWIuY2Fubm9uLnNwaW5aIHx8IDApOwogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCBudWxsLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","./DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CgogICAgICAgIF9zZXR1cFJ1bnRpbWVNb25pdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1J1bnRpbWUgTW9uaXRvcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIERPTSBPdmVybGF5CiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5tb25pdG9yRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICAgICAgICAgICAgdG9wOiAnODBweCcsIAogICAgICAgICAgICAgICAgbGVmdDogJzEwcHgnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzhweCcsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAncmdiYSgwLCAwLCAwLCAwLjgpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzFweCBzb2xpZCAjMDBmZjAwJywKICAgICAgICAgICAgICAgIGNvbG9yOiAnIzAwZmYwMCcsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTFweCcsCiAgICAgICAgICAgICAgICBsaW5lSGVpZ2h0OiAnMS40JywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIG1pbldpZHRoOiAnMTUwcHgnLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnNHB4JywKICAgICAgICAgICAgICAgIHRleHRTaGFkb3c6ICcxcHggMXB4IDAgIzAwMCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5tb25pdG9yRWwpOwoKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgc2hvd092ZXJsYXk6IGZhbHNlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Nob3dPdmVybGF5JykubmFtZSgnU2hvdyBPdmVybGF5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgdXBkYXRlIGxvb3AKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5zaG93T3ZlcmxheSkgdGhpcy5fdXBkYXRlTW9uaXRvcigpOwogICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTW9uaXRvcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSBnbS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgbGV0IGh0bWwgPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkdBTUUgU1RBVEU8L2Rpdj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7Z20uc3RhdGV9PC9zcGFuPjxicj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZSBUaW1lcjogJHtnbS5zdGF0ZVRpbWVyLnRvRml4ZWQoMil9czxicj5gOwogICAgICAgICAgICBodG1sICs9IGBNYXRjaCBUaW1lOiAke01hdGguZmxvb3IoZ20udGltZS82MCl9OiR7TWF0aC5mbG9vcihnbS50aW1lJTYwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsJzAnKX0gKEgke2dtLmhhbGZ9KTxicj5gOwogICAgICAgICAgICAKICAgICAgICAgICAgaHRtbCArPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IG1hcmdpbi10b3A6OHB4OyBmb250LXdlaWdodDpib2xkOyBjb2xvcjojZmZmIj5CQUxMPC9kaXY+YDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0ZUNvbG9yID0gYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnID8gJyMwYWYnIDogKGJhbGwuc3RhdGUgPT09ICdoZWxkJyA/ICcjZmEwJyA6ICcjZjBmJyk7CiAgICAgICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiR7c3RhdGVDb2xvcn0iPiR7YmFsbC5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBob2xkZXJTdHIgPSAnTm9uZSc7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5yb2xlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSBiYWxsLmhvbGRlci50ZWFtID8gYmFsbC5ob2xkZXIudGVhbS5pZC50b1VwcGVyQ2FzZSgpIDogJz8nOwogICAgICAgICAgICAgICAgICAgIGhvbGRlclN0ciA9IGAke25hbWV9ICgke3RlYW19KWA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBodG1sICs9IGBIb2xkZXI6IDxzcGFuIHN0eWxlPSJjb2xvcjojZmZmIj4ke2hvbGRlclN0cn08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBodG1sICs9IGBQb3M6ICR7cC54LnRvRml4ZWQoMSl9LCAke3AueS50b0ZpeGVkKDEpfSwgJHtwLnoudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFNwZWVkOiAke2JhbGwudmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCArPSBgUG93ZXI6ICR7YmFsbC5wb3dlci50b0ZpeGVkKDEpfSAoJHtiYWxsLnBvd2VyVHlwZX0pPGJyPmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sICs9IGBPRkZMSU5FPGJyPmA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9Cn0pOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX1lfT0ZGU0VUJywgLTUwLjAsIDIwLjApLm5hbWUoJ0dvYWwgWSBQb3MnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnkgPSB2OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueSA9IHY7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9TQ0FMRScsIDEuMCwgMTAwLjApLm5hbWUoJ0dvYWwgU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnNjYWxlLnNldFNjYWxhcih2KTsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnNjYWxlLnNldFNjYWxhcih2KTsKICAgIH0pOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfQlVGRkVSJywgMC4wLCAyMC4wKS5uYW1lKCdTb2Z0IEJ1ZmZlcicpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfRk9SQ0UnLCAwLjAsIDIwMC4wKS5uYW1lKCdTb2Z0IEZvcmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEJvdW5jZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0ZSSUNUSU9OJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgRnJpY3Rpb24nKTsKICAgIGFyZW5hLmFkZChDLCAnRkxPT1JfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdDZWlsL0Zsb29yIEJvdW5jZScpOwoKICAgIGNvbnN0IHBvY2tldCA9IGFyZW5hLmFkZEZvbGRlcignR29hbCBQb2NrZXQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9YJywgMC4wLCA0MC4wKS5uYW1lKCdQb2NrZXQgSGFsZi1YJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9aJywgMC4wLCA1MC4wKS5uYW1lKCdQb2NrZXQgU3RhcnQgfFp8Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUG9ja2V0IFJhZGl1cycpOwoKICAgIGNvbnN0IGxhdW5jaCA9IHBoeXMuYWRkRm9sZGVyKCdMYXVuY2ggTWFwcGluZycpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ1NwZWVkIFNjYWxlJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfQ0FQJywgMTAuMCwgMjAwLjApLm5hbWUoJ1NwZWVkIENhcCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUaHJvdyBtYXBwaW5nIChQbGF5ZXIucmVsZWFzZUNoYXJnZSAtPiBCYWxsLnNob290KQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0aHJvd01hcCA9IHJvb3QuYWRkRm9sZGVyKCdUaHJvdyBNYXBwaW5nIChUaHJvd0NvbmZpZyknKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1NXSVBFX01JTl9QWCcsIDAsIDEyMCwgMSkubmFtZSgnU3dpcGUgTWluIFBYJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFhfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFggU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWV9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWSBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfQkFTRScsIDAuMSwgMy4wKS5uYW1lKCdQb3dlciBCYXNlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9SQU5HRScsIDAuMCwgMy4wKS5uYW1lKCdQb3dlciBSYW5nZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX0JPTlVTX1JBVElPJywgMC4wLCAxLjApLm5hbWUoJ01heCBCb251cyBSYXRpbycpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX01VTFRJUExJRVInLCAxLjAsIDYuMCkubmFtZSgnTWF4IE11bHRpcGxpZXInKTsKCiAgICBjb25zdCBjdXJ2ZU1hcCA9IHRocm93TWFwLmFkZEZvbGRlcignQ3VydmUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEJywgMC4wLCAxLjApLm5hbWUoJ0lucHV0IFRocmVzaG9sZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9TQ0FMRScsIDAuMCwgNDAwMC4wKS5uYW1lKCdTcGluIFNjYWxlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUEVFRF9NVUxUJywgMC4wLCA1LjApLm5hbWUoJ1N3aXBlIFNwZWVkIE11bHQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fQ0FQJywgMC4wLCA2MDAwLjApLm5hbWUoJ1NwaW4gQ2FwJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9QRVJGRUNUX1NQSU4nLCAwLjAsIDIwMDAuMCkubmFtZSgnUGVyZmVjdCBUaHJlc2hvbGQnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGVsZXBvcnQgLyBTdGF0ZSB0b29scwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0cCA9IHJvb3QuYWRkRm9sZGVyKCdUZWxlcG9ydCAvIFJlc2V0Jyk7CiAgICBjb25zdCB0cFBhcmFtcyA9IHsKICAgICAgICBUb0NlbnRlcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgYi5yZXNldCgpOyB9LAogICAgICAgIFRvQWN0aXZlUGxheWVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgaWYgKGIgJiYgcCkgYi5ncmFiKHApOyB9LAogICAgICAgIFRvSG9tZUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb0F3YXlHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvU2t5OiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDEwLCAwKTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgQ2xlYXJQcmV2aWV3OiAoKSA9PiBjbGVhclByZXZpZXdMaW5lKCkKICAgIH07CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0NlbnRlcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9BY3RpdmVQbGF5ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvSG9tZUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQXdheUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvU2t5Jyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdDbGVhclByZXZpZXcnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU2hvdCBDYW5ub24gKGZvcmNlIGZpcmUgd2l0aCBwYXJhbXMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5YJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblknLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBZJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWicsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFonKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ2ZpcmVCdXJzdCcsIDEsIDEwLCAxKS5uYW1lKCdCdXJzdCBDb3VudCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3ByZWFkRGVnJywgMCwgMzAsIDAuNSkubmFtZSgnU3ByZWFkIChkZWcpJyk7CgogICAgY29uc3QgZmlyZVBhcmFtcyA9IHsKICAgICAgICBGaXJlOiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGJhc2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoYi5zdGF0ZSA9PT0gJ2hlbGQnICYmIHAgJiYgcC5tZXNoKSA/IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjIsIDApKSA6IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAobGFiLmNhbm5vbi5maXJlQnVyc3QgfHwgMSk7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFzZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgaWYgKGxhYi5jYW5ub24uc3ByZWFkRGVnID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IChsYWIuY2Fubm9uLnNwcmVhZERlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgIGRpci54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBiLmRyb3AoKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHN0YXJ0KTsKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7CgogICAgICAgICAgICAgICAgY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKGxhYi5jYW5ub24uc3BpblggfHwgMCwgbGFiLmNhbm5vbi5zcGluWSB8fCAwLCBsYWIuY2Fubm9uLnNwaW5aIHx8IDApOwogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCBudWxsLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","/DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CgogICAgICAgIF9zZXR1cFJ1bnRpbWVNb25pdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1J1bnRpbWUgTW9uaXRvcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIERPTSBPdmVybGF5CiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5tb25pdG9yRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICAgICAgICAgICAgdG9wOiAnODBweCcsIAogICAgICAgICAgICAgICAgbGVmdDogJzEwcHgnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzhweCcsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAncmdiYSgwLCAwLCAwLCAwLjgpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzFweCBzb2xpZCAjMDBmZjAwJywKICAgICAgICAgICAgICAgIGNvbG9yOiAnIzAwZmYwMCcsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTFweCcsCiAgICAgICAgICAgICAgICBsaW5lSGVpZ2h0OiAnMS40JywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIG1pbldpZHRoOiAnMTUwcHgnLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnNHB4JywKICAgICAgICAgICAgICAgIHRleHRTaGFkb3c6ICcxcHggMXB4IDAgIzAwMCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5tb25pdG9yRWwpOwoKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgc2hvd092ZXJsYXk6IGZhbHNlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Nob3dPdmVybGF5JykubmFtZSgnU2hvdyBPdmVybGF5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgdXBkYXRlIGxvb3AKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5zaG93T3ZlcmxheSkgdGhpcy5fdXBkYXRlTW9uaXRvcigpOwogICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTW9uaXRvcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSBnbS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgbGV0IGh0bWwgPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkdBTUUgU1RBVEU8L2Rpdj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7Z20uc3RhdGV9PC9zcGFuPjxicj5gOwogICAgICAgICAgICBodG1sICs9IGBTdGF0ZSBUaW1lcjogJHtnbS5zdGF0ZVRpbWVyLnRvRml4ZWQoMil9czxicj5gOwogICAgICAgICAgICBodG1sICs9IGBNYXRjaCBUaW1lOiAke01hdGguZmxvb3IoZ20udGltZS82MCl9OiR7TWF0aC5mbG9vcihnbS50aW1lJTYwKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsJzAnKX0gKEgke2dtLmhhbGZ9KTxicj5gOwogICAgICAgICAgICAKICAgICAgICAgICAgaHRtbCArPSBgPGRpdiBzdHlsZT0iYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzQ0NDsgbWFyZ2luLWJvdHRvbTo0cHg7IG1hcmdpbi10b3A6OHB4OyBmb250LXdlaWdodDpib2xkOyBjb2xvcjojZmZmIj5CQUxMPC9kaXY+YDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0ZUNvbG9yID0gYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnID8gJyMwYWYnIDogKGJhbGwuc3RhdGUgPT09ICdoZWxkJyA/ICcjZmEwJyA6ICcjZjBmJyk7CiAgICAgICAgICAgICAgICBodG1sICs9IGBTdGF0ZTogPHNwYW4gc3R5bGU9ImNvbG9yOiR7c3RhdGVDb2xvcn0iPiR7YmFsbC5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBob2xkZXJTdHIgPSAnTm9uZSc7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5yb2xlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSBiYWxsLmhvbGRlci50ZWFtID8gYmFsbC5ob2xkZXIudGVhbS5pZC50b1VwcGVyQ2FzZSgpIDogJz8nOwogICAgICAgICAgICAgICAgICAgIGhvbGRlclN0ciA9IGAke25hbWV9ICgke3RlYW19KWA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBodG1sICs9IGBIb2xkZXI6IDxzcGFuIHN0eWxlPSJjb2xvcjojZmZmIj4ke2hvbGRlclN0cn08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBodG1sICs9IGBQb3M6ICR7cC54LnRvRml4ZWQoMSl9LCAke3AueS50b0ZpeGVkKDEpfSwgJHtwLnoudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFNwZWVkOiAke2JhbGwudmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX08YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCArPSBgUG93ZXI6ICR7YmFsbC5wb3dlci50b0ZpeGVkKDEpfSAoJHtiYWxsLnBvd2VyVHlwZX0pPGJyPmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sICs9IGBPRkZMSU5FPGJyPmA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9Cn0pOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX1lfT0ZGU0VUJywgLTUwLjAsIDIwLjApLm5hbWUoJ0dvYWwgWSBQb3MnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnkgPSB2OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueSA9IHY7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9TQ0FMRScsIDEuMCwgMTAwLjApLm5hbWUoJ0dvYWwgU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnNjYWxlLnNldFNjYWxhcih2KTsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnNjYWxlLnNldFNjYWxhcih2KTsKICAgIH0pOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfQlVGRkVSJywgMC4wLCAyMC4wKS5uYW1lKCdTb2Z0IEJ1ZmZlcicpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX1NPRlRfRk9SQ0UnLCAwLjAsIDIwMC4wKS5uYW1lKCdTb2Z0IEZvcmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEJvdW5jZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0ZSSUNUSU9OJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgRnJpY3Rpb24nKTsKICAgIGFyZW5hLmFkZChDLCAnRkxPT1JfRUxBU1RJQ0lUWScsIDAuMCwgMS4wKS5uYW1lKCdDZWlsL0Zsb29yIEJvdW5jZScpOwoKICAgIGNvbnN0IHBvY2tldCA9IGFyZW5hLmFkZEZvbGRlcignR29hbCBQb2NrZXQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9YJywgMC4wLCA0MC4wKS5uYW1lKCdQb2NrZXQgSGFsZi1YJyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9aJywgMC4wLCA1MC4wKS5uYW1lKCdQb2NrZXQgU3RhcnQgfFp8Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUG9ja2V0IFJhZGl1cycpOwoKICAgIGNvbnN0IGxhdW5jaCA9IHBoeXMuYWRkRm9sZGVyKCdMYXVuY2ggTWFwcGluZycpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ1NwZWVkIFNjYWxlJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfQ0FQJywgMTAuMCwgMjAwLjApLm5hbWUoJ1NwZWVkIENhcCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUaHJvdyBtYXBwaW5nIChQbGF5ZXIucmVsZWFzZUNoYXJnZSAtPiBCYWxsLnNob290KQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0aHJvd01hcCA9IHJvb3QuYWRkRm9sZGVyKCdUaHJvdyBNYXBwaW5nIChUaHJvd0NvbmZpZyknKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1NXSVBFX01JTl9QWCcsIDAsIDEyMCwgMSkubmFtZSgnU3dpcGUgTWluIFBYJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFhfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFggU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWV9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWSBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfQkFTRScsIDAuMSwgMy4wKS5uYW1lKCdQb3dlciBCYXNlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9SQU5HRScsIDAuMCwgMy4wKS5uYW1lKCdQb3dlciBSYW5nZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX0JPTlVTX1JBVElPJywgMC4wLCAxLjApLm5hbWUoJ01heCBCb251cyBSYXRpbycpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfTUFYX01VTFRJUExJRVInLCAxLjAsIDYuMCkubmFtZSgnTWF4IE11bHRpcGxpZXInKTsKCiAgICBjb25zdCBjdXJ2ZU1hcCA9IHRocm93TWFwLmFkZEZvbGRlcignQ3VydmUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEJywgMC4wLCAxLjApLm5hbWUoJ0lucHV0IFRocmVzaG9sZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9TQ0FMRScsIDAuMCwgNDAwMC4wKS5uYW1lKCdTcGluIFNjYWxlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUEVFRF9NVUxUJywgMC4wLCA1LjApLm5hbWUoJ1N3aXBlIFNwZWVkIE11bHQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fQ0FQJywgMC4wLCA2MDAwLjApLm5hbWUoJ1NwaW4gQ2FwJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9QRVJGRUNUX1NQSU4nLCAwLjAsIDIwMDAuMCkubmFtZSgnUGVyZmVjdCBUaHJlc2hvbGQnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGVsZXBvcnQgLyBTdGF0ZSB0b29scwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCB0cCA9IHJvb3QuYWRkRm9sZGVyKCdUZWxlcG9ydCAvIFJlc2V0Jyk7CiAgICBjb25zdCB0cFBhcmFtcyA9IHsKICAgICAgICBUb0NlbnRlcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgYi5yZXNldCgpOyB9LAogICAgICAgIFRvQWN0aXZlUGxheWVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgaWYgKGIgJiYgcCkgYi5ncmFiKHApOyB9LAogICAgICAgIFRvSG9tZUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb0F3YXlHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvU2t5OiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDEwLCAwKTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgQ2xlYXJQcmV2aWV3OiAoKSA9PiBjbGVhclByZXZpZXdMaW5lKCkKICAgIH07CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0NlbnRlcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9BY3RpdmVQbGF5ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvSG9tZUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQXdheUdvYWwnKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvU2t5Jyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdDbGVhclByZXZpZXcnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU2hvdCBDYW5ub24gKGZvcmNlIGZpcmUgd2l0aCBwYXJhbXMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5YJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblknLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBZJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWicsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFonKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ2ZpcmVCdXJzdCcsIDEsIDEwLCAxKS5uYW1lKCdCdXJzdCBDb3VudCcpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3ByZWFkRGVnJywgMCwgMzAsIDAuNSkubmFtZSgnU3ByZWFkIChkZWcpJyk7CgogICAgY29uc3QgZmlyZVBhcmFtcyA9IHsKICAgICAgICBGaXJlOiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGJhc2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoYi5zdGF0ZSA9PT0gJ2hlbGQnICYmIHAgJiYgcC5tZXNoKSA/IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAxLjIsIDApKSA6IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAobGFiLmNhbm5vbi5maXJlQnVyc3QgfHwgMSk7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFzZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgaWYgKGxhYi5jYW5ub24uc3ByZWFkRGVnID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IChsYWIuY2Fubm9uLnNwcmVhZERlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgIGRpci54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBiLmRyb3AoKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHN0YXJ0KTsKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7CgogICAgICAgICAgICAgICAgY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKGxhYi5jYW5ub24uc3BpblggfHwgMCwgbGFiLmNhbm5vbi5zcGluWSB8fCAwLCBsYWIuY2Fubm9uLnNwaW5aIHx8IDApOwogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCBudWxsLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","./DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","/DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","./MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","/MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","./PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","/PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","./WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","/WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","./GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","/GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCnRoaXMubWFzdGVyVm9sdW1lID0gMC44OyAvLyBJbmNyZWFzZWQgZnJvbSAwLjUKICAgICAgICAgICAgdGhpcy5iZ21MZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5zZnhMZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCgogICAgICAgICAgICAvLyBEeW5hbWljIFN0YXRlIChQaXRjaC9Wb2x1bWUgbW9kdWxhdGlvbikKICAgICAgICAgICAgdGhpcy5jdXJyZW50UmF0ZSA9IDEuMDsKdGhpcy5jdXJyZW50RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKCiAgICAgICAgc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCBpc092ZXJ0aW1lKSB7CiAgICAgICAgICAgIHRoaXMubWF0Y2hUZW5zaW9uID0gdGVuc2lvbjsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gaXNPdmVydGltZTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmdtIHx8IHRoaXMuaXNNdXRlZCkgcmV0dXJuOwoKbGV0IHRhcmdldFJhdGUgPSAxLjA7CiAgICAgICAgICAgIGxldCB0YXJnZXREeW5hbWljVm9sID0gMS4wOwoKICAgICAgICAgICAgLy8gVXNlIHB1c2hlZCBzdGF0ZSBmcm9tIEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLjAsIHRoaXMubWF0Y2hUZW5zaW9uIHx8IDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW9kdWxhdGUgUmF0ZTogMS4wIC0+IDEuMiAoSGlnaGVyIHBpdGNoL3RlbXBvKQogICAgICAgICAgICB0YXJnZXRSYXRlICs9IHQgKiAwLjI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2R1bGF0ZSBWb2x1bWU6IDEuMCAtPiAxLjMgKExvdWRlcikKICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSB0ICogMC4zOwoKICAgICAgICAgICAgLy8gT3ZlcnRpbWUgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0UmF0ZSArPSAwLjA1OwogICAgICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSAwLjE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU21vb3RoIEludGVycG9sYXRpb24gKExlcnApCiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IE1hdGgubWluKDEuMCwgZHQgKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlICs9ICh0YXJnZXRSYXRlIC0gdGhpcy5jdXJyZW50UmF0ZSkgKiBsZXJwU3BlZWQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudER5bmFtaWNWb2wgKz0gKHRhcmdldER5bmFtaWNWb2wgLSB0aGlzLmN1cnJlbnREeW5hbWljVm9sKSAqIGxlcnBTcGVlZDsKCiAgICAgICAgICAgIC8vIEFwcGx5IHRvIEJHTQogICAgICAgICAgICAvLyBQbGF5YmFjayBSYXRlIChQaXRjaCkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAtIHRoaXMuY3VycmVudFJhdGUpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXliYWNrUmF0ZSA9IHRoaXMuY3VycmVudFJhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZvbHVtZSAoQmFzZSAqIER5bmFtaWMpCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","./AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCnRoaXMubWFzdGVyVm9sdW1lID0gMC44OyAvLyBJbmNyZWFzZWQgZnJvbSAwLjUKICAgICAgICAgICAgdGhpcy5iZ21MZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5zZnhMZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCgogICAgICAgICAgICAvLyBEeW5hbWljIFN0YXRlIChQaXRjaC9Wb2x1bWUgbW9kdWxhdGlvbikKICAgICAgICAgICAgdGhpcy5jdXJyZW50UmF0ZSA9IDEuMDsKdGhpcy5jdXJyZW50RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKCiAgICAgICAgc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCBpc092ZXJ0aW1lKSB7CiAgICAgICAgICAgIHRoaXMubWF0Y2hUZW5zaW9uID0gdGVuc2lvbjsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gaXNPdmVydGltZTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmdtIHx8IHRoaXMuaXNNdXRlZCkgcmV0dXJuOwoKbGV0IHRhcmdldFJhdGUgPSAxLjA7CiAgICAgICAgICAgIGxldCB0YXJnZXREeW5hbWljVm9sID0gMS4wOwoKICAgICAgICAgICAgLy8gVXNlIHB1c2hlZCBzdGF0ZSBmcm9tIEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLjAsIHRoaXMubWF0Y2hUZW5zaW9uIHx8IDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW9kdWxhdGUgUmF0ZTogMS4wIC0+IDEuMiAoSGlnaGVyIHBpdGNoL3RlbXBvKQogICAgICAgICAgICB0YXJnZXRSYXRlICs9IHQgKiAwLjI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2R1bGF0ZSBWb2x1bWU6IDEuMCAtPiAxLjMgKExvdWRlcikKICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSB0ICogMC4zOwoKICAgICAgICAgICAgLy8gT3ZlcnRpbWUgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0UmF0ZSArPSAwLjA1OwogICAgICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSAwLjE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU21vb3RoIEludGVycG9sYXRpb24gKExlcnApCiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IE1hdGgubWluKDEuMCwgZHQgKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlICs9ICh0YXJnZXRSYXRlIC0gdGhpcy5jdXJyZW50UmF0ZSkgKiBsZXJwU3BlZWQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudER5bmFtaWNWb2wgKz0gKHRhcmdldER5bmFtaWNWb2wgLSB0aGlzLmN1cnJlbnREeW5hbWljVm9sKSAqIGxlcnBTcGVlZDsKCiAgICAgICAgICAgIC8vIEFwcGx5IHRvIEJHTQogICAgICAgICAgICAvLyBQbGF5YmFjayBSYXRlIChQaXRjaCkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAtIHRoaXMuY3VycmVudFJhdGUpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXliYWNrUmF0ZSA9IHRoaXMuY3VycmVudFJhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZvbHVtZSAoQmFzZSAqIER5bmFtaWMpCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","/AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCnRoaXMubWFzdGVyVm9sdW1lID0gMC44OyAvLyBJbmNyZWFzZWQgZnJvbSAwLjUKICAgICAgICAgICAgdGhpcy5iZ21MZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5zZnhMZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCgogICAgICAgICAgICAvLyBEeW5hbWljIFN0YXRlIChQaXRjaC9Wb2x1bWUgbW9kdWxhdGlvbikKICAgICAgICAgICAgdGhpcy5jdXJyZW50UmF0ZSA9IDEuMDsKdGhpcy5jdXJyZW50RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKCiAgICAgICAgc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCBpc092ZXJ0aW1lKSB7CiAgICAgICAgICAgIHRoaXMubWF0Y2hUZW5zaW9uID0gdGVuc2lvbjsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gaXNPdmVydGltZTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmdtIHx8IHRoaXMuaXNNdXRlZCkgcmV0dXJuOwoKbGV0IHRhcmdldFJhdGUgPSAxLjA7CiAgICAgICAgICAgIGxldCB0YXJnZXREeW5hbWljVm9sID0gMS4wOwoKICAgICAgICAgICAgLy8gVXNlIHB1c2hlZCBzdGF0ZSBmcm9tIEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLjAsIHRoaXMubWF0Y2hUZW5zaW9uIHx8IDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW9kdWxhdGUgUmF0ZTogMS4wIC0+IDEuMiAoSGlnaGVyIHBpdGNoL3RlbXBvKQogICAgICAgICAgICB0YXJnZXRSYXRlICs9IHQgKiAwLjI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2R1bGF0ZSBWb2x1bWU6IDEuMCAtPiAxLjMgKExvdWRlcikKICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSB0ICogMC4zOwoKICAgICAgICAgICAgLy8gT3ZlcnRpbWUgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0UmF0ZSArPSAwLjA1OwogICAgICAgICAgICAgICAgdGFyZ2V0RHluYW1pY1ZvbCArPSAwLjE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU21vb3RoIEludGVycG9sYXRpb24gKExlcnApCiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IE1hdGgubWluKDEuMCwgZHQgKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlICs9ICh0YXJnZXRSYXRlIC0gdGhpcy5jdXJyZW50UmF0ZSkgKiBsZXJwU3BlZWQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudER5bmFtaWNWb2wgKz0gKHRhcmdldER5bmFtaWNWb2wgLSB0aGlzLmN1cnJlbnREeW5hbWljVm9sKSAqIGxlcnBTcGVlZDsKCiAgICAgICAgICAgIC8vIEFwcGx5IHRvIEJHTQogICAgICAgICAgICAvLyBQbGF5YmFjayBSYXRlIChQaXRjaCkKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAtIHRoaXMuY3VycmVudFJhdGUpID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXliYWNrUmF0ZSA9IHRoaXMuY3VycmVudFJhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZvbHVtZSAoQmFzZSAqIER5bmFtaWMpCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","./LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","/LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCnRoaXMuY3Jvd2QgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgICAgICB0aGlzLl9idWlsZEdvYWxCYXJyaWVycygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7Ci8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKLy8gMi4gVmlzdWFsIEdsb3cgKEZsYXJlKQogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KfQoKICAgICAgICBfYnVpbGRHb2FsQmFycmllcnMoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnk6IEludmVydGVkIFRyaWFuZ2xlIChNYXRjaGVzIEdvYWwgSGl0Ym94KQogICAgICAgICAgICAvLyBUb3AgWTogMTIuMCwgQm90dG9tIFk6IC02LjAuIFdpZHRoIGF0IHRvcDogMjguMCAoKy8tIDE0LjApLgogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwotMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBSaWdodAogICAgICAgICAgICAgICAgICAwLjAsIC0xOC4wLCAwLjAgIC8vIEJvdHRvbSBDZW50ZXIKICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVVnMgZm9yIHNoYWRlciBlZmZlY3RzCiAgICAgICAgICAgIGNvbnN0IHV2cyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgMC4wLCAxLjAsCiAgICAgICAgICAgICAgICAxLjAsIDEuMCwKICAgICAgICAgICAgICAgIDAuNSwgMC4wCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodmVydGljZXMsIDMpKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodXZzLCAyKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICAvLyBGb3JjZWZpZWxkIFNoYWRlcgovLyBGb3JjZWZpZWxkIFNoYWRlcgogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHg0NGFhZmYpIH0sIC8vIEN5YW4vQmx1ZSBFbmVyZ3kKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4wIH0gLy8gSW52aXNpYmxlIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgICAgIHZQb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwoKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhleCBQYXR0ZXJuIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXYgKiAxNS4wOyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIHV2LnkgKz0gdVRpbWUgKiAwLjU7IC8vIFNjcm9sbCBkb3duCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW1wbGV4LWxpa2UgZ3JpZCBmb3IgaGV4IGFwcHJveGltYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiByID0gdmVjMigxLjAsIDEuNzMpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGggPSByICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGEgPSBtb2QodXYsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBiID0gbW9kKHV2IC0gaCwgcikgLSBoOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGcgPSBkb3QoYSwgYSkgPCBkb3QoYiwgYikgPyBhIDogYjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChnKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaW4gbGluZXMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGV4ID0gc21vb3Roc3RlcCgwLjQ1LCAwLjQ4LCBkaXN0KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMzAuMCAtIHVUaW1lICogMi4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVkZ2UgR2xvdyAoRnJlc25lbC1pc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBwb3coYWJzKHZVdi54IC0gMC41KSAqIDIuMCwgMy4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwYXR0ZXJuID0gKDEuMCAtIGhleCkgKiAwLjU7IC8vIFN0cm9uZ2VyIGdyaWQKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBzY2FuICogMC4yOyAgICAgICAgICAgICAvLyBTdHJvbmdlciBzY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuICs9IGVkZ2UgKiAwLjY7ICAgICAgICAgICAgIC8vIFN0cm9uZ2VyIGVkZ2UKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hc3RlciBPcGFjaXR5IENvbnRyb2wgKDAgPSBJbnZpc2libGUsIDEgPSBWaXNpYmxlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIGZpbGwgMC4xICsgcGF0dGVybiwgc2NhbGVkIGJ5IHVPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gKDAuMSArIHBhdHRlcm4pICogdU9wYWNpdHk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaW50CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodUNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEEgKEF3YXkgR29hbCAvIC1aKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJBID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJBLnBvc2l0aW9uLnNldCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEIgKEhvbWUgR29hbCAvICtaKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJCID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnBvc2l0aW9uLnNldCgwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIHRoaXMuYmFycmllckIucm90YXRpb24ueSA9IE1hdGguUEk7IC8vIEZhY2UgaW53YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZCh0aGlzLmJhcnJpZXJCKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmFycmllcnMgPSBbdGhpcy5iYXJyaWVyQSwgdGhpcy5iYXJyaWVyQl07CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKICAgICAgICAgICAgdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBMaWdodCBQb3BzIChDaW5lbWF0aWMpCiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBpZiAocy52aXNpYmxlICYmIHMuc2NhbGUueCA+IDguMCkgewogICAgICAgICAgICAgICAgICAgIC8vIERlY2F5IHBvcCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnggLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIHMuc2NhbGUueSAtPSBkdCAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2NhbGUueCA8IDguMCkgcy5zY2FsZS5zZXQoOCwgOCwgMSk7CmlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","./Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCnRoaXMuY3Jvd2QgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgICAgICB0aGlzLl9idWlsZEdvYWxCYXJyaWVycygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7Ci8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKLy8gMi4gVmlzdWFsIEdsb3cgKEZsYXJlKQogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KfQoKICAgICAgICBfYnVpbGRHb2FsQmFycmllcnMoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnk6IEludmVydGVkIFRyaWFuZ2xlIChNYXRjaGVzIEdvYWwgSGl0Ym94KQogICAgICAgICAgICAvLyBUb3AgWTogMTIuMCwgQm90dG9tIFk6IC02LjAuIFdpZHRoIGF0IHRvcDogMjguMCAoKy8tIDE0LjApLgogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwotMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBSaWdodAogICAgICAgICAgICAgICAgICAwLjAsIC0xOC4wLCAwLjAgIC8vIEJvdHRvbSBDZW50ZXIKICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVVnMgZm9yIHNoYWRlciBlZmZlY3RzCiAgICAgICAgICAgIGNvbnN0IHV2cyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgMC4wLCAxLjAsCiAgICAgICAgICAgICAgICAxLjAsIDEuMCwKICAgICAgICAgICAgICAgIDAuNSwgMC4wCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodmVydGljZXMsIDMpKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodXZzLCAyKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICAvLyBGb3JjZWZpZWxkIFNoYWRlcgovLyBGb3JjZWZpZWxkIFNoYWRlcgogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHg0NGFhZmYpIH0sIC8vIEN5YW4vQmx1ZSBFbmVyZ3kKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4wIH0gLy8gSW52aXNpYmxlIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgICAgIHZQb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwoKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhleCBQYXR0ZXJuIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXYgKiAxNS4wOyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIHV2LnkgKz0gdVRpbWUgKiAwLjU7IC8vIFNjcm9sbCBkb3duCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW1wbGV4LWxpa2UgZ3JpZCBmb3IgaGV4IGFwcHJveGltYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiByID0gdmVjMigxLjAsIDEuNzMpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGggPSByICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGEgPSBtb2QodXYsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBiID0gbW9kKHV2IC0gaCwgcikgLSBoOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGcgPSBkb3QoYSwgYSkgPCBkb3QoYiwgYikgPyBhIDogYjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChnKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaW4gbGluZXMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGV4ID0gc21vb3Roc3RlcCgwLjQ1LCAwLjQ4LCBkaXN0KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMzAuMCAtIHVUaW1lICogMi4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVkZ2UgR2xvdyAoRnJlc25lbC1pc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBwb3coYWJzKHZVdi54IC0gMC41KSAqIDIuMCwgMy4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwYXR0ZXJuID0gKDEuMCAtIGhleCkgKiAwLjU7IC8vIFN0cm9uZ2VyIGdyaWQKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBzY2FuICogMC4yOyAgICAgICAgICAgICAvLyBTdHJvbmdlciBzY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuICs9IGVkZ2UgKiAwLjY7ICAgICAgICAgICAgIC8vIFN0cm9uZ2VyIGVkZ2UKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hc3RlciBPcGFjaXR5IENvbnRyb2wgKDAgPSBJbnZpc2libGUsIDEgPSBWaXNpYmxlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIGZpbGwgMC4xICsgcGF0dGVybiwgc2NhbGVkIGJ5IHVPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gKDAuMSArIHBhdHRlcm4pICogdU9wYWNpdHk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaW50CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodUNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEEgKEF3YXkgR29hbCAvIC1aKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJBID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJBLnBvc2l0aW9uLnNldCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEIgKEhvbWUgR29hbCAvICtaKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJCID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnBvc2l0aW9uLnNldCgwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIHRoaXMuYmFycmllckIucm90YXRpb24ueSA9IE1hdGguUEk7IC8vIEZhY2UgaW53YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZCh0aGlzLmJhcnJpZXJCKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmFycmllcnMgPSBbdGhpcy5iYXJyaWVyQSwgdGhpcy5iYXJyaWVyQl07CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKICAgICAgICAgICAgdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBMaWdodCBQb3BzIChDaW5lbWF0aWMpCiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBpZiAocy52aXNpYmxlICYmIHMuc2NhbGUueCA+IDguMCkgewogICAgICAgICAgICAgICAgICAgIC8vIERlY2F5IHBvcCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnggLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIHMuc2NhbGUueSAtPSBkdCAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2NhbGUueCA8IDguMCkgcy5zY2FsZS5zZXQoOCwgOCwgMSk7CmlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","/Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCnRoaXMuY3Jvd2QgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgICAgICB0aGlzLl9idWlsZEdvYWxCYXJyaWVycygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7Ci8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKLy8gMi4gVmlzdWFsIEdsb3cgKEZsYXJlKQogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KfQoKICAgICAgICBfYnVpbGRHb2FsQmFycmllcnMoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnk6IEludmVydGVkIFRyaWFuZ2xlIChNYXRjaGVzIEdvYWwgSGl0Ym94KQogICAgICAgICAgICAvLyBUb3AgWTogMTIuMCwgQm90dG9tIFk6IC02LjAuIFdpZHRoIGF0IHRvcDogMjguMCAoKy8tIDE0LjApLgogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwotMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQuMCwgMi4wLCAwLjAsIC8vIFRvcCBSaWdodAogICAgICAgICAgICAgICAgICAwLjAsIC0xOC4wLCAwLjAgIC8vIEJvdHRvbSBDZW50ZXIKICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVVnMgZm9yIHNoYWRlciBlZmZlY3RzCiAgICAgICAgICAgIGNvbnN0IHV2cyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgMC4wLCAxLjAsCiAgICAgICAgICAgICAgICAxLjAsIDEuMCwKICAgICAgICAgICAgICAgIDAuNSwgMC4wCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodmVydGljZXMsIDMpKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodXZzLCAyKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICAvLyBGb3JjZWZpZWxkIFNoYWRlcgovLyBGb3JjZWZpZWxkIFNoYWRlcgogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHg0NGFhZmYpIH0sIC8vIEN5YW4vQmx1ZSBFbmVyZ3kKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4wIH0gLy8gSW52aXNpYmxlIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgICAgIHZQb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwoKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhleCBQYXR0ZXJuIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXYgKiAxNS4wOyAvLyBEZW5zaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIHV2LnkgKz0gdVRpbWUgKiAwLjU7IC8vIFNjcm9sbCBkb3duCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW1wbGV4LWxpa2UgZ3JpZCBmb3IgaGV4IGFwcHJveGltYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiByID0gdmVjMigxLjAsIDEuNzMpOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGggPSByICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGEgPSBtb2QodXYsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBiID0gbW9kKHV2IC0gaCwgcikgLSBoOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGcgPSBkb3QoYSwgYSkgPCBkb3QoYiwgYikgPyBhIDogYjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChnKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaW4gbGluZXMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGV4ID0gc21vb3Roc3RlcCgwLjQ1LCAwLjQ4LCBkaXN0KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMzAuMCAtIHVUaW1lICogMi4wKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVkZ2UgR2xvdyAoRnJlc25lbC1pc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGVkZ2UgPSBwb3coYWJzKHZVdi54IC0gMC41KSAqIDIuMCwgMy4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwYXR0ZXJuID0gKDEuMCAtIGhleCkgKiAwLjU7IC8vIFN0cm9uZ2VyIGdyaWQKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBzY2FuICogMC4yOyAgICAgICAgICAgICAvLyBTdHJvbmdlciBzY2FubGluZQogICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuICs9IGVkZ2UgKiAwLjY7ICAgICAgICAgICAgIC8vIFN0cm9uZ2VyIGVkZ2UKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hc3RlciBPcGFjaXR5IENvbnRyb2wgKDAgPSBJbnZpc2libGUsIDEgPSBWaXNpYmxlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBCYXNlIGZpbGwgMC4xICsgcGF0dGVybiwgc2NhbGVkIGJ5IHVPcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gKDAuMSArIHBhdHRlcm4pICogdU9wYWNpdHk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaW50CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodUNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEEgKEF3YXkgR29hbCAvIC1aKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJBID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJBLnBvc2l0aW9uLnNldCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQSk7CgogICAgICAgICAgICAvLyBCYXJyaWVyIEIgKEhvbWUgR29hbCAvICtaKQogICAgICAgICAgICB0aGlzLmJhcnJpZXJCID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnBvc2l0aW9uLnNldCgwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIHRoaXMuYmFycmllckIucm90YXRpb24ueSA9IE1hdGguUEk7IC8vIEZhY2UgaW53YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZCh0aGlzLmJhcnJpZXJCKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmFycmllcnMgPSBbdGhpcy5iYXJyaWVyQSwgdGhpcy5iYXJyaWVyQl07CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKICAgICAgICAgICAgdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBMaWdodCBQb3BzIChDaW5lbWF0aWMpCiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBpZiAocy52aXNpYmxlICYmIHMuc2NhbGUueCA+IDguMCkgewogICAgICAgICAgICAgICAgICAgIC8vIERlY2F5IHBvcCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnggLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIHMuc2NhbGUueSAtPSBkdCAqIDMwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2NhbGUueCA8IDguMCkgcy5zY2FsZS5zZXQoOCwgOCwgMSk7CmlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","./PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","/PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjb25zdCBPUkJfVFlQRVMgPSB7CiAgICAgICAgJ0hFQUwnOiB7IGNvbG9yOiAweDAwZmYwMCwgbGFiZWw6ICdIUCBVUCcsIGNoYW5jZTogMC4zIH0sCiAgICAgICAgJ0NIQVJHRSc6IHsgY29sb3I6IDB4ZmZhYTAwLCBsYWJlbDogJ0VOIFVQJywgY2hhbmNlOiAwLjMgfSwKICAgICAgICAnVEVDSCc6IHsgY29sb3I6IDB4MDBmZmZmLCBsYWJlbDogJ1RFQ0gnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjIgfQogICAgfTsKCiAgICBjbGFzcyBQb3dlclVwTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMub3JicyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5zcGF3bkludGVydmFsID0gMTAuMDsgLy8gU3Bhd24gZXZlcnkgMTAgc2Vjb25kcwogICAgICAgICAgICB0aGlzLm1heE9yYnMgPSA1OwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5jb250YWluZXIpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgc3Bhd24vdXBkYXRlIGR1cmluZyBhY3RpdmUgcGxheQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3Bhd25UaW1lciA+PSB0aGlzLnNwYXduSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yYnMubGVuZ3RoIDwgdGhpcy5tYXhPcmJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25SYW5kb21PcmIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpXTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBvcmIuYWdlICs9IGR0OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnBvc2l0aW9uLnkgPSBvcmIuYmFzZVkgKyBNYXRoLnNpbihvcmIuYWdlICogMi4wKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvcmIubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMi4wOwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnogKz0gZHQgKiAxLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChvcmIuYWdlID4gMjAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQ29sbGlzaW9uKG9yYiwgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduUmFuZG9tT3JiKCkgewogICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoT1JCX1RZUEVTKTsKICAgICAgICAgICAgY29uc3QgdHlwZUtleSA9IGtleXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICoga2V5cy5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgdHlwZURhdGEgPSBPUkJfVFlQRVNbdHlwZUtleV07CgogICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAzNS4wOwogICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgIGNvbnN0IHkgPSAoTWF0aC5yYW5kb20oKSAqIDQuMCkgLSAyLjA7CgogICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goX29yYkdlbywgX29yYk1hdEJhc2UuY2xvbmUoKSk7CiAgICAgICAgICAgIG1lc2gubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHR5cGVEYXRhLmNvbG9yKTsKICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoeCwgeSwgeik7CgogICAgICAgICAgICBjb25zdCBjb3JlR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNywgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGNvcmVNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIGNvbnN0IGNvcmUgPSBuZXcgVEhSRUUuTWVzaChjb3JlR2VvLCBjb3JlTWF0KTsKICAgICAgICAgICAgbWVzaC5hZGQoY29yZSk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CgogICAgICAgICAgICB0aGlzLm9yYnMucHVzaCh7CiAgICAgICAgICAgICAgICBtZXNoOiBtZXNoLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZUtleSwKICAgICAgICAgICAgICAgIGRhdGE6IHR5cGVEYXRhLAogICAgICAgICAgICAgICAgYmFzZVk6IHksCiAgICAgICAgICAgICAgICBhZ2U6IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTcGF3biBlZmZlY3QKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgbmV3IFRIUkVFLlZlY3RvcjMoeCx5LHopLCB7IHNjYWxlOiAyLjAsIGNvbG9yOiB0eXBlRGF0YS5jb2xvciB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2hlY2tDb2xsaXNpb24ob3JiLCBpbmRleCkgewogICAgICAgICAgICBjb25zdCBwbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuaG9tZSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMpOwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHBsYXllcnMucHVzaCguLi50aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGNvbnN0IGNvbGxpc2lvblJhZGl1c1NxID0gMi41ICogMi41OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKG9yYi5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjb2xsaXNpb25SYWRpdXNTcSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGVjdE9yYihvcmIsIHApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihvcmIuZGF0YS5sYWJlbCwgcGxheWVyLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG9yYi5tZXNoLnBvc2l0aW9uLCB7IAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LCAKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG9yYi5kYXRhLmNvbG9yIAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDAuOCwgcmF0ZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZW1vdmVPcmIoaW5kZXgpIHsKICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2luZGV4XTsKICAgICAgICAgICAgaWYgKG9yYi5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmUob3JiLm1lc2gpOwogICAgICAgICAgICAgICAgaWYgKG9yYi5tZXNoLm1hdGVyaWFsKSBvcmIubWVzaC5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAvLyBEaXNwb3NlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBvcmIubWVzaC50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMuZ2VvbWV0cnkpIGMuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgYy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vcmJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlciA9IFBvd2VyVXBNYW5hZ2VyOwp9KSgpOw==","./PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjb25zdCBPUkJfVFlQRVMgPSB7CiAgICAgICAgJ0hFQUwnOiB7IGNvbG9yOiAweDAwZmYwMCwgbGFiZWw6ICdIUCBVUCcsIGNoYW5jZTogMC4zIH0sCiAgICAgICAgJ0NIQVJHRSc6IHsgY29sb3I6IDB4ZmZhYTAwLCBsYWJlbDogJ0VOIFVQJywgY2hhbmNlOiAwLjMgfSwKICAgICAgICAnVEVDSCc6IHsgY29sb3I6IDB4MDBmZmZmLCBsYWJlbDogJ1RFQ0gnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjIgfQogICAgfTsKCiAgICBjbGFzcyBQb3dlclVwTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMub3JicyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5zcGF3bkludGVydmFsID0gMTAuMDsgLy8gU3Bhd24gZXZlcnkgMTAgc2Vjb25kcwogICAgICAgICAgICB0aGlzLm1heE9yYnMgPSA1OwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5jb250YWluZXIpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgc3Bhd24vdXBkYXRlIGR1cmluZyBhY3RpdmUgcGxheQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3Bhd25UaW1lciA+PSB0aGlzLnNwYXduSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yYnMubGVuZ3RoIDwgdGhpcy5tYXhPcmJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25SYW5kb21PcmIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpXTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBvcmIuYWdlICs9IGR0OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnBvc2l0aW9uLnkgPSBvcmIuYmFzZVkgKyBNYXRoLnNpbihvcmIuYWdlICogMi4wKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvcmIubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMi4wOwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnogKz0gZHQgKiAxLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChvcmIuYWdlID4gMjAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQ29sbGlzaW9uKG9yYiwgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduUmFuZG9tT3JiKCkgewogICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoT1JCX1RZUEVTKTsKICAgICAgICAgICAgY29uc3QgdHlwZUtleSA9IGtleXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICoga2V5cy5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgdHlwZURhdGEgPSBPUkJfVFlQRVNbdHlwZUtleV07CgogICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAzNS4wOwogICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgIGNvbnN0IHkgPSAoTWF0aC5yYW5kb20oKSAqIDQuMCkgLSAyLjA7CgogICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goX29yYkdlbywgX29yYk1hdEJhc2UuY2xvbmUoKSk7CiAgICAgICAgICAgIG1lc2gubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHR5cGVEYXRhLmNvbG9yKTsKICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoeCwgeSwgeik7CgogICAgICAgICAgICBjb25zdCBjb3JlR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNywgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGNvcmVNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIGNvbnN0IGNvcmUgPSBuZXcgVEhSRUUuTWVzaChjb3JlR2VvLCBjb3JlTWF0KTsKICAgICAgICAgICAgbWVzaC5hZGQoY29yZSk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CgogICAgICAgICAgICB0aGlzLm9yYnMucHVzaCh7CiAgICAgICAgICAgICAgICBtZXNoOiBtZXNoLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZUtleSwKICAgICAgICAgICAgICAgIGRhdGE6IHR5cGVEYXRhLAogICAgICAgICAgICAgICAgYmFzZVk6IHksCiAgICAgICAgICAgICAgICBhZ2U6IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTcGF3biBlZmZlY3QKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgbmV3IFRIUkVFLlZlY3RvcjMoeCx5LHopLCB7IHNjYWxlOiAyLjAsIGNvbG9yOiB0eXBlRGF0YS5jb2xvciB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2hlY2tDb2xsaXNpb24ob3JiLCBpbmRleCkgewogICAgICAgICAgICBjb25zdCBwbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuaG9tZSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMpOwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHBsYXllcnMucHVzaCguLi50aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGNvbnN0IGNvbGxpc2lvblJhZGl1c1NxID0gMi41ICogMi41OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKG9yYi5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjb2xsaXNpb25SYWRpdXNTcSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGVjdE9yYihvcmIsIHApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihvcmIuZGF0YS5sYWJlbCwgcGxheWVyLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG9yYi5tZXNoLnBvc2l0aW9uLCB7IAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LCAKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG9yYi5kYXRhLmNvbG9yIAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDAuOCwgcmF0ZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZW1vdmVPcmIoaW5kZXgpIHsKICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2luZGV4XTsKICAgICAgICAgICAgaWYgKG9yYi5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmUob3JiLm1lc2gpOwogICAgICAgICAgICAgICAgaWYgKG9yYi5tZXNoLm1hdGVyaWFsKSBvcmIubWVzaC5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAvLyBEaXNwb3NlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBvcmIubWVzaC50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMuZ2VvbWV0cnkpIGMuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgYy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vcmJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlciA9IFBvd2VyVXBNYW5hZ2VyOwp9KSgpOw==","/PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjb25zdCBPUkJfVFlQRVMgPSB7CiAgICAgICAgJ0hFQUwnOiB7IGNvbG9yOiAweDAwZmYwMCwgbGFiZWw6ICdIUCBVUCcsIGNoYW5jZTogMC4zIH0sCiAgICAgICAgJ0NIQVJHRSc6IHsgY29sb3I6IDB4ZmZhYTAwLCBsYWJlbDogJ0VOIFVQJywgY2hhbmNlOiAwLjMgfSwKICAgICAgICAnVEVDSCc6IHsgY29sb3I6IDB4MDBmZmZmLCBsYWJlbDogJ1RFQ0gnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjIgfQogICAgfTsKCiAgICBjbGFzcyBQb3dlclVwTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMub3JicyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5zcGF3bkludGVydmFsID0gMTAuMDsgLy8gU3Bhd24gZXZlcnkgMTAgc2Vjb25kcwogICAgICAgICAgICB0aGlzLm1heE9yYnMgPSA1OwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5jb250YWluZXIpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIE9ubHkgc3Bhd24vdXBkYXRlIGR1cmluZyBhY3RpdmUgcGxheQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3Bhd25UaW1lciA+PSB0aGlzLnNwYXduSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yYnMubGVuZ3RoIDwgdGhpcy5tYXhPcmJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25SYW5kb21PcmIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpXTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBvcmIuYWdlICs9IGR0OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnBvc2l0aW9uLnkgPSBvcmIuYmFzZVkgKyBNYXRoLnNpbihvcmIuYWdlICogMi4wKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvcmIubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMi4wOwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnogKz0gZHQgKiAxLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChvcmIuYWdlID4gMjAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQ29sbGlzaW9uKG9yYiwgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduUmFuZG9tT3JiKCkgewogICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoT1JCX1RZUEVTKTsKICAgICAgICAgICAgY29uc3QgdHlwZUtleSA9IGtleXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICoga2V5cy5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgdHlwZURhdGEgPSBPUkJfVFlQRVNbdHlwZUtleV07CgogICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAzNS4wOwogICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgIGNvbnN0IHkgPSAoTWF0aC5yYW5kb20oKSAqIDQuMCkgLSAyLjA7CgogICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goX29yYkdlbywgX29yYk1hdEJhc2UuY2xvbmUoKSk7CiAgICAgICAgICAgIG1lc2gubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHR5cGVEYXRhLmNvbG9yKTsKICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoeCwgeSwgeik7CgogICAgICAgICAgICBjb25zdCBjb3JlR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNywgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGNvcmVNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIGNvbnN0IGNvcmUgPSBuZXcgVEhSRUUuTWVzaChjb3JlR2VvLCBjb3JlTWF0KTsKICAgICAgICAgICAgbWVzaC5hZGQoY29yZSk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CgogICAgICAgICAgICB0aGlzLm9yYnMucHVzaCh7CiAgICAgICAgICAgICAgICBtZXNoOiBtZXNoLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZUtleSwKICAgICAgICAgICAgICAgIGRhdGE6IHR5cGVEYXRhLAogICAgICAgICAgICAgICAgYmFzZVk6IHksCiAgICAgICAgICAgICAgICBhZ2U6IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTcGF3biBlZmZlY3QKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgbmV3IFRIUkVFLlZlY3RvcjMoeCx5LHopLCB7IHNjYWxlOiAyLjAsIGNvbG9yOiB0eXBlRGF0YS5jb2xvciB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2hlY2tDb2xsaXNpb24ob3JiLCBpbmRleCkgewogICAgICAgICAgICBjb25zdCBwbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuaG9tZSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMpOwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHBsYXllcnMucHVzaCguLi50aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGNvbnN0IGNvbGxpc2lvblJhZGl1c1NxID0gMi41ICogMi41OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKG9yYi5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjb2xsaXNpb25SYWRpdXNTcSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGVjdE9yYihvcmIsIHApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihvcmIuZGF0YS5sYWJlbCwgcGxheWVyLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG9yYi5tZXNoLnBvc2l0aW9uLCB7IAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LCAKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG9yYi5kYXRhLmNvbG9yIAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDAuOCwgcmF0ZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZW1vdmVPcmIoaW5kZXgpIHsKICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2luZGV4XTsKICAgICAgICAgICAgaWYgKG9yYi5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmUob3JiLm1lc2gpOwogICAgICAgICAgICAgICAgaWYgKG9yYi5tZXNoLm1hdGVyaWFsKSBvcmIubWVzaC5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAvLyBEaXNwb3NlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBvcmIubWVzaC50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMuZ2VvbWV0cnkpIGMuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgYy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vcmJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU9yYihpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlciA9IFBvd2VyVXBNYW5hZ2VyOwp9KSgpOw=="}}</script></head>
<body>
<div id="game-container">
<img id="screen-overlay-gif" src="https://i.postimg.cc/htrkgHTr/grok-video-2026-01-09-06-22-47-ezgif-com-resize.gif">
<div id="ui-layer">
            <div id="ui-particles">
                <div class="ui-mote layer-1"></div>
                <div class="ui-mote layer-2"></div>
                <div class="ui-mote layer-3"></div>
            </div>
            <!-- Cinematic Letterboxing -->
            <div id="cinematic-bars">
                <div class="bar top"></div>
                <div class="bar bottom"></div>
            </div>

            <!-- Tech Copy / Event Flash System -->
            <div id="tech-flash-overlay">
                <div class="flash-line top"></div>
                <div class="tech-content-wrapper">
                    <div class="tech-text">TECHCOPY!</div>
                    <div class="tech-sub-text"></div>
                    <div class="tech-timer-track">
                        <div class="tech-timer-fill"></div>
                    </div>
                </div>
                <div class="flash-line bottom"></div>
            </div>

            <div id="loading">Loading Blitzball...</div>

            <!-- Top HUD -->
<div id="hud-top">
                <div class="hud-mist"></div>
                
                <div class="team-wing home">
                    <div class="crystal-border"></div>
                    <div class="team-data">
                        <div class="team-name">BESAID</div>
                        <div class="team-sub">AUROCHS</div>
                    </div>
                    <div class="score-box">
                        <div id="score-player" class="score-digit">0</div>
                    </div>
                </div>

                <div class="timer-complex">
                    <div class="timer-crystal-ring"></div>
                    <div class="timer-content">
                        <div id="half-indicator">1st</div>
                        <div id="timer-display">00:00</div>
                    </div>
                </div>

                <div class="team-wing away">
                    <div class="crystal-border"></div>
                    <div class="score-box">
                        <div id="score-cpu" class="score-digit">0</div>
                    </div>
                    <div class="team-data">
                        <div class="team-name">LUCA</div>
                        <div class="team-sub">GOERS</div>
                    </div>
                </div>
            </div>

            <!-- NEW: Goal Distance Indicator -->
            <div id="goal-distance-container">
                <div class="distance-label">GOAL</div>
                <div id="goal-distance">0m</div>
            </div>

            <!-- Mini-Map -->
            <div id="minimap-container">
                <div class="radar-rim"></div>
                <div id="minimap"></div>
                <div class="radar-label">SPHERE POOL</div>
            </div>

            <!-- Player Status Panel -->
            <div id="player-status-panel">
                <div class="char-name">TIDUS</div>
                <div class="hp-gauge-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar-track">
                        <div class="hp-bar-fill" style="width: 100%;"></div>
                    </div>
                    <div class="hp-value">120/120</div>
                </div>
                <div class="tech-gauge-container">
                    <div class="tech-label">EXP</div>
                    <div class="tech-bar-track">
                        <div class="tech-bar-fill" style="width: 45%;"></div>
                    </div>
                </div>
            </div>
<!-- 3. Renderer -->
            <!-- NEW: Charge Power Meter -->
            <div id="charge-meter-container">
                <div class="charge-label">POWER</div>
                <div class="charge-meter-track">
                    <div id="charge-meter-fill"></div>
                </div>
                <div class="charge-hint">RELEASE!</div>
            </div>

            <!-- Announcement -->
            <div id="announcement">GOAL!</div>
<!-- Controls -->
            <!-- Controls -->
            <!-- Movement Joystick (Left) -->
            <div id="joystick-hit-zone"></div>
            <div id="joystick-visual-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>

            <!-- NEW: Aim Joystick (Right) -->
            <div id="aim-joystick-zone"></div>
            <div id="aim-joystick-visual">
                <div id="aim-joystick-base"></div>
                <div id="aim-joystick-knob"></div>
            </div>

            <div id="camera-zone"></div>

            <!-- Action Command -->
            <div id="action-container">
                <div class="command-menu-bg"></div>
                <div class="command-ring"></div>
                <div id="action-label">COMMAND</div>
                <div id="action-buttons-wrapper" style="position: relative; width: 100px; height: 100px;">
<div id="action-button">
                        <!-- Layer 1: Outer Ornate Ring (Metal/Gold) -->
                        <div class="ab-outer-ring"></div>
                        <!-- Layer 2: Rune Ring (Spinning Text/Symbols) -->
                        <div class="ab-rune-ring"></div>
                        <!-- Layer 3: Inner Crystal Housing -->
                        <div class="ab-inner-crystal"></div>
                        <!-- Layer 4: Liquid Core (The button surface) -->
                        <div class="ab-liquid-core"></div>
                        <!-- Layer 5: Limit Break / Overdrive Ring -->
                        <div class="limit-ring"></div>
                        <!-- Layer 6: Text Label -->
                        <span class="btn-text">WAIT</span>
                        <!-- Layer 7: Glare/Shine Overlay -->
                        <div class="btn-glare"></div>
                        <!-- Layer 8: Particle Emitter Anchor -->
                        <div class="ab-particles"></div>
                    </div>
                    <div id="pass-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">PASS</span>
                        <div class="btn-glare"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Tackle Button -->
            <div id="tackle-button">
                <span class="btn-text">TACKLE</span>
                <div class="btn-glare"></div>
            </div>

            <!-- Auto/Demo Toggle -->
            <div id="auto-toggle" class="glass-btn">MANUAL</div>

            <!-- NEW: Settings Button -->
            <div id="settings-button" class="glass-btn">SETTINGS</div>

            <div id="practice-restore-btn">MENU</div>
<div id="controls-hint">WASD or Drag to Swim | Swipe to Dash</div>

            <!-- Gesture Hint Overlay -->
            <div id="gesture-hint">
                <svg width="200" height="300" viewBox="0 0 200 300" style="overflow: visible;">
                    <path class="curve-arrow" d="M100 250 Q 180 150 100 50" stroke="#00ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="15 15"></path>
                    <polygon points="100,40 115,65 85,65" fill="#00ffff" filter="drop-shadow(0 0 5px #00ffff)"></polygon>
                </svg>
                <div class="gesture-text">SWIPE CURVE</div>
                <div class="gesture-hand"></div>
<div class="gesture-hand"></div>
            </div>

            <!-- Offscreen Player Indicator -->
            <div id="offscreen-indicator">
                <div class="arrow"></div>
            </div>

            <!-- NEW: Settings Panel -->
<!-- NEW: Settings Panel -->
<div id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <span>SETTINGS</span>
                    <button id="settings-close">X</button>
                </div>
                <div class="settings-content">
                    <div class="setting-row">
                        <label>Sensitivity</label>
                        <input type="range" id="sensitivity-slider" min="50" max="150" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Aim Assist</label>
                        <input type="checkbox" id="aim-assist-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Camera Shake</label>
                        <input type="checkbox" id="shake-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" value="50">
                    </div>
                    <div class="setting-row" style="justify-content: center; margin-top: 20px; background: transparent;">
                        <button id="exit-to-menu-btn" class="glass-btn" style="width: 100%; border-color: #ff4444; color: #ff4444;">EXIT TO MENU</button>
                    </div>
                </div>
            </div>


            <!-- Practice Overlay -->
            <div id="practice-overlay">
                <div class="practice-panel">
                    <div class="panel-header">
                        <div class="panel-minimize-btn" id="p-minimize">-</div>
                        <div class="panel-title-group">
                            <span class="panel-title">BLITZ TRAINING</span>
                            <span class="panel-subtitle">SPHERE POOL SIMULATION</span>
                        </div>
                        <div class="panel-deco-line"></div>
                    </div>

                    <div class="panel-content">
                        <div class="panel-section">
                            <div class="section-label">DRILL SELECTION</div>
                            <div class="drill-list">
<div class="drill-btn active" data-drill="free">
                                    <span class="icon"></span> FREE ROAM
                                </div>
                                <div class="drill-btn" data-drill="ball_lab">
                                    <span class="icon"></span> BALL LAB
                                </div>
                                <div class="drill-btn" data-drill="shooting">
                                    <span class="icon"></span> SHOOTING
                                </div>
                                <div class="drill-btn" data-drill="passing">
                                    <span class="icon"></span> PASSING
                                </div>
<div class="drill-btn" data-drill="defense">
                                    <span class="icon"></span> DEFENSE
                                </div>
                                <div class="drill-btn" data-drill="curve">
<span class="icon"></span> CURVE BALL
                                </div>
                                <div class="drill-btn" data-drill="rapid_fire">
                                    <span class="icon"></span> RAPID FIRE
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="section-label">SYSTEM OVERRIDE</div>
                            <div class="option-list">
<div class="option-toggle active" id="opt-inf-stat">
                                    <span class="checkbox"></span> INF STATS
                                </div>
                                <div class="option-toggle active" id="opt-ai-dummy">
                                    <span class="checkbox"></span> AI DUMMY
                                </div>
                                <div class="option-toggle" id="opt-hitboxes">
                                    <span class="checkbox"></span> HITBOXES
                                </div>
                            </div>

                            <div class="section-label" style="margin-top: 15px;">COMMANDS</div>
                            <div class="action-btn" id="p-reset-ball">RESET BALL (R)</div>
                            <div class="action-btn" id="p-exit">EXIT PRACTICE</div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <div id="drill-instruction">SELECT A DRILL TO BEGIN SIMULATION</div>
                        <div id="drill-score">SCORE: 0</div>
                    </div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="active">
                <div class="menu-bg-overlay"></div>
                <div class="ffx-logo-container">
                    <div class="ffx-logo-main">BLITZBALL</div>
                    <div class="ffx-logo-sub">REMASTERED</div>
                </div>
                <div class="menu-options">
                    <div class="menu-item" data-action="normal">
                        <span class="cursor">&gt;</span>
                        <span class="label">NORMAL MATCH</span>
                    </div>
                    <div class="menu-item" data-action="practice">
                        <span class="cursor">&gt;</span>
                        <span class="label">PRACTICE</span>
                    </div>
                    <div class="menu-item" data-action="ball_lab">
                        <span class="cursor">&gt;</span>
                        <span class="label">BALL LAB</span>
                    </div>
                    <div class="menu-item" data-action="options">
                        <span class="cursor">&gt;</span>
                        <span class="label">OPTIONS</span>
                    </div>
                </div>
                <div class="menu-footer">FLUX ENGINE v2.0</div>
</div>

            <!-- NEW: End Game Menu -->
            <div id="end-game-menu">
                <div class="end-bg-layer"></div>
                <div class="end-content">
                    <div class="result-header">
                        <div class="result-title" id="end-result-title">VICTORY</div>
                        <div class="result-subtitle">MATCH COMPLETE</div>
                    </div>
                    
                    <div class="final-score-container">
                        <div class="final-team home">
                            <div class="final-score-digit" id="end-score-home">3</div>
                            <div class="final-team-name">BESAID</div>
                        </div>
                        <div class="final-vs">
                            <div class="vs-line"></div>
                            <span>VS</span>
                            <div class="vs-line"></div>
                        </div>
                        <div class="final-team away">
                            <div class="final-score-digit" id="end-score-away">1</div>
                            <div class="final-team-name">LUCA</div>
                        </div>
                    </div>

                    <div class="end-options">
                        <div class="menu-item" id="end-btn-rematch">
                            <span class="cursor">&gt;</span>
                            <span class="label">REMATCH</span>
                        </div>
                        <div class="menu-item" id="end-btn-exit">
                            <span class="cursor">&gt;</span>
                            <span class="label">EXIT TO MENU</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script>(function() {
    window.flux = window.flux || {};

    const _loader = new THREE.GLTFLoader();

    // Helper to convert a single material to Basic (Unlit/PSX)
// Helper to convert a single material to Basic (Unlit/PSX)
    function convertMaterial(oldMat, isSkinned) {
        
        // Preserve texture: Check map, then emissiveMap
        const texture = oldMat.map || oldMat.emissiveMap || null;

        // FORCE OPAQUE VISIBILITY
        // We override transparency to ensure models are always visible (fixing the "invisible model" issue).
        const params = {
            map: texture,
            color: 0xffffff,        // FORCE WHITE: Remove any tint from GLTF
            skinning: isSkinned,
            side: THREE.DoubleSide, // Render both sides to prevent backface culling invisibility
            transparent: false,     // Disable transparency to prevent sorting issues
            opacity: 1.0,           // Force full opacity
            alphaTest: 0.5,         // Strong alpha test for cutouts (nets/grates)
            vertexColors: oldMat.vertexColors, // Preserve vertex colors
            depthTest: true,
            depthWrite: true,       // Force depth write so it occludes properly
            fog: true
        };

        // Ensure texture encoding is correct for Three.js
        if (params.map) params.map.encoding = THREE.sRGBEncoding;

        return new THREE.MeshBasicMaterial(params);
    }

    window.flux.AssetLoader = {
        loadModel: function(url, onLoad, onProgress, onError) {
            _loader.load(url, function(gltf) {
                gltf.scene.traverse(function(node) {
                    if (node.isMesh) {
node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // Prevent invisibility
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material = node.material.map(m => convertMaterial(m, node.isSkinnedMesh));
                            } else {
                                node.material = convertMaterial(node.material, node.isSkinnedMesh);
                            }
                        }
                    }
                });
                if (onLoad) onLoad(gltf);
            }, onProgress, onError);
        }
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Ball Lab / DevTools: throw & curve mapping knobs
window.flux.ThrowConfig = window.flux.ThrowConfig || {
        SWIPE_MIN_PX: 20,
        AIM_DX_SCALE: 1,
        AIM_DY_SCALE: 1,

        POWER_BASE: 1,
        POWER_RANGE: 0.8,
        POWER_MAX_BONUS_RATIO: 0.95,
        POWER_MAX_MULTIPLIER: 2.5,

        CURVE_ENABLED: true,
        CURVE_INTENSITY_THRESHOLD: 0.25,
        CURVE_SPIN_SCALE: 1000,
        CURVE_SPEED_MULT: 1.5,
        CURVE_SPIN_CAP: 1500,
        CURVE_PERFECT_SPIN: 500
    };

    // Reusable math objects
    const _pVec = new THREE.Vector3();
    const _pVec2 = new THREE.Vector3();
    const _pQuat = new THREE.Quaternion();
    const _pQuat2 = new THREE.Quaternion();
    const _pTargetQuat = new THREE.Quaternion();
    const _pEuler = new THREE.Euler();
    const _pAxisY = new THREE.Vector3(0, 1, 0);
    const _pAxisZ = new THREE.Vector3(0, 0, 1);
    const _pInvQuat = new THREE.Quaternion();
    const _pTmpQuat = new THREE.Quaternion();
    const _pTmpEuler = new THREE.Euler();


    // --- NEW: Reticle Texture for Pass Indicator ---
    const _reticleTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 256; c.height = 256;
        const ctx = c.getContext('2d');
        const cx = 128, cy = 128;
        
        ctx.clearRect(0,0,256,256);
        
        // Glow
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#ffffff';
        
        // 1. Outer Ring Segments
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        
        for(let i=0; i<3; i++) {
            const start = (i * (Math.PI*2)/3) + 0.2;
            const end = ((i+1) * (Math.PI*2)/3) - 0.2;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, start, end);
            ctx.stroke();
        }
        
        // 2. Inner Brackets
        ctx.lineWidth = 4;
        const r = 60;
        const len = 20;
        // Corners
        const drawCorner = (x, y, dx, dy) => {
            ctx.beginPath();
            ctx.moveTo(x, y-dy*len);
            ctx.lineTo(x, y);
            ctx.lineTo(x-dx*len, y);
            ctx.stroke();
        };
        drawCorner(cx-r, cy-r, -1, -1); // TL
        drawCorner(cx+r, cy-r, 1, -1);  // TR
        drawCorner(cx+r, cy+r, 1, 1);   // BR
        drawCorner(cx-r, cy+r, -1, 1);  // BL

        // 3. Center Dot
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(cx, cy, 10, 0, Math.PI*2);
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    class Player {
        constructor(scene, role = 'MF') {
            this.scene = scene;
            this.role = role;
            this.team = null; // Assigned by Team.addPlayer
            this.homePosition = new THREE.Vector3();

            this.mesh = null;
            this.mixer = null;
            this.actions = {};
            this.activeAction = null;
            this.state = 'idle';
            this._animLocked = false;
            this._lockedState = null;
            this._lastLocomotion = 'idle';
            this.inputVector = new THREE.Vector3(0, 0, 0);

            // Physics (Drift/Inertia Model)
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.acceleration = 12.0;
            this.drag = 3.0;
            this.maxSpeed = 8.0;
            // Bone reference for holding ball
            this.handBone = null;
            // Procedural animation bone refs (filled in setMesh)
            this.bones = {
                hips: null,
                spine: null,
                chest: null,
                neck: null,
                head: null,
                rUpperArm: null,
                rForeArm: null,
                rHand: null,
                lUpperArm: null,
                lForeArm: null,
                lHand: null
            };
            this._boneBaseQuats = null; // Optional future use
            this._procAnimTime = 0;
            this._smoothedSpeed = 0;
            this._movingLatch = false;

            this.canCatch = true;
            this.catchCooldown = 0; // Replaces setTimeout for safety

            // Blitzball Stats
            this.stats = {
                HP: 100,
                maxHP: 100,
                EN: 30,
                AT: 10,
                PA: 15,
                BL: 10,
                SH: 15,
                CA: 10,
                SP: 60
            };

            // Leveling System
            this.level = 1;
            this.exp = 0;
            this.nextLevelExp = 100;

            // Status Effects & Techniques
this.status = {
                venom: 0,
                nap: 0,
                wither: { PA: 0, SH: 0, AT: 0, BL: 0, CA: 0, SP: 0 },
                blind: 0,
                silence: 0,
                shield: 0,
                haste: 0,
                slow: 0
            };

            this.marking = null;
            this.learnedTechs = [];

            this.techs = {
                tackle: null,
                shoot: null,
                pass: null,
                passive: null
            };

            // Visuals
            this.baseColorHex = 0xffffff;
            this.originalMaterials = [];
            this.auraMesh = null;
            this.rotationOffset = 0;
            this.baseScale = 1.17; // Increased ~8%

            // Real-time Stats
            this.currentEN = this.stats.EN;
            this.tackleRadius = 2.0; // Reduced from 2.5 to reduce swarm lock

            this.speed = 4.0;
            this._updateDerivedStats();

            this.hasBall = false;
            this.isThrowing = false;

            // Dash State
            this.isDashing = false;
            this.dashTime = 0;
            this.dashTotalTime = 0.5;
            this.dashCooldown = 0;
            this.dashVec = new THREE.Vector3();

            // Feedback Accumulators
            this._accumulatedDamage = 0;
            this._damageTimer = 0;

            // HP Bar
            this.hpBar = null;
            this.hpBarFill = null;

            // Gameplay Flow Timers
            this.stunTimer = 0;
            this.immunityTimer = 0;

            // Banking & Verticality
            this.bankingAmount = 0;
            this.targetY = 0;

            // Encounter System
            this.isEngaged = false;
            this.clashTimer = 0;

            this.encounterTimer = 0; // Track duration of current engagement
            // Charge Mechanic
            this.isCharging = false;
            this.chargeTime = 0;
            this.maxChargeTime = 1.5;

            // FIXED: Improved Rotation State with hysteresis
            this.currentYaw = 0;
            this.targetYaw = 0;
            this.lastValidYaw = 0; // Store last known good yaw for deadzone handling
            this.pitchAmount = 0;
            this.bankingAmount = 0;
            this.facingDeadzone = 0.3; // Minimum input/velocity magnitude to update facing

            // Particle Emission Timers
            this._particleTimers = {
venom: 0,
                nap: 0,
                wither: 0,
                blind: 0,
                silence: 0,
                shield: 0,
                haste: 0,
                slow: 0
            };

            // DevTools Flags
            this.isGodMode = false;

            // Pass Target Indicator
            this.passTargetIndicator = null;
            
            // Bubble Trail Timer
            this._bubbleTimer = 0;

            this._dashParticleTimer = 0;
            this.struggleIntensity = 0; // Continuous pressure factor (0.0 to 1.0)

            // --- JUICE: Visual Feedback ---
            this.flashTimer = 0;
            this.flashDuration = 0;
            this.flashColor = new THREE.Color(0xffffff);

            this.currentSquash = new THREE.Vector3(1, 1, 1);
            this.squashVelocity = new THREE.Vector3(0, 0, 0);
            
            // HP Bar FX State
            this.hpShake = 0;
            this.hpFlash = 0;


// --- NEW: Evasion & Charged Tackle ---
            this.isEvading = false;
            this.evadeTime = 0;
            this.evadeCooldown = 0;
            
            this.isTackleCharging = false;
            this.tackleChargeTime = 0;
            this.maxTackleChargeTime = 1.5;
            this.tackleChargeBonus = 0;

            // --- NEW: Tackle Mechanics (Phase 1) ---
            this.isTackling = false;
            this.tackleTime = 0;
            this.isRecovering = false;
            this.recoveryTime = 0;
            this._hasHitTackle = false;
            
            // --- NEW: Blocking ---
            this.isBlocking = false;
        }

        syncRotation() {
            if (!this.mesh) return;
            const euler = new THREE.Euler().setFromQuaternion(this.mesh.quaternion, 'YXZ');
            this.currentYaw = euler.y - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.lastValidYaw = this.currentYaw;
            this.bankingAmount = 0;
            this.pitchAmount = 0;
        }

getStat(name) {
            let val = this.stats[name];
            if (this.status.wither[name] > 0) {
                val *= 0.5;
            }
            // Blocking Bonus
            if (this.isBlocking && name === 'BL') {
                val *= 2.0;
            }
            return val;
        }

        applyStatus(type, duration, subType = null) {
            if (type === 'venom') {
                const wasActive = this.status.venom > 1.0;
                this.status.venom = Math.max(this.status.venom, duration);

                if (!wasActive) {
                    console.log(`${this.role} poisoned!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("POISON", this.mesh.position, "status");
                }
            } else if (type === 'nap') {
                const wasActive = this.status.nap > 1.0;
                this.status.nap = Math.max(this.status.nap, duration);

                if (!wasActive) {
                    if (this.hasBall) this.fumble();
                    console.log(`${this.role} fell asleep!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("SLEEP", this.mesh.position, "status");
                }
            } else if (type === 'wither' && subType) {
                const currentVal = this.status.wither[subType] || 0;
                const wasActive = currentVal > 1.0;
                this.status.wither[subType] = Math.max(currentVal, duration);

                if (!wasActive) {
                    console.log(`${this.role} withered ${subType}!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn(`WITHER ${subType}`, this.mesh.position, "status");

                }
            } else if (type === 'blind') {
                this.status.blind = Math.max(this.status.blind, duration);
                    window.flux.gameInstance.floatingText.spawn("BLIND", this.mesh.position, "status");
            } else if (type === 'silence') {
                this.status.silence = Math.max(this.status.silence, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCE", this.mesh.position, "status");
            } else if (type === 'shield') {
                this.status.shield = Math.max(this.status.shield, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SHIELD", this.mesh.position, "heal");
            } else if (type === 'haste') {
                this.status.haste = Math.max(this.status.haste, duration);
                this.status.slow = 0; // Overwrite slow
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("HASTE", this.mesh.position, "heal");
            } else if (type === 'slow') {
                this.status.slow = Math.max(this.status.slow, duration);
                this.status.haste = 0; // Overwrite haste
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SLOW", this.mesh.position, "status");

            }
        }

_updateDerivedStats() {
            const sp = this.getStat('SP');
            this.maxSpeed = 5.0 + (sp / 15.0);
            this.currentEN = this.getStat('EN');
        }

        setMesh(sourceMesh, animations) {
            this.mesh = sourceMesh;
            this.scene.add(this.mesh);
            this._createHPBar();
            this._createAura();
            this._createPassTargetIndicator();

            // Custom Character Scaling
            if (this.characterName) {
                if (this.characterName.includes('Tidus')) this.baseScale = 1.6;
                else if (this.characterName.includes('Wakka')) this.baseScale = 1.4;
            }

            this.mesh.scale.setScalar(this.baseScale);

            this.mesh.traverse((node) => {
                if (node.isMesh && node.material) {
                    const convertOne = (mat) => {
                        const m = new THREE.MeshBasicMaterial({
                            map: mat.map || null,
                            color: new THREE.Color(0xffffff), // FORCE WHITE: Ignore source color
                            transparent: !!mat.transparent,
                            opacity: (mat.opacity !== undefined ? mat.opacity : 1),
                            alphaTest: (mat.alphaTest !== undefined ? mat.alphaTest : 0),
                            side: mat.side,
                            depthTest: mat.depthTest,
                            depthWrite: mat.depthWrite,
                            fog: true,
                            skinning: !!node.isSkinnedMesh
                        });
                        this.originalMaterials.push({ material: m, baseColor: m.color.clone() });
                        return m;
                    };
                    node.material = Array.isArray(node.material)
                        ? node.material.map(convertOne)
                        : convertOne(node.material);
                }

                if (node.isBone) {
                    const name = (node.name || '').toLowerCase();

                    // Core spine/head chain (Mixamo-friendly)
                    if (!this.bones.hips && name.includes('hips')) this.bones.hips = node;
                    if (!this.bones.spine && name.includes('spine') && !name.includes('spine2') && !name.includes('spine_2')) this.bones.spine = node;
                    if (!this.bones.chest && (name.includes('chest') || name.includes('spine2') || name.includes('spine_2'))) this.bones.chest = node;
                    if (!this.bones.neck && name.includes('neck')) this.bones.neck = node;
                    if (!this.bones.head && name.includes('head')) this.bones.head = node;

                    const isRight = name.includes('right') || name.endsWith('r') || name.includes('_r') || name.includes('.r');
                    const isLeft  = name.includes('left')  || name.endsWith('l') || name.includes('_l') || name.includes('.l');

                    // Arms/hands (Mixamo: mixamorigRightArm/RightForeArm/RightHand)
                    if (!this.bones.rUpperArm && (name.includes('rightarm') || (isRight && name.includes('upperarm')))) this.bones.rUpperArm = node;
                    if (!this.bones.rForeArm && (name.includes('rightforearm') || (isRight && name.includes('forearm')))) this.bones.rForeArm = node;
                    if (!this.bones.rHand && ((name.includes('hand') && isRight) || name.includes('righthand'))) this.bones.rHand = node;

                    if (!this.bones.lUpperArm && (name.includes('leftarm') || (isLeft && name.includes('upperarm')))) this.bones.lUpperArm = node;
                    if (!this.bones.lForeArm && (name.includes('leftforearm') || (isLeft && name.includes('forearm')))) this.bones.lForeArm = node;
                    if (!this.bones.lHand && ((name.includes('hand') && isLeft) || name.includes('lefthand'))) this.bones.lHand = node;

                    // Back-compat: ball attachment uses handBone
                    if (!this.handBone && this.bones.rHand) this.handBone = this.bones.rHand;
                }
            });

            this.mixer = new THREE.AnimationMixer(this.mesh);

            if (animations) {
                const _normClipName = (s) => (s || '')
                    .toLowerCase()
                    .replace(/[_\-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Helper to strip leg tracks from action clips
                const _stripLegs = (clip) => {
                    const tracks = [];
                    clip.tracks.forEach(t => {
                        // Regex to match leg bones (Mixamo style: RightUpLeg, RightLeg, RightFoot, RightToeBase)
                        // Also generic "Leg", "Foot"
                        if (!t.name.match(/(UpLeg|Leg|Foot|Toe)/i)) {
                            tracks.push(t);
                        }
                    });
                    clip.tracks = tracks;
                    return clip;
                };

                animations.forEach((clip) => {
                    const name = _normClipName(clip.name);
                    const has = (re) => re.test(name);
                    
                    let isLocomotion = false;
                    let actionKey = null;

                    // --- Core locomotion ---
                    if (has(/tread|treading|idle|float/)) {
                        actionKey = 'idle';
                        isLocomotion = true;
                    } else if (has(/dash|sprint|burst|fast\s*swim|swim\s*fast/)) {
                        actionKey = 'dash';
                        isLocomotion = true;
                    } else if (has(/swim|freestyle|crawl/)) {
                        actionKey = 'swim';
                        isLocomotion = true;
                    
                    // --- Throwing (pass/shot variants if present) ---
                    } else if (has(/throw|toss|pitch/)) {
                        if (has(/shoot|shot|goal/)) actionKey = 'throw_shot';
                        else if (has(/pass/)) actionKey = 'throw_pass';
                        else actionKey = 'throw';

                    // --- Catching (jump/air variants if present) ---
                    } else if (has(/catch|receive|grab|intercept/)) {
                        if (has(/jump|leap|air|dive/)) actionKey = 'catch_jump';
                        else actionKey = 'catch';

                    // --- Hit / React ---
                    } else if (has(/react|hit|hurt|damage|stagger|knock/)) {
                        actionKey = 'react';

                    // --- Optional states ---
                    } else if (has(/charge|aim|ready|windup|hold/)) {
                        actionKey = 'charge';
                    } else if (has(/tackle|check|ram/)) {
                        actionKey = 'tackle';
                    } else if (has(/block|save/)) {
                        actionKey = 'block';
                    } else if (has(/celebrate|victory|cheer/)) {
                        actionKey = 'celebrate';
                    } else {
                        actionKey = clip.name;
                    }

                    // Strip legs from non-locomotion clips to allow treading water overlay
                    if (!isLocomotion && actionKey) {
                        _stripLegs(clip);
                    }

                    if (actionKey) {
                        this.actions[actionKey] = this.mixer.clipAction(clip);
                    }
                });
            }

            // Start default locomotion
            if (this.actions['idle']) {
                this.playLocomotion('idle');
            } else {
                // Fallback
                const first = Object.values(this.actions)[0];
                if(first) first.play();
            }

            // One-shot animation listener
            if (this.mixer) {
                this.mixer.addEventListener('finished', (e) => {
                    if (!this._animLocked) return;
                    if (!e || !e.action) return;
                    
                    // Check if the finished action is our current one-shot
                    if (e.action === this.activeOneShot) {
                        this._animLocked = false;
                        this._lockedState = null;
                        this.activeOneShot = null;

                        // Return to locomotion updates
                        if (!this.isThrowing) {
                            this._updateLocomotionAnim(0.15);
                        }
                    }
                });
            }
        }

        // New method for base layer (legs/body movement)
        playLocomotion(actionName, duration = 0.5) {
            const newAction = this.actions[actionName];
            if (!newAction || newAction === this.activeLocomotion) return;

            if (this.activeLocomotion) {
                this.activeLocomotion.fadeOut(duration);
            }

            newAction.reset();
            newAction.fadeIn(duration);
            newAction.play();
            this.activeLocomotion = newAction;
            this._lastLocomotion = actionName;
        }

        // Overhauled play method to handle layering
        play(actionName, duration = 0.5) {
            // If it's a locomotion state, route to playLocomotion
            if (['idle', 'swim', 'dash'].includes(actionName)) {
                this.playLocomotion(actionName, duration);
                return;
            }

            // Otherwise treat as an action layer
            const newAction = this.actions[actionName];
            if (!newAction) return;

            // If we have an active one-shot, fade it out
            if (this.activeOneShot && this.activeOneShot !== newAction) {
                this.activeOneShot.fadeOut(0.1);
            }

            newAction.reset();
            newAction.fadeIn(0.1); // Fast transition for actions
            newAction.play();
            
            this.activeOneShot = newAction;
            this.state = actionName;
        }

        _updateLocomotionAnim(duration = 0.2) {
            // Note: We NO LONGER check _animLocked here.
            // Locomotion should update continuously based on speed, 
            // running underneath the upper body action.
            
            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;
            const speed = Math.sqrt(vx * vx + vz * vz);

            // Smooth speed
            const smoothK = 1.0 - Math.pow(0.001, duration);
            this._smoothedSpeed += (speed - this._smoothedSpeed) * smoothK;

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;

            // Hysteresis
            const enterMove = 0.18;
            const exitMove = 0.10;

            const inputMoving = this.inputVector && this.inputVector.lengthSq() > 0.06;
            const velMoving = this._smoothedSpeed > (this._movingLatch ? exitMove : enterMove);

            this._movingLatch = inputMoving || velMoving;

            let target = this._movingLatch ? 'swim' : 'idle';
            if (this._movingLatch && this.isDashing && this.actions['dash']) target = 'dash';

            // Update playback rate
            const applyRate = (key) => {
                const a = this.actions[key];
                if (!a) return;
if (key === 'swim') a.timeScale = THREE.MathUtils.lerp(0.85, 1.70, speedNorm);
                else if (key === 'dash') a.timeScale = THREE.MathUtils.lerp(1.10, 2.20, speedNorm);
                else if (key === 'idle') a.timeScale = THREE.MathUtils.lerp(0.95, 1.05, speedNorm);

                // Haste/Slow Animation Scaling
                if (this.status.haste > 0) a.timeScale *= 1.5;
                if (this.status.slow > 0) a.timeScale *= 0.6;
};

applyRate(target);

            if (this._lastLocomotion !== target) {
                const a = this.actions[target];
                if (a) {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                }
                this.playLocomotion(target, duration);
            }
        }

        playOneShot(actionName, duration = 0.1, opts = {}) {
            const a = this.actions[actionName];
            if (!a) return false;

            this._animLocked = true;
            this._lockedState = actionName;

            try {
                a.reset();
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.timeScale = (opts.timeScale !== undefined ? opts.timeScale : 1.0);
            } catch (_) {}

            // Use the new play method which handles layering
            this.play(actionName, duration);
            return true;
        }

        setInput(x, z) {
            if (this.status.nap > 0) {
                this.inputVector.set(0, 0, 0);
                return;
            }
            this.inputVector.set(x, 0, z);
        }

        receiveBall() {
            this.canCatch = false;
            
            // CRITICAL FIX: Reset states that might prevent shooting
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();

            if (this.status.nap > 0) {
                this.status.nap = 0;
            }

            this.hasBall = true;
            this.immunityTimer = 2.0;

const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            
            if (ball && ball.lastHolder && ball.lastHolder !== this) {
                ball.lastHolder.gainExp(2);
                this.gainExp(1);
            }

            const ballY = (this.ballRef && this.ballRef.mesh) ? this.ballRef.mesh.position.y : 0;
            const catchKey = (ballY > 0.25 && this.actions['catch_jump']) ? 'catch_jump' : 'catch';

            this.playOneShot(catchKey, 0.1);
            
            // JUICE: Catch Squash
            this.squash(1.1, 0.9, 1.1); // Slight compression on catch

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch');
            }

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SNAP!", this.mesh.position, "comic-action");
            }
        }

        throwBall(ball, forcedType = null, powerMultiplier = 1.0, forcedSpin = null) {
            if (!this.hasBall || this.isThrowing) return;
            if (this.status.nap > 0) return;

            this.isThrowing = true;

            // Lock aim direction at start of throw
            this.lockedAimVector = new THREE.Vector3();

            if (this.inputVector.lengthSq() > 0.1) {
                this.lockedAimVector.copy(this.inputVector).normalize();
            } else {
                this.lockedAimVector.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
            }

const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            let type = forcedType;
            if (!type) {
                type = (distToGoal < 25) ? 'SH' : 'PA';
            }

            const isFinisher = (type === 'SH' && distToGoal < 12.0);

            let techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;

if ((this.status.venom > 0 || this.status.silence > 0) && techName) {
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCED", this.mesh.position, "status");
                techName = null;
            }

            let windupTime = 100;
            let animSpeed = 1.5;

            if (powerMultiplier > 1.1) {
                windupTime += 200;
            }

            if (isFinisher && !techName) {
                windupTime = 50;
                animSpeed = 3.0;
            }

            if (techName) {
                windupTime = 400;
                animSpeed = 0.8;

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.playCinematic(techName, this.mesh, 1.2);
                }

                this.immunityTimer = 1.5;

                if (window.flux.gameInstance.floatingText) {
                    const label = techName.replace('_', ' ').toUpperCase();
                    window.flux.gameInstance.floatingText.spawn(label, this.mesh.position, "tech");
                }

                // NEW: Spawn Tech Glyph (Vertical Casting Circle)
                if (window.flux.gameInstance.glyphManager) {
                    window.flux.gameInstance.glyphManager.spawn('tech', this.mesh.position, {
                        parent: this,
                        life: 1.2,
                        rotationSpeed: 4.0,
                        scaleSpeed: 1.5,
                        offsetY: 1.2,
                        faceCamera: true
                    });
                }
            }

            // Pick best throw clip (pass/shot variants if present)
            const throwKey =
                (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' :
                (type === 'PA' && this.actions['throw_pass']) ? 'throw_pass' :
                'throw';

            this.playOneShot(throwKey, 0.1, { timeScale: animSpeed });
            
            // JUICE: Throw Stretch
            this.squash(0.8, 1.2, 0.8); // Stretch on release

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('throw');
            }

            if (window.flux.gameInstance.floatingText && !techName) {
                window.flux.gameInstance.floatingText.spawn("WHOOSH", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                // Safety: If ball holder is still us, proceed. If hasBall is false but holder is us, assume sync lag and proceed.
                if (this.hasBall || (ball && ball.holder === this)) {
                    const throwAction = this.actions[throwKey];
                    if (throwAction) throwAction.timeScale = 1.0;

                    let finalDir = new THREE.Vector3();
                    let referenceDir = new THREE.Vector3();

                    if (this.overrideAimVector) {
                        finalDir.copy(this.overrideAimVector).normalize();
                        referenceDir.copy(finalDir);
                    } else {
                        finalDir.copy(this.lockedAimVector);
                        referenceDir.copy(this.lockedAimVector);
                    }

                    const spin = new THREE.Vector3(0, 0, 0);

                    if (forcedSpin) {
                        spin.copy(forcedSpin);
                    } else if (this.inputVector.lengthSq() > 0.1) {
                        const inputDir = this.inputVector.clone().normalize();
                        const crossY = new THREE.Vector3().crossVectors(referenceDir, inputDir).y;

                        if (Math.abs(crossY) > 0.1) {
                            spin.set(0, crossY * 12.0, 0);
                        }
                    }

                    let baseCost = (type === 'SH') ? 20 : 10;
                    let techCost = 0;
                    let techBonus = 0;
                    let techPayload = null;

                    if (techName) {
                        switch (techName) {
                            case 'venom':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'venom', level: 1 };
                                break;
                            case 'wither':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'wither', level: 1 };
                                break;
                            case 'nap':
                                techCost = (type === 'SH' ? 35 : 30);
                                techBonus = 3;
                                techPayload = { type: 'nap', level: 1 };
                                break;
                            case 'sphere':
                                if (type === 'SH') {
                                    techCost = 25;
                                    const rng = Math.floor(Math.random() * 11) + 5;
                                    techBonus = rng;
                                    techPayload = { type: 'sphere', level: 1, bonus: rng };
                                    if (window.flux.gameInstance.floatingText)
                                        window.flux.gameInstance.floatingText.spawn(`SPHERE +${rng}`, this.mesh.position, "goal");
                                }
                                break;
                            case 'jecht':
                                if (type === 'SH') {
                                    techCost = 40;
                                    techBonus = 5;
                                    techPayload = { type: 'jecht', level: 1 };
                                    this._performJechtKnockback();
                                }
                                break;
                            case 'invisible':
                                if (type === 'SH') {
                                    techCost = 25;
                                    techBonus = 2;
                                    techPayload = { type: 'invisible', level: 1 };
                                }
                                break;
                        }
                    }

                    const totalCost = baseCost + techCost;

                    let powerFactor = 1.0;
                    if (this.stats.HP < totalCost) {
                        powerFactor = 0.5;
                        this.stats.HP = 0;
                        techPayload = null;
                        techBonus = 0;
                        if (window.flux.gameInstance.floatingText)
                            window.flux.gameInstance.floatingText.spawn("TIRED", this.mesh.position, "damage");
                    } else {
                        this.stats.HP -= totalCost;
                    }

                    let statVal = this.getStat(type);
                    statVal += techBonus;
                    statVal *= powerFactor;
                    statVal *= powerMultiplier;

                    const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
                    const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
                    const goalDot = finalDir.dot(goalDir);

                    if (type === 'SH') {
                        const goalPos = new THREE.Vector3(0, 2, goalZ);
                        const toGoal = goalPos.clone().sub(this.mesh.position).normalize();

                        const sh = this.getStat('SH');
                        let assistFactor = Math.min(0.9, Math.max(0.1, sh / 100.0));

                        if (this.overrideAimVector) {
                            assistFactor *= 0.1;
                        }

if (goalDot > 0.2 && this.status.blind <= 0) {
                            finalDir.lerp(toGoal, assistFactor);
                        }

                        if (isFinisher) {
                            finalDir.y += 0.05;
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn("SLAM!", this.mesh.position, "comic-impact");
                            }
                        } else {
                            finalDir.y += 0.25;
                        }
                        
                        // Goalie Loft Bonus (Prevent interception by immediate defender)
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance

                    } else {
                        const target = this._findPassTargetInCone(finalDir);

                        if (target) {
                            const toMate = target.mesh.position.clone().sub(this.mesh.position);
                            if (target.velocity.lengthSq() > 0.1) {
                                toMate.addScaledVector(target.velocity, 0.5);
                            }
                            toMate.normalize();

                            const pa = this.getStat('PA');
                            let assistFactor = Math.min(1.0, 0.3 + (pa / 80.0));

if (this.overrideAimVector) {
                                assistFactor *= 0.1;
                            }
                            
                            // Blind disables assist
                            if (this.status.blind > 0) assistFactor = 0;

                            finalDir.lerp(toMate, assistFactor);
finalDir.lerp(toMate, assistFactor);

                            const dist = this.mesh.position.distanceTo(target.mesh.position);
                            finalDir.y += Math.min(0.6, dist * 0.03);
                        } else {
                            finalDir.y += 0.2;
                        }
                        
                        // Goalie Loft Bonus for Passing
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance
                    }

// Blind Randomization
                    if (this.status.blind > 0) {
                        finalDir.x += (Math.random() - 0.5) * 0.8;
                        finalDir.y += (Math.random() - 0.5) * 0.4;
                        finalDir.z += (Math.random() - 0.5) * 0.8;
                    }

                    finalDir.normalize();

                    if (techPayload && window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, techName);
                    }

                    ball.shoot(finalDir, statVal, type, techPayload, spin);

                    // Camera Recoil
                    if (window.flux.gameInstance.cameraManager) {
                        const recoilForce = (type === 'SH' ? 2.5 : 1.0) * (powerMultiplier || 1.0);
                        window.flux.gameInstance.cameraManager.addRecoil(
                            -finalDir.x * recoilForce, 
                            -finalDir.y * recoilForce * 0.5, 
                            -finalDir.z * recoilForce
                        );
                    }
                    
                    // Extra grace period for Goalie to prevent point-blank interceptions
                    if (this.role === 'GL') {
                        ball.catchGracePeriod = 0.6; // 0.6s immunity (approx 10-12m travel)
                    }

this.loseBall(1.0);
                }
            }, windupTime);

            setTimeout(() => {
                this.isThrowing = false;
                this.overrideAimVector = null;
                this._updateLocomotionAnim(0.2);
            }, windupTime + 500);
        }

        _findPassTargetInCone(aimDir) {
            if (!this.team) return null;

            let bestTarget = null;
            let maxScore = -Infinity;

            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;

                const toMate = mate.mesh.position.clone().sub(this.mesh.position).normalize();
                const dot = aimDir.dot(toMate);

                if (dot > 0.7) {
                    const dist = this.mesh.position.distanceTo(mate.mesh.position);
                    const score = (dot * 10) - (dist * 0.1);

                    if (score > maxScore) {
                        maxScore = score;
                        bestTarget = mate;
                    }
                }
            }
            return bestTarget;
        }

        startCharge() {
            if (!this.hasBall || this.isThrowing || this.status.nap > 0) return;
            this.isCharging = true;
            this.chargeTime = 0;

            // Visuals handled in update

            // Show charge UI
            this._updateChargeUI(0);

            // NEW: Spawn Charge Glyph (Ground Ring)
            if (window.flux.gameInstance && window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: this.maxChargeTime,
                    rotationSpeed: 3.0,
                    scaleSpeed: 0.2,
                    offsetY: 0.1
                });
            }
        }

        releaseCharge(dx, dy, curveInput = null) {
            if (!this.isCharging) return;
            this.isCharging = false;

            // Power Calculation
            const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
            const TC = window.flux.ThrowConfig || {};

            // Base multiplier (defaults: 1.0 to 1.8)
            let multiplier = (TC.POWER_BASE !== undefined ? TC.POWER_BASE : 1.0) + (ratio * (TC.POWER_RANGE !== undefined ? TC.POWER_RANGE : 0.8));
            
            // MAX POWER BONUS: If held near max, significant boost
            if (ratio > (TC.POWER_MAX_BONUS_RATIO !== undefined ? TC.POWER_MAX_BONUS_RATIO : 0.95)) {
                multiplier = (TC.POWER_MAX_MULTIPLIER !== undefined ? TC.POWER_MAX_MULTIPLIER : 2.5); // Critical Power
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("MAX POWER!", this.mesh.position, "comic-impact");
                }
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-10);
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            this._hideChargeUI();

            // Aim Vector Calculation
            let aimVec = null;
            const swipeLen = Math.sqrt(dx*dx + dy*dy);

            if (swipeLen > (TC.SWIPE_MIN_PX !== undefined ? TC.SWIPE_MIN_PX : 20)) {
                const camera = window.flux.gameInstance.camera;
                const fwd = new THREE.Vector3();
                const right = new THREE.Vector3();

                if (camera) {
                    camera.getWorldDirection(fwd);
                    fwd.y = 0;
                    if (fwd.lengthSq() < 0.001) fwd.set(0, 0, -1);
                    else fwd.normalize();

                    right.crossVectors(fwd, new THREE.Vector3(0, 1, 0)).normalize();

                    const worldVec = new THREE.Vector3();
                    worldVec.addScaledVector(right, dx * (TC.AIM_DX_SCALE !== undefined ? TC.AIM_DX_SCALE : 1.0));
                    worldVec.addScaledVector(fwd, -dy * (TC.AIM_DY_SCALE !== undefined ? TC.AIM_DY_SCALE : 1.0));
                    worldVec.normalize();

                    aimVec = worldVec;
                    this.overrideAimVector = aimVec;
                } else {
                    aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    this.overrideAimVector = null;
                }
            } else {
                aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                this.overrideAimVector = null;
            }

// --- ANALOG CURVE LOGIC ---
            // Detect LOB (Vertical Up Swipe)
// Detect LOB (Vertical Up Swipe)
            let isLob = false;
            /* DISABLED: User feedback indicates accidental triggers preventing forward throws.
            if (dy < -80 && Math.abs(dx) < Math.abs(dy) * 0.6) {
                isLob = true;
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("LOB!", this.mesh.position, "tech");
                }
            }
            */

            // Formula: Curve = Intensity * Speed
            // Formula: Curve = Intensity * Speed
            let spinVec = null;
            
            if ((TC.CURVE_ENABLED !== false) && curveInput && Math.abs(curveInput.intensity) > (TC.CURVE_INTENSITY_THRESHOLD !== undefined ? TC.CURVE_INTENSITY_THRESHOLD : 0.25)) {
                const rawIntensity = Math.abs(curveInput.intensity);
                const sign = Math.sign(curveInput.intensity); // Positive = Right Hump = Left Curve
                const swipeSpeed = curveInput.speed || 1.0;

                // 1. Base Spin from Arc (Herculean Boost)
                let spinMag = rawIntensity * (TC.CURVE_SPIN_SCALE !== undefined ? TC.CURVE_SPIN_SCALE : 1000.0);

                // 2. Speed Bonus (Quickness adds RPM)
                const speedBonus = Math.max(1.0, swipeSpeed * (TC.CURVE_SPEED_MULT !== undefined ? TC.CURVE_SPEED_MULT : 1.5));
                spinMag *= speedBonus;

                // Cap (Increased to 1500 for massive arcs)
                spinMag = Math.min((TC.CURVE_SPIN_CAP !== undefined ? TC.CURVE_SPIN_CAP : 1500.0), spinMag);

                // Apply Spin
                // Right Hump (Positive Intensity) -> Left Curve (Positive Spin Y)
                spinVec = new THREE.Vector3(0, spinMag * sign, 0);
                
                if (spinMag > (TC.CURVE_PERFECT_SPIN !== undefined ? TC.CURVE_PERFECT_SPIN : 500.0) && window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("PERFECT CURVE", this.mesh.position, "tech");
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addShake(0.5);
                        window.flux.gameInstance.cameraManager.addRollImpulse(sign * -0.3); // Tilt camera into the curve
                    }
                }
            }

            // Determine Type (Pass vs Shoot)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
            const dotGoal = aimVec.dot(goalDir);

let type = 'PA';
            if (isLob) {
                type = 'LOB';
            } else {
                const distToGoal = Math.abs(this.mesh.position.z - goalZ);
                if (dotGoal > 0.8 && distToGoal < 35.0) {
                    type = 'SH';
                } else if (dotGoal > 0.5 && distToGoal < 20.0) {
                    type = 'SH';
                }
            }

            // Smart Pass Override
            const targetMate = this._findPassTargetInCone(aimVec);
            if (targetMate && type === 'SH') {
                const distMate = this.mesh.position.distanceTo(targetMate.mesh.position);
                if (distMate < 12.0) type = 'PA';
            }

const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
                this.throwBall(ball, type, multiplier, spinVec);
            }

        // NEW: Charge UI methods
        _updateChargeUI(ratio) {
            const meter = document.getElementById('charge-meter-fill');
            if (meter) {
                meter.style.width = `${ratio * 100}%`;
                if (ratio > 0.9) {
                    meter.style.background = 'linear-gradient(90deg, #ff0, #f80)';
                } else if (ratio > 0.5) {
                    meter.style.background = 'linear-gradient(90deg, #0f0, #ff0)';
                } else {
                    meter.style.background = 'linear-gradient(90deg, #0af, #0f0)';
                }
            }
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'block';
        }

        _hideChargeUI() {
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'none';
        }

        setOverrideAim(x, z) {
            if (!this.overrideAimVector) this.overrideAimVector = new THREE.Vector3();
            this.overrideAimVector.set(x, 0, z).normalize();
        }

loseBall(cooldown = 1.0) {
            this.hasBall = false;
            this._hidePassTargetIndicators();
            
            // Enforce cooldown to prevent instant re-grab
            this.catchCooldown = cooldown;
            this.canCatch = false;

            // Safety: Reset states to prevent locking
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();
        }

        update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

updatePhysics(dt) {
            if (!this.mesh) return;

            // Safety: NaN Check
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                console.warn("Player position NaN detected. Resetting.", this.role);
                this.mesh.position.copy(this.homePosition || new THREE.Vector3());
                this.velocity.set(0, 0, 0);
            }
            // SYNC FIX: If ball thinks I hold it, but I don't, force receive
            if (this.ballRef && this.ballRef.holder === this && !this.hasBall) {
                console.warn("Syncing ball possession to player");
                this.receiveBall();
            }

            if (this.isGodMode) {
                this.stats.HP = this.stats.maxHP;
                this.currentEN = this.getStat('EN');
                this.status.venom = 0;
                this.status.nap = 0;
            }

            this._updateStatusLogic(dt);

            // Charge Logic (Physics part - Timer)
            if (this.isCharging) {
                if (!this.hasBall || this.status.nap > 0 || this.stunTimer > 0) {
                    this.isCharging = false;
                    // Reset physics props that might have been altered
                    // Visual reset happens in updateVisuals
                } else {
                    this.chargeTime += dt;
                    // AUTO-RELEASE: If held too long (3s), force release
                    if (this.chargeTime > 3.0) {
                        this.releaseCharge(0, 0); 
                        return;
                    }
                }
            }

if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            if (this.evadeCooldown > 0) this.evadeCooldown -= dt;

            if (this.catchCooldown > 0) {
                this.catchCooldown -= dt;
                if (this.catchCooldown <= 0) this.canCatch = true;
            }

            // Evasion Logic (Spin Move)
            if (this.isEvading) {
                this.evadeTime -= dt;
                
                // Spin visual handled in updateVisuals, but we apply movement here
                // Frictionless movement during evade
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                
                // Slight drag
                this.velocity.multiplyScalar(0.95);

                if (this.evadeTime <= 0) {
                    this.isEvading = false;
                    this.velocity.multiplyScalar(0.5); // Slow down after spin
                }
                return; // Skip normal physics
            }

// Tackle Charge Logic
            if (this.isTackleCharging) {
                this.tackleChargeTime += dt;
                // Auto-release if held too long
                if (this.tackleChargeTime > this.maxTackleChargeTime + 0.5) {
                    this.releaseTackle();
                    return;
                }
            }

            // --- TACKLE STATE (Slide & Commit) ---
            if (this.isTackling) {
                this.tackleTime -= dt;
                
                // Physics: High Drag (Slide to stop)
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (3.0 * dt))); 
                
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);

                // Collision Check
                this._checkTackleCollision();
                
                if (this._hasHitTackle) {
                    // Successful Hit
                    this.isTackling = false;
                    this.velocity.multiplyScalar(0.1); // Stop momentum
                    this.isRecovering = true;
                    this.recoveryTime = 0.2; // Quick recovery
                } else if (this.tackleTime <= 0) {
                    // Missed Tackle (Whiff)
                    this.isTackling = false;
                    this.isRecovering = true;
                    this.recoveryTime = 1.2; // Punishment (Stumble)
                    this.velocity.multiplyScalar(0.5);
                    this.play('react', 0.2); // Stumble animation
                    
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("MISS", this.mesh.position, "default");
                    }
                }
                return;
            }

            // --- RECOVERY STATE (Stumble/Punishment) ---
            if (this.isRecovering) {
                this.recoveryTime -= dt;
                this.velocity.multiplyScalar(0.9); // Heavy friction
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                
                if (this.recoveryTime <= 0) {
                    this.isRecovering = false;
                    this.play('idle', 0.2);
                }
                return;
            }
            // Dash Logic
            if (this.isDashing) {
                this.dashTime -= dt;
                
                // Smooth Rotation during Dash (Logic affecting transform)
                let diff = this.targetYaw - this.currentYaw;
                while (diff > Math.PI) diff -= Math.PI * 2;
                while (diff < -Math.PI) diff += Math.PI * 2;
                
                const turnSpeed = 15.0; 
                const change = Math.max(-turnSpeed * dt, Math.min(turnSpeed * dt, diff));
                this.currentYaw += change;

                this._checkTackleCollision();
                
if (this.dashTime <= 0) {
                    this.isDashing = false;
                    this.dashType = null;
                    this.tackleChargeBonus = 0; // Reset charge bonus
                } else {
                    if (this.dashType === 'vertical') {
                        _pVec.copy(this.dashVec).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        // Y position calculation is visual/physics hybrid, keeping here for collision consistency
                        const t = 1 - (this.dashTime / this.dashTotalTime);
                        this.mesh.position.y = Math.sin(t * Math.PI) * 3.0;
                    } else {
                        // Horizontal Dash Movement
                        _pVec.copy(this.velocity).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        this.mesh.position.y = 0;

                        // Rotation update
                        _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                        // Visual lean is calculated in updateVisuals, but we set base orientation here
                        this.mesh.quaternion.copy(_pQuat);

                        this.velocity.multiplyScalar(0.96);
                    }
                }
                return;
            }

            // Stun/Nap Check
            if (this.status.nap > 0 || this.stunTimer > 0) {
                const dragFactor = Math.max(0, 1 - (2.0 * dt));
                this.velocity.multiplyScalar(dragFactor);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                return;
            }

            this._checkTacklePressure(dt);

            if (this.isThrowing) {
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (2.0 * dt)));
                this._applySoftCollision(dt);
                this._applyGoalCrease(dt);
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                this._updateVerticality(dt);
                this._updateBanking(dt); 
            } else {
                this._updatePhysics(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt);
            }
        }

        updateVisuals(dt) {
            if (!this.mesh) return;

            if (this.mixer) {
                this.mixer.update(dt);
            }
            
            this._updateLocomotionAnim(dt); // Animation state logic driven by physics state
            this._updateStatusVisuals(dt);

            // Charge Visuals
            if (this.isCharging) {
                if (this.hasBall && this.status.nap <= 0 && this.stunTimer <= 0) {
                    const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
                    
                    // Levitation
                    const hover = (Math.sin(Date.now() * 0.02) * 0.1) + (ratio * 0.8);
                    const shake = 0.05 + (0.1 * ratio);
                    
                    this.mesh.position.y = hover + (Math.random() - 0.5) * shake;
                    
                    // Visual Jitter
                    this.bankingAmount += (Math.random() - 0.5) * shake;
                    this.pitchAmount += (Math.random() - 0.5) * shake;

                    this.mesh.scale.setScalar(this.baseScale);
                    this._updateChargeUI(ratio);
                } else {
                    // Reset visuals if charge cancelled
                    this.mesh.position.y = 0;
                    this.mesh.scale.setScalar(this.baseScale);
                    this._hideChargeUI();
                }
            }

// Dash Visuals (Particles & Lean)
            if (this.isDashing) {
                this._dashParticleTimer -= dt;
                if (this._dashParticleTimer <= 0) {
                    this._dashParticleTimer = 0.01;
                    if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                        const back = this.velocity.clone().normalize().negate();
                        if (back.lengthSq() < 0.1) back.set(0, 0, 1);
                        for(let i=0; i<2; i++) {
                            const pos = this.mesh.position.clone().add(back.multiplyScalar(0.5));
                            pos.y += 1.0 + (Math.random() - 0.5) * 0.5;
                            pos.x += (Math.random() - 0.5) * 0.5;
                            pos.z += (Math.random() - 0.5) * 0.5;
                            window.flux.gameInstance.particleManager.spawn('dash_stream', pos, { scale: 2.0 + Math.random(), emitterVelocity: this.velocity, momentumScale: 0.1 });
                        }
                    }
                }

                // Visual Lean for Dash
                if (this.dashType === 'horizontal' || this.dashType === 'break' || this.dashType === 'sprint') {
                    const t = 1 - (this.dashTime / this.dashTotalTime);
                    const lean = Math.sin(t * Math.PI);
                    
                    _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                    
                    let pitch = 0, yaw = 0, roll = 0, lungeAmt = 0;
                    if (this.dashType !== 'sprint') {
                         pitch = 1.2 * lean; yaw = 0.8 * lean; roll = -0.6 * lean; lungeAmt = 0.8 * lean;
                    } else {
                         pitch = 0.5 * lean; lungeAmt = 0.2 * lean;
                    }

                    if (lungeAmt > 0) {
                         _pVec.set(0, 0, lungeAmt).applyQuaternion(_pQuat);
                         this.mesh.position.add(_pVec);
                    }

                    _pEuler.set(pitch, yaw, roll);
// Duplicate removed
                    _pQuat2.setFromEuler(_pEuler);
                    this.mesh.quaternion.multiplyQuaternions(_pQuat, _pQuat2);
                }
            }
            if (this.isEvading) {
                // Rapid Spin
                this.mesh.rotation.y += 25.0 * dt;
                
                // Trail
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    if (Math.random() < 0.5) {
                        const pm = window.flux.gameInstance.particleManager;
                        const pos = this.mesh.position.clone();
                        pos.y += 1.0;
                        pos.x += (Math.random()-0.5);
                        pos.z += (Math.random()-0.5);
                        pm.spawn('dash_stream', pos, { scale: 1.0, life: 0.2 });
                    }
                }
            }

// Tackle Charge Visuals
            if (this.isTackleCharging) {
                const ratio = Math.min(this.tackleChargeTime / this.maxTackleChargeTime, 1.0);
                // Shake mesh
// Red tint pulse
                const pulse = Math.sin(Date.now() * 0.02) * 0.5 + 0.5;
                this.originalMaterials.forEach(entry => {
                    entry.material.color.lerpColors(entry.baseColor, new THREE.Color(0xff0000), 0.5 * pulse);
                });

                // HERCULEAN: Gather Particles
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    if (Math.random() < 0.3) { // Density
                        const pm = window.flux.gameInstance.particleManager;
                        // Spawn in a sphere around player
                        const r = 2.0;
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.acos(2 * Math.random() - 1);
                        const x = r * Math.sin(phi) * Math.cos(theta);
                        const y = r * Math.sin(phi) * Math.sin(theta);
                        const z = r * Math.cos(phi);
                        
                        const spawnPos = this.mesh.position.clone().add(new THREE.Vector3(x, y + 1.0, z));
                        const centerPos = this.mesh.position.clone().add(new THREE.Vector3(0, 1.0, 0));
                        
                        // Velocity towards center
                        const vel = centerPos.sub(spawnPos).normalize().multiplyScalar(4.0); // Suck in speed
                        
                        pm.spawn('gather', spawnPos, { 
                            velocity: vel, 
                            life: 0.5, 
                            scale: 1.5,
                            color: 0xff0000 
                        });
                    }
                }
            } else if (this.isTackling) {
                // Visual trail for tackle (The Lunge)
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    // High density trail
                    const pm = window.flux.gameInstance.particleManager;
                    const pos = this.mesh.position.clone();
                    pos.y += 0.8;
                    // Offset slightly behind
                    const back = this.velocity.clone().normalize().negate().multiplyScalar(0.5);
                    pos.add(back);
                    
                    pm.spawn('dash_stream', pos, { 
                        scale: 2.5, 
                        life: 0.3,
                        color: 0xff4400 // Fiery orange trail
                    });
                    
                    // Side streams
                    for(let i=0; i<2; i++) {
                        const sidePos = pos.clone();
                        sidePos.x += (Math.random()-0.5) * 1.5;
                        sidePos.y += (Math.random()-0.5) * 1.0;
                        sidePos.z += (Math.random()-0.5) * 1.5;
                        pm.spawn('dash_stream', sidePos, { 
                            scale: 1.5, 
                            life: 0.2,
                            color: 0xffaa00
                        });
                    }
                }
            } else if (this.isBlocking) {
            } else if (this.isTackling) {
                // Visual trail for tackle
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    if (Math.random() < 0.3) {
                        const pm = window.flux.gameInstance.particleManager;
                        const pos = this.mesh.position.clone();
                        pos.y += 0.5;
                        pm.spawn('dash_stream', pos, { scale: 1.5, life: 0.2 });
                    }
                }
            } else if (this.isBlocking) {
                const pulse = Math.sin(Date.now() * 0.01) * 0.3 + 0.7;
                this.originalMaterials.forEach(entry => {
                    entry.material.color.lerpColors(entry.baseColor, new THREE.Color(0x00ffff), 0.5 * pulse);
                });
            } else {
                 // Reset color if not charging/dashing/flashing/blocking
                 this.originalMaterials.forEach(entry => {
                    entry.material.color.copy(entry.baseColor);
                });
            }

            // Stun/Nap Visual Reset
            if (this.status.nap > 0 || this.stunTimer > 0) {
                if (!this._animLocked && this.state !== 'idle' && this.state !== 'catch') this.play('idle', 0.5);
            }

            this._updateHPBar(dt);
            this._updatePassTargetIndicators();

            // Bubble Trail
            const speedSq = this.velocity.lengthSq();
            if (speedSq > 1.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                this._bubbleTimer -= dt;
                if (this._bubbleTimer <= 0) {
                    const pm = window.flux.gameInstance.particleManager;
                    const backDir = this.velocity.clone().normalize().negate();
                    
                    const offset = backDir.clone().multiplyScalar(0.8);
                    offset.y = 0.5 + Math.random() * 0.5; 
                    offset.x += (Math.random()-0.5) * 0.5;
                    offset.z += (Math.random()-0.5) * 0.5;
                    pm.spawn('bubble', this.mesh.position.clone().add(offset), { 
                        scale: 0.15 + Math.random() * 0.25,
                        emitterVelocity: this.velocity,
                        momentumScale: 0.2
                    });

                    if (speedSq > 40.0) {
                        for(let i=0; i<3; i++) {
                            const mOffset = backDir.clone().multiplyScalar(0.5 + Math.random()*0.5);
                            mOffset.x += (Math.random()-0.5)*0.8;
                            mOffset.y = 0.5 + (Math.random()-0.5)*0.8; 
                            mOffset.z += (Math.random()-0.5)*0.8;
                            pm.spawn('bubble_micro', this.mesh.position.clone().add(mOffset), { 
                                scale: 0.06 + Math.random()*0.08,
                                emitterVelocity: this.velocity,
                                momentumScale: 0.3
                            });
                        }
                        this._bubbleTimer = 0.03; 
                    } else {
                        this._bubbleTimer = 0.1; 
                    }
                }
            }

            this._applyProceduralPose(dt);
        }

        _applyProceduralPose(dt) {
            // Advance local time (used for subtle sways)
            this._procAnimTime += dt;

            const b = this.bones;
            if (!b) return;

            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;

            let shouldApply = false;

            // Build a desired world-space direction we want the torso/head to bias toward.
            // NOTE: We apply this AFTER the animation mixer has posed bones, as a small additive offset.
            _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();

            if (this.hasBall) {
                // Aim direction (prefer explicit aim vector)
                if (this.overrideAimVector) {
                    _pVec.copy(this.overrideAimVector).normalize();
                } else if (this.lockedAimVector) {
                    _pVec.copy(this.lockedAimVector).normalize();
                } else if (this.inputVector && this.inputVector.lengthSq() > 0.08) {
                    _pVec.copy(this.inputVector).normalize();
                } else {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                }
                shouldApply = true;
            } else if (ball && ball.mesh) {
                // Look at the ball if it's in the "awareness" radius
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 20.0) {
                    _pVec.subVectors(ball.mesh.position, this.mesh.position);
                    shouldApply = true;
                }
            }

            if (!shouldApply) return;

            // Convert the direction into the player's local space so yaw/pitch are stable.
            _pInvQuat.copy(this.mesh.quaternion).invert();
            _pVec.applyQuaternion(_pInvQuat).normalize();

            const lx = _pVec.x, ly = _pVec.y, lz = _pVec.z;
            const yaw = Math.atan2(lx, lz);
            const pitch = Math.atan2(ly, Math.sqrt(lx * lx + lz * lz) + 1e-6);

            const yawC = THREE.MathUtils.clamp(yaw, -0.9, 0.9);
            const pitchC = THREE.MathUtils.clamp(pitch, -0.6, 0.6);

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;
            const aimW = (this.hasBall ? (this.isCharging ? 1.0 : 0.65) : 0.35) * (1.0 - 0.35 * speedNorm);
            const headW = (this.hasBall ? 0.55 : 0.75) * (1.0 - 0.25 * speedNorm);

            // Torso bias (spine/chest)
            if (b.chest) {
                _pTmpEuler.set(-pitchC * 0.20 * aimW, yawC * 0.35 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.chest.quaternion.multiply(_pTmpQuat);
            } else if (b.spine) {
                _pTmpEuler.set(-pitchC * 0.15 * aimW, yawC * 0.25 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.spine.quaternion.multiply(_pTmpQuat);
            }

            // Head/neck look
            if (b.neck) {
                _pTmpEuler.set(-pitchC * 0.25 * headW, yawC * 0.45 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.neck.quaternion.multiply(_pTmpQuat);
            }
            if (b.head) {
                _pTmpEuler.set(-pitchC * 0.30 * headW, yawC * 0.55 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.head.quaternion.multiply(_pTmpQuat);
            }

            // Ball-hold / aim arm pose (keeps "swim" animation but reads as holding/aiming)
            if (this.hasBall && !this.isThrowing && !this._animLocked) {
                const t = this._procAnimTime;
                const lift = THREE.MathUtils.clamp(0.35 + (this.isCharging ? 0.55 : 0.25) - speedNorm * 0.2, 0.15, 0.95);
                const sway = Math.sin(t * 5.0) * 0.05 * (0.5 + lift);

                const raiseX = -0.55 * lift + sway;
                const raiseZ = -0.25 * lift;

                if (b.rUpperArm) {
                    _pTmpEuler.set(raiseX, yawC * 0.10 * lift, raiseZ);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rUpperArm.quaternion.multiply(_pTmpQuat);
                }
                if (b.rForeArm) {
                    _pTmpEuler.set(-0.35 * lift + sway * 0.5, 0, 0);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rForeArm.quaternion.multiply(_pTmpQuat);
                }

                // Counterbalance left arm slightly for a more dynamic silhouette
                if (b.lUpperArm) {
                    _pTmpEuler.set(0.15 * lift, -yawC * 0.05 * lift, 0.15 * lift);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.lUpperArm.quaternion.multiply(_pTmpQuat);
                }
            }
        }

        _updateStatus(dt) {
            this._updateStatusLogic(dt);
            this._updateStatusVisuals(dt);
        }

        _updateStatusLogic(dt) {
            if (this.status.venom > 0) {
                this.status.venom -= dt;
                this.stats.HP -= 5 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            } else {
                if (!this.hasBall && this.stats.HP < this.stats.maxHP) {
                    this.stats.HP += 5 * dt;
                    if (this.stats.HP > this.stats.maxHP) this.stats.HP = this.stats.maxHP;
                }
            }

            if (this.hasBall) {
                this.stats.HP -= 2.0 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            }

            if (this.status.nap > 0) {
                this.status.nap -= dt;
            }

            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) {
                    this.status.wither[key] -= dt;
                }
}

            if (this.status.blind > 0) this.status.blind -= dt;
            if (this.status.silence > 0) this.status.silence -= dt;
            if (this.status.shield > 0) this.status.shield -= dt;
            if (this.status.haste > 0) this.status.haste -= dt;
            if (this.status.slow > 0) this.status.slow -= dt;
}

        _updateStatusVisuals(dt) {
            const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;

            if (this.status.venom > 0) {
                this._particleTimers.venom -= dt;
                if (this._particleTimers.venom <= 0 && pm) {
                    pm.spawn('venom', this.mesh.position);
                    this._particleTimers.venom = 0.15;
                }
            }

            if (this.status.nap > 0) {
                this._particleTimers.nap -= dt;
                if (this._particleTimers.nap <= 0 && pm) {
                    pm.spawn('nap', this.mesh.position);
                    this._particleTimers.nap = 0.8;
                }
            }

            let isWithering = false;
            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) isWithering = true;
            }

            if (isWithering) {
                this._particleTimers.wither -= dt;
                if (this._particleTimers.wither <= 0 && pm) {
                    pm.spawn('wither', this.mesh.position);
                    this._particleTimers.wither = 0.2;
                }
}

                if (this.status.blind > 0) {
                    pm.spawn('blind', this.mesh.position);
                    this._particleTimers.blind = 0.3;
                }

                if (this.status.silence > 0) {
                if (this._particleTimers.silence <= 0 && pm) {
                    pm.spawn('silence', this.mesh.position);
                    this._particleTimers.silence = 0.5;
                }
            }
if (this.status.shield > 0) {
                this._particleTimers.shield = (this._particleTimers.shield || 0) - dt;
                if (this._particleTimers.shield <= 0 && pm) {
                    pm.spawn('shield', this.mesh.position);
                    this._particleTimers.shield = 0.4;
                }
            }
            if (this.status.haste > 0) {
                this._particleTimers.haste = (this._particleTimers.haste || 0) - dt;
                if (this._particleTimers.haste <= 0 && pm) {
                    pm.spawn('haste', this.mesh.position);
                    this._particleTimers.haste = 0.2;
                }
            }
            if (this.status.slow > 0) {
                this._particleTimers.slow = (this._particleTimers.slow || 0) - dt;
                if (this._particleTimers.slow <= 0 && pm) {
                    pm.spawn('slow', this.mesh.position);
                    this._particleTimers.slow = 0.4;
                }
            }

            this._updateVisuals(dt);
        }

        _updateVisuals(dt) {
            // --- 1. FLASH EFFECT ---
            let flashRatio = 0;
            if (this.flashTimer > 0) {
                // Use passed dt if available, otherwise assume 16ms (safety)
                const delta = dt || 0.016;
                this.flashTimer -= delta;
                flashRatio = Math.max(0, this.flashTimer / this.flashDuration);
            }

            this.originalMaterials.forEach(entry => {
                if (flashRatio > 0) {
                    // Lerp towards flash color
                    entry.material.color.lerpColors(entry.baseColor, this.flashColor, flashRatio);
                } else {
                    entry.material.color.copy(entry.baseColor);
                }
            });

            // --- 2. PROCEDURAL SQUASH & STRETCH (Spring Physics) ---
            if (this.mesh) {
                const delta = dt || 0.016;
                const stiffness = 200.0;
                const damping = 15.0;
                const target = 1.0;

                // X Axis
                const forceX = (target - this.currentSquash.x) * stiffness;
                this.squashVelocity.x += forceX * delta;
                this.squashVelocity.x *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.x += this.squashVelocity.x * delta;

                // Y Axis
                const forceY = (target - this.currentSquash.y) * stiffness;
                this.squashVelocity.y += forceY * delta;
                this.squashVelocity.y *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.y += this.squashVelocity.y * delta;

                // Z Axis
                const forceZ = (target - this.currentSquash.z) * stiffness;
                this.squashVelocity.z += forceZ * delta;
                this.squashVelocity.z *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.z += this.squashVelocity.z * delta;

                // Apply to Mesh Scale (Multiplicative with baseScale)
                this.mesh.scale.set(
                    this.baseScale * this.currentSquash.x,
                    this.baseScale * this.currentSquash.y,
                    this.baseScale * this.currentSquash.z
                );
            }
        }

        flash(colorHex, duration) {
            this.flashColor.setHex(colorHex);
            this.flashDuration = duration;
            this.flashTimer = duration;
        }

        squash(x, y, z) {
            this.currentSquash.set(x, y, z);
            // Reset velocity for snap feel
            this.squashVelocity.set(0, 0, 0);
        }

        _createAura() {
            // Aura removed per user request
            this.auraMesh = null;
        }

        // NEW: Pass target indicator (Enhanced Reticle)
        _createPassTargetIndicator() {
            this.passTargetIndicator = new THREE.Group();
            this.scene.add(this.passTargetIndicator);
            this.passTargetIndicator.visible = false;

            // 1. Ground Reticle (Rotating)
            const mat = new THREE.MeshBasicMaterial({
                map: _reticleTexture,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                color: 0x00ff00 // Green for pass
            });
            const geo = new THREE.PlaneGeometry(3.0, 3.0);
            this.reticleMesh = new THREE.Mesh(geo, mat);
            this.reticleMesh.rotation.x = -Math.PI / 2;
            this.passTargetIndicator.add(this.reticleMesh);

            // 2. Vertical Pillar (Light Shaft)
            const pillarGeo = new THREE.CylinderGeometry(1.0, 1.0, 6, 16, 1, true);
            const pillarMat = new THREE.MeshBasicMaterial({
                color: 0x44ff44,
                transparent: true,
                opacity: 0.15,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            this.reticlePillar = new THREE.Mesh(pillarGeo, pillarMat);
            this.reticlePillar.position.y = 3.0;
            this.passTargetIndicator.add(this.reticlePillar);
            
            // 3. Floating Icon (Above Head)
            const iconGeo = new THREE.PlaneGeometry(1.0, 1.0);
            this.reticleIcon = new THREE.Mesh(iconGeo, mat); // Reuse texture
            this.reticleIcon.position.y = 4.5;
            // Billboard behavior handled in update
            this.passTargetIndicator.add(this.reticleIcon);
        }

        _updatePassTargetIndicators() {
            if (!this.hasBall || !this.team) {
                this._hidePassTargetIndicators();
                return;
            }

            // Find best pass target
            const aimDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const target = this._findPassTargetInCone(aimDir);

            if (target && target.mesh) {
                // Smoothly move to target
                const dest = target.mesh.position;
                
                if (this.passTargetIndicator) {
                    this.passTargetIndicator.visible = true;
                    
                    // If distance is large (switched target), snap. Else lerp.
                    const dist = this.passTargetIndicator.position.distanceTo(dest);
                    if (dist > 5.0) {
                        this.passTargetIndicator.position.copy(dest);
                    } else {
                        this.passTargetIndicator.position.lerp(dest, 0.3);
                    }
                    
                    // Keep Y at ground level
                    this.passTargetIndicator.position.y = 0.05;

                    // Animation
                    const time = Date.now() * 0.001;
                    
                    // Spin ground reticle
                    if (this.reticleMesh) {
                        this.reticleMesh.rotation.z = -time * 2.0;
                        const s = 1.0 + Math.sin(time * 5.0) * 0.1;
                        this.reticleMesh.scale.set(s, s, s);
                    }
                    
                    // Pulse pillar
                    if (this.reticlePillar) {
                        this.reticlePillar.material.opacity = 0.1 + Math.sin(time * 8.0) * 0.05;
                        this.reticlePillar.rotation.y = time;
                    }

                    // Billboard Icon
                    if (this.reticleIcon) {
                        if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                            this.reticleIcon.lookAt(window.flux.gameInstance.camera.position);
                        }
                        this.reticleIcon.rotation.z = time * 3.0; // Spin icon
                    }
                }
            } else {
                this._hidePassTargetIndicators();
            }
        }

        _hidePassTargetIndicators() {
            if (this.passTargetIndicator) {
                this.passTargetIndicator.visible = false;
            }
        }

_applySoftCollision(dt) {
            const game = window.flux.gameInstance;
            if (!this.mesh || !game || !game.teams) return;

            const teams = [game.teams.home, game.teams.away];
            const repulsionRadius = 0.5; // Reduced to 0.5 to fix invisible wall issues
            const stiffness = 15.0;

            teams.forEach(team => {
                if (!team) return;
                team.players.forEach(other => {
                    if (other === this || !other.mesh) return;

                    const dx = this.mesh.position.x - other.mesh.position.x;
                    const dy = this.mesh.position.y - other.mesh.position.y;
                    const dz = this.mesh.position.z - other.mesh.position.z;

                    const distSq = dx*dx + dy*dy + dz*dz;
                    const minDist = repulsionRadius * 2.0;

                    if (distSq < minDist * minDist && distSq > 0.0001) {
                        const dist = Math.sqrt(distSq);
                        const overlap = minDist - dist;

                        const force = overlap * stiffness;

                        const nx = dx / dist;
                        const ny = dy / dist;
                        const nz = dz / dist;

                        this.velocity.x += nx * force * dt;
                        this.velocity.y += ny * force * dt;
                        this.velocity.z += nz * force * dt;
                    }
                });
            });
        }

        _updatePhysics(dt) {
            this._applySoftCollision(dt);
            this._applyGoalCrease(dt);

            const inputLenSq = this.inputVector.lengthSq();
            const isInputActive = inputLenSq > 0.01;

            let currentMaxSpeed = this.maxSpeed;
            
            // STRUGGLE STATE: Hinder movement based on pressure
            // Instead of a binary 0.8 multiplier, we scale based on intensity.
            // Max struggle (1.0) reduces speed to 40%.
            if (this.struggleIntensity > 0) {
                currentMaxSpeed *= (1.0 - (this.struggleIntensity * 0.6));
            } else if (this.isEngaged) {
                // Fallback slight reduction if engaged but low pressure
                currentMaxSpeed *= 0.9;
            }
            
if (this.isCharging || this.isTackleCharging || this.isBlocking) currentMaxSpeed *= 0.4; // Slow down when charging/blocking
            
            // Haste / Slow
            if (this.status.haste > 0) currentMaxSpeed *= 1.5;
            if (this.status.slow > 0) currentMaxSpeed *= 0.5;

            if (isInputActive) {
                _pVec.copy(this.inputVector).normalize();

                // Apply Struggle Jitter to direction
                // Simulates wrestling for control
                if (this.struggleIntensity > 0.3) {
                    const jitter = (Math.random() - 0.5) * this.struggleIntensity * 0.8;
                    _pVec.x += jitter;
                    _pVec.z += jitter;
                    _pVec.normalize();
                }

                const targetVelX = _pVec.x * currentMaxSpeed;
                const targetVelZ = _pVec.z * currentMaxSpeed;

                const currentSpeed = this.velocity.length();
                const speedRatio = Math.min(1.0, currentSpeed / this.maxSpeed);

                // Agility is reduced when struggling
                let agility = THREE.MathUtils.lerp(10.0, 2.0, speedRatio);
                if (this.struggleIntensity > 0) agility *= 0.5;

                const t = 1.0 - Math.pow(0.01, dt * agility);

                this.velocity.x += (targetVelX - this.velocity.x) * t;
                this.velocity.z += (targetVelZ - this.velocity.z) * t;

            } else {
                const brakeFactor = 2.0;
                const t = 1.0 - Math.pow(0.1, dt * brakeFactor);

                this.velocity.x += (0 - this.velocity.x) * t;
                this.velocity.z += (0 - this.velocity.z) * t;

                if (this.velocity.lengthSq() < 0.01) {
                    this.velocity.set(0, this.velocity.y, 0);
                }
            }

            this.velocity.y *= Math.max(0, 1.0 - (2.0 * dt));

            _pVec.copy(this.velocity).multiplyScalar(dt);
            this.mesh.position.add(_pVec);
        }

_updateVerticality(dt) {
            let targetY = 0;

            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            if (ball && ball.mesh && !this.hasBall) {
                const distToBall = this.mesh.position.distanceTo(ball.mesh.position);
                if (distToBall < 15.0) {
                    targetY = ball.mesh.position.y;
                }
            }

            if (this.hasBall) {
                targetY = 0.5;
            }

            const yDiff = targetY - this.mesh.position.y;

            const lift = yDiff * 10.0 * dt;
            this.velocity.y += lift;

            if (this.mesh.position.y > 8.0) {
                this.mesh.position.y = 8.0;
                this.velocity.y *= -0.5;
            } else if (this.mesh.position.y < -8.0) {
                this.mesh.position.y = -8.0;
                this.velocity.y *= -0.5;
            }
        }

        // FIXED: Improved banking with hysteresis to prevent facing flips
        _updateBanking(dt) {
            const inputLenSq = this.inputVector.lengthSq();
            const velLenSq = this.velocity.lengthSq();

            let targetYaw = this.targetYaw;
            let shouldUpdateYaw = false;

            // PRIORITY 1: Explicit Aim (Aim Stick / Swipe)
            if (this.overrideAimVector) {
                targetYaw = Math.atan2(this.overrideAimVector.x, this.overrideAimVector.z);
                shouldUpdateYaw = true;
            }
            // PRIORITY 2: Movement Input
            else if (inputLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.inputVector.x, this.inputVector.z);
                shouldUpdateYaw = true;
            } 
            // PRIORITY 3: Velocity (Drifting)
            else if (velLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.velocity.x, this.velocity.z);
                shouldUpdateYaw = true;
            }

            // If we should update, do so. Otherwise keep last valid yaw
            if (shouldUpdateYaw) {
                this.lastValidYaw = targetYaw;
            } else {
                targetYaw = this.lastValidYaw;
            }

            // Smooth Yaw with wrap-around handling
            let diff = targetYaw - this.currentYaw;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;

            const speedRatio = Math.min(1.0, this.velocity.length() / this.maxSpeed);
            const turnSpeed = THREE.MathUtils.lerp(8.0, 4.0, speedRatio); // Reduced from 12.0/6.0 to reduce flipping

            // Prevent sudden snaps when diff is very large (teleport/reset scenarios)
            const maxYawChange = Math.PI * dt * turnSpeed;
            const yawChange = Math.max(-maxYawChange, Math.min(maxYawChange, diff * dt * turnSpeed));

            this.currentYaw += yawChange;
            this.targetYaw = targetYaw;

            // Banking
            const bankSensitivity = 0.8;
            const maxBank = 0.75;

            let targetBank = -diff * bankSensitivity;
            targetBank = Math.max(-maxBank, Math.min(maxBank, targetBank));

            const bankLerp = 1.0 - Math.pow(0.02, dt);
            this.bankingAmount += (targetBank - this.bankingAmount) * bankLerp;

            // Pitch
            const pitchSensitivity = 0.1;
            const maxPitch = 1.0;

            let targetPitch = -this.velocity.y * pitchSensitivity;
            targetPitch = Math.max(-maxPitch, Math.min(maxPitch, targetPitch));

            const pitchLerp = 1.0 - Math.pow(0.05, dt);
            this.pitchAmount += (targetPitch - this.pitchAmount) * pitchLerp;

            // Apply Rotation
            const finalYaw = this.currentYaw + this.rotationOffset;

            this.mesh.quaternion.setFromAxisAngle(_pAxisY, finalYaw);

            _pQuat.setFromAxisAngle(new THREE.Vector3(1, 0, 0), this.pitchAmount);
            this.mesh.quaternion.multiply(_pQuat);

            _pQuat.setFromAxisAngle(new THREE.Vector3(0, 0, 1), this.bankingAmount);
            this.mesh.quaternion.multiply(_pQuat);

            // Idle Bob
            if (velLenSq < 0.1 && !this.isEngaged) {
                const time = Date.now() * 0.0015;
                const bobPitch = Math.sin(time) * 0.03;
                const bobRoll = Math.cos(time * 0.7) * 0.02;

                _pEuler.set(bobPitch, 0, bobRoll);
                _pQuat.setFromEuler(_pEuler);
                this.mesh.quaternion.multiply(_pQuat);
            }
        }

        _checkTacklePressure(dt) {
            this.struggleIntensity = 0;
            
            if (!this.hasBall) {
                this.isEngaged = false;
                this.encounterTimer = 0;
                return;
            }

            if (this.immunityTimer > 0) return;
            if (this.isDashing) return;

            const game = window.flux.gameInstance;
if (!game || !game.teams || !this.team) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];
            if (!opponentTeam) return;

            let totalPressure = 0;
            let engagedCount = 0;
            const effectiveRadius = this.tackleRadius; 

            // Forward vector for shielding check
            _pVec.copy(_pAxisZ).applyQuaternion(this.mesh.quaternion); 

            for (const entity of opponentTeam.players) {
                if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(entity.mesh.position);
                if (dist < effectiveRadius) {
                    engagedCount++;
                    
                    // Calculate Pressure Intensity (0 to 1 based on distance)
                    const proximity = 1.0 - (dist / effectiveRadius);
                    
                    // Base Pressure from AT stat
                    let pressure = entity.getStat('AT') * proximity;

                    // Directional Shielding (Continuous)
                    const toOpp = entity.mesh.position.clone().sub(this.mesh.position).normalize();
                    const dot = _pVec.dot(toOpp);
                    
                    // If opponent is BEHIND (dot < -0.2), pressure is reduced (Shielding)
                    let isShielded = false;
                    if (dot < -0.2) {
                        pressure *= 0.5;
                        isShielded = true;
                    }

                    // Tech Modifiers (Continuous application chance)
                    if (entity.techs.tackle === 'venom') {
                        if (Math.random() < dt * 0.5) this.applyStatus('venom', 5.0);
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'wither') {
                        if (Math.random() < dt * 0.5) this.applyStatus('wither', 5.0, 'EN');
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'drain') {
                        const drainAmt = pressure * dt * 0.5;
                        this.stats.HP -= drainAmt;
                        entity.stats.HP += drainAmt;
                    }

                    totalPressure += pressure;

                    // Visuals: Sparks occasionally based on pressure
                    if (Math.random() < dt * 4.0 * proximity) { 
                         if (game.spawnClash) {
                            const mid = this.mesh.position.clone().lerp(entity.mesh.position, 0.5);
                            mid.y += 1.0;
                            game.spawnClash(mid, 0.5);
                        }
                    }
                }
            }

            this.isEngaged = (engagedCount > 0);

            if (this.isEngaged) {
                this.encounterTimer += dt;

                // Apply EN Drain (Continuous)
                // Scaling: 20 AT pressure -> approx 10 EN lost per second
                const drainRate = totalPressure * 0.5; 
                this.currentEN -= drainRate * dt;
                
                // Update Struggle Intensity for Physics (0.0 to 1.0)
                // Max struggle at roughly 30 pressure
                this.struggleIntensity = Math.min(1.0, totalPressure / 30.0);

                // Visual Feedback for Drain (Accumulate to avoid spam)
                this._accumulatedDamage += drainRate * dt;
                if (this._accumulatedDamage > 5.0) {
                    if (game.floatingText) {
                        game.floatingText.spawn(`-${Math.floor(this._accumulatedDamage)}`, this.mesh.position, "damage");
                    }
                    this._accumulatedDamage = 0;
                }
                
                // Hint for player if engaged too long
                if (this.encounterTimer > 1.0 && this.encounterTimer < 1.1 && this.team.isHuman && this.team.activePlayer === this) {
                     if (game.floatingText) game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
            } else {
                this.encounterTimer = 0;
            }

            if (this.currentEN <= 0) {
                this.fumble();
            }
        }

        _performJechtKnockback() {
            if (!this.team) return;
            const game = window.flux.gameInstance;
            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            const range = 6.0;
            const force = 25.0;

            if (game.floatingText) {
                game.floatingText.spawn("JECHT SHOT!", this.mesh.position, "goal");
            }

            opponentTeam.players.forEach(p => {
                if (!p.mesh) return;
                const dist = this.mesh.position.distanceTo(p.mesh.position);
                if (dist < range) {
                    const dir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                    dir.y = 0.5;
                    dir.normalize();

                    p.velocity.add(dir.multiplyScalar(force));

                    p.stunTimer = 2.0; // Ensure they stay down
                    p.isDashing = false;
                    const reactAction = p.actions && p.actions['react'];
                    if (reactAction) {
                        reactAction.setLoop(THREE.LoopOnce);
                        reactAction.clampWhenFinished = true;
                        p.playOneShot('react', 0.1);
                    } else {
                        p.play('catch', 0.5);
                    }

                    if (game.floatingText) {
                        game.floatingText.spawn("SMACK!", p.mesh.position, "damage");
                    }
                    if (game.triggerImpact) game.triggerImpact(0.15, 'shatter');
                }
            });
        }

        fumble() {
            console.log("FUMBLE! EN Depleted.");
            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("CRASH!", this.mesh.position, "comic-impact");
            }

            this.stunTimer = 1.5;

            const backDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize().negate();
            backDir.x += (Math.random() - 0.5) * 0.5;
            backDir.z += (Math.random() - 0.5) * 0.5;
            backDir.normalize();

            this.velocity.add(backDir.multiplyScalar(12.0));

            if (this.hasBall) {
                const ball = window.flux.gameInstance.entities.ball;
                if (ball) {
                    const ejectDir = new THREE.Vector3(Math.random()-0.5, 0.8, Math.random()-0.5).normalize();
                    ball.shoot(ejectDir, 6.0, 'none');
                    this.loseBall();
// Duplicate removed
                    this.currentEN = 0;
                }
            }
        }

        dash(x, z) {
            if (this.isDashing || this.dashCooldown > 0) return;
            if (this.status.nap > 0) return;

            // OFFENSE: BREAK TACKLE
            if (this.hasBall && this.isEngaged) {
                const cost = 15;

                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("FAILED!", this.mesh.position, "damage");
                    }
                    this.fumble();
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.0;
                this.dashType = 'break';

                _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                this.velocity.add(_pVec.multiplyScalar(10.0)); // Nerfed from 15.0 for realism

                const game = window.flux.gameInstance;
                const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
                const opponentTeam = game.teams[opponentTeamId];

                opponentTeam.players.forEach(p => {
                    if (!p.mesh) return;
                    const dist = this.mesh.position.distanceTo(p.mesh.position);
                    if (dist < this.tackleRadius * 1.5) {
                        const pushDir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                        pushDir.y = 0.5;
                        p.velocity.add(pushDir.multiplyScalar(15.0));

                        p.stunTimer = 2.0;
                        p.play('catch', 0.2);

                        if (game.floatingText) {
                            game.floatingText.spawn("STUN!", p.mesh.position, "damage");
                        }
                    }
                });

                if (game.floatingText) {
                    game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
                
                // NEW: Spawn Break Glyph (Explosive Burst)
                if (game.glyphManager) {
                    game.glyphManager.spawn('status', this.mesh.position, {
                        parent: this,
                        life: 0.5,
                        rotationSpeed: 8.0,
                        scaleSpeed: 3.0,
                        offsetY: 0.5
                    });
                }
                
                // Particle Burst (Break Tackle)
                if (game.particleManager) {
                    for(let i=0; i<30; i++) {
                        game.particleManager.spawn('flash', this.mesh.position, { scale: 2.5 });
                        // Bubble Burst
                        const bubblePos = this.mesh.position.clone().add(new THREE.Vector3((Math.random()-0.5)*2, (Math.random()-0.5)*2, (Math.random()-0.5)*2));
                        game.particleManager.spawn('bubble', bubblePos, { scale: 0.2 + Math.random() * 0.4 });
                    }
                }

                if (game.triggerImpact) game.triggerImpact(0.15, 'heavy');

                return;
            }
            // OFFENSE: SPRINT
            if (this.hasBall) {
                const cost = 5;
                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                    }
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 1.5;
                this.dashType = 'sprint';

                const burstDir = this.velocity.clone().normalize();
                if (burstDir.lengthSq() < 0.1) burstDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);

                this.velocity.add(burstDir.multiplyScalar(12.0)); // Nerfed from 15.0
                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(20);
                }
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("DASH!", this.mesh.position, "tech");
                }
                return;
            }

            // DEFENSE: BLOCK / TACKLE
// DEFENSE: BLOCK / TACKLE
            let isBlockContext = false;
            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            if (ball && ball.mesh) {
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 8.0 && ball.mesh.position.y > 2.5) {
                    isBlockContext = true;
                }
            }
            this.isDashing = true;
            this.dashTime = this.dashTotalTime;
            this.dashCooldown = 1.5;

            const len = Math.sqrt(x*x + z*z);
            const nx = (len > 0) ? x/len : 0;
            const nz = (len > 0) ? z/len : 0;

            if (len > 0) {
                // Smooth turn for dash instead of snap
                this.targetYaw = Math.atan2(nx, nz);
            }
            if (isBlockContext) {
                this.dashType = 'vertical';

                const dirToBall = ball.mesh.position.clone().sub(this.mesh.position);
                dirToBall.y = 0;

                if (dirToBall.lengthSq() > 0.01) {
                    dirToBall.normalize();
                    this.dashVec.copy(dirToBall).multiplyScalar(8.0);
                } else {
                    this.dashVec.set(0, 0, 0);
                }

                const catchAction = this.actions['catch'];
                if (catchAction) {
                    catchAction.setLoop(THREE.LoopOnce);
                    catchAction.clampWhenFinished = true;
                    catchAction.timeScale = 1.5;
                }
                this.play('catch', 0.1);

                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "default");
                }

            } else {
                this.dashType = 'horizontal';
                this._hasHitTackle = false;

                // Apply velocity impulse in dash direction
                _pVec.set(nx, 0, nz);
                if (_pVec.lengthSq() < 0.1) {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                }
                this.velocity.add(_pVec.multiplyScalar(14.0)); // Nerfed from 20.0

                const lungeAction = this.actions['throw'];
                if (lungeAction) {
                    lungeAction.setLoop(THREE.LoopOnce);
                    lungeAction.clampWhenFinished = true;
                    lungeAction.timeScale = 2.0;
                }
                this.play('throw', 0.1);

                // JUICE: Stretch on Dash
                this.squash(0.7, 1.4, 0.7);

                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.05, 'default');
            }

            if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addFovImpulse(10);
                window.flux.gameInstance.cameraManager.addShake(0.3); 
                
                // Dash Recoil (Kickback)
                const dashDir = this.velocity.clone().normalize();
                window.flux.gameInstance.cameraManager.addRecoil(-dashDir.x * 1.5, -0.5, -dashDir.z * 1.5);
            }
            // Dash Effect
            if (window.flux.gameInstance.particleManager) {
                const dashPos = this.mesh.position.clone();
                dashPos.y += 1.0;
                window.flux.gameInstance.particleManager.spawn('shockwave', dashPos, { scale: 1.5, life: 0.3 });
                // Speed lines
                const back = this.velocity.clone().normalize().negate();
                for(let i=0; i<3; i++) {
                    const p = dashPos.clone().add(back.multiplyScalar(Math.random()));
                    p.x += (Math.random()-0.5);
                    window.flux.gameInstance.particleManager.spawn('dash_stream', p, { scale: 1.5 });
                }
            }
        }

        _createHPBar() {
            // Holographic HP Bar Shader with Juice (Shake & Flash)
            const geometry = new THREE.PlaneGeometry(1.4, 0.18);
            
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uFill: { value: 1.0 },
                    uColor: { value: new THREE.Color(0x00ff00) },
                    uTime: { value: 0.0 },
                    uOpacity: { value: 0.9 },
                    uShake: { value: 0.0 },
                    uFlash: { value: 0.0 }
                },
                vertexShader: `
                    uniform float uTime;
                    uniform float uShake;
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        vec3 pos = position;
                        
                        // Juice: Shake Effect
                        if (uShake > 0.001) {
                            float t = uTime * 30.0;
                            pos.x += sin(t) * uShake;
                            pos.y += cos(t * 0.8) * uShake;
                        }
                        
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uFill;
                    uniform vec3 uColor;
                    uniform float uTime;
                    uniform float uOpacity;
                    uniform float uFlash;
                    varying vec2 vUv;

                    void main() {
                        // Frame dimensions (UV space)
                        float borderY = 0.15;
                        float borderX = 0.02;
                        
                        // Inner content mask
                        float inY = step(borderY, vUv.y) * step(vUv.y, 1.0 - borderY);
                        float inX = step(borderX, vUv.x) * step(vUv.x, 1.0 - borderX);
                        float contentMask = inY * inX;

                        // Background (Tech Grid)
                        vec3 bgCol = vec3(0.0, 0.1, 0.2);
                        float grid = step(0.9, fract(vUv.x * 20.0 + vUv.y * 10.0)) * 0.2;
                        bgCol += grid;

                        // Fill Logic
                        float fillMask = step(vUv.x, uFill) * contentMask;

                        // Energy Pulse Pattern
                        float pulse = sin(vUv.x * 10.0 - uTime * 3.0) * 0.5 + 0.5;
                        vec3 barCol = mix(uColor, uColor + vec3(0.4), pulse * 0.6);

                        // Hot Edge
                        float edge = smoothstep(uFill - 0.05, uFill, vUv.x) * fillMask;
                        barCol += vec3(1.0) * edge;

                        // Scanline (Hologram effect)
                        float scan = sin(vUv.y * 80.0 + uTime * 5.0) * 0.05;
                        
                        // Border Glow
                        float borderMask = (1.0 - contentMask);
                        vec3 borderCol = vec3(0.0, 0.6, 1.0) * 0.6; // Cyan tech border

                        // Compose
                        vec3 finalCol = mix(bgCol, barCol, fillMask);
                        finalCol = mix(finalCol, borderCol, borderMask);
                        finalCol += scan;

                        // Juice: Flash (Damage/Impact)
                        if (uFlash > 0.001) {
                            finalCol = mix(finalCol, vec3(1.0, 1.0, 1.0), uFlash);
                        }

                        // Opacity
                        float alpha = uOpacity;
                        // Fade background areas slightly
                        if (fillMask < 0.5 && borderMask < 0.5) alpha *= 0.5;

                        gl_FragColor = vec4(finalCol, alpha);
                    }
                `,
                transparent: true,
                depthTest: false, // Render on top
                depthWrite: false,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending
            });

            this.hpBar = new THREE.Mesh(geometry, material);
            this.hpBar.renderOrder = 900; // Ensure it renders above most things
            this.scene.add(this.hpBar);
        }

        _updateHPBar(dt = 0.016) {
            if (!this.hpBar || !this.mesh) return;

            // Visibility Check: Only show if mesh is visible AND in Active/Practice states
            if (!this.mesh.visible) {
                this.hpBar.visible = false;
                return;
            }

            const game = window.flux.gameInstance;
            const allowedState = game && (game.state === 'active' || game.state === 'kickoff' || game.gameMode === 'practice');
            
            if (!allowedState) {
                this.hpBar.visible = false;
                return;
            }
            this.hpBar.position.copy(this.mesh.position);
            this.hpBar.position.y += 2.2;

            if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                this.hpBar.lookAt(window.flux.gameInstance.camera.position);
            }

            // --- JUICE: Damage Reaction ---
            // Initialize _lastHP if undefined (first run)
            if (this._lastHP === undefined) this._lastHP = this.stats.HP;

            const delta = this._lastHP - this.stats.HP;
            if (delta > 0.1) {
                // HP Decreased
                if (this.isThrowing || this.isCharging) {
                    // Voluntary exertion (Ability cost) -> Small Flash
                    this.hpFlash = Math.min(this.hpFlash + 0.4, 0.6);
                } else {
                    // Involuntary damage (Venom, Drain, etc) -> Shake + Flash
                    this.hpShake = Math.min(this.hpShake + 0.05, 0.15);
                    this.hpFlash = 1.0;
                }
            }
            this._lastHP = this.stats.HP;

            // Decay FX
            this.hpShake *= Math.max(0, 1.0 - dt * 8.0);
            this.hpFlash *= Math.max(0, 1.0 - dt * 5.0);

            const pct = Math.max(0, this.stats.HP / this.stats.maxHP);
            
            // Update Shader Uniforms
            const mat = this.hpBar.material;
            if (mat.uniforms) {
                mat.uniforms.uFill.value = pct;
                mat.uniforms.uTime.value += dt;
                mat.uniforms.uShake.value = this.hpShake;
                mat.uniforms.uFlash.value = this.hpFlash;
                
                const col = mat.uniforms.uColor.value;
                if (pct > 0.5) col.setHex(0x00ff00);
                else if (pct > 0.25) col.setHex(0xffff00);
                else col.setHex(0xff0000);
            }

            // Hide if full HP to reduce clutter, unless in practice mode
            const alwaysShow = game && game.gameMode === 'practice';
            this.hpBar.visible = (pct < 0.98 || alwaysShow || this.hpFlash > 0.1);
        }

        gainExp(amount) {
            if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            this.exp += amount;

            if (this.exp >= this.nextLevelExp) {
                this.levelUp();
            }
        }

        levelUp() {
            this.level++;
            this.exp -= this.nextLevelExp;
            this.nextLevelExp = Math.floor(this.nextLevelExp * 1.5);

            const keys = ['HP', 'EN', 'AT', 'PA', 'BL', 'SH', 'CA', 'SP'];

            const hpGain = Math.floor(Math.random() * 20) + 10;
            this.stats.maxHP += hpGain;
            this.stats.HP = this.stats.maxHP;

            keys.forEach(k => {
                if (k === 'HP') return;
                if (Math.random() > 0.4) {
                    const gain = Math.floor(Math.random() * 2) + 1;
                    this.stats[k] += gain;
                }
            });

            this._updateDerivedStats();

            console.log(`${this.role} reached Level ${this.level}!`);

            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("LEVEL UP!", this.mesh.position, "tech");
            }
        }

_checkTackleCollision() {
            if (!this.team || this._hasHitTackle) return;

            const game = window.flux.gameInstance;
            if (!game) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            // Use velocity as tackle direction (since tackle imparts velocity)
            // Fallback to facing if velocity is negligible
            let tackleDir = this.velocity.clone();
            tackleDir.y = 0;
            if (tackleDir.lengthSq() < 0.1) {
                tackleDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            }
            tackleDir.normalize();

            for (const opp of opponentTeam.players) {
                if (!opp.mesh) continue;
                
                // Vector to opponent
                const toOpp = opp.mesh.position.clone().sub(this.mesh.position);
                toOpp.y = 0; // Ignore height difference for hit detection cylinder
                
                const dist = toOpp.length();
                const reach = 3.5; // Detection radius

                if (dist < reach) {
                    toOpp.normalize();
                    const dot = tackleDir.dot(toOpp);
                    
                    // Cone Check: ~45 degrees (dot > 0.7)
                    // This requires the player to actually aim the tackle
                    if (dot > 0.7) {
                        // Calculate Impact Quality (0.0 to 1.0)
                        // 1.0 = Dead center hit, 0.0 = Glancing blow at edge of cone
                        let quality = (dot - 0.7) / 0.3; 
                        quality = Math.max(0, Math.min(1, quality));
                        
                        this._resolveTackleHit(opp, quality);
                        this._hasHitTackle = true;
                        return; // Only hit one target per tackle frame
                    }
                }
            }
        }

_resolveTackleHit(opp, quality) {
            this.play('idle', 0.2); // Stop tackle animation
            
            const isCleanHit = quality > 0.6; // Threshold for "Clean Hit"
            
            // JUICE: Impact Flash & Squash (Attacker)
            this.flash(0xffffff, 0.15);
            this.squash(1.2, 0.8, 1.2); // Impact compression

            // HERCULEAN IMPACT FX
            if (isCleanHit) {
                // 1. Freeze Frame (Impact Stop)
                if (window.flux.gameInstance.triggerImpact) {
                    window.flux.gameInstance.triggerImpact(0.25, 'shatter'); // Heavy freeze
                }
                
                // 2. Camera Zoom Snap & Aberration
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-20); // Zoom IN
                    window.flux.gameInstance.cameraManager.addShake(3.0);
                    window.flux.gameInstance.cameraManager.addAberration(15.0); // Massive glitch
                }

                // 3. Directional Debris (Cone behind victim)
                if (window.flux.gameInstance.particleManager) {
                    const pm = window.flux.gameInstance.particleManager;
                    const impactPos = opp.mesh.position.clone().add(new THREE.Vector3(0, 1, 0));
                    const tackleDir = this.velocity.clone().normalize();
                    
                    // Shockwave
                    pm.spawn('shockwave', impactPos, { scale: 6.0, life: 0.4, color: 0xffffff });
                    pm.spawn('flash', impactPos, { scale: 5.0 });

                    // Debris Cone
for(let i=0; i<8; i++) { // Reduced from 15
                        const debrisDir = tackleDir.clone();
                        // Spread
                        debrisDir.x += (Math.random()-0.5) * 1.5;
                        debrisDir.y += (Math.random()) * 1.0; // Upward bias
                        debrisDir.z += (Math.random()-0.5) * 1.5;
                        debrisDir.normalize().multiplyScalar(10.0 + Math.random() * 10.0);
                        
pm.spawn('impact_shard', impactPos, {
                            velocity: debrisDir,
                            life: 0.8 + Math.random() * 0.5,
                            scale: 0.5 + Math.random() * 0.5,
                            gravity: 25.0,
                            drag: 1.0,
                            rotationSpeed: (Math.random() - 0.5) * 15.0,
                            frame: Math.floor(Math.random() * 4)
                        });
                    }
                }
            } else {
                // Glancing Hit FX
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            if (window.flux.gameInstance.audioManager) {
                // Pitch shift based on quality (Higher pitch = cleaner hit)
                window.flux.gameInstance.audioManager.playSFX('tackle', { rate: 0.8 + quality * 0.4 });
                if (isCleanHit) {
                    window.flux.gameInstance.audioManager.playSFX('impact', { volume: 1.0, rate: 0.5 }); // Deep boom
                }
            }

            let damage = this.getStat('AT');
            if (isCleanHit) damage *= 1.5;

            if (opp.hasBall) {
                // SHIELD CHECK
                let fumbleChance = isCleanHit ? 1.0 : 0.3; // Glancing hits rarely cause fumbles unless EN depleted
                
                if (opp.status.shield > 0) {
                    damage *= 0.5;
                    fumbleChance = 0.0; // Shield prevents fumble
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SHIELDED", opp.mesh.position, "block");
                    }
                }

                opp.currentEN -= damage;

                if (window.flux.gameInstance.floatingText) {
                    const label = isCleanHit ? "CRITICAL!" : "GLANCING";
                    const style = isCleanHit ? "comic-impact" : "default";
                    
                    window.flux.gameInstance.floatingText.spawn(`${Math.floor(damage)}`, opp.mesh.position, "damage");
                    // Delay label slightly for readability
                    setTimeout(() => {
                        if(window.flux.gameInstance.floatingText) 
                            window.flux.gameInstance.floatingText.spawn(label, opp.mesh.position, style);
                    }, 100);
                }

                if (opp.currentEN <= 0 && Math.random() < fumbleChance) {
                    opp.fumble();
                } else {
                    // Stun logic: Clean hits stun longer
                    opp.stunTimer = isCleanHit ? 1.0 : 0.3;
                    opp.playOneShot('react', 0.1);

                    // JUICE: Impact Flash & Squash (Victim)
                    opp.flash(0xff0000, isCleanHit ? 0.3 : 0.1); 
                    opp.squash(1.3, 0.6, 1.3); 
                }

                if (this.techs.tackle && window.flux.gameInstance.triggerTechEvent && isCleanHit) {
                    window.flux.gameInstance.triggerTechEvent(this, this.techs.tackle);
                }

            } else {
                // Hit player without ball
                opp.stunTimer = isCleanHit ? 1.5 : 0.5;
                opp.flash(0xffaa00, 0.2);
                opp.squash(1.2, 0.7, 1.2);
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn(isCleanHit ? "SMACK!" : "BUMP", opp.mesh.position, "comic-impact");
                }
            }

            // Physics Knockback
            const pushDir = opp.mesh.position.clone().sub(this.mesh.position).normalize();
            pushDir.y = 0.2;
            const knockbackForce = isCleanHit ? 18.0 : 8.0;
            opp.velocity.add(pushDir.multiplyScalar(knockbackForce));

            // Camera Shake & Impact
            if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addShake(isCleanHit ? 1.5 : 0.5);
            }
            if (window.flux.gameInstance.triggerImpact) {
                window.flux.gameInstance.triggerImpact(isCleanHit ? 0.15 : 0.05, isCleanHit ? 'heavy' : 'default');
            }
            
            // Particles
            if (window.flux.gameInstance.spawnClash) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                window.flux.gameInstance.spawnClash(mid, quality);
            }
            
            if (window.flux.gameInstance.particleManager) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                const impactVel = this.velocity.clone().multiplyScalar(0.5);
                
                const count = isCleanHit ? 30 : 10;
                for(let i=0; i<count; i++) {
                    const bubblePos = mid.clone().add(new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5));
                    window.flux.gameInstance.particleManager.spawn('bubble', bubblePos, { 
                        scale: 0.15 + Math.random() * 0.35,
                        emitterVelocity: impactVel,
                        momentumScale: 0.5
                    });
                }
                
                if (isCleanHit) {
                    window.flux.gameInstance.particleManager.spawn('shockwave', mid, { scale: 3.0 });
                }
            }
        }

        _applyGoalCrease(dt) {
            const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goals = [
                new THREE.Vector3(0, 0, goalDist),
                new THREE.Vector3(0, 0, -goalDist)
            ];

            const radius = 10.0;

            goals.forEach(goal => {
                const dx = this.mesh.position.x - goal.x;
                const dz = this.mesh.position.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < radius * radius) {
                    const dist = Math.sqrt(distSq);
                    const pushX = dist > 0 ? dx / dist : 1;
                    const pushZ = dist > 0 ? dz / dist : 0;

                    const force = 50.0;
                    this.velocity.x += pushX * force * dt;
                    this.velocity.z += pushZ * force * dt;

                    if (dist < radius - 0.5) {
                        const clampRatio = radius / (dist + 0.001);
                        this.mesh.position.x = goal.x + dx * clampRatio;
                        this.mesh.position.z = goal.z + dz * clampRatio;
                    }
                }
});
        }

evade() {
            if (this.isEvading || this.isDashing || this.evadeCooldown > 0 || this.status.nap > 0 || this.stunTimer > 0) return;
            
            const cost = 10;
            if (this.currentEN < cost) {
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                 return;
            }
            this.currentEN -= cost;

            this.isEvading = true;
            this.evadeTime = 0.4;
            this.evadeCooldown = 1.5;
            this.immunityTimer = 0.5; // Invulnerability frames

            const game = window.flux.gameInstance;

            // --- PERFECT DODGE CHECK ---
            let isPerfect = false;
            if (game && this.team) {
                const oppTeamId = this.team.id === 'home' ? 'away' : 'home';
                const oppTeam = game.teams[oppTeamId];
                if (oppTeam) {
                    for (const opp of oppTeam.players) {
                        // Check if opponent is dashing (tackling) and close
                        if (opp.isDashing && opp.mesh) {
                            const dist = this.mesh.position.distanceTo(opp.mesh.position);
                            // 5.0 is slightly larger than tackle radius (3.0), creating a window
                            if (dist < 5.0) { 
                                isPerfect = true;
                                break;
                            }
                        }
                    }
                }
            }

            if (isPerfect) {
                // 1. Refund & Bonus
                this.currentEN = Math.min(this.stats.EN, this.currentEN + cost + 10);
                
                // 2. Visuals
                if (game.floatingText) {
                    game.floatingText.spawn("PERFECT!", this.mesh.position, "tech");
                }
                
                // 3. Tech Flash Overlay
                if (game.ui && game.ui.techFlash) {
                    const tf = game.ui.techFlash;
                    tf.style.display = 'flex';
                    const txt = tf.querySelector('.tech-text');
                    const sub = tf.querySelector('.tech-sub-text');
                    if (txt) txt.innerText = "PERFECT DODGE";
                    if (sub) sub.innerText = this.role;
                    tf.style.background = "linear-gradient(90deg, rgba(0,0,0,0), rgba(0, 255, 255, 0.6), rgba(0,0,0,0))";
                    
                    // Auto-hide
                    setTimeout(() => { tf.style.display = 'none'; }, 800);
                }

                // 4. Matrix Time Slow
                const originalTimeScale = window.flux.timeScale || 0.8;
                window.flux.timeScale = 0.1; // Slow motion
                
                // Restore time after 800ms real-time
                setTimeout(() => {
                    window.flux.timeScale = originalTimeScale;
                }, 800);

                // 5. Camera Juice
                if (game.cameraManager) {
                    game.cameraManager.addFovImpulse(-10); // Zoom snap
                    game.cameraManager.addShake(0.5);
                }
                
                // 6. SFX
                if (game.audioManager) {
                    game.audioManager.playSFX('dash', { rate: 0.5, volume: 1.2 }); // Deep whoosh
                }

                // 7. Particle Burst
                if (game.particleManager) {
                    game.particleManager.spawn('shockwave', this.mesh.position, { scale: 3.0, life: 0.5 });
                    game.particleManager.spawn('flash', this.mesh.position, { scale: 2.0 });
                }

            } else {
                // Normal Evade
                if (game.audioManager) game.audioManager.playSFX('dash', { rate: 1.5 });
                if (game.floatingText) game.floatingText.spawn("EVADE!", this.mesh.position, "tech");
            }

            // Momentum Shift: Add velocity perpendicular to current facing or input
            const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const right = new THREE.Vector3(1, 0, 0).applyQuaternion(this.mesh.quaternion);
            
            // Determine dodge direction based on input
            let dodgeDir = right.clone();
            
            // Randomize direction
            if (Math.random() > 0.5) dodgeDir.negate();
            
            this.velocity.add(dodgeDir.multiplyScalar(12.0)); // Boosted speed
            this.velocity.add(fwd.multiplyScalar(4.0)); // Slight forward momentum
        }

startTackleCharge() {
            if (this.hasBall || this.isDashing || this.isEvading || this.isTackling || this.isRecovering || this.status.nap > 0 || this.stunTimer > 0 || this.isTackleCharging) return;
            
            this.isTackleCharging = true;
            this.tackleChargeTime = 0;
            
            // Visual feedback
            if (window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: 2.0,
                    scale: 0.5,
                    offsetY: 0.1
                });
            }
        }

        releaseTackle() {
            if (!this.isTackleCharging) return;
            this.isTackleCharging = false;
            
            const ratio = Math.min(this.tackleChargeTime / this.maxTackleChargeTime, 1.0);
            this.tackleChargeBonus = ratio;
            
            // Calculate direction based on input
            let dx = this.inputVector.x;
            let dz = this.inputVector.z;
            
            // If no input, tackle forward
            if (Math.abs(dx) < 0.1 && Math.abs(dz) < 0.1) {
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                dx = fwd.x;
                dz = fwd.z;
            }
            
            this.startTackle(dx, dz);
            
            // If high charge, add extra juice
            if (ratio > 0.8) {
                 if (window.flux.gameInstance.cameraManager) window.flux.gameInstance.cameraManager.addShake(0.5);
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("MAX TACKLE!", this.mesh.position, "comic-impact");
                 if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('tackle', { rate: 0.8 });
            }
        }

        startTackle(dx, dz) {
            if (this.isTackling || this.isRecovering || this.isDashing || this.status.nap > 0 || this.stunTimer > 0) return;

            const cost = 15;
            if (this.currentEN < cost) {
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                 return;
            }
            this.currentEN -= cost;

            this.isTackling = true;
            this.tackleTime = 0.5; // Slide duration
            this._hasHitTackle = false;
            
            // Calculate Direction
            _pVec.set(dx, 0, dz);
            if (_pVec.lengthSq() < 0.1) {
                _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            }
            _pVec.normalize();

            // Lock Rotation (Commitment)
            const targetAngle = Math.atan2(_pVec.x, _pVec.z);
            this.currentYaw = targetAngle - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.mesh.quaternion.setFromAxisAngle(_pAxisY, targetAngle);

            // Initial Impulse (High Velocity)
            const speed = 25.0; 
            this.velocity.copy(_pVec).multiplyScalar(speed);
            
            // Animation (Reuse throw lunge for now, looks like a shoulder barge)
            this.play('throw', 0.1); 
            
            // Visuals
            if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');
            if (window.flux.gameInstance.particleManager) {
                 const pos = this.mesh.position.clone();
                 pos.y = 0.5;
                 window.flux.gameInstance.particleManager.spawn('shockwave', pos, { scale: 1.5 });
            }
        }

        startBlock() {
            if (this.hasBall || this.isDashing || this.isEvading || this.status.nap > 0 || this.stunTimer > 0) return;
            this.isBlocking = true;
            // Use 'catch' animation for block stance
            this.play('catch', 0.2);
        }

        stopBlock() {
            if (this.isBlocking) {
                this.isBlocking = false;
                this.play('idle', 0.2);
            }
        }
    }

    window.flux.Player = Player;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Formation Definitions (Coordinates for Side 1: Defends +Z, Attacks -Z)
    // X: Left(-)/Right(+), Z: Forward(-)/Back(+)
    const FORMATIONS = {
        'Normal': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -10, z: -10 }, 'RF': { x: 10, z: -10 }
        },
        'Center Attack': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -4, z: -15 }, 'RF': { x: 4, z: -15 }
        },
        'Right Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: 0, z: 15 }, 'RD': { x: 12, z: 15 },
            'MF': { x: 10, z: 5 },
            'LF': { x: 5, z: -10 }, 'RF': { x: 15, z: -10 }
        },
        'Left Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -12, z: 15 }, 'RD': { x: 0, z: 15 },
            'MF': { x: -10, z: 5 },
            'LF': { x: -15, z: -10 }, 'RF': { x: -5, z: -10 }
        },
        'All-Out Defense': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -6, z: 20 }, 'RD': { x: 6, z: 20 },
            'MF': { x: 0, z: 10 },
            'LF': { x: -10, z: 5 }, 'RF': { x: 10, z: 5 }
        },
        'Flat Line': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 0 }, 'RD': { x: 8, z: 0 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -15, z: 0 }, 'RF': { x: 15, z: 0 }
        },
        'Counter': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 20 }, 'RD': { x: 8, z: 20 },
            'MF': { x: 0, z: 15 },
            'LF': { x: -12, z: -20 }, 'RF': { x: 12, z: -20 }
        },
        'Double Sides': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -18, z: 15 }, 'RD': { x: 18, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -18, z: -10 }, 'RF': { x: 18, z: -10 }
        }
    };



    // --- Enemy Indicator (Red Arrow Sprite) ---
    // Shared texture/material so we don't create 6 canvases.
const _enemyArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64;
        c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ff0000';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

const _playerArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#00ff00'; // Green
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _teammateArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ffffff'; // White
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _enemyArrowMaterial = new THREE.SpriteMaterial({ map: _enemyArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _playerArrowMaterial = new THREE.SpriteMaterial({ map: _playerArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _teammateArrowMaterial = new THREE.SpriteMaterial({ map: _teammateArrowTexture, transparent: true, depthTest: false, depthWrite: false });
class Team {
        /**
         * Generates and applies stats to a player based on role and level.
         * Centralizes balancing to ensure high-level play feels distinct.
         */
        static generateStats(player, role, level = 1, isHuman = false) {
            // 1. Define Role Baselines (Level 1)
            // Balanced to be weak but functional at Level 1
            const base = {
                HP: 100, SP: 55, EN: 10, AT: 5, PA: 5, BL: 5, SH: 5, CA: 5
            };

            // Role Specializations
            switch(role) {
                case 'LF': case 'RF': // Strikers
                    base.SH += 10; base.SP += 5; base.EN += 5;
                    break;
                case 'MF': // Playmakers
                    base.PA += 10; base.AT += 8; base.EN += 8; base.SP += 2;
                    break;
                case 'LD': case 'RD': // Defenders
                    base.AT += 12; base.BL += 10; base.PA += 5;
                    break;
                case 'GL': // Goalie
                    base.CA += 10; base.SP += 5; base.PA += 15; // Strong arm
                    break;
            }

            // 2. Scaling Factors (Per Level)
            // Designed so Level 50 is "God Tier" and Level 1 is "Rookie"
            const growth = {
                HP: 15,    // +1500 HP at Lvl 99
                SP: 0.5,   // +50 SP at Lvl 99 (Speed demon)
                Primary: 0.8, // +80 Stat at Lvl 99
                Secondary: 0.5 // +50 Stat at Lvl 99
            };

            // Helper to scale
            const scale = (val, rate) => Math.floor(val + ((level - 1) * rate));

            // Apply Scaling
            player.stats.HP = scale(base.HP, growth.HP);
            
            // SP: Cap at 99, but ensure high levels feel FAST
            player.stats.SP = Math.min(99, scale(base.SP, growth.SP));

            // Stat distribution based on role priorities
            if (['LF', 'RF'].includes(role)) {
                player.stats.SH = Math.min(99, scale(base.SH, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Secondary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (role === 'MF') {
                player.stats.PA = Math.min(99, scale(base.PA, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.SH = Math.min(99, scale(base.SH, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (['LD', 'RD'].includes(role)) {
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.2)); // Defenders bad at shooting
            } else if (role === 'GL') {
                player.stats.CA = Math.min(99, scale(base.CA, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.3));
            }

            // 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
// 3. Human Player Bonus (The "Hero" Feel)
// 3. Human Player Bonus (The "Hero" Feel)
            if (isHuman) {
                player.stats.HP += 300; // Tankier (was 150)
                player.stats.SP += 8;   // Faster (was 5)
                player.stats.EN += 10;   // Harder to tackle (was 5)
                
                // Key Stat Boost
                if (role === 'LF' || role === 'RF') player.stats.SH += 5;
                if (role === 'MF') player.stats.PA += 5;
                if (role === 'LD' || role === 'RD') player.stats.AT += 5;
                if (role === 'GL') player.stats.CA += 5;
            }

            // 4. Finalize
            player.stats.maxHP = player.stats.HP;
            player.level = level;
            player._updateDerivedStats();
        }

constructor(scene, id, side, color, isHuman) {
            this.scene = scene;
            this.id = id; // 'home' or 'away'
            this.side = side; // 1 (Defends +Z) or -1 (Defends -Z)
            this.color = color;
            this.isHuman = isHuman;
            this.aiEnabled = true; // Master switch for AI logic
            
            this.players = [];
            this.activePlayer = null; // The player currently controlled/focused
            
            // Formation Anchors
this.currentFormation = 'Normal';

            // Auto-Switch Smoothing
            this.lastSwitchTime = 0;
            this.switchCooldown = 0.5; // Seconds before auto-switch can happen again
            // Player Indicator (Green Arrow)
            if (this.isHuman) {
                this.playerArrow = new THREE.Sprite(_playerArrowMaterial);
                this.playerArrow.scale.set(0.8, 0.8, 1.0);
                this.playerArrow.renderOrder = 1000; // On top
            }
        }

        assignMarks(opposingTeam) {
            // Simple auto-assign logic: Mark the player in the "matching" position
            // LF<->RD, RF<->LD, MF<->MF, LD<->RF, RD<->LF, GL<->LF
            this.players.forEach(p => {
                let targetRole = 'MF';
                switch (p.role) {
                    case 'LF': targetRole = 'RD'; break;
                    case 'RF': targetRole = 'LD'; break;
                    case 'MF': targetRole = 'MF'; break;
                    case 'LD': targetRole = 'RF'; break;
                    case 'RD': targetRole = 'LF'; break;
                    case 'GL': targetRole = 'LF'; break;
                }

                const target = opposingTeam.players.find(op => op.role === targetRole);
                if (target) {
                    p.marking = target;
                    // console.log(`${this.id} ${p.role} marked ${target.role}`);
                }
            });
        }

        addPlayer(player) {
            this.players.push(player);
            player.team = this;

            // Calculate Home Position based on Formation
            this._updatePlayerHomePosition(player);

            // Enemy indicator: red arrows over the Away team (so enemies are readable)
// Enemy indicator: red arrows over the Away team
            if (this.id === 'away' && player.mesh) {
                const arrow = new THREE.Sprite(_enemyArrowMaterial);
                arrow.scale.set(0.8, 0.8, 1.0);
                arrow.position.set(0, 3.2, 0); // above head
                arrow.renderOrder = 999;
                player.mesh.add(arrow);
                player.enemyArrow = arrow;
            }

            // Teammate indicator: White arrows for inactive humans
            if (this.isHuman && player.mesh) {
                const arrow = new THREE.Sprite(_teammateArrowMaterial);
                arrow.scale.set(0.6, 0.6, 1.0);
                arrow.position.set(0, 3.2, 0);
                arrow.renderOrder = 999;
                arrow.visible = false; // Hidden by default, managed by setActivePlayer
                player.mesh.add(arrow);
                player.teammateArrow = arrow;
            }
        }

        setFormation(name) {
            if (!FORMATIONS[name]) return;
            this.currentFormation = name;
            // console.log(`Team ${this.id} switched to ${name}`);
            
            this.players.forEach(p => {
                this._updatePlayerHomePosition(p);
            });
        }

_updatePlayerHomePosition(player) {
            const data = FORMATIONS[this.currentFormation];
            if (!data) return;

            const offset = data[player.role];
            if (offset) {
// X Position:
                // Formations: -X is Left, +X is Right.
                // Home Team (Side 1) faces -Z. Left is -X. Use offset.x as is.
                let xPos = offset.x;
                let zPos = offset.z * this.side;

                player.homePosition.set(xPos, 0, zPos);
                
                // Away Team (Side -1) faces +Z. Left is +X. Flip X.
                if (this.side === -1) {
                    player.homePosition.x *= -1; 
                }
            }
            
            // Set initial position
            if (player.mesh) {
                player.mesh.position.copy(player.homePosition);
                // Face center (0,0,0)
                player.mesh.lookAt(0, 0, 0);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updatePhysics) {
                    this.players[i].updatePhysics(dt);
                } else {
                    // Fallback if not split yet
                    this.players[i].update(dt);
                }
            }
            if (this.isHuman) {
                this.updateActivePlayerSelection();
            }
        }

        updateVisuals(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updateVisuals) {
                    this.players[i].updateVisuals(dt);
                }
            }
        }

updateActivePlayerSelection() {
            const ball = window.flux.gameInstance.entities.ball;
            if (!ball || !ball.mesh) return;

            // 1. OFFENSE: If we have the ball, active player MUST be the holder
            if (ball.holder && ball.holder.team === this) {
                if (this.activePlayer !== ball.holder) {
                    this.setActivePlayer(ball.holder);
                }
                return;
            }

            // 2. DEFENSE: Smart Switching
            
            // Cooldown check (Time in seconds)
            const now = Date.now() / 1000;
            if (now - this.lastSwitchTime < this.switchCooldown) return;

            // Action Locking: Don't switch if current player is committing to an action
            if (this.activePlayer) {
                const p = this.activePlayer;
                // If dashing, charging a tackle, evading, or in the middle of a tackle animation
                if (p.isDashing || p.isTackleCharging || p.isEvading || p.isTackling || p.isRecovering) {
                    return;
                }
            }

            let bestCandidate = this.activePlayer;
            let bestScore = Infinity;
            
            // Hysteresis: The current player gets a "virtual distance reduction"
            // This means a new candidate must be significantly closer to override the current one.
            const hysteresis = 5.0; // 5 meters stickiness

            for (const p of this.players) {
                if (p.role === 'GL') continue; // Don't auto-switch to goalie
                if (!p.mesh) continue;
                
                // Don't switch to incapacitated players
                if (p.status.nap > 0 || p.stunTimer > 0) continue;

                const dist = p.mesh.position.distanceTo(ball.mesh.position);
                
                let score = dist;

                // Apply bias to current player
                if (p === this.activePlayer) {
                    score -= hysteresis;
                }

                if (score < bestScore) {
                    bestScore = score;
                    bestCandidate = p;
                }
            }

            if (bestCandidate && bestCandidate !== this.activePlayer) {
                this.setActivePlayer(bestCandidate);
                this.lastSwitchTime = now;
            }
        }

setActivePlayer(player) {
            // Reset input on previous
            if (this.activePlayer) {
                this.activePlayer.setInput(0, 0);
            }
            this.activePlayer = player;

            // Visual Indicators
            if (this.isHuman) {
                // 1. Green Arrow for Active
                if (this.playerArrow && player.mesh) {
                    player.mesh.add(this.playerArrow);
                    this.playerArrow.position.set(0, 3.5, 0); // Float above head
                }

                // 2. White Arrows for Others
                this.players.forEach(p => {
                    if (p.teammateArrow) {
                        p.teammateArrow.visible = (p !== player);
                    }
                });
            }
        }

resetPositions() {
            for (const p of this.players) {
                if (p.mesh) {
                    p.mesh.position.copy(p.homePosition);
                    
                    // Reset Physics
                    p.velocity.set(0, 0, 0);
                    p.inputVector.set(0, 0, 0);
                    p.isDashing = false;
                    p.isThrowing = false;
p.loseBall(); // Drop ball if holding
                    p.canCatch = true; // Force reset capability
                    
                    // Reset Stats
                    p.currentEN = p.stats.EN;
                    
// Orientation: Face Center
                    p.mesh.lookAt(0, 0, 0);
                    if (p.syncRotation) p.syncRotation();
                    
                    // Reset Animation
                    p.play('idle', 0.1);
                }
            }
            // Reset active player to MF
            const mf = this.players.find(p => p.role === 'MF');
            if (mf) this.setActivePlayer(mf);
        }
    }

    window.flux.Team = Team;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors
    const _aiVec = new THREE.Vector3();
    const _targetPos = new THREE.Vector3();
    const _scanDir = new THREE.Vector3();
    const _scanToOpp = new THREE.Vector3();
    const _tempVec1 = new THREE.Vector3();
    const _tempVec2 = new THREE.Vector3();

    class AIPlayer extends window.flux.Player {
        constructor(scene, role) {
            super(scene, role);
            this.ballRef = null;
            
            // Stats are managed by Team/Main or default Player values.
            this._updateDerivedStats();

            // State Machine
// State Machine
            this.aiState = 'IDLE';
            this.decisionTimer = 0;
            this.decisionInterval = 0.25; // Faster decisions (was 0.5)

            // Stuck Detection
            this.stuckTimer = 0;
            this.lastStuckPos = new THREE.Vector3();
            this.stuckCheckTimer = 0;
            // --- PERCEPTION SYSTEM (Reaction Time) ---
            this.perceivedTargetPos = new THREE.Vector3();
            this.reactionSpeed = 1.5; 
            this.anticipationTime = 0.2; 
            
            // Role Config
            this.isForward = ['LF', 'RF'].includes(role);
            this.isMidfielder = role === 'MF';
            this.isDefender = ['LD', 'RD'].includes(role);

            this.techImmunityTimer = 0;
            this._assignDefaultTechs();
        }

        _assignDefaultTechs() {
            const tackleTechs = ['venom', 'wither', 'drain'];
            const shootTechs = ['venom', 'sphere', 'invisible'];
            const passTechs = ['venom', 'wither', 'nap'];
            const passiveTechs = ['brawler', 'elite_defense'];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const chance = (prob) => Math.random() < prob;

            if (this.isDefender) {
                if (chance(0.3)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.pass = pick(passTechs);
                if (chance(0.2)) this.techs.passive = pick(passiveTechs);
            } else if (this.isMidfielder) {
                if (chance(0.2)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.2)) this.techs.pass = pick(passTechs);
                if (chance(0.1)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            } else if (this.isForward) {
                if (chance(0.3)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

updatePhysics(dt) {
            // Safety: Auto-link ball if missing
            if (!this.ballRef && window.flux.gameInstance && window.flux.gameInstance.entities) {
                this.ballRef = window.flux.gameInstance.entities.ball;
            }

            const game = window.flux.gameInstance;
            const isPractice = game && game.gameMode === 'practice';
            const isActive = game && game.state === 'active';
            
            if (!isActive && !isPractice) {
                this.setInput(0, 0);
                super.updatePhysics(dt);
                return;
            }

            const isDemo = game && game.isDemoMode;
            const isIncapacitated = (this.stunTimer > 0) || (this.status.nap > 0);
            const isHumanTeam = this.team && this.team.isHuman;
            const isActivePlayer = this.team && (this.team.activePlayer === this);
            const shouldRunAI = (!isHumanTeam || isDemo || (isHumanTeam && !isActivePlayer));
            const isTeamAIEnabled = this.team ? this.team.aiEnabled : true;

            if (isIncapacitated) {
                this.setInput(0, 0);
                this.stuckTimer = 0; // Reset stuck if stunned
            } else if (shouldRunAI && isTeamAIEnabled) {
                // --- STUCK DETECTION ---
                this.stuckCheckTimer += dt;
                if (this.stuckCheckTimer > 0.5) {
                    this.stuckCheckTimer = 0;
                    const dist = this.mesh.position.distanceTo(this.lastStuckPos);
                    // If trying to move (input active) but moved very little
                    if (dist < 0.5 && this.inputVector.lengthSq() > 0.1) {
                        this.stuckTimer += 0.5;
                    } else {
                        this.stuckTimer = 0;
                    }
                    this.lastStuckPos.copy(this.mesh.position);
                }

                // Perception Update
                if (this.ballRef && this.ballRef.mesh) {
                    let realTarget = this.ballRef.mesh.position.clone();
                    if (this.ballRef.holder && this.ballRef.holder.mesh) {
                        realTarget = this.ballRef.holder.mesh.position.clone();
                        if (this.ballRef.holder.velocity) {
                            realTarget.addScaledVector(this.ballRef.holder.velocity, this.anticipationTime);
                        }
                    } else if (this.ballRef.velocity) {
                        realTarget.addScaledVector(this.ballRef.velocity, this.anticipationTime * 0.5);
                    }
                    const alpha = Math.min(1.0, dt * this.reactionSpeed);
                    this.perceivedTargetPos.lerp(realTarget, alpha);
                }

                // Decision
                this.decisionTimer += dt;
                if (this.decisionTimer > this.decisionInterval) {
                    this.decisionTimer = 0;
                    this._evaluateState();
                }

                // Execution
                this._executeState(dt);
                
                // Interception
                if (this.techImmunityTimer > 0) this.techImmunityTimer -= dt;
                this._applyInterceptionPressure(dt);

            } else {
                // Human controlled or disabled
                const isDrivenByHuman = isHumanTeam && isActivePlayer && !isDemo;
                if (!isDrivenByHuman) {
                    this.setInput(0, 0);
                }
                this.stuckTimer = 0;
                this._applyInterceptionPressure(dt);
            }

            super.updatePhysics(dt);
        }

        updateVisuals(dt) {
            super.updateVisuals(dt);
        }

_evaluateState() {
            if (!this.ballRef) return;
            const ball = this.ballRef;

            // 1. Possession
            if (this.hasBall) {
                this.aiState = 'ATTACK_CARRY';
                return;
            }

            // 2. Unstuck Priority
            if (this.stuckTimer > 2.0) {
                this.aiState = 'UNSTUCK';
                return;
            }

            // 3. Determine Role relative to Ball (Anti-Swarm)
            const myDistSq = this.mesh.position.distanceToSquared(ball.mesh.position);
            
            // Count teammates closer to ball
            let closerCount = 0;
            if (this.team && this.team.players) {
                for (const p of this.team.players) {
                    if (p === this || !p.mesh || p.role === 'GL' || p.status.nap > 0 || p.stunTimer > 0) continue;
                    if (p.mesh.position.distanceToSquared(ball.mesh.position) < myDistSq) {
                        closerCount++;
                    }
                }
            }

            // 4. Logic
            if (ball.holder) {
                if (ball.holder.team === this.team) {
                    this.aiState = 'SUPPORT';
                } else {
                    // Opponent has ball
                    // Allow 2 chasers max to press
                    if (closerCount < 2) {
                        this.aiState = 'CHASE'; 
                    } else {
                        this.aiState = 'DEFEND'; // Mark or Zone
                    }
                }
            } else {
                // Ball is free
                // Allow 1 chaser max (closest) to avoid collision mess, others support/defend
                if (closerCount < 1) {
                    this.aiState = 'CHASE';
                } else {
                    this.aiState = 'DEFEND'; 
                }
            }
        }

        _executeState(dt) {
            if (!this.ballRef) {
                this.setInput(0, 0);
                return;
            }

            switch (this.aiState) {
case 'ATTACK_CARRY': this._stateAttackCarry(dt); break;
                case 'SUPPORT': this._stateSupport(dt); break;
                case 'DEFEND': this._stateDefend(dt); break;
                case 'CHASE': this._stateChase(dt); break;
                case 'UNSTUCK': this._stateUnstuck(dt); break;
                case 'RETURN_HOME': 
                default: this._stateReturnHome(dt); break;
            }
        }

        _stateUnstuck(dt) {
             // Move in a random direction to break free
             if (Math.random() < 0.1) { 
                 const angle = Math.random() * Math.PI * 2;
                 this.setInput(Math.cos(angle), Math.sin(angle));
                 // Try to dash if stuck
                 if (this.currentEN > 10 && Math.random() < 0.2) {
                     this.dash(Math.cos(angle), Math.sin(angle));
                 }
}
        }

_stateAttackCarry(dt) {
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = goalDist * attackDir;
            
            _targetPos.set(0, 0, goalZ);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);

            const distToGoal = Math.abs(this.mesh.position.z - goalZ);
            
            if (distToGoal < 20.0 && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH'); 
                return;
            }
            
            const isSurrounded = this._isSurrounded();
            const lowEN = this.currentEN < 10;
            const isPlaymaker = this.isMidfielder;
            
            if ((isSurrounded || lowEN || isPlaymaker) && !this.isThrowing) {
                const bestMate = this._findBestPassTarget();
                if (bestMate) {
                    let shouldPass = false;
                    if (isSurrounded || lowEN) {
                        shouldPass = true;
                    } else if (isPlaymaker) {
                        const myDist = Math.abs(this.mesh.position.z - goalZ);
                        const mateDist = Math.abs(bestMate.mesh.position.z - goalZ);
                        if (mateDist < myDist - 5.0) shouldPass = true;
                    }
                    
                    if (shouldPass) {
                        this.mesh.lookAt(bestMate.mesh.position);
                        this._smartThrow(this.ballRef, 'PA');
                        return;
                    }
                }
            }
            
            if (isSurrounded && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH');
            }
        }

        _isSurrounded() {
            let count = 0;
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            for(let p of oppTeam.players) {
                if (p.mesh && p.mesh.position.distanceTo(this.mesh.position) < 4.0) {
                    count++;
                }
            }
            return count >= 2;
        }

        _smartThrow(ball, forcedType = null) {
            let type = forcedType;
            if (!type) {
                _tempVec1.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const attackDir = (this.team && this.team.side === 1) ? -1 : 1;
                const isAimingGoal = (_tempVec1.z * attackDir > 0.5);
                type = isAimingGoal ? 'SH' : 'PA';
            }

            const techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;
            let baseCost = (type === 'SH') ? 20 : 10;
            let techCost = 0;
            
            if (techName) {
                if (techName.includes('nap')) techCost = 30;
                else if (techName.includes('sphere') || techName.includes('invisible')) techCost = 25;
                else techCost = 20;
            }

            const totalCost = baseCost + techCost;
            let tempTech = null;
            if (techName && this.stats.HP < totalCost && this.stats.HP >= baseCost) {
                if (type === 'SH') {
                    tempTech = this.techs.shoot;
                    this.techs.shoot = null;
                } else {
                    tempTech = this.techs.pass;
                    this.techs.pass = null;
                }
            }

            this.throwBall(ball, type);

            if (tempTech) {
                if (type === 'SH') this.techs.shoot = tempTech;
                else this.techs.pass = tempTech;
            }
        }

_stateChase(dt) {
            _targetPos.copy(this.perceivedTargetPos);
            const ball = this.ballRef;
            if (ball.velocity.lengthSq() > 1.0) {
                _targetPos.addScaledVector(ball.velocity, 0.3);
            }
            
            // FIX: Allow entering goal crease if ball is inside it (prevent stuck ball)
            const ballInCrease = this._isPosInCrease(_targetPos);
            if (!ballInCrease) {
                this._avoidGoalCrease(_targetPos);
            }
            
            this._moveTo(_targetPos);

            // AI TACKLE LOGIC
            if (ball && ball.holder && ball.holder.team !== this.team) {
                this._attemptTackle(ball.holder);
            }
        }

        _stateReturnHome(dt) {
            _targetPos.copy(this.homePosition);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateSupport(dt) {
            const ball = this.ballRef;
            const carrier = ball.holder;
            
            if (!carrier || !carrier.mesh) {
                this._stateReturnHome(dt);
                return;
            }

            const ballPos = carrier.mesh.position;
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team.side === 1) ? -goalDist : goalDist;

            const pressure = this._calculatePressureOnPlayer(carrier);

            _targetPos.copy(this.homePosition);
            _targetPos.z += ballPos.z * 0.6;

            if (this.isForward) {
                let targetZ = ballPos.z + (attackDir * 15.0); 
                if (pressure > 0.8) {
                    targetZ = ballPos.z + (attackDir * 8.0);
                }
                const time = Date.now() * 0.001;
                const weave = Math.sin(time + this.mesh.id) * 6.0;
                _targetPos.x = this.homePosition.x + weave;
                _targetPos.z = targetZ;

            } else if (this.isMidfielder) {
                if (pressure > 0.8) {
                    const side = (this.mesh.position.x > ballPos.x) ? 1 : -1;
                    _targetPos.x = ballPos.x + (side * 10.0);
                    _targetPos.z = ballPos.z - (attackDir * 2.0);
                } else {
                    const midZ = (ballPos.z + goalZ) * 0.45;
                    _targetPos.z = midZ;
                    if (ballPos.x < -5) _targetPos.x = 5;
                    else if (ballPos.x > 5) _targetPos.x = -5;
                    else _targetPos.x = (this.homePosition.x > 0 ? 8 : -8);
                }

            } else {
                const safetyDist = 12.0;
                _targetPos.z = ballPos.z - (attackDir * safetyDist);
                if (this.team.side === 1) _targetPos.z = Math.min(38, _targetPos.z);
                else _targetPos.z = Math.max(-38, _targetPos.z);
                _targetPos.x = ballPos.x * 0.6 + this.homePosition.x * 0.4;
            }

            if (this._isPathBlocked(_targetPos, ballPos)) {
                _tempVec1.copy(_targetPos); _tempVec1.x -= 8.0;
                _tempVec2.copy(_targetPos); _tempVec2.x += 8.0;
                
                const blockedL = this._isPathBlocked(_tempVec1, ballPos);
                const blockedR = this._isPathBlocked(_tempVec2, ballPos);
                
                if (!blockedL && !blockedR) {
                    if (Math.abs(_targetPos.x - _tempVec1.x) < Math.abs(_targetPos.x - _tempVec2.x)) {
                        _targetPos.copy(_tempVec1);
                    } else {
                        _targetPos.copy(_tempVec2);
                    }
                } else if (!blockedL) {
                    _targetPos.copy(_tempVec1);
                } else if (!blockedR) {
                    _targetPos.copy(_tempVec2);
                } else {
                    _targetPos.lerp(ballPos, 0.4);
                }
            }

            this._avoidTeammates(_targetPos);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_stateDefend(dt) {
            // Maintain formation or mark
            if (this.marking && this.marking.mesh) {
                // Stick to mark
                const markPos = this.marking.mesh.position;
                const goalZ = (this.team.side === 1) ? 45 : -45; // My goal
                
                // Position between mark and goal (Goal-side marking)
                _targetPos.copy(markPos);
                _tempVec1.set(0, 0, goalZ - markPos.z).normalize();
                _targetPos.addScaledVector(_tempVec1, 2.5); // 2.5m goal-side of mark
                
                // If mark is very close to ball, tighten up
                if (this.ballRef && this.ballRef.holder === this.marking) {
                     _targetPos.lerp(markPos, 0.5);
                }

                this._avoidGoalCrease(_targetPos);
this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);

                // AI TACKLE LOGIC (Opportunistic)
                if (this.ballRef && this.ballRef.holder && this.ballRef.holder.team !== this.team) {
                    const dist = this.mesh.position.distanceTo(this.ballRef.holder.mesh.position);
                    if (dist < 8.0) {
                        this._attemptTackle(this.ballRef.holder);
                    }
                }
                // Zone defense (Formation home + shift towards ball)
                _targetPos.copy(this.homePosition);
                
                // Shift based on ball Z (depth) to compress field
                if (this.ballRef && this.ballRef.mesh) {
                    const ballZ = this.ballRef.mesh.position.z;
                    // Blend home Z and ball Z (0.7 home, 0.3 ball) to shift formation slightly
                    _targetPos.z = this.homePosition.z * 0.7 + ballZ * 0.3; 
                    
                    // Also shift X slightly towards ball side
                    const ballX = this.ballRef.mesh.position.x;
                    _targetPos.x = this.homePosition.x * 0.8 + ballX * 0.2;
                }
                
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
            }
        }

_isPosInCrease(pos) {
            const creaseRadius = 10.0;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goals = [{ x: 0, z: -goalDist }, { x: 0, z: goalDist }];
            for (let g of goals) {
                const dx = pos.x - g.x;
                const dz = pos.z - g.z;
                if (dx*dx + dz*dz < creaseRadius*creaseRadius) return true;
            }
            return false;
        }

        _avoidGoalCrease(targetPos) {
            const creaseRadius = 10.0;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goals = [{ x: 0, z: -goalDist }, { x: 0, z: goalDist }];

            goals.forEach(goal => {
                const dx = targetPos.x - goal.x;
                const dz = targetPos.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < creaseRadius * creaseRadius) {
                    const dist = Math.sqrt(distSq);
                    if (dist > 0.001) {
                        const ratio = creaseRadius / dist;
                        targetPos.x = goal.x + dx * ratio;
                        targetPos.z = goal.z + dz * ratio;
                    } else {
                        targetPos.z = goal.z + (goal.z > 0 ? -creaseRadius : creaseRadius);
                    }
                }
            });

            const arenaRadius = 45.0;
            const dSq = targetPos.x * targetPos.x + targetPos.z * targetPos.z;
            if (dSq > arenaRadius*arenaRadius) {
                const d = Math.sqrt(dSq);
                const r = arenaRadius / d;
                targetPos.x *= r;
                targetPos.z *= r;
            }
        }

        _findBestPassTarget() {
            let bestTarget = null;
            let maxScore = -Infinity;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team.side === 1) ? -goalDist : goalDist;

            for (const mate of this.team.players) {
                if (mate === this) continue;
                if (!mate.mesh) continue;
                if (mate.status.nap > 0) continue;
                if (mate.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(mate.mesh.position);
                if (dist < 4.0) continue;
                if (dist > 30.0) continue;
                
                if (this._isPathBlocked(mate.mesh.position)) continue; 
                
                let score = 0;
                const myDistToGoal = Math.abs(this.mesh.position.z - goalZ);
                const mateDistToGoal = Math.abs(mate.mesh.position.z - goalZ);
                const progress = myDistToGoal - mateDistToGoal;
                
                score += progress * 1.5; 
                if (mateDistToGoal < 15.0) score += 10.0;
                if (mateDistToGoal < 8.0) score += 15.0;

                const openness = this._calculateOpenness(mate);
                score += openness * 3.0;

                if (mate.isForward) score += 5.0;
                score -= dist * 0.5;

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = mate;
                }
            }
            return bestTarget;
        }

        _calculateOpenness(player) {
            let minDefDist = 999;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const d = player.mesh.position.distanceTo(opp.mesh.position);
                if (d < minDefDist) minDefDist = d;
            }
            return Math.min(minDefDist, 8.0);
        }

        _isPathBlocked(targetPos, startPos = null) {
            const start = startPos || this.mesh.position;
            const end = targetPos;
            const dist = start.distanceTo(end);
            
            _scanDir.subVectors(end, start).normalize();
            
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            const safetyRadius = 2.5; 

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                
                _scanToOpp.subVectors(opp.mesh.position, start);
                const projection = _scanToOpp.dot(_scanDir);
                
                if (projection > 0 && projection < dist) {
                    const perpDistSq = _scanToOpp.lengthSq() - (projection * projection);
                    if (perpDistSq < (safetyRadius * safetyRadius)) {
                        return true;
                    }
                }
            }
            return false;
        }

        _moveTo(target) {
            _aiVec.subVectors(target, this.mesh.position);
            _aiVec.y = 0;
            
            const distSq = _aiVec.lengthSq();
            if (distSq > 1.0) {
                _aiVec.normalize();
                this.setInput(_aiVec.x, _aiVec.z);
            } else {
                this.setInput(0, 0);
                this.velocity.multiplyScalar(0.8);
            }
        }

        _applyInterceptionPressure(dt) {
            const ball = this.ballRef;
            if (!ball || !ball.mesh) return;

            if (ball.state !== 'free' || ball.velocity.lengthSq() < 1.0) return;
            if (ball.isInvisible) return;
            if (this.status.nap > 0 || this.stunTimer > 0) return;

            let range = 2.0;
            if (this.techs.passive === 'brawler' || this.techs.passive === 'elite_defense') {
                range += 1.5;
            }

            const dist = this.mesh.position.distanceTo(ball.mesh.position);
            if (dist > range) return;

            _scanToOpp.subVectors(this.mesh.position, ball.mesh.position).normalize();
            _tempVec1.copy(ball.velocity).normalize();
            
            const headingDot = _tempVec1.dot(_scanToOpp);
            if (headingDot < 0.7) return;

            const distFactor = Math.max(0, 1.0 - (dist / range));
            const pressure = 1.5;

            if (ball.power > 0) {
                ball.power -= pressure;
                this._accumulatedBlock = (this._accumulatedBlock || 0) + pressure;
                if (this._accumulatedBlock >= 5.0) { 
                    const val = Math.floor(this._accumulatedBlock);
                    this._accumulatedBlock -= val;
                    if (window.flux.gameInstance.floatingText) { 
                         window.flux.gameInstance.floatingText.spawn(`-${val}`, ball.mesh.position, "block", ball.mesh);
                    }
                }
            }

            if (Math.random() < (distFactor * 0.8)) { 
                _tempVec2.copy(this.mesh.position).lerp(ball.mesh.position, 0.5 + (Math.random()-0.5)*0.2);
                _tempVec2.x += (Math.random()-0.5) * 0.5;
                _tempVec2.y += (Math.random()-0.5) * 0.5;
                _tempVec2.z += (Math.random()-0.5) * 0.5;
                
                if (window.flux.gameInstance.spawnClash) {
                    window.flux.gameInstance.spawnClash(_tempVec2, 0.6);
                }
            }

            if (ball.power <= 0 && ball.powerType === 'SH') {
                ball.powerType = 'none';
                if (window.flux.gameInstance.floatingText) { 
                    window.flux.gameInstance.floatingText.spawn("BLOCKED", this.mesh.position, "comic-impact");
                }
            }

            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                if (tech.type === 'venom') this.applyStatus('venom', 15.0);
                else if (tech.type === 'nap') this.applyStatus('nap', 8.0);
                else if (tech.type === 'wither') this.applyStatus('wither', 15.0, 'BL');
            }
        }

        _calculatePressureOnPlayer(player) {
            if (!player || !player.mesh) return 0;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            
            const oppTeam = (player.team.id === 'home') ? game.teams.away : game.teams.home;
            let pressure = 0;
            
            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const dist = player.mesh.position.distanceTo(opp.mesh.position);
                if (dist < 10.0) {
                    pressure += (10.0 - dist) / 10.0;
                }
            }
            return pressure;
        }

        _avoidTeammates(targetPos) {
            if (!this.team) return;
            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;
                if (mate.hasBall) continue;
                
                const dist = targetPos.distanceTo(mate.mesh.position);
                if (dist < 5.0) {
                    _tempVec1.subVectors(targetPos, mate.mesh.position).normalize();
                    targetPos.addScaledVector(_tempVec1, 5.0 - dist);
                }
            }
}

        _attemptTackle(target) {
            if (this.isTackling || this.isRecovering || this.isDashing || this.stunTimer > 0) return;
            if (this.currentEN < 15) return; // Cost check

            // 1. Predict Target Position (Lead the target)
            // Tackle slide takes ~0.5s. We want to hit them where they will be.
            const leadTime = 0.4; 
            const predictedPos = target.mesh.position.clone();
            if (target.velocity) {
                predictedPos.addScaledVector(target.velocity, leadTime);
            }
            
            // 2. Calculate Vector to Predicted Spot
            const toPred = predictedPos.sub(this.mesh.position);
            toPred.y = 0;
            const dist = toPred.length();
            
            // 3. Range Check
            // Lunge covers ~12 units. Ideally trigger around 6-8 units away.
            if (dist < 8.0 && dist > 2.0) {
                toPred.normalize();
                
                // 4. Angle Check (Must be facing roughly the right way)
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const dot = fwd.dot(toPred);
                
                // 0.85 is ~30 degrees. AI needs to be lined up.
                if (dot > 0.85) {
                    // 5. Reaction Check (Don't tackle instantly every frame)
                    if (Math.random() < 0.15) { // 15% chance per decision frame
                        this.startTackle(toPred.x, toPred.z);
                    }
                }
            }
        }
    }

    window.flux.AIPlayer = AIPlayer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};
    
    // Reusable vectors to avoid GC
const _gVec = new THREE.Vector3();
    const _gPos = new THREE.Vector3();
    const _ballPos = new THREE.Vector3();
    const _faceVec = new THREE.Vector3();
    const _goalCenter = new THREE.Vector3();
    const _tempVecG = new THREE.Vector3();

    class Goalie extends window.flux.Player {
constructor(scene, role) {
            super(scene, role);
            
            // Goalie Specific Stats (Buffed for Playability)
            this.stats.CA = 30; // Catch
            this.stats.SP = 40; // Speed
            this.stats.EN = 50;
            
            // BUFFED: Strong arm for clearing the zone
            this.stats.PA = 45; // Was 20 - Now strong enough to reach midfield
            this.stats.SH = 35; // Was 10 - Decent clearance kick
            
            this._updateDerivedStats();

            // Goal Dimensions (Save Box) - Matches GameManager detection
            this.goalWidth = 22.0; 
            this.goalHeight = 18.0; 
            
            // Save Mechanics
// Config for "Herculean" scale
            this.pressureMultiplier = 5.0; 
            
            // Techs
            this.techs = {
                active: null, 
                passive: null 
            };
            
            // AI State
            this.throwTimer = 0;
            this._accumulatedSave = 0;
            
            // Super Goalie State
            this.isSuperGoalie = false;
            this.superGoalieTimer = 0;

// Perception Smoothing (Reaction Delay)
            this.perceivedBallPos = new THREE.Vector3();
            this.reactionSpeed = 4.0; // Lower = more delay/smoothing
            this.techImmunityTimer = 0;
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            // 1. Super Goalie Timer
            if (this.isSuperGoalie) {
                this.superGoalieTimer -= dt;
                if (this.superGoalieTimer <= 0) {
                    this.isSuperGoalie = false;
                }
            }
            
            // 2. Possession Logic (Ball Held)
            if (this.hasBall) {
                this._checkTacklePressure(dt);
                
const game = window.flux.gameInstance;
                const isHumanControlled = game && this.team && this.team.isHuman && this.team.activePlayer === this && !game.isDemoMode;
                
                if (isHumanControlled) {
                    super.updatePhysics(dt);
                } else {
                    if (!this.isThrowing) {
                        this._aiPossessionLogic(dt);
                    }
                    this.setInput(0, 0);
                    super.updatePhysics(dt);
                }
                this._constrainBounds();
                return; 
            }

            // 3. Defense / Save Logic (No Ball)
            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            
            this._updateStatusLogic(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                this._constrainBounds();
                return;
            }

            this._defenseLogic(dt);
            this._constrainBounds();
        }

        updateVisuals(dt) {
            if (this.hasBall) {
                super.updateVisuals(dt);
                return;
            }

            this._updateStatusVisuals(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                if (this.mixer) this.mixer.update(dt);
                this._updateHPBar();
                return;
            }

            if (this.mixer) this.mixer.update(dt);
            this._updateHPBar();
        }

_constrainBounds() {
            if (!this.mesh) return;
            const pos = this.mesh.position;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;

            const side = this.team ? this.team.side : 1;
            // X Bounds (Width of penalty area +/- 10m) -> Increased for massive goal
const xLimit = 20.0; // Reduced width of goalie movement
            if (pos.x > xLimit) { pos.x = xLimit; this.velocity.x = 0; }
            if (pos.x < -xLimit) { pos.x = -xLimit; this.velocity.x = 0; }
            
            // Y Bounds
// Y Bounds (Expanded for deeper goal)
            const yLimit = 18.0; 
            if (pos.y > yLimit) { pos.y = yLimit; this.velocity.y = 0; }
            if (pos.y < -yLimit) { pos.y = -yLimit; this.velocity.y = 0; }
            
            // Z Bounds (Depth)
// Z Bounds (Depth)
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (side === 1) {
                if (pos.z > goalDist - 0.5) { pos.z = goalDist - 0.5; this.velocity.z = 0; }
                if (pos.z < 20.0) { pos.z = 20.0; this.velocity.z = 0; }
            } else {
                if (pos.z < -goalDist + 0.5) { pos.z = -goalDist + 0.5; this.velocity.z = 0; }
                if (pos.z > -20.0) { pos.z = -20.0; this.velocity.z = 0; }
            }
        }

// Override throwBall to fix "weak throw" issue
// Override throwBall to fix "weak throw" issue and reduce loft
        throwBall(ball, forcedType = null, powerMultiplier = 1.0) {
            if (!this.hasBall || this.isThrowing) return;
            
            this.isThrowing = true;
            const type = forcedType || 'PA';
            const boost = 1.2;
            const finalPower = powerMultiplier * boost;

            // Animation
            const throwKey = (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' : 'throw_pass';
            this.playOneShot(throwKey, 0.1, { timeScale: 1.2 });

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CLEAR!", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                if (this.hasBall || (ball && ball.holder === this)) {
                    // Calculate Direction
                    const finalDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    
                    // REDUCED LOFT: Goalie throws flatter (0.25 instead of 0.8)
                    finalDir.y += 0.25; 
                    finalDir.normalize();

                    // Calculate Stats
                    let statVal = this.getStat(type);
                    statVal *= finalPower;

                    ball.shoot(finalDir, statVal, type);
// Duplicate removed
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addRecoil(
                            -finalDir.x * 2.0, 
                            -0.5, 
                            -finalDir.z * 2.0
                        );
                    }
                    // Extra grace period for Goalie
                    ball.catchGracePeriod = 0.6;

this.loseBall(1.0);
                }
            }, 300); // Windup time

            setTimeout(() => {
                this.isThrowing = false;
                this._updateLocomotionAnim(0.2);
            }, 800);
        }

_defenseLogic(dt) {
            // 0. Game State Check
if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            const ball = (window.flux.gameInstance && window.flux.gameInstance.entities) ? window.flux.gameInstance.entities.ball : null;
            if (!ball || !ball.mesh) return;

            // --- PERCEPTION UPDATE ---
            // Smoothly interpolate perceived position towards real ball position
            // This creates a natural reaction delay and prevents jittery mirroring
            this.perceivedBallPos.lerp(ball.mesh.position, dt * this.reactionSpeed);

            // Determine Threat Source
            let threatPos = _ballPos;
            let isThreat = false;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const myGoalZ = (this.team.side === 1) ? goalDist : -goalDist;

            // Case A: Ball is Held (Pre-throw)
            if (ball.state === 'held' && ball.holder && ball.holder.team !== this.team) {
                // Track holder, but use perceived position if we wanted to simulate reading the player
                // For now, tracking the ball (which is on the player) via perceivedPos is sufficient
                threatPos = this.perceivedBallPos;
                
                // Check if holder is in attacking half or near enough
                const distToGoal = Math.abs(threatPos.z - myGoalZ);
                if (distToGoal < 40.0) { // If they are within 40m, track them
                    isThreat = true;
                }
            } 
            // Case B: Ball is Free (Shot/Pass)
            else if (ball.state === 'free') {
                threatPos = this.perceivedBallPos;
                
                // Direction Check
                const movingTowards = (this.team.side === 1 && ball.velocity.z > 0) || 
                                      (this.team.side === -1 && ball.velocity.z < 0);
                
                // Position Check
                const inFrontOfGoal = (this.team.side === 1 && threatPos.z < 45.0) || 
                                      (this.team.side === -1 && threatPos.z > -45.0);

                isThreat = movingTowards && inFrontOfGoal;
            }
            if (isThreat) {
                // --- POSITIONING: ANGLE CUTTING ---
                _ballPos.copy(threatPos); // Update reference for lookAt
                
                // 1. Calculate Goal Center
// 1. Calculate Goal Center (Adjusted for Y offset)
// 1. Calculate Goal Center (Adjusted for new Y offset -8.0)
                _goalCenter.set(0, -8.0, myGoalZ);
                
                // 2. Vector from Goal to Ball
                _tempVecG.subVectors(_ballPos, _goalCenter);
                const distToBall = _tempVecG.length();
                _tempVecG.normalize(); // Now holds direction
                
                // 3. Determine Extension (How far out to step)
                // Base: 1.5m off line.
                // Max: 6.0m off line (Cutting angle).
                // Scale based on ball proximity: Closer ball = More extension (to a point)
let extension = 1.5;
                if (distToBall < 30.0) {
                    const ratio = 1.0 - (Math.max(0, distToBall - 5.0) / 25.0); 
                    extension = 1.5 + (4.5 * ratio); 
                }
                
// Safety: Don't go past the ball (keep 1m buffer)
                extension = Math.min(extension, distToBall - 1.0);
                
                // 4. Calculate Target Position (Base Interception)
                _gPos.copy(_goalCenter).add(_tempVecG.multiplyScalar(extension));
                
                // 5. Vertical Override (Jump to meet ball)
                // Explicitly set Y to match ball height if it's high
                if (_ballPos.y > 0.5) {
                    _gPos.y = _ballPos.y;
                } else {
                    _gPos.y = 0.5; // Default stance
                }

                // 6. Clamp to Goal Box Dimensions (Lateral/Vertical Limits)
                // Goal Width 22 (+/- 11), Height 18 (+/- 9).
                // Allow slightly outside posts to cover angles.
                const clampX = this.goalWidth * 0.6; // +/- 13.2
const clampY = 18.0; // Increased max jump height
                
                _gPos.x = Math.max(-clampX, Math.min(clampX, _gPos.x));
                _gPos.y = Math.max(-clampY, Math.min(clampY, _gPos.y));
                
                // 6. Lead the ball slightly if it has lateral velocity (Anticipation)
if (ball.velocity.lengthSq() > 1.0) {
                    const anticipation = ball.velocity.clone().multiplyScalar(0.25); // 0.25s lead
                    anticipation.z = 0; // Only lateral lead
                    _gPos.add(anticipation);
                }

                // CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (this.team.side === 1) {
                _gPos.z = Math.min(goalDist - 0.5, _gPos.z);
            } else {
                _gPos.z = Math.max(-goalDist + 0.5, _gPos.z);
            }

                // Move towards target
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                const distToTarget = moveDir.length();
                
                if (distToTarget > 0.1) {
                    moveDir.normalize();
                    // Burst speed for saves if ball is close
                    const urgency = (distToBall < 10.0) ? 1.5 : 1.0;
                    const speed = this.maxSpeed * urgency;
                    
                    this.mesh.position.add(moveDir.multiplyScalar(speed * dt));
                    
                    // Face ball
                    this.mesh.lookAt(_ballPos);
                    
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                    this.mesh.lookAt(_ballPos);
                }

                // --- SAVE MECHANIC ---
                // If ball is within range, apply CA pressure
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < this.saveRadius) { 
                    this._applySavePressure(ball, dt);
                }
            } else {
                // --- IDLE / RETURN TO POST ---
                // Return to home position (usually center of goal)
                _gPos.copy(this.homePosition);
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                
                if (moveDir.length() > 0.5) {
                    moveDir.normalize();
                    this.mesh.position.add(moveDir.multiplyScalar(this.maxSpeed * 0.6 * dt));
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                }
                
                // Face center field
                this.mesh.lookAt(0, 0, 0);
            }
        }

        _applySavePressure(ball, dt) {
            // If Goalie is Asleep, they cannot save.
            if (this.status.nap > 0) return;

            // --- SUPER GOALIE TRIGGER ---
            // Trigger if: Tech equipped, Not active, Ball has power, Ball is close
            if (this.techs.active === 'super_goalie' && !this.isSuperGoalie && ball.power > 5.0) {
                // Chance to trigger (High chance for AI, or check HP)
                // Cost: 10 HP
                if (this.stats.HP >= 10) {
                    this.stats.HP -= 10;
                    this.isSuperGoalie = true;
                    this.superGoalieTimer = 1.5; // Lasts 1.5s
                    
                    console.log(`${this.role} used SUPER GOALIE!`);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SUPER GOALIE!", this.mesh.position, "save");
                    }
                    
                    // Trigger Techcopy Event
                    if (window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, 'super_goalie');
                    }
                }
            }

            // Calculate Effective CA
            let ca = this.getStat('CA');
            
            // Apply Super Goalie Bonus (e.g. +50% + Flat 10)
            if (this.isSuperGoalie) {
                ca = (ca * 1.5) + 10;
            }
            
            // Apply Grip Gloves (Passive)
            if (this.techs.passive === 'grip_gloves') {
                ca += 5;
            }

            // Calculate Pressure
            // Pressure = CA * dt * Multiplier
            const pressure = ca * dt * this.pressureMultiplier;
            
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback
                this._accumulatedSave += pressure;
                // THROTTLE: Increased threshold to 12.0
                if (this._accumulatedSave >= 12.0) { 
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "comic-impact");
                    }
                    this._accumulatedSave = 0;
                }
            }

            // Apply Ball Technique to Goalie (Risk of catching special shots)
// Apply Ball Technique to Goalie (Risk of catching special shots)
            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'CA');
                }
            }

            // Check Result
            if (ball.power <= 0 && this.status.nap <= 0) {
                // CATCH
                this.catchBall(ball);
            }
        }

        catchBall(ball) {
            ball.grab(this);
            this.play('catch', 0.1);
            console.log("SAVED by " + this.role);
            
            // EXP REWARD: Save
            this.gainExp(5);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SAVED!", this.mesh.position, "comic-impact");
            }
            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.15, 'heavy');
            
            // Reset throw timer
            this.throwTimer = 0;
        }

_aiPossessionLogic(dt) {
            this.throwTimer += dt;
            
            // Hold for a moment (1.5s) then throw
            if (this.throwTimer > 1.5) {
                // Find best target: Prefer MF or Defenders, but must be somewhat distant to avoid "handoff" look
                // Filter for teammates > 8 units away if possible
                const validMates = this.team.players.filter(p => 
                    p !== this && 
                    p.mesh && 
                    p.mesh.position.distanceTo(this.mesh.position) > 8.0
                );

                let target = null;

                // Priority 1: Midfielder (Playmaker)
                target = validMates.find(p => p.role === 'MF');
                
                // Priority 2: Defenders
                if (!target) target = validMates.find(p => p.role === 'LD' || p.role === 'RD');
                
                // Priority 3: Anyone open (fallback to close range if no one is far)
                if (!target) target = this.team.players.find(p => p !== this && p.role !== 'GL');

                if (target && target.mesh) {
                    // AIMING LOGIC: Loft the pass
                    // Look at target, but aim slightly up to create an arc
                    const targetPos = target.mesh.position.clone();
                    
                    // Calculate distance
                    const dist = this.mesh.position.distanceTo(targetPos);
                    
                    // Loft factor: The further away, the higher we aim
                    // 20 units away -> Aim 5 units above head
                    const loft = Math.max(1.0, dist * 0.25);
                    targetPos.y += loft;

                    this.mesh.lookAt(targetPos);
                    
                    // Throw
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'PA'); 
                    console.log(`${this.role} throws to ${target.role} (Dist: ${dist.toFixed(1)})`);
                } else {
                    // Clear it forward
                    this.mesh.lookAt(0, 5, 0); // Aim up-center
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'SH'); // Hard clear
                }
                
                this.throwTimer = 0;
            }
        }
    }

    window.flux.Goalie = Goalie;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable math vectors to avoid GC
const _bVec = new THREE.Vector3();
    const _bDir = new THREE.Vector3();
    const _axisY = new THREE.Vector3(0, 1, 0);
    const _tempVec = new THREE.Vector3();
    const _magnusVec = new THREE.Vector3();

// Physics Configuration (Exposed for DevTools)
window.flux.BallConfig = {
        // -----------------------------------------------------------------
        // Core integration
        // -----------------------------------------------------------------
        SUBSTEPS: 2,
        STOP_SPEED: 0.02,

        // -----------------------------------------------------------------
        // Water resistance
        // -----------------------------------------------------------------
        WATER_DRAG_LINEAR: 0.15,
        WATER_DRAG_QUAD: 0.002,

        // -----------------------------------------------------------------
        // Spin & curve
        // -----------------------------------------------------------------
        SPIN_DRAG: 0.4,
        MAGNUS_ENABLED: true,
        MAGNUS_COEFF: 0.08,
        MAGNUS_CAP: 60,

        // -----------------------------------------------------------------
        // Depth constraint
        // -----------------------------------------------------------------
        DEPTH_TARGET_Y: 0,
        DEPTH_SPRING: 1,
        DEPTH_DAMP: 1.5,

        // -----------------------------------------------------------------
        // Arena boundary
        // -----------------------------------------------------------------
        BOUNDARY_RADIUS: 46,
        BOUNDARY_HEIGHT: 20,
        
        // Goal Settings
        GOAL_DISTANCE: 41.5,
        GOAL_Y_OFFSET: -2.31,
        GOAL_SCALE: 45,
        GOAL_SCALE_X: 1.3456,
        GOAL_SCALE_Y: 1,
        GOAL_SCALE_Z: 1,
        
        // Goal Trigger (Hitbox)
        GOAL_TRIGGER_TOP_Y: 9.1555,
        GOAL_TRIGGER_BOTTOM_Y: -4.3555,
        GOAL_TRIGGER_WIDTH: 17.1,
        GOAL_TRIGGER_OFFSET: 1,

        // Goal Pocket
        GOAL_POCKET_ENABLED: true,
        GOAL_POCKET_X: 12,
        GOAL_POCKET_Z: 40,
        GOAL_POCKET_RADIUS: 55,

        // Walls
        WALL_SOFT_BUFFER: 3,
        WALL_SOFT_FORCE: 20,
        WALL_ELASTICITY: 0.3,
        WALL_FRICTION: 0.95,
        FLOOR_ELASTICITY: 0.4,

        // -----------------------------------------------------------------
        // Throw mapping
        // -----------------------------------------------------------------
        LAUNCH_SPEED_SCALE: 1,
        LAUNCH_SPEED_CAP: 85
    };


    
    const C = window.flux.BallConfig; // Local alias for brevity
    // --- TRAIL RENDERER ---
// --- TRAIL RENDERER ---
    class TrailRenderer {
        constructor(scene) {
            this.scene = scene;
            this.segments = 30; // More segments for smoother curves
            this.points = [];
this.baseWidth = 0.8; // Increased width for visibility
            this.currentWidth = 0.8;
            
            // Geometry
            const geometry = new THREE.BufferGeometry();
            const posData = new Float32Array(this.segments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(posData, 3));
            
            // Indices
            const indices = [];
            for (let i=0; i<this.segments-1; i++) {
                const base = i*2;
                indices.push(base, base+1, base+2);
                indices.push(base+1, base+3, base+2);
            }
            geometry.setIndex(indices);
            
            this.material = new THREE.MeshBasicMaterial({
                color: 0x00aaff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.scene.add(this.mesh);
            
            // Init points
            for(let i=0; i<this.segments; i++) this.points.push(new THREE.Vector3());
            this.active = false;

            // Reusable temps (avoid per-frame allocations on mobile)
            this._tmpDir = new THREE.Vector3();
            this._tmpToCam = new THREE.Vector3();
            this._tmpRight = new THREE.Vector3();
        }
        
        reset(pos) {
            for(let i=0; i<this.segments; i++) this.points[i].copy(pos);
            this.updateGeometry();
        }
        
        setColor(hex) {
            this.material.color.setHex(hex);
        }
        
        update(currentPos, speedRatio = 0.0) {
            if (!this.active) {
                this.reset(currentPos);
                return;
            }

// Dynamic Width based on speed AND SPIN (Power Visual)
            // Fast ball = Thicker. Spinning ball = Even Thicker.
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;
            const spinRatio = ball ? Math.min(1.0, ball.angularVelocity.length() / 30.0) : 0;
            
            const targetWidth = this.baseWidth * (0.8 + speedRatio * 1.2 + spinRatio * 2.0);
            this.currentWidth += (targetWidth - this.currentWidth) * 0.2; // Smooth transition

            // Shift points
            for (let i = this.segments - 1; i > 0; i--) {
                this.points[i].copy(this.points[i-1]);
            }
            this.points[0].copy(currentPos);
            
            this.updateGeometry();
        }
        
        updateGeometry() {
            const positions = this.mesh.geometry.attributes.position.array;
            const cam = window.flux.gameInstance ? window.flux.gameInstance.camera : null;
            if (!cam) return;
            const camPos = cam.position;
            const tempDir = this._tmpDir;
            const tempToCam = this._tmpToCam;
            const tempRight = this._tmpRight;
            for (let i=0; i<this.segments; i++) {
                const p = this.points[i];
                
                // Taper width along trail length
                const taper = 1.0 - Math.pow(i / this.segments, 2); // Quadratic taper
                const w = this.currentWidth * taper;
                
                // Calculate direction
                if (i < this.segments - 1) {
                    tempDir.subVectors(this.points[i], this.points[i+1]);
                } else {
                    tempDir.subVectors(this.points[i-1], this.points[i]);
                }
                
                if (tempDir.lengthSq() < 0.0001) tempDir.set(0, 1, 0);
                tempDir.normalize();
                
                tempToCam.subVectors(camPos, p).normalize();
                tempRight.crossVectors(tempDir, tempToCam).normalize().multiplyScalar(w);
                
                // Vert 1
                positions[i*6 + 0] = p.x - tempRight.x;
                positions[i*6 + 1] = p.y - tempRight.y;
                positions[i*6 + 2] = p.z - tempRight.z;
                
                // Vert 2
                positions[i*6 + 3] = p.x + tempRight.x;
                positions[i*6 + 4] = p.y + tempRight.y;
                positions[i*6 + 5] = p.z + tempRight.z;
            }
this.mesh.geometry.attributes.position.needsUpdate = true;
        }
    }

    // C is already defined in the outer scope
    class Ball {

        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.holder = null; 
            this.lastHolder = null; // Track who threw it last (for EXP/Assists)
            
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.angularVelocity = new THREE.Vector3(0, 0, 0);
            this.state = 'free'; // 'free', 'held', 'magnetized'
            this.isInvisible = false;
this.isInvisible = false;
            this.isRicochet = false;
            this.homingTarget = null;
            // Continuous Stats
            this.power = 0;      // Current PA or SH value
            this.powerType = 'none'; // 'PA' or 'SH'
            this.decayRate = 3.0; // Stat points lost per second (Water resistance)
            this.catchGracePeriod = 0; // Time before ball can be caught again

            // Magnet System
            this.magnetTarget = null;
            this.magnetTimer = 0;
            this.magnetDuration = 0.2; 
            this.magnetStartPos = new THREE.Vector3();
            this.magnetStartVel = new THREE.Vector3();

            // Visuals (Squash & Stretch)
            this.accumulatedRotation = new THREE.Quaternion();
            this.deformNode = null;
            this.spinNode = null;
            this.model = null;

this.initMesh();
            this.trail = new TrailRenderer(scene);
// Duplicate removed
            
            // Failsafe Timers
            this.stuckTimer = 0;
            this.outOfBoundsTimer = 0;
}

        initMesh() {
            // Hierarchy: Mesh (Pos) -> Deform (Squash/Stretch) -> Spin (Rotation) -> Model
            this.mesh = new THREE.Group();
            this.scene.add(this.mesh);

this.deformNode = new THREE.Group();
            this.deformNode.position.y = 0.0; // Reset offset so ball is centered on mesh position
            this.mesh.add(this.deformNode); // Fix: Add deformNode to mesh

            this.spinNode = new THREE.Group();
            this.deformNode.add(this.spinNode);

            // Procedural Placeholder Texture (Blitzball-ish)
            const placeholderTex = (() => {
                const c = document.createElement('canvas');
                c.width = 128; c.height = 64;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0,0,128,64);
                
                // Blue bumps/details
                ctx.fillStyle = '#0088ff';
                for(let i=0; i<6; i++) {
                    ctx.beginPath();
                    ctx.arc(i*25, 32, 10, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#004488';
                ctx.fillRect(0, 28, 128, 8); // Stripe
                
                return new THREE.CanvasTexture(c);
            })();

            // Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
const geometry = new THREE.SphereGeometry(0.3, 16, 16); // Scaled down ~15%
            const material = new THREE.MeshBasicMaterial({
                map: placeholderTex,
                color: 0xffffff, 
                wireframe: false, // Solid
                transparent: false,
                opacity: 1.0
            });
            this.placeholder = new THREE.Mesh(geometry, material);

            // Load GLB Model
            const url = 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb';
            
            window.flux.AssetLoader.loadModel(url, (gltf) => {
                console.log("DEBUG: Ball GLB loaded.", gltf);
                
                const model = gltf.scene;

                // 1. Reset root transforms
                model.position.set(0, 0, 0);
                model.rotation.set(0, 0, 0);
                model.scale.set(1, 1, 1);
                model.updateMatrixWorld(true);

                // 2. Harden Materials & Visibility
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // CRITICAL: Prevent culling if bounds are off
                        
                        if (node.material) {
                            const mats = Array.isArray(node.material) ? node.material : [node.material];
                            mats.forEach(m => {
                                m.color.setHex(0xffffff); // Force white base
                                m.side = THREE.DoubleSide;
                                m.transparent = false;
                                m.opacity = 1.0;
                                m.alphaTest = 0; // CRITICAL: Disable alpha test to prevent culling
                                m.depthWrite = true;
                                m.depthTest = true;
                            });
                        }
                    }
                });

                // 3. Compute Bounding Box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // 4. Validation
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim <= 0.001 || !isFinite(maxDim)) {
                    console.warn("Ball model has invalid dimensions. Keeping placeholder.");
                    return; 
                }

                // 5. Calculate Scale
// 5. Calculate Scale
const targetDiameter = 0.72; // Reduced scale by ~15% (was 0.85)
                const scaleFactor = targetDiameter / maxDim;

                // 6. Apply Transforms
                model.scale.setScalar(scaleFactor);
                model.position.copy(center).multiplyScalar(-scaleFactor);

                // 7. Swap Placeholder
                if (this.placeholder) {
                    this.spinNode.remove(this.placeholder);
                    if (this.placeholder.geometry) this.placeholder.geometry.dispose();
                    this.placeholder = null;
                }

                this.model = model;
                this.spinNode.add(this.model);
                console.log(`Blitzball model attached. Scale: ${scaleFactor.toFixed(4)}`);

            }, undefined, (err) => {
                console.error("Failed to load Blitzball model:", err);
                // Fallback: Keep placeholder but tint it red to indicate error
                if (this.placeholder) {
                    this.placeholder.material.color.setHex(0xffaaaa);
                }
            });
        }

update(dt) {
            // Wrapper for backward compatibility
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Physics control)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this && typeof __lab.applyReplayFrame === 'function') {
                __lab.applyReplayFrame(this, dt);
                return;
            }

            // Safety: Reset if position corrupted
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                this.reset();
                return;
            }

            // Safety: Fix "Unpickable Ball" Bug
            if (this.state === 'held' && (!this.holder || !this.holder.mesh)) {
                this.drop();
            }
            if (this.state === 'magnetized') {
                if (!this.magnetTarget || !this.magnetTarget.mesh) {
                    this.drop();
                }
                if (this.magnetTimer > 2.0) {
                    console.warn("Ball stuck in magnetized state. Dropping.");
                    this.drop();
                }
            }
            if (this.state === 'free' && this.holder !== null) {
                this.holder = null;
            }
            if (this.state === 'free' && this.velocity.lengthSq() < 0.5) {
                this.catchGracePeriod = 0;
            }

            if (this.state === 'held' && this.holder && this.holder.mesh) {
                this.updateHeld(dt);
            } else if (this.state === 'magnetized') {
                this.updateMagnetized(dt);
            } else {
                this._updateFreePhysics(dt);
            }
            
if (this.catchGracePeriod > 0) {
                this.catchGracePeriod -= dt;
                if (this.catchGracePeriod < 0) this.catchGracePeriod = 0;
            }

            this._checkFailsafes(dt);
        }

        updateVisuals(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Visuals)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this) {
                if (this.trail) this.trail.active = false;
                this._updateVisualTransforms(dt);
                return;
            }

            if (this.trail) {
                const speed = this.velocity.length();
                this.trail.active = (this.state === 'free' && speed > 2.0);
                
                _bVec.copy(this.mesh.position);
                if (this.deformNode) _bVec.y += this.deformNode.position.y;

                const ratio = Math.min(speed / 60.0, 1.0);
                this.trail.update(_bVec, ratio);
            }

            this._updateVisualTransforms(dt);
            this._updateParticles(dt);
            
            if (this.mesh && !this.isInvisible) {
                this.mesh.visible = true;
                if (this.model) this.model.visible = true;
            }
        }

magnetize(target) {
            if (this.state === 'magnetized' || this.state === 'held') return;
            
            this.state = 'magnetized';
            this.magnetTarget = target;
            this.holder = target; // Logical possession so AI reacts
            this.magnetTimer = 0;
            this.magnetStartPos.copy(this.mesh.position);
            this.magnetStartVel.copy(this.velocity);
            
            // Dynamic Duration based on distance (Smoother for long range, snappy for close)
            const dist = this.mesh.position.distanceTo(target.mesh.position);
            this.magnetDuration = Math.max(0.15, Math.min(0.4, dist / 15.0));
            
            // Kill physics
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // Notify player immediately so they stop chasing and play animation
            if (target.receiveBall) {
                target.receiveBall();
            }

this.reveal();
            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch', { volume: 0.6 });
            }
        }

updateMagnetized(dt) {
            if (!this.magnetTarget || !this.magnetTarget.mesh) {
                this.drop();
                return;
            }

            this.magnetTimer += dt;
            
            // Normalized Time
            let t = this.magnetTimer / this.magnetDuration;
            if (t > 1.0) t = 1.0;

            // Target "Virtual Hand" Position (Front of Chest)
            const holderPos = this.magnetTarget.mesh.position;
            const holderQuat = this.magnetTarget.mesh.quaternion;
            
            // Offset: Forward 0.6, Up 1.0 (Chest height)
            const offset = _bVec.set(0, 1.0, 0.6).applyQuaternion(holderQuat);
            const targetPos = offset.add(holderPos);

            // --- QUADRATIC BEZIER CURVE ---
            // P0 = Start, P2 = Target
            // P1 = Control Point (Projected along initial velocity to preserve momentum feel)
            
            const p0 = this.magnetStartPos;
            const p2 = targetPos;
            
            // Calculate P1 (Control Point)
            // Project forward from P0 along start velocity vector
            // Distance of projection = 40% of total distance to target
            const dist = p0.distanceTo(p2);
            const p1 = _tempVec.copy(p0);
            
            const velLen = this.magnetStartVel.lengthSq();
            if (velLen > 1.0) {
                // Use velocity tangent
// Use velocity tangent
                _bDir.copy(this.magnetStartVel).normalize();
                p1.add(_bDir.multiplyScalar(dist * 0.4));
            } else {
                // No velocity (stationary ball), arc upwards slightly
                p1.lerp(p2, 0.5);
                p1.y += 1.5; 
            }

            // Bezier: B(t) = (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            const oneMinusT = 1.0 - t;
            const w0 = oneMinusT * oneMinusT;
            const w1 = 2.0 * oneMinusT * t;
            const w2 = t * t;
            
            this.mesh.position.x = (w0 * p0.x) + (w1 * p1.x) + (w2 * p2.x);
            this.mesh.position.y = (w0 * p0.y) + (w1 * p1.y) + (w2 * p2.y);
            this.mesh.position.z = (w0 * p0.z) + (w1 * p1.z) + (w2 * p2.z);

            // Finish
            if (t >= 1.0) {
                this.grab(this.magnetTarget);
            }
        }

updateHeld(dt) {
            // ATTACHED STATE (Virtual Attachment)
            if (!this.holder || !this.holder.mesh) {
                this.drop();
                return;
            }

            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // 1. Try to use Hand Bone if available (Realism)
            if (this.holder.handBone) {
                // Get world position of the hand bone
                this.holder.handBone.getWorldPosition(this.mesh.position);
                
                // Adjust slightly to sit IN the hand rather than ON the wrist
                // We can't easily know "forward" for the bone without more info, 
                // but usually GLTF bones are oriented. For now, exact bone pos is better than chest.
            } else {
                // 2. Fallback: Calculate "Carrying" Position (Right Hand Side)
                // Relative to player: Up 0.8 (Waist/Chest), Right 0.4, Forward 0.5
                const holderPos = this.holder.mesh.position;
                const holderQuat = this.holder.mesh.quaternion;
                
                // Reuse _bVec
// Reuse _bVec
                // Offset: x=0.35 (Right), y=1.3 (Chest/Hands), z=0.5 (Forward)
                _bVec.set(0.35, 1.3, 0.5).applyQuaternion(holderQuat);
                this.mesh.position.copy(holderPos).add(_bVec);
            }

// Visual Flair: Spin the ball slowly
            const rotX = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), 2 * dt);
            const rotY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), 5 * dt);
            this.accumulatedRotation.multiply(rotX).multiply(rotY);
        }


updateFree(dt) {
            // Legacy wrapper
            this._updateFreePhysics(dt);
            this._updateParticles(dt);
            this._updateVisualTransforms(dt);
        }

_updateFreePhysics(dt) {
            // Homing Logic (Steering)
            if (this.homingTarget && this.velocity.lengthSq() > 1.0) {
                _tempVec.subVectors(this.homingTarget, this.mesh.position).normalize();
                const currentSpeed = this.velocity.length();
                const steerRate = 2.5 * dt; // Turn rate
                this.velocity.lerp(_tempVec.multiplyScalar(currentSpeed), steerRate);
                this.velocity.normalize().multiplyScalar(currentSpeed); // Maintain speed
            }

const C = window.flux.BallConfig || {};
const substeps = (C.SUBSTEPS || 1);
            const stepDt = dt / substeps;

            for (let s = 0; s < substeps; s++) {
                // A) Magnus effect
                if (C.MAGNUS_ENABLED && this.angularVelocity && this.velocity) {
                    const spinSq = this.angularVelocity.lengthSq();
                    const velSq = this.velocity.lengthSq();
                    if (spinSq > 0.25 && velSq > 0.25) {
                        _magnusVec.copy(this.angularVelocity).cross(this.velocity).multiplyScalar((C.MAGNUS_COEFF || 0) * stepDt);
                        const cap = (C.MAGNUS_CAP !== undefined ? C.MAGNUS_CAP : 60.0);
                        const magLen = _magnusVec.length();
                        if (magLen > cap) _magnusVec.multiplyScalar(cap / magLen);
                        this.velocity.add(_magnusVec);
                    }
                }

                // B) Spin decay
                if (this.angularVelocity) {
                    const spinDrag = Math.max(0, 1.0 - (C.SPIN_DRAG || 0) * stepDt);
                    this.angularVelocity.multiplyScalar(spinDrag);
                }

                // C) Depth spring
                const targetY = (C.DEPTH_TARGET_Y !== undefined ? C.DEPTH_TARGET_Y : 0.0);
                const yErr = (this.mesh.position.y - targetY);
                this.velocity.y -= yErr * (C.DEPTH_SPRING || 0) * stepDt;
                this.velocity.y *= Math.max(0, 1.0 - (C.DEPTH_DAMP || 0) * stepDt);

                // D) Drag
                const vLen = this.velocity.length();
                if (vLen > 0.00001) {
                    const lin = (C.WATER_DRAG_LINEAR !== undefined ? C.WATER_DRAG_LINEAR : (C.WATER_DRAG || 0)) * stepDt;
                    const quad = (C.WATER_DRAG_QUAD || 0) * vLen * stepDt;
                    const drag = Math.max(0, 1.0 - lin - quad);
                    this.velocity.multiplyScalar(drag);

                    const stop = (C.STOP_SPEED || 0);
                    if (stop > 0 && this.velocity.lengthSq() < stop * stop) {
                        this.velocity.set(0, 0, 0);
                    }
                }

                // E) Move
                _tempVec.copy(this.velocity).multiplyScalar(stepDt);
                this.mesh.position.add(_tempVec);

                // F) Stat power decay
                if (this.power > 0) {
                    this.power -= this.decayRate * stepDt;
                    if (this.power < 0) this.power = 0;
                }

                // G) Boundary logic
                const pos = this.mesh.position;
                const distXZ = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
                const boundaryRadius = (C.BOUNDARY_RADIUS !== undefined ? C.BOUNDARY_RADIUS : 33.0);
                let effectiveBoundary = boundaryRadius;

                if (C.GOAL_POCKET_ENABLED) {
                    const inGoalPocket = (Math.abs(pos.x) < (C.GOAL_POCKET_X || 12.0) && Math.abs(pos.z) > (C.GOAL_POCKET_Z || 25.0));
                    if (inGoalPocket) effectiveBoundary = (C.GOAL_POCKET_RADIUS || 45.0);
                }

                const softBuffer = Math.max(0.01, (C.WALL_SOFT_BUFFER !== undefined ? C.WALL_SOFT_BUFFER : 3.0));

                if (distXZ > effectiveBoundary - softBuffer) {
                    const penetration = distXZ - (effectiveBoundary - softBuffer);
                    const ratio = Math.max(0, Math.min(1, penetration / softBuffer));
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) {
                        _tempVec.normalize();
                        const force = ratio * ratio * (C.WALL_SOFT_FORCE || 0) * stepDt;
                        this.velocity.addScaledVector(_tempVec, force);
                    }
                }

                if (distXZ > effectiveBoundary) {
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) _tempVec.normalize();
                    const overlap = distXZ - effectiveBoundary;
                    pos.addScaledVector(_tempVec, overlap);
                    const vDotN = this.velocity.dot(_tempVec);
                    if (vDotN < 0) {
                        const impactSpeed = Math.abs(vDotN);
                        if (impactSpeed > 10.0 && window.flux.triggerArenaImpact) {
                            window.flux.triggerArenaImpact(pos, Math.min(impactSpeed * 0.5, 15.0));
                            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                                window.flux.gameInstance.audioManager.playSFX('impact', { volume: Math.min(1.0, impactSpeed * 0.05) });
                            }
                        }
const e = (this.isRicochet ? 0.95 : (C.WALL_ELASTICITY !== undefined ? C.WALL_ELASTICITY : 0.3));
                        const impulse = _tempVec.clone().multiplyScalar(-vDotN * (1.0 + e));
                        this.velocity.add(impulse);
                        
                        // Ricochet Spin Kick
                        if (this.isRicochet && this.angularVelocity.lengthSq() > 1.0) {
                            const spinForce = _tempVec.cross(this.angularVelocity).normalize().multiplyScalar(5.0);
                            this.velocity.add(spinForce);
                        }

const friction = (C.WALL_FRICTION !== undefined ? C.WALL_FRICTION : 0.95);
                        const tangent = this.velocity.clone().projectOnPlane(_tempVec);
                        this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
                        this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
                    }
                }

                const bh = (C.BOUNDARY_HEIGHT !== undefined ? C.BOUNDARY_HEIGHT : 15.0);
                if (Math.abs(pos.y) > bh) {
                    const sign = Math.sign(pos.y) || 1;
                    pos.y = bh * sign;
                    const fe = (C.FLOOR_ELASTICITY !== undefined ? C.FLOOR_ELASTICITY : 0.4);
                    this.velocity.y *= -fe;
                }
            }
        }

_updateParticles(dt) {
            if (this._ghost) return;
            
            const speedSq = this.velocity.lengthSq();
            this._bubbleTimer -= dt;

            // Continuous Bubble Stream (The "Damn Blitzball" Effect)
            if (speedSq > 1.0 && this._bubbleTimer <= 0) {
                const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;
                if (pm) {
                    // Calculate emission frequency based on speed
                    // Fast = very frequent (0.01s), Slow = less frequent (0.05s)
                    const speedRatio = Math.min(1.0, speedSq / 100.0);
                    this._bubbleTimer = 0.05 - (0.04 * speedRatio); 

                    const offset = this.velocity.clone().normalize().multiplyScalar(-0.6);
                    const basePos = this.mesh.position.clone().add(offset);
                    if (this.deformNode) basePos.y += this.deformNode.position.y;

                    // 1. Micro Bubbles (The tight stream)
                    // Spawn a cluster for density
                    const count = 1 + Math.floor(speedRatio * 3);
                    for(let i=0; i<count; i++) {
                        const jitter = new THREE.Vector3(
                            (Math.random()-0.5) * 0.4,
                            (Math.random()-0.5) * 0.4,
                            (Math.random()-0.5) * 0.4
                        );
                        pm.spawn('bubble_micro', basePos.clone().add(jitter), {
                            scale: 0.05 + Math.random() * 0.08,
                            life: 0.4 + Math.random() * 0.4,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.1
                        });
                    }

                    // 2. Main Bubbles (Occasional larger ones)
                    if (Math.random() < 0.4) {
                        const jitter = new THREE.Vector3(
                            (Math.random()-0.5) * 0.6,
                            (Math.random()-0.5) * 0.6,
                            (Math.random()-0.5) * 0.6
                        );
                        pm.spawn('bubble', basePos.clone().add(jitter), {
                            scale: 0.2 + Math.random() * 0.3,
                            life: 0.8 + Math.random() * 0.6,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.05
                        });
                    }

                    // 3. High Speed Cavitation (Jet Stream)
                    if (speedSq > 80.0) {
                        pm.spawn('dash_stream', basePos, { 
                            scale: 1.5, 
                            life: 0.2,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.02,
                            color: 0xaaccff
                        });
                    }
                }
            }
        }

// Stray code block removed

grab(player) {
            this.reveal(); 
            
            // Announcement: Possession (if taking from free state)
            if (this.state === 'free') {
                 if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                     window.flux.gameInstance.showAnnouncement("POSSESSION", "normal");
                 }
            }

            // Check Turnover (Possession Change)
            const previousTeam = this.holder ? this.holder.team : (this.lastHolder ? this.lastHolder.team : null);
            if (previousTeam && previousTeam !== player.team) {
                 if (window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                     window.flux.gameInstance.floatingText.spawn("TURNOVER", player.mesh.position, "tech");
                 }
            }
            
            // If someone else held it, they lose it
            if (this.holder && this.holder !== player) {
                this.holder.loseBall();
            }

            this.holder = player;
            this.state = 'held';
            
            // NOTE: We do NOT parent the mesh to the player anymore.
            // This prevents the ball from flying around due to swim animations.
            // Instead, we update its position manually in updateHeld().
            
            // Notify player
            if (player.receiveBall) {
                player.receiveBall();
            }
            
            console.log("Ball grabbed by " + player.role);
        }

        drop() {
            this.reveal(); // Ensure visible
            
            // No need to detach from scene graph since we aren't parenting to player anymore.
            // Just clear holder.

            if (this.holder) {
                if (this.holder.loseBall) this.holder.loseBall();
                this.holder = null;
            }
            
            this.state = 'free';
        }
// Shoot/Pass
// Shoot/Pass
        shoot(directionVector, force, type = 'SH', technique = null, spinVector = null) {

            this.lastHolder = this.holder; // Record for EXP attribution
            
            // Fumble Detection (Type 'none' is used by Player.fumble)
            if (type === 'none') {
                if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                    window.flux.gameInstance.showAnnouncement("FUMBLE!", "slam");
                }
}

            this.isRicochet = (type === 'RICOCHET' || (technique && technique.type === 'ricochet'));
            this.homingTarget = null;

            this.drop(); // Detach first

// Duplicate removed
            // Set Grace Period to prevent instant interceptions/catches
            // 0.2s allows ball to clear the thrower's immediate vicinity
            this.catchGracePeriod = 0.2;

            // Physical Velocity (Visual speed)
            const C = window.flux.BallConfig || {};
            const scale = (C.LAUNCH_SPEED_SCALE !== undefined ? C.LAUNCH_SPEED_SCALE : 1.0);
            const cap = (C.LAUNCH_SPEED_CAP !== undefined ? C.LAUNCH_SPEED_CAP : 85.0);
            const speed = Math.min(force * scale, cap);
this.velocity.copy(directionVector).normalize().multiplyScalar(speed);
            
            if (type === 'LOB') {
                this.velocity.multiplyScalar(0.7); // Slower forward
                this.velocity.y = 18.0; // High vertical pop
                if (!spinVector) this.angularVelocity.set(-15, 0, 0); // Backspin
            }

            if (type === 'HOMING' || (technique && technique.type === 'homing')) {
                const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                const targetZ = (this.velocity.z > 0) ? goalDist : -goalDist;
                this.homingTarget = new THREE.Vector3(0, 0, targetZ);
                if (technique && technique.targetPos) {
                    this.homingTarget.copy(technique.targetPos);
                }
            }

            // Apply Spin if provided
            
// Apply Spin if provided
            if (spinVector) {
                this.angularVelocity.copy(spinVector);
            } else {
                this.angularVelocity.set(0, 0, 0);
            }
            
            // Stat Power (Game Logic)
            this.power = force;
            this.powerType = type;
            this.technique = technique; 
            
            // Update Trail Color
            if (this.trail) {
                let color = 0x00aaff; // Default Blue (Pass)
                
                if (technique) {
                    if (technique.type === 'venom') color = 0x00ff00; // Green (Venom)
                    else if (technique.type === 'wither') color = 0x888888; // Grey
                    else if (technique.type === 'nap') color = 0x000088; // Dark Blue
                    else if (technique.type === 'sphere') color = 0x00ffff; // Cyan
                    else if (technique.type === 'jecht') color = 0xff0000; // Red
                    else if (technique.type === 'invisible') color = 0x444444; // Dark Grey
                } else if (type === 'SH') {
                    color = 0xff4400; // Orange/Red
                }
                
                this.trail.setColor(color);
            }
            
            // Handle Invisible Shot
            if (technique && technique.type === 'invisible') {
                this.isInvisible = true;
                if (this.mesh) this.mesh.visible = false;
                // FX: Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
                console.log("Invisible Shot!");
            }
            
            console.log(`Ball ${type} with Power: ${this.power.toFixed(1)} Spin: ${this.angularVelocity.length().toFixed(1)}`);
            
            // Visual Feedback for Curve
            if (this.angularVelocity.length() > 15.0 && window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CURVE!", this.mesh.position, "tech");
            }
        }

        reveal() {
            if (this.isInvisible) {
                // FX: Reveal Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager && this.mesh) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
            }
            this.isInvisible = false;
            if (this.mesh) this.mesh.visible = true;
        }


        
reset() {
            this.reveal();
            this.drop();
            this.mesh.position.set(0, 0, 0);
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.catchGracePeriod = 0;
            this.power = 0;
        }
isCatchable() {
            return this.catchGracePeriod <= 0;
        }

_updateVisualTransforms(dt) {
            if (!this.deformNode || !this.spinNode) return;

            // 1. Squash & Stretch based on velocity
            const speed = this.velocity.length();
            
            if (speed > 1.0 && this.state === 'free') {
                const dir = this.velocity.clone().normalize();
                this.deformNode.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), dir);
                
                const factor = Math.min(speed / 40.0, 1.0); 
                const stretch = 1.0 + (factor * 0.8);
                const squash = 1.0 / Math.sqrt(stretch);
                
                this.deformNode.scale.set(squash, squash, stretch);
            } else {
                this.deformNode.quaternion.identity();
                this.deformNode.scale.set(1, 1, 1);
            }

            // 2. Apply Accumulated Spin
            const invDeform = this.deformNode.quaternion.clone().invert();
            this.spinNode.quaternion.copy(invDeform.multiply(this.accumulatedRotation));

            // 3. Visual rotation integration
            const spinSq = this.angularVelocity.lengthSq();
            if (spinSq > 0.01) {
                const spinSpeed = Math.sqrt(spinSq);
                const axis = _tempVec.copy(this.angularVelocity).normalize();
                const q = new THREE.Quaternion().setFromAxisAngle(axis, spinSpeed * dt);
                this.accumulatedRotation.premultiply(q);
            } else {
                if (speed > 0.1) {
                    _tempVec.copy(this.velocity).cross(_axisY).normalize();
                    if (_tempVec.lengthSq() > 0.01) {
                        const q = new THREE.Quaternion().setFromAxisAngle(_tempVec, speed * dt);
                        this.accumulatedRotation.premultiply(q);
                    }
                }
}
        }

        _checkFailsafes(dt) {

            if (!this.mesh) return;
            const C = window.flux.BallConfig || {};
            const maxRadius = (C.BOUNDARY_RADIUS || 46.0) + 15.0; // Generous buffer
            const maxHeight = (C.BOUNDARY_HEIGHT || 20.0) + 15.0;

            const pos = this.mesh.position;
            const distSq = pos.x*pos.x + pos.z*pos.z;

            // 1. Out of Bounds Check
            if (distSq > maxRadius*maxRadius || Math.abs(pos.y) > maxHeight) {
                this.outOfBoundsTimer += dt;
                if (this.outOfBoundsTimer > 1.0) { // 1 second OOB
                    console.warn("Ball OOB detected. Resetting.");
                    this.forceResetToPlay();
                    this.outOfBoundsTimer = 0;
                }
            } else {
                this.outOfBoundsTimer = 0;
            }

            // 2. Stuck Check (Free & Stationary)
            // Only check if game is active to avoid resetting during cutscenes/menus
            const game = window.flux.gameInstance;
            if (game && game.state === 'active' && this.state === 'free' && this.velocity.lengthSq() < 0.05) {
                this.stuckTimer += dt;
                if (this.stuckTimer > 4.0) { // 4 seconds stationary
                    console.warn("Ball stuck stationary. Resetting.");
                    this.forceResetToPlay();
                    this.stuckTimer = 0;
                }
            } else {
                this.stuckTimer = 0;
            }
        }

        forceResetToPlay() {
            this.drop();
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.power = 0;

            // Find nearest player to reset to
            let nearest = null;
            let minDst = Infinity;
            const game = window.flux.gameInstance;
            let targetPos = new THREE.Vector3(0, 0, 0); // Default center

            if (game) {
                const allPlayers = [];
                if (game.teams.home) allPlayers.push(...game.teams.home.players);
                if (game.teams.away) allPlayers.push(...game.teams.away.players);
                
                allPlayers.forEach(p => {
                    if (p.mesh) {
                        const d = p.mesh.position.distanceTo(this.mesh.position);
                        if (d < minDst) {
                            minDst = d;
                            nearest = p;
                        }
                    }
                });
            }

            if (nearest && nearest.mesh) {
                // Ensure player is within reasonable bounds before teleporting ball to them
                const pPos = nearest.mesh.position;
if (pPos.lengthSq() < 60*60) { // Within 60m radius
                    const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(nearest.mesh.quaternion).normalize();
                    targetPos.copy(pPos).add(fwd.multiplyScalar(2.0));
                    targetPos.y = Math.max(0, pPos.y + 1.0);
                }
            }

            this.mesh.position.copy(targetPos);
            
            if (game && game.particleManager) {
                game.particleManager.spawn('flash', this.mesh.position, { scale: 3.0 });
            }
            if (game && game.floatingText) {
                game.floatingText.spawn("RESET", this.mesh.position, "tech");
            }
}
    }

window.flux.Ball = Ball;
    window.flux.TrailRenderer = TrailRenderer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MiniMap {
        constructor() {
            this.container = document.getElementById('minimap');
            this.canvas = document.createElement('canvas');
            // Optimization: alpha: true is needed for transparent background
            this.ctx = this.canvas.getContext('2d', { alpha: true });
            
            // High DPI scaling (2x for retina sharpness on 100px container)
            this.size = 200; 
            this.canvas.width = this.size;
            this.canvas.height = this.size;
            
            Object.assign(this.canvas.style, {
                width: '100%',
                height: '100%',
                borderRadius: '50%',
                display: 'block'
            });
            
            if (this.container) {
                // Remove any existing children (e.g. from previous inits)
                while (this.container.firstChild) {
                    this.container.removeChild(this.container.firstChild);
                }
                this.container.appendChild(this.canvas);
            }

            this.worldRadius = 30; // Arena radius
            this.homeTeam = null;
            this.awayTeam = null;
            this.ball = null;
        }

        init(homeTeam, awayTeam, ball) {
            this.homeTeam = homeTeam;
            this.awayTeam = awayTeam;
            this.ball = ball;
        }

        update() {
            if (!this.ctx) return;

            const ctx = this.ctx;
            const size = this.size;
            const center = size / 2;
            // Map world radius (30) to canvas radius (approx 90px to leave padding)
            const scale = (center - 10) / this.worldRadius; 

            ctx.clearRect(0, 0, size, size);

            // Helper to draw entities
            const drawEntity = (entity, color, radius, isRing = false) => {
                if (!entity.mesh) return;
                
                // Skip if explicitly invisible (e.g. Ball invisible shot, or Practice dummies)
                if (entity.isInvisible) return;
                if (entity.mesh.visible === false) return;

                const pos = entity.mesh.position;
                
                // Map Logic: -Z is Top (Home Attack), +Z is Bottom
                // Canvas: 0,0 is Top-Left.
                // Center is 100,100.
                // World X -> Canvas X
                // World Z -> Canvas Y
                
                let dx = pos.x * scale;
                let dy = pos.z * scale;

                // Clamp to circular bounds
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = center - radius - 2;
                
                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }

                const x = center + dx;
                const y = center + dy;

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                
                if (isRing) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else {
                    ctx.fillStyle = color;
                    ctx.fill();
                }
            };

            // Draw Home Team
            if (this.homeTeam) {
                const active = this.homeTeam.activePlayer;
                for (let i = 0; i < this.homeTeam.players.length; i++) {
                    const p = this.homeTeam.players[i];
                    let color = '#60c0d0'; // Cyan
                    let r = 6; // 2x scale of 3px

                    if (p.status && p.status.nap > 0) color = '#333333';
                    
                    if (p === active) {
                        color = '#00ff00';
                        r = 8;
                    } else if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);
                    
                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Away Team
            if (this.awayTeam) {
                for (let i = 0; i < this.awayTeam.players.length; i++) {
                    const p = this.awayTeam.players[i];
                    let color = '#ff4444';
                    let r = 6;

                    if (p.status && p.status.nap > 0) color = '#333333';
                    if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);

                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Ball (if free)
            if (this.ball && this.ball.state === 'free') {
                drawEntity(this.ball, '#ff00cc', 7);
                drawEntity(this.ball, '#ffffff', 9, true);
            }
        }
    }

    window.flux.MiniMap = MiniMap;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Spark Texture (Procedural Burst)
    const _sparkTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,64,64);
        
        // Burst shape
        const cx = 32, cy = 32;
        const spikes = 8;
        const outer = 30;
        const inner = 10;
        
        ctx.beginPath();
        for(let i=0; i<spikes*2; i++){
            const r = (i%2===0)? outer : inner;
            const a = (Math.PI*i)/spikes;
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.closePath();
        ctx.fillStyle = '#ffcc00';
        ctx.fill();
        
        // White Core
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    const _sparkMaterial = new THREE.SpriteMaterial({ 
        map: _sparkTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class GameManager {

        
constructor(scene, uiLayerId, camera, renderer) {
            this.scene = scene;
            this.camera = camera;
            this.uiLayer = document.getElementById(uiLayerId);
            
            this.score = { home: 0, away: 0 };
            this.time = 0;
            this.half = 1;
            this.halfDuration = 300; // 5 minutes (seconds)
            this.isOvertime = false;
            this.isDemoMode = false;
this.gameMode = 'normal'; // 'normal' or 'practice'
            this.isForgeMode = false; // Asset Forge State
            // Impact Frames
this.impactPause = 0;
            // --- HUD Shake System ---
            this.hudShakeIntensity = 0;
this._hudShakeDirty = false;
            
            this.stateTimer = 0;
            this.nextStatePayload = null;

            this.state = 'menu'; // Start in menu
this.teams = {
                home: null,
                away: null
            };
            
            this.entities = {
                ball: null
            };

this.ui = {
                scorePlayer: null,
                scoreCpu: null,
                timer: null,
                half: null,
                announcement: null,
                // Player Status Panel
                statusPanel: {
                    container: null,
                    name: null,
                    hpBar: null,
                    hpText: null,
                    expBar: null
                }
            };

            // Techcopy State
            this.techCopyState = {
                active: false,
                timer: 0,
                tech: null,
                learners: []
            };

this.miniMap = new window.flux.MiniMap();
            
            // Initialize Floating Text
// Initialize Floating Text
            this.floatingText = new window.flux.FloatingTextManager(scene, uiLayerId, camera);
            
            // Reusable vector for UI calculations
            this._tempVec = new THREE.Vector3();

            // Initialize Particle Manager (Status Effects)
            
// Initialize Particle Manager (Status Effects)
            this.particleManager = new window.flux.ParticleManager(scene);
this.glyphManager = null; // Injected by main.js
this._initCinematics();
            this._initParticles(); // 3D Spark System (Legacy/Impact)

this.debugVisualizer = new window.flux.DebugVisualizer(scene);
            this.powerUpManager = new window.flux.PowerUpManager(scene, this);
            this.practiceManager = new window.flux.PracticeManager(this); // Initialize Practice Manager
            this._injectStyles();
this._initUI();
        }

_initCinematics() {
            // Menu Background Shots (B-Roll)
            this.menuShotIndex = 0;
            this.menuShotTimer = 0;
            this.menuShots = [
                { duration: 10.0, update: (t, cam) => { cam.position.set(60, 35, 60).lerp(new THREE.Vector3(40, 25, 40), t); cam.lookAt(0, 0, 0); } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(-25, 6, -25 + 50*t); cam.lookAt(0, 2, (-25 + 50*t)*0.8); } },
                { duration: 8.0, update: (t, cam) => { const a = t+3.5; cam.position.set(-10+Math.cos(a)*10, 4, -10+Math.sin(a)*10); cam.lookAt(-10, 1.5, -10); } },
                { duration: 7.0, update: (t, cam) => { cam.position.set(0, -5, 32).lerp(new THREE.Vector3(0, 8, 20), t); cam.lookAt(0, 15, 45); cam.rotation.z = (t-0.5)*0.15; } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(0, 50, 0).lerp(new THREE.Vector3(0, 10, 0), t*t*(3-2*t)); cam.lookAt(0, 0, 0); cam.rotation.z = t*0.8; } }
            ];

            // Epic Intro Sequence ("Herculean")
            this.introShots = [
                // 1. "The Awakening" - Close on Sphere -> Zoom Out Upside Down -> Lights & Roar
                {
                    duration: 8.0,
                    onStart: () => { 
                        this.showAnnouncement("THE SPHERE POOL", "slam"); 
                        if(this.stadium) this.stadium.resetLights(); // Ensure dark start
                        this._hasRoared = false;
                        
                        // Ambient start sound (Deep hum / Underwater feel)
                        if(this.audioManager) this.audioManager.playSFX('swim', { volume: 1.0, rate: 0.3 });
                    },
                    update: (t, cam) => {
                        // Easing
                        const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        const expT = Math.pow(t, 3.0); // Strong exponential zoom out

                        // Camera Motion: Start INSIDE/CLOSE (0,0,2) -> End FAR BACK/UP (0, 80, 160)
                        const startPos = new THREE.Vector3(0, 0, 2); 
                        const endPos = new THREE.Vector3(0, 80, 160); 
                        
                        cam.position.lerpVectors(startPos, endPos, expT);
                        cam.lookAt(0, 0, 0);

                        // Dynamic Roll: Turn upside down (0 -> PI)
                        cam.rotation.z = ease * Math.PI; 

                        // Light Sequencing & Sound
                        if (this.stadium) {
                            const total = this.stadium.lightCount;
                            const lightProgress = Math.max(0, (t - 0.2) / 0.6);
                            const activeCount = Math.floor(lightProgress * total);
                            
                            // Trigger "Roar to Life"
                            if (lightProgress > 0.5 && !this._hasRoared) {
                                this._hasRoared = true;
                                if(this.audioManager) {
                                    this.audioManager.playSFX('goal', { volume: 1.0, rate: 0.7 }); // Deep roar
                                    this.audioManager.playSFX('dash', { volume: 0.8, rate: 0.5 }); // Whoosh
                                }
                                if (this.cameraManager) this.cameraManager.addShake(1.5);
                            }

                            for(let i=0; i < total; i++) {
                                if (i <= activeCount) {
                                    const sprite = this.stadium.lightSprites[i];
                                    if (sprite && !sprite.visible) {
                                        this.stadium.turnOnLight(i);
                                        
                                        // Industrial Light SFX
                                        if(this.audioManager) {
                                            const pitch = 0.5 + (i / total) * 0.5; 
                                            this.audioManager.playSFX('impact', { volume: 0.4, rate: pitch, variance: 0.0 });
                                        }
                                        if (this.cameraManager) this.cameraManager.addShake(0.2);
                                    }
                                }
                            }
                        }
                    }
                },
                // 2. "The Roar" - Sweeping crowd shot
                {
                    duration: 4.0,
                    onStart: () => {
                        this.showAnnouncement("LEGENDARY ARENA", "normal");
                        if(this.cameraManager) this.cameraManager.addShake(1.0);
                        if(this.audioManager) this.audioManager.playSFX('goal', { volume: 0.7 }); // Crowd cheer
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;
                        
                        const angle = -Math.PI/2 + (t * Math.PI * 0.5);
                        const r = isPortrait ? 85 : 65; // Pull back in portrait
                        
                        cam.position.set(Math.cos(angle)*r, 15, Math.sin(angle)*r);
                        cam.lookAt(0, 5, 0);
                    }
                },
                // 3. "Home Glory" - Orbit Home Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("BESAID AUROCHS", "slam");
                        if(this.teams.home) this.teams.home.players.forEach(p => p.play('celebrate', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Orbit Home Team (Side 1, -Z)
                        const center = new THREE.Vector3(0, 0, -20);
                        const angle = Math.PI + (t * 1.5);
                        const r = isPortrait ? 20 : 12; // Pull back if portrait
                        cam.position.set(center.x + Math.cos(angle)*r, 4, center.z + Math.sin(angle)*r);
                        cam.lookAt(center.x, 2, center.z);
                    }
                },
                // 4. "Enemy Gates" - Tracking Away Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("LUCA GOERS", "slam");
                        if(this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Tracking Away Team (Side -1, +Z)
                        const start = new THREE.Vector3(-15, 2, 25);
                        const end = new THREE.Vector3(15, 2, 25);
                        
                        if (isPortrait) {
                            start.x *= 1.5; end.x *= 1.5;
                            start.z += 10; end.z += 10;
                        }

                        cam.position.lerpVectors(start, end, t);
                        cam.lookAt(0, 3, 25);
                    }
                },
                // 5. "The Sphere" - Zoom to center
                {
                    duration: 2.0,
                    onStart: () => {
                        this.showAnnouncement("BLITZ OFF!", "slam");
                        if(this.stadium) this.stadium.setAllLights(true);
                        if(this.audioManager) this.audioManager.playSFX('whistle', { volume: 0.8 });
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        const p1 = new THREE.Vector3(0, 30, isPortrait ? 70 : 50);
                        const p2 = new THREE.Vector3(0, 14, 22); // Gameplay cam
                        const st = t * t;
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                    }
                }
            ];
        }

        _injectStyles() {
            if (document.getElementById('flux-dynamic-styles')) return;
            const style = document.createElement('style');
            style.id = 'flux-dynamic-styles';
style.textContent = `
                @keyframes textSlam {
                    0% { transform: translate(-50%, -50%) scale(4); opacity: 0; letter-spacing: 50px; }
                    10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 5px; }
                    15% { transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0px); }
                    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(10px); }
                }
                
                .announcement-slam {
                    position: absolute;
                    top: 45%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%;
                    text-align: center;
                    font-family: 'Impact', sans-serif;
                    font-size: 96px;
                    font-style: italic;
                    text-transform: uppercase;
                    background: linear-gradient(to bottom, #ffffff 0%, #ffdd00 45%, #ff8800 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    filter: drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(255, 100, 0, 0.6));
                    z-index: 2000;
                    animation: textSlam 1.8s cubic-bezier(0.1, 0.8, 0.1, 1) forwards;
                    pointer-events: none;
                    white-space: nowrap;
                }

                .modal-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle at center, rgba(10, 25, 60, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
                    display: flex; justify-content: center; align-items: center; flex-direction: column;
                    z-index: 1900;
                    opacity: 0; pointer-events: none; transition: opacity 0.8s;
                    backdrop-filter: blur(8px);
                }
                .modal-overlay.active { opacity: 1; pointer-events: auto; }
                
                .modal-title {
                    font-family: 'Garamond', serif;
                    font-size: 52px; color: #fff;
                    text-transform: uppercase;
                    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #00aaff;
                    padding-bottom: 10px;
                    width: 80%; text-align: center;
                    letter-spacing: 5px;
                }
                
                .modal-score-container {
                    display: flex; align-items: center; gap: 40px;
                    margin-bottom: 40px;
                }
                .modal-score {
                    font-family: 'Impact', sans-serif;
                    font-size: 80px; color: #ffd700;
                    letter-spacing: 5px;
                    text-shadow: 0 0 20px #b8860b;
                }
                .modal-vs {
                    font-family: 'Courier New', monospace;
                    font-size: 24px; color: #00aaff; opacity: 0.7;
                }

                .flash-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: white;
                    z-index: 2100;
                    opacity: 0; pointer-events: none;
                    transition: opacity 0.1s ease-out;
                    mix-blend-mode: overlay;
                }

                @keyframes clashPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
                }

                .clash-spark {
                    position: absolute;
                    width: 60px; height: 60px;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 40%, transparent 70%);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1500;
                    mix-blend-mode: screen;
                    animation: clashPop 0.3s ease-out forwards;
                    box-shadow: 0 0 20px #ffaa00;
                }
            `;
            document.head.appendChild(style);
        }

        registerTeams(homeTeam, awayTeam, ball) {
            this.teams.home = homeTeam;
            this.teams.away = awayTeam;
this.entities.ball = ball;
            
            // Initialize MiniMap
            if (this.miniMap) {
                this.miniMap.init(homeTeam, awayTeam, ball);
            }
        }

_initUI() {
            // Bind to existing HTML elements
            this.ui.scorePlayer = document.getElementById('score-player');
            this.ui.scoreCpu = document.getElementById('score-cpu');
            this.ui.timer = document.getElementById('timer-display');
            this.ui.half = document.getElementById('half-indicator');
            this.ui.announcement = document.getElementById('announcement');
this.ui.announcement = document.getElementById('announcement');
            this.ui.offscreenIndicator = document.getElementById('offscreen-indicator');
            this.ui.techFlash = document.getElementById('tech-flash-overlay');
            if (this.ui.techFlash) {
                this.ui.techSub = this.ui.techFlash.querySelector('.tech-sub-text');
            }
            this.ui.techTimerFill = document.querySelector('.tech-timer-fill');

            // Bind Player Status Panel
            this.ui.statusPanel.container = document.getElementById('player-status-panel');
            this.ui.statusPanel.name = document.querySelector('#player-status-panel .char-name');
            this.ui.statusPanel.hpBar = document.querySelector('#player-status-panel .hp-bar-fill');
            this.ui.statusPanel.hpText = document.querySelector('#player-status-panel .hp-value');
            this.ui.statusPanel.expBar = document.querySelector('#player-status-panel .tech-bar-fill');
            
            // End Game Menu Bindings
            this.ui.endMenu = document.getElementById('end-game-menu');
            const btnRematch = document.getElementById('end-btn-rematch');
            const btnExit = document.getElementById('end-btn-exit');

            if (btnRematch) {
                btnRematch.addEventListener('click', () => {
                    this._hideEndMenu();
                    this.startMatch(this.gameMode);
                });
            }
            if (btnExit) {
                btnExit.addEventListener('click', () => {
                    this._hideEndMenu();
                    if (window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        this.state = 'menu';
                    }
                });
            }

            // Create Modal Overlay (For Halftime only now)
            this.ui.modal = document.createElement('div');
            this.ui.modal.className = 'modal-overlay';
            this.ui.modal.innerHTML = `
                <div class="modal-title">HALF TIME</div>
                <div class="modal-score-container">
                    <div class="modal-score" id="modal-score-home">0</div>
                    <div class="modal-vs">-</div>
                    <div class="modal-score" id="modal-score-away">0</div>
                </div>
                <div id="modal-msg" style="color: #00aaff; font-size: 14px; letter-spacing: 2px;">PREPARING 2ND HALF...</div>
            `;
            this.uiLayer.appendChild(this.ui.modal);

            // Create Flash Overlay
            this.ui.flash = document.createElement('div');
            this.ui.flash.className = 'flash-overlay';
            this.uiLayer.appendChild(this.ui.flash);

            // Initial State
// Initial State
// Initial State
            if (this.ui.timer) this.ui.timer.innerText = "00:00";
            
            // Ensure end menu is hidden on init
            this._hideEndMenu();
        }
        _updateScoreUI() {
            if (this.ui.scorePlayer) this.ui.scorePlayer.innerText = this.score.home;
            if (this.ui.scoreCpu) this.ui.scoreCpu.innerText = this.score.away;
        }

updatePractice(dt) {
            // Delegate logic to PracticeManager
            if (this.practiceManager) {
                this.practiceManager.update(dt);
            }
        }

update(dt) {
            // --- STATE TIMER LOGIC ---
            if (this.stateTimer > 0) {
                this.stateTimer -= dt;
if (this.stateTimer <= 0) {
                    this._advanceState();
                }
            }

            // --- PHYSICS & LOGIC UPDATE (Fixed Timestep) ---
            
            // Intro & Menu are purely visual states, handled in updateVisuals
            if (this.state === 'intro' || this.state === 'menu') return;

            if (this.state === 'blitz_charge') {
                this._updateBlitzCharge(dt);
                return;
            }
            if (this.state === 'blitz_launch') {
                this._updateBlitzLaunch(dt);
                return;
            }

if (this.state === 'active') {
                this.time += dt;
                this._updateTimer();
                this._checkHalfTime();
            }

            this._checkGoals();
            
            // Update Techcopy Logic (Timer)
            if (this.techCopyState.active) {
                this.techCopyState.timer -= dt;
                if (this.techCopyState.timer <= 0) {
                    this.endTechCopyWindow(false);
                }
}
            // Update PowerUps
// Update PowerUps
            if (this.powerUpManager) {
                this.powerUpManager.update(dt);
            }
        }

        updateVisuals(dt) {

            if (this.state === 'intro') {
                // Player Warmup Animations
                this._updateIntroWarmup(dt);

                if (!this.introShots || this.introShots.length === 0) {
                    this.skipIntro();
                    return;
                }

                const shot = this.introShots[this.introShotIndex];
                this.introShotTimer += dt;

                if (this.introShotTimer >= shot.duration) {
                    this.introShotIndex++;
                    this.introShotTimer = 0;
                    
                    if (this.introShotIndex >= this.introShots.length) {
                        this.skipIntro(); // Done
                        return;
                    } else {
                        // Next shot start
                        const nextShot = this.introShots[this.introShotIndex];
                        if (nextShot.onStart) nextShot.onStart();
                    }
                } else {
                    // Update current shot
                    const t = this.introShotTimer / shot.duration;
                    if (this.camera && shot.update) {
                        shot.update(t, this.camera);
                    }
                }
                return;
            }

            if (this.state === 'menu') {
                // --- POPULATE ARENA FOR B-ROLL ---
                const animateTeam = (team) => {
                    if (!team) return;
                    team.players.forEach(p => {
                        if (p.mesh) {
                            p.mesh.visible = true;
                            // Gentle bobbing to simulate treading water
                            p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.002 + p.mesh.id) * 0.5;
                            // Ensure idle animation is playing
                            if (p.state !== 'idle') p.play('idle', 0.5);
                            if (p.mixer) p.mixer.update(dt);
                        }
                    });
                };
                animateTeam(this.teams.home);
                animateTeam(this.teams.away);

                // --- CINEMATIC B-ROLL ---
                if (this.menuShots && this.menuShots.length > 0) {
                    const shot = this.menuShots[this.menuShotIndex];
                    this.menuShotTimer += dt;
                    
                    if (this.menuShotTimer >= shot.duration) {
                        this.menuShotTimer = 0;
                        this.menuShotIndex = (this.menuShotIndex + 1) % this.menuShots.length;
                    }
                    
                    // Normalize time (0 to 1)
                    const t = this.menuShotTimer / shot.duration;
                    if (this.camera) {
                        shot.update(t, this.camera);
                    }
                }

                // Ambient FX in Menu
                if (this.particleManager && Math.random() < 0.2) {
                    const range = 60;
                    const pos = new THREE.Vector3(
                        (Math.random()-0.5)*range, 
                        -10 + Math.random()*20, 
                        (Math.random()-0.5)*range
                    );
                    this.particleManager.spawn('bubble', pos, { life: 3.0 + Math.random()*2.0, scale: 0.3 + Math.random()*0.4 });
                }

                // Update Background Systems
                if (this.particleManager) this.particleManager.update(dt);
                return;
            }

            // Update Techcopy UI
            if (this.techCopyState.active && this.ui.techTimerFill) {
                const pct = Math.max(0, (this.techCopyState.timer / this.techCopyState.maxTime) * 100);
                this.ui.techTimerFill.style.width = `${pct}%`;
                
                // Color shift based on urgency
                if (pct < 30) this.ui.techTimerFill.style.background = '#ff0000';
                else this.ui.techTimerFill.style.background = 'linear-gradient(90deg, #ffffff, #00ffff)';
            }

            // General Visuals (Always Run except Intro/Menu)
// General Visuals (Always Run except Intro/Menu)
            if (this.state !== 'menu' && this.state !== 'intro') {
                // Update band possession display
                if (window.flux.updateBandPossession && this.entities && this.entities.ball) {
                    const ball = this.entities.ball;
                    const homeHasBall = ball.holder && ball.holder.team && ball.holder.team.isHuman;
                    window.flux.updateBandPossession(homeHasBall);
                }

                if (this.miniMap) this.miniMap.update();
                if (this.floatingText) this.floatingText.update(dt);
                
                // CRITICAL FIX: Update particles during gameplay
                if (this.particleManager) this.particleManager.update(dt);

                this._updateAudioState();
                if (this.audioManager && this.audioManager.update) this.audioManager.update(dt);
                this._updateHUDShake(dt); // Apply HUD Shake
this._updateHUDShake(dt); // Apply HUD Shake
                this._updateEnvironmentalFX(dt); // Ambient Bubbles
            }
        }

    _updateGoalTransparency() {
            if (!this.camera) return;
            
            const goals = [window.flux.goalA, window.flux.goalB];
            const fadeDist = 35.0; // Distance to start fading
            const minFadeDist = 15.0; // Distance where it's most transparent
            const minOpacity = 0.2;

            goals.forEach(goal => {
                if (!goal) return;

                // Calculate distance from camera to goal position
                const dist = this.camera.position.distanceTo(goal.position);
                
                let opacity = 1.0;
                if (dist < fadeDist) {
                    // Linear fade
                    const t = (dist - minFadeDist) / (fadeDist - minFadeDist);
                    opacity = THREE.MathUtils.clamp(t, 0.0, 1.0) * (1.0 - minOpacity) + minOpacity;
                }

                const isTransparent = opacity < 0.99;

                // Apply to all meshes in goal hierarchy
                goal.traverse(child => {
                    if (child.isMesh && child.material) {
                        const mat = child.material;
                        
                        // Only update if changed to minimize overhead
                        if (Math.abs(mat.opacity - opacity) > 0.01 || mat.transparent !== isTransparent) {
                            mat.opacity = opacity;
                            mat.transparent = isTransparent;
                            // Disable depthWrite when transparent so we can see the ball inside the net
                            mat.depthWrite = !isTransparent;
                            mat.needsUpdate = true;
                        }
                    }
                });
            });
}
        _updateOffscreenIndicator() {
            const p = this.teams.home ? this.teams.home.activePlayer : null;
            const indicator = this.ui.offscreenIndicator;
            
            if (!p || !p.mesh || !this.camera || !indicator) return;

            // 1. Get Player Position (Center Mass)
            const pos = p.mesh.position.clone();
            pos.y += 1.0; 
            
            // 2. Project to Normalized Device Coordinates (NDC) [-1, 1]
            this._tempVec.copy(pos).project(this.camera);
            
            // 3. Check if Behind Camera
            const camFwd = new THREE.Vector3();
            this.camera.getWorldDirection(camFwd);
            const toPlayer = pos.clone().sub(this.camera.position).normalize();
            const dot = camFwd.dot(toPlayer);
            const isBehind = dot < 0.2; // Buffer to prevent flipping at edge

            // 4. Check Bounds
            const isOffScreen = (
                this._tempVec.x < -0.9 || this._tempVec.x > 0.9 ||
                this._tempVec.y < -0.9 || this._tempVec.y > 0.9 ||
                isBehind
            );

            if (isOffScreen) {
                indicator.style.display = 'block';
                
                let x = this._tempVec.x;
                let y = this._tempVec.y;

                // If behind, invert coordinates to point correctly
                if (isBehind) {
                    x = -x;
                    y = -y;
                    // Fix singularity if exactly behind center
                    if (Math.abs(x) < 0.01 && Math.abs(y) < 0.01) y = -1; 
                }

                // Clamp to screen edges
                // We want to find the intersection of the vector (x,y) with the box [-0.9, 0.9]
                const padding = 0.9;
                
                // Normalize to get direction
                const mag = Math.sqrt(x*x + y*y);
                const nx = x / mag;
                const ny = y / mag;
                
                // Raycast to box edges
                // Vertical edges: x = +/- padding
                // Horizontal edges: y = +/- padding
                
                // Avoid divide by zero
                const tx = (Math.abs(nx) > 0.001) ? (nx > 0 ? padding : -padding) / nx : 999;
                const ty = (Math.abs(ny) > 0.001) ? (ny > 0 ? padding : -padding) / ny : 999;
                
                // Use the nearest intersection (smallest positive t)
                // Since we are projecting from center (0,0) to (nx,ny), t must be positive.
                const t = Math.min(Math.abs(tx), Math.abs(ty));
                
                const screenX = nx * t;
                const screenY = ny * t;

                // Convert NDC to Pixels
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const px = (screenX * 0.5 + 0.5) * width;
                const py = (-(screenY) * 0.5 + 0.5) * height;

                // Calculate Rotation
                // Arrow points UP by default.
                // We want it to point in direction (nx, ny) on screen.
                // Screen Y is down (inverted from WebGL Y).
                // So (0, 1) in NDC is UP. (0, -1) in NDC is DOWN.
                // atan2(y, x) gives angle from +X.
                // We want angle from +Y (Up).
                // Rotation = PI/2 - angle.
                
                const angle = Math.atan2(ny, nx);
                const rot = (Math.PI / 2) - angle;

                indicator.style.transform = `translate(${px}px, ${py}px) rotate(${rot}rad)`;
                
            } else {

                indicator.style.display = 'none';
            }
        }

        _updateTimer() {
            if (!this.ui.timer) return;
            // Clamp to half duration for display if we go slightly over before tick
            const t = Math.min(this.time, this.halfDuration);
            const minutes = Math.floor(t / 60);
            const seconds = Math.floor(t % 60);
            this.ui.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        _checkHalfTime() {
            if (this.time >= this.halfDuration) {
                this.endHalf();
            }
        }

endHalf() {
            this.state = 'halftime';
            
            // Stop all players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            if (this.half === 1) {
                this._showModal("HALF TIME", "PREPARING 2ND HALF...");
                
                // Optional: Play whistle sound here if available
                if (this.audioManager) this.audioManager.playSFX('whistle');

                this.stateTimer = 4.0;
            } else {
                // End of 2nd Half or Overtime Period
                if (this.score.home === this.score.away) {
                    // TIED - Go to Overtime (Golden Goal / Sudden Death)
                    this._showModal("SUDDEN DEATH", "NEXT GOAL WINS");
                    
                    if (this.audioManager) this.audioManager.playSFX('whistle');

                    this.stateTimer = 4.0;
                } else {
                    // Winner decided
                    this.endGame();
                }
            }
        }
        startSecondHalf() {
            this.half = 2;
            this.time = 0;
            if (this.ui.half) {
                this.ui.half.innerText = "2nd HALF";
                this.ui.half.style.color = ""; // Reset color
                this.ui.half.style.textShadow = "";
            }
            this.resetRound(null); // Neutral Blitz-off for 2nd half start
        }

        startOvertime() {
            this.half++;
            this.time = 0;
            this.isOvertime = true;
            if (this.ui.half) {
                this.ui.half.innerText = "SUDDEN DEATH";
                this.ui.half.style.color = "#ff4444"; // Red for danger/urgency
                this.ui.half.style.textShadow = "0 0 10px #ff0000";
            }
            this.resetRound(null); // Neutral Blitz-off
            
            // Announce start
            this.showAnnouncement("SUDDEN DEATH!", "slam");
        }

endGame() {
            this.state = 'gameover';
            
            // Stop players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            let msg = "DRAW";
            if (this.score.home > this.score.away) msg = "VICTORY";
            if (this.score.away > this.score.home) msg = "DEFEAT";
            
            // Populate End Game Menu
            if (this.ui.endMenu) {
                const titleEl = document.getElementById('end-result-title');
                const homeScoreEl = document.getElementById('end-score-home');
                const awayScoreEl = document.getElementById('end-score-away');
                
                if (titleEl) {
                    titleEl.innerText = msg;
                    titleEl.style.color = (msg === "VICTORY") ? "#00ffff" : ((msg === "DEFEAT") ? "#ff4444" : "#ffffff");
                }
                if (homeScoreEl) homeScoreEl.innerText = this.score.home;
                if (awayScoreEl) awayScoreEl.innerText = this.score.away;

                this.ui.endMenu.classList.add('active');
                this.setMenuMode(true); // Hide HUD
            }

            // Stop Music on Game Over
            if (this.audioManager) {
                this.audioManager.stopBGM();
            }
        }

        _hideEndMenu() {
            if (this.ui.endMenu) {
                this.ui.endMenu.classList.remove('active');
                this.setMenuMode(false); // Show HUD
            }
        }

        _showModal(title, subtext) {
            if (!this.ui.modal) return;
            
            this.ui.modal.querySelector('.modal-title').innerText = title;
            this.ui.modal.querySelector('#modal-score-home').innerText = this.score.home;
            this.ui.modal.querySelector('#modal-score-away').innerText = this.score.away;
            this.ui.modal.querySelector('#modal-msg').innerText = subtext;
            
            this.ui.modal.classList.add('active');
            
            // Hide HUD elements
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
        }

        _hideModal() {
            if (!this.ui.modal) return;
            this.ui.modal.classList.remove('active');
            
            // Show HUD elements
            document.getElementById('hud-top').style.opacity = '1';
            document.getElementById('player-status-panel').style.opacity = '1';
        }

_checkGoals() {
            const C = window.flux.BallConfig || {};
            const goalDist = C.GOAL_DISTANCE || 41.5;
            
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const pos = ball.mesh.position;

// Precise Goal Detection (Inverted Triangle Hitbox)
            // Matches FFX Style Goal Model
            const triTopY = (C.GOAL_TRIGGER_TOP_Y !== undefined) ? C.GOAL_TRIGGER_TOP_Y : 2.0;
            const triBottomY = (C.GOAL_TRIGGER_BOTTOM_Y !== undefined) ? C.GOAL_TRIGGER_BOTTOM_Y : -18.0;
            const triMaxHalfWidth = ((C.GOAL_TRIGGER_WIDTH !== undefined) ? C.GOAL_TRIGGER_WIDTH : 28.0) / 2.0;

            const triggerOffset = (C.GOAL_TRIGGER_OFFSET !== undefined) ? C.GOAL_TRIGGER_OFFSET : 1.0;
            const triggerZ = goalDist - triggerOffset;

            if (Math.abs(pos.z) > triggerZ) {
                // PREVENT OWN GOAL BY CARRIER (User Request)
                // If the ball is held by the team defending this goal, do not count it.
                if (ball.holder) {
                    // Home (Side 1) defends +Z. If pos.z > 0 (Home Goal) and holder is Home, ignore.
                    if (pos.z > 0 && ball.holder.team.side === 1) return;
                    // Away (Side -1) defends -Z. If pos.z < 0 (Away Goal) and holder is Away, ignore.
                    if (pos.z < 0 && ball.holder.team.side === -1) return;
                }

                // 2. Check Frame (Inverted Triangle)
                if (pos.y <= triTopY && pos.y >= triBottomY) {
                    // Calculate allowed width at this height (Linear interpolation)
                    // At bottom (-6), width is 0. At top (12), width is max.
                    const t = (pos.y - triBottomY) / (triTopY - triBottomY);
                    const allowedX = t * triMaxHalfWidth;

                    if (Math.abs(pos.x) <= allowedX) {
                        if (pos.z < 0) {
                            this.goalScored('home'); // Home attacks -Z
                        } else {
                            this.goalScored('away'); // Away attacks +Z
                        }
                    }
                }
            }
        }

goalScored(scorer) {
            if (this.state !== 'active') return;
            
            // IMPACT FRAME: GOAL
            this.triggerImpact(0.4, 'shatter'); // Massive freeze for goal
            
            // EXP REWARD: Goal
            // Find who scored (Last holder of ball)
            const ball = this.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team.id === scorer) {
                ball.lastHolder.gainExp(10);
            }

            this.state = 'goal';
            this.score[scorer]++;
            this._updateScoreUI();
            
            // 1. VISCERAL SHAKE & PARTICLES
            if (this.cameraManager) {
                this.cameraManager.addShake(2.0); // Heavy shake
                this.addHUDShake(20.0); // HUD Shake
            }

            // BARRIER SHATTER LOGIC
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            // Home scores at -Z (Away Goal), Away scores at +Z (Home Goal)
            const goalZ = (scorer === 'home') ? -goalDist : goalDist;

            if (this.stadium) {
                const barrier = (scorer === 'home') ? this.stadium.barrierA : this.stadium.barrierB;
                if (barrier) barrier.visible = false;
            }

            if (this.particleManager && this.entities.ball && this.entities.ball.mesh) {
                const ballPos = this.entities.ball.mesh.position.clone();
                const ballVel = this.entities.ball.velocity.clone();
                const forward = ballVel.clone().normalize();

                // Calculate Impact Point on Goal Plane (The "Invisible Barrier")
                const impactPos = ballPos.clone();
                // Snap effect to the barrier plane (Z) but keep X/Y of entry
                impactPos.z = goalZ; 
                
                // Trigger Glass Shatter Effect (The Hole)
                this._triggerGlassShatter(impactPos, ballVel);

                // Trigger Triangle Frame Shatter (The Barrier)
                this._spawnTriangleShatter(goalZ, forward);

                // Massive Goal Explosion
                this.particleManager.spawn('shockwave', impactPos, { scale: 20.0, life: 0.6, color: 0x00ffff });
                this.particleManager.spawn('flash', impactPos, { scale: 12.0 });
            }
            // 2. SCREEN FLASH
            if (this.ui.flash) {
                this.ui.flash.style.opacity = '0.8';
                setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 100);
            }

            // 3. GOLDEN GOAL CHECK (Sudden Death)
            if (this.isOvertime) {
                this.showAnnouncement("GOLDEN GOAL!", 'slam');
                
                // Slow motion finish
                if (window.flux) window.flux.timeScale = 0.2;

                // End game after short delay (0.5s game time at 0.2 scale = 2.5s real time)
                this.state = 'golden_goal';
                this.stateTimer = 0.5;
                return;
            }

            // 4. SLAM ANNOUNCEMENT (Normal)
            this.showAnnouncement("GOAL!", 'slam');
            if (this.audioManager) this.audioManager.playSFX('goal');
            
            // Reset sequence
            // Scored-upon team gets ball
            const loser = scorer === 'home' ? 'away' : 'home';
            
            // FASTER FLOW: Reduced delay from 3000ms to 1200ms (2.0s game time)
            this.stateTimer = 2.0;
            this.nextStatePayload = loser;
        }

_spawnTriangleShatter(zPos, forwardDir) {
            if (!this.particleManager) return;

            // Triangle Vertices (Matches Stadium.js geometry)
            // Top Y: 12.0, Bottom Y: -6.0. Width at top: 28.0 (+/- 14.0).
const v1 = { x: -14, y: 9 };
            const v2 = { x: 14, y: 9 };
            const v3 = { x: 0, y: -6 };
            
            const edges = [
                { start: v1, end: v2 },
                { start: v2, end: v3 },
                { start: v3, end: v1 }
            ];

            // Increased density for "appearing" effect
// Increased density for "appearing" effect
const particlesPerEdge = 4; // Reduced from 12 for less clutter
            
            edges.forEach(edge => {
                for (let i = 0; i <= particlesPerEdge; i++) {
                    const t = i / particlesPerEdge;
                    const x = edge.start.x + (edge.end.x - edge.start.x) * t;
                    const y = edge.start.y + (edge.end.y - edge.start.y) * t;
                    
                    const pos = new THREE.Vector3(x, y, zPos);
                    
                    // Add some randomness
                    pos.x += (Math.random() - 0.5) * 0.5;
                    pos.y += (Math.random() - 0.5) * 0.5;
                    pos.z += (Math.random() - 0.5) * 0.5;

                    // Velocity: Outward from center of triangle (approx 0, 4) + Forward
                    const center = { x: 0, y: 1.5 }; // Rough center of mass
                    const dir = new THREE.Vector3(x - center.x, y - center.y, 0).normalize();
                    
                    const vel = dir.multiplyScalar(8.0 + Math.random() * 12.0);
                    vel.add(forwardDir.clone().multiplyScalar(20.0)); // Strong forward momentum

this.particleManager.spawn('shard', pos, {
                        velocity: vel,
                        scale: 4.0 + Math.random() * 6.0, 
                        life: 1.5 + Math.random(),
                        color: 0x44aaff,
                        rotationSpeed: (Math.random() - 0.5) * 10.0, // Spin
                        frame: Math.floor(Math.random() * 4) // Random shape
                    });
                    
                    // Flash on perimeter to outline the shape as it breaks
                    if (Math.random() < 0.5) {
                        this.particleManager.spawn('flash', pos, { scale: 3.0, life: 0.3, color: 0xffffff });
                    }
                }
            });
        }

_triggerGlassShatter(pos, vel) {
            if (!this.particleManager) return;
            
            const forward = vel.clone().normalize();
            const speed = Math.max(20.0, vel.length()); // Ensure minimum explosion speed
            
            // 1. The "Pane" (Radial burst on the goal plane)
            // Simulates the barrier shattering outward
// 1. The "Pane" (Radial burst on the goal plane)
            // Simulates the barrier shattering outward
const shardCount = 15; // Reduced from 50
            for(let i=0; i<shardCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 10.0; // Larger radius
                
                const offset = new THREE.Vector3(Math.cos(angle) * r, Math.sin(angle) * r, 0);
                const p = pos.clone().add(offset);
                
                // Velocity is radial outward from impact center
                const radialDir = offset.clone().normalize();
                const shardVel = radialDir.multiplyScalar(15.0 + Math.random() * 25.0);
                
                // Add forward momentum (The ball punches through)
                shardVel.add(forward.clone().multiplyScalar(speed * 0.8));
                
this.particleManager.spawn('shard', p, {
                    velocity: shardVel,
                    scale: 6.0 + Math.random() * 8.0, 
                    life: 1.2 + Math.random() * 0.8,
                    gravity: 25.0,
                    color: 0xaaffff,
                    rotationSpeed: (Math.random() - 0.5) * 15.0,
                    frame: Math.floor(Math.random() * 4)
                });
            }

            // 2. The "Hole" (High velocity shards moving forward with the ball)
// 2. The "Hole" (High velocity shards moving forward with the ball)
            for(let i=0; i<8; i++) { // Reduced from 20
                const p = pos.clone();
                // Randomize start pos slightly (impact zone)
                p.x += (Math.random() - 0.5) * 4.0;
                p.y += (Math.random() - 0.5) * 4.0;
                
                // Velocity: Mostly forward, some spread
                const shardVel = forward.clone().multiplyScalar(speed * (1.0 + Math.random() * 0.5));
                shardVel.x += (Math.random() - 0.5) * 15.0;
                shardVel.y += (Math.random() - 0.5) * 15.0;
                
this.particleManager.spawn('shard', p, {
                    velocity: shardVel,
                    scale: 5.0 + Math.random() * 7.0,
                    life: 2.0 + Math.random(),
                    gravity: 15.0,
                    color: 0xffffff,
                    rotationSpeed: (Math.random() - 0.5) * 20.0,
                    frame: Math.floor(Math.random() * 4)
                });
            }
            
            // 3. Impact Flash & Sound
            this.particleManager.spawn('flash', pos, { scale: 15.0, color: 0xffffff });
            
            // 3. Impact Flash & Sound
            this.particleManager.spawn('flash', pos, { scale: 10.0, color: 0xffffff });
            
            if (this.audioManager) {
                // High pitch impact to simulate glass breaking
                this.audioManager.playSFX('impact', { volume: 1.0, rate: 2.5 }); 
                this.audioManager.playSFX('dash', { volume: 1.0, rate: 0.5 }); // Deep whoosh
            }
        }

showAnnouncement(text, type = 'normal', duration = 2000) {
            const el = this.ui.announcement;
            if (!el) return;

            // Clear previous timeout
            if (this._announceTimeout) {
                clearTimeout(this._announceTimeout);
                this._announceTimeout = null;
            }

            // Reset Animation by cloning
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            this.ui.announcement = newEl;

            newEl.innerText = text;
            newEl.style.display = 'block';
            
            // Apply Class based on type
            newEl.className = ''; // Reset classes
            if (type === 'slam') {
                newEl.classList.add('announcement-slam');
            } else {
                // Default style
                newEl.style.animation = 'none';
                newEl.offsetHeight; /* trigger reflow */
                newEl.style.animation = 'announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            // Auto-hide
            if (duration > 0) {
                this._announceTimeout = setTimeout(() => {
                    this.hideAnnouncement();
                }, duration);
            }
        }

        hideAnnouncement() {
            if (this.ui.announcement) {
                this.ui.announcement.style.display = 'none';
            }
        }

resetRound(possessionTeamId) {
            this.state = 'reset';
            
            // Clear persistent visuals
            if (this.glyphManager) this.glyphManager.clear();
            if (this.powerUpManager) this.powerUpManager.reset();
            if (this.particleManager) {
                // Optional: Clear particles if needed, though they self-expire quickly
            }
            
            // Restore Barriers
            if (this.stadium) {
                if (this.stadium.barrierA) this.stadium.barrierA.visible = true;
                if (this.stadium.barrierB) this.stadium.barrierB.visible = true;
            }

            // Reset Ball
            if (this.entities.ball) this.entities.ball.reset();
            // Reset Teams
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            
            // Clear ball holder
            if (this.entities.ball) this.entities.ball.drop();

            // CRITICAL: Snap camera to prevent disorientation
            if (this.cameraManager) {
                // Force update target first (usually ball)
                if (this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }

            // FASTER FLOW: Reduced delay from 2000ms to 100ms
            this.state = 'reset';
            this.stateTimer = 0.1;
            this.nextStatePayload = possessionTeamId;
        }


startKickoff(possessionTeamId) {
            // Stop all players immediately
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            // If a team has possession (after goal), standard kickoff
            if (possessionTeamId) {
                this.state = 'kickoff';
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) this.audioManager.playSFX('whistle');

                const team = this.teams[possessionTeamId];
                if (team) {
                    const mf = team.players.find(p => p.role === 'MF');
                    if (mf && this.entities.ball) {
                        this.entities.ball.grab(mf);
                        
                        // Snap camera to new holder
                        if (this.cameraManager) {
                            this.cameraManager.setTarget(mf.mesh, mf.velocity);
                            this.cameraManager.snapToTarget();
                        }
                    }
                }
                
this.state = 'kickoff';
                this.stateTimer = 0.8;
            } else {
                // NEUTRAL KICKOFF: "The Blitz Off" Cinematic Sequence
                this._startNeutralBlitzOff();
            }
        }


_startNeutralBlitzOff() {
            this.state = 'blitz_charge';
            this.blitzTimer = 0;
            
            // 1. Reset Ball to Center (Deep)
            const ball = this.entities.ball;
            if (ball && ball.mesh) {
                ball.drop();
                ball.mesh.position.set(0, -5, 0); // Start DEEP (-5m) for "ground up" rise
                ball.velocity.set(0, 0, 0);
                ball.angularVelocity.set(0, 0, 0);
                // Reset visuals
                if (ball.deformNode) ball.deformNode.scale.set(1, 1, 1);
            }

            // 2. Position Captains (MFs)
            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');

            if (homeMF && homeMF.mesh) {
                homeMF.mesh.position.set(0, 0, 8); // 8m back
                homeMF.mesh.lookAt(0, 0, 0);
                homeMF.play('idle', 0.1);
            }
            if (awayMF && awayMF.mesh) {
                awayMF.mesh.position.set(0, 0, -8); // 8m back
                awayMF.mesh.lookAt(0, 0, 0);
                awayMF.play('idle', 0.1);
            }

            // 3. Camera Focus
            if (this.cameraManager && ball && ball.mesh) {
                this.cameraManager.setTarget(ball.mesh, null);
                this.cameraManager.snapToTarget();
                // Zoom in tight
                this.cameraManager.currentPullBack = -12; 
                this.cameraManager.manualOrbitPitch = 0.4; // Look down steep
            }

            // Build Tension
            this.showAnnouncement("READY...", 'normal');
            if (this.audioManager) this.audioManager.playSFX('swim', { volume: 0.5 });
        }

        _updateBlitzCharge(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const chargeDuration = 2.0; // Longer build up for cinematic feel

            // PHASE 1: CHARGE (Rising from depths)
            if (this.blitzTimer < chargeDuration) {
                const t = this.blitzTimer / chargeDuration;
                const easeT = t * t; // Quadratic ease in
                
                // Rise from -5 to 0 (Ground up effect)
                ball.mesh.position.y = -5.0 + (5.0 * easeT);
                
                // Spin up (Exponential)
                ball.mesh.rotation.y += (10.0 + 50.0 * t) * dt;
                ball.mesh.rotation.x += (5.0 + 20.0 * t) * dt;

                // Squash (Flatten like a disc building energy)
                if (ball.deformNode) {
                    // Extreme squash at the end
                    const squash = 1.0 - (0.7 * easeT); // Flatten Y to 0.3
                    const stretch = 1.0 + (0.5 * easeT); // Expand XZ
                    ball.deformNode.scale.set(stretch, squash, stretch);
                }

                // Camera Shake increasing
                if (this.cameraManager) this.cameraManager.addShake(0.2 * t);

                // Particles: Rising Energy from ground
                if (this.particleManager) {
                    // Bubbles rising fast
                    const count = Math.floor(t * 8) + 1;
                    for(let i=0; i<count; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = 2.0 * (1.0 - t); // Radius shrinks as it gets closer to launch
                        const x = Math.cos(angle) * r;
                        const z = Math.sin(angle) * r;
                        const y = ball.mesh.position.y - 1.0; // Below ball
                        
                        this.particleManager.spawn('bubble', new THREE.Vector3(x, y, z), { 
                            life: 0.4, 
                            scale: 0.2 + t * 0.5 
                        });
                    }
                }
            } 
            // PHASE 2: LAUNCH
            else if (this.state === 'blitz_charge') {
                this.state = 'blitz_launch';
                this.blitzTimer = 0; // Reset for launch phase

                // TIMED ANNOUNCEMENT
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) {
                    this.audioManager.playSFX('impact', { volume: 1.0 }); // Boom
                    this.audioManager.playSFX('dash', { volume: 1.0 });   // Whoosh
                }

                // Launch Ball
                ball.velocity.set(0, 35, 0); // Shoot UP FAST
                if (ball.deformNode) ball.deformNode.scale.set(0.4, 3.0, 0.4); // Extreme stretch vertical

                // FX: Massive Ground Eruption
                if (this.particleManager) {
                    this.particleManager.spawn('shockwave', ball.mesh.position, { scale: 8.0 });
                    this.particleManager.spawn('flash', ball.mesh.position, { scale: 6.0 });
                    // Vertical stream
                    for(let i=0; i<10; i++) {
                        const p = ball.mesh.position.clone();
                        p.y += i * 0.5;
                        this.particleManager.spawn('dash_stream', p, { scale: 3.0 });
                    }
                }
                
                if (this.cameraManager) {
                    this.cameraManager.addShake(3.0); // Heavy shake
                    this.cameraManager.currentPullBack = 10; // Zoom out fast
                    this.cameraManager.manualOrbitPitch = 0.0; // Level out
                }

                // Captains Jump
                const homeMF = this.teams.home.players.find(p => p.role === 'MF');
                const awayMF = this.teams.away.players.find(p => p.role === 'MF');

                const jumpTo = (p) => {
                    if (!p || !p.mesh) return;
                    const dir = ball.mesh.position.clone().sub(p.mesh.position).normalize();
                    dir.y = 1.2; // Steep jump
                    p.velocity.copy(dir).multiplyScalar(18.0); // Fast jump
                    p.play('catch_jump', 0.1);
                };

                jumpTo(homeMF);
                jumpTo(awayMF);
            }
        }

        _updateBlitzLaunch(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            
            // Apply gravity manually for cinematic feel (Increased gravity for snappier arc)
            ball.velocity.y -= 40.0 * dt; 
            ball.mesh.position.addScaledVector(ball.velocity, dt);

            // Move Players manually
            const updateJumper = (p) => {
                if (!p || !p.mesh) return;
                p.velocity.y -= 25.0 * dt; // Gravity
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.lookAt(ball.mesh.position);
            };

            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');
            
            updateJumper(homeMF);
            updateJumper(awayMF);

            // PHASE 3: GRAB (Apex ~0.7s)
            if (this.blitzTimer > 0.7 && this.state === 'blitz_launch') {
                // Determine Winner (50/50 + Stat bias)
                const homeSp = homeMF.getStat('SP');
                const awaySp = awayMF.getStat('SP');
                const total = homeSp + awaySp;
                const roll = Math.random() * total;
                
                const winner = (roll < homeSp) ? homeMF : awayMF;
                
                ball.grab(winner);
                this.hideAnnouncement();
                
                if (this.floatingText) {
                    this.floatingText.spawn("WON!", winner.mesh.position, "tech");
                }

                // Transition to Active
                this.state = 'active';
                
                // Snap camera to winner
                if (this.cameraManager) {
                    this.cameraManager.setTarget(winner.mesh, winner.velocity);
                    // this.cameraManager.snapToTarget(); // Optional: Keep smooth or snap
                }
            }
        }
        
// Initial start
startMatch(mode) {
            console.log("Starting Match in mode:", mode);
            
            // Reset Score
            this.score.home = 0;
            this.score.away = 0;
            this._updateScoreUI();
            
            // Reset Time
            this.time = 0;
            this.half = 1;
            this.isOvertime = false; // Reset Sudden Death flag
            
            if (this.ui.half) {
                this.ui.half.innerText = "1st";
                this.ui.half.style.color = "";
                this.ui.half.style.textShadow = "";
            }
            
            if (mode === 'practice') {
                if (this.ui.half) this.ui.half.innerText = "PRAC";
                
                // Start Practice Manager
                if (this.practiceManager) {
                    this.practiceManager.start();
                }

                // In practice, ensure AI is enabled for sparring
                if (this.teams.away) {
                    this.teams.away.aiEnabled = true;
                }
                
                // Start BGM immediately for practice
                if (this.audioManager) {
                    this.audioManager.playBGM();
                }

                // Skip intro for practice
                this.resetRound();
            } else {
                // Ensure Practice Manager is stopped if normal game
                if (this.practiceManager) this.practiceManager.stop();
                
                // Safety: Ensure all players are visible (in case Practice hid them)
                if (this.teams.away) {
                    this.teams.away.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                    this.teams.away.aiEnabled = true; 
                }
                if (this.teams.home) {
                    this.teams.home.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                }

                // Start Cinematic Intro
                this.startIntroSequence();
            }
        }

skipIntro() {
            if (this.state !== 'intro') return;
            console.log("Intro Complete/Skipped");
            
            this.hideAnnouncement();
            
// RESTORE UI ELEMENTS
            const uiElements = [
                'hud-top',
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'auto-toggle', 
                'settings-button',
                'controls-hint'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = ''; // Revert to CSS default
            });

            // Hide Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '0');
            }
            
// Lights on
            if (this.stadium) this.stadium.setAllLights(true);
            
            // Reset players to idle
            if (this.teams.home) this.teams.home.players.forEach(p => p.play('idle', 0.1));
            if (this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.1));
            
            // Start BGM after intro
            if (this.audioManager) {
                this.audioManager.playBGM();
            }

            this.resetRound(null);
        }

        startIntroSequence() {

            this.state = 'intro';
            this.introShotIndex = 0;
            this.introShotTimer = 0;
            this._hasRoared = false; // Reset roar flag
            
            // Initial setup
            if (this.stadium) this.stadium.setAllLights(false);

            // HIDE ALL UI ELEMENTS
            const uiElements = [
                'hud-top', 
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'tackle-button', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'joystick-visual-container',
                'aim-joystick-visual',
                'auto-toggle', 
                'settings-button',
                'controls-hint',
                'charge-meter-container',
                'practice-restore-btn'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Show Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '10%');
            }
            
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            if (this.entities.ball) this.entities.ball.reset();
            
            // Trigger first shot start
            if (this.introShots && this.introShots.length > 0) {
                if (this.introShots[0].onStart) this.introShots[0].onStart();
            } else {
                this.skipIntro();
            }
        }
_updateIntroWarmup(dt) {
            const allPlayers = [];
            if (this.teams.home) allPlayers.push(...this.teams.home.players);
            if (this.teams.away) allPlayers.push(...this.teams.away.players);

            allPlayers.forEach(p => {
                if (!p.mesh) return;

                // Ensure mixer updates (since game loop might skip player.update in intro state)
                if (p.mixer) p.mixer.update(dt);

                // Initialize warmup timer if needed
                if (p._warmupTimer === undefined) p._warmupTimer = Math.random() * 2.0;
                
                p._warmupTimer -= dt;

                if (p._warmupTimer <= 0) {
                    // Pick next action time (2s to 5s)
                    p._warmupTimer = 2.0 + Math.random() * 3.0;
                    
                    const rand = Math.random();
                    if (rand < 0.4) {
                        p.play('idle', 0.5);
                    } else if (rand < 0.6) {
                        p.play('swim', 0.5);
                    } else if (rand < 0.8) {
                        // "Stretch" / Celebrate
                        p.play('celebrate', 0.5);
                    } else if (rand < 0.9) {
                        p.play('catch', 0.5); // Checking gloves
                    } else {
                        p.play('react', 0.5); // Shake off
                    }
                }

                // Gentle bobbing (treading water)
                if (p.homePosition) {
                    p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.003 + p.mesh.id) * 0.3;
                }
            });
        }

setMenuMode(isActive) {
            this.state = isActive ? 'menu' : 'active';
            
            if (isActive && this.audioManager) {
                this.audioManager.stopBGM();
            }
            
            // List of static HUD elements to toggle
            const staticUI = [
                'hud-top',
                'player-status-panel',
                'action-container',
                'joystick-hit-zone',
                'aim-joystick-zone',
                'minimap-container',
                'goal-distance-container',
                'settings-button',
                'auto-toggle',
                'tackle-button',
                'controls-hint'
            ];

            // List of dynamic elements to FORCE HIDE in menu
            const dynamicUI = [
                'joystick-visual-container',
                'aim-joystick-visual',
                'charge-meter-container',
                'tech-flash-overlay',
                'practice-restore-btn'
            ];

            if (isActive) {
                // HIDE ALL
                [...staticUI, ...dynamicUI].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            } else {
                // SHOW STATIC ONLY
                staticUI.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'hud-top' || id === 'action-container') el.style.display = 'flex';
                        else el.style.display = 'block';
                    }
                });
                // Dynamic ones remain hidden/controlled by their logic
            }
        }
toggleDemoMode() {
            this.isDemoMode = !this.isDemoMode;
            console.log("Demo Mode:", this.isDemoMode);
            
            // Update UI Button
            const btn = document.getElementById('auto-toggle');
            if (btn) {
                btn.innerText = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
                if (this.isDemoMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // Announcement
            const text = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
            this.showAnnouncement(text);
            
            // Visual Flair: Spawn text above active player
            if (this.isDemoMode && this.floatingText && this.teams.home && this.teams.home.activePlayer && this.teams.home.activePlayer.mesh) {
                this.floatingText.spawn("AI ENGAGED", this.teams.home.activePlayer.mesh.position, "goal");
            }

            // Auto-hide announcement
setTimeout(() => {
                if (this.ui.announcement && this.ui.announcement.innerText === text) {
                    this.hideAnnouncement();
                }
            }, 1500);
        }

        // --- TECHCOPY SYSTEM ---

        triggerTechEvent(sourcePlayer, techName) {
            if (!sourcePlayer || !sourcePlayer.team) return;

            // Find opposing team
            const oppTeamId = sourcePlayer.team.id === 'home' ? 'away' : 'home';
            const oppTeam = this.teams[oppTeamId];
            if (!oppTeam) return;

            // Find who is marking this source
            const learners = oppTeam.players.filter(p => p.marking === sourcePlayer);
            
            if (learners.length === 0) return;

            // Only show UI if the learning team is Human (Home)
            // (Or if we are in Demo mode and want to see it happen for Home team)
            if (oppTeam.isHuman) {
                // Filter out those who already know it
                const validLearners = learners.filter(p => !p.learnedTechs.includes(techName));
                if (validLearners.length > 0) {
                    this.startTechCopyWindow(techName, validLearners);
                }
            }
        }

startTechCopyWindow(techName, learners) {
            this.techCopyState.active = true;
            this.techCopyState.maxTime = 0.6; // 0.6s window
            this.techCopyState.timer = this.techCopyState.maxTime;
            this.techCopyState.tech = techName;
            this.techCopyState.learners = learners;
            
            // Show UI
            if (this.ui.techFlash) {
                this.ui.techFlash.style.display = 'flex';
                this.ui.techFlash.style.background = ""; // Reset background
                this.ui.techFlash.querySelector('.tech-text').innerText = "TECHCOPY!";
                
                if (this.ui.techSub) {
                    this.ui.techSub.innerText = techName.replace('_', ' ');
                }
                
                // Reset bar
                if (this.ui.techTimerFill) {
                    this.ui.techTimerFill.style.width = '100%';
                }
            }
        }

attemptTechCopy() {
            if (!this.techCopyState.active) return false;
            
            // Success!
            const tech = this.techCopyState.tech;
            const learners = this.techCopyState.learners;
            
            learners.forEach(p => {
                // Double check to prevent duplicates
                if (!p.learnedTechs.includes(tech)) {
                    p.learnedTechs.push(tech);
                    console.log(`${p.role} learned ${tech}!`);
                    
                    // 1. Floating Text
                    if (this.floatingText && p.mesh) {
                        this.floatingText.spawn(`LEARNED!`, p.mesh.position, "tech");
                    }
                    
                    // 2. Particle Effect (Spiral)
                    if (this.particleManager && p.mesh) {
                        // Spawn multiple particles for a swirl effect
                        for(let i=0; i<10; i++) {
                            setTimeout(() => {
                                this.particleManager.spawn('learned', p.mesh.position);
                            }, i * 50);
                        }
                    }
                }
            });
            
            this.endTechCopyWindow(true);
            return true;
        }

endTechCopyWindow(success) {
            this.techCopyState.active = false;
            if (this.ui.techFlash) {
                if (success) {
                    this.ui.techFlash.querySelector('.tech-text').innerText = "SUCCESS!";
                    // Flash success color (White flash)
                    this.ui.techFlash.style.background = "rgba(255, 255, 255, 0.8)";
                    
                    // Hide after short delay to show the success flash
                    setTimeout(() => { 
                        this.ui.techFlash.style.display = 'none'; 
                    }, 300);
                } else {
                    // Failed / Missed
                    this.ui.techFlash.style.display = 'none';
                }
            }
        }
_updatePlayerStatusUI() {
            if (!this.teams.home || !this.teams.home.activePlayer) return;
            
            const p = this.teams.home.activePlayer;
            const ui = this.ui.statusPanel;
            
// UI Updates (Action Button Context)
                ui.container.style.display = 'block';
                
                // Name & Level
                if (ui.name) ui.name.innerText = `${p.characterName || p.role} LV${p.level}`;
                
                // HP
                if (ui.hpBar) {
                    const hpPct = Math.max(0, Math.min(100, (p.stats.HP / p.stats.maxHP) * 100));
                    ui.hpBar.style.width = `${hpPct}%`;
                    // Color shift
                    if (hpPct < 25) ui.hpBar.style.background = 'linear-gradient(90deg, #ff0000, #ff4444)';
                    else if (hpPct < 50) ui.hpBar.style.background = 'linear-gradient(90deg, #ffff00, #ffff88)';
                    else ui.hpBar.style.background = 'linear-gradient(90deg, #00ff00, #ccffcc)';
                }
                if (ui.hpText) ui.hpText.innerText = `${Math.floor(p.stats.HP)}/${p.stats.maxHP}`;
                
                // EXP
                if (ui.expBar) {
                    const expPct = Math.max(0, Math.min(100, (p.exp / p.nextLevelExp) * 100));
                    ui.expBar.style.width = `${expPct}%`;

                }
        }

_initParticles() {
            this.activeSparks = [];
            this.sparkPool = [];
            const poolSize = 40; // Sufficient for continuous grinding
            
            for (let i = 0; i < poolSize; i++) {
                const sprite = new THREE.Sprite(_sparkMaterial.clone());
                sprite.visible = false;
                this.scene.add(sprite);
                this.sparkPool.push(sprite);
            }
        }

        spawnClash(pos, intensity = 1.0) {
            // Find free spark
            const spark = this.sparkPool.find(s => !s.visible);
            if (!spark) return; // Pool exhausted
            
            spark.position.copy(pos);
            spark.visible = true;
            
            // Randomize rotation
            spark.material.rotation = Math.random() * Math.PI;
            
            // Initialize Active State
            this.activeSparks.push({
                mesh: spark,
                age: 0,
                life: 0.15 + Math.random() * 0.15, // Fast, punchy sparks
                maxScale: 2.5 * intensity,
                velocity: new THREE.Vector3(
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8
                )
            });
        }

        _updateParticles(dt) {
            for (let i = this.activeSparks.length - 1; i >= 0; i--) {
                const p = this.activeSparks[i];
                p.age += dt;
                
                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    this.activeSparks.splice(i, 1);
                    continue;
                }
                
                const t = p.age / p.life;
                
                // Expand
                const currentScale = 0.5 + (p.maxScale - 0.5) * t;
                p.mesh.scale.setScalar(currentScale);
                
                // Fade out
                p.mesh.material.opacity = 1.0 - (t * t); // Quadratic fade
                
                // Move
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.material.rotation += 10.0 * dt;
            }
        }

// Helper for impact frames

triggerImpact(duration, type = 'default') {
            this.impactPause = duration;
            
            // Trigger HUD Shake based on impact type
            let shakeAmount = 5.0;
            if (type === 'heavy') shakeAmount = 15.0;
            if (type === 'shatter') shakeAmount = 30.0;
            this.addHUDShake(shakeAmount);

            const container = document.getElementById('game-container');
            if (!container) return;

            // Clear any existing timeout to prevent early removal of new class
            if (this._impactTimeout) {
                clearTimeout(this._impactTimeout);
                this._impactTimeout = null;
            }

            // Reset classes to ensure animation restarts (reflow trick)
            container.classList.remove('impact-fx', 'impact-heavy', 'impact-shatter');
            
            // Force reflow
            void container.offsetWidth;

            let className = 'impact-fx';
            if (type === 'heavy') className = 'impact-heavy';
            if (type === 'shatter') className = 'impact-shatter';

            container.classList.add(className);

            // Auto-remove class after duration + buffer for animation tail
            // We add a bit more time than the pause duration to let the CSS animation finish
            const animDuration = (type === 'shatter' ? 500 : (type === 'heavy' ? 250 : 150));
            
            this._impactTimeout = setTimeout(() => {
                container.classList.remove(className);
                this._impactTimeout = null;
            }, animDuration);
        }

        addHUDShake(amount) {
            this.hudShakeIntensity = Math.min(this.hudShakeIntensity + amount, 50.0);
        }

        _updateHUDShake(dt) {
            if (this.hudShakeIntensity > 0) {
                // Decay
                this.hudShakeIntensity -= dt * 60.0; // Decay approx 60px per second
                if (this.hudShakeIntensity < 0) this.hudShakeIntensity = 0;

                const x = (Math.random() - 0.5) * this.hudShakeIntensity;
                const y = (Math.random() - 0.5) * this.hudShakeIntensity;
                
                const transform = `translate(${x.toFixed(1)}px, ${y.toFixed(1)}px)`;
                
                // Apply to main HUD containers
                const hudTop = document.getElementById('hud-top');
                if (hudTop) hudTop.style.transform = transform;
                
                const statusPanel = document.getElementById('player-status-panel');
                // Preserve existing skew
                if (statusPanel) statusPanel.style.transform = `skewX(-10deg) ${transform}`;
                
                const actionContainer = document.getElementById('action-container');
                if (actionContainer) actionContainer.style.transform = transform;
                
                const minimap = document.getElementById('minimap-container');
                if (minimap) minimap.style.transform = transform;

                this._hudShakeDirty = true;
            } else if (this._hudShakeDirty) {
                // Reset to clean state
                const hudTop = document.getElementById('hud-top');
                if (hudTop) hudTop.style.transform = '';
                
                const statusPanel = document.getElementById('player-status-panel');
                if (statusPanel) statusPanel.style.transform = 'skewX(-10deg)';
                
                const actionContainer = document.getElementById('action-container');
                if (actionContainer) actionContainer.style.transform = '';
                
                const minimap = document.getElementById('minimap-container');
                if (minimap) minimap.style.transform = '';
                
                this._hudShakeDirty = false;
            }
        }
_updateAudioState() {
            if (!this.audioManager) return;

            let tension = 0;

            // 1. Ball Threat
            const ball = this.entities.ball;
            if (ball && ball.mesh && (this.state === 'active' || this.state === 'blitz_launch')) {
                const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                const z = ball.mesh.position.z;
                const distToGoal = Math.min(Math.abs(z - goalDist), Math.abs(z + goalDist));
                const threatRange = 35.0;
                const ballThreat = Math.max(0, 1.0 - (distToGoal / threatRange));
                tension += ballThreat * ballThreat; // Quadratic ramp
            }

            // 2. Score Pressure (Close game)
            const diff = Math.abs(this.score.home - this.score.away);
            if (diff <= 1) tension += 0.15;

            // 3. Time Pressure (Last minute)
            const timeLeft = this.halfDuration - this.time;
            if (timeLeft < 60 && this.state === 'active') {
                tension += 0.2 * (1.0 - (timeLeft / 60));
            }

            if (this.audioManager.setMatchState) {
                this.audioManager.setMatchState(tension, this.isOvertime);
            }
}

        _updateEnvironmentalFX(dt) {
            // Only in active game or menu
            if (this.state === 'intro') return;

            this._envBubbleTimer = (this._envBubbleTimer || 0) - dt;
            
            if (this._envBubbleTimer <= 0) {
                // Random interval: 0.2s to 0.8s (Frequent streams)
                this._envBubbleTimer = 0.2 + Math.random() * 0.6;
                
                if (this.particleManager) {
                    // Pick a random spot on the floor
                    const x = (Math.random() - 0.5) * 70;
                    const z = (Math.random() - 0.5) * 90;
                    const yBase = -20; // Deep
                    
                    // Spawn a "Stream" (Burst of bubbles rising together)
                    const count = 3 + Math.floor(Math.random() * 5);
                    const streamSpeed = 3.0 + Math.random() * 4.0;
                    
                    for(let i=0; i<count; i++) {
                        const pos = new THREE.Vector3(
                            x + (Math.random()-0.5) * 1.0,
                            yBase - (Math.random() * 5.0), // Staggered start depth
                            z + (Math.random()-0.5) * 1.0
                        );
                        
                        this.particleManager.spawn('bubble_micro', pos, {
                            life: 4.0 + Math.random() * 2.0, // Long life to reach top
                            scale: 0.08 + Math.random() * 0.15, // Shimmery size
                            velocity: new THREE.Vector3(
                                (Math.random()-0.5) * 0.5, 
                                streamSpeed + (Math.random() * 2.0), 
                                (Math.random()-0.5) * 0.5
                            ),
                            drag: 0.1
                        });
                    }
                }
            }
        }
_advanceState() {
            switch (this.state) {
                case 'goal':
                    this.resetRound(this.nextStatePayload);
                    break;
                case 'reset':
                    this.startKickoff(this.nextStatePayload);
                    break;
                case 'kickoff':
                    this.hideAnnouncement();
                    this.state = 'active';
                    break;
                case 'halftime':
                    this._hideModal();
                    if (this.half === 1) {
                        this.startSecondHalf();
                    } else {
                        // Check for OT or End
                        if (this.score.home === this.score.away) {
                             this.startOvertime();
                        } else {
                             this.endGame();
                        }
                    }
                    break;
                case 'golden_goal':
                    if (window.flux) window.flux.timeScale = 0.8; // Restore speed
                    this.endGame();
                    break;
            }
        }
    }

    window.flux.GameManager = GameManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class FloatingTextManager {
        constructor(scene, containerId, camera) {
            this.scene = scene;
            this.camera = camera;
            this.container = document.getElementById(containerId);
            this.texts = []; // Active instances
            this.pool = [];  // Inactive instances
            
            // Reusable vector for projection
            this._tempV = new THREE.Vector3();

            // Pre-allocate pool (30 elements)
            this._expandPool(30);
        }

        _expandPool(count) {
            if (!this.container) return;
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'floating-text-wrapper';
                wrapper.style.display = 'none';
                // Force hardware acceleration hint
                wrapper.style.willChange = 'transform, opacity';
                
                const inner = document.createElement('span');
                inner.className = 'floating-text-inner';
                wrapper.appendChild(inner);
                this.container.appendChild(wrapper);

                this.pool.push({
                    el: wrapper,
                    inner: inner,
                    worldPos: new THREE.Vector3(),
                    offset: new THREE.Vector3(),
                    velocity: new THREE.Vector3(),
                    gravity: 0,
                    drag: 0,
                    elasticity: 0.6,
                    floorY: -999,
                    life: 0,
                    maxLife: 1.0,
                    target: null
                });
            }
        }

        spawn(text, worldPos, type = 'default', target = null) {
            if (!this.container || !this.camera) return;

            let instance = this.pool.pop();
            if (!instance) {
                this._expandPool(5);
                instance = this.pool.pop();
            }

            // Reset State
            instance.worldPos.copy(worldPos);
            instance.offset.set(0, 0, 0);
            instance.velocity.set(0, 0, 0);
            instance.gravity = 0;
            instance.drag = 0;
            instance.elasticity = 0.6;
            instance.floorY = -999;
            instance.target = target;
            instance.el.style.display = 'block';
            instance.el.style.opacity = '1';
            // Move offscreen initially to prevent flash
            instance.el.style.transform = 'translate3d(-9999px, -9999px, 0)'; 

            // Update Text & Classes
            instance.inner.innerText = text;
            
            // Smart Class Assignment
            let classes = ['floating-text-inner'];
            classes.push(type);

            const upper = text.toString().toUpperCase();
            if (upper.includes('POISON') || upper.includes('VENOM')) classes.push('venom');
            else if (upper.includes('SLEEP') || upper.includes('NAP') || upper.includes('ZZZ')) classes.push('sleep');
            else if (upper.includes('WITHER')) classes.push('wither');
            else if (type === 'tech' || upper.includes('SHOT') || upper.includes('JECHT') || upper.includes('TACKLE')) classes.push('tech');
            else if (type === 'comic-impact') classes.push('comic-impact');
            else if (type === 'comic-action') classes.push('comic-action');
            else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage');
else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage');
            else if (type === 'save' || type === 'block') classes.push('save');
            
            // New Statuses
            else if (upper.includes('BLIND')) classes.push('blind');
            else if (upper.includes('SILENCE')) classes.push('silence');
            else if (upper.includes('SHIELD')) classes.push('shield');
            else if (upper.includes('HASTE')) classes.push('haste');
            else if (upper.includes('SLOW')) classes.push('slow');

            instance.inner.className = classes.join(' ');

            // Physics Setup
            if (classes.includes('damage') || classes.includes('save') || classes.includes('block')) {
                instance.target = null;
                instance.gravity = 40.0;
                instance.drag = 0.5;
// Initialize Floating Text
                const spread = 6.0;
                instance.velocity.set(
                    (Math.random() - 0.5) * spread,
                    15.0 + Math.random() * 5.0,
                    (Math.random() - 0.5) * spread
                );
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('comic-impact')) {
                instance.gravity = 0;
                instance.velocity.set((Math.random()-0.5)*2, 1.0, (Math.random()-0.5)*2);
                instance.life = 0.5;
                instance.maxLife = 0.5;
            } else if (classes.includes('comic-action')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 0.4;
                instance.maxLife = 0.4;
            } else if (classes.includes('tech')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 2.5;
                instance.maxLife = 2.5;
                instance.offset.y = 2.0;
            } else if (classes.includes('sleep')) {
                instance.gravity = -0.5;
                instance.velocity.set(0, 0.5, 0);
                instance.life = 3.0;
                instance.maxLife = 3.0;
instance.maxLife = 3.0;
            } else if (classes.includes('blind')) {
                instance.gravity = 0;
                instance.velocity.set(0, 1.0, 0);
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('silence')) {
                instance.gravity = 0;
                instance.velocity.set(0, 1.0, 0);
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('shield')) {
                instance.gravity = -10.0; // Float up fast
                instance.velocity.set(0, 2.0, 0);
                instance.life = 1.5;
                instance.maxLife = 1.5;
            } else if (classes.includes('haste')) {
                instance.gravity = -20.0;
                instance.velocity.set(0, 5.0, 0);
                instance.life = 1.0;
                instance.maxLife = 1.0;
            } else if (classes.includes('slow')) {
                instance.gravity = 20.0; // Heavy drop
                instance.velocity.set(0, -2.0, 0);
                instance.life = 1.5;
                instance.maxLife = 1.5;
            } else {
                instance.velocity.set(0, 3.0, 0);
                instance.gravity = 5.0;
                instance.life = 1.0;
                instance.maxLife = 1.0;
            }

            if (!target) {
                instance.worldPos.x += (Math.random() - 0.5) * 0.5;
                instance.worldPos.z += (Math.random() - 0.5) * 0.5;
            }
            instance.worldPos.y += 1.0;

            this.texts.push(instance);
            this.updatePosition(instance);
        }

        update(dt) {
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.life -= dt;

                if (t.target && t.target.parent) { 
                    t.worldPos.copy(t.target.position);
                    t.worldPos.y += 1.0; 
                }

                if (t.gravity !== 0 || t.velocity.lengthSq() > 0) {
                    t.velocity.y -= t.gravity * dt;
                    if (t.drag > 0) {
                        t.velocity.multiplyScalar(Math.max(0, 1.0 - (t.drag * dt)));
                    }
                    t.offset.addScaledVector(t.velocity, dt);

                    if (t.offset.y < t.floorY) {
                        t.offset.y = t.floorY;
                        t.velocity.y *= -t.elasticity;
                        t.velocity.x *= 0.7;
                        t.velocity.z *= 0.7;
                        if (Math.abs(t.velocity.y) < 2.0) t.velocity.y = 0;
                    }
                }

                if (t.life <= 0) {
                    t.el.style.display = 'none';
                    this.pool.push(t);
                    this.texts.splice(i, 1);
                } else {
                    this.updatePosition(t);
                    if (t.life < t.maxLife * 0.3) {
                        t.el.style.opacity = t.life / (t.maxLife * 0.3);
                    }
                }
            }
        }

        updatePosition(t) {
            this._tempV.copy(t.worldPos).add(t.offset);
            this._tempV.project(this.camera);

            // Optimization: Check bounds before setting style to avoid unnecessary paint
            if (this._tempV.z > 1 || Math.abs(this._tempV.x) > 1.1 || Math.abs(this._tempV.y) > 1.1) {
                 // Offscreen
                 if (t.el.style.display !== 'none') t.el.style.display = 'none';
            } else {
                if (t.el.style.display === 'none') t.el.style.display = 'block';
                
                const x = (this._tempV.x * .5 + .5) * this.container.clientWidth;
                const y = (-(this._tempV.y * .5) + .5) * this.container.clientHeight;
                
                // Use translate3d for GPU acceleration
                t.el.style.transform = `translate3d(${x.toFixed(1)}px, ${y.toFixed(1)}px, 0)`;
            }
        }
    }

    window.flux.FloatingTextManager = FloatingTextManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATORS ---
    
    // 1. Venom Bubble (Green, shiny, sharp)
    const _venomTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 4, 32, 32, 30);
        g.addColorStop(0, 'rgba(150, 255, 100, 0.9)');
        g.addColorStop(0.8, 'rgba(0, 200, 0, 0.5)');
        g.addColorStop(1, 'rgba(0, 50, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 2. Sleep Zzz
    const _napTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.font = 'bold italic 48px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#0000ff';
        ctx.shadowBlur = 4;
        ctx.fillText('Z', 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 3. Wither Smoke (Optimized to 32x32)
    const _witherTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(80, 80, 80, 0.8)');
        g.addColorStop(0.5, 'rgba(40, 40, 40, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 4. Shockwave Ring (Optimized to 64x64)
    const _shockwaveTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const cx = 32, cy = 32;
        const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 30);
        g.addColorStop(0, 'rgba(255, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    // 5. Flash Star (Optimized to 32x32)
    const _flashTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const cx = 16, cy = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        for(let i=0; i<4; i++) {
            const a = (i * Math.PI / 2);
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*15, cy + Math.sin(a)*15);
            ctx.lineTo(cx + Math.cos(a + 0.2)*5, cy + Math.sin(a + 0.2)*5);
        }
        ctx.fill();
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 10);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

// 6. Debris Shard (Atlas 2x2)
    const _debrisTex = (() => {
        const c = document.createElement('canvas');
        c.width = 128; c.height = 128; // 64x64 slots
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff';
        
        const drawPoly = (ox, oy, pts) => {
            ctx.save();
            ctx.translate(ox, oy);
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        };

        // Slot 0: Jagged
        drawPoly(0, 0, [[32, 5], [50, 60], [20, 45], [10, 55], [5, 10]]);
        // Slot 1: Triangle
        drawPoly(64, 0, [[32, 5], [60, 60], [5, 50]]);
        // Slot 2: Chunk
        drawPoly(0, 64, [[10, 10], [55, 15], [50, 50], [15, 55]]);
        // Slot 3: Sliver
        drawPoly(64, 64, [[20, 5], [40, 60], [30, 20]]);

        return new THREE.CanvasTexture(c);
    })();

    // 7. Bubble Texture (New: Aesthetic & Subtle)
    const _bubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, 64, 64);

        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 28);
        g.addColorStop(0, 'rgba(255, 255, 255, 0.95)'); 
        g.addColorStop(0.3, 'rgba(200, 240, 255, 0.4)');
        g.addColorStop(0.8, 'rgba(100, 200, 255, 0.1)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
        ctx.beginPath(); 
        ctx.arc(20, 20, 4, 0, Math.PI * 2); 
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    // 8. Micro Bubble (New: Sharp, high-vis cavitation)
    const _microBubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, 32, 32);
        
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
        g.addColorStop(0.3, 'rgba(220, 255, 255, 0.8)');
        g.addColorStop(0.6, 'rgba(100, 200, 255, 0.3)');
        g.addColorStop(1.0, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 16, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 9. Dash Stream (Square for Points)
    const _dashStreamTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        // Draw a streak in the middle
        const g = ctx.createLinearGradient(0, 0, 64, 0);
        g.addColorStop(0, 'rgba(0, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(200, 255, 255, 0.8)');
        g.addColorStop(1, 'rgba(0, 255, 255, 0)');
        
        ctx.fillStyle = g;
        ctx.fillRect(0, 28, 64, 8); // Centered vertically
        
return new THREE.CanvasTexture(c);
    })();

    // 10. Blind (Dark Cloud)
    const _blindTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(20, 20, 20, 0.9)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 14, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 11. Silence (Mute X)
    const _silenceTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.strokeStyle = '#ff00ff';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(8, 8); ctx.lineTo(24, 24);
        ctx.moveTo(24, 8); ctx.lineTo(8, 24);
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    // 12. Shield (Ring)
    const _shieldTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(16, 16, 12, 0, Math.PI*2); ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    // 13. Haste (Arrow)
    const _hasteTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.moveTo(8, 24); ctx.lineTo(16, 8); ctx.lineTo(24, 24);
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 14. Slow (Square)
    const _slowTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#888888';
        ctx.fillRect(8, 8, 16, 16);
        return new THREE.CanvasTexture(c);
    })();

    // --- PARTICLE BATCH SYSTEM (THREE.Points) ---
    class ParticleBatch {

        constructor(scene, texture, maxParticles = 200, blending = THREE.AdditiveBlending, grid = new THREE.Vector2(1, 1)) {
            this.maxParticles = maxParticles;
            this.activeCount = 0;
            this.grid = grid;
            
            // CPU State
            this.particles = [];
            for(let i=0; i<maxParticles; i++) {
                this.particles.push({
                    active: false,
                    pos: new THREE.Vector3(),
                    vel: new THREE.Vector3(),
                    life: 0,
                    maxLife: 1,
                    scale: 1,
                    startScale: 1,
                    rotation: 0,
                    rotationSpeed: 0, // NEW: Individual rotation speed
                    gravity: 0,
                    drag: 0,
                    color: new THREE.Color(1,1,1),
                    opacity: 1,
                    frame: 0 // NEW: Texture frame index
                });
            }

            // GPU Buffers
            this.positions = new Float32Array(maxParticles * 3);
            this.sizes = new Float32Array(maxParticles);
            this.rotations = new Float32Array(maxParticles);
            this.opacities = new Float32Array(maxParticles);
            this.colors = new Float32Array(maxParticles * 3);
            this.frames = new Float32Array(maxParticles); // NEW

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
            geo.setAttribute('size', new THREE.BufferAttribute(this.sizes, 1));
            geo.setAttribute('rotation', new THREE.BufferAttribute(this.rotations, 1));
            geo.setAttribute('opacity', new THREE.BufferAttribute(this.opacities, 1));
            geo.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));
            geo.setAttribute('frame', new THREE.BufferAttribute(this.frames, 1)); // NEW

            // Shader Material
            const mat = new THREE.ShaderMaterial({
                uniforms: {
                    map: { value: texture },
                    uGrid: { value: grid }
                },
                vertexShader: `
                    attribute float size;
                    attribute float rotation;
                    attribute float opacity;
                    attribute vec3 color;
                    attribute float frame;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    varying float vFrame;
                    void main() {
                        vRotation = rotation;
                        vOpacity = opacity;
                        vColor = color;
                        vFrame = frame;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_Position = projectionMatrix * mvPosition;
                        // Size attenuation
                        gl_PointSize = size * (300.0 / -mvPosition.z);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D map;
                    uniform vec2 uGrid;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    varying float vFrame;
                    void main() {
                        vec2 uv = gl_PointCoord;
                        vec2 centered = uv - 0.5;
                        float c = cos(vRotation);
                        float s = sin(vRotation);
                        vec2 rotated = vec2(centered.x * c - centered.y * s, centered.x * s + centered.y * c) + 0.5;
                        
                        // Atlas Logic
                        float fx = mod(vFrame, uGrid.x);
                        float fy = floor(vFrame / uGrid.x);
                        
                        // Map to grid cell
                        // Standard UV (0,0 bottom-left). We assume row 0 is top.
                        // Flip row index for GL coords if needed, but let's assume standard grid order.
                        // Row 0 = Top (High V), Row 1 = Bottom (Low V).
                        
                        float glRow = (uGrid.y - 1.0) - fy;
                        
                        vec2 cellUV = rotated / uGrid;
                        vec2 offset = vec2(fx / uGrid.x, glRow / uGrid.y);
                        
                        vec4 tex = texture2D(map, cellUV + offset);
                        
                        gl_FragColor = vec4(tex.rgb * vColor, tex.a * vOpacity);
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: blending
            });

            this.mesh = new THREE.Points(geo, mat);
            this.mesh.frustumCulled = false;
            scene.add(this.mesh);
            
            // Logic hook
            this.updateLogic = null;
        }

        spawn(pos, options) {
            // Find first inactive
            let p = null;
            for(let i=0; i<this.maxParticles; i++) {
                if(!this.particles[i].active) {
                    p = this.particles[i];
                    break;
                }
            }
            
            if (!p) return; // Pool full

            p.active = true;
            p.pos.copy(pos);
            p.life = options.life || 1.0;
            p.maxLife = p.life;
            p.startScale = options.scale || 1.0;
            p.scale = p.startScale;
p.rotation = options.rotation || 0;
            p.rotationSpeed = options.rotationSpeed || 0; // NEW
            p.vel.copy(options.velocity || new THREE.Vector3());
            p.gravity = options.gravity || 0;
            p.drag = options.drag || 0;
            if (options.color) p.color.set(options.color);
            else p.color.setHex(0xffffff);
            p.opacity = 1.0;
            p.frame = options.frame || 0; // NEW
        }

        update(dt) {
            let activeCount = 0;
            
            for(let i=0; i<this.maxParticles; i++) {
                const p = this.particles[i];
                if (!p.active) {
                    this.sizes[i] = 0; // Hide
                    continue;
                }

                p.life -= dt;
                if (p.life <= 0) {
                    p.active = false;
                    this.sizes[i] = 0;
                    continue;
                }

                // Physics
                if (p.gravity !== 0) p.vel.y -= p.gravity * dt;
                if (p.drag !== 0) p.vel.multiplyScalar(Math.max(0, 1.0 - p.drag * dt));
p.pos.addScaledVector(p.vel, dt);
                p.rotation += p.rotationSpeed * dt; // Apply rotation speed

                // Logic
                const t = 1.0 - (p.life / p.maxLife);
                if (this.updateLogic) {
                    this.updateLogic(p, t, dt);
                } else {
                    p.opacity = 1.0 - t;
                }

                // Update Buffers
                this.positions[i*3] = p.pos.x;
                this.positions[i*3+1] = p.pos.y;
                this.positions[i*3+2] = p.pos.z;
                
                this.sizes[i] = p.scale;
                this.rotations[i] = p.rotation;
this.rotations[i] = p.rotation;
                this.opacities[i] = p.opacity;
                this.frames[i] = p.frame; // Update frame buffer
                
                this.colors[i*3] = p.color.r;
                this.colors[i*3+1] = p.color.g;
                this.colors[i*3+2] = p.color.b;

                activeCount++;
            }

            if (activeCount > 0 || this.activeCount > 0) {
                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.mesh.geometry.attributes.size.needsUpdate = true;
this.mesh.geometry.attributes.rotation.needsUpdate = true;
                this.mesh.geometry.attributes.opacity.needsUpdate = true;
                this.mesh.geometry.attributes.color.needsUpdate = true;
                this.mesh.geometry.attributes.frame.needsUpdate = true; // Update frame buffer
                this.mesh.geometry.attributes.opacity.needsUpdate = true;
                this.mesh.geometry.attributes.color.needsUpdate = true;
            }
            this.activeCount = activeCount;
        }
    }

    class ParticleManager {
        constructor(scene) {
            this.scene = scene;
            this.batches = {};
            
            // Initialize Batches
// Initialize Batches (Optimized Counts)
this._createBatch('venom', _venomTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.y) * 0.05;
                p.opacity = 0.8 * (1.0 - Math.pow(t, 3));
            });

            this._createBatch('nap', _napTex, 10, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (0.5 + t * 1.5);
                p.opacity = 1.0 - Math.pow(t, 2);
                p.pos.x += Math.sin(t * 5) * 0.02;
            });

            this._createBatch('wither', _witherTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 0.6 * (1.0 - t);
                p.rotation += 0.05;
            });

            this._createBatch('learned', _venomTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.color.setHex(0x00ffff);
            });

            this._createBatch('shockwave', _shockwaveTex, 5, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * Math.pow(t, 0.5) * 5.0;
                p.opacity = 1.0 - Math.pow(t, 2);
            });

            this._createBatch('flash', _flashTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.rotation += 0.2;
            });

this._createBatch('debris', _debrisTex, 200, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
            }, new THREE.Vector2(2, 2)); // 2x2 Grid

this._createBatch('bubble', _bubbleTex, 300, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.z) * 0.02;
                p.scale = p.startScale * (1.0 + t * 0.2);
                p.opacity = 0.6 * (1.0 - Math.pow(t, 2));
                p.color.setHex(0xaaccff);
            });

this._createBatch('bubble_micro', _microBubbleTex, 1000, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t * 0.5);
                p.opacity = 0.9 * (1.0 - t);
                p.pos.x += Math.sin(t * 25.0 + p.pos.y * 0.5) * 0.015; // High freq shimmer
                p.pos.z += Math.cos(t * 20.0 + p.pos.y * 0.5) * 0.015;
            });

            this._createBatch('dash_stream', _dashStreamTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 0.8 * (1.0 - t);
            });

            this._createBatch('blind', _blindTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 0.8 * (1.0 - t);
                p.scale = p.startScale * (1.0 + t);
                p.pos.y += t * 0.5;
            });

            this._createBatch('silence', _silenceTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y += t * 0.5;
            });

            this._createBatch('shield', _shieldTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.scale = p.startScale * (1.0 + t * 0.5);
            });

            this._createBatch('haste', _hasteTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y += t * 1.0; // Fast rise
            });

this._createBatch('slow', _slowTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y -= t * 0.5; // Sink
            });

this._createBatch('shard', _debrisTex, 500, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.opacity = 1.0 - t;
            }, new THREE.Vector2(2, 2));
            // --- HERCULEAN TACKLE FX ---
            this._createBatch('gather', _flashTex, 50, THREE.AdditiveBlending, (p, t) => {
                // Particles sucking in
                p.opacity = Math.sin(t * Math.PI); // Fade in/out
                p.scale = p.startScale * (0.2 + t * 0.8); // Shrink as they die (t goes 1->0? No, t is 1.0 - life/maxLife. Wait.
                // In update(), t = 1.0 - (p.life / p.maxLife). So t goes 0 -> 1.
                // Actually let's check update(): const t = 1.0 - (p.life / p.maxLife);
                // Yes, t goes 0 to 1.
                // We want gather particles to start far and move in. Physics handles pos.
                // We want them to shrink as they reach center?
                p.scale = p.startScale * (1.0 - t * 0.5); 
                p.rotation += 0.2;
            });

this._createBatch('impact_shard', _debrisTex, 100, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t); // Shrink over time
                p.opacity = 1.0 - t;
            }, new THREE.Vector2(2, 2)); // 2x2 Grid
        }

_createBatch(name, tex, count, blending, logic, grid) {
            const batch = new ParticleBatch(this.scene, tex, count, blending, grid);
            if (logic) batch.updateLogic = logic;
            this.batches[name] = batch;
        }

        spawn(type, pos, options = {}) {
            const batch = this.batches[type];
            if (batch) {
                // Default physics params if not provided
                const opts = { ...options };
                
                // Initialize base velocity from options or zero
                let baseVel = (opts.velocity) ? opts.velocity.clone() : new THREE.Vector3();

                if (type === 'venom') {
                    opts.life = opts.life || 1.0 + Math.random() * 0.5;
                    baseVel.set(0, 1.0 + Math.random(), 0);
                    opts.scale = 0.3 + Math.random() * 0.2;
                } else if (type === 'nap') {
                    opts.life = 2.0;
                    baseVel.set((Math.random()-0.5)*0.2, 0.5, (Math.random()-0.5)*0.2);
                    opts.scale = 0.4;
                } else if (type === 'wither') {
                    opts.life = 1.5;
                    baseVel.set((Math.random()-0.5)*0.5, 0.5, (Math.random()-0.5)*0.5);
                    opts.rotation = Math.random() * Math.PI;
                } else if (type === 'shockwave') {
                    opts.life = opts.life || 0.4;
                    opts.scale = opts.scale || 2.0;
                } else if (type === 'flash') {
                    opts.life = 0.2;
                    opts.scale = opts.scale || 3.0;
                    opts.rotation = Math.random() * Math.PI;
} else if (type === 'debris') {
                    opts.life = 1.5;
                    const speed = 5.0 + Math.random() * 10.0;
                    baseVel.set(
                        (Math.random()-0.5) * speed,
                        (Math.random() * speed * 0.5) + 2.0,
                        (Math.random()-0.5) * speed
                    );
                    opts.gravity = 20.0;
                    opts.drag = 1.0;
                    opts.scale = (opts.scale || 0.3) * (0.5 + Math.random());
                    opts.rotation = Math.random() * Math.PI;
                    opts.rotationSpeed = (Math.random() - 0.5) * 10.0; // Random spin
                    opts.frame = Math.floor(Math.random() * 4); // Random shape
                } else if (type === 'bubble') {
                    opts.life = 1.0 + Math.random() * 1.0;
                    baseVel.set(
                        (Math.random() - 0.5) * 0.5,
                        0.5 + Math.random() * 1.0,
                        (Math.random() - 0.5) * 0.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.4);
                } else if (type === 'bubble_micro') {
                    opts.life = 0.4 + Math.random() * 0.4;
                    baseVel.set(
                        (Math.random() - 0.5) * 1.5,
                        1.5 + Math.random() * 2.0,
                        (Math.random() - 0.5) * 1.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.5);
                } else if (type === 'dash_stream') {
                    opts.life = 0.3;
                    opts.scale = opts.scale || 2.0;
                    opts.rotation = Math.random() * Math.PI;
// Duplicate removed
                } else if (type === 'blind') {
                    opts.life = 1.0;
                    opts.scale = 0.5;
                } else if (type === 'silence') {
                    opts.life = 1.0;
                    opts.scale = 0.4;
                } else if (type === 'shield') {
                    opts.life = 0.8;
                    opts.scale = 0.6;
                } else if (type === 'haste') {
                    opts.life = 0.5;
                    opts.scale = 0.4;
                } else if (type === 'slow') {
                    opts.life = 1.0;
                    opts.scale = 0.4;
                }

                // --- MOMENTUM INHERITANCE ---
                if (opts.emitterVelocity) {
                    const momentumScale = (opts.momentumScale !== undefined) ? opts.momentumScale : 0.2;
                    if (momentumScale !== 0) {
                        baseVel.addScaledVector(opts.emitterVelocity, momentumScale);
                    }
                }

                opts.velocity = baseVel;

                batch.spawn(pos, opts);
            }
}

        update(dt) {
            for (const key in this.batches) {
                this.batches[key].update(dt);
            }
        }
    }

    window.flux.ParticleManager = ParticleManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATION ---
    const _createGlyphTexture = (colorStr, type) => {
        const size = 256;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, size, size);
        
        // Glow settings
        ctx.shadowBlur = 15;
        ctx.shadowColor = colorStr;
        ctx.strokeStyle = colorStr;
        ctx.fillStyle = colorStr;
        ctx.lineCap = 'round';

        const cx = size / 2;
        const cy = size / 2;

        if (type === 'ring') {
            // Outer Ring
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, 0, Math.PI * 2);
            ctx.stroke();

            // Inner Ring
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 90, 0, Math.PI * 2);
            ctx.stroke();

            // Runes
ctx.font = '24px Spira, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 100;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                // Draw a simple rune-like shape
                ctx.beginPath();
                ctx.moveTo(-5, -5); ctx.lineTo(5, 0); ctx.lineTo(-5, 5);
                ctx.stroke();
                ctx.restore();
            }
        } else if (type === 'rune') {
            // Central Complex Rune
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - 60);
            ctx.lineTo(cx, cy + 60);
            ctx.moveTo(cx - 60, cy);
            ctx.lineTo(cx + 60, cy);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        const tex = new THREE.CanvasTexture(c);
        return tex;
    };

    const _techTexture = _createGlyphTexture('#00ffff', 'ring'); // Cyan Ring
    const _statusTexture = _createGlyphTexture('#ff00ff', 'rune'); // Magenta Rune
    const _chargeTexture = _createGlyphTexture('#ffff00', 'ring'); // Gold Ring

    class GlyphManager {
        constructor(scene) {
            this.scene = scene;
            this.glyphs = [];
            
            // Materials
            this.materials = {
                tech: new THREE.MeshBasicMaterial({ 
                    map: _techTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                status: new THREE.MeshBasicMaterial({ 
                    map: _statusTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                charge: new THREE.MeshBasicMaterial({ 
                    map: _chargeTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                })
            };

            // Pool
            this.pool = [];
            this.poolSize = 30;
            const geo = new THREE.PlaneGeometry(1, 1);
            
            for(let i=0; i<this.poolSize; i++) {
                const mesh = new THREE.Mesh(geo, this.materials.tech);
                mesh.visible = false;
                mesh.renderOrder = 2000; // Draw on top of water/arena
                this.scene.add(mesh);
                this.pool.push(mesh);
            }
        }

        spawn(type, pos, options = {}) {
            const mesh = this.pool.find(m => !m.visible);
            if (!mesh) return;

            mesh.visible = true;
            mesh.material = this.materials[type] || this.materials.tech;
            mesh.position.copy(pos);
            
            // Reset Material Opacity
            mesh.material.opacity = 1.0;

            // Defaults
            const scale = options.scale || 1.0;
            mesh.scale.set(scale, scale, scale);
            
            // Orientation
            if (options.faceCamera) {
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    mesh.lookAt(window.flux.gameInstance.camera.position);
                }
            } else if (options.orientation === 'vertical') {
                mesh.rotation.set(0, 0, 0);
                // Face camera Y-axis rotation only
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    const camPos = window.flux.gameInstance.camera.position;
                    const angle = Math.atan2(camPos.x - pos.x, camPos.z - pos.z);
                    mesh.rotation.y = angle;
                }
            } else {
                // Horizontal (Ground)
                mesh.rotation.set(-Math.PI / 2, 0, Math.random() * Math.PI);
            }

            if (options.offsetY) {
                mesh.position.y += options.offsetY;
            }

            this.glyphs.push({
                mesh: mesh,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                rotationSpeed: options.rotationSpeed || 1.0,
                scaleSpeed: options.scaleSpeed || 0,
                fade: options.fade !== undefined ? options.fade : true,
                followTarget: options.parent || null,
                offsetY: options.offsetY || 0
            });
        }
update(dt) {
            for (let i = this.glyphs.length - 1; i >= 0; i--) {
                const g = this.glyphs[i];
                g.age += dt;

                if (g.age >= g.life) {
                    g.mesh.visible = false;
                    this.glyphs.splice(i, 1);
                    continue;
                }

                const t = g.age / g.maxLife;

                // Follow target
                if (g.followTarget && g.followTarget.mesh) {
                    g.mesh.position.copy(g.followTarget.mesh.position);
                    g.mesh.position.y += g.offsetY;
                    
                    // If ground oriented, keep near floor
                    if (g.mesh.rotation.x === -Math.PI/2) {
                         g.mesh.position.y = 0.1 + g.offsetY;
                    }
                }

                // Animation
                g.mesh.rotation.z += g.rotationSpeed * dt;
                
                if (g.scaleSpeed !== 0) {
                    const s = g.mesh.scale.x + g.scaleSpeed * dt;
                    g.mesh.scale.set(s, s, s);
                }

                // Fade
                if (g.fade) {
                    let opacity = 1.0;
                    if (t < 0.1) opacity = t / 0.1;
                    else if (t > 0.7) opacity = 1.0 - ((t - 0.7) / 0.3);
                    g.mesh.material.opacity = opacity;
                }
            }
        }

        clear() {
            // Hide all active glyphs and reset list
            for (const g of this.glyphs) {
                if (g.mesh) g.mesh.visible = false;
            }
            this.glyphs = [];
        }
    }

    window.flux.GlyphManager = GlyphManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors to avoid Garbage Collection
    const _idealPos = new THREE.Vector3();
    const _idealLook = new THREE.Vector3();
    const _currentPos = new THREE.Vector3();
    const _currentLook = new THREE.Vector3();
    const _velocity = new THREE.Vector3();
    const _targetWorldPos = new THREE.Vector3();
    const _camOffset = new THREE.Vector3();
    const _lookAhead = new THREE.Vector3();
    const _goalPos = new THREE.Vector3();
    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();

    class CameraManager {
        constructor(camera, scene) {
            this.camera = camera;
            this.scene = scene;

            // --- IMPROVED CONFIGURATION ---
// --- IMPROVED CONFIGURATION ---
this.config = {
                // FIXED PERSPECTIVE SETTINGS
                baseDistance: 14.0,   // Closer for immersion (was 20.0)
                baseHeight: 8.0,      // Lower angle for chase feel (was 12.0)

                // IMPROVED: Faster, more responsive smoothing
                followSpeed: 6.0,     // Snappier follow
                lookSpeed: 4.0,       // Responsive look-at

                // Dynamic FOV
                fovBase: 65,          // Higher base FOV (was 50)
                fovMax: 85,           // Higher max for speed sensation (was 70)

                // IMPROVED: Look-ahead settings
                lookAheadDistance: 10.0, // Look further ahead
                lookAheadSmoothing: 4.0,

                // Smart framing
                ballTrackWeight: 0.15, 
                threatAwareness: true
            };

            // State
            this.target = null;
            this.ball = null; // Direct ball reference for smart framing
            this.targetVel = new THREE.Vector3();
            this.targetInput = new THREE.Vector3();
            this.smoothedInput = new THREE.Vector3();
            this.smoothedLookAhead = new THREE.Vector3();

            // Camera State
            this.pos = camera.position.clone();
            this.lookAt = new THREE.Vector3(0, 0, 0);

            // Orbit State
            this.currentYaw = Math.PI;
            this.targetYaw = Math.PI;

            // IMPROVED: Manual orbit from touch (right side of screen)
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
            this.orbitSensitivity = 0.004;
            this.autoRecenterTimer = 0;
            this.autoRecenterDelay = 3.0;

// Shake
            this.shakeIntensity = 0;
            this.shakeRoll = 0; // NEW: Rotational shake
this.shakeOffset = new THREE.Vector3();
            this.fovImpulse = 0;
this.rollImpulse = 0; // NEW: Dynamic tilt for curves
            this.recoilOffset = new THREE.Vector3(); // NEW: Directional Recoil
this.recoilOffset = new THREE.Vector3(); // NEW: Directional Recoil
            this.aberrationImpulse = 0; // NEW: Chromatic Aberration Kick
            // Cinematic State
            this.isCinematic = false;
            this.cinematicTimer = 0;
            this.cinematicDuration = 0;
            this.cinematicType = 'default';
            this.cinematicStartPos = new THREE.Vector3();
            this.cinematicStartLook = new THREE.Vector3();
            this.cinematicEndPos = new THREE.Vector3();

            // IMPROVED: Dynamic pull-back based on action
            this.currentPullBack = 0;
            this.maxPullBack = 8;
        }

        // NEW: Set ball reference for smart framing
        setBall(ball) {
            this.ball = ball;
        }

        // IMPROVED: Get camera-relative input transformation
        getCameraRelativeInput(inputX, inputZ) {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), _camFwd).normalize();

            // Transform input to world space
            const worldX = (inputX * _camRight.x) + (inputZ * _camFwd.x);
            const worldZ = (inputX * _camRight.z) + (inputZ * _camFwd.z);

            return { x: worldX, z: worldZ };
        }

        // NEW: Manual orbit input from touch
        handleOrbitInput(dx, dy) {
            this.manualOrbitYaw += dx * this.orbitSensitivity;
            this.manualOrbitPitch += dy * this.orbitSensitivity * 0.5;

            // Clamp pitch
            this.manualOrbitPitch = Math.max(-0.3, Math.min(0.5, this.manualOrbitPitch));

            // Reset auto-recenter timer
            this.autoRecenterTimer = 0;
        }

        // NEW: Recenter camera
        recenter() {
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
        }

        playCinematic(type, target, duration = 1.5) {
            this.isCinematic = true;
            this.cinematicTimer = 0;
            this.cinematicDuration = duration;
            this.target = target;
            this.cinematicType = type;

            this.cinematicStartPos.copy(this.pos);
            this.cinematicStartLook.copy(this.lookAt);

            this.addFovImpulse(-15);
        }

        _updateCinematic(dt) {
            this.cinematicTimer += dt;
            const progress = Math.min(1.0, this.cinematicTimer / this.cinematicDuration);

            const t = 1 - Math.pow(1 - progress, 3);

            let activeTarget = this.target;
            let isBallTracking = false;
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;

            if (ball && ball.mesh && ball.state === 'free' && ball.velocity.lengthSq() > 2.0) {
                activeTarget = ball.mesh;
                isBallTracking = true;
            }

            if (!activeTarget) {
                this.isCinematic = false;
                return;
            }

            activeTarget.getWorldPosition(_targetWorldPos);

            const endLook = _targetWorldPos.clone();
            let fwd = new THREE.Vector3();
            let right = new THREE.Vector3();

            if (isBallTracking) {
                endLook.addScaledVector(ball.velocity, 0.3);

                fwd.copy(ball.velocity).normalize();
                fwd.y = 0;
                if (fwd.lengthSq() < 0.01) fwd.set(0,0,1);
                fwd.normalize();

                right.crossVectors(new THREE.Vector3(0,1,0), fwd).normalize();
            } else {
                endLook.y += 1.5;
                fwd.set(0, 0, 1).applyQuaternion(activeTarget.quaternion);
                right.set(1, 0, 0).applyQuaternion(activeTarget.quaternion);
            }

            const endPos = _targetWorldPos.clone();

            if (this.cinematicType === 'jecht') {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist).add(right.clone().multiplyScalar(3.0));
                endPos.add(offset);
                endPos.y += 6.0;
            } else if (this.cinematicType === 'sphere') {
                const dist = isBallTracking ? 16.0 : 12.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 10.0;
            } else if (this.cinematicType === 'invisible') {
                const dist = 12.0;
                const offset = fwd.clone().multiplyScalar(-dist * 0.5).add(right.clone().multiplyScalar(dist));
                endPos.add(offset);
                endPos.y += 5.0;
            } else {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 5.0;
            }

            this.pos.lerp(endPos, dt * 4.0);
            this.lookAt.lerp(endLook, dt * 6.0);

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            if (this.cinematicTimer >= this.cinematicDuration) {
                this.isCinematic = false;
            }
        }

setTarget(mesh, velocity, input, isAiming = false) {
            this.target = mesh;
            if (velocity) this.targetVel.copy(velocity);
            if (input) this.targetInput.copy(input);
            else this.targetInput.set(0, 0, 0);
            this.isAiming = isAiming;
        }

        // Keep for compatibility
        handleInput(dx, dy) {
            this.handleOrbitInput(dx, dy);
        }

        getYaw() { return this.currentYaw; }

        addShake(amount) {

            this.shakeIntensity = Math.min(this.shakeIntensity + amount, 4.0); // Increased cap
            this.shakeRoll = Math.min(this.shakeRoll + amount * 0.2, 0.8); // Add roll
        }
        addFovImpulse(amount) {
            this.fovImpulse = Math.min(this.fovImpulse + amount, 30);

        }
        addRollImpulse(amount) {
            this.rollImpulse += amount;
this.rollImpulse = Math.max(-0.5, Math.min(0.5, this.rollImpulse));
        }

        addRecoil(x, y, z) {
            this.recoilOffset.x += x;
            this.recoilOffset.y += y;
            this.recoilOffset.z += z;
this.recoilOffset.z += z;
        }

        addAberration(amount) {
            this.aberrationImpulse = Math.max(this.aberrationImpulse, amount);
        }

snapToTarget() {
            if (!this.target) return;
            this.target.getWorldPosition(_targetWorldPos);

            this._calculateIdealState(0);

            this.pos.copy(_idealPos);
            this.lookAt.copy(_idealLook);
            this.currentYaw = this.targetYaw;

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            this.smoothedInput.set(0, 0, 0);
            this.smoothedLookAhead.set(0, 0, 0);
        }

        update(dt) {
            if (this.isCinematic) {
                this._updateCinematic(dt);
                return;
            }

            if (!this.target) return;

            const safeDt = Math.min(dt, 0.05);

            // IMPROVED: Auto-recenter logic (Only if not aiming)
            if (!this.isAiming) {
                this.autoRecenterTimer += safeDt;
                if (this.autoRecenterTimer > this.autoRecenterDelay) {
                    const recenterSpeed = 2.0 * safeDt;
                    this.manualOrbitYaw *= (1.0 - recenterSpeed);
                    this.manualOrbitPitch *= (1.0 - recenterSpeed);
                }
            }

            // IMPROVED: Smart pull-back based on ball speed
            if (this.ball && this.ball.velocity) {
                const ballSpeed = this.ball.velocity.length();
                const targetPullBack = Math.min(this.maxPullBack, ballSpeed * 0.3);
                this.currentPullBack += (targetPullBack - this.currentPullBack) * safeDt * 3.0;
            } else {
                this.currentPullBack *= (1.0 - safeDt * 2.0);
            }

            // 1. Update Target Info
            this.target.getWorldPosition(_targetWorldPos);

            // 2. Calculate Ideal State
            this._calculateIdealState(safeDt);

            // 3. IMPROVED: Faster, more responsive smoothing
// 3. IMPROVED: Faster, more responsive smoothing
            // Dynamic follow speed based on distance error (Catch-up logic)
            const distError = this.pos.distanceTo(_idealPos);
            const dynamicFollow = this.config.followSpeed + (distError * 0.2);
            
            const speedMult = this.isAiming ? 2.0 : 1.0;
            const lookFactor = 1.0 - Math.exp(-this.config.lookSpeed * speedMult * safeDt);
            const posFactor = 1.0 - Math.exp(-dynamicFollow * speedMult * safeDt);

this.pos.lerp(_idealPos, posFactor);
            this.lookAt.lerp(_idealLook, lookFactor);

            // 4. Screen Shake (Position & Rotation)
            if (this.shakeIntensity > 0) {
                const decay = 8.0 * safeDt; // Fast decay for snappy feel
                this.shakeIntensity -= decay;
                if (this.shakeIntensity < 0) this.shakeIntensity = 0;

                const shakeMag = this.shakeIntensity * 0.5;
                this.shakeOffset.set(
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag
                );
            } else {
                this.shakeOffset.set(0, 0, 0);
            }

            // Roll Shake
            if (this.shakeRoll > 0) {
                this.shakeRoll -= 5.0 * safeDt;
                if (this.shakeRoll < 0) this.shakeRoll = 0;
                this.camera.rotation.z = (Math.random() - 0.5) * this.shakeRoll;
} else {
                this.camera.rotation.z = 0;
            }
            
            // Apply Curve Tilt (Roll Impulse)
            if (Math.abs(this.rollImpulse) > 0.001) {
                this.camera.rotation.z += this.rollImpulse;
this.rollImpulse *= (1.0 - 4.0 * safeDt); // Decay
            }

            // Recoil Decay
            this.recoilOffset.multiplyScalar(Math.max(0, 1.0 - (8.0 * safeDt)));
this.recoilOffset.multiplyScalar(Math.max(0, 1.0 - (8.0 * safeDt)));

            // Aberration Decay & Apply
            if (this.aberrationImpulse > 0) {
                this.aberrationImpulse *= Math.max(0, 1.0 - (5.0 * safeDt));
                if (this.aberrationImpulse < 0.1) this.aberrationImpulse = 0;
                
                if (window.flux.gameInstance && window.flux.gameInstance.postProcessing) {
                    // Base 1.5 + Impulse
                    window.flux.gameInstance.postProcessing.uniforms.uAberration.value = 1.5 + this.aberrationImpulse;
                }
            } else if (window.flux.gameInstance && window.flux.gameInstance.postProcessing) {
                // Reset to base if no impulse (and not dirty)
                if (window.flux.gameInstance.postProcessing.uniforms.uAberration.value > 1.6) {
                     window.flux.gameInstance.postProcessing.uniforms.uAberration.value = 1.5;
                }
            }
            // 5. Dynamic FOV
// 5. Dynamic FOV
            const speed = this.targetVel.length();
            const speedRatio = Math.min(speed / 25.0, 1.0);
            const warp = speedRatio * speedRatio;

            // Zoom in slightly when aiming
            const aimZoom = this.isAiming ? -10 : 0;
            const targetFov = this.config.fovBase + (this.config.fovMax - this.config.fovBase) * warp + this.fovImpulse + aimZoom;

            this.fovImpulse *= Math.max(0, 1.0 - (6.0 * safeDt));

            this.camera.fov += (targetFov - this.camera.fov) * 4.0 * safeDt;
            this.camera.updateProjectionMatrix();

// 6. Apply to Camera
            this.camera.position.copy(this.pos).add(this.shakeOffset).add(this.recoilOffset);
            this.camera.lookAt(this.lookAt);
        }

_calculateIdealState(dt) {
            const tPos = _targetWorldPos;

            // --- AIM MODE OVERRIDE ---
            if (this.isAiming) {
                // Relaxed Aim Mode: Zoom in but maintain orientation
                const aimDist = 14.0; 
                const aimHeight = 6.0;
                
                // Use Manual Orbit Logic (Consistent with Standard Mode)
                const effectiveDistance = aimDist;
                const effectiveHeight = aimHeight + this.manualOrbitPitch * 10;
                
                // Base Z offset (Camera defaults to +Z)
                const camZ = effectiveDistance;
                
                // Apply Orbit Rotation
                const finalX = camZ * Math.sin(this.manualOrbitYaw);
                const finalZ = camZ * Math.cos(this.manualOrbitYaw);
                
                _idealPos.set(tPos.x + finalX, tPos.y + effectiveHeight, tPos.z + finalZ);
                
                _idealLook.copy(tPos);
                _idealLook.y += 1.0; // Look at player center
                
                // Disable look-ahead to keep framing stable while aiming
                this.smoothedLookAhead.set(0,0,0);
                
                return;
            }

            // --- STANDARD MODE ---

            // 0. Threat Assessment (Dynamic Pull-back)
            let threatPullback = 0;
            if (this.config.threatAwareness) {
                const threat = this._calculateThreatLevel(tPos);
                threatPullback = threat * 6.0; // Pull back up to 6 units
            }

// IMPROVED: Apply manual orbit & Portrait Adjustment
// IMPROVED: Apply manual orbit & Portrait Adjustment
            const aspect = this.camera.aspect;
            // 9:16 is ~0.56. We trigger adjustment if narrower than square.
            const isPortrait = aspect < 0.85; 
            const portraitMult = isPortrait ? 1.7 : 1.0; // Pull back 70% more in portrait to see the field
            // 1. Calculate Ideal Position with pull-back
            const effectiveDistance = (this.config.baseDistance + this.currentPullBack + threatPullback) * portraitMult;
            const effectiveHeight = (this.config.baseHeight + this.currentPullBack * 0.3 + threatPullback * 0.5 + this.manualOrbitPitch * 10) * portraitMult;

            // Base offset (Camera usually sits at +Z relative to target)
            const camZ = effectiveDistance;

            // Apply Orbit Rotation
            const finalCamX = camZ * Math.sin(this.manualOrbitYaw);
            const finalCamZ = camZ * Math.cos(this.manualOrbitYaw);

            _idealPos.set(tPos.x + finalCamX, tPos.y + effectiveHeight, tPos.z + finalCamZ);

            // Clamp to arena bounds (roughly) to prevent clipping through walls
            if (_idealPos.z > 48.0) _idealPos.z = 48.0;
            if (_idealPos.z < -48.0) _idealPos.z = -48.0;

            // 2. Calculate Ideal LookAt with IMPROVED look-ahead
            _idealLook.copy(tPos);

            // IMPROVED: Velocity-based look-ahead
            if (this.targetVel.lengthSq() > 0.5) {
                const speed = this.targetVel.length();
                const lookAheadFactor = Math.min(1.0, speed / 15.0) * this.config.lookAheadDistance;

                const velDir = this.targetVel.clone().normalize();
                _lookAhead.copy(velDir).multiplyScalar(lookAheadFactor);

                // Smooth the look-ahead
                this.smoothedLookAhead.lerp(_lookAhead, dt * this.config.lookAheadSmoothing);
                _idealLook.add(this.smoothedLookAhead);
            } else {
                this.smoothedLookAhead.multiplyScalar(1.0 - dt * 3.0);
                _idealLook.add(this.smoothedLookAhead);
            }

            _idealLook.y *= 0.5; // Look slightly lower than actual target height

            // IMPROVED: Include ball in framing when nearby
            if (this.ball && this.ball.mesh && this.config.ballTrackWeight > 0) {
                const ballPos = this.ball.mesh.position;
                const distToBall = tPos.distanceTo(ballPos);

                if (distToBall < 25 && distToBall > 2) {
                    const ballWeight = Math.max(0, 1 - distToBall / 25) * this.config.ballTrackWeight;
                    _idealLook.lerp(ballPos, ballWeight);
                }
            }

            // 3. Input Anticipation (Smoothed)
            this.smoothedInput.lerp(this.targetInput, dt * 3.0);

            if (this.smoothedInput.lengthSq() > 0.01) {
                _idealLook.x += this.smoothedInput.x * 4.0;
                _idealLook.z += this.smoothedInput.z * 4.0;
            }
        }

        _calculateThreatLevel(centerPos) {
            if (!window.flux.gameInstance) return 0;
const game = window.flux.gameInstance;
            if (!game.teams) return 0;
            
            let density = 0;
            const checkTeam = (team) => {
                if (!team) return;
                for (let i = 0; i < team.players.length; i++) {
                    const p = team.players[i];
                    if (p.mesh && p.mesh !== this.target) {
                        const dSq = p.mesh.position.distanceToSquared(centerPos);
                        if (dSq < 64.0) { // 8m radius
                            density += 1.0;
                        }
                    }
                }
            };
            checkTeam(game.teams.home);
            checkTeam(game.teams.away);
            
            return Math.min(1.0, density / 4.0); // Cap at 4 players
        }

        // NEW: Get forward direction for UI reference
        getForwardDirection() {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;
            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }
            return _camFwd.clone();
        }

        // NEW: Get right direction
        getRightDirection() {
            const fwd = this.getForwardDirection();
            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), fwd).normalize();
            return _camRight.clone();
        }
    }

    window.flux.CameraManager = CameraManager;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Tooltip Descriptions for Long-Press
    const TOOLTIP_DESCRIPTIONS = {
        'SUBSTEPS': "Physics iterations per frame. Higher = more stable, more CPU.",
        'STOP_SPEED': "Velocity threshold below which the ball snaps to a halt.",
        'WATER_DRAG_LINEAR': "Base water resistance. Slows ball linearly.",
        'WATER_DRAG_QUAD': "Quadratic drag. Slows high-speed balls significantly.",
        'SPIN_DRAG': "How fast the ball's spin decays over time.",
        'MAGNUS_ENABLED': "Enables the Magnus effect (curve from spin).",
        'MAGNUS_COEFF': "Strength of the curve force relative to spin/speed.",
        'MAGNUS_CAP': "Maximum curve force allowed (prevents physics explosions).",
        'DEPTH_TARGET_Y': "Ideal Y height the ball tries to float at.",
        'DEPTH_SPRING': "Strength of the force pulling ball to Target Y.",
        'DEPTH_DAMP': "Damping on vertical movement to prevent oscillation.",
        'BOUNDARY_RADIUS': "Radius of the circular arena wall.",
        'BOUNDARY_HEIGHT': "Height of the arena ceiling/floor.",
        'WALL_SOFT_BUFFER': "Distance from wall where soft repulsion begins.",
        'WALL_SOFT_FORCE': "Force pushing ball away from wall before impact.",
        'WALL_ELASTICITY': "Bounciness of the wall (0 = dead thud, 1 = perfect bounce).",
        'WALL_FRICTION': "Friction when sliding along the wall.",
        'FLOOR_ELASTICITY': "Bounciness of the floor/ceiling.",
        'GOAL_POCKET_ENABLED': "Enables the extended corridor for the goal.",
        'GOAL_POCKET_X': "Half-width of the goal pocket corridor.",
        'GOAL_POCKET_Z': "Z-depth where the pocket starts.",
        'GOAL_POCKET_RADIUS': "Effective radius inside the pocket.",
        'LAUNCH_SPEED_SCALE': "Multiplier for converting Stat Power to Physics Velocity.",
        'LAUNCH_SPEED_CAP': "Maximum physical speed the ball can be thrown.",
        'SWIPE_MIN_PX': "Minimum swipe distance to register a throw.",
        'AIM_DX_SCALE': "Sensitivity of horizontal aim from swipe.",
        'AIM_DY_SCALE': "Sensitivity of vertical aim from swipe.",
        'POWER_BASE': "Base power multiplier for a quick tap.",
        'POWER_RANGE': "Additional power multiplier at full charge.",
        'POWER_MAX_BONUS_RATIO': "Charge threshold for 'Max Power' bonus.",
        'POWER_MAX_MULTIPLIER': "Multiplier applied when hitting Max Power.",
        'CURVE_ENABLED': "Enables curve shots via curved swipes.",
        'CURVE_INTENSITY_THRESHOLD': "How curved a swipe must be to trigger spin.",
        'CURVE_SPIN_SCALE': "Multiplier for converting swipe curve to ball spin.",
        'CURVE_SPEED_MULT': "Multiplier for spin based on swipe speed.",
        'CURVE_SPIN_CAP': "Maximum spin allowed from a curve throw.",
        'CURVE_PERFECT_SPIN': "Spin threshold to trigger 'Perfect Curve' FX.",
        'timeScale': "Global game speed multiplier.",
        'demoMode': "Toggle AI vs AI auto-play.",
        'resolution': "Internal render resolution scale (0.5 = half res).",
        'arenaOpacity': "Opacity of the outer arena grid.",
'arena2Opacity': "Opacity of the inner hex grid.",

'GOAL_DISTANCE': "Distance of the goals from the center (Z-axis).",
        'scanline': "Strength of the CRT scanline effect.",
        'vignette': "Darkening of the screen corners.",
        'noise': "Film grain intensity.",
        'aberration': "RGB color separation offset (Chromatic Aberration).",
        'contrast': "Global contrast adjustment.",
        'saturation': "Global color saturation adjustment."
    };
    class DevTools {
        constructor(gameManager) {
            this.game = gameManager;
            
            // lil-gui attaches to window.lil by default in UMD build
            if (!window.lil || !window.lil.GUI) {
                console.warn("DevTools: lil-gui not found.");
                return;
            }

const container = document.getElementById('game-container');
            this.gui = new window.lil.GUI({ title: 'Flux DevTools', container: container });
            
            // Position as a collapsed tab on the right frame
// Position as a sliding tab on the right frame
// Position as a sliding tab on the right frame
// Wrapper for sliding animation
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '100px';
            wrapper.style.right = '-260px';
            wrapper.style.width = '260px';
            wrapper.style.transition = 'right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0)';
            wrapper.style.zIndex = '9999';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            container.appendChild(wrapper);

            const dom = this.gui.domElement;
            dom.style.width = '100%';
            dom.style.setProperty('--width', '100%');
            dom.style.maxHeight = '80vh';
            dom.style.overflowY = 'auto';
            dom.style.overflowX = 'hidden';
            
            // Move GUI into wrapper
            wrapper.appendChild(dom);
            
            // Create Toggle Handle
            const handle = document.createElement('div');
            handle.style.position = 'absolute';
            handle.style.left = '-40px'; // Protrude to the left
            handle.style.top = '0';
            handle.style.width = '40px';
            handle.style.height = '40px';
            handle.style.backgroundColor = 'rgba(0, 20, 40, 0.9)';
            handle.style.border = '1px solid #00ffff';
            handle.style.borderRight = 'none';
            handle.style.borderTopLeftRadius = '8px';
            handle.style.borderBottomLeftRadius = '8px';
            handle.style.cursor = 'pointer';
            handle.style.display = 'flex';
            handle.style.justifyContent = 'center';
            handle.style.alignItems = 'center';
            handle.style.color = '#00ffff';
            handle.style.fontSize = '20px';
            handle.innerHTML = '';
            handle.style.boxShadow = '-5px 0 10px rgba(0,0,0,0.5)';
            
            wrapper.appendChild(handle);
            
            // Toggle Logic
            let isOpen = false;
            handle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent game inputs
                isOpen = !isOpen;
                wrapper.style.right = isOpen ? '0px' : '-260px';
                handle.innerHTML = isOpen ? '' : '';
            });
            // Default global timeScale if not set
if (window.flux.timeScale === undefined) window.flux.timeScale = 0.8;

this._setupGeneral();
            this._setupGameState();
this._setupOverlays();
            this._setupTeams();
            this._setupPlayerInspector();
            this._setupBallSandbox();
this._setupFXLab();
this._setupVisualDebug();
            this._setupVisuals();
            this._setupAudio();
            this._setupPostProcessing();
// Duplicate removed
            this._setupRuntimeMonitor();
            this._setupTooltips();

}

        _setupRuntimeMonitor() {
            const folder = this.gui.addFolder('Runtime Monitor');
            
            // Create DOM Overlay
            this.monitorEl = document.createElement('div');
            Object.assign(this.monitorEl.style, {
                position: 'absolute',
                top: '80px', 
                left: '10px',
                padding: '8px',
                background: 'rgba(0, 0, 0, 0.8)',
                border: '1px solid #00ff00',
                color: '#00ff00',
                fontFamily: 'monospace',
                fontSize: '11px',
                lineHeight: '1.4',
                pointerEvents: 'none',
                zIndex: '10000',
                display: 'none',
                minWidth: '150px',
                borderRadius: '4px',
                textShadow: '1px 1px 0 #000'
            });
            document.body.appendChild(this.monitorEl);

            const params = {
                showOverlay: false
            };

            folder.add(params, 'showOverlay').name('Show Overlay').onChange(v => {
                this.monitorEl.style.display = v ? 'block' : 'none';
            });
            
            // Start update loop
            setInterval(() => {
                if (params.showOverlay) this._updateMonitor();
            }, 50);
        }

        _updateMonitor() {
            if (!this.game) return;
            const gm = this.game;
            const ball = gm.entities.ball;

            let html = `<div style="border-bottom:1px solid #444; margin-bottom:4px; font-weight:bold; color:#fff">GAME STATE</div>`;
            html += `State: <span style="color:#fff">${gm.state}</span><br>`;
            html += `State Timer: ${gm.stateTimer.toFixed(2)}s<br>`;
            html += `Match Time: ${Math.floor(gm.time/60)}:${Math.floor(gm.time%60).toString().padStart(2,'0')} (H${gm.half})<br>`;
            
            html += `<div style="border-bottom:1px solid #444; margin-bottom:4px; margin-top:8px; font-weight:bold; color:#fff">BALL</div>`;
            if (ball && ball.mesh) {
                const stateColor = ball.state === 'free' ? '#0af' : (ball.state === 'held' ? '#fa0' : '#f0f');
                html += `State: <span style="color:${stateColor}">${ball.state}</span><br>`;
                
                let holderStr = 'None';
                if (ball.holder) {
                    const name = ball.holder.characterName || ball.holder.role;
                    const team = ball.holder.team ? ball.holder.team.id.toUpperCase() : '?';
                    holderStr = `${name} (${team})`;
                }
                html += `Holder: <span style="color:#fff">${holderStr}</span><br>`;
                
                const p = ball.mesh.position;
                html += `Pos: ${p.x.toFixed(1)}, ${p.y.toFixed(1)}, ${p.z.toFixed(1)}<br>`;
                html += `Speed: ${ball.velocity.length().toFixed(1)}<br>`;
                
                if (ball.power > 0) {
                    html += `Power: ${ball.power.toFixed(1)} (${ball.powerType})<br>`;
                }
            } else {
                html += `OFFLINE<br>`;
            }

            this.monitorEl.innerHTML = html;
        }

        _setupTooltips() {
            // Create Tooltip DOM
            this.tooltipEl = document.createElement('div');
            Object.assign(this.tooltipEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                backgroundColor: 'rgba(0, 10, 30, 0.95)',
                border: '2px solid #00ffff',
                padding: '20px',
                color: '#fff',
                fontFamily: 'monospace',
                fontSize: '14px',
                maxWidth: '300px',
                zIndex: '10000',
                display: 'none',
                pointerEvents: 'none',
                boxShadow: '0 0 20px rgba(0, 255, 255, 0.3)',
                borderRadius: '8px',
                textAlign: 'center'
            });
            document.body.appendChild(this.tooltipEl);

            // Recursive function to attach listeners
            const attach = (gui) => {
                // Controllers
                if (gui.controllers) {
                    gui.controllers.forEach(c => {
                        const dom = c.domElement.closest('.controller'); // lil-gui structure
                        if(dom) {
                            const label = dom.querySelector('.name');
                            if(label) {
                                this._addLongPress(label, c.property, c._name);
                            }
                        }
                    });
                }
                // Sub-folders
                if(gui.folders) {
                    gui.folders.forEach(f => attach(f));
                }
            };

            // Wait a tick for GUI to fully render DOM
            setTimeout(() => attach(this.gui), 100);
        }

        _addLongPress(element, property, name) {
            let timer = null;
            const duration = 500; // 0.5s

            const start = (e) => {
                timer = setTimeout(() => {
                    this._showTooltip(property, name);
                }, duration);
            };

            const end = () => {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                this._hideTooltip();
            };

            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start, {passive: true});
            
            element.addEventListener('mouseup', end);
            element.addEventListener('mouseleave', end);
            element.addEventListener('touchend', end);
            element.addEventListener('touchcancel', end);
        }

        _showTooltip(prop, name) {
            const desc = TOOLTIP_DESCRIPTIONS[prop];
            if(desc) {
                this.tooltipEl.innerHTML = `<strong style="color:#00ffff; font-size:16px;">${name || prop}</strong><br><br>${desc}`;
                this.tooltipEl.style.display = 'block';
            }
        }

        _hideTooltip() {
            if (this.tooltipEl) this.tooltipEl.style.display = 'none';
        }


_setupGeneral() {
            const folder = this.gui.addFolder('General');
            
const params = {
                timeScale: window.flux.timeScale,
                demoMode: this.game.isDemoMode,
                toggleHUD: true,
                resolution: 0.50,
arenaOpacity: 0.3,
                arena2Opacity: 0.25
            };

            folder.add(params, 'timeScale', 0.0, 5.0).name('Game Speed').onChange(v => {
                window.flux.timeScale = v;
            });

            folder.add(params, 'demoMode').name('Demo Mode').listen().onChange(v => {
                if (this.game.isDemoMode !== v) {
                    this.game.toggleDemoMode();
                }
            });

            folder.add(params, 'toggleHUD').name('Show HUD').onChange(v => {
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    hud.style.visibility = v ? 'visible' : 'hidden';
                }
            });

            folder.add(params, 'resolution', 0.1, 2.0).name('Resolution Scale').onChange(v => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const renderer = this.game.renderer;
                if (renderer) {
                    renderer.setSize(w * v, h * v, false);
                }
            });

folder.add(params, 'arenaOpacity', 0.0, 1.0).name('Arena 1 Opacity').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.opacity = v;
                }
            });

            const blendModes = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'NoBlending': THREE.NoBlending
            };
params.arenaBlend = 'Normal';

            folder.add(params, 'arenaBlend', Object.keys(blendModes)).name('Arena 1 Blend').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.blending = blendModes[v];
                    window.flux.arenaMesh.material.needsUpdate = true;
                }
            });

            // Arena 2 Controls
folder.add(params, 'arena2Opacity', 0.0, 1.0).name('Arena 2 Opacity').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material && window.flux.arenaMesh2.material.uniforms.uOpacity) {
                    window.flux.arenaMesh2.material.uniforms.uOpacity.value = v;
                }
            });

params.arena2Blend = 'Additive';
            folder.add(params, 'arena2Blend', Object.keys(blendModes)).name('Arena 2 Blend').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                    window.flux.arenaMesh2.material.blending = blendModes[v];
                    window.flux.arenaMesh2.material.needsUpdate = true;
                }
            });
            
            // Apply defaults
            if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                window.flux.arenaMesh.material.opacity = params.arenaOpacity;
            }
            if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                window.flux.arenaMesh2.material.opacity = params.arena2Opacity;
            }

            // --- Arena Graphics Controls ---
            this._setupArenaGraphics();
        }

        _setupArenaGraphics() {
            const folder = this.gui.addFolder('Arena Graphics');

            const threeBlends = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'NoBlending': THREE.NoBlending
            };

            // --- Blue Band ---
            if (window.flux.blueBandMat) {
                const blueFolder = folder.addFolder('Blue Band');
                const blueParams = {
                    visible: window.flux.blueBandMesh ? window.flux.blueBandMesh.visible : true,
                    opacity: window.flux.blueBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                blueFolder.add(blueParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.blueBandMesh) window.flux.blueBandMesh.visible = v;
                });
                blueFolder.add(blueParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.blueBandMat) window.flux.blueBandMat.opacity = v;
                });
                blueFolder.add(blueParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.blueBandMat) {
                        window.flux.blueBandMat.blending = threeBlends[v];
                        window.flux.blueBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Gold Band ---
            if (window.flux.goldBandMat) {
                const goldFolder = folder.addFolder('Gold Band');
                const goldParams = {
                    visible: window.flux.goldBandMesh ? window.flux.goldBandMesh.visible : false,
                    opacity: window.flux.goldBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                goldFolder.add(goldParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.goldBandMesh) window.flux.goldBandMesh.visible = v;
                });
                goldFolder.add(goldParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.goldBandMat) window.flux.goldBandMat.opacity = v;
                });
                goldFolder.add(goldParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.goldBandMat) {
                        window.flux.goldBandMat.blending = threeBlends[v];
                        window.flux.goldBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Yellow Arrows ---
            if (window.flux.arrowMat) {
                const arrowFolder = folder.addFolder('Yellow Arrows');
                const arrowParams = {
                    visible: window.flux.arrowGroup ? window.flux.arrowGroup.visible : true,
                    opacity: window.flux.arrowMat.opacity || 0.8,
                    blend: 'Additive'
                };
                arrowFolder.add(arrowParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.arrowGroup) window.flux.arrowGroup.visible = v;
                });
                arrowFolder.add(arrowParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.arrowMat) window.flux.arrowMat.opacity = v;
                });
                arrowFolder.add(arrowParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.arrowMat) {
                        window.flux.arrowMat.blending = threeBlends[v];
                        window.flux.arrowMat.needsUpdate = true;
                    }
                });
            }

            // --- Floor Glyph ---
            if (window.flux.floorGlyphMat) {
                const floorFolder = folder.addFolder('Floor Glyph');
                const floorParams = {
                    visible: window.flux.floorGlyphMesh ? window.flux.floorGlyphMesh.visible : true,
                    opacity: window.flux.floorGlyphMat.opacity || 0.35,
                    blend: 'Additive'
                };
                floorFolder.add(floorParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.floorGlyphMesh) window.flux.floorGlyphMesh.visible = v;
                });
                floorFolder.add(floorParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.floorGlyphMat) window.flux.floorGlyphMat.opacity = v;
                });
                floorFolder.add(floorParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.floorGlyphMat) {
                        window.flux.floorGlyphMat.blending = threeBlends[v];
                        window.flux.floorGlyphMat.needsUpdate = true;
                    }
                });
            }
        }

_setupOverlays() {
            const folder = this.gui.addFolder('Overlays & FX');
            
            // 1. GIF Overlay
            const gifEl = document.getElementById('screen-overlay-gif');
            if (gifEl) {
                const gifParams = {
                    visible: true,
opacity: 0.62,
                    blend: 'overlay'
                };
                
                const gFolder = folder.addFolder('Screen GIF');
                gFolder.add(gifParams, 'visible').onChange(v => gifEl.style.display = v ? 'block' : 'none');
                gFolder.add(gifParams, 'opacity', 0.0, 1.0).onChange(v => gifEl.style.opacity = v);
                
                const blendModes = [
                    'normal', 'multiply', 'screen', 'overlay', 
                    'darken', 'lighten', 'color-dodge', 'color-burn', 
                    'hard-light', 'soft-light', 'difference', 'exclusion', 
                    'hue', 'saturation', 'color', 'luminosity'
                ];
                gFolder.add(gifParams, 'blend', blendModes).onChange(v => gifEl.style.mixBlendMode = v);
            }

            // 2. Water Overlay
            const wo = this.game.waterOverlay;
            if (wo && wo.mesh) {
                const wFolder = folder.addFolder('Water Shader');
                const wParams = { 
                    visible: true,
                    opacity: wo.material.uniforms.uOpacity ? wo.material.uniforms.uOpacity.value : 0.5,
                    blend: 'Additive'
                };
                
                wFolder.add(wParams, 'visible').onChange(v => wo.mesh.visible = v);
                
                if (wo.material.uniforms.uOpacity) {
                    wFolder.add(wParams, 'opacity', 0.0, 2.0).onChange(v => wo.material.uniforms.uOpacity.value = v);
                }

                const threeBlends = {
                    'Normal': THREE.NormalBlending,
                    'Additive': THREE.AdditiveBlending,
                    'Subtractive': THREE.SubtractiveBlending,
                    'Multiply': THREE.MultiplyBlending,
                    'NoBlending': THREE.NoBlending
                };
                
                wFolder.add(wParams, 'blend', Object.keys(threeBlends)).onChange(v => {
                    wo.material.blending = threeBlends[v];
                    wo.material.needsUpdate = true;
                });
            }

            // 3. Light Shafts
            const ls = this.game.lightShafts;
            if (ls && ls.container) {
                const lParams = { visible: true };
                folder.add(lParams, 'visible').name('Light Shafts').onChange(v => ls.container.visible = v);
            }
        }

_setupGameState() {
            const folder = this.gui.addFolder('Game State');
            const gm = this.game;
            
            const params = {
                forceHomeGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('home'); 
                    else console.warn("Game must be active to trigger goal");
                },
                forceAwayGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('away');
                    else console.warn("Game must be active to trigger goal");
                },
                forceHalftime: () => {
                    if(gm.state === 'active') gm.endHalf();
                },
                resetRound: () => gm.resetRound(),
                exitToMenu: () => {
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        // Stop practice if running
                        if (window.flux.gameInstance.practiceManager) {
                            window.flux.gameInstance.practiceManager.stop();
                        }
                    }
                }
            };

            folder.add(params, 'forceHomeGoal').name('Trigger Home Goal');
            folder.add(params, 'forceAwayGoal').name('Trigger Away Goal');
            folder.add(params, 'forceHalftime').name('Force Halftime');
            folder.add(params, 'resetRound').name('Reset Round');
            folder.add(params, 'exitToMenu').name('Exit to Menu');
        }

        _setupTeams() {
            const folder = this.gui.addFolder('Teams');
            if (!this.game.teams.home || !this.game.teams.away) return;

            const home = this.game.teams.home;
            const away = this.game.teams.away;

            // Home
            const hFolder = folder.addFolder('Home Team');
            hFolder.add(home, 'isHuman').name('Is Human Controlled').listen();
            hFolder.add(home, 'aiEnabled').name('AI Logic Enabled').listen();

            // Away
            const aFolder = folder.addFolder('Away Team');
            aFolder.add(away, 'isHuman').name('Is Human Controlled').listen();
            aFolder.add(away, 'aiEnabled').name('AI Logic Enabled').listen();

        }

_setupPlayerInspector() {
            const folder = this.gui.addFolder('Player Inspector (Home Active)');
            
            // Helper to get current active player safely
            const getActive = () => {
                return (this.game.teams.home && this.game.teams.home.activePlayer) 
                    ? this.game.teams.home.activePlayer 
                    : null;
            };

            // Proxy object to bind GUI to dynamic target
            const proxy = {
                get Role() { 
                    const p = getActive();
                    return p ? p.role : '-'; 
                },
                
                get GodMode() { 
                    const p = getActive();
                    return p ? p.isGodMode : false; 
                },
                set GodMode(v) { 
                    const p = getActive();
                    if(p) p.isGodMode = v; 
                },

                // Runtime Values
                get HP() { 
                    const p = getActive();
                    return p ? p.stats.HP : 0; 
                },
                set HP(v) { 
                    const p = getActive();
                    if(p) p.stats.HP = v; 
                },
                
                get CurrentEN() { 
                    const p = getActive();
                    return p ? p.currentEN : 0; 
                },
                set CurrentEN(v) { 
                    const p = getActive();
                    if(p) p.currentEN = v; 
                },

                // Base Stats
                get MaxHP() { 
                    const p = getActive();
                    return p ? p.stats.maxHP : 0; 
                },
                set MaxHP(v) { 
                    const p = getActive();
                    if(p) p.stats.maxHP = v; 
                },

                get SP() { 
                    const p = getActive();
                    return p ? p.stats.SP : 0; 
                },
                set SP(v) { 
                    const p = getActive();
                    if(p) { 
                        p.stats.SP = v; 
                        p._updateDerivedStats(); 
                    } 
                },

                get EN() { 
                    const p = getActive();
                    return p ? p.stats.EN : 0; 
                }, 
                set EN(v) { 
                    const p = getActive();
                    if(p) {
                        p.stats.EN = v;
                    }
                },

                get AT() { 
                    const p = getActive();
                    return p ? p.stats.AT : 0; 
                },
                set AT(v) { 
                    const p = getActive();
                    if(p) p.stats.AT = v; 
                },

                get PA() { 
                    const p = getActive();
                    return p ? p.stats.PA : 0; 
                },
                set PA(v) { 
                    const p = getActive();
                    if(p) p.stats.PA = v; 
                },

                get BL() { 
                    const p = getActive();
                    return p ? p.stats.BL : 0; 
                },
                set BL(v) { 
                    const p = getActive();
                    if(p) p.stats.BL = v; 
                },

                get SH() { 
                    const p = getActive();
                    return p ? p.stats.SH : 0; 
                },
                set SH(v) { 
                    const p = getActive();
                    if(p) p.stats.SH = v; 
                },

                get CA() { 
                    const p = getActive();
                    return p ? p.stats.CA : 0; 
                },
                set CA(v) { 
                    const p = getActive();
                    if(p) p.stats.CA = v; 
                },

                // Actions
                LevelUp: () => { 
                    const p = getActive();
                    if(p) p.levelUp(); 
                },
                FullHeal: () => { 
                    const p = getActive(); 
                    if(p) { 
                        p.stats.HP = p.stats.maxHP; 
                        p.currentEN = p.getStat('EN'); 
                        p.status.venom = 0; 
                        p.status.nap = 0; 
                        for(let k in p.status.wither) p.status.wither[k] = 0;
                        if(window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("FULL HEAL", p.mesh.position, "heal");
                        }
                    } 
                },
                DrainEN: () => { 
                    const p = getActive();
                    if(p) {
                        p.currentEN = 0;
                        p.fumble(); // Trigger fumble logic
                    }
                }
            };

            folder.add(proxy, 'Role').listen().disable();
            folder.add(proxy, 'GodMode').name('God Mode (Inf HP/EN)').listen();

            const rtFolder = folder.addFolder('Runtime Status');
            rtFolder.add(proxy, 'HP', 0, 9999).listen();
            rtFolder.add(proxy, 'CurrentEN', 0, 100).name('Current EN').listen();

            const statFolder = folder.addFolder('Base Stats');
            statFolder.add(proxy, 'MaxHP', 100, 9999).listen();
            statFolder.add(proxy, 'EN', 0, 99).name('Max EN').listen();
            statFolder.add(proxy, 'SP', 0, 99).listen();
            statFolder.add(proxy, 'AT', 0, 99).listen();
            statFolder.add(proxy, 'PA', 0, 99).listen();
            statFolder.add(proxy, 'BL', 0, 99).listen();
            statFolder.add(proxy, 'SH', 0, 99).listen();
            statFolder.add(proxy, 'CA', 0, 99).listen();

            const actionFolder = folder.addFolder('Actions');
            actionFolder.add(proxy, 'LevelUp').name('Instant Level Up');
            actionFolder.add(proxy, 'FullHeal').name('Full Heal & Cure');
            actionFolder.add(proxy, 'DrainEN').name('Drain EN (Fumble)');
        }

_setupBallSandbox() {
    const root = this.gui.addFolder('Ball Lab (Throw & Physics)');

    // ------------------------------------------------------------
    // Shared state object (lives on window.flux so it survives reloads)
    // ------------------------------------------------------------
    const lab = window.flux.ballLab = window.flux.ballLab || {};
    lab.game = this.game;

    const C = window.flux.BallConfig;
    const TC = window.flux.ThrowConfig;

    if (!C || !TC) {
        console.warn("Ball Lab: Missing BallConfig or ThrowConfig.");
        return;
    }

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    const getBall = () => this.game && this.game.entities ? this.game.entities.ball : null;
    const getActive = () => this.game && this.game.teams && this.game.teams.home ? this.game.teams.home.activePlayer : null;

    const ensurePreviewLine = () => {
        if (lab.previewLine) return;
        if (!this.game || !this.game.scene) return;

        const geom = new THREE.BufferGeometry();
        const mat = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.95 });
        const line = new THREE.Line(geom, mat);
        line.frustumCulled = false;
        line.renderOrder = 999;
        this.game.scene.add(line);
        lab.previewLine = line;
    };

    const clearPreviewLine = () => {
        if (lab.previewLine && lab.previewLine.geometry) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry();
        }
    };

    // A safe "ghost ball" that can use Ball.updateFree without spawning FX
    const makeGhostBall = (pos, vel, spin) => {
        const gb = {
            mesh: { position: pos.clone() },
            velocity: vel.clone(),
            angularVelocity: (spin ? spin.clone() : new THREE.Vector3()),
            accumulatedRotation: new THREE.Quaternion(),
            power: 0,
            decayRate: 0,
            _bubbleTimer: 999,
            _ghost: true,
            deformNode: null
        };
        return gb;
    };

    // Use Ball.updateFree for faithful trajectory prediction
    const simulate = (ghostBall, steps, stepDt) => {
        const pts = [];
        pts.push(ghostBall.mesh.position.clone());
        const proto = window.flux.Ball && window.flux.Ball.prototype;
        if (!proto || typeof proto.updateFree !== 'function') return pts;

        for (let i = 0; i < steps; i++) {
            proto.updateFree.call(ghostBall, stepDt);
            pts.push(ghostBall.mesh.position.clone());
        }
        return pts;
    };

    // ------------------------------------------------------------
    // Preview + record/replay runtime loop
    // ------------------------------------------------------------
lab.preview = lab.preview || {
        enabled: false,
        source: 'Cannon',
        steps: 120,
        stepDt: 1/60,
        refreshHz: 10,
        showOnHeldOnly: false
    };

    lab.cannon = lab.cannon || {
        yaw: 0,
        pitch: 0,
        power: 20,
        type: 'SH',
        spinX: 0,
        spinY: 0,
        spinZ: 0,
        fireBurst: 1,
        spreadDeg: 0
    };

    lab.recording = lab.recording || {
        isRecording: false,
        frames: [],
        maxSeconds: 12
    };

    lab.replay = lab.replay || {
        isReplaying: false,
        frames: [],
        idx: 0,
        loop: true,
        speed: 1.0
    };

    lab.isReplaying = false;
    lab.targetBall = null;

    lab.applyReplayFrame = (ball, dt) => {
        const rep = lab.replay;
        if (!rep || !rep.isReplaying || !rep.frames || rep.frames.length === 0) {
            lab.isReplaying = false;
            return;
        }

        // Advance time by stepping indices (frame-based)
        const step = Math.max(1, Math.floor(rep.speed));
        rep.idx += step;

        if (rep.idx >= rep.frames.length) {
            if (rep.loop) rep.idx = 0;
            else { rep.isReplaying = false; lab.isReplaying = false; return; }
        }

        const f = rep.frames[rep.idx];
        if (!f) return;

        ball.drop(); // ensure no holder logic fights us
        ball.state = 'free';
        ball.mesh.position.set(f.px, f.py, f.pz);
        ball.velocity.set(f.vx, f.vy, f.vz);
        ball.angularVelocity.set(f.sx, f.sy, f.sz);
    };

    lab._previewTimer = lab._previewTimer || 0;

    lab.update = (dt) => {
        // --- recording ---
        const b = getBall();
        if (b && lab.recording && lab.recording.isRecording) {
            const r = lab.recording;
            const maxFrames = Math.floor((r.maxSeconds || 12) / (dt || (1/60)));
            if (r.frames.length > maxFrames) r.frames.shift();
            r.frames.push({
                px: b.mesh.position.x, py: b.mesh.position.y, pz: b.mesh.position.z,
                vx: b.velocity.x, vy: b.velocity.y, vz: b.velocity.z,
                sx: b.angularVelocity.x, sy: b.angularVelocity.y, sz: b.angularVelocity.z
            });
        }

        // --- preview refresh ---
        lab._previewTimer += dt;
        const refreshInterval = 1.0 / Math.max(1, (lab.preview.refreshHz || 10));
        if (lab.preview.enabled && lab._previewTimer >= refreshInterval) {
            lab._previewTimer = 0;
            lab.refreshPreview();
        }
    };

    lab.refreshPreview = () => {
        if (!lab.preview.enabled) { clearPreviewLine(); return; }
        ensurePreviewLine();

        const b = getBall();
        const p = getActive();
        if (!b || !b.mesh) return;

        if (lab.preview.showOnHeldOnly && b.state !== 'held') {
            clearPreviewLine();
            return;
        }

        // Decide preview source
        let startPos = b.mesh.position;
        let startVel = b.velocity;
        let startSpin = b.angularVelocity;

        if (lab.preview.source === 'Cannon') {
            // Cannon always launches from ball position (or player if held)
            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const dir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const cap = (window.flux.BallConfig.LAUNCH_SPEED_CAP !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_CAP : 85.0);
            const scale = (window.flux.BallConfig.LAUNCH_SPEED_SCALE !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_SCALE : 1.0);
            const speed = Math.min((lab.cannon.power || 20) * scale, cap);

            startPos = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();
            startVel = dir.multiplyScalar(speed);
            startSpin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
        }

        const ghost = makeGhostBall(startPos.clone(), startVel.clone(), startSpin);
        const pts = simulate(ghost, Math.floor(lab.preview.steps || 120), (lab.preview.stepDt || (1/60)));

        if (lab.previewLine) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry().setFromPoints(pts);
        }
    };

    // ------------------------------------------------------------
    // Folder: Ball Physics (BallConfig)
    // ------------------------------------------------------------
    const phys = root.addFolder('Ball Physics (BallConfig)');

    const integ = phys.addFolder('Integration');
    integ.add(C, 'SUBSTEPS', 1, 12, 1).name('Substeps');
    integ.add(C, 'STOP_SPEED', 0.0, 0.2).name('Stop Speed');

    const drag = phys.addFolder('Water Drag');
    drag.add(C, 'WATER_DRAG_LINEAR', 0.0, 2.0).name('Linear Drag');
    drag.add(C, 'WATER_DRAG_QUAD', 0.0, 0.05).name('Quadratic Drag');

    const spin = phys.addFolder('Spin');
    spin.add(C, 'SPIN_DRAG', 0.0, 3.0).name('Spin Decay');

    const magnus = phys.addFolder('Magnus');
    magnus.add(C, 'MAGNUS_ENABLED').name('Enabled');
    magnus.add(C, 'MAGNUS_COEFF', 0.0, 0.5).name('Coeff');
    magnus.add(C, 'MAGNUS_CAP', 0.0, 200.0).name('Cap');

    const depth = phys.addFolder('Depth Constraint');
    depth.add(C, 'DEPTH_TARGET_Y', -5.0, 5.0).name('Target Y');
    depth.add(C, 'DEPTH_SPRING', 0.0, 10.0).name('Spring');
    depth.add(C, 'DEPTH_DAMP', 0.0, 6.0).name('Damp');

    const arena = phys.addFolder('Arena Boundary');
    arena.add(C, 'BOUNDARY_RADIUS', 10.0, 120.0).name('Radius');
    arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
    arena.add(C, 'GOAL_DISTANCE', 20.0, 60.0).name('Goal Distance').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.position.z = -v;
        if (window.flux.goalB) window.flux.goalB.position.z = v;
        // Update Debug Visuals if active
        if (window.flux.gameInstance && window.flux.gameInstance.debugVisualizer) {
            window.flux.gameInstance.debugVisualizer.updateGoalVolumes();
        }
});
    arena.add(C, 'GOAL_Y_OFFSET', -50.0, 20.0).name('Goal Y Pos').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.position.y = v;
        if (window.flux.goalB) window.flux.goalB.position.y = v;
    });
    arena.add(C, 'GOAL_SCALE', 1.0, 100.0).name('Goal Scale').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.scale.setScalar(v);
        if (window.flux.goalB) window.flux.goalB.scale.setScalar(v);
    });
    arena.add(C, 'WALL_SOFT_BUFFER', 0.0, 20.0).name('Soft Buffer');
    arena.add(C, 'WALL_SOFT_FORCE', 0.0, 200.0).name('Soft Force');
    arena.add(C, 'WALL_ELASTICITY', 0.0, 1.0).name('Wall Bounce');
    arena.add(C, 'WALL_FRICTION', 0.0, 1.0).name('Wall Friction');
    arena.add(C, 'FLOOR_ELASTICITY', 0.0, 1.0).name('Ceil/Floor Bounce');

    const pocket = arena.addFolder('Goal Pocket');
    pocket.add(C, 'GOAL_POCKET_ENABLED').name('Enabled');
    pocket.add(C, 'GOAL_POCKET_X', 0.0, 40.0).name('Pocket Half-X');
    pocket.add(C, 'GOAL_POCKET_Z', 0.0, 50.0).name('Pocket Start |Z|');
    pocket.add(C, 'GOAL_POCKET_RADIUS', 10.0, 120.0).name('Pocket Radius');

    const launch = phys.addFolder('Launch Mapping');
    launch.add(C, 'LAUNCH_SPEED_SCALE', 0.1, 5.0).name('Speed Scale');
    launch.add(C, 'LAUNCH_SPEED_CAP', 10.0, 200.0).name('Speed Cap');

    // ------------------------------------------------------------
    // Folder: Throw mapping (Player.releaseCharge -> Ball.shoot)
    // ------------------------------------------------------------
    const throwMap = root.addFolder('Throw Mapping (ThrowConfig)');
    throwMap.add(TC, 'SWIPE_MIN_PX', 0, 120, 1).name('Swipe Min PX');
    throwMap.add(TC, 'AIM_DX_SCALE', 0.1, 5.0).name('Aim X Scale');
    throwMap.add(TC, 'AIM_DY_SCALE', 0.1, 5.0).name('Aim Y Scale');
    throwMap.add(TC, 'POWER_BASE', 0.1, 3.0).name('Power Base');
    throwMap.add(TC, 'POWER_RANGE', 0.0, 3.0).name('Power Range');
    throwMap.add(TC, 'POWER_MAX_BONUS_RATIO', 0.0, 1.0).name('Max Bonus Ratio');
    throwMap.add(TC, 'POWER_MAX_MULTIPLIER', 1.0, 6.0).name('Max Multiplier');

    const curveMap = throwMap.addFolder('Curve');
    curveMap.add(TC, 'CURVE_ENABLED').name('Enabled');
    curveMap.add(TC, 'CURVE_INTENSITY_THRESHOLD', 0.0, 1.0).name('Input Threshold');
    curveMap.add(TC, 'CURVE_SPIN_SCALE', 0.0, 4000.0).name('Spin Scale');
    curveMap.add(TC, 'CURVE_SPEED_MULT', 0.0, 5.0).name('Swipe Speed Mult');
    curveMap.add(TC, 'CURVE_SPIN_CAP', 0.0, 6000.0).name('Spin Cap');
    curveMap.add(TC, 'CURVE_PERFECT_SPIN', 0.0, 2000.0).name('Perfect Threshold');

    // ------------------------------------------------------------
    // Folder: Teleport / State tools
    // ------------------------------------------------------------
    const tp = root.addFolder('Teleport / Reset');
    const tpParams = {
        ToCenter: () => { const b = getBall(); if (b) b.reset(); },
        ToActivePlayer: () => { const b = getBall(); const p = getActive(); if (b && p) b.grab(p); },
        ToHomeGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, 25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToAwayGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, -25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToSky: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 10, 0); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ClearPreview: () => clearPreviewLine()
    };
    tp.add(tpParams, 'ToCenter');
    tp.add(tpParams, 'ToActivePlayer');
    tp.add(tpParams, 'ToHomeGoal');
    tp.add(tpParams, 'ToAwayGoal');
    tp.add(tpParams, 'ToSky');
    tp.add(tpParams, 'ClearPreview');

    // ------------------------------------------------------------
    // Folder: Shot Cannon (force fire with params)
    // ------------------------------------------------------------
    const cannon = root.addFolder('Shot Cannon');
    cannon.add(lab.cannon, 'yaw', -180, 180, 1).name('Yaw (deg)');
    cannon.add(lab.cannon, 'pitch', -89, 89, 1).name('Pitch (deg)');
    cannon.add(lab.cannon, 'power', 0, 120, 0.1).name('Power');
    cannon.add(lab.cannon, 'type', ['PA','SH']).name('Type');
    cannon.add(lab.cannon, 'spinX', -3000, 3000, 1).name('Spin X');
    cannon.add(lab.cannon, 'spinY', -3000, 3000, 1).name('Spin Y');
    cannon.add(lab.cannon, 'spinZ', -3000, 3000, 1).name('Spin Z');
    cannon.add(lab.cannon, 'fireBurst', 1, 10, 1).name('Burst Count');
    cannon.add(lab.cannon, 'spreadDeg', 0, 30, 0.5).name('Spread (deg)');

    const fireParams = {
        Fire: () => {
            const b = getBall();
            const p = getActive();
            if (!b) return;

            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const baseDir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const start = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();

            for (let i = 0; i < (lab.cannon.fireBurst || 1); i++) {
                const dir = baseDir.clone();
                if (lab.cannon.spreadDeg > 0) {
                    const spread = (lab.cannon.spreadDeg * Math.PI / 180);
                    dir.x += (Math.random()-0.5) * spread;
                    dir.y += (Math.random()-0.5) * spread;
                    dir.z += (Math.random()-0.5) * spread;
                    dir.normalize();
                }

                b.drop();
                b.mesh.position.copy(start);
                b.velocity.set(0,0,0);
                b.angularVelocity.set(0,0,0);

                const spin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
                b.shoot(dir, lab.cannon.power || 20, lab.cannon.type || 'SH', null, spin);
            }
        }
    };
    cannon.add(fireParams, 'Fire');

    // ------------------------------------------------------------
    // Folder: Trajectory Preview
    // ------------------------------------------------------------
    const preview = root.addFolder('Trajectory Preview');
    preview.add(lab.preview, 'enabled').name('Enabled').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'source', ['Cannon', 'Live Ball']).name('Source').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'steps', 10, 600, 1).name('Steps').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'stepDt', 1/240, 1/15, 1/240).name('Step dt').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'refreshHz', 1, 60, 1).name('Refresh Hz');
    preview.add(lab.preview, 'showOnHeldOnly').name('Only when Held').onChange(() => lab.refreshPreview());

    const previewBtns = {
        Refresh: () => lab.refreshPreview(),
        Hide: () => { lab.preview.enabled = false; clearPreviewLine(); }
    };
    preview.add(previewBtns, 'Refresh');
    preview.add(previewBtns, 'Hide');

    // ------------------------------------------------------------
    // Folder: Record / Replay
    // ------------------------------------------------------------
    const rr = root.addFolder('Record / Replay');
    const rrParams = {
        Record: () => {
            lab.recording.isRecording = true;
            lab.recording.frames = [];
        },
        Stop: () => {
            lab.recording.isRecording = false;
        },
        UseRecordingForReplay: () => {
            lab.replay.frames = (lab.recording.frames || []).slice();
            lab.replay.idx = 0;
        },
        Play: () => {
            const b = getBall();
            if (!b) return;
            lab.replay.isReplaying = true;
            lab.isReplaying = true;
            lab.targetBall = b;
            lab.replay.idx = 0;
        },
        Pause: () => {
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        },
        Clear: () => {
            lab.recording.frames = [];
            lab.replay.frames = [];
            lab.replay.idx = 0;
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        }
    };
    rr.add(rrParams, 'Record');
    rr.add(rrParams, 'Stop');
    rr.add(rrParams, 'UseRecordingForReplay').name('Copy Rec -> Replay');
    rr.add(lab.replay, 'loop').name('Loop');
    rr.add(lab.replay, 'speed', 0.25, 6.0, 0.25).name('Replay Speed');
    rr.add(rrParams, 'Play');
    rr.add(rrParams, 'Pause');
    rr.add(rrParams, 'Clear');

    // ------------------------------------------------------------
    // Folder: Presets
    // ------------------------------------------------------------
    const presets = root.addFolder('Presets');
    const P = {
        Vanilla: () => {
            Object.assign(C, {
                SUBSTEPS: 2,
                STOP_SPEED: 0.02,
                WATER_DRAG_LINEAR: 0.15,
                WATER_DRAG_QUAD: 0.002,
                SPIN_DRAG: 0.40,
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.08,
                MAGNUS_CAP: 60.0,
                DEPTH_TARGET_Y: 0.0,
                DEPTH_SPRING: 1.0,
                DEPTH_DAMP: 1.5,
                BOUNDARY_RADIUS: 33.0,
                BOUNDARY_HEIGHT: 15.0,
                WALL_SOFT_BUFFER: 3.0,
                WALL_SOFT_FORCE: 20.0,
                WALL_ELASTICITY: 0.30,
                WALL_FRICTION: 0.95,
                FLOOR_ELASTICITY: 0.40,
                GOAL_POCKET_ENABLED: true,
                GOAL_POCKET_X: 12.0,
                GOAL_POCKET_Z: 25.0,
                GOAL_POCKET_RADIUS: 45.0,
                LAUNCH_SPEED_SCALE: 1.0,
                LAUNCH_SPEED_CAP: 85.0
            });
            lab.refreshPreview();
        },
        ArcadeCurve: () => {
            Object.assign(C, {
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.16,
                MAGNUS_CAP: 90.0,
                SPIN_DRAG: 0.25,
                WATER_DRAG_LINEAR: 0.12,
                WATER_DRAG_QUAD: 0.001,
                WALL_SOFT_FORCE: 35.0,
                LAUNCH_SPEED_CAP: 110.0
            });
            Object.assign(TC, {
                CURVE_ENABLED: true,
                CURVE_SPIN_SCALE: 1500.0,
                CURVE_SPIN_CAP: 3000.0,
                CURVE_PERFECT_SPIN: 700.0
            });
            lab.refreshPreview();
        },
        SnappyRealistic: () => {
            Object.assign(C, {
                WATER_DRAG_LINEAR: 0.25,
                WATER_DRAG_QUAD: 0.006,
                MAGNUS_COEFF: 0.05,
                MAGNUS_CAP: 40.0,
                SPIN_DRAG: 0.75,
                STOP_SPEED: 0.05,
                LAUNCH_SPEED_CAP: 70.0
            });
            lab.refreshPreview();
        }
    };
    presets.add(P, 'Vanilla');
    presets.add(P, 'ArcadeCurve');
    presets.add(P, 'SnappyRealistic');

    // ------------------------------------------------------------
    // Folder: Snapshot / Export
    // ------------------------------------------------------------
    const snapshot = root.addFolder('Snapshot / Export');

    const _round = (n, places = 4) => {
        if (!Number.isFinite(n)) return null;
        const p = Math.pow(10, places);
        return Math.round(n * p) / p;
    };

    const _v3 = (v, places = 4) => {
        if (!v) return null;
        return [_round(v.x, places), _round(v.y, places), _round(v.z, places)];
    };

    const _cloneJson = (obj) => {
        if (!obj) return null;
        try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return null; }
    };

    const _playerSnap = (p) => {
        if (!p) return null;
        const anim = (p.activeAction && p.activeAction._clip) ? p.activeAction._clip.name : (p.state || null);
        return {
            name: p.characterName || p.name || null,
            role: p.role || null,
            state: p.state || null,
            hasBall: !!p.hasBall,
            isThrowing: !!p.isThrowing,
            isCharging: !!p.isCharging,
            isDashing: !!p.isDashing,
            dashCooldown: _round(p.dashCooldown, 4),
            pos: _v3(p.mesh && p.mesh.position),
            vel: _v3(p.velocity),
            input: _v3(p.inputVector),
            stats: p.stats ? _cloneJson(p.stats) : null,
            anim
        };
    };

    const _teamSnap = (t) => {
        if (!t) return null;
        const active = t.activePlayer ? _playerSnap(t.activePlayer) : null;
        return {
            id: t.id || null,
            side: t.side,
            isHuman: !!t.isHuman,
            aiEnabled: !!t.aiEnabled,
            currentFormation: t.currentFormation || null,
            activePlayer: active,
            players: Array.isArray(t.players) ? t.players.map(_playerSnap) : []
        };
    };

    const buildSnapshot = () => {
        const game = this.game || window.flux.gameInstance || null;
        const ball = game && game.entities ? game.entities.ball : null;
        const camMgr = game ? game.cameraManager : null;
        const cam = (camMgr && camMgr.camera) ? camMgr.camera : (game ? game.camera : null);

        const ballSnap = ball ? {
            state: ball.state || null,
            isInvisible: !!ball.isInvisible,
            holder: ball.holder ? (ball.holder.characterName || ball.holder.name || null) : null,
            lastHolder: ball.lastHolder ? (ball.lastHolder.characterName || ball.lastHolder.name || null) : null,
            pos: _v3(ball.mesh && ball.mesh.position),
            vel: _v3(ball.velocity),
            angVel: _v3(ball.angularVelocity),
            power: _round(ball.power, 4),
            shotType: ball.shotType || null
        } : null;

        const cameraSnap = cam ? {
            pos: _v3(cam.position),
            rot: cam.rotation ? [_round(cam.rotation.x, 4), _round(cam.rotation.y, 4), _round(cam.rotation.z, 4)] : null,
            fov: _round(cam.fov, 4),
            near: _round(cam.near, 6),
            far: _round(cam.far, 4)
        } : null;

        const camMgrSnap = camMgr ? {
            mode: camMgr.mode || null,
            targetName: (camMgr.target && (camMgr.target.characterName || camMgr.target.name)) || null,
            settings: camMgr.settings ? _cloneJson(camMgr.settings) : null
        } : null;

        const debugIO = window.flux && window.flux._debugIO ? window.flux._debugIO : null;
        const inputSnap = debugIO ? {
            settings: debugIO.settings ? _cloneJson(debugIO.settings) : null,
            perf: debugIO.perf ? _cloneJson(debugIO.perf) : null,
            move: (debugIO.input && debugIO.input.move) ? {
                touchId: debugIO.input.move.touchId ?? null,
                dragging: !!debugIO.input.move.dragging,
                vector: debugIO.input.move.vector ? _cloneJson(debugIO.input.move.vector) : null
            } : null,
            aim: (debugIO.input && debugIO.input.aim) ? {
                touchId: debugIO.input.aim.touchId ?? null,
                dragging: !!debugIO.input.aim.dragging,
                vector: debugIO.input.aim.vector ? _cloneJson(debugIO.input.aim.vector) : null
            } : null,
            swipe: (debugIO.input && debugIO.input.swipe) ? {
                touchId: debugIO.input.swipe.touchId ?? null,
                start: debugIO.input.swipe.start ? _cloneJson(debugIO.input.swipe.start) : null,
                points: Array.isArray(debugIO.input.swipe.points) ? debugIO.input.swipe.points.slice(-32).map(_cloneJson) : []
            } : null
        } : null;

        return {
            meta: {
                timestampISO: new Date().toISOString(),
                href: (typeof location !== 'undefined' && location.href) ? location.href : null,
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : null
            },
            game: game ? {
                score: game.score ? _cloneJson(game.score) : null,
                time: _round(game.time, 4),
                half: game.half ?? null,
                halfDuration: _round(game.halfDuration, 4),
                isOvertime: !!game.isOvertime,
                isDemoMode: !!game.isDemoMode
            } : null,
            config: {
                BallConfig: (window.flux && window.flux.BallConfig) ? _cloneJson(window.flux.BallConfig) : null,
                ThrowConfig: (window.flux && window.flux.ThrowConfig) ? _cloneJson(window.flux.ThrowConfig) : null
            },
            camera: cameraSnap,
            cameraManager: camMgrSnap,
            ball: ballSnap,
            teams: game ? {
                home: _teamSnap(game.teams && game.teams.home),
                away: _teamSnap(game.teams && game.teams.away)
            } : null,
            input: inputSnap
        };
    };

    const _copyText = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // Fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {}
        return false;
    };

    const _downloadText = (filename, text) => {
        try {
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Snapshot download failed:', e);
        }
    };

const snapshotActions = {
        CopySnapshot: async () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            const ok = await _copyText(text);
            console.log('[Snapshot]', snap);
            if (!ok) console.warn('Snapshot: copy failed (see console).');
        },
        DownloadSnapshot: () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            _downloadText('snapshot.json', text);
            console.log('[Snapshot]', snap);
        },
        CopyConfigs: async () => {
            const cfg = {
                BallConfig: window.flux.BallConfig,
                ThrowConfig: window.flux.ThrowConfig
            };
            const text = JSON.stringify(cfg, null, 4);
            const ok = await _copyText(text);
            if (ok) {
                console.log("Configs copied to clipboard!");
                alert("Configs copied to clipboard!");
            } else {
                console.warn("Copy failed");
                alert("Copy failed. Check console.");
            }
        }
    };

    snapshot.add(snapshotActions, 'CopySnapshot').name('Copy JSON Snapshot');
    snapshot.add(snapshotActions, 'DownloadSnapshot').name('Download snapshot.json');
    snapshot.add(snapshotActions, 'CopyConfigs').name('Copy Configs (For Dev)');

}
    }

    window.flux.DevTools = DevTools;

    DevTools.prototype._setupVisualDebug = function() {
        const folder = this.gui.addFolder('Visual Debugging');
        const dv = this.game.debugVisualizer;
        if (!dv) return;

const params = {
            enabled: dv.enabled,
            hitboxes: dv.showHitboxes,
            vectors: dv.showVectors,
            ai: dv.showAI,
            goalVolume: dv.showGoalVolume,
            goalDist: window.flux.BallConfig.GOAL_DISTANCE || 41.5,
            triggerOffset: window.flux.BallConfig.GOAL_TRIGGER_OFFSET || 1.0
        };

        folder.add(params, 'enabled').name('Enable Entity Viz').onChange(v => dv.enabled = v);
        folder.add(params, 'hitboxes').name('Show Hitboxes').onChange(v => dv.showHitboxes = v);
        folder.add(params, 'vectors').name('Show Vectors').onChange(v => dv.showVectors = v);
        folder.add(params, 'ai').name('Show AI Perception').onChange(v => dv.showAI = v);
        
const gFolder = folder.addFolder('Goal Volume Settings');
        gFolder.add(params, 'goalVolume').name('Show Goal Volume').onChange(v => {
            dv.showGoalVolume = v;
            if (dv.goalVol1) dv.goalVol1.visible = v;
            if (dv.goalVol2) dv.goalVol2.visible = v;
        });
        
        gFolder.add(params, 'goalDist', 20.0, 60.0).name('Goal Distance').onChange(v => {
            window.flux.BallConfig.GOAL_DISTANCE = v;
            if (window.flux.goalA) window.flux.goalA.position.z = -v;
            if (window.flux.goalB) window.flux.goalB.position.z = v;
            dv.updateGoalVolumes();
        });

        gFolder.add(params, 'triggerOffset', -5.0, 10.0).name('Trigger Offset').onChange(v => {
            window.flux.BallConfig.GOAL_TRIGGER_OFFSET = v;
            dv.updateGoalVolumes();
        });

        // Trigger Dimensions
// Trigger Dimensions & Position
        const trigParams = {
            width: window.flux.BallConfig.GOAL_TRIGGER_WIDTH || 28.0,
            centerY: ((window.flux.BallConfig.GOAL_TRIGGER_TOP_Y || 2.0) + (window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y || -18.0)) / 2,
            height: (window.flux.BallConfig.GOAL_TRIGGER_TOP_Y || 2.0) - (window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y || -18.0)
        };

        const updateTriggerFromCenter = () => {
            const half = trigParams.height / 2;
            window.flux.BallConfig.GOAL_TRIGGER_TOP_Y = trigParams.centerY + half;
            window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y = trigParams.centerY - half;
            dv.updateGoalVolumes();
        };

        gFolder.add(trigParams, 'centerY', -30, 30).name('Trigger Center Y').onChange(updateTriggerFromCenter);
        gFolder.add(trigParams, 'height', 1, 60).name('Trigger Height').onChange(updateTriggerFromCenter);
        
        gFolder.add(trigParams, 'width', 5, 50).name('Trigger Width').onChange(v => {
            window.flux.BallConfig.GOAL_TRIGGER_WIDTH = v;
            dv.updateGoalVolumes();
        });

        // Model Dimensions
        const modFolder = gFolder.addFolder('Model Dimensions');
        const modParams = {
            scale: window.flux.BallConfig.GOAL_SCALE || 45.0,
            sx: window.flux.BallConfig.GOAL_SCALE_X || 1.0,
            sy: window.flux.BallConfig.GOAL_SCALE_Y || 1.0,
            sz: window.flux.BallConfig.GOAL_SCALE_Z || 1.0,
            yOff: window.flux.BallConfig.GOAL_Y_OFFSET || -18.0
        };
        
        const updateModel = () => {
            const s = modParams.scale;
            const sx = modParams.sx;
            const sy = modParams.sy;
            const sz = modParams.sz;
            
            window.flux.BallConfig.GOAL_SCALE = s;
            window.flux.BallConfig.GOAL_SCALE_X = sx;
            window.flux.BallConfig.GOAL_SCALE_Y = sy;
            window.flux.BallConfig.GOAL_SCALE_Z = sz;
            window.flux.BallConfig.GOAL_Y_OFFSET = modParams.yOff;

            [window.flux.goalA, window.flux.goalB].forEach(g => {
                if(g) {
                    g.scale.set(s * sx, s * sy, s * sz);
                    g.position.y = modParams.yOff;
                }
            });
        };

        modFolder.add(modParams, 'scale', 1.0, 100.0).name('Base Scale').onChange(updateModel);
        modFolder.add(modParams, 'sx', 0.1, 3.0).name('Scale X (Width)').onChange(updateModel);
        modFolder.add(modParams, 'sy', 0.1, 3.0).name('Scale Y (Height)').onChange(updateModel);
        modFolder.add(modParams, 'sz', 0.1, 3.0).name('Scale Z (Depth)').onChange(updateModel);
        modFolder.add(modParams, 'yOff', -50.0, 20.0).name('Y Offset').onChange(updateModel);
    };

    DevTools.prototype._setupFXLab = function() {
        const folder = this.gui.addFolder('FX Lab & UI Test');
        
        const getTargetPos = () => {
            const p = this.game.teams.home.activePlayer;
            return p && p.mesh ? p.mesh.position : new THREE.Vector3(0, 2, 0);
        };

        const fxParams = {
            SpawnVenom: () => this.game.particleManager.spawn('venom', getTargetPos()),
            SpawnNap: () => this.game.particleManager.spawn('nap', getTargetPos()),
            SpawnWither: () => this.game.particleManager.spawn('wither', getTargetPos()),
            SpawnLearned: () => this.game.particleManager.spawn('learned', getTargetPos()),
            SpawnClash: () => this.game.spawnClash(getTargetPos()),
        };

        const fxSub = folder.addFolder('Particles');
        fxSub.add(fxParams, 'SpawnVenom');
        fxSub.add(fxParams, 'SpawnNap');
        fxSub.add(fxParams, 'SpawnWither');
        fxSub.add(fxParams, 'SpawnLearned');
        fxSub.add(fxParams, 'SpawnClash');

        const txtParams = {
            Text: "TEST",
            Type: "damage",
            Spawn: () => {
                if(this.game.floatingText) 
                    this.game.floatingText.spawn(txtParams.Text, getTargetPos(), txtParams.Type);
            }
        };
        
        const txtSub = folder.addFolder('Floating Text');
        txtSub.add(txtParams, 'Text');
        txtSub.add(txtParams, 'Type', ['damage', 'heal', 'status', 'tech', 'comic-impact', 'comic-action', 'save', 'block', 'default']);
        txtSub.add(txtParams, 'Spawn').name('Spawn Text');

        const camParams = {
            ShakeSmall: () => this.game.cameraManager.addShake(0.5),
            ShakeBig: () => this.game.cameraManager.addShake(2.0),
            ImpactLight: () => this.game.triggerImpact(0.1, 'default'),
            ImpactHeavy: () => this.game.triggerImpact(0.2, 'heavy'),
            ImpactShatter: () => this.game.triggerImpact(0.4, 'shatter'),
        };

        const camSub = folder.addFolder('Camera & Impact');
        camSub.add(camParams, 'ShakeSmall');
        camSub.add(camParams, 'ShakeBig');
        camSub.add(camParams, 'ImpactLight');
        camSub.add(camParams, 'ImpactHeavy');
        camSub.add(camParams, 'ImpactShatter');
    };


DevTools.prototype._setupVisuals = function() {
        const folder = this.gui.addFolder('Asset Forge');
        
        const forgeState = {
            active: false,
            assetName: 'Tidus',
            animName: 'idle',
            posX: 0, posY: 0, posZ: 0,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1.0,
            camDist: 5, camHeight: 1.5, camRot: 0
        };

        const assets = {
            'Tidus': 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb',
            'Wakka': 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb',
            'Letty': 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb',
            'Datto': 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb',
            'Jassu': 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb',
            'Botta': 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb',
            'Ball': 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb',
            'Goal': 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb'
        };

        let currentAsset = null;

        const updateTransform = () => {
            if (currentAsset) {
                currentAsset.position.set(forgeState.posX, forgeState.posY, forgeState.posZ);
                currentAsset.rotation.set(forgeState.rotX, forgeState.rotY, forgeState.rotZ);
                currentAsset.scale.setScalar(forgeState.scale);
            }
        };

        const updateCamera = () => {
            if (!forgeState.active) return;
            // Orbit around (1000, Y, 1000)
            const cx = 1000 + Math.sin(forgeState.camRot) * forgeState.camDist;
            const cz = 1000 + Math.cos(forgeState.camRot) * forgeState.camDist;
            this.game.camera.position.set(cx, forgeState.camHeight, cz);
            this.game.camera.lookAt(1000, forgeState.posY + 1, 1000);
        };

        const playAnimation = () => {
            if (!this.vizMixer || !this.vizClips) return;
            this.vizMixer.stopAllAction();
            if (forgeState.animName === 'none') return;
            
            let clip = this.vizClips.find(c => c.name === forgeState.animName);
            if (!clip) clip = this.vizClips.find(c => c.name.toLowerCase().includes(forgeState.animName.toLowerCase()));
            if (clip) this.vizMixer.clipAction(clip).play();
        };

        const spawnAsset = () => {
            if (!this.vizGroup) return;
            
            // Clear previous
            while(this.vizGroup.children.length > 0) {
                const child = this.vizGroup.children[0];
                this.vizGroup.remove(child);
            }
            
            this.vizMixer = null;
            currentAsset = null;

            const url = assets[forgeState.assetName];
            if (!url) return;

            console.log("Forge: Spawning", forgeState.assetName);

            window.flux.AssetLoader.loadModel(url, (gltf) => {
                // Check if we are still in forge mode before adding
                if (!forgeState.active) return;

                const model = gltf.scene;
                this.vizGroup.add(model);
                currentAsset = model;
                
                // Reset model transform relative to group
                model.position.set(0,0,0);
                model.rotation.set(0,0,0);
                
                updateTransform();

                if (gltf.animations && gltf.animations.length > 0) {
                    this.vizMixer = new THREE.AnimationMixer(model);
                    this.vizClips = gltf.animations;
                    playAnimation();
                }
            });
        };

        const toggleForge = (isActive) => {
            forgeState.active = isActive;
            this.game.isForgeMode = isActive; // Critical: Tell main.js to stop game loop
            
            // Toggle Game Visibility (Hide everything in the main arena)
            const gameLayer = [this.game.teams.home, this.game.teams.away, this.game.entities.ball];
            gameLayer.forEach(t => {
                if(t && t.players) t.players.forEach(p => { if(p.mesh) p.mesh.visible = !isActive; });
                else if(t && t.mesh) t.mesh.visible = !isActive;
            });
            if(window.flux.arenaMesh) window.flux.arenaMesh.visible = !isActive;
            if(window.flux.arenaMesh2) window.flux.arenaMesh2.visible = !isActive;
            if(this.game.stadium && this.game.stadium.container) this.game.stadium.container.visible = !isActive;
            if(this.game.waterOverlay && this.game.waterOverlay.mesh) this.game.waterOverlay.mesh.visible = !isActive;
            
            // Hide UI
            const ui = document.getElementById('ui-layer');
            if(ui) ui.style.display = isActive ? 'none' : 'flex';

            if (isActive) {
                // Initialize Forge Scene if needed
                if (!this.vizGroupParent) {
                    this.vizGroupParent = new THREE.Group();
                    this.game.scene.add(this.vizGroupParent);
                    
                    this.vizGroup = new THREE.Group();
                    this.vizGroup.position.set(1000, 0, 1000); // Far away from arena
                    this.vizGroupParent.add(this.vizGroup);

                    const grid = new THREE.GridHelper(20, 20, 0x00ffff, 0x444444);
                    grid.position.set(1000, 0, 1000);
                    this.vizGroupParent.add(grid);

                    this.vizLight = new THREE.DirectionalLight(0xffffff, 1.0);
                    this.vizLight.position.set(1005, 10, 1005);
                    this.game.scene.add(this.vizLight);
                    
                    this.vizAmbient = new THREE.AmbientLight(0x404040);
                    this.game.scene.add(this.vizAmbient);
                }
                
                this.vizGroupParent.visible = true;
                this.vizLight.visible = true;
                this.vizAmbient.visible = true;
                
                spawnAsset();
                updateCamera();
                
            } else {
                // Restore Game
                if (this.vizGroupParent) this.vizGroupParent.visible = false;
                if (this.vizLight) this.vizLight.visible = false;
                if (this.vizAmbient) this.vizAmbient.visible = false;
                
                // Snap camera back to game target
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        };

        folder.add(forgeState, 'active').name('Enable Forge').onChange(toggleForge);
        folder.add(forgeState, 'assetName', Object.keys(assets)).name('Select Asset').onChange(spawnAsset);
        
        const tf = folder.addFolder('Transform');
        tf.add(forgeState, 'posX', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posY', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posZ', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'rotX', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotY', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotZ', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'scale', 0.1, 3.0).onChange(updateTransform);

        folder.add(forgeState, 'animName', ['none', 'idle', 'swim', 'throw', 'catch', 'react']).name('Animation').onChange(playAnimation);

        const cf = folder.addFolder('Camera');
        cf.add(forgeState, 'camDist', 2, 15).onChange(updateCamera);
        cf.add(forgeState, 'camHeight', 0, 10).onChange(updateCamera);
        cf.add(forgeState, 'camRot', 0, 6.28).onChange(updateCamera);

        // Hook Game Loop
        const originalUpdate = this.game.update.bind(this.game);
        this.game.update = (dt) => {
            if (forgeState.active) {
                // Forge Mode: Only update forge components and render
                if (this.vizMixer) this.vizMixer.update(dt);
                
                // Force Camera Update here since main.js loop is skipped
                updateCamera();

                if (this.game.renderer && this.game.scene && this.game.camera) {
                    this.game.renderer.render(this.game.scene, this.game.camera);
                }
            } else {
                // Normal Mode: Run standard game update
                originalUpdate(dt);
            }
};
        };

        DevTools.prototype._setupAudio = function() {
            const folder = this.gui.addFolder('Audio Settings');
            const am = this.game.audioManager;
            if (!am) return;

            const params = {
                master: am.masterVolume,
                bgm: am.bgmLevel,
                sfx: am.sfxLevel,
                mute: am.isMuted
            };

            folder.add(params, 'master', 0.0, 1.0).name('Master Volume').onChange(v => am.setMasterVolume(v));
            folder.add(params, 'bgm', 0.0, 2.0).name('BGM Level').onChange(v => am.setBGMLevel(v));
            folder.add(params, 'sfx', 0.0, 2.0).name('SFX Level').onChange(v => am.setSFXLevel(v));
            folder.add(params, 'mute').name('Mute').onChange(v => {
                am.toggleMute();
            });
// Duplicate removed
        };

        DevTools.prototype._setupPostProcessing = function() {
            const pp = this.game.postProcessing;
            if (!pp || !pp.uniforms) return;

            const folder = this.gui.addFolder('Post-Processing (Retro FX)');
            
            const params = {
                enabled: pp.enabled,
                scanline: pp.uniforms.uScanlineIntensity.value,
                vignette: pp.uniforms.uVignette.value,
                noise: pp.uniforms.uNoise.value,
                aberration: pp.uniforms.uAberration.value,
                contrast: pp.uniforms.uContrast.value,
                saturation: pp.uniforms.uSaturation.value
            };

            folder.add(params, 'enabled').name('Enable PP').onChange(v => pp.enabled = v);
            folder.add(params, 'scanline', 0.0, 1.0).name('Scanline Intensity').onChange(v => pp.uniforms.uScanlineIntensity.value = v);
            folder.add(params, 'vignette', 0.0, 2.0).name('Vignette').onChange(v => pp.uniforms.uVignette.value = v);
            folder.add(params, 'noise', 0.0, 0.5).name('Noise').onChange(v => pp.uniforms.uNoise.value = v);
            folder.add(params, 'aberration', 0.0, 10.0).name('Chromatic Aberration').onChange(v => pp.uniforms.uAberration.value = v);
            folder.add(params, 'contrast', 0.0, 2.0).name('Contrast').onChange(v => pp.uniforms.uContrast.value = v);
            folder.add(params, 'saturation', 0.0, 2.0).name('Saturation').onChange(v => pp.uniforms.uSaturation.value = v);
        };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class DebugVisualizer {
constructor(scene) {
            this.scene = scene;
            this.enabled = false;
            this.showHitboxes = false;
            this.showVectors = false;
            this.showAI = false;
            this.showGoalVolume = false;

            this.visuals = new Map();
            
            // Materials
            this.matTackle = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true, transparent: true, opacity: 0.2 });
            this.matCatch = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.2 });
            this.matVel = new THREE.LineBasicMaterial({ color: 0xffff00 }); // Yellow Velocity
            this.matInput = new THREE.LineBasicMaterial({ color: 0x00ffff }); // Cyan Input
            this.matAI = new THREE.LineBasicMaterial({ color: 0xff00ff }); // Magenta AI Perception
            
            // Geometries
            this.geoCylinder = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            this.geoCylinder.translate(0, 0.05, 0);

// Goal Volume Visualization (Red Transparent Triangular Prism)
            // Matches FFX Goal Shape: Inverted Triangle
            // Top Width: 28, Bottom Width: 0, Height: 18, Depth: 10
            // Centered at Y=3 (Midpoint of 12 and -6)
            const goalGeo = new THREE.BufferGeometry();
            const vertices = new Float32Array([
                // Front Face (Z = 5)
// Front Face (Z = 5)
-14, 2, 5,  // 0: Top Left
                 14, 2, 5,  // 1: Top Right
                  0, -18, 5, // 2: Bottom
                // Back Face (Z = -5)
                -14, 2, -5, // 3: Top Left
                 14, 2, -5, // 4: Top Right
                  0, -18, -5 // 5: Bottom
            ]);
            const indices = [
                0, 2, 1,          // Front
                3, 4, 5,          // Back
                0, 1, 4, 0, 4, 3, // Top
                1, 2, 5, 1, 5, 4, // Right Side
                0, 3, 5, 0, 5, 2  // Left Side
            ];
            goalGeo.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            goalGeo.setIndex(indices);
            goalGeo.computeVertexNormals();

            const goalMat = new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                transparent: true, 
                opacity: 0.25, 
                side: THREE.DoubleSide, 
                depthWrite: false 
            });

this.goalVol1 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol1.visible = false;
            this.scene.add(this.goalVol1);

            this.goalVol2 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol2.visible = false;
            this.scene.add(this.goalVol2);
            
            this.updateGoalVolumes();
        }
        
updateGoalVolumes() {
            const C = window.flux.BallConfig || {};
            const goalDist = C.GOAL_DISTANCE || 41.5;
            const triggerOffset = (C.GOAL_TRIGGER_OFFSET !== undefined) ? C.GOAL_TRIGGER_OFFSET : 1.0;
            
            // Trigger Dimensions
            const topY = (C.GOAL_TRIGGER_TOP_Y !== undefined) ? C.GOAL_TRIGGER_TOP_Y : 2.0;
            const botY = (C.GOAL_TRIGGER_BOTTOM_Y !== undefined) ? C.GOAL_TRIGGER_BOTTOM_Y : -18.0;
            const halfW = ((C.GOAL_TRIGGER_WIDTH !== undefined) ? C.GOAL_TRIGGER_WIDTH : 28.0) / 2.0;
            const depth = 10.0;
            const halfDepth = depth / 2.0;

            // Volume represents the trigger area.
            // Trigger starts at (goalDist - triggerOffset) and goes outwards.
            const zStart = goalDist - triggerOffset;
            const zCenter = zStart + halfDepth;

            // Update Geometry Vertices
            // 0: Top Left Front (-X, TopY, +Z)
            // 1: Top Right Front (+X, TopY, +Z)
            // 2: Bottom Front (0, BotY, +Z)
            // 3: Top Left Back (-X, TopY, -Z)
            // 4: Top Right Back (+X, TopY, -Z)
            // 5: Bottom Back (0, BotY, -Z)
            
            const updateGeo = (mesh) => {
                if (!mesh || !mesh.geometry) return;
                const pos = mesh.geometry.attributes.position;
                const arr = pos.array;
                
                // Front Face (Z = halfDepth)
                arr[0] = -halfW; arr[1] = topY; arr[2] = halfDepth;
                arr[3] = halfW;  arr[4] = topY; arr[5] = halfDepth;
                arr[6] = 0;      arr[7] = botY; arr[8] = halfDepth;
                
                // Back Face (Z = -halfDepth)
                arr[9] = -halfW;  arr[10] = topY; arr[11] = -halfDepth;
                arr[12] = halfW;  arr[13] = topY; arr[14] = -halfDepth;
                arr[15] = 0;      arr[16] = botY; arr[17] = -halfDepth;
                
                pos.needsUpdate = true;
                mesh.geometry.computeBoundingSphere();
            };

            if (this.goalVol1) {
                this.goalVol1.position.set(0, 0, -zCenter);
                updateGeo(this.goalVol1);
            }
            if (this.goalVol2) {
                this.goalVol2.position.set(0, 0, zCenter);
                // Flip Z for goal 2? No, the box is symmetric in Z local space, just position handles it.
                // But Goal 2 faces opposite way. The trigger logic uses abs(x) and y range, so orientation doesn't matter for logic.
                // Visualizer is just a box.
                updateGeo(this.goalVol2);
            }
}

update() {
// Update static debugs
            if (this.goalVol1) this.goalVol1.visible = this.showGoalVolume;
            if (this.goalVol2) this.goalVol2.visible = this.showGoalVolume;

            if (!this.enabled) {
                if (this.visuals.size > 0) this.clear();
                return;
            }

            const game = window.flux.gameInstance;
            if (!game || !game.teams.home) return;

            const entities = [
                ...game.teams.home.players,
                ...game.teams.away.players,
                game.entities.ball
            ];

            entities.forEach(e => {
                if (!e || !e.mesh) return;
                
                let v = this.visuals.get(e);
                if (!v) {
                    v = this.createVisual(e);
                    this.visuals.set(e, v);
                }
                this.updateVisual(e, v);
            });
        }

        createVisual(entity) {
            const group = new THREE.Group();
            this.scene.add(group);

            // Hitboxes
            const tackle = new THREE.Mesh(this.geoCylinder, this.matTackle);
            const catchR = new THREE.Mesh(this.geoCylinder, this.matCatch);
            group.add(tackle);
            group.add(catchR);

            // Lines
            const velLine = this.createLine(this.matVel);
            const inputLine = this.createLine(this.matInput);
            const aiLine = this.createLine(this.matAI); // Line to perceived target
            
            group.add(velLine);
            group.add(inputLine);
            group.add(aiLine);

            return { group, tackle, catchR, velLine, inputLine, aiLine };
        }

        createLine(mat) {
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
            return new THREE.Line(geo, mat);
        }

        updateLine(line, start, end) {
            const pos = line.geometry.attributes.position.array;
            pos[0] = start.x; pos[1] = start.y; pos[2] = start.z;
            pos[3] = end.x; pos[4] = end.y; pos[5] = end.z;
            line.geometry.attributes.position.needsUpdate = true;
            line.visible = true;
        }

        updateVisual(e, v) {
            v.group.visible = true;
            
            // Hitboxes (Local to entity position)
            v.tackle.position.copy(e.mesh.position);
            v.catchR.position.copy(e.mesh.position);
            
            if (this.showHitboxes && e.role) {
                v.tackle.visible = true;
                const rT = e.tackleRadius || 2.5;
                v.tackle.scale.set(rT, 1, rT);

                v.catchR.visible = true;
                // Logic from main.js checkBallGrab
                const rC = e.isDashing ? 4.0 : 2.5; 
                v.catchR.scale.set(rC, 1, rC);
                v.catchR.position.y = e.mesh.position.y + 0.1;
            } else {
                v.tackle.visible = false;
                v.catchR.visible = false;
            }

            // Vectors (Global lines)
            const origin = e.mesh.position.clone();
            origin.y += 1.0; // Lift up

            if (this.showVectors) {
                // Velocity
                if (e.velocity) {
                    const end = origin.clone().add(e.velocity);
                    this.updateLine(v.velLine, origin, end);
                }
                // Input
                if (e.inputVector && e.inputVector.lengthSq() > 0) {
                    const end = origin.clone().add(e.inputVector.clone().multiplyScalar(3.0));
                    this.updateLine(v.inputLine, origin, end);
                } else {
                    v.inputLine.visible = false;
                }
            } else {
                v.velLine.visible = false;
                v.inputLine.visible = false;
            }

            // AI
            if (this.showAI && e.perceivedTargetPos) {
                // Draw line to perceived target
                this.updateLine(v.aiLine, origin, e.perceivedTargetPos);
            } else {
                v.aiLine.visible = false;
            }
        }

        clear() {
            this.visuals.forEach(v => {
                this.scene.remove(v.group);
            });
            this.visuals.clear();
        }
    }
    window.flux.DebugVisualizer = DebugVisualizer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MenuManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.container = document.getElementById('main-menu');
            this.items = document.querySelectorAll('.menu-item');
            
            this.setupEvents();
        }

        setupEvents() {
            this.items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click-through
                    this.handleSelection(item.dataset.action);
                });
                
item.addEventListener('mouseenter', () => {
                    // Optional: Play hover sound
                    if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 0.5, variance: 0.05 });
                });
            });
        }

        handleSelection(action) {
            console.log("Menu Selection:", action);
console.log("Menu Selection:", action);
if (action === 'normal') {
                if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 1.0 });
                this.hide();
                this.game.startMatch('normal');
} else if (action === 'practice') {
                this.hide();
                this.game.startMatch('practice');
            } else if (action === 'ball_lab') {
                this.hide();
                window.flux = window.flux || {};
                window.flux.requestedPracticeDrill = 'ball_lab';
                this.game.startMatch('practice');
            } else if (action === 'options') {
                console.log("Options clicked (Not implemented)");
            }
        }

        show() {
            if (this.container) {
                this.container.classList.add('active');
                this.game.setMenuMode(true);
            }
        }

        hide() {
            if (this.container) {
                this.container.classList.remove('active');
                this.game.setMenuMode(false);
            }
        }
    }

    window.flux.MenuManager = MenuManager;
})();</script>

    <script>(function() {
    window.flux = window.flux || {};

    const _orbGeo = new THREE.SphereGeometry(1.5, 16, 16);
    const _orbMatBase = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    const ORB_TYPES = {
        'HEAL': { color: 0x00ff00, label: 'HP UP', chance: 0.3 },
        'CHARGE': { color: 0xffaa00, label: 'EN UP', chance: 0.3 },
        'TECH': { color: 0x00ffff, label: 'TECH', chance: 0.2 },
        'SPEED': { color: 0xff00ff, label: 'HASTE', chance: 0.2 }
    };

    class PowerUpManager {
        constructor(scene, gameManager) {
            this.scene = scene;
            this.game = gameManager;
            this.orbs = [];
            
            this.spawnTimer = 0;
            this.spawnInterval = 10.0; // Spawn every 10 seconds
            this.maxOrbs = 5;

            this.container = new THREE.Group();
            this.scene.add(this.container);
        }

        update(dt) {
            // Only spawn/update during active play
            if (this.game.state === 'active') {
                this.spawnTimer += dt;
                if (this.spawnTimer >= this.spawnInterval) {
                    this.spawnTimer = 0;
                    if (this.orbs.length < this.maxOrbs) {
                        this.spawnRandomOrb();
                    }
                }

                for (let i = this.orbs.length - 1; i >= 0; i--) {
                    const orb = this.orbs[i];
                    
                    orb.age += dt;
                    orb.mesh.position.y = orb.baseY + Math.sin(orb.age * 2.0) * 0.5;
                    orb.mesh.rotation.y += dt * 2.0;
                    orb.mesh.rotation.z += dt * 1.0;

                    if (orb.age > 20.0) {
                        this.removeOrb(i);
                        continue;
                    }

                    this.checkCollision(orb, i);
                }
            }
        }

        spawnRandomOrb() {
            const keys = Object.keys(ORB_TYPES);
            const typeKey = keys[Math.floor(Math.random() * keys.length)];
            const typeData = ORB_TYPES[typeKey];

            const angle = Math.random() * Math.PI * 2;
            const r = Math.random() * 35.0;
            const x = Math.cos(angle) * r;
            const z = Math.sin(angle) * r;
            const y = (Math.random() * 4.0) - 2.0;

            const mesh = new THREE.Mesh(_orbGeo, _orbMatBase.clone());
            mesh.material.color.setHex(typeData.color);
            mesh.position.set(x, y, z);

            const coreGeo = new THREE.SphereGeometry(0.7, 8, 8);
            const coreMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const core = new THREE.Mesh(coreGeo, coreMat);
            mesh.add(core);

            this.container.add(mesh);

            this.orbs.push({
                mesh: mesh,
                type: typeKey,
                data: typeData,
                baseY: y,
                age: 0
            });
            
            // Spawn effect
            if (this.game.particleManager) {
                this.game.particleManager.spawn('flash', new THREE.Vector3(x,y,z), { scale: 2.0, color: typeData.color });
            }
        }

        checkCollision(orb, index) {
            const players = [];
            if (this.game.teams.home) players.push(...this.game.teams.home.players);
            if (this.game.teams.away) players.push(...this.game.teams.away.players);

            const collisionRadiusSq = 2.5 * 2.5;

            for (const p of players) {
                if (!p.mesh) continue;
                
                const distSq = p.mesh.position.distanceToSquared(orb.mesh.position);
                if (distSq < collisionRadiusSq) {
                    this.collectOrb(orb, p);
                    this.removeOrb(index);
                    return;
                }
            }
        }

        collectOrb(orb, player) {
            switch (orb.type) {
                case 'HEAL':
                    player.stats.HP = Math.min(player.stats.HP + 50, player.stats.maxHP);
                    break;
                case 'CHARGE':
                    player.currentEN = Math.min(player.currentEN + 30, player.getStat('EN'));
                    break;
                case 'TECH':
                    player.gainExp(20); // Give EXP for now
                    break;
                case 'SPEED':
                    player.applyStatus('haste', 8.0);
                    break;
            }

            if (this.game.floatingText) {
                this.game.floatingText.spawn(orb.data.label, player.mesh.position, "heal");
            }
            
            if (this.game.particleManager) {
                for(let i=0; i<5; i++) {
                    this.game.particleManager.spawn('flash', orb.mesh.position, { 
                        scale: 1.5, 
                        color: orb.data.color 
                    });
                }
            }

            if (this.game.audioManager) {
                this.game.audioManager.playSFX('menu', { volume: 0.8, rate: 1.5 });
            }
        }

        removeOrb(index) {
            const orb = this.orbs[index];
            if (orb.mesh) {
                this.container.remove(orb.mesh);
                if (orb.mesh.material) orb.mesh.material.dispose();
                // Dispose children
                orb.mesh.traverse(c => {
                    if (c.isMesh) {
                        if (c.geometry) c.geometry.dispose();
                        if (c.material) c.material.dispose();
                    }
                });
            }
            this.orbs.splice(index, 1);
        }
        
        reset() {
            for (let i = this.orbs.length - 1; i >= 0; i--) {
                this.removeOrb(i);
            }
            this.spawnTimer = 0;
        }
    }

    window.flux.PowerUpManager = PowerUpManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class PracticeManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.isRunning = false;
            this.currentDrill = null;
            this.drillState = {}; 
            
this.drills = {
                'free': { name: 'FREE ROAM', setup: this._setupFree.bind(this), loop: this._loopFree.bind(this) },
                'ball_lab': { name: 'BALL LAB', setup: this._setupBallLab.bind(this), loop: this._loopBallLab.bind(this) },
                'shooting': { name: 'SHOOTING DRILL', setup: this._setupShooting.bind(this), loop: this._loopShooting.bind(this) },
                'passing': { name: 'PASSING DRILL', setup: this._setupPassing.bind(this), loop: this._loopPassing.bind(this) },
                'defense': { name: 'DEFENSE DRILL', setup: this._setupDefense.bind(this), loop: this._loopDefense.bind(this) },
                'curve': { name: 'CURVE SHOT', setup: this._setupCurve.bind(this), loop: this._loopCurve.bind(this) },
                'rapid_fire': { name: 'RAPID FIRE', setup: this._setupRapidFire.bind(this), loop: this._loopRapidFire.bind(this) }
            };

this.ui = document.getElementById('practice-overlay');
            this.gestureHint = document.getElementById('gesture-hint');
            
            this.options = {
                infStats: true,
                aiDummy: true,
                showHitboxes: false
            };
            
this.targetRing = null;
            this.ghostBalls = []; // Array to track visual copies of thrown balls
            this._initVisuals();
            this._setupEvents();
        }

        _initVisuals() {
            // Create a glowing ring for targets
            const geometry = new THREE.RingGeometry(1.5, 1.8, 32);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                side: THREE.DoubleSide, 
                transparent: true, 
                opacity: 0.6,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            this.targetRing = new THREE.Mesh(geometry, material);
            this.targetRing.visible = false;
            // Add to scene via game manager reference
            if (this.game.scene) this.game.scene.add(this.targetRing);
        }

        start() {
this.isRunning = true;
            this._showPanel();
            // If menu requested a specific drill (e.g., Ball Lab), honor it once.
            const req = window.flux && window.flux.requestedPracticeDrill;
            if (req && this.drills[req]) {
                this.setDrill(req);
                window.flux.requestedPracticeDrill = null;
            } else {
                this.setDrill('free');
            }
            
            // Ensure HUD is visible
            const hud = document.getElementById('ui-layer');
            if(hud) hud.style.visibility = 'visible';
        }

        stop() {

            this.isRunning = false;
            this._hidePanel();
            this._hideRestoreBtn();
this._clearDrill();
            
// Clear Ghost Balls
            this.ghostBalls.forEach(b => {
                if (b.mesh) this.game.scene.remove(b.mesh);
                if (b.trail) {
                    this.game.scene.remove(b.trail.mesh);
                    if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                }
            });
            if (this.targetRing) this.targetRing.visible = false;

            // Restore Away Team Visibility for Normal Match
// Restore Away Team Visibility for Normal Match
            if (this.game.teams.away) {
                this.game.teams.away.players.forEach(p => {
                    if(p.mesh) {
                        p.mesh.visible = true;
                        p.mesh.position.y = 0; // Ensure they aren't stuck under floor
                        p.canCatch = true; // Restore catching
                    }
                });
            }

            // Disable debug visuals if they were on
            if (this.game.debugVisualizer) {
                this.game.debugVisualizer.enabled = false;
                this.game.debugVisualizer.showHitboxes = false;
            }
        }

        setDrill(key) {
            if (!this.drills[key]) return;
            this._clearDrill();
            this.currentDrill = key;
            
            // Update UI
            if (this.ui) {
                this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.drill === key);
                });
            }

            // Run Setup
            this.drills[key].setup();
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(this.drills[key].name, 'normal');
            }
        }

update(dt) {
            if (!this.isRunning) return;

            // Common Practice Logic (Infinite Stats)
            if (this.options.infStats) {
                this._applyInfiniteStats();
            }

            // Drill Logic
            if (this.currentDrill && this.drills[this.currentDrill].loop) {
                this.drills[this.currentDrill].loop(dt);
            }
            
            // Visuals Animation
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.rotation.z += dt; // Spin
                const s = 1.0 + Math.sin(Date.now() * 0.005) * 0.1;
                this.targetRing.scale.set(s, s, s);
            }

            // Update Ghost Balls
            for (let i = this.ghostBalls.length - 1; i >= 0; i--) {
                const b = this.ghostBalls[i];
                b.life -= dt;
                
                // --- PHYSICS & VISUALS DELEGATION ---
                if (window.flux.Ball && window.flux.Ball.prototype.updateFree) {
                    window.flux.Ball.prototype.updateFree.call(b, dt);
                    window.flux.Ball.prototype.updateVisuals.call(b, dt);
                }

                // Update Trail
                if (b.trail) {
                    const trailPos = b.mesh.position.clone();
                    if (b.deformNode) trailPos.y += b.deformNode.position.y;
                    b.trail.update(trailPos);
                }

                // --- GOAL DETECTION FOR GHOST BALLS ---
                const pos = b.mesh.position;
                // Check Z depth (Goal is at +/- 28, trigger at 29)
                if (Math.abs(pos.z) > 40.0) {
                    // Goal Detection (Inverted Triangle Hitbox)
const triTopY = 9.0;
                    const triBottomY = -6.0;
                    const triMaxHalfWidth = 14.0;
                    
                    if (pos.y <= triTopY && pos.y >= triBottomY) {
                        const t = (pos.y - triBottomY) / (triTopY - triBottomY);
                        const allowedX = t * triMaxHalfWidth;

                        if (Math.abs(pos.x) <= allowedX) {
                            // GOAL!
                            if (this.game.particleManager) {
                                // Spawn Goal FX
                                this.game.particleManager.spawn('shockwave', pos, { scale: 8.0, life: 0.5 });
                                this.game.particleManager.spawn('flash', pos, { scale: 5.0 });
                                // Debris
for(let k=0; k<5; k++) this.game.particleManager.spawn('debris', pos, { scale: 0.5, rotationSpeed: (Math.random()-0.5)*10, frame: Math.floor(Math.random()*4) });
                            }
                            if (this.game.floatingText) {
                                this.game.floatingText.spawn("GOAL", pos, "goal");
                            }
                            // Kill ball immediately
                            b.life = 0;
                        }
                    }
                }

                // Cleanup
                if (b.life <= 0 || b.mesh.position.y < -10) {
                    this.game.scene.remove(b.mesh);
                    if (b.trail) {
                        this.game.scene.remove(b.trail.mesh);
                        if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                    }
                    this.ghostBalls.splice(i, 1);
                }
            }
        }
        _setupEvents() {

            // Minimize / Restore
            const minBtn = this.ui.querySelector('#p-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._hidePanel();
                    this._showRestoreBtn();
                });
            }

            const restoreBtn = document.getElementById('practice-restore-btn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._showPanel();
                    this._hideRestoreBtn();
                });
            }

            // Drill Buttons
            this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setDrill(btn.dataset.drill);
                });
            });

            // Reset Ball
            const resetBtn = this.ui.querySelector('#p-reset-ball');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._resetBallToPlayer();
                });
            }

            // Exit
            const exitBtn = this.ui.querySelector('#p-exit');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        this.stop();
                    }
                });
            }

            // Options Toggles
            this._bindToggle('opt-inf-stat', 'infStats');
            this._bindToggle('opt-ai-dummy', 'aiDummy', (val) => {
                // Update AI Dummy state immediately
                if (this.game.teams.away) {
                    this.game.teams.away.aiEnabled = !val; // If dummy is TRUE, AI is FALSE
                }
            });
            this._bindToggle('opt-hitboxes', 'showHitboxes', (val) => {
                if (this.game.debugVisualizer) {
                    this.game.debugVisualizer.enabled = val;
                    this.game.debugVisualizer.showHitboxes = val;
                }
            });

            // Keyboard Shortcut for Reset (R)
// Keyboard Shortcut for Reset (R)
            window.addEventListener('keydown', (e) => {
                if (this.isRunning && e.key.toLowerCase() === 'r' && !e.repeat) {
                    this._resetBallToPlayer();
                }
            });
        }

_bindToggle(id, optionKey, callback) {
            const el = this.ui.querySelector(`#${id}`);
            if (!el) return;

            // Helper to update visuals
            const updateVisual = () => {
                const isActive = this.options[optionKey];
                el.classList.toggle('active', isActive);
                const box = el.querySelector('.checkbox');
                if (box) box.innerText = isActive ? '' : '';
            };

            // Initialize visual state immediately
            updateVisual();

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                this.options[optionKey] = !this.options[optionKey];
                
                updateVisual();

                if (callback) callback(this.options[optionKey]);
            });
        }


        _setupBallLab() {
            this._setInstruction("BALL LAB: Open DevTools  Ball Lab. Use Shot Cannon + trajectory preview + record/replay.");
            this.drillState.resetting = false;
            this.drillState._autoResetTimer = 0;

            const home = this.game.teams.home;
            const away = this.game.teams.away;
            const p = home ? home.activePlayer : null;
            if (!p) return;

            // Solo mode: hide everyone except the active player
            if (home && home.players) {
                home.players.forEach(mate => {
                    if (mate.mesh) mate.mesh.visible = (mate === p);
                });
            }
            if (away && away.players) {
                away.players.forEach(opp => {
                    if (opp.mesh) opp.mesh.visible = false;
                });
            }

            // Place active player at center facing the away goal
            if (p.mesh) {
                p.mesh.position.set(0, 0, 0);
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0, 0, 0);
                if (p.syncRotation) p.syncRotation();
            }

            // Big stats so you can test extremes
            if (p.stats) {
                p.stats.SH = 99;
                p.stats.PA = 99;
                p.stats.EN = 99;
                p.stats.maxHP = Math.max(p.stats.maxHP || 999, 999);
                p.stats.HP = p.stats.maxHP;
            }

            // A clear target marker (purely visual)
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -18);
                this.targetRing.material.color.setHex(0xff00ff);
            }

            this._resetBallToPlayer();
        }

        _loopBallLab(dt) {
            const b = this.game.entities.ball;
            const p = this.game.teams.home.activePlayer;
            if (!b || !p) return;

            // Auto-reset ball back to player once it comes to rest,
            // so you can spam variations without touching anything.
            if (b.state === 'free') {
                const stopped = (b.velocity.lengthSq() < 0.01) && (b.power <= 0.01);
                if (stopped) {
                    this.drillState._autoResetTimer = (this.drillState._autoResetTimer || 0) + dt;
                    if (this.drillState._autoResetTimer > 0.45) {
                        this._resetBallToPlayer();
                        this.drillState._autoResetTimer = 0;
                    }
                } else {
                    this.drillState._autoResetTimer = 0;
                }
            } else {
                this.drillState._autoResetTimer = 0;
            }

            // Slight target bob (helps depth perception)
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            }
        }

        _applyInfiniteStats() {
            const home = this.game.teams.home;
            if (home) {
                home.players.forEach(p => {
                    p.stats.HP = p.stats.maxHP;
                    p.currentEN = p.stats.EN;
                    p.status.venom = 0;
                    p.status.nap = 0;
                    p.stunTimer = 0;
                });
            }
        }

        _clearDrill() {

            // Reset positions, clear dummies, reset score
            if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
            this.drillState = { score: 0, timer: 0, stage: 0, resetting: false };
            if (this.gestureHint) this.gestureHint.style.display = 'none';
            this._updateScoreUI(0);
            
            // Clear Glyphs
            if (this.game.glyphManager) this.game.glyphManager.clear();
            
            if (this.targetRing) this.targetRing.visible = false;

            // Reset teams to default positions

// Reset teams to default positions
            this.game.teams.home.resetPositions();
            this.game.teams.away.resetPositions();
            
            // Apply AI Dummy setting
            if (this.game.teams.away) {
                this.game.teams.away.aiEnabled = !this.options.aiDummy;
            }
// Hide away team by default in drills unless specified
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = false;
                p.mesh.position.set(0, -1000, 0); // Move WAY away to prevent interaction
                p.velocity.set(0,0,0);
                p.canCatch = false; // Disable catching
            });
            
            // Ensure Home team is visible
            this.game.teams.home.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
            });
        }

        _resetBallToPlayer() {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;
            if (p && b) {
                b.reset();
                b.grab(p);
                if (this.game.floatingText) this.game.floatingText.spawn("RESET", p.mesh.position, "tech");
                
                // Snap camera
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        }

        _updateScoreUI(val) {
            const el = this.ui.querySelector('#drill-score');
            if (el) el.innerText = `SCORE: ${val}`;
        }

        _setInstruction(text) {
             const el = this.ui.querySelector('#drill-instruction');
             if (el) el.innerText = text;
        }

        // --- DRILLS ---

_setupFree() {
            this._setInstruction("Free practice. Infinite HP/EN.");
            // Show everyone
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
                p.mesh.position.copy(p.homePosition);
                p.canCatch = true; // Restore capability
            });
            this._resetBallToPlayer();
        }
        _loopFree(dt) {}

        _setupShooting() {

            this._setInstruction("Score on the Goalie!");
            this.drillState.resetting = false; // Clear reset flag
            
            // Setup: Active Player at 18m, Goalie in net.
            const p = this.game.teams.home.activePlayer;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (p && p.mesh) {
                p.mesh.position.set(0, 0, -10); // 18m out (Home attacks -Z)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }
            if (g && g.mesh) {
                g.mesh.visible = true;
                g.mesh.position.set(0, 0, -27);
                g.mesh.lookAt(0, 0, 0);
                g.velocity.set(0,0,0);
            }
            
            this._resetBallToPlayer();
        }
        
_loopShooting(dt) {
            if (this.drillState.resetting) return;

            // Check if goal scored (GameManager handles the actual goal event, but we track reset)
            if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                this.game.state = 'active'; // Hijack state back
                setTimeout(() => this._setupShooting(), 1000);
                return;
            }

            // Check for Save (Ball stopped or moving away from goal without scoring)
            const ball = this.game.entities.ball;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (ball && g && g.mesh) {
                const dist = ball.mesh.position.distanceTo(g.mesh.position);
                // If ball is close to goalie and stopped/caught
                if (dist < 3.0 && (ball.holder === g || ball.velocity.length() < 1.0)) {
                     this.drillState.resetting = true;
                     if (this.game.floatingText) this.game.floatingText.spawn("SAVED", g.mesh.position, "damage");
                     setTimeout(() => this._setupShooting(), 1000);
                }
            }
        }

        _setupPassing() {

             this._setInstruction("Pass to the moving target!");
             this.drillState.resetting = false;

             // Setup: Active Player center. 1 Teammate running patterns.
             const p = this.game.teams.home.activePlayer;
             const target = this.game.teams.home.players.find(x => x !== p && x.role !== 'GL');
             
             this.drillState.target = target;
             
             if (p) {
                 p.mesh.position.set(0, 0, 10);
                 p.velocity.set(0,0,0);
             }
             if (target) {
                 target.mesh.position.set(0, 0, -10);
                 target.mesh.visible = true;
                 target.velocity.set(0,0,0);
             }
             
             this._resetBallToPlayer();
        }

        _loopPassing(dt) {
            if (this.drillState.resetting) return;

            const target = this.drillState.target;
            if (!target) return;
            
            // Move target in circle
            this.drillState.timer += dt;
            target.mesh.position.x = Math.sin(this.drillState.timer) * 10;
            target.mesh.position.z = -10 + Math.cos(this.drillState.timer * 0.5) * 5;
            target.mesh.lookAt(0,0,10);

            // Update Ring
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(target.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0x00ffff); // Cyan
            }

            if (target.hasBall) {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                if (this.game.floatingText) this.game.floatingText.spawn("NICE PASS!", target.mesh.position, "heal");
                
                // Reset
                setTimeout(() => {
                    target.loseBall();
                    this._setupPassing(); // Re-setup to reset positions
                }, 800);
            }
        }
        
        _setupDefense() {

            this._setInstruction("Tackle the attacker!");
            this.drillState.resetting = false;

            const p = this.game.teams.home.activePlayer;
            const attacker = this.game.teams.away.players.find(x => x.role === 'MF');
            
            this.drillState.attacker = attacker;
            
            if (p) {
                p.mesh.position.set(0, 0, 20); // Near own goal
                p.velocity.set(0,0,0);
            }
            if (attacker) {
                attacker.mesh.visible = true;
                attacker.mesh.position.set(0, 0, -10);
                attacker.velocity.set(0,0,0);
                // Give ball to attacker
                const b = this.game.entities.ball;
                b.reset();
                b.grab(attacker);
            }
        }
        
        _loopDefense(dt) {
            if (this.drillState.resetting) return;

            const attacker = this.drillState.attacker;
            const p = this.game.teams.home.activePlayer;
            
            if (!attacker || !p) return;
            
            // Attacker runs to goal (+Z)
// Attacker runs to goal (+Z)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalPos = new THREE.Vector3(0, 0, goalDist);
            const dir = goalPos.clone().sub(attacker.mesh.position).normalize();
            
            // Update Ring on Attacker
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(attacker.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0xff0000); // Red for enemy
            }

            if (attacker.hasBall) {
                attacker.setInput(dir.x, dir.z);
            } else {
                // Ball lost (Tackled)
                if (p.hasBall || this.game.entities.ball.state === 'free') {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("STOPPED!", p.mesh.position, "block");
                    setTimeout(() => this._setupDefense(), 1000);
                }
            }
            
            // Fail condition: Attacker scores (GameManager handles goal check)
             if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.game.state = 'active';
                if (this.game.floatingText) this.game.floatingText.spawn("FAILED", p.mesh.position, "damage");
                setTimeout(() => this._setupDefense(), 1000);
            }
}

        _setupCurve() {
this._setInstruction("Swipe a CURVE ( ) ) to bypass the defender!");
            this.drillState.resetting = false;

            // Show gesture hint
            if (this.gestureHint) {
                this.gestureHint.style.display = 'flex';
                this.gestureHint.classList.add('active');
                
                // Clear any existing timeout
                if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
                
                // Auto hide after 4s
                this.drillState.hintTimeout = setTimeout(() => {
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'none';
                        this.gestureHint.classList.remove('active');
                    }
                }, 4000);
            }

            const p = this.game.teams.home.activePlayer;
            // Use a defender dummy
            const defender = this.game.teams.away.players.find(x => x.role === 'LD');
            this.drillState.defender = defender;

            if (p) {
                p.mesh.position.set(0, 0, 15);
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }

            if (defender) {
                defender.mesh.visible = true;
                defender.mesh.position.set(0, 0, 5); // 10m in front of player
                defender.mesh.lookAt(0, 0, 15); // Face player
                defender.velocity.set(0,0,0);
                // Boost BL to ensure straight shots are blocked
                defender.stats.BL = 99; 
                // Ensure they don't move
                defender.aiState = 'IDLE';
            }

            // Target Ring behind defender
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -10);
                this.targetRing.material.color.setHex(0x00ffff);
            }

            this._resetBallToPlayer();
        }

_loopCurve(dt) {
            if (this.drillState.resetting) return;

            const ball = this.game.entities.ball;
            const defender = this.drillState.defender;

            // Check if ball passed the defender line (z < 0)
            if (ball.mesh.position.z < 0) {
                // Success zone (Within 5m width)
                if (Math.abs(ball.mesh.position.x) < 5) {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("CURVED!", ball.mesh.position, "tech");
                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Check if blocked (Ball stopped or power drained significantly near defender)
            if (defender && ball.mesh.position.distanceTo(defender.mesh.position) < 3.0) {
                if (ball.power <= 0 || ball.velocity.length() < 1.0) {
                    this.drillState.resetting = true;
                    if (this.game.floatingText) this.game.floatingText.spawn("BLOCKED", defender.mesh.position, "damage");
                    
                    // Re-show hint on failure to guide player
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'flex';
                        this.gestureHint.classList.add('active');
                        clearTimeout(this.drillState.hintTimeout);
                        this.drillState.hintTimeout = setTimeout(() => {
                            if (this.gestureHint) {
                                this.gestureHint.style.display = 'none';
                                this.gestureHint.classList.remove('active');
                            }
                        }, 4000);
                    }

                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Missed / Out of bounds
            if (ball.mesh.position.z < -15) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("MISSED", ball.mesh.position, "damage");
                 
                 // Re-show hint on miss
                 if (this.gestureHint) {
                    this.gestureHint.style.display = 'flex';
                    this.gestureHint.classList.add('active');
                    clearTimeout(this.drillState.hintTimeout);
                    this.drillState.hintTimeout = setTimeout(() => {
                        if (this.gestureHint) {
                            this.gestureHint.style.display = 'none';
                            this.gestureHint.classList.remove('active');
                        }
                    }, 4000);
                 }

                 setTimeout(() => this._setupCurve(), 1000);
            }
        }

_setupRapidFire() {
            this._setInstruction("UNLIMITED AMMO! Spam throws!");
            this.drillState.resetting = false;

            // Find Tidus or default to LF
            let p = this.game.teams.home.players.find(x => x.characterName && x.characterName.includes('Tidus'));
            if (!p) p = this.game.teams.home.players.find(x => x.role === 'LF');
            
            // Set active player
            if (p) {
                this.game.teams.home.setActivePlayer(p);
                p.mesh.position.set(0, 0, 0);
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
                
                // Boost stats for fun
                p.stats.SH = 99;
                p.stats.PA = 99;
            }

            // HIDE EVERYONE (Alone Mode)
            this.game.teams.home.players.forEach(mate => {
                if (mate !== p && mate.mesh) mate.mesh.visible = false;
            });
            this.game.teams.away.players.forEach(opp => {
                if (opp.mesh) opp.mesh.visible = false;
            });

            this._resetBallToPlayer();
        }

_loopRapidFire(dt) {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;

            if (!p || !b) return;

            // Detect if ball was just thrown (is free)
            if (b.state === 'free') {
                // 1. Spawn Ghost Ball (Visual Copy)
                // Clone the mesh hierarchy to preserve Deform/Spin nodes
                const ghostMesh = b.mesh.clone();
                
                // Ensure visibility and add to scene
                this.game.scene.add(ghostMesh);
                
                // Re-bind internal references for the physics engine
                // Hierarchy: Mesh -> DeformNode -> SpinNode
                const deformNode = ghostMesh.children[0];
                const spinNode = deformNode ? deformNode.children[0] : null;

                // Determine Trail Color based on Tech
                let trailColor = 0xff4400; // Default SH (Orange)
                if (b.technique) {
                    if (b.technique.type === 'venom') trailColor = 0xaa00ff;
                    else if (b.technique.type === 'wither') trailColor = 0x888888;
                    else if (b.technique.type === 'nap') trailColor = 0x000088;
                    else if (b.technique.type === 'sphere') trailColor = 0x00ffff;
                    else if (b.technique.type === 'jecht') trailColor = 0xff0000;
                    else if (b.technique.type === 'invisible') trailColor = 0x444444;
                } else if (b.powerType === 'PA') {
                    trailColor = 0x00aaff; // Pass (Blue)
                }

                // Create Trail
                const trail = new window.flux.TrailRenderer(this.game.scene);
                trail.active = true;
                trail.setColor(trailColor);
                trail.reset(ghostMesh.position);

                // Create a "Mock" Ball object that satisfies Ball.js physics requirements
                const ghostBall = {
                    mesh: ghostMesh,
                    deformNode: deformNode,
                    spinNode: spinNode,
                    velocity: b.velocity.clone(),
                    angularVelocity: b.angularVelocity ? b.angularVelocity.clone() : new THREE.Vector3(),
                    accumulatedRotation: b.accumulatedRotation ? b.accumulatedRotation.clone() : new THREE.Quaternion(),
                    state: 'free',
                    power: b.power,
                    powerType: b.powerType,
                    technique: b.technique,
                    isInvisible: b.isInvisible,
                    life: 5.0, // Enough time to reach goal
                    trail: trail,
                    _bubbleTimer: 0,
                    _ghost: true,
                    // Mock methods
                    reset: () => {}, 
                    drop: () => {},
                    reveal: () => {}
                };

                // Apply visibility
                ghostMesh.visible = !b.isInvisible;

                this.ghostBalls.push(ghostBall);

// 2. Reset Real Ball to Player INSTANTLY
                b.velocity.set(0, 0, 0);
                b.angularVelocity.set(0, 0, 0);
                
                // FIX: Force ball position to be explicitly in front of the player
                // This prevents any logic from thinking the ball is behind and triggering a turn
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                b.mesh.position.copy(p.mesh.position).add(fwd.multiplyScalar(0.8));
                b.mesh.position.y += 1.0;

                // Manual Attach (Bypass 'catch' animation)
                b.holder = p;
                b.state = 'held';
                p.hasBall = true;
                
                // Reset Player Throw State so they can fire again immediately
                p.isThrowing = false;
                p.catchCooldown = 0;

                // Sync rotation to prevent snapping
                if (p.syncRotation) p.syncRotation();
            }
            
            // Ensure infinite stats
            p.currentEN = p.stats.EN;
            p.stats.HP = p.stats.maxHP;
        }

        _showPanel() {
            if (this.ui) this.ui.classList.add('active');
        }

        _hidePanel() {
            if (this.ui) this.ui.classList.remove('active');
        }

        _showRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'block';
        }

        _hideRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'none';
        }
    }
window.flux.PracticeManager = PracticeManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- High-Quality Noise Texture Generator ---
    window.flux.noiseTexture = (() => {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        
        // Generate seamless noise (Perlin-ish via layered random circles/gradients)
        const drawNoiseLayer = (scale, alpha) => {
            ctx.globalAlpha = alpha;
            ctx.globalCompositeOperation = 'lighter'; // Additive
            const count = 300 * scale;
            for(let i=0; i<count; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const r = (Math.random() * 30 + 10) / scale;
                
                const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                g.addColorStop(0, '#888888');
                g.addColorStop(1, 'transparent');
                
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                
                // Wrap around for seamless tiling
                [[x-size, y], [x+size, y], [x, y-size], [x, y+size]].forEach(pos => {
                    const g2 = ctx.createRadialGradient(pos[0], pos[1], 0, pos[0], pos[1], r);
                    g2.addColorStop(0, '#888888');
                    g2.addColorStop(1, 'transparent');
                    ctx.fillStyle = g2;
                    ctx.beginPath(); ctx.arc(pos[0], pos[1], r, 0, Math.PI*2); ctx.fill();
                });
            }
        };
        
        drawNoiseLayer(1.0, 0.3);
        drawNoiseLayer(2.0, 0.2);
        drawNoiseLayer(4.0, 0.1);
        
        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = THREE.RepeatWrapping;
        tex.wrapT = THREE.RepeatWrapping;
        return tex;
    })();

    class WaterOverlay {
        constructor(camera) {
            this.camera = camera;
            
            // Fullscreen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
            const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                precision mediump float;
                uniform float uTime;
                uniform float uOpacity;
                uniform sampler2D tNoise;
                varying vec2 vUv;

                // FFX Palette (Additive Friendly)
                const vec3 C_DEEP = vec3(0.0, 0.05, 0.2);     // Deep Blue
                const vec3 C_GLOW = vec3(0.0, 0.6, 0.9);      // Cyan Glow
                const vec3 C_RAY  = vec3(0.5, 0.8, 1.0);      // Light Shafts
                const vec3 C_PYRE = vec3(1.0, 0.85, 0.5);     // Pyrefly Gold

                // 4x4 Bayer Matrix for Ordered Dithering
                float bayer4x4(vec2 uv) {
                    int x = int(mod(uv.x, 4.0));
                    int y = int(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0) { if (x == 0) v = 0.0; else if (x == 1) v = 8.0; else if (x == 2) v = 2.0; else v = 10.0; }
                    else if (y == 1) { if (x == 0) v = 12.0; else if (x == 1) v = 4.0; else if (x == 2) v = 14.0; else v = 6.0; }
                    else if (y == 2) { if (x == 0) v = 3.0; else if (x == 1) v = 11.0; else if (x == 2) v = 1.0; else v = 9.0; }
                    else { if (x == 0) v = 15.0; else if (x == 1) v = 7.0; else if (x == 2) v = 13.0; else v = 5.0; }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    float t = uTime * 0.12;

                    // 1. Distortion (Lookup 1)
                    float warp = texture2D(tNoise, uv * 0.4 + vec2(t * 0.04, t * 0.02)).r;
                    
                    // 2. Caustics (Lookup 2)
                    vec2 cUV = uv * 2.0 + vec2(warp * 0.5, warp * 0.2) - vec2(t * 0.05);
                    float c = texture2D(tNoise, cUV).r;
                    
                    c = (c - 0.4) * 2.5;
                    c = max(0.0, c);
                    c = pow(c, 3.0); // Sharper caustics
                    
                    float caustic = c * 10.0;
                    vec3 causticColor = vec3(caustic * 0.7, caustic, caustic * 1.3);

                    // 3. Rays (Lookup 3)
                    vec2 rayUV = vec2(uv.x + warp * 0.1, uv.y * 0.15 - t * 0.05);
                    float rays = texture2D(tNoise, rayUV).r;
                    rays = rays * rays;
                    
                    float rayMask = 1.0 - abs(uv.y * 2.0 - 1.0);
                    rays *= max(0.0, rayMask);

                    // 4. Pyreflies
                    vec2 p = uv * 6.0;
                    vec2 id = floor(p);
                    vec2 sub = fract(p) - 0.5;
                    
                    float n = fract(sin(dot(id, vec2(12.9898, 78.233))) * 43758.5453);
                    float px = fract(n * 13.0 + t * 0.3) - 0.5;
                    float py = fract(n * 7.0 + t * 0.2) - 0.5;
                    
                    vec2 flyPos = vec2(px, py);
                    float d2 = dot(sub - flyPos, sub - flyPos);
                    
                    float fly = 0.0006 / (d2 + 0.0005);
                    fly *= step(0.6, n); 
                    fly *= 0.5 + 0.5 * sin(t * 5.0 + n * 10.0);

                    // Composition
                    vec3 finalCol = vec3(0.0);

                    // Vignette
                    vec2 vd = uv - 0.5;
                    float vSq = dot(vd, vd);
                    float vig = vSq * 1.5; 
                    finalCol += C_DEEP * vig;

                    finalCol += causticColor * C_GLOW * 0.5;
                    finalCol += rays * C_RAY * 0.4;
                    finalCol += fly * C_PYRE;

                    // --- PSX DITHERING & QUANTIZATION ---
                    
                    // 1. Get Dither Value (Screen Space)
                    float dither = bayer4x4(gl_FragCoord.xy);
                    
                    // 2. Color Depth Reduction (e.g. 32 levels = 5 bit)
                    float colorDepth = 32.0;
                    
                    // 3. Apply Dither to Color
                    // We add noise before quantization to smooth bands
                    // The magnitude is 1/Depth centered around 0
                    vec3 dithered = finalCol + (dither - 0.5) * (1.0 / colorDepth);
                    
                    // 4. Quantize
                    dithered = floor(dithered * colorDepth) / colorDepth;
                    
                    // 5. Dithered Alpha/Intensity
                    // Instead of simple alpha blending, we can use dither to break up faint details
                    // This gives that "crunchy" look in dark areas
                    float intensity = length(dithered);
                    // Boost shadows with dither noise
                    dithered += (dither - 0.5) * 0.02;

                    gl_FragColor = vec4(dithered, uOpacity);
                }
            `;

            this.material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uOpacity: { value: 0.5 },
                    tNoise: { value: window.flux.noiseTexture }
                },
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthTest: false,
                depthWrite: false,
                blending: THREE.AdditiveBlending // Additive blending prevents dark occlusion
            });

            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.mesh.renderOrder = 9999;
            
            // Add to camera so it stays on screen
            this.camera.add(this.mesh);
        }
        
        update(dt) {
            if (this.material) {
                this.material.uniforms.uTime.value += dt;
            }
        }
    }
    
    window.flux.WaterOverlay = WaterOverlay;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class LightShafts {
        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.uniforms = {
                uTime: { value: 0 },
                tNoise: { value: null }
            };

            this._init();
        }

_init() {
            // Geometry: A cluster of cones/cylinders
            // We use a single geometry with instancing or merged geometry for performance,
            // but for simplicity and aesthetic control, let's use a few large planes or a cylinder.
            // A large cylinder with open ends works well for a "pool" shaft effect.
            
            // Increased length to 90 to accommodate tilt without clipping top/bottom
            const geometry = new THREE.CylinderGeometry(30, 20, 90, 32, 1, true);
            
            // Shader
            const vert = `
                varying vec2 vUv;
                varying vec3 vPos;
                void main() {
                    vUv = uv;
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform float uTime;
                uniform sampler2D tNoise;
                varying vec2 vUv;
                varying vec3 vPos;

                void main() {
                    // Vertical fade (Soft top and bottom)
                    float alpha = smoothstep(0.0, 0.3, vUv.y) * smoothstep(1.0, 0.6, vUv.y);

                    // Scrolling Rays
                    // Layer 1: Slow, broad rays
                    float n1 = texture2D(tNoise, vec2(vUv.x * 2.0 + uTime * 0.02, vUv.y * 0.5 - uTime * 0.05)).r;
                    
                    // Layer 2: Fast, interference rays
                    float n2 = texture2D(tNoise, vec2(vUv.x * 3.0 - uTime * 0.03, vUv.y * 0.5 - uTime * 0.1)).r;

                    float rays = n1 * n2;
                    // Boost intensity significantly (Removed pow to prevent crushing)
                    rays = rays * 3.0; 

                    // Glistening Sparkles (High frequency noise)
                    float sparkle = texture2D(tNoise, vUv * vec2(8.0, 2.0) + vec2(uTime * 0.1, uTime * 0.3)).r;
                    sparkle = pow(sparkle, 5.0) * 10.0; // Sharp points

                    // Color: Cyan/Blue/White (Brighter base)
                    vec3 color = vec3(0.6, 0.9, 1.0);
                    
                    // Combine (Higher multipliers)
                    float finalAlpha = (rays * 0.8 + sparkle * 0.4) * alpha;
                    
                    // Distance fade (optional, handled by fog usually but we want additive)
                    gl_FragColor = vec4(color, finalAlpha);
                }
            `;

            const material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                side: THREE.DoubleSide
            });

            // Container for the angle (Realistic Light Source)
            this.container = new THREE.Group();
            // Angle: Coming from top-left (simulating surface sun penetrating deep water)
            this.container.rotation.z = Math.PI / 5; // ~36 degrees tilt
            this.container.rotation.x = Math.PI / 10; // ~18 degrees forward
            this.container.position.set(12, 8, 0); // Offset source to hit arena center
            this.scene.add(this.container);

            this.mesh = new THREE.Mesh(geometry, material);
            this.mesh.renderOrder = 100; 
            this.mesh.position.set(0, 0, 0);
            this.container.add(this.mesh);

            // Add a second layer for core intensity
            const coreGeo = new THREE.CylinderGeometry(12, 8, 90, 16, 1, true);
            this.coreMesh = new THREE.Mesh(coreGeo, material);
            this.coreMesh.renderOrder = 100;
            this.container.add(this.coreMesh);
        }

        update(dt) {
            this.uniforms.uTime.value += dt;
            
            // Lazy load texture
            if (!this.uniforms.tNoise.value && window.flux.noiseTexture) {
                this.uniforms.tNoise.value = window.flux.noiseTexture;
                // Ensure wrapping is correct for the cylinder UVs
                window.flux.noiseTexture.wrapS = THREE.RepeatWrapping;
                window.flux.noiseTexture.wrapT = THREE.RepeatWrapping;
            }

            // Slowly rotate shafts for dynamic feel
            if (this.mesh) this.mesh.rotation.y += dt * 0.02;
            if (this.coreMesh) this.coreMesh.rotation.y -= dt * 0.03;
        }
    }

    window.flux.LightShafts = LightShafts;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

// Reusable Glow for Lights
    const _glowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(0.4, 'rgba(0, 170, 255, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    const _glowMaterial = new THREE.SpriteMaterial({ 
        map: _glowTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class Stadium {
        constructor(scene) {
            this.scene = scene;
            this.container = new THREE.Group();
            this.scene.add(this.container);

            // Config for "Herculean" scale
// Config for "Herculean" scale
            this.config = {
                radius: 60,       // Start outside the arena (48 radius)
                tiers: 6,         // Number of seating rings
                tierHeight: 12,
                tierDepth: 15,
crowdCount: 300, // Optimized density (was 1500)
                structureColor: 0x080c10, // Deep dark blue/black
                lightColor: 0x00aaff
            };

this.rings = [];
            this.lightSprites = []; // Store light sprites for cinematic control
this.crowd = null;

            this._buildArchitecture();
            this._buildCrowd();
            this._buildHerculeanRings();
            this._buildStadiumLights();
            this._buildGoalBarriers();
        }

        _buildArchitecture() {
            // 1. The Void Bowl (Background Occluder)
            // Massive cylinder to block the void
            const bowlGeo = new THREE.CylinderGeometry(180, 50, 120, 32, 1, true);
            const bowlMat = new THREE.MeshBasicMaterial({ 
                color: this.config.structureColor, 
                side: THREE.BackSide,
                fog: true 
            });
            const bowl = new THREE.Mesh(bowlGeo, bowlMat);
            bowl.position.y = 20;
            this.container.add(bowl);

            // 2. Seating Tiers (Concentric Rings)
            const tierMat = new THREE.MeshBasicMaterial({ color: 0x111a22, side: THREE.DoubleSide });
            const rimMat = new THREE.MeshBasicMaterial({ color: 0x004466 });

            for(let i=0; i<this.config.tiers; i++) {
                const y = (i * this.config.tierHeight) - 30;
                const rInner = this.config.radius + (i * (this.config.tierDepth * 0.8));
                const rOuter = rInner + this.config.tierDepth;
                
                // Floor Ring
                const ringGeo = new THREE.RingGeometry(rInner, rOuter, 64);
                ringGeo.rotateX(-Math.PI / 2);
                const mesh = new THREE.Mesh(ringGeo, tierMat);
                mesh.position.y = y;
                this.container.add(mesh);
                
                // Glowing Rim (The "Tech" feel)
                const rimGeo = new THREE.TorusGeometry(rInner, 0.8, 4, 64);
                rimGeo.rotateX(Math.PI / 2);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.position.y = y;
                this.container.add(rim);
            }

            // 3. Massive Pillars (The "Herculean" Support)
            const pillarGeo = new THREE.BoxGeometry(8, 200, 8);
            const pillarMat = new THREE.MeshBasicMaterial({ color: 0x050505 });
            
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 140; // Far out
                const mesh = new THREE.Mesh(pillarGeo, pillarMat);
                mesh.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                mesh.lookAt(0,0,0);
                this.container.add(mesh);
            }
        }

_buildCrowd() {
            // Instanced Mesh for Crowd (Low Poly, High Count)
            // Using a simple vertical plane that faces center
            const geo = new THREE.PlaneGeometry(1.2, 2.5);
            
            // --- CROWD SHADER IMPLEMENTATION ---
            // Add instance-specific random offset for animation variation
            const offsets = new Float32Array(this.config.crowdCount);
            for(let i=0; i<this.config.crowdCount; i++) {
                offsets[i] = Math.random();
            }
            geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(offsets, 1));

            // Custom Shader via onBeforeCompile
            const mat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide });
            
            mat.onBeforeCompile = (shader) => {
                shader.uniforms.uTime = { value: 0 };
                this.crowdUniforms = shader.uniforms;

                shader.vertexShader = `
                    uniform float uTime;
                    attribute float aOffset;
                    varying float vJump; // Pass to fragment for color variation
                ` + shader.vertexShader;

                shader.vertexShader = shader.vertexShader.replace(
                    '#include <begin_vertex>',
                    `
                    #include <begin_vertex>
                    
                    // Animation Logic
                    float speed = 8.0;
                    float t = uTime * speed + (aOffset * 100.0);
                    
                    // Jump (Sine wave clipped)
                    float jump = max(0.0, sin(t));
                    jump = pow(jump, 2.0); // Sharpen the jump curve
                    
                    // Randomize jump height slightly
                    float height = 0.5 + 0.5 * aOffset;
                    
                    transformed.y += jump * height;
                    
                    // Sway (Side to side)
                    transformed.x += cos(t * 0.5) * 0.1;
                    
                    vJump = jump;
                    `
                );

                shader.fragmentShader = `
                    varying float vJump;
                ` + shader.fragmentShader;

                shader.fragmentShader = shader.fragmentShader.replace(
                    'vec4 diffuseColor = vec4( diffuse, opacity );',
                    `
                    vec4 diffuseColor = vec4( diffuse, opacity );
                    
                    // Brighten when jumping (Cheering effect)
                    diffuseColor.rgb += vec3(0.2) * vJump;
                    `
                );
            };
            
this.crowd = new THREE.InstancedMesh(geo, mat, this.config.crowdCount);
            this.crowd.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            
            // Optimization: Enable culling and manually set bounding sphere to cover the whole stadium
            // This prevents GPU from processing 2500 instances when the entire structure is out of view
            this.crowd.frustumCulled = true;
            this.crowd.geometry.boundingSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), 150);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
// 1. Calculate Total Circumference for distribution to ensure all tiers get people
            let totalCirc = 0;
            const tierRadii = [];
            for(let t=0; t<this.config.tiers; t++) {
                const rMin = this.config.radius + (t * (this.config.tierDepth * 0.8)) + 2;
                const circ = 2 * Math.PI * rMin;
                totalCirc += circ;
                tierRadii.push({ rMin: rMin, circ: circ });
            }

            let idx = 0;
            for(let t=0; t<this.config.tiers; t++) {
                const yBase = (t * this.config.tierHeight) - 30;
                const { rMin, circ } = tierRadii[t];
                const rMax = rMin + this.config.tierDepth - 2;
                
                // Distribute proportionally so upper rows don't get cut off
                const countPerTier = Math.floor(this.config.crowdCount * (circ / totalCirc));
                
                for(let i=0; i<countPerTier; i++) {
                    if (idx >= this.config.crowdCount) break;

                    const angle = Math.random() * Math.PI * 2;
                    const r = rMin + Math.random() * (rMax - rMin);
                    
                    dummy.position.set(
                        Math.cos(angle) * r,
                        yBase + 1.25, // Center of quad
                        Math.sin(angle) * r
                    );
                    
                    // Face center
                    dummy.lookAt(0, yBase, 0);
                    dummy.updateMatrix();
                    
                    this.crowd.setMatrixAt(idx, dummy.matrix);
                    
                    // Random Team Colors (Simulating fans)
                    const rand = Math.random();
                    if (rand < 0.45) color.setHex(0x0088ff); // Home Blue
                    else if (rand < 0.9) color.setHex(0xff4444); // Away Red
                    else color.setHex(0xffffff); // Neutral/Flash
                    
                    // Vary brightness for depth
                    color.multiplyScalar(0.5 + Math.random() * 0.5);
                    
                    this.crowd.setColorAt(idx, color);
                    idx++;
                }
            }
            
            this.container.add(this.crowd);
        }

        _buildHerculeanRings() {
            // Massive floating rings that rotate slowly
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x445566, 
                transparent: true, 
                opacity: 0.3,
                wireframe: true // Tech/Holographic feel
            });

            // 1. Equatorial Ring (Massive)
            const geo1 = new THREE.TorusGeometry(110, 1, 16, 100);
            const ring1 = new THREE.Mesh(geo1, mat);
            ring1.rotation.x = Math.PI / 2;
            this.container.add(ring1);
            this.rings.push({ mesh: ring1, axis: 'z', speed: 0.01 });

            // 2. Tilted Ring
            const geo2 = new THREE.TorusGeometry(130, 2, 16, 100);
            const ring2 = new THREE.Mesh(geo2, mat);
            ring2.rotation.x = Math.PI / 3;
            this.container.add(ring2);
            this.rings.push({ mesh: ring2, axis: 'y', speed: -0.008 });
            
            // 3. Vertical Ring
            const geo3 = new THREE.TorusGeometry(150, 3, 16, 100);
const ring3 = new THREE.Mesh(geo3, mat);
            this.container.add(ring3);
            this.rings.push({ mesh: ring3, axis: 'y', speed: 0.005 });
        }

        _buildStadiumLights() {
            const count = 16; // Number of lights around the equator
            const radius = 36; // Just outside the arena boundary (32)
            const yPos = 0; // Middle of the sphere
            
            const lightGeo = new THREE.SphereGeometry(0.4, 8, 8);
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

            for(let i=0; i<count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // 1. Physical Fixture (The bulb)
                const mesh = new THREE.Mesh(lightGeo, lightMat);
                mesh.position.set(x, yPos, z);
                this.container.add(mesh);

                // 2. Visual Glow (Flare)
                const sprite = new THREE.Sprite(_glowMaterial);
// 2. Visual Glow (Flare)
// 2. Visual Glow (Flare)
                sprite.position.set(x, yPos, z);
                sprite.scale.set(8, 8, 1); // Large glow
                this.container.add(sprite);
                this.lightSprites.push(sprite);

// 3. Actual Point Light - REMOVED for optimization
                // Since we use MeshBasicMaterial (Unlit), real lights waste CPU/GPU resources.
                // The sprite glow above provides the visual effect.
            }
}

        _buildGoalBarriers() {
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            
            // Geometry: Inverted Triangle (Matches Goal Hitbox)
            // Top Y: 12.0, Bottom Y: -6.0. Width at top: 28.0 (+/- 14.0).
            const geometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
-14.0, 2.0, 0.0, // Top Left
                 14.0, 2.0, 0.0, // Top Right
                  0.0, -18.0, 0.0  // Bottom Center
            ]);
            
            // UVs for shader effects
            const uvs = new Float32Array([
                0.0, 1.0,
                1.0, 1.0,
                0.5, 0.0
            ]);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
            geometry.computeVertexNormals();

            // Forcefield Shader
// Forcefield Shader
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uColor: { value: new THREE.Color(0x44aaff) }, // Cyan/Blue Energy
                    uOpacity: { value: 0.0 } // Invisible by default
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vPos;
                    void main() {
                        vUv = uv;
                        vPos = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uTime;
                    uniform vec3 uColor;
                    uniform float uOpacity;
                    varying vec2 vUv;

                    void main() {
                        // Hex Pattern Logic
                        vec2 uv = vUv * 15.0; // Density
                        uv.y += uTime * 0.5; // Scroll down
                        
                        // Simplex-like grid for hex approximation
                        vec2 r = vec2(1.0, 1.73);
                        vec2 h = r * 0.5;
                        vec2 a = mod(uv, r) - h;
                        vec2 b = mod(uv - h, r) - h;
                        vec2 g = dot(a, a) < dot(b, b) ? a : b;
                        float dist = length(g);
                        
                        // Thin lines
                        float hex = smoothstep(0.45, 0.48, dist); 
                        
                        // Scanline
                        float scan = sin(vUv.y * 30.0 - uTime * 2.0) * 0.5 + 0.5;
                        
                        // Edge Glow (Fresnel-ish)
                        float edge = pow(abs(vUv.x - 0.5) * 2.0, 3.0);
                        
                        // Compose Pattern
                        float pattern = (1.0 - hex) * 0.5; // Stronger grid
                        pattern += scan * 0.2;             // Stronger scanline
                        pattern += edge * 0.6;             // Stronger edge
                        
                        // Master Opacity Control (0 = Invisible, 1 = Visible)
                        // Base fill 0.1 + pattern, scaled by uOpacity
                        float alpha = (0.1 + pattern) * uOpacity;

                        // Tint
                        gl_FragColor = vec4(uColor, alpha);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            // Barrier A (Away Goal / -Z)
            this.barrierA = new THREE.Mesh(geometry, material.clone());
            this.barrierA.position.set(0, 0, -goalDist);
            this.container.add(this.barrierA);

            // Barrier B (Home Goal / +Z)
            this.barrierB = new THREE.Mesh(geometry, material.clone());
            this.barrierB.position.set(0, 0, goalDist);
            this.barrierB.rotation.y = Math.PI; // Face inward
            this.container.add(this.barrierB);
            
            this.barriers = [this.barrierA, this.barrierB];
        }

update(dt) {
            // Animate Rings
            this.rings.forEach(r => {
                if (r.mesh && r.axis) {
                    r.mesh.rotation[r.axis] += r.speed * dt;
                }
            });

            // Update Crowd Shader
            if (this.crowdUniforms) {
                this.crowdUniforms.uTime.value += dt;
            }

            // Update Light Pops (Cinematic)
            this.lightSprites.forEach(s => {
                if (s.visible && s.scale.x > 8.0) {
                    // Decay pop effect
                    s.scale.x -= dt * 30.0;
                    s.scale.y -= dt * 30.0;
                    if (s.scale.x < 8.0) s.scale.set(8, 8, 1);
if (s.scale.x < 8.0) s.scale.set(8, 8, 1);
                }
            });

            // Update Barrier Uniforms
            if (this.barriers) {
                this.barriers.forEach(b => {
                    if (b.material.uniforms) {
                        b.material.uniforms.uTime.value += dt;
                    }
                });
            }
}

setAllLights(visible) {
            this.lightSprites.forEach(s => {
                s.visible = visible;
                s.scale.set(8, 8, 1); // Reset scale
            });
        }

        get lightCount() {
            return this.lightSprites.length;
        }

        resetLights() {
            this.setAllLights(false);
        }

        turnOnLight(index) {

            if (this.lightSprites[index]) {
                const s = this.lightSprites[index];
                s.visible = true;
                s.material.opacity = 1.0;
                s.scale.set(20, 20, 1); // Pop effect
            }
        }
    }

    window.flux.Stadium = Stadium;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class PostProcessing {
        constructor(renderer, width, height) {
            this.renderer = renderer;
            this.enabled = true;

            // Render Target for the scene (Internal Resolution)
            this.renderTarget = new THREE.WebGLRenderTarget(width, height, {
                minFilter: THREE.NearestFilter,
                magFilter: THREE.NearestFilter,
                format: THREE.RGBAFormat,
                depthBuffer: true,
                stencilBuffer: false
            });

            // FSQ Setup
            this.orthoCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            this.scene = new THREE.Scene();

            // Shader
            this.uniforms = {
                tDiffuse: { value: null },
                uTime: { value: 0 },
                uResolution: { value: new THREE.Vector2(width, height) },
                // Retro Settings
uScanlineIntensity: { value: 0.0 }, // Disabled by default
                uScanlineCount: { value: height * 0.5 }, // Half resolution scanlines
                uVignette: { value: 0.6 },
                uNoise: { value: 0.04 },
                uAberration: { value: 1.5 }, // Pixel offset amount
                uContrast: { value: 1.1 },
                uSaturation: { value: 1.1 }
            };

            const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform sampler2D tDiffuse;
                uniform float uTime;
                uniform vec2 uResolution;
                uniform float uScanlineIntensity;
                uniform float uScanlineCount;
                uniform float uVignette;
                uniform float uNoise;
                uniform float uAberration;
                uniform float uContrast;
                uniform float uSaturation;

                varying vec2 vUv;

float random(vec2 p) {
                    return fract(sin(dot(p.xy, vec2(12.9898, 78.233))) * 43758.5453);
                }

                // 4x4 Bayer Matrix for Ordered Dithering
                float bayer4x4(vec2 uv) {
                    float x = floor(mod(uv.x, 4.0));
                    float y = floor(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0.0) { if (x == 0.0) v = 0.0; else if (x == 1.0) v = 8.0; else if (x == 2.0) v = 2.0; else v = 10.0; }
                    else if (y == 1.0) { if (x == 0.0) v = 12.0; else if (x == 1.0) v = 4.0; else if (x == 2.0) v = 14.0; else v = 6.0; }
                    else if (y == 2.0) { if (x == 0.0) v = 3.0; else if (x == 1.0) v = 11.0; else if (x == 2.0) v = 1.0; else v = 9.0; }
                    else { if (x == 0.0) v = 15.0; else if (x == 1.0) v = 7.0; else if (x == 2.0) v = 13.0; else v = 5.0; }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    
                    // Chromatic Aberration
                    vec2 dist = uv - 0.5;
                    // Offset based on distance from center
                    vec2 offset = dist * (uAberration / uResolution);
                    
                    float r = texture2D(tDiffuse, uv - offset).r;
                    float g = texture2D(tDiffuse, uv).g;
                    float b = texture2D(tDiffuse, uv + offset).b;
                    vec3 color = vec3(r, g, b);

                    // Saturation
                    float gray = dot(color, vec3(0.299, 0.587, 0.114));
                    color = mix(vec3(gray), color, uSaturation);

                    // Contrast
                    color = (color - 0.5) * uContrast + 0.5;

// Scanlines (DISABLED)
                    // float scan = sin(uv.y * uScanlineCount * 6.28 + uTime * 2.0);
                    // color -= (scan * 0.5 + 0.5) * uScanlineIntensity;

                    // Dithering (Increased)
                    float dither = bayer4x4(gl_FragCoord.xy);
                    float colorDepth = 32.0; // 5-bit color simulation
                    vec3 dithered = color + (dither - 0.5) * (1.5 / colorDepth); // 1.5x strength
                    color = floor(dithered * colorDepth) / colorDepth;

                    // Noise
                    float n = random(uv + mod(uTime, 1.0));
                    color += (n - 0.5) * uNoise;

                    // Vignette
                    float d = dot(dist, dist);
                    color *= (1.0 - d * uVignette);

                    gl_FragColor = vec4(color, 1.0);
                }
            `;

            this.material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                depthWrite: false,
                depthTest: false
            });

            this.quad = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), this.material);
            this.scene.add(this.quad);
        }

        setSize(width, height) {
            this.renderTarget.setSize(width, height);
            this.uniforms.uResolution.value.set(width, height);
            this.uniforms.uScanlineCount.value = height * 0.5;
        }

        render(scene, camera, dt) {
            if (!this.enabled) {
                this.renderer.render(scene, camera);
                return;
            }

            this.uniforms.uTime.value += dt;

            // Pass 1: Scene -> Target
            this.renderer.setRenderTarget(this.renderTarget);
            this.renderer.clear();
            this.renderer.render(scene, camera);

            // Pass 2: Target -> Screen
            this.renderer.setRenderTarget(null);
            this.uniforms.tDiffuse.value = this.renderTarget.texture;
            this.renderer.render(this.scene, this.orthoCamera);
        }
    }

    window.flux.PostProcessing = PostProcessing;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class AudioManager {
        constructor() {
            // --- BGM SYSTEM (HTML5 Audio for streaming) ---
            this.bgm = new Audio();
            this.bgm.src = 'https://files.catbox.moe/sp2yhy.mp3'; // Existing BGM
            this.bgm.loop = true;
// Duplicate removed
            this.bgm.volume = 0.5;
            
            // --- SFX SYSTEM (Web Audio API for precision & variance) ---
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            
            this.sfxBuffers = new Map();
            
            // Master Gain for SFX
            this.sfxGain = this.ctx.createGain();
            this.sfxGain.connect(this.ctx.destination);
            this.sfxGain.gain.value = 0.5;

            // Volume State
this.masterVolume = 0.8; // Increased from 0.5
            this.bgmLevel = 1.0;
            this.sfxLevel = 1.0;
            this.isMuted = false;
            this.shouldBePlaying = false;
// Duplicate removed

            // Dynamic State (Pitch/Volume modulation)
            this.currentRate = 1.0;
this.currentDynamicVol = 1.0;
            this.matchTension = 0;
            this.isOvertime = false;
            // --- SFX DICTIONARY (Public Domain / CC0) ---
            // Note: These are direct links to Pixabay Audio (Public Domain).
            // In a production environment, these should be hosted locally to avoid hotlinking issues.
this.sfxLibrary = {
                // Throw: Fast whoosh/swish
                'throw': 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_07659d95f0.mp3?filename=whoosh-motion-2-102589.mp3',
                
                // Catch: Leather glove impact (using punch/thud as proxy)
                'catch': 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_273f0f7f32.mp3?filename=punch-140236.mp3',
                
                // Tackle: Heavy body thud
                'tackle': 'https://cdn.pixabay.com/download/audio/2021/08/09/audio_03e622602d.mp3?filename=body-impact-42777.mp3',
                
                // Swim: Water splashing
                'swim': 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=water-splash-80527.mp3',
                
                // Goal: Crowd cheer
                'goal': 'https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3?filename=crowd-cheer-ii-6263.mp3',
                
                // Whistle: Referee whistle
                'whistle': 'https://cdn.pixabay.com/download/audio/2022/03/22/audio_c2b3762b36.mp3?filename=referee-whistle-102972.mp3',
                
                // UI: Blips
                'menu': 'https://cdn.pixabay.com/download/audio/2021/08/04/audio_c6ddf1b39e.mp3?filename=ui-click-43196.mp3',
                
                // Dash: Air cut
                'dash': 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_8db1f115a5.mp3?filename=whoosh-6316.mp3',
                
                // Impact: Heavy hit
                'impact': 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_736f99056c.mp3?filename=punch-2-123369.mp3'
            };

            this._preloadSFX();
            this._initWatchdogs();
        }

_initWatchdogs() {
            // BGM Loop & Resume Logic
            this.bgm.addEventListener('ended', () => {
                if (this.shouldBePlaying && !this.isMuted) {
                    this.bgm.currentTime = 0;
                    this.bgm.play().catch(e => console.warn("BGM Replay fail:", e));
                }
            });

            // Robust Unlock Strategy for Mobile (iOS/Android)
            const unlock = () => {
                // 1. Resume Web Audio Context
                if (this.ctx.state !== 'running') {
                    this.ctx.resume().then(() => {
                        // console.log("AudioContext Resumed via interaction");
                    }).catch(e => console.warn("AudioContext Resume fail:", e));
                }

                // 2. Play Silent Buffer (Crucial for iOS wake-up)
                // Creates a tiny empty buffer and plays it instantly to engage the audio engine
                try {
                    const buffer = this.ctx.createBuffer(1, 1, 22050);
                    const source = this.ctx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(this.ctx.destination);
                    source.start(0);
                } catch (e) {
                    // Ignore errors here
                }

                // 3. Resume HTML5 BGM if needed
                if (this.shouldBePlaying && this.bgm.paused && !this.isMuted) {
                    this.bgm.play().catch(e => {
                        // console.warn("BGM Resume fail:", e);
                    });
                }

                // 4. Cleanup listeners
                ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                    document.removeEventListener(evt, unlock, true);
                });
            };

            // Attach aggressive listeners
            const opts = { capture: true, passive: true };
            ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                document.addEventListener(evt, unlock, opts);
            });
        }

        _preloadSFX() {
            for (const [id, url] of Object.entries(this.sfxLibrary)) {
                this.loadSFX(id, url);
            }
        }

        async loadSFX(id, url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);
                this.sfxBuffers.set(id, audioBuffer);
                // console.log(`SFX Loaded: ${id}`);
            } catch (e) {
                console.warn(`AudioManager: Failed to load SFX '${id}' from ${url}`, e);
            }
        }

        playSFX(id, options = {}) {
            if (this.isMuted) return;
            if (this.ctx.state === 'suspended') this.ctx.resume();

            const buffer = this.sfxBuffers.get(id);
            if (!buffer) return;

            const source = this.ctx.createBufferSource();
            source.buffer = buffer;

            // Pitch Variance (prevents repetitive fatigue)
// Pitch Variance & Base Rate
            const variance = options.variance !== undefined ? options.variance : 0.1;
            let rate = options.rate !== undefined ? options.rate : 1.0;

            if (variance > 0) {
                // Random rate between (rate - variance) and (rate + variance)
                rate += (Math.random() * variance * 2 - variance);
            }
            // Clamp rate to sane limits
            source.playbackRate.value = Math.max(0.1, Math.min(4.0, rate));

            // Volume
            const gainNode = this.ctx.createGain();
            const vol = options.volume !== undefined ? options.volume : 1.0;
            gainNode.gain.value = vol;

            // Graph: Source -> Gain -> MasterSFXGain -> Destination
            source.connect(gainNode);
            gainNode.connect(this.sfxGain);

            source.start(0);
        }

        // --- BGM CONTROLS ---

        playBGM() {
            if (this.isMuted) return;
            this.shouldBePlaying = true;
            this.bgm.play().catch(e => console.log("BGM Autoplay prevented, waiting for interaction."));
        }

        stopBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }

        pauseBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
        }

        resumeBGM() {
            if (!this.isMuted && this.shouldBePlaying) {
                this.bgm.play().catch(e => {});
            }
        }

setMasterVolume(volume) {
            this.masterVolume = Math.max(0, Math.min(1, volume));
            this._updateVolumes();
        }

        setBGMLevel(level) {
            this.bgmLevel = Math.max(0, level);
            this._updateVolumes();
        }

        setSFXLevel(level) {
            this.sfxLevel = Math.max(0, level);
            this._updateVolumes();
        }

        _updateVolumes() {
            if (this.bgm) {
                this.bgm.volume = Math.min(1, this.masterVolume * this.bgmLevel);
            }
            if (this.sfxGain) {
                this.sfxGain.gain.value = this.masterVolume * this.sfxLevel;
            }
        }



        setMatchState(tension, isOvertime) {
            this.matchTension = tension;
            this.isOvertime = isOvertime;
        }

        update(dt) {
            if (!this.bgm || this.isMuted) return;

let targetRate = 1.0;
            let targetDynamicVol = 1.0;

            // Use pushed state from GameManager
            const t = Math.min(1.0, this.matchTension || 0);
            
            // Modulate Rate: 1.0 -> 1.2 (Higher pitch/tempo)
            targetRate += t * 0.2;
            
            // Modulate Volume: 1.0 -> 1.3 (Louder)
            targetDynamicVol += t * 0.3;

            // Overtime Bonus
            if (this.isOvertime) {
                targetRate += 0.05;
                targetDynamicVol += 0.1;
            }
            // Smooth Interpolation (Lerp)
            const lerpSpeed = Math.min(1.0, dt * 2.0);
            this.currentRate += (targetRate - this.currentRate) * lerpSpeed;
            this.currentDynamicVol += (targetDynamicVol - this.currentDynamicVol) * lerpSpeed;

            // Apply to BGM
            // Playback Rate (Pitch)
            if (Math.abs(this.bgm.playbackRate - this.currentRate) > 0.001) {
                this.bgm.playbackRate = this.currentRate;
            }

            // Volume (Base * Dynamic)
            const baseVol = this.masterVolume * this.bgmLevel;
            const finalVol = Math.max(0, Math.min(1.0, baseVol * this.currentDynamicVol));
            
            if (Math.abs(this.bgm.volume - finalVol) > 0.001) {
                this.bgm.volume = finalVol;
            }
        }
toggleMute() {
            this.isMuted = !this.isMuted;
            if (this.isMuted) {
                this.bgm.pause();
                this.ctx.suspend();
            } else {
                if (this.shouldBePlaying) this.bgm.play().catch(e=>{});
                this.ctx.resume();
            }
            return this.isMuted;
        }
    }

    window.flux.AudioManager = AudioManager;
})();</script>
    <script>(function() {
    // Namespace
    window.flux = window.flux || {};
    window.flux._runtimeUpdaters = window.flux._runtimeUpdaters || [];

    // Config
const _config = {
        internalWidth: 360,
        internalHeight: 640,
        bgColor: 0x001e36,
        fogColor: 0x001e36,
        fogDensity: 0.0001, // Drastically reduced to ensure visibility
        arenaRadius: 48.0
    };

    // Globals
// Globals
    const _input = { x: 0, y: 0 }; // Input state
    
    // Shader Uniforms
    const _arenaUniforms = {
        uTime: { value: 0 },
        uImpactPos: { value: new THREE.Vector3() },
        uImpactStr: { value: 0.0 }
    };
    const _particleUniforms = {
        uTime: { value: 0 }
    };

    // Expose Impact Trigger
    window.flux.triggerArenaImpact = function(pos, strength) {
        _arenaUniforms.uImpactPos.value.copy(pos);
        _arenaUniforms.uImpactStr.value = strength * 2.0; // Scale up for visibility
    };
// _input already declared above
    const _tempVec1 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec2 = new THREE.Vector3(); // Reusable for physics/logic
    let _scene, _camera, _renderer, _clock;
    let _homeTeam, _awayTeam;
    let _ball;
    let _gameManager;
    let _menuManager;

    let _audioManager;
    let _postProcessing;

    let _cameraManager;
    let _waterOverlay;
    let _lightShafts;
    let _stadium;
    let _glyphManager;

    // IMPROVED: Settings object
    const _settings = {
        joystickSensitivity: 1.0,
        aimAssist: true,
        cameraShake: true,
        hitStop: true,
        invertCamera: false,
        autoRecenter: true
    };

    // ---------------------------------------------------------------------
    // Debug IO Bridge (exposed for DevTools JSON snapshots)
    // ---------------------------------------------------------------------
    const _debugIO = window.flux._debugIO = window.flux._debugIO || {};
    _debugIO.settings = _settings;
    _debugIO.input = _debugIO.input || {};
    _debugIO.perf = _debugIO.perf || { frame: 0, rawDt: 0, dt: 0, fps: 0, avgFps: 0 };


    // ---------------------------------------------------------------------
    // Touch helpers (multi-touch safe)
    // ---------------------------------------------------------------------
    function _findTouchById(touchList, id) {
        if (id === null || id === undefined) return null;
        if (!touchList) return null;
        for (let i = 0; i < touchList.length; i++) {
            const t = touchList[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }

    function _endedTouchById(changedTouches, id) {
        if (id === null || id === undefined) return null;
        if (!changedTouches) return null;
        for (let i = 0; i < changedTouches.length; i++) {
            const t = changedTouches[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }


    function init() {
        _container = document.getElementById('game-container');

        // 1. Scene
        _scene = new THREE.Scene();
        _scene.background = new THREE.Color(_config.bgColor);
        _scene.fog = new THREE.FogExp2(_config.fogColor, _config.fogDensity);

        // 2. Camera
        const aspect = _config.internalWidth / _config.internalHeight;
_camera = new THREE.PerspectiveCamera(65, aspect, 0.1, 500);
_camera.position.set(0, 10, 15);
        _camera.lookAt(0, 0, 0);
        _scene.add(_camera); // Ensure camera is in scene for children to render

        // 3. Renderer
// 3. Renderer
        _renderer = new THREE.WebGLRenderer({
            antialias: false,
            powerPreference: "high-performance",
            precision: "mediump", // Mobile optimization: faster shaders
            stencil: false,       // Disable stencil buffer if not used
            depth: true
        });
        _renderer.setPixelRatio(1); // Force 1:1 pixel ratio, we handle scaling via setSize
        _renderer.autoClear = false; // We manage clearing via background or manual calls if needed (though scene.background handles color)
        // Expose renderer for DevTools
        if (_gameManager) _gameManager.renderer = _renderer; 
else window.flux.gameInstance = { renderer: _renderer, entities: {}, teams: { home: null, away: null } }; // Temp hook
_container.appendChild(_renderer.domElement);

// --- Video Overlay Enforcement ---
        // --- Overlay Video Logic Removed (Switched to GIF) ---
        // 5. Environment
        createParticles();
        createArena();
        createHolographicRings();
// 5.5 Game Manager
_gameManager = new window.flux.GameManager(_scene, 'ui-layer', _camera, _renderer);
        window.flux.gameInstance = _gameManager;
        
        // 5.5.1 Audio Manager
        _audioManager = new window.flux.AudioManager();
_gameManager.audioManager = _audioManager;

        // 5.5.2 Post Processing
_postProcessing = new window.flux.PostProcessing(_renderer, _config.internalWidth, _config.internalHeight);
        _postProcessing.enabled = false; // Disabled by default for performance
        _gameManager.postProcessing = _postProcessing;

        // 5.6 Camera Manager
        _cameraManager = new window.flux.CameraManager(_camera, _scene);
        _gameManager.cameraManager = _cameraManager;

        // 5.7 Dev Tools
if (window.flux.DevTools) {
            new window.flux.DevTools(_gameManager);
        }
// 5.8 Water Overlay, Light Shafts, Stadium, Glyphs
        _waterOverlay = new window.flux.WaterOverlay(_camera);
        _lightShafts = new window.flux.LightShafts(_scene);
        _stadium = new window.flux.Stadium(_scene);
        _glyphManager = new window.flux.GlyphManager(_scene);
        
if (_gameManager) {
            _gameManager.glyphManager = _glyphManager;
            _gameManager.waterOverlay = _waterOverlay;
            _gameManager.lightShafts = _lightShafts;
            _gameManager.stadium = _stadium;
        }
        // 6. Teams Setup
        _homeTeam = new window.flux.Team(_scene, 'home', 1, 0x00aaff, true);
        _awayTeam = new window.flux.Team(_scene, 'away', -1, 0xff6666, false);

        // 7. Ball
        _ball = new window.flux.Ball(_scene);

        // IMPROVED: Link ball to camera for smart framing
        _cameraManager.setBall(_ball);

        // 8. Team Roster Models
        const roles = ['LF', 'RF', 'MF', 'LD', 'RD', 'GL'];
        const homeRoster = {
            LF: { name: 'Tidus', url: 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb' },
            RF: { name: 'Wakka', url: 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb' },
            MF: { name: 'Letty', url: 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb' },
            LD: { name: 'Datto', url: 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb' },
            RD: { name: 'Jassu', url: 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb' },
            GL: { name: 'Botta', url: 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb' }
        };

const applyStats = (p, role, isHome) => {
const teamLevel = isHome ? 25 : 8; // Nerfed CPU level significantly (was 15)
            window.flux.Team.generateStats(p, role, teamLevel, isHome);

            if (p.characterName.includes('Tidus')) {
                p.stats.SH += 5;
                p.stats.SP += 3;
            } else if (p.characterName.includes('Wakka')) {
                p.stats.SH += 3;
                p.stats.EN += 5;
            } else if (p.characterName.includes('Brother')) {
                p.stats.SP = 99;
            }

            p._updateDerivedStats();
        };

        let homeLoaded = 0;
        const roleGltfs = {};

        const finalizeTeams = () => {
            roles.forEach(role => {
                const gltf = roleGltfs[role] || roleGltfs.LF;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                const entry = homeRoster[role];
                p.characterName = entry ? `CPU ${entry.name}` : 'CPU';
                applyStats(p, role, false);

                if (gltf && gltf.scene) {
                    const clone = THREE.SkeletonUtils.clone(gltf.scene);
                    p.setMesh(clone, gltf.animations || []);
                } else {
                    console.warn('Missing GLTF for away role:', role);
                }

                _awayTeam.addPlayer(p);
            });

            const allPlayers = [..._homeTeam.players, ..._awayTeam.players];
            allPlayers.forEach(p => {
                if (p.ballRef === null) p.ballRef = _ball;
            });

            _homeTeam.activePlayer = _homeTeam.players.find(p => p.role === 'MF');

            if (_homeTeam.activePlayer) {
                _homeTeam.activePlayer.techs.tackle = 'venom';
                _homeTeam.activePlayer.techs.shoot = 'sphere';
                console.log('Equipped Home MF with Venom Tackle & Sphere Shot');
            }

const awayMF = _awayTeam.players.find(p => p.role === 'MF');
            // Removed guaranteed Wither tackle for Away MF to reduce difficulty
            _awayTeam.setFormation('Counter');

            const awayGL = _awayTeam.players.find(p => p.role === 'GL');
            // Removed guaranteed Super Goalie for Away GL to make scoring easier

            _homeTeam.assignMarks(_awayTeam);
            _awayTeam.assignMarks(_homeTeam);

            document.getElementById('loading').style.display = 'none';
            if (_gameManager) {
                _gameManager.registerTeams(_homeTeam, _awayTeam, _ball);

                _menuManager = new window.flux.MenuManager(_gameManager);
                _menuManager.show();
            }
        };

roles.forEach(role => {
            const entry = homeRoster[role];
            if (!entry) return;

            const onComplete = () => {
                homeLoaded++;
                if (homeLoaded >= roles.length) {
                    finalizeTeams();
                }
            };

            window.flux.AssetLoader.loadModel(entry.url, (gltf) => {
                roleGltfs[role] = gltf;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name;
                applyStats(p, role, true);

                const clone = THREE.SkeletonUtils.clone(gltf.scene);
                p.setMesh(clone, gltf.animations);
                _homeTeam.addPlayer(p);

                onComplete();
            }, undefined, (err) => {
                console.error('Failed to load model', entry.name, entry.url, err);
                
                // Fallback Mesh (Red Box)
                const fallbackGeo = new THREE.BoxGeometry(1, 2, 1);
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const fallbackMesh = new THREE.Mesh(fallbackGeo, fallbackMat);
                
                // Store dummy in roleGltfs for away team cloning
                roleGltfs[role] = { scene: fallbackMesh, animations: [] };

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name + " (Error)";
                applyStats(p, role, true);
                
                p.setMesh(fallbackMesh.clone(), []);
                _homeTeam.addPlayer(p);

                onComplete();
            });
        });

        // 8. Input
        setupInputs();

        // 9. Loop
        _clock = new THREE.Clock();
        requestAnimationFrame(animate);

        // Handle resize
        window.addEventListener('resize', onResize);
        onResize();
    }

function createParticles() {
        const count = 200; // Optimized for performance (was 1500)
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        const offsets = []; // Random offsets for independent bobbing

        for (let i = 0; i < count; i++) {
            vertices.push(
                (Math.random() - 0.5) * 80, // Wider spread X
                (Math.random() - 0.5) * 50, // Wider spread Y
                (Math.random() - 0.5) * 80  // Wider spread Z
            );
            offsets.push(Math.random() * 100);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        const material = new THREE.ShaderMaterial({
            uniforms: _particleUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
vertexShader: `
                uniform float uTime;
                attribute float aOffset;
                varying float vAlpha;
                void main() {
                    vec3 pos = position;
                    // Bobbing motion: Sine wave based on time + random offset
                    float bob = sin(uTime * 0.5 + aOffset) * 2.0;
                    pos.y += bob;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    
                    // Size attenuation - Small and shimmery
                    float sizeBase = 2.0 + sin(uTime * 3.0 + aOffset) * 1.0; 
                    gl_PointSize = sizeBase * (20.0 / -mvPosition.z);
                    
                    // Fade based on distance/height
                    vAlpha = 0.5 + 0.5 * sin(uTime * 2.0 + aOffset);
                }
            `,
            fragmentShader: `
                varying float vAlpha;
                void main() {
                    // Soft glow particle (Dust mote)
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    float dist = length(coord);
                    if(dist > 0.5) discard;
                    
                    // Soft falloff for shimmer
                    float strength = 1.0 - (dist * 2.0);
                    strength = pow(strength, 2.0);
                    
                    // Cyan/Blue tint, additive feel
                    gl_FragColor = vec4(0.7, 0.9, 1.0, vAlpha * strength * 0.8);
                }
            `
        });

        const points = new THREE.Points(geometry, material);
        points.frustumCulled = false;
        _scene.add(points);
    }

function createArena() {
        // Group for rotation
        window.flux.arenaGroup = new THREE.Group();
        _scene.add(window.flux.arenaGroup);

        const geometry = new THREE.SphereGeometry(_config.arenaRadius, 32, 32);
        
        // --- 1. Base Sphere (Faint Grid) ---
        const texLoader = new THREE.TextureLoader();
        const arenaTex = texLoader.load('https://i.postimg.cc/W1LsH68Q/file-0000000023ec71f596593829e8118760-(1).png');
        arenaTex.magFilter = THREE.NearestFilter;
        arenaTex.minFilter = THREE.NearestFilter;
        arenaTex.wrapS = THREE.RepeatWrapping;
        arenaTex.wrapT = THREE.RepeatWrapping;
        arenaTex.repeat.set(6, 4);

        const material = new THREE.MeshBasicMaterial({
            map: arenaTex,
            color: 0x446688,
            wireframe: false,
            transparent: true,
            opacity: 0.15, 
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            depthWrite: false
        });
            
        const arena = new THREE.Mesh(geometry, material);
        window.flux.arenaGroup.add(arena);
        window.flux.arenaMesh = arena;

        // --- 2. Inner Hex Grid (Warp Effect) ---
        // Reuse existing hex generation logic but attach to group
        const hexTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            const r = 64;
            const w = r * 2;
            const h = Math.sqrt(3) * r;
            for(let y = -1; y < 512/h + 2; y++) {
                for(let x = -1; x < 512/(w*0.75) + 2; x++) {
                    const cx = x * w * 0.75;
                    const cy = y * h + (x%2===0 ? 0 : h/2);
                    ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const ang = Math.PI/3 * i;
                        ctx.lineTo(cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
            }
            return new THREE.CanvasTexture(c);
        })();
        hexTex.wrapS = THREE.RepeatWrapping;
        hexTex.wrapT = THREE.RepeatWrapping;
        hexTex.repeat.set(4, 2);

        const arenaUniforms = THREE.UniformsUtils.merge([
            THREE.UniformsLib['common'],
            _arenaUniforms,
            { 
                tMap: { value: hexTex },
                uOpacity: { value: 0.1 } 
            }
        ]);

        const material2 = new THREE.ShaderMaterial({
            uniforms: arenaUniforms,
            transparent: true,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                uniform float uTime;
                uniform vec3 uImpactPos;
                uniform float uImpactStr;
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    vec3 pos = position;
                    float dist = distance(pos, uImpactPos);
                    float radius = 20.0;
                    if (dist < radius) {
                        float t = dist / radius;
                        float bulge = (1.0 - t) * (1.0 - t);
                        vec3 normal = normalize(pos);
                        pos += normal * (bulge * uImpactStr);
                    }
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tMap;
                uniform float uImpactStr;
                uniform float uOpacity;
                varying vec2 vUv;
                void main() {
                    vec4 texColor = texture2D(tMap, vUv);
                    float alpha = uOpacity * texColor.a;
                    alpha += uImpactStr * 0.02; 
                    vec3 color = texColor.rgb * vec3(0.2, 0.8, 1.0);
                    gl_FragColor = vec4(color, alpha);
                }
            `
        });

        const arena2 = new THREE.Mesh(geometry, material2);
        arena2.scale.setScalar(0.98);
        window.flux.arenaGroup.add(arena2);
        window.flux.arenaMesh2 = arena2;

        // --- 3. EQUATOR BANDS (Blue and Gold - possession based) ---
        const bandTexLoader = new THREE.TextureLoader();

        // Blue Band (shown when home team has ball) - thin band, no vertical stretch
        const blueBandTex = bandTexLoader.load('https://i.postimg.cc/SQnFpDHN/Blue-band.png');
        blueBandTex.wrapS = THREE.RepeatWrapping;
        blueBandTex.wrapT = THREE.ClampToEdgeWrapping;
        blueBandTex.repeat.set(1, 1); // Single wrap, image tiles naturally

        const blueBandMat = new THREE.MeshBasicMaterial({
            map: blueBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
// Thin band - height of 3 to avoid stretching
        const blueBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const blueBandMesh = new THREE.Mesh(blueBandGeo, blueBandMat);
        blueBandMesh.position.y = 0;
        blueBandMesh.visible = true;
        _scene.add(blueBandMesh);

        // Gold Band (shown when away team has ball)
        const goldBandTex = bandTexLoader.load('https://i.postimg.cc/MZn28dgq/Gold-band.png');
        goldBandTex.wrapS = THREE.RepeatWrapping;
        goldBandTex.wrapT = THREE.ClampToEdgeWrapping;
        goldBandTex.repeat.set(1, 1);

        const goldBandMat = new THREE.MeshBasicMaterial({
            map: goldBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
const goldBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const goldBandMesh = new THREE.Mesh(goldBandGeo, goldBandMat);
        goldBandMesh.position.y = 0;
        goldBandMesh.visible = false;
        _scene.add(goldBandMesh);

        // Store references
        window.flux.blueBandMesh = blueBandMesh;
        window.flux.goldBandMesh = goldBandMesh;
        window.flux.blueBandMat = blueBandMat;
        window.flux.goldBandMat = goldBandMat;

        window.flux.updateBandPossession = function(homeHasBall) {
            if (window.flux.blueBandMesh && window.flux.goldBandMesh) {
                window.flux.blueBandMesh.visible = homeHasBall;
                window.flux.goldBandMesh.visible = !homeHasBall;
            }
        };

        window.flux.tribalUniforms = {
            uTime: { value: 0 },
            uColor: { value: new THREE.Color(0x00ffff) }
        };

        // --- 4. VERTICAL ARROW STRIPS (Around sphere, above & below band) ---
        const arrowTexLoader = new THREE.TextureLoader();
        const arrowTex = arrowTexLoader.load('https://i.postimg.cc/dQhPK4gQ/Yellowarrows.png');
        arrowTex.wrapS = THREE.ClampToEdgeWrapping;
        arrowTex.wrapT = THREE.ClampToEdgeWrapping;

        const arrowMat = new THREE.MeshBasicMaterial({
            map: arrowTex,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        // Create vertical arrow strips around the sphere (curved to match sphere surface)
        const arrowGroup = new THREE.Group();
        const numArrows = 16;   // Number of arrow strips around circumference
        const arrowHeight = 30; // Height of each arrow strip
        const arrowWidth = 6;   // Width of each strip
        const arrowRadius = _config.arenaRadius * 0.94;

        const makeCurvedStrip = (baseAngle, yCenter, flipV = false) => {
            // More segments = smoother curvature (keep modest for mobile)
            const segW = 6;   // curvature resolution (width)
            const segH = 18;  // vertical resolution (height)

            // Convert desired world-space width into an angular span on the sphere
            const phiSpan = arrowWidth / arrowRadius; // radians (approx at equator)
            const phi0 = baseAngle - phiSpan * 0.5;
            const phi1 = baseAngle + phiSpan * 0.5;

            const y0 = yCenter - arrowHeight * 0.5;
            const y1 = yCenter + arrowHeight * 0.5;

            const positions = [];
            const normals = [];
            const uvs = [];
            const indices = [];

            for (let iy = 0; iy <= segH; iy++) {
                const v = iy / segH;
                const y = THREE.MathUtils.lerp(y0, y1, v);

                // Circle radius at this height on the sphere (x/z shrink as |y| grows)
                const ringR = Math.sqrt(Math.max(0.00001, arrowRadius * arrowRadius - y * y));

                for (let ix = 0; ix <= segW; ix++) {
                    const u = ix / segW;
                    const phi = THREE.MathUtils.lerp(phi0, phi1, u);

                    const x = Math.sin(phi) * ringR;
                    const z = Math.cos(phi) * ringR;

                    positions.push(x, y, z);

                    // Outward normal for a sphere centered at origin
                    const invLen = 1.0 / Math.sqrt(x * x + y * y + z * z);
                    normals.push(x * invLen, y * invLen, z * invLen);

                    const vv = flipV ? (1 - v) : v;
                    uvs.push(u, vv);
                }
            }

            const row = segW + 1;
            for (let iy = 0; iy < segH; iy++) {
                for (let ix = 0; ix < segW; ix++) {
const a = iy * row + ix;
                    const b = iy * row + (ix + 1);
                    const c = (iy + 1) * row + ix;
                    const d = (iy + 1) * row + (ix + 1);
                    indices.push(a, c, b);
                    indices.push(b, c, d);
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setIndex(indices);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
            geo.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));
            geo.computeBoundingSphere();

            return new THREE.Mesh(geo, arrowMat);
        };

        for (let i = 0; i < numArrows; i++) {
            const angle = (i / numArrows) * Math.PI * 2;

            // Upper arrow strip (above band)
            arrowGroup.add(makeCurvedStrip(angle, arrowHeight * 0.5 + 2, false));

            // Lower arrow strip (below band) - flip V so arrows point downward
            arrowGroup.add(makeCurvedStrip(angle, -arrowHeight * 0.5 - 2, true));
        }

        _scene.add(arrowGroup);

        // Store references for DevTools
        window.flux.arrowGroup = arrowGroup;
        window.flux.arrowMat = arrowMat;

        // --- 5. TOP GLYPHS (Dome) --- (Dome) ---
        const topGlyphTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, Math.PI*2);
            ctx.stroke();
            
            // Intricate pattern
            for(let i=0; i<8; i++) {
                const a = (i/8)*Math.PI*2;
                const x = 256 + Math.cos(a)*150;
                const y = 256 + Math.sin(a)*150;
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI*2);
                ctx.stroke();
                // Connector
                ctx.beginPath();
                ctx.moveTo(256, 256);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(c);
        })();

        const topGlyphMat = new THREE.MeshBasicMaterial({
            map: topGlyphTex,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        const topGlyphGeo = new THREE.PlaneGeometry(60, 60);
        const topGlyph = new THREE.Mesh(topGlyphGeo, topGlyphMat);
        topGlyph.rotation.x = -Math.PI / 2;
        topGlyph.position.y = 35; // Near top of dome
        window.flux.arenaGroup.add(topGlyph);

        // --- NEW: FFX GOAL MODELS ---
        const goalUrl = 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb';
        
const onGoalLoaded = (model, isFallback) => {
            const goalA = model;

            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalY = (window.flux.BallConfig && window.flux.BallConfig.GOAL_Y_OFFSET) !== undefined ? window.flux.BallConfig.GOAL_Y_OFFSET : -18.0;

            const goalScale = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE) !== undefined ? window.flux.BallConfig.GOAL_SCALE : 45.0;
            const sx = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_X) !== undefined ? window.flux.BallConfig.GOAL_SCALE_X : 1.0;
            const sy = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_Y) !== undefined ? window.flux.BallConfig.GOAL_SCALE_Y : 1.0;
            const sz = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_Z) !== undefined ? window.flux.BallConfig.GOAL_SCALE_Z : 1.0;
            
goalA.position.set(0, goalY, -goalDist);
            if (!isFallback) {
                goalA.scale.set(goalScale * sx, goalScale * sy, goalScale * sz); 
            }
            // Setup Goal A
            goalA.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false; // CRITICAL: Prevent culling
                    c.renderOrder = 0;
                    
                    // Ensure material is visible and unique
                    if (c.material) {
                        c.material = c.material.clone(); // Clone for independence
                        c.material.color.setHex(0xffffff); // White to show original texture/colors
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.side = THREE.DoubleSide;
                        c.material.depthWrite = true;
                        c.material.depthTest = true;
                    }
                }
            });
            // Add goals to SCENE, not arenaGroup (they shouldn't rotate with the sphere)
            _scene.add(goalA);
            window.flux.goalA = goalA; // Expose for DevTools

            // Setup Goal B
            const goalB = isFallback ? goalA.clone() : THREE.SkeletonUtils.clone(goalA);

goalB.position.set(0, goalY, goalDist);
if (!isFallback) {
                goalB.scale.set(goalScale * sx, goalScale * sy, goalScale * sz);
            }
            goalB.rotation.y = Math.PI;
            // Ensure Goal B meshes are also persistent and have unique materials
            goalB.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false;
                    if (c.material) {
                        c.material = c.material.clone(); // Clone again for B
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.depthWrite = true;
                    }
                }
            });

            _scene.add(goalB);
            window.flux.goalB = goalB; // Expose for DevTools
        };

        window.flux.AssetLoader.loadModel(goalUrl, (gltf) => {
            onGoalLoaded(gltf.scene, false);
        }, undefined, (err) => {
            console.warn("Goal model failed to load. Using fallback.", err);
            const geo = new THREE.BoxGeometry(75, 45, 10); // Fallback massive box (Scaled 1.5x)
            const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            const fallback = new THREE.Mesh(geo, fallbackMat);
            onGoalLoaded(fallback, true);
        });

        // --- NEW: MASSIVE FIELD MARKINGS ---
        createFieldMarkings();
    }

function createFieldMarkings() {
        // Load floor glyph from image
        const texLoader = new THREE.TextureLoader();
        const tex = texLoader.load('https://i.postimg.cc/v8CR85dQ/Floorglyph.png');
        tex.anisotropy = 16;

        // Floor Plane (Deep)
        const geo = new THREE.PlaneGeometry(90, 90);
        const mat = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        const field = new THREE.Mesh(geo, mat);
        field.rotation.x = -Math.PI / 2;
        field.position.y = -8.0; // Sunk deep
        _scene.add(field);

        // Store references for DevTools
        window.flux.floorGlyphMesh = field;
        window.flux.floorGlyphMat = mat;
    }

function createHolographicRings() {
        // Floating Holographic Rings (Mid-height)
        const ringGeo = new THREE.TorusGeometry(20, 0.1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        ring1.rotation.x = Math.PI / 2;
        ring1.position.y = 0;
        _scene.add(ring1);
        
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        ring2.rotation.x = Math.PI / 2;
        ring2.scale.setScalar(1.2);
        ring2.position.y = 4.0;
        _scene.add(ring2);

        // Animate Rings (integrated into main loop to avoid a second RAF on mobile)
let _ringTime = 0;
        const _ringUpdate = (dt) => {
            _ringTime += dt;
            if (ring1) {
                ring1.rotation.z += dt * 0.9;
                ring1.scale.setScalar(1.0 + Math.sin(_ringTime * 0.5) * 0.05);
            }
            if (ring2) {
                ring2.rotation.z -= dt * 0.75;
                ring2.position.y = 4.0 + Math.cos(_ringTime * 0.7) * 1.0;
            }
        };
        if (window.flux && window.flux._runtimeUpdaters) window.flux._runtimeUpdaters.push(_ringUpdate);
    }

    // --- INPUT SYSTEM ---
// --- INPUT SYSTEM ---
const _keys = {};
// Globals moved to below helper

    // Helper: Analyze curve geometry for analog control
    const analyzeSwipeCurve = (points) => {
        if (points.length < 3) return { intensity: 0, speed: 0, dx: 0, dy: 0 };
        
        const pStart = points[0];
        const pEnd = points[points.length - 1];
        const midIdx = Math.floor(points.length / 2);
        const pMid = points[midIdx];

        const dx = pEnd.x - pStart.x;
        const dy = pEnd.y - pStart.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const dt = pEnd.t - pStart.t;
        const speed = (dt > 0) ? dist / dt : 0; // px/ms

        if (dist < 50) return { intensity: 0, speed: speed, dx, dy };

        const vSM_x = pMid.x - pStart.x;
        const vSM_y = pMid.y - pStart.y;

        // Cross product gives signed area/curvature direction
        const cross = (dx * vSM_y) - (dy * vSM_x);
        // Normalize by distance squared to get a curvature ratio independent of scale
const intensity = cross / (dist * dist);

        return { intensity, speed, dx, dy };
    };
    let _swipePoints = []; // Track swipe history for curves
    const _aimInput = { x: 0, y: 0, active: false }; // NEW: Aim joystick

    const _actionBuffer = { active: false, timestamp: 0, duration: 300 };

    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();
    const _upAxis = new THREE.Vector3(0, 1, 0);

function setupInputs() {
        // Skip Intro Listener
        const skipHandler = () => {
            if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') {
                window.flux.gameInstance.skipIntro();
            }
        };
        window.addEventListener('mousedown', skipHandler);
        window.addEventListener('touchstart', skipHandler, {passive: true});

        // Keyboard
        window.addEventListener('keydown', (e) => {
            _keys[e.key] = true;
            if (e.code === 'Space' && _homeTeam && _homeTeam.activePlayer && _ball) {
                _homeTeam.activePlayer.throwBall(_ball);
            }
// NEW: Tackle/Sprint on Shift
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (p.hasBall) {
                        // Offense: Sprint/Break (Instant)
                        p.dash(p.inputVector.x, p.inputVector.z);
                    } else {
                        // Defense: Start Charge
                        if (!p.isTackleCharging && !p.isTackling && !p.isRecovering) {
                            p.startTackleCharge();
                        }
                    }
                }
            }
            // NEW: Evade on 'E'
            if (e.code === 'KeyE') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    _homeTeam.activePlayer.evade();
                }
            }
            updateInputVector();
        });
window.addEventListener('keyup', (e) => { 
            _keys[e.key] = false; 
            
            // NEW: Release Tackle on Shift Up
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (!p.hasBall && p.isTackleCharging) {
                        p.releaseTackle();
                    }
                }
            }

            updateInputVector(); 
        });

        // --- FLOATING JOYSTICK (Movement) ---
        const hitZone = document.getElementById('joystick-hit-zone');
        const visuals = document.getElementById('joystick-visual-container');
        const base = document.getElementById('joystick-base');
        const knob = document.getElementById('joystick-knob');

        let startX = 0, startY = 0;
        let dragging = false;
        const maxDist = 40;

        let moveTouchId = null;
        const moveDeadzonePx = 6;

        // Expose move joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.move = _dbg.input.move || {};
        _dbg.input.move.vector = _input;
        _dbg.input.move.dragging = dragging;
        _dbg.input.move.touchId = moveTouchId;


        const handleStart = (clientX, clientY) => {
            dragging = true;
            startX = clientX;

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
            }

            startY = clientY;

            visuals.style.display = 'block';
            visuals.style.left = `${clientX}px`;
            visuals.style.top = `${clientY}px`;

            knob.style.transform = `translate(-50%, -50%)`;

            createRipple(clientX, clientY);

            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        const handleMove = (clientX, clientY) => {
            if (!dragging) return;

            let dx = clientX - startX;
            let dy = clientY - startY;

            const dist = Math.sqrt(dx*dx + dy*dy);


            // Deadzone to prevent drift from tiny thumb jitter
            if (dist < moveDeadzonePx) {
                dx = 0;
                dy = 0;
            }

            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            _input.x = (dx / maxDist) * _settings.joystickSensitivity;
            _input.y = (dy / maxDist) * _settings.joystickSensitivity;
            updateInputVector();
        };

        const handleEnd = () => {
            if (!dragging) return;
            dragging = false;

            moveTouchId = null;

            visuals.style.display = 'none';

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
                _dbg.input.move.touchId = moveTouchId;
            }


            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        if (hitZone) {
            hitZone.addEventListener('touchstart', (e) => {
                if (e.cancelable) e.preventDefault();
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
                moveTouchId = t ? t.identifier : null;
                if (_dbg && _dbg.input && _dbg.input.move) {
                    _dbg.input.move.touchId = moveTouchId;
                }
                handleStart(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                if (e.cancelable) e.preventDefault();
                const t = _findTouchById(e.touches, moveTouchId);
                if (!t) return;
                handleMove(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchend', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return; // Ignore other fingers lifting
                handleEnd();
            });
            window.addEventListener('touchcancel', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return;
                handleEnd();
            });

            hitZone.addEventListener('mousedown', (e) => {
                handleStart(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (dragging) handleMove(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', handleEnd);
        }

        // --- NEW: AIM JOYSTICK (Right side) ---
        setupAimJoystick();

        // --- NEW: TACKLE BUTTON ---
        setupTackleButton();

        // Swipe Detection
// Swipe Detection
        let swipeStart = { x: 0, y: 0, t: 0 };
        let swipeTouchId = null;
        
        // Expose swipe/throw gesture state for snapshots
        _dbg.input.swipe = _dbg.input.swipe || {};
        _dbg.input.swipe.start = swipeStart;
        _dbg.input.swipe.touchId = swipeTouchId;
        _dbg.input.swipe.points = _swipePoints;
const onSwipeStart = (x, y) => {
            swipeStart.x = x;
            swipeStart.y = y;
            swipeStart.t = Date.now();
            _swipePoints = [{x, y, t: Date.now()}];
        };

const onSwipeMove = (x, y) => {
            if (_swipePoints.length > 0) {
                _swipePoints.push({x, y, t: Date.now()});
                createSwipeTrailDot(x, y); // Visual Feedback
            }
        };

const onSwipeEnd = (x, y) => {
            if (_swipePoints.length < 2) return;
            _swipePoints.push({x, y, t: Date.now()});

            const { intensity, speed, dx, dy } = analyzeSwipeCurve(_swipePoints);
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (_homeTeam && _homeTeam.activePlayer && _camera) {
                const p = _homeTeam.activePlayer;

                // --- CURVE BALL DETECTION (Immediate Throw) ---
// --- CURVE BALL DETECTION (Immediate Throw) ---
                if (p.hasBall && !p.isThrowing && !p.isCharging) {
                    // Analog Curve Check: Threshold 0.25 requires a deliberate arc (The "Feat")
                    if (Math.abs(intensity) > 0.25 && dist > 100) {
                        _camera.getWorldDirection(_camFwd);
                        _camFwd.y = 0; _camFwd.normalize();
                        _camRight.crossVectors(_camFwd, _upAxis).normalize();

                        const worldX = (_camRight.x * dx) + (_camFwd.x * -dy);
                        const worldZ = (_camRight.z * dx) + (_camFwd.z * -dy);
                        const throwDir = new THREE.Vector3(worldX, 0, worldZ).normalize();

                        // Map intensity to spin - Drastically reduced sensitivity
                        const rawSpin = Math.abs(intensity) * 300.0; 
                        const speedFactor = Math.min(1.5, speed / 1.0);
                        const spinPower = Math.min(400.0, rawSpin * speedFactor);
                        const spinSign = Math.sign(intensity); 
                        const spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);


                        p.setOverrideAim(throwDir.x, throwDir.z);
const ball = window.flux.gameInstance && window.flux.gameInstance.entities ? window.flux.gameInstance.entities.ball : null;
                        if (ball) p.throwBall(ball, 'SH', 1.0, spinVec);
                        
                        if (window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("CURVE", p.mesh.position, "tech");
                        }
                        createRipple(x, y);
                        _swipePoints = [];
                        return; 
                    }
                }

                // --- STANDARD DASH / AIM ---
                _camera.getWorldDirection(_camFwd);
                _camFwd.y = 0;
                if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                else _camFwd.normalize();

                _camRight.crossVectors(_camFwd, _upAxis).normalize();

const worldX2 = (_camRight.x * dx) + (_camFwd.x * -dy);
                const worldZ2 = (_camRight.z * dx) + (_camFwd.z * -dy);

                if (p.isThrowing) {
p.setOverrideAim(worldX2, worldZ2);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("AIM!", p.mesh.position, "default");
                    }
                } else {
if (dist > 50) p.dash(worldX2, worldZ2);
                }

                createRipple(x, y);
            }
_swipePoints = [];
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            swipeTouchId = t ? t.identifier : null;
// onSwipeStart(t.clientX, t.clientY); // Fixed syntax error
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
            onSwipeStart(t.clientX, t.clientY);
            createRipple(t.clientX, t.clientY);
        }, { passive: false });

window.addEventListener('touchmove', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            const t = _findTouchById(e.touches, swipeTouchId);
            if (!t) return;
            onSwipeMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        });

                window.addEventListener('touchcancel', (e) => {
if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }

        });
// Mouse Swipe
        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            onSwipeStart(e.clientX, e.clientY);
            createRipple(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
             if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            // Only track if mouse is down (simulating drag)
            if (e.buttons === 1) {
                onSwipeMove(e.clientX, e.clientY);
            }
        });


        window.addEventListener('mouseup', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            onSwipeEnd(e.clientX, e.clientY);
        });

        // Action Button (Shoot/Pass)
        const actionBtn = document.getElementById('action-button');

const setupButton = (btn) => {
            if (!btn) return;

            let btnStartX = 0;
            let btnStartY = 0;
            let isDragging = false;
            let swipePoints = [];
            let actionTouchId = null;

const attemptAction = () => {
                if (!_homeTeam || !_homeTeam.activePlayer) return false;
                const p = _homeTeam.activePlayer;

                if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                    p.startCharge();
                    btn.classList.add('active');
                    return true;
                }
                
                // DEFENSE: Block
                if (!p.hasBall && !p.isDashing && !p.isEvading && p.status.nap <= 0 && p.stunTimer <= 0) {
                    p.startBlock();
                    btn.classList.add('active');
                    return true;
                }

                return false;
            };

            const handleStart = (e) => {
                if (e.cancelable) e.preventDefault();

                if (_gameManager && _gameManager.techCopyState.active) {
                    _gameManager.attemptTechCopy();
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                    return;
                }

                if (_gameManager && _gameManager.isDemoMode) return;

let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.changedTouches && e.changedTouches.length) {
                    const t = e.changedTouches[0];
                    actionTouchId = t.identifier;
                    clientX = t.clientX;
                    clientY = t.clientY;
                } else {
                    actionTouchId = null; // mouse
                }

                // Visual Feedback: Input Ripple
                createRipple(clientX, clientY);

                btnStartX = clientX;
                btnStartY = clientY;
                isDragging = true;
                swipePoints = [{x: clientX, y: clientY, t: Date.now()}];

                _actionBuffer.active = true;
                _actionBuffer.timestamp = Date.now();

                if (attemptAction()) {
                    _actionBuffer.active = false;
                }

                // Attach global listeners to track swipe outside button
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('touchcancel', handleEnd);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                // Touch path (multi-touch safe)
                if (e.touches && actionTouchId !== null) {
                    const t = _findTouchById(e.touches, actionTouchId);
                    if (!t) return;
                    swipePoints.push({x: t.clientX, y: t.clientY, t: Date.now()});
                    return;
                }

                // Mouse path
                const clientX = e.clientX;
                const clientY = e.clientY;
                swipePoints.push({x: clientX, y: clientY, t: Date.now()});
            };

const handleEnd = (e) => {
                let dx = 0;
                let dy = 0;
                let validEnd = false;

                // 1. Check Touch
                if (e.changedTouches && actionTouchId !== null) {
                    const tEnd = _endedTouchById(e.changedTouches, actionTouchId);
                    if (tEnd) {
                        dx = tEnd.clientX - btnStartX;
                        dy = tEnd.clientY - btnStartY;
                        validEnd = true;
                        actionTouchId = null;
                    }
                } 
                // 2. Check Mouse
                else if (!e.changedTouches && isDragging) {
                    dx = e.clientX - btnStartX;
                    dy = e.clientY - btnStartY;
                    validEnd = true;
                }

                if (!validEnd) return;

                // Cleanup listeners
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('touchcancel', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);

                if (!isDragging) return;
                isDragging = false;
                
                const wasBuffered = _actionBuffer.active;
                _actionBuffer.active = false;

                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    
                    // Curve Analysis
                    let curveData = null;
                    let spinVec = null;

                    // Calculate curve if we have enough data
// Calculate curve if we have enough data
                    if (swipePoints.length > 2) {
                        const analysis = analyzeSwipeCurve(swipePoints);
                        // High threshold for button release too
                        if (Math.abs(analysis.intensity) > 0.25) {
                            curveData = analysis;
                            
                            // Calculate spin vector for mouse/touch unified (Conservative values)
                            const spinPower = Math.min(400.0, Math.abs(analysis.intensity) * 1500.0);
                            const spinSign = Math.sign(analysis.intensity);
                            spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);
                        }
}

                    // EXECUTE
// EXECUTE
                    if (p.isCharging) {
                        // Normal Release
                        if (spinVec) {
                            // Unified spin passing
                            p.releaseCharge(dx, dy, { intensity: curveData.intensity, speed: curveData.speed }); 
                        } else {
                            p.releaseCharge(dx, dy, curveData);
                        }
                        btn.classList.remove('active');
                    } 
                    else if (wasBuffered && p.hasBall && !p.isThrowing && p.status.nap <= 0) {
                        // Buffered Tap (Instant Shot)
                        // Force start and release immediately
                        p.startCharge();
p.releaseCharge(dx, dy, curveData);
                        btn.classList.remove('active');
                    }
                    else if (p.isBlocking) {
                        btn.classList.remove('active');
                    }
                }
            };

            btn.addEventListener('touchstart', handleStart, { passive: false });
            btn.addEventListener('mousedown', handleStart);
        };
        setupButton(actionBtn);

// Auto Toggle
        const autoBtn = document.getElementById('auto-toggle');
        if (autoBtn) {
            const handleToggle = () => {
                if (_gameManager) {
                    _gameManager.toggleDemoMode();
                    if (_homeTeam && _homeTeam.activePlayer) {
                        _homeTeam.activePlayer.setInput(0, 0);
                    }
                }
            };

            autoBtn.addEventListener('click', handleToggle);
autoBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleToggle();
            }, { passive: false });
        }

        // NEW: Settings Button
        setupSettingsButton();
    }

    // NEW: Aim Joystick Setup
// NEW: Aim Joystick Setup
function setupAimJoystick() {
        const aimKnob = document.getElementById('aim-joystick-knob');
        const aimVisuals = document.getElementById('aim-joystick-visual');
        const aimZone = document.getElementById('aim-joystick-zone');
        if (!aimZone) return;
        let aimStartX = 0, aimStartY = 0;
        let aimDragging = false;
        const aimMaxDist = 35;
        let aimTouchId = null;

        

        // Expose aim joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.aim = _dbg.input.aim || {};
        _dbg.input.aim.vector = _aimInput;
        _dbg.input.aim.dragging = aimDragging;
        _dbg.input.aim.touchId = aimTouchId;
const handleAimStart = (clientX, clientY) => {
            aimDragging = true;
            aimStartX = clientX;

            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.dragging = aimDragging; }

            aimStartY = clientY;
            _aimInput.active = true;

            if (aimVisuals) {
                aimVisuals.style.display = 'block';
                aimVisuals.style.left = `${clientX}px`;
                aimVisuals.style.top = `${clientY}px`;
            }
            if (aimKnob) {
                aimKnob.style.transform = `translate(-50%, -50%)`;
            }
        };

        const handleAimMove = (clientX, clientY) => {
            if (!aimDragging) return;

            let dx = clientX - aimStartX;
            let dy = clientY - aimStartY;

            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > aimMaxDist) {
                dx = (dx / dist) * aimMaxDist;
                dy = (dy / dist) * aimMaxDist;
            }

            if (aimKnob) {
                aimKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            }

            // Normalize and transform to world space
            _aimInput.x = dx / aimMaxDist;
            _aimInput.y = dy / aimMaxDist;

            // Apply aim to player if charging
            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;
                if (p.isCharging || p.isThrowing) {
                    // Transform screen aim to world space
                    _camera.getWorldDirection(_camFwd);
                    _camFwd.y = 0;
                    if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                    else _camFwd.normalize();
                    _camRight.crossVectors(_camFwd, _upAxis).normalize();

                    const worldX = (_camRight.x * _aimInput.x) + (_camFwd.x * -_aimInput.y);
                    const worldZ = (_camRight.z * _aimInput.x) + (_camFwd.z * -_aimInput.y);

                    if (Math.abs(worldX) > 0.1 || Math.abs(worldZ) > 0.1) {
                        p.setOverrideAim(worldX, worldZ);
                    }
                }
            }
        };

const handleAimEnd = () => {
            if (!aimDragging) return;
            aimDragging = false;
            _aimInput.active = false;
            _aimInput.x = 0;
            _aimInput.y = 0;

            if (aimVisuals) {
                aimVisuals.style.display = 'none';
            }

            // Clear player aim override
            if (_homeTeam && _homeTeam.activePlayer) {
                _homeTeam.activePlayer.overrideAimVector = null;
            }
        };

        aimZone.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            aimTouchId = t ? t.identifier : null;
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; }
            handleAimStart(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!aimDragging) return;
            if (e.cancelable) e.preventDefault();
            const t = _findTouchById(e.touches, aimTouchId);
            if (!t) return;
            handleAimMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (!aimDragging) return;
            const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
            if (!tEnd) return;
            aimTouchId = null;
handleAimEnd();
if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
        });

        window.addEventListener('touchcancel', (e) => {
            if (!aimDragging) return;
                        const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
                        if (!tEnd) return;
                        aimTouchId = null;
handleAimEnd();
                        if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
                    });
// Mouse support for desktop testing
        aimZone.addEventListener('mousedown', (e) => {
            handleAimStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
            if (aimDragging) handleAimMove(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', (e) => {
            if (aimDragging) handleAimEnd();
        });
    }

    // NEW: Tackle Button Setup
// NEW: Tackle Button Setup
    function setupTackleButton() {
        const tackleBtn = document.getElementById('tackle-button');
        if (!tackleBtn) return;

        let holdTimer = null;
        let isHolding = false;
        let lastTapTime = 0;
        const HOLD_THRESHOLD = 200; // ms
        const DOUBLE_TAP_THRESHOLD = 300; // ms

        const handleStart = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation(); // Prevent bubbling to joystick

            // Visual Feedback: Input Ripple
            let clientX = e.clientX;
            let clientY = e.clientY;
            if (e.changedTouches && e.changedTouches.length) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            }
            createRipple(clientX, clientY);

            if (_gameManager && _gameManager.isDemoMode) return;
            if (!_homeTeam || !_homeTeam.activePlayer) return;

            const p = _homeTeam.activePlayer;

            // Visual Feedback immediately
            tackleBtn.classList.add('active');

            // Reset Hold State
            isHolding = false;
            if (holdTimer) clearTimeout(holdTimer);

            // Start Hold Timer
            holdTimer = setTimeout(() => {
                isHolding = true;
                // Only charge if we don't have the ball (Defensive Tackle)
                if (!p.hasBall) {
                    p.startTackleCharge();
                    tackleBtn.classList.add('urgent'); // Visual cue for charge
                }
            }, HOLD_THRESHOLD);
        };

        const handleEnd = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation();

            tackleBtn.classList.remove('active');
            tackleBtn.classList.remove('urgent');
            if (holdTimer) clearTimeout(holdTimer);

            if (_gameManager && _gameManager.isDemoMode) return;
            if (!_homeTeam || !_homeTeam.activePlayer) return;

            const p = _homeTeam.activePlayer;

            if (isHolding) {
                // --- HOLD RELEASE (Charged Tackle) ---
                if (!p.hasBall) {
                    p.releaseTackle();
                }
                isHolding = false;
            } else {
                // --- TAP (Tackle / Evade) ---
                const now = Date.now();
                const timeSinceLast = now - lastTapTime;

                if (timeSinceLast < DOUBLE_TAP_THRESHOLD) {
                    // --- DOUBLE TAP: EVADE ---
                    // Force cancel dash if active to allow immediate evade
                    if (p.isDashing || p.dashCooldown > 0) {
                        p.isDashing = false;
                        p.dashCooldown = 0;
                    }
                    p.evade();
                    lastTapTime = 0; // Reset to prevent triple-tap issues
                } else {
                    // --- SINGLE TAP: TACKLE / BREAK ---
                    if (!p.hasBall) {
                        // Defensive Tackle
                        let dashX = p.inputVector.x;
                        let dashZ = p.inputVector.z;

                        // If not moving, dash forward relative to player facing
                        if (Math.abs(dashX) < 0.1 && Math.abs(dashZ) < 0.1) {
// Duplicate removed
                        }

                        p.dash(dashX, dashZ);

                        if (window.flux.gameInstance.floatingText && p.isDashing) {
                            window.flux.gameInstance.floatingText.spawn("TACKLE!", p.mesh.position, "tech");
                        }
                    } else if (p.isEngaged) {
                        // Offensive Break Tackle
                        p.dash(p.inputVector.x, p.inputVector.z);
                    }
                    
                    lastTapTime = now;
                }
            }
        };

        tackleBtn.addEventListener('touchstart', handleStart, { passive: false });
        tackleBtn.addEventListener('touchend', handleEnd, { passive: false });
        
        tackleBtn.addEventListener('mousedown', handleStart);
        tackleBtn.addEventListener('mouseup', handleEnd);
        tackleBtn.addEventListener('mouseleave', (e) => {
             if (isHolding || holdTimer) handleEnd(e);
        });
    }

    // NEW: Settings Button Setup
// NEW: Settings Button Setup
function setupSettingsButton() {
        const settingsBtn = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');

        if (!settingsBtn || !settingsPanel) return;

        settingsBtn.addEventListener('click', () => {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });
        }

        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        if (sensitivitySlider) {
            sensitivitySlider.value = _settings.joystickSensitivity * 100;
            sensitivitySlider.addEventListener('input', (e) => {
                _settings.joystickSensitivity = e.target.value / 100;
            });
        }

        // Aim assist toggle
        const aimAssistToggle = document.getElementById('aim-assist-toggle');
        if (aimAssistToggle) {
            aimAssistToggle.checked = _settings.aimAssist;
            aimAssistToggle.addEventListener('change', (e) => {
                _settings.aimAssist = e.target.checked;
            });
        }

        // Camera shake toggle
        const shakeToggle = document.getElementById('shake-toggle');
        if (shakeToggle) {
            shakeToggle.checked = _settings.cameraShake;
            shakeToggle.addEventListener('change', (e) => {
                _settings.cameraShake = e.target.checked;
            });
        }

        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider && _audioManager) {
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value / 100;
_audioManager.setMasterVolume(vol);
            });
        }

        // Exit to Menu
        const exitBtn = document.getElementById('exit-to-menu-btn');
        if (exitBtn) {
            exitBtn.addEventListener('click', () => {
                if (_menuManager) {
                    _menuManager.show();
                    if (_gameManager) {
                        _gameManager.state = 'menu';
                        // Stop practice if running
                        if (_gameManager.practiceManager) {
                            _gameManager.practiceManager.stop();
                        }
                    }
                    settingsPanel.style.display = 'none';
                }
            });
        }
    }

function updateInputVector() {
        let x = _input.x || 0;
        let z = _input.y || 0;

        if (_keys['w'] || _keys['ArrowUp']) z -= 1;
        if (_keys['s'] || _keys['ArrowDown']) z += 1;
        if (_keys['a'] || _keys['ArrowLeft']) x -= 1;
        if (_keys['d'] || _keys['ArrowRight']) x += 1;

        const lenSq = x*x + z*z;
        if (lenSq > 1) {
            const len = Math.sqrt(lenSq);
            x /= len;
            z /= len;
        }

        if (isNaN(x)) x = 0;
        if (isNaN(z)) z = 0;

        if (_camera) {
            _camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(_camFwd, _upAxis).normalize();
        } else {
            _camFwd.set(0, 0, -1);
            _camRight.set(1, 0, 0);
        }

        let worldX = (_camFwd.x * -z) + (_camRight.x * x);
        let worldZ = (_camFwd.z * -z) + (_camRight.z * x);

        if (isNaN(worldX) || isNaN(worldZ)) {
            worldX = 0;
            worldZ = 0;
        }

if (_homeTeam && _homeTeam.activePlayer) {
            // FIX: Only allow movement if game is active or in practice
            const gm = window.flux.gameInstance;
            const canMove = gm && !gm.isDemoMode && (gm.state === 'active');
            
            if (canMove) {
                _homeTeam.activePlayer.setInput(worldX, worldZ);
            } else {
                _homeTeam.activePlayer.setInput(0, 0);
            }
        }
}

    function createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        document.getElementById('ui-layer').appendChild(ripple);

        setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
        }, 600);

    }

    // NEW: Visual Swipe Trail
    function createSwipeTrailDot(x, y) {
        const dot = document.createElement('div');
        dot.className = 'swipe-trail-dot';
        dot.style.left = `${x - 6}px`; // Center (12px width)
        dot.style.top = `${y - 6}px`;
        document.getElementById('ui-layer').appendChild(dot);
        
        // CSS animation handles removal, but we clean up DOM to be safe
        setTimeout(() => {
            if (dot.parentNode) dot.parentNode.removeChild(dot);
        }, 500);
    }

function onResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        if (_camera) {
            _camera.aspect = width / height;
            _camera.updateProjectionMatrix();
            // Force immediate camera update to prevent jump
            if (_cameraManager) _cameraManager.update(0);
        }
        
        // Strictly 0.50 as requested for performance
// Performance Optimization: Cap resolution
const maxDimension = 480; // Hard cap on internal render resolution (Reduced for performance)
        const currentMax = Math.max(width, height);
        let resScale = 0.50; // Base scale
        
        if (currentMax * resScale > maxDimension) {
            resScale = maxDimension / currentMax;
        }
        
        _config.internalWidth = Math.floor(width * resScale);
        _config.internalHeight = Math.floor(height * resScale);
if (_renderer) {
            _renderer.setSize(_config.internalWidth, _config.internalHeight, false);
            if (_postProcessing) _postProcessing.setSize(_config.internalWidth, _config.internalHeight);
        }
    }

// --- FIXED TIMESTEP VARIABLES ---
    let _accumulator = 0;
    const _fixedStep = 1 / 60;

    function animate() {
        requestAnimationFrame(animate);

        const rawDt = _clock.getDelta();
        // Clamp dt to prevent spirals (max 0.1s)
        const dt = Math.min(rawDt, 0.1) * (window.flux.timeScale !== undefined ? window.flux.timeScale : 0.8);

        // Perf stats for DevTools
        if (window.flux && window.flux._debugIO && window.flux._debugIO.perf) {
            const perf = window.flux._debugIO.perf;
            perf.frame = (perf.frame || 0) + 1;
            perf.rawDt = rawDt;
            perf.dt = dt;
            const fps = dt > 0 ? (1 / dt) : 0;
            perf.fps = fps;
            perf.avgFps = (perf.avgFps && perf.avgFps > 0) ? (perf.avgFps * 0.9 + fps * 0.1) : fps;
        }

        // Impact Frames (Freeze Frame Effect)
        if (_gameManager && _gameManager.impactPause > 0) {
            _gameManager.impactPause -= dt;
            if (_renderer && _scene && _camera) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

        updateInputVector();

        // Action Buffer Processing
        if (_actionBuffer.active) {
            if (Date.now() - _actionBuffer.timestamp > _actionBuffer.duration) {
                _actionBuffer.active = false;
            } else {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                        p.startCharge();
                        const btn = document.getElementById('action-button');
                        if (btn) btn.classList.add('active');
                        _actionBuffer.active = false;
                    }
                }
            }
        }

        // --- FIXED UPDATE LOOP (Physics & Game Logic) ---
        _accumulator += dt;
        // Safety Cap: Prevent spiral of death if frame takes too long
if (_accumulator > 0.1) _accumulator = 0.1; // Cap at 100ms to prevent spiral of death

        while (_accumulator >= _fixedStep) {
            const _sdt = _fixedStep;

            if (_gameManager) _gameManager.update(_sdt);

            // If in Asset Forge mode, skip game logic
            if (_gameManager && _gameManager.isForgeMode) {
                _accumulator = 0; 
                return;
            }

            const gmState = _gameManager ? _gameManager.state : '';
            const isIntro = gmState === 'intro';
            const isMenu = gmState === 'menu';

            // Update Entities (Physics/AI)
            if (_homeTeam && !isIntro && !isMenu) {
                _homeTeam.update(_sdt);
                _homeTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_awayTeam && !isIntro && !isMenu) {
                _awayTeam.update(_sdt);
                _awayTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_ball && !isIntro && !isMenu) {
                _ball.update(_sdt);
            }

            // Ball Lab
            if (window.flux && window.flux.ballLab && typeof window.flux.ballLab.update === 'function') {
                window.flux.ballLab.update(_sdt);
            }

            // Runtime Updaters (e.g. Rings logic)
            if (window.flux && window.flux._runtimeUpdaters && window.flux._runtimeUpdaters.length) {
                for (let ui = 0; ui < window.flux._runtimeUpdaters.length; ui++) {
                    const fn = window.flux._runtimeUpdaters[ui];
                    if (typeof fn === 'function') fn(_sdt);
                }
            }

            _accumulator -= _fixedStep;
        }

        // --- VISUAL UPDATE LOOP (Once Per Frame) ---
        // These systems don't affect gameplay outcome, so we update them with the visual delta `dt`
        // to ensure smooth animation at high refresh rates (90/120Hz) without wasting CPU on physics.

        const gmState = _gameManager ? _gameManager.state : '';
        const isIntro = gmState === 'intro';
        const isMenu = gmState === 'menu';

        // Camera
        if (!isIntro && !isMenu) {
            updateCameraLogic(dt);
        }

        // Visual FX Systems
        if (_waterOverlay) _waterOverlay.update(dt);
        if (_lightShafts) _lightShafts.update(dt);
        if (_stadium) _stadium.update(dt);
        if (_glyphManager) _glyphManager.update(dt);

if (_glyphManager) _glyphManager.update(dt);
        if (_gameManager) _gameManager.updateVisuals(dt);
        if (_arenaUniforms) {
            _arenaUniforms.uTime.value += dt;
            _arenaUniforms.uImpactStr.value *= Math.max(0, 1.0 - dt * 4.0);
        }

        if (window.flux.arenaGroup) {
            window.flux.arenaGroup.rotation.y += dt * 0.05;
        }

        if (window.flux.tribalUniforms) {
            window.flux.tribalUniforms.uTime.value += dt;
            let targetColor = new THREE.Color(0x00ffff);
            if (_ball && _ball.holder) {
                if (_ball.holder.team && _ball.holder.team.side === -1) {
                    targetColor.setHex(0xff8800);
                }
            }
            window.flux.tribalUniforms.uColor.value.lerp(targetColor, dt * 2.0);
        }

        if (_particleUniforms) {
            _particleUniforms.uTime.value += dt;
        }

        // Render
// Render
        if (_renderer && _scene && _camera) {
            if (_postProcessing) {
                _postProcessing.render(_scene, _camera, dt);
            } else {
                _renderer.render(_scene, _camera);
            }
        }
        // UI Updates
        updateUI();
    }

function updateUI() {
        // Prevent UI updates during intro to keep things hidden
        if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') return;

        if (!_homeTeam || !_homeTeam.activePlayer) return;
        const btn = document.getElementById('action-button');
        const lbl = document.getElementById('action-label');
        const tackleBtn = document.getElementById('tackle-button');
        const p = _homeTeam.activePlayer;

        if (btn && lbl) {
            const btnText = btn.querySelector('.btn-text');

            if (p.hasBall) {
                if (btnText && btnText.innerText !== "ACTION") {
                    btnText.innerText = "ACTION";
                    btn.classList.add('shoot-mode');
                    lbl.innerText = "OFFENSE";
                    lbl.classList.add('shoot-label');
                }

                const isHighEnergy = (p.stats.HP / p.stats.maxHP) > 0.4;
                if (isHighEnergy) {
                    if (!btn.classList.contains('limit-ready')) btn.classList.add('limit-ready');
                } else {
                    if (btn.classList.contains('limit-ready')) btn.classList.remove('limit-ready');
                }

} else {
                if (p.isBlocking) {
                    if (btnText && btnText.innerText !== "BLOCK") {
                        btnText.innerText = "BLOCK";
                        btn.classList.add('active'); // Ensure visual feedback
                        lbl.innerText = "DEFENSE";
                    }
                } else {
                    if (btnText && btnText.innerText !== "SWIM") {
                        btnText.innerText = "SWIM";
                        btn.classList.remove('shoot-mode');
                        btn.classList.remove('limit-ready');
                        btn.classList.remove('active');
                        lbl.innerText = "NORMAL";
                        lbl.classList.remove('shoot-label');
                    }
                }
            }
        }

        // Update tackle button visibility
        if (tackleBtn) {
            if (!p.hasBall || p.isEngaged) {
                tackleBtn.style.display = 'flex';
                // Update tackle button text based on context
                const tackleText = tackleBtn.querySelector('.btn-text');
                if (tackleText) {
                    if (p.isEngaged && p.hasBall) {
                        tackleText.innerText = 'BREAK';
                        tackleBtn.classList.add('urgent');
                    } else {
                        tackleText.innerText = 'TACKLE';
                        tackleBtn.classList.remove('urgent');
                    }
                }
            } else {
                tackleBtn.style.display = 'none';
            }
        }

        // Update distance to goal indicator
        const distIndicator = document.getElementById('goal-distance');
        if (distIndicator && p.mesh) {
            const goalZ = (p.team && p.team.side === 1) ? -28 : 28;
            const dist = Math.abs(p.mesh.position.z - goalZ);
            distIndicator.innerText = `${Math.floor(dist)}m`;
        }
    }

function updateCameraLogic(dt) {
        if (!_cameraManager || !_ball) return;

        let targetMesh = _ball.mesh;
        let targetVel = _ball.velocity;
        let targetInput = null;
        let isAiming = false;

        if (_ball.holder && _ball.holder.mesh) {
            targetMesh = _ball.holder.mesh;
            targetVel = _ball.holder.velocity;
            if (_ball.holder.inputVector) {
                targetInput = _ball.holder.inputVector;
            }
// Check aiming state (Charging or Throwing)
            if (_ball.holder.isCharging || _ball.holder.isThrowing) {
                isAiming = true;
            }
        }

        _cameraManager.setTarget(targetMesh, targetVel, targetInput, isAiming);
        _cameraManager.update(dt);
    }

function checkBallGrab(entity) {
        if (!entity.canCatch) return;
        if (_ball && !_ball.isCatchable()) return;
        if (entity.stunTimer > 0 || (entity.status && entity.status.nap > 0)) return;
        if (_ball.state !== 'free') return;
        if (!_ball.mesh || !entity.mesh) return;

        const ballPos = _ball.mesh.position;
        const entPos = entity.mesh.position;

        const dx = ballPos.x - entPos.x;
        const dz = ballPos.z - entPos.z;
        const distXZ = Math.sqrt(dx*dx + dz*dz);
        const distY = Math.abs(ballPos.y - entPos.y);

        // --- RELAXED TOLERANCES FOR EASIER PICKUP ---
        const touchRadius = 1.5; // Increased from 1.0 (Auto-grab radius)
        let magnetRadius = 3.5;  // Increased from 1.8 (Magnetic radius)
        let interactionRadius = 6.0; // Increased from 3.5 (Turn-to radius)
        let catchHeight = 6.0;   // Increased from 3.0 (Vertical reach)

        if (entity.isDashing) {
            magnetRadius = 4.5;
            interactionRadius = 7.0;
            catchHeight = 7.0;
        }

        if (distXZ > interactionRadius || distY > catchHeight) return;

        // Optimization: Use shared vectors to avoid GC
        _tempVec1.copy(ballPos).sub(entPos).normalize(); // toBall
        _tempVec2.set(0, 0, 1).applyQuaternion(entity.mesh.quaternion).normalize(); // playerForward

        const facingDot = _tempVec2.dot(_tempVec1);

        const coneThreshold = -0.4; // More generous cone (was -0.2)
        const isInCone = facingDot > coneThreshold;
        
        // AUTO-TURN: If near but facing wrong way, turn towards ball
        if (distXZ < interactionRadius && !isInCone) {
            const targetAngle = Math.atan2(_tempVec1.x, _tempVec1.z);
            const q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);
            entity.mesh.quaternion.slerp(q, 0.2); // Faster turn (was 0.1)
            if (entity.syncRotation) entity.syncRotation();
        }

        // GRAB LOGIC
        // 1. Touch: Very close (ignore facing - prevents running over ball)
        // 2. Magnet: Close and facing
        const isTouch = distXZ < touchRadius;
        const isMagnet = distXZ < magnetRadius && isInCone;

        if (isTouch || isMagnet) {
            // BLAST THROUGH LOGIC
            const ballSpeed = _ball.velocity.length();
            let catchChance = 1.0;

            // If ball is moving fast (e.g. > 20), check CA
            if (ballSpeed > 20.0) {
                const ca = entity.getStat('CA');
                // Difficulty scales with speed. 
                const difficulty = ballSpeed * 1.2; 
                
                if (difficulty > ca) {
                    catchChance = 0.4 + (ca / difficulty) * 0.6;
                    
                    // Point Blank Penalty: Harder to react if ball is right on top of you moving fast
                    if (distXZ < 1.2) {
                        catchChance *= 0.6; // Blast through likely
                    }
                    
                    if (entity.isDashing) catchChance += 0.2;
                }
            } else if (_ball.powerType === 'SH' && _ball.power > 15.0) {
                // Shot power check
                const ca = entity.getStat('CA');
                if (_ball.power > ca * 1.2) {
                    const chance = Math.min(0.7, (_ball.power - ca) * 0.04);
                    catchChance = 1.0 - chance;
                }
            }

            let fumble = false;
            if (Math.random() > catchChance) {
                fumble = true;
            }

            if (fumble) {
                if (window.flux.gameInstance.floatingText) {
                    // Visual feedback for blast through
                    window.flux.gameInstance.floatingText.spawn("BLAST THROUGH!", entPos, "damage");
                }
                
                // Deflect slightly but keep moving fast (Blast Through)
                // Don't stop it completely like a block, just perturb it
                _ball.velocity.multiplyScalar(0.85); 
                _ball.velocity.x += (Math.random()-0.5) * 5.0;
                _ball.velocity.y += (Math.random()) * 5.0; // Pop up
                _ball.velocity.z += (Math.random()-0.5) * 5.0;
                
                _ball.power *= 0.7;

                entity.canCatch = false;
                // Stun briefly
                entity.stunTimer = 0.5;
                if(entity.play) entity.play('react', 0.1);
                
entity.catchCooldown = 1.0;

            } else {
                _ball.magnetize(entity);
            }
        }
    }

    // Start
    init();
})();</script>


</body></html>