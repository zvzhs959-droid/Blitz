<html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitzball FFX Remastered</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700;900&display=swap');

:root {
    /* --- THE SPIRAN PALETTE --- */
    --ffx-blue-deep: #010205;       /* Void */
    --ffx-blue-dark: #081226;       /* Midnight Depth */
    --ffx-blue-mid: #16325B;        /* Zanarkand Sea */
    --ffx-blue-light: #3b75ba;      /* Sphere Water */
    
    --ffx-cyan: #00f2ff;            /* Spirit Energy */
    --ffx-cyan-glow: #a2f9ff;       /* Pyrefly Core */
    --ffx-cyan-dim: #005f73;        /* Deep Magic */

    --ffx-gold: #c5a059;            /* Yevon Script */
    --ffx-gold-light: #fceeb5;      /* Holy Aura */
    --ffx-gold-dark: #7a5c22;       /* Aged Relic */
    
    --ffx-glass-bg: rgba(6, 12, 24, 0.85);
    --ffx-glass-border: rgba(0, 242, 255, 0.25);
    
    /* Typography */
    --font-title: 'Cinzel', 'Garamond', serif;
    --font-data: 'Impact', 'Arial Narrow', sans-serif;
    --font-ui: 'Courier New', monospace;
    --font-spira: 'Spira', 'Impact', sans-serif;
}

@font-face {
    font-family: 'Spira';
    src: url('https://files.catbox.moe/zyn7s3.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

html, body {
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    width: 100vw;
    height: 100%;
    position: fixed; 
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    font-family: var(--font-data);
    color: white;
    user-select: none;
    -webkit-user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

* {
    box-sizing: border-box;
}
/* --- SPIRAN UTILITIES --- */

/* Global Keyframes */
@keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
}

@keyframes pulse-glow {
    0% { box-shadow: 0 0 5px var(--ffx-cyan-dim); }
    50% { box-shadow: 0 0 20px var(--ffx-cyan), 0 0 10px var(--ffx-blue-light); }
    100% { box-shadow: 0 0 5px var(--ffx-cyan-dim); }
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
}

@keyframes holographic-flicker {
    0% { opacity: 0.95; }
    5% { opacity: 0.8; }
    10% { opacity: 0.95; }
    100% { opacity: 0.95; }
}

/* Glass Panel Utility - The Foundation of the UI */
.glass-panel {
    background: linear-gradient(160deg, rgba(6, 12, 24, 0.9) 0%, rgba(10, 25, 50, 0.8) 100%);
    backdrop-filter: blur(16px) saturate(120%);
    -webkit-backdrop-filter: blur(16px) saturate(120%);
    
    border: 1px solid rgba(0, 242, 255, 0.1);
    border-top: 1px solid rgba(0, 242, 255, 0.3);
    border-bottom: 1px solid rgba(0, 242, 255, 0.05);
    
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.6),
        inset 0 0 30px rgba(0, 242, 255, 0.05);
        
    position: relative;
    overflow: hidden;
    
    /* Asymmetric Cut - FFX Style */
    clip-path: polygon(
        0 0, 
        100% 0, 
        100% 85%, 
        95% 100%, 
        0 100%
    );
}

/* Shimmer Effect for Glass Panels */
.glass-panel::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(
        105deg, 
        transparent 20%, 
        rgba(255, 255, 255, 0.05) 40%, 
        rgba(0, 242, 255, 0.1) 45%, 
        rgba(255, 255, 255, 0.05) 50%, 
        transparent 70%
    );
    background-size: 200% 100%;
    animation: shimmer 8s infinite linear;
    pointer-events: none;
    mix-blend-mode: overlay;
}

/* Decorative Corner Accent */
.glass-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--ffx-cyan), transparent);
    opacity: 0.7;
    box-shadow: 0 0 10px var(--ffx-cyan);
}
/* --- MAIN GAME CONTAINER --- */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    background: #000510;
    box-shadow: none;
    overflow: hidden;
    transition: filter 0.05s;
    z-index: 1;
    contain: strict;
}

/* --- IMPACT FX --- */
/* --- IMPACT FX (JUICED) --- */
#game-container.impact-fx {
    animation: impactShake 0.15s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(1.3) brightness(1.2) saturate(1.2);
    will-change: transform, filter;
}

#game-container.impact-heavy {
    animation: impactHeavy 0.25s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(1.5) brightness(1.3) saturate(1.5) sepia(0.2);
    will-change: transform, filter;
}

#game-container.impact-shatter {
    animation: impactShatter 0.5s cubic-bezier(.36,.07,.19,.97) both;
    filter: contrast(2.0) brightness(1.5) saturate(2.0) invert(0.05);
    will-change: transform, filter;
}

@keyframes impactShake {
    0% { transform: translate3d(0, 0, 0); }
    25% { transform: translate3d(-3px, 2px, 0) scale(1.01); }
    50% { transform: translate3d(3px, -2px, 0) scale(1.01); }
    75% { transform: translate3d(-3px, -2px, 0) scale(1.01); }
    100% { transform: translate3d(0, 0, 0) scale(1); }
}

@keyframes impactHeavy {
    0% { transform: translate3d(0, 0, 0) scale(1); }
    10% { transform: translate3d(-6px, 4px, 0) scale(1.02); }
    30% { transform: translate3d(6px, -4px, 0) scale(1.02); }
    50% { transform: translate3d(-4px, -2px, 0) scale(1.04); filter: contrast(1.8) brightness(1.5); }
    70% { transform: translate3d(4px, 2px, 0) scale(1.02); }
    100% { transform: translate3d(0, 0, 0) scale(1); }
}

@keyframes impactShatter {
    0% { transform: translate3d(0, 0, 0) scale(1); filter: hue-rotate(0deg); }
    10% { transform: translate3d(-10px, 5px, 0) scale(1.05) skewX(2deg); filter: hue-rotate(45deg) contrast(2.5); }
    20% { transform: translate3d(10px, -5px, 0) scale(1.05) skewX(-2deg); filter: hue-rotate(-45deg); }
    40% { transform: translate3d(0, 0, 0) scale(1.1); filter: invert(0.2); }
    60% { transform: translate3d(-5px, 0, 0) scale(1.05); }
    100% { transform: translate3d(0, 0, 0) scale(1); filter: hue-rotate(0deg); }
}

/* --- CANVAS & RENDER --- */
canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    image-rendering: pixelated; 
    z-index: 0;
}

/* --- GIF OVERLAY --- */
#screen-overlay-gif {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    mix-blend-mode: overlay;
    opacity: 1.0;
    pointer-events: none;
    z-index: 950;
    image-rendering: pixelated;
}

#ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1000;
    contain: strict;
}

/* --- CINEMATIC BARS --- */
#cinematic-bars .bar {
    position: absolute;
    left: 0; width: 100%; height: 0;
    background: black;
    transition: height 0.5s ease;
    z-index: 800;
}
#cinematic-bars .bar.top { top: 0; }
#cinematic-bars .bar.bottom { bottom: 0; }

/* --- TECH FLASH OVERLAY --- */
/* --- TECH FLASH OVERLAY (LIMIT BREAK STYLE) --- */
#tech-flash-overlay {
    position: absolute;
    top: 25%; left: 0; width: 100%; height: 150px;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* Limit Break Gradient */
    background: linear-gradient(90deg, 
        rgba(0,0,0,0) 0%, 
        rgba(50, 0, 0, 0.8) 20%, 
        rgba(100, 20, 0, 0.9) 50%, 
        rgba(50, 0, 0, 0.8) 80%, 
        rgba(0,0,0,0) 100%
    );
    z-index: 2200;
    backdrop-filter: blur(4px);
    border-top: 2px solid rgba(255, 100, 0, 0.5);
    border-bottom: 2px solid rgba(255, 100, 0, 0.5);
    transform: skewX(-15deg);
    box-shadow: 0 0 50px rgba(255, 50, 0, 0.3);
    animation: limitBreakEnter 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes limitBreakEnter {
    0% { transform: skewX(-15deg) scaleY(0); opacity: 0; }
    100% { transform: skewX(-15deg) scaleY(1); opacity: 1; }
}

/* Shatter Lines (Pseudo-elements) */
#tech-flash-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: repeating-linear-gradient(
        45deg,
        transparent 0,
        transparent 10px,
        rgba(255, 255, 255, 0.05) 10px,
        rgba(255, 255, 255, 0.05) 20px
    );
    pointer-events: none;
    mix-blend-mode: overlay;
}

.tech-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: skewX(15deg); /* Counter-skew text */
    position: relative;
    z-index: 2;
}

.tech-text {
    font-family: var(--font-title); /* Cinzel */
    font-weight: 900;
    font-size: clamp(40px, 12vw, 64px);
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 5px;
    line-height: 1.0;
    
    /* Limit Break Gold/White Gradient */
    background: linear-gradient(to bottom, #ffffff 0%, #ffffaa 40%, #ffaa00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8)) drop-shadow(0 0 20px rgba(255, 0, 0, 0.4));
    
    animation: limitTextPulse 0.1s infinite alternate;
    text-align: center;
    margin-bottom: 5px;
}

@keyframes limitTextPulse {
    0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8)); }
    100% { transform: scale(1.05); filter: drop-shadow(0 0 20px rgba(255, 200, 0, 1.0)); }
}

.tech-sub-text {
    font-family: var(--font-spira);
    font-size: 16px;
    color: #00ffff;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 10px;
    text-shadow: 0 0 10px #00ffff;
    background: rgba(0, 0, 0, 0.5);
    padding: 2px 10px;
    border: 1px solid rgba(0, 255, 255, 0.3);
}

.tech-timer-track {
    width: 300px;
    height: 12px;
    background: rgba(20, 0, 0, 0.8);
    border: 1px solid #ff4400;
    border-radius: 2px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(255, 68, 0, 0.4);
    position: relative;
}

.tech-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffaa00, #ffff00, #ffffff);
    width: 100%;
    transform-origin: left;
    box-shadow: 0 0 20px #ffaa00;
    position: relative;
}

/* Shimmer on bar */
.tech-timer-fill::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    animation: shimmer 0.5s infinite linear;
}

/* --- HUD TOP (HERCULEAN SCOREBOARD) --- */
#hud-top {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 160px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 20px;
    pointer-events: none;
    z-index: 1100;
    font-family: var(--font-data);
    perspective: 1000px;
}

/* --- WINGS (Team Panels) --- */
.sb-wing {
    position: relative;
    width: 350px;
    height: 100px;
    display: flex;
    align-items: center;
    transform-style: preserve-3d;
}

.sb-wing.home {
    justify-content: flex-start;
    margin-left: 20px;
}

.sb-wing.away {
    justify-content: flex-end;
    margin-right: 20px;
}

/* Background Shape */
.sb-wing-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(160deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 10, 20, 0.8) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    z-index: 0;
}

.sb-wing.home .sb-wing-bg {
    transform: skewX(-20deg);
    border-left: 4px solid var(--ffx-cyan);
    border-top: 1px solid rgba(0, 242, 255, 0.3);
    clip-path: polygon(0 0, 100% 0, 90% 100%, 0 100%);
}

.sb-wing.away .sb-wing-bg {
    transform: skewX(20deg);
    border-right: 4px solid #ff4444;
    border-top: 1px solid rgba(255, 68, 68, 0.3);
    clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%);
}

/* Content Container (Counter-skew) */
.sb-content-container {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 0 30px;
}

.sb-wing.home .sb-content-container {
    transform: skewX(20deg); /* Counter skew */
    justify-content: flex-start;
}

.sb-wing.away .sb-content-container {
    transform: skewX(-20deg); /* Counter skew */
    justify-content: flex-end;
}

/* Team Info */
.sb-team-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.sb-wing.away .sb-team-info {
    align-items: flex-end;
    text-align: right;
}

.sb-team-name {
    font-family: var(--font-title);
    font-size: 28px;
    color: #fff;
    text-transform: uppercase;
    line-height: 0.9;
    text-shadow: 0 0 10px rgba(255,255,255,0.5);
    letter-spacing: 2px;
}

.sb-team-sub {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-gold);
    letter-spacing: 4px;
    margin-top: 4px;
    text-transform: uppercase;
}

/* Score Wrapper */
.sb-score-wrapper {
    position: relative;
    width: 100px;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

.sb-score {
    font-size: 72px;
    font-weight: 900;
    color: #fff;
    line-height: 1.0;
    z-index: 2;
}

.sb-wing.home .sb-score {
    background: linear-gradient(180deg, #ffffff 0%, #00ffff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 0 rgba(0,0,0,0.5)) drop-shadow(0 0 15px var(--ffx-cyan));
    margin-left: 20px;
}

.sb-wing.away .sb-score {
    background: linear-gradient(180deg, #ffffff 0%, #ff4444 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 0 rgba(0,0,0,0.5)) drop-shadow(0 0 15px #ff4444);
    margin-right: 20px;
}

/* Score Update Animation */
.sb-score.score-update {
    animation: scorePop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes scorePop {
    0% { transform: scale(1); }
    50% { transform: scale(1.5); filter: brightness(2); }
    100% { transform: scale(1); }
}

/* Crystal Deco */
.sb-crystal-deco {
    position: absolute;
    top: -5px;
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(0,0,0,0) 70%);
    mix-blend-mode: overlay;
    z-index: 3;
    animation: pulse-glow 3s infinite;
}
.sb-wing.home .sb-crystal-deco { left: -10px; }
.sb-wing.away .sb-crystal-deco { right: -10px; }

/* Energy Conduit (Bar at bottom) */
.sb-energy-conduit {
    position: absolute;
    bottom: 0;
    height: 4px;
    width: 80%;
    background: #fff;
    box-shadow: 0 0 10px currentColor;
    z-index: 2;
}
.sb-wing.home .sb-energy-conduit {
    left: 0;
    background: var(--ffx-cyan);
    transform: skewX(-20deg);
}
.sb-wing.away .sb-energy-conduit {
    right: 0;
    background: #ff4444;
    transform: skewX(20deg);
}

/* --- CHRONOSPHERE (Center Timer) --- */
.sb-chronosphere {
    position: relative;
    width: 140px;
    height: 140px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
}

.chrono-core {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 30, 60, 0.9) 0%, rgba(0, 10, 20, 0.95) 100%);
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 30px rgba(0, 242, 255, 0.3), inset 0 0 20px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
    backdrop-filter: blur(5px);
}

.chrono-ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid rgba(0, 242, 255, 0.3);
    pointer-events: none;
}

.chrono-ring.outer {
    width: 130px; height: 130px;
    border: 2px dashed var(--ffx-cyan);
    animation: spinSlow 20s linear infinite;
    opacity: 0.6;
}

.chrono-ring.mid {
    width: 115px; height: 115px;
    border: 1px solid rgba(255, 215, 0, 0.4);
    border-left: 2px solid var(--ffx-gold);
    border-right: 2px solid var(--ffx-gold);
    animation: spinSlow 15s linear infinite reverse;
}

.chrono-ring.inner {
    width: 90px; height: 90px;
    border: 1px dotted rgba(255, 255, 255, 0.5);
    animation: spinSlow 10s linear infinite;
}

@keyframes spinSlow { to { transform: rotate(360deg); } }

.chrono-gem {
    position: absolute;
    width: 12px; height: 12px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 0 10px #fff, 0 0 20px var(--ffx-cyan);
    z-index: 15;
}
.chrono-gem.top { top: 0; }
.chrono-gem.bottom { bottom: 0; }

#half-indicator {
    font-family: var(--font-spira);
    font-size: 14px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    margin-bottom: 2px;
    text-shadow: 0 0 5px var(--ffx-gold);
}

#timer-display {
    font-family: var(--font-data);
    font-size: 36px;
    color: #fff;
    letter-spacing: 2px;
    text-shadow: 0 0 15px var(--ffx-cyan);
    font-weight: bold;
}

/* --- MOBILE ADJUSTMENTS FOR HERCULEAN HUD --- */
@media screen and (max-width: 768px) {
    #hud-top {
        height: 120px;
        padding: 5px;
    }

    .sb-wing {
        width: 130px;
        height: 70px;
    }
    
    .sb-wing.home .sb-wing-bg { transform: skewX(-10deg); }
    .sb-wing.away .sb-wing-bg { transform: skewX(10deg); }
    
    .sb-wing.home .sb-content-container { transform: skewX(10deg); padding: 0 10px; }
    .sb-wing.away .sb-content-container { transform: skewX(-10deg); padding: 0 10px; }

    .sb-team-name { font-size: 14px; }
    .sb-team-sub { display: none; }
    
    .sb-score { font-size: 42px; }
    .sb-score-wrapper { width: 50px; }
    
    .sb-wing.home .sb-score { margin-left: 5px; }
    .sb-wing.away .sb-score { margin-right: 5px; }

    .sb-chronosphere {
        width: 90px; height: 90px;
        margin-top: 0;
    }
    .chrono-core { width: 70px; height: 70px; }
    .chrono-ring.outer { width: 85px; height: 85px; }
    .chrono-ring.mid { width: 78px; height: 78px; }
    .chrono-ring.inner { width: 65px; height: 65px; }
    
    #timer-display { font-size: 20px; }
    #half-indicator { font-size: 10px; }
    
    .sb-crystal-deco { display: none; }
}
/* --- PLAYER STATUS PANEL (LIQUID LIGHT) --- */
#player-status-panel {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 40px);
    left: max(20px, env(safe-area-inset-left));
    width: 200px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(0, 10, 30, 0.85) 0%, rgba(0, 20, 40, 0.6) 100%);
    border: 1px solid rgba(100, 200, 255, 0.2);
    border-left: 4px solid var(--ffx-cyan);
    border-radius: 0 15px 0 15px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transform: skewX(-10deg);
    pointer-events: none;
    display: none; /* Managed by JS */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    overflow: hidden;
}

/* Decorative background shard */
#player-status-panel::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.03) 50%, transparent 55%);
    animation: shimmer 6s infinite linear;
    pointer-events: none;
}

.char-name {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-transform: uppercase;
    margin-bottom: 8px;
    transform: skewX(10deg);
    text-shadow: 0 0 10px var(--ffx-blue-light);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 2px;
    display: flex;
    justify-content: space-between;
}

.hp-gauge-container {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    transform: skewX(10deg);
    position: relative;
}
.hp-label { 
    font-family: var(--font-ui);
    font-size: 10px; 
    color: var(--ffx-cyan); 
    width: 25px; 
    text-shadow: 0 0 5px var(--ffx-cyan);
}
.hp-bar-track {
    flex-grow: 1;
    height: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #334455;
    margin: 0 8px;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
}
.hp-bar-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #00aa44, #44ff88, #00aa44);
    background-size: 200% 100%;
    animation: liquidFlow 3s linear infinite;
    box-shadow: 0 0 10px #00ff44;
    border-radius: 2px;
    transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0);
}
.hp-value { 
    font-family: var(--font-data);
    font-size: 12px; 
    color: #fff; 
    width: 55px; 
    text-align: right; 
    letter-spacing: 1px;
}

.tech-gauge-container {
    display: flex;
    align-items: center;
    transform: skewX(10deg);
}
.tech-label { 
    font-family: var(--font-ui);
    font-size: 10px; 
    color: var(--ffx-gold); 
    width: 25px; 
    text-shadow: 0 0 5px var(--ffx-gold);
}
.tech-bar-track {
    flex-grow: 1;
    height: 4px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #443322;
    margin: 0 8px;
    border-radius: 2px;
    overflow: hidden;
}
.tech-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #aa6600, #ffcc00, #aa6600);
    background-size: 200% 100%;
    animation: liquidFlow 4s linear infinite;
    box-shadow: 0 0 5px #ffaa00;
}

@keyframes liquidFlow {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}
/* --- MINIMAP --- */
#minimap-container {
    position: absolute;
    top: max(80px, env(safe-area-inset-top) + 60px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    height: 110px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.radar-rim {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid var(--ffx-blue-light);
    box-shadow: 0 0 15px var(--ffx-blue-mid), inset 0 0 20px rgba(0,0,0,0.8);
    background: radial-gradient(circle, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    z-index: 5;
}

#minimap {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    z-index: 6;
    overflow: hidden;
}

.radar-label {
    position: absolute;
    bottom: -15px;
    width: 140%;
    left: -20%;
    text-align: center;
    font-family: var(--font-spira);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--ffx-cyan);
}

.map-dot {
    position: absolute;
    width: 6px; height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px currentColor;
}
.map-dot.home { background: var(--ffx-cyan); color: var(--ffx-cyan); }
.map-dot.away { background: #ff4444; color: #ff4444; }
.map-dot.ball { 
    background: #ff00cc;
    color: #ff00cc; 
    width: 12px; height: 12px;
    border: 2px solid #ffffff;
    z-index: 20;
    animation: blinkBall 0.3s infinite alternate;
    box-shadow: 0 0 6px #ff00cc;
}
.map-dot.nap { background: #333; color: #000; border: 1px solid #555; }
.map-dot.active-player { 
    background: #00ff00 !important; 
    color: #00ff00 !important; 
    box-shadow: 0 0 8px #00ff00;
    z-index: 15;
    transform: translate(-50%, -50%) scale(1.2);
}
.map-dot.ball-carrier {
    box-shadow: 0 0 15px #fff, 0 0 30px #ffaa00;
    border: 2px solid #ffffff;
    background-color: #ffaa00 !important;
    z-index: 100;
    width: 10px; height: 10px;
    animation: carrierPulse 0.8s infinite alternate;
}
@keyframes carrierPulse {
    from { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px #fff; opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 25px #ffcc00; opacity: 1.0; }
}
@keyframes blinkBall { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.5; transform: translate(-50%, -50%) scale(1.3); } }

/* --- ANNOUNCEMENTS --- */
#announcement {
    position: absolute;
    top: 40%; 
    left: 5%; 
    width: 90%;
    text-align: center;
    font-family: var(--font-data);
    font-size: clamp(40px, 12vw, 72px);
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.0;
    white-space: normal;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 40%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)) drop-shadow(3px 3px 0 #000);
    display: none;
    z-index: 2000;
    animation: announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    will-change: transform, opacity;
}

@keyframes announceSlide {
    from { transform: scale(0) rotate(-5deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
}

/* --- JOYSTICK (ETHEREAL INTERFACE) --- */
#joystick-hit-zone {
    position: absolute;
    bottom: 0; left: 0;
    width: 50%; height: 50%;
    z-index: 1000;
    background: rgba(0,0,0,0); 
    touch-action: none;
    pointer-events: auto;
}

#joystick-visual-container {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 140px; height: 140px;
    border-radius: 50%;
    /* Ethereal Ring */
    border: 1px dashed rgba(0, 242, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 242, 255, 0.1), inset 0 0 20px rgba(0, 242, 255, 0.05);
    background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0, 242, 255, 0.05) 100%);
    animation: etherealSpin 10s linear infinite;
}

#joystick-base::after {
    content: '';
    position: absolute;
    top: 10%; left: 10%; width: 80%; height: 80%;
    border-radius: 50%;
    border: 1px solid rgba(0, 242, 255, 0.1);
    animation: etherealSpin 5s linear infinite reverse;
}

@keyframes etherealSpin {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

#joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    /* Pyrefly Light */
    background: radial-gradient(circle at 30% 30%, #ffffff 0%, #a2f9ff 40%, #00f2ff 100%);
    box-shadow: 0 0 15px #00f2ff, 0 0 30px #00f2ff;
    transition: transform 0.05s linear;
    will-change: transform;
    opacity: 0.8;
}

#joystick-knob::after {
    content: "";
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.5);
    opacity: 0.5;
    animation: pulse-glow 2s infinite;
}

.touch-ripple {
    position: absolute;
    border-radius: 50%;
    border: 2px solid rgba(0, 242, 255, 0.5);
    background: transparent;
    transform: translate(-50%, -50%) scale(0);
    animation: rippleAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 9000;
    box-shadow: 0 0 10px var(--ffx-cyan);
    will-change: transform, opacity;
}

@keyframes rippleAnim {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 5px; }
    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; border-width: 0px; }
}

#camera-zone {
    position: absolute;
    top: 0; right: 0; width: 50%; height: 100%;
    pointer-events: auto;
    touch-action: none;
    z-index: 50;
}

/* --- ACTION BUTTON (SPHERE GRID NODE) --- */
#action-container {
    position: absolute;
    bottom: max(40px, env(safe-area-inset-bottom)); 
    right: max(40px, env(safe-area-inset-right));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
z-index: 1500;
}
.command-menu-bg {
    position: absolute;
    width: 220px; height: 100px;
    bottom: 20px;
    background: radial-gradient(ellipse at center, rgba(0, 20, 60, 0.8) 0%, transparent 70%);
    z-index: -1;
    pointer-events: none;
}

.command-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 140px; height: 140px;
    border-radius: 50%;
    border: 1px dashed rgba(0, 242, 255, 0.3);
    border-top: 2px solid var(--ffx-cyan);
    border-bottom: 2px solid var(--ffx-cyan);
    animation: spinReverse 20s linear infinite;
    pointer-events: none;
    box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
}
.command-ring::before {
    content: '';
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border-radius: 50%;
    border: 1px dotted rgba(255, 255, 255, 0.2);
    animation: spinReverse 10s linear infinite reverse;
}

@keyframes spinReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

#action-label {
    font-family: var(--font-spira);
    font-size: 14px;
    color: #fff;
    background: rgba(0, 0, 0, 0.6);
    padding: 4px 16px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 12px;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 3px;
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
    text-shadow: 0 0 5px var(--ffx-cyan);
    transition: all 0.3s;
    z-index: 20;
}

/* --- ACTION BUTTON (HERCULEAN SPHERE GRID NODE) --- */
/* --- ACTION BUTTON (HERCULEAN SPHERE GRID NODE) --- */
#action-button {
    position: absolute;
    top: 0; left: 0;
    width: 140px; height: 140px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    /* Deep Shadow & 3D Context */
    box-shadow: 
        0 30px 60px rgba(0, 0, 0, 0.9),
        0 0 0 2px rgba(0, 0, 0, 1.0);
    background: none;
    border: none;
    perspective: 1000px;
    transform-style: preserve-3d;
}

#action-button:active {
    transform: scale(0.95);
}

/* Keyframes for Living UI */
@keyframes ring-gyro-z {
    0% { transform: rotateZ(0deg); }
    100% { transform: rotateZ(360deg); }
}

@keyframes ring-wobble {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    25% { transform: rotateX(10deg) rotateY(5deg); }
    50% { transform: rotateX(0deg) rotateY(10deg); }
    75% { transform: rotateX(-10deg) rotateY(5deg); }
    100% { transform: rotateX(0deg) rotateY(0deg); }
}

@keyframes rune-spin-glow {
    0% { transform: rotate(0deg) scale(1); filter: drop-shadow(0 0 2px var(--ffx-cyan)); opacity: 0.8; }
    50% { transform: rotate(180deg) scale(1.05); filter: drop-shadow(0 0 8px var(--ffx-cyan-glow)); opacity: 1.0; }
    100% { transform: rotate(360deg) scale(1); filter: drop-shadow(0 0 2px var(--ffx-cyan)); opacity: 0.8; }
}

@keyframes liquid-surge-complex {
    0% { transform: scale(0.98); background-position: 0% 50%; border-radius: 50%; box-shadow: 0 0 30px #00aaff, inset 0 0 20px rgba(255, 255, 255, 0.5); }
    50% { transform: scale(1.02); background-position: 100% 50%; border-radius: 49%; box-shadow: 0 0 50px #00ffff, inset 0 0 40px rgba(255, 255, 255, 0.8); }
    100% { transform: scale(0.98); background-position: 0% 50%; border-radius: 50%; box-shadow: 0 0 30px #00aaff, inset 0 0 20px rgba(255, 255, 255, 0.5); }
}

@keyframes crystal-breathe {
    0%, 100% { border-color: rgba(0, 200, 255, 0.3); box-shadow: inset 0 0 20px #000000; }
    50% { border-color: rgba(0, 255, 255, 0.6); box-shadow: inset 0 0 30px #001133, 0 0 15px rgba(0, 255, 255, 0.2); }
}

/* Layer 1: Outer Ornate Ring (Metal/Gold) - The Gyro */
.ab-outer-ring {
    position: absolute;
    top: -8px; left: -8px; right: -8px; bottom: -8px;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        #b8860b, #ffd700, #fffacd, #ffd700, #b8860b, #8b4500, #b8860b
    );
    box-shadow: 
        inset 0 0 10px rgba(0,0,0,0.8),
        0 0 25px rgba(255, 215, 0, 0.3);
    z-index: 1;
    border: 1px solid #553300;
    /* Complex rotation */
    animation: ring-gyro-z 20s linear infinite;
}

/* Pseudo-element for 3D depth/wobble effect on the ring */
.ab-outer-ring::before {
    content: '';
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%;
    border: 2px dashed rgba(255, 215, 0, 0.5);
    animation: ring-wobble 8s ease-in-out infinite;
    pointer-events: none;
}

/* Layer 2: Rune Ring (Spinning) */
.ab-rune-ring {
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%;
    border: 2px dashed rgba(0, 255, 255, 0.6);
    /* box-shadow handled by animation */
    z-index: 2;
    animation: rune-spin-glow 15s linear infinite;
    pointer-events: none;
}

/* Layer 3: Inner Crystal Housing (Dark Glass) */
.ab-inner-crystal {
    position: absolute;
    top: 6px; left: 6px; right: 6px; bottom: 6px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, rgba(0, 10, 30, 0.95) 60%, #000000 100%);
    border: 2px solid rgba(0, 200, 255, 0.3);
    z-index: 3;
    overflow: hidden;
    pointer-events: none;
    animation: crystal-breathe 4s ease-in-out infinite;
}

/* Layer 4: Liquid Core (Animated Surface) */
.ab-liquid-core {
    position: absolute;
    top: 12px; left: 12px; right: 12px; bottom: 12px;
    border-radius: 50%;
    /* Complex Gradient for liquid motion */
    background: radial-gradient(circle at 40% 40%, #00ffff 0%, #0088ff 40%, #002266 100%);
    background-size: 150% 150%;
    z-index: 4;
    animation: liquid-surge-complex 3s ease-in-out infinite;
    pointer-events: none;
}

/* Liquid movement effect (Internal reflection) */
.ab-liquid-core::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.5) 0%, transparent 25%);
    animation: liquidMove 5s infinite ease-in-out;
    mix-blend-mode: overlay;
}

/* Layer 5: Limit Break Ring (Hidden by default) */
.limit-ring {
    position: absolute;
    top: -22px; left: -22px; right: -22px; bottom: -22px;
    border-radius: 50%;
    border: 4px solid transparent;
    border-top-color: #ff4400;
    border-bottom-color: #ffaa00;
    border-left-color: transparent;
    border-right-color: transparent;
    box-shadow: 0 0 40px #ff4400;
    z-index: 0;
    opacity: 0;
    animation: limitSpin 1.5s linear infinite;
    transition: opacity 0.5s;
    pointer-events: none;
}

@keyframes limitSpin {
    0% { transform: rotate(0deg) scale(1); filter: hue-rotate(0deg); }
    50% { transform: rotate(180deg) scale(1.1); filter: hue-rotate(15deg); }
    100% { transform: rotate(360deg) scale(1); filter: hue-rotate(0deg); }
}

/* Layer 6: Text Label */
#action-button .btn-text {
    font-family: var(--font-title);
    font-size: 28px;
    font-weight: 900;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 
        0 2px 0 #000,
        0 0 15px rgba(0, 255, 255, 1.0),
        0 0 30px #0088ff;
    z-index: 6;
    pointer-events: none;
    position: relative;
    top: 1px;
    animation: textFloat 3s ease-in-out infinite;
}

@keyframes textFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

/* Layer 7: Glare */
#action-button .btn-glare {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, transparent 45%, transparent 100%);
    z-index: 7;
    pointer-events: none;
    mix-blend-mode: soft-light;
}

/* STATE: SHOOT MODE (Orange/Red) */
#action-button.shoot-mode .ab-outer-ring {
    background: conic-gradient(
        from 0deg,
        #8b0000, #ff4400, #ffaa00, #ff4400, #8b0000, #440000, #8b0000
    );
    box-shadow: 0 0 50px rgba(255, 68, 0, 0.9);
    animation: ring-gyro-z 5s linear infinite; /* Faster spin */
}

#action-button.shoot-mode .ab-liquid-core {
    background: radial-gradient(circle at 40% 40%, #ffff00 0%, #ff4400 50%, #660000 100%);
    animation: corePulseRed 0.4s ease-in-out infinite alternate;
}

@keyframes corePulseRed {
    0% { transform: scale(0.95); box-shadow: 0 0 40px #ff4400; filter: brightness(1); }
    100% { transform: scale(1.08); box-shadow: 0 0 80px #ffaa00, 0 0 20px #fff; filter: brightness(1.3); }
}

#action-button.shoot-mode .btn-text {
    text-shadow: 0 2px 0 #000, 0 0 20px #ff4400;
}

/* STATE: LIMIT READY (Herculean Gold) */
#action-button.limit-ready .limit-ring {
    opacity: 1;
    border-width: 6px;
    border-top-color: #fff;
    border-bottom-color: #ffd700;
    box-shadow: 0 0 60px #ffaa00, inset 0 0 20px #ff4400;
    animation: limitSpin 0.8s linear infinite, limitPulse 0.3s ease-in-out infinite alternate;
    filter: drop-shadow(0 0 10px #ffffff);
}

@keyframes limitPulse {
    from { opacity: 0.8; box-shadow: 0 0 40px #ff4400, inset 0 0 20px #ffaa00; }
    to { opacity: 1.0; box-shadow: 0 0 80px #ffaa00, inset 0 0 40px #ffff00; }
}

#action-button.limit-ready .ab-outer-ring {
    background: conic-gradient(
        from 0deg,
        #ffd700, #ffffff, #ffaa00, #ffffff, #ffd700, #b8860b, #ffd700
    );
    box-shadow: 0 0 80px rgba(255, 215, 0, 0.8);
    animation: ring-gyro-z 2s linear infinite;
    border: 2px solid #ffffff;
}

#action-button.limit-ready .ab-rune-ring {
    border-color: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 40px #00ffff;
    animation: rune-spin-glow 3s linear infinite reverse;
}

#action-button.limit-ready .ab-liquid-core {
    background: radial-gradient(circle at 50% 50%, #ffffff 0%, #ffff00 20%, #ff8800 60%, #ff0000 100%);
    animation: liquid-surge-complex 0.5s ease-in-out infinite;
    filter: brightness(1.2);
}

#action-button.limit-ready .btn-text {
    color: #ffffff;
    text-shadow: 0 0 10px #ff0000, 0 0 20px #ffff00, 0 0 40px #ffffff;
    animation: textFloat 0.2s ease-in-out infinite alternate;
}

/* STATE: ACTIVE (Charging/Pressed) */
#action-button.active {
    transform: scale(0.95);
}

#action-button.active .ab-liquid-core {
    background: radial-gradient(circle at 50% 50%, #ffffff 40%, #ffffaa 70%, #ffaa00 100%);
    box-shadow: 0 0 80px #ffffff, inset 0 0 50px #ffffff;
    filter: brightness(2.0) contrast(1.2);
    animation: none; /* Solid intense light */
}

#action-button.active .ab-outer-ring {
    animation: ring-gyro-z 0.2s linear infinite; /* Hyper spin */
    filter: brightness(1.5);
    box-shadow: 0 0 100px #ffffff;
}

#action-button.active .limit-ring {
    border-color: #ffffff;
    box-shadow: 0 0 100px #ffffff;
    animation: limitSpin 0.1s linear infinite;
    opacity: 1;
}
/* --- AUTO TOGGLE --- */
#auto-toggle {
    position: absolute;
    top: max(200px, env(safe-area-inset-top) + 60px); 
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 10px 0;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--ffx-cyan);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 5, 10, 0.9) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 1px solid var(--ffx-cyan);
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
z-index: 1500;
}
#auto-toggle:hover {
    background: rgba(0, 40, 80, 0.9);
    box-shadow: 0 0 15px var(--ffx-cyan);
    color: white;
}
#auto-toggle.active {
    background: linear-gradient(135deg, rgba(100, 20, 0, 0.8) 0%, rgba(40, 0, 0, 0.9) 100%);
    border-color: #ff4400;
    color: #ffaa00;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff4400; } 100% { box-shadow: 0 0 5px #ff0000; } }

/* --- FLOATING TEXT --- */
.floating-text-wrapper {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    z-index: 2000;
    will-change: transform;
    contain: layout style;
}

.floating-text-inner {
    display: block;
    font-family: var(--font-data);
    font-weight: 900;
    text-transform: uppercase;
    white-space: nowrap;
    text-align: center;
    font-size: 24px; 
    text-shadow: 1px 1px 0 #000;
    opacity: 0.9;
}

.floating-text-inner.damage {
    font-size: 42px;
    font-style: italic;
    background: linear-gradient(to bottom, #ffffff 0%, #ffcc00 40%, #ff4400 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    animation: popDamage 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.floating-text-inner.heal {
    font-size: 36px;
    color: #44ff44;
    text-shadow: 0 0 10px #00ff00;
    animation: floatUp 1s ease-out forwards;
}

.floating-text-inner.venom {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #aaff00;
    text-shadow: 0 0 10px #448800, 2px 2px 0 #002200;
    background: linear-gradient(to bottom, #ccff66 0%, #66cc00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(100, 255, 0, 0.5));
    animation: dripStatus 2s infinite;
}

.floating-text-inner.sleep {
    font-family: var(--font-title);
    font-size: 42px;
    color: #ffffff;
    text-shadow: 0 0 15px #0044ff, 0 0 30px #0000ff;
    opacity: 0.9;
    animation: driftStatus 3s ease-in-out infinite;
}

.floating-text-inner.wither {
    font-family: var(--font-data);
    font-size: 38px;
    color: #cccccc;
    text-shadow: 2px 2px 0 #444444;
    background: linear-gradient(to bottom, #eeeeee 0%, #888888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.tech {
    font-family: var(--font-title);
    font-size: 32px;
    color: #00ffff;
    background: rgba(0, 10, 30, 0.7);
    padding: 2px 10px;
    border: 1px solid #00ffff;
    border-radius: 4px;
    box-shadow: 0 0 10px #0088ff;
    text-shadow: 0 0 5px #fff;
    animation: shakeTech 0.6s ease-in-out, flashTech 0.3s;
    transform-origin: center;
}

.floating-text-inner.save, .floating-text-inner.block {
    font-size: 48px;
    font-weight: 900;
    color: #ffffff;
    -webkit-text-stroke: 1px #004488;
    text-shadow: 0 0 20px #0088ff;
    animation: popDamage 0.5s ease-out forwards;
}

@keyframes popDamage {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.5); opacity: 1; }
    40% { transform: scale(1.0); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

@keyframes dripStatus {
    0% { transform: scaleY(1); filter: blur(0px); }
    50% { transform: scaleY(1.1) translateY(5px); filter: blur(1px); }
    100% { transform: scaleY(1); filter: blur(0px); }
}

@keyframes driftStatus {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    50% { transform: translateX(15px) translateY(-20px) rotate(10deg); }
    100% { transform: translateX(-15px) translateY(-50px) rotate(-10deg); opacity: 0; }
}

@keyframes witherStatus {
    0% { transform: scale(1); filter: grayscale(0%); opacity: 1; }
    100% { transform: scale(0.6); filter: grayscale(100%); opacity: 0; }
}

@keyframes shakeTech {
    0% { transform: scale(0.8); }
    10%, 30%, 50%, 70%, 90% { transform: scale(1.1) translate(-2px, 2px); }
    20%, 40%, 60%, 80% { transform: scale(1.1) translate(2px, -2px); }
    100% { transform: scale(1.0); }
}

@keyframes flashTech {
    0% { background-color: #fff; color: #000; border-color: #fff; }
    100% { background-color: rgba(0, 10, 30, 0.85); color: #00ffff; border-color: #00ffff; }
}

#loading {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 5px;
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0.5; } }

#controls-hint {
    position: absolute;
    top: 130px; width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    pointer-events: none;
}

.floating-text-inner.comic-impact {
    font-family: 'Impact', sans-serif;
    font-size: 42px;
    color: #ffff00; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 3px 3px 0 #ff0000;
    font-style: italic;
    transform-origin: center;
    white-space: nowrap;
    animation: comicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    z-index: 2500;
}

.floating-text-inner.comic-action {
    font-family: 'Arial Black', sans-serif;
    font-size: 28px;
    color: #00ffff; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 2px 2px 0 #0044aa;
    font-style: italic;
    white-space: nowrap;
    animation: comicSlide 0.4s ease-out forwards;
    z-index: 2500;
}

@keyframes comicPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    60% { transform: scale(1.0) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
}

@keyframes comicSlide {
    0% { transform: translate(-20px, 20px) scale(0.5); opacity: 0; }
    100% { transform: translate(20px, -20px) scale(1.2); opacity: 0; }
}

/* --- MAIN MENU --- */
/* --- MAIN MENU & END GAME (FFX STYLE) --- */
/* --- MAIN MENU (FAYTH INTERFACE) --- */
#main-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-end; /* Asymmetric Right Align */
    padding-right: 10%;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    
    /* Deep Void Background */
    background: radial-gradient(circle at 30% 50%, #051020 0%, #000000 100%);
    overflow: hidden;
}

#main-menu.active {
    opacity: 1;
    pointer-events: auto;
}

/* Scanlines & Vignette */
.menu-bg-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    background: 
        repeating-linear-gradient(
            0deg,
            transparent 0px,
            transparent 2px,
            rgba(0, 255, 255, 0.02) 3px,
            rgba(0, 255, 255, 0.02) 4px
        );
    pointer-events: none;
}
.menu-bg-overlay::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.8) 100%);
}

/* LOGO STYLING */
.ffx-logo-container {
    margin-bottom: 60px;
    text-align: right;
    transform: skewX(-10deg);
    position: relative;
    margin-right: 20px;
}

.ffx-logo-main {
    font-family: var(--font-title);
    font-size: clamp(60px, 12vw, 100px);
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 10px;
    line-height: 0.9;
    
    /* Crystal Gradient */
    background: linear-gradient(180deg, #ffffff 0%, #aaccff 45%, #0088ff 55%, #002266 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    filter: drop-shadow(0 0 20px rgba(0, 150, 255, 0.6));
    animation: logoFloat 4s ease-in-out infinite;
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 20px rgba(0, 150, 255, 0.6)); }
    50% { transform: translateY(-10px); filter: drop-shadow(0 0 30px rgba(0, 200, 255, 0.8)); }
}

.ffx-logo-sub {
    font-family: var(--font-spira);
    font-size: clamp(18px, 4vw, 32px);
    color: var(--ffx-gold);
    letter-spacing: 12px;
    margin-top: 5px;
    text-shadow: 0 0 10px #ffaa00;
    opacity: 0.9;
    text-align: right;
}

/* MENU OPTIONS (Asymmetric List) */
.menu-options {
    display: flex;
    flex-direction: column;
/* MENU OPTIONS (Asymmetric List) */
    width: 400px;
    align-items: flex-end; /* Align items to right */
}

.menu-item {
    position: relative;
    width: 100%;
    padding: 15px 40px 15px 20px;
    
    /* Glass Shard Look */
    background: linear-gradient(270deg, rgba(0, 40, 80, 0.8) 0%, rgba(0, 10, 20, 0.0) 100%);
    border-right: 3px solid rgba(100, 200, 255, 0.3);
    
    cursor: pointer;
/* Glass Shard Look */
    transform: skewX(-15deg);
    
    display: flex;
    justify-content: flex-end;
    align-items: center;
    overflow: visible;
}

.menu-item:hover {
    background: linear-gradient(270deg, rgba(0, 100, 200, 0.9) 0%, rgba(0, 20, 40, 0.2) 100%);
    border-right-color: #00ffff;
    padding-right: 60px; /* Slide left effect */
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
}

.menu-item .label {
    font-family: var(--font-title);
    font-size: 24px;
    color: #aaaaaa;
    letter-spacing: 4px;
    text-transform: uppercase;
    transform: skewX(15deg); /* Counter skew text */
    transition: color 0.2s, text-shadow 0.2s;
}

.menu-item:hover .label {
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0088ff;
}

/* PYREFLY CURSOR */
.menu-item .cursor {
    position: absolute;
    right: 15px;
    width: 12px; height: 12px;
    background: #ffd700;
    border-radius: 50%;
    opacity: 0;
    transform: skewX(15deg) scale(0);
    transition: all 0.3s;
    box-shadow: 
        0 0 10px #ffd700,
        0 0 20px #ffaa00,
        0 0 40px #ff4400;
    pointer-events: none;
}

.menu-item:hover .cursor {
    opacity: 1;
    right: 30px;
    transform: skewX(15deg) scale(1);
    animation: pyreflyWiggle 1s infinite ease-in-out;
}

@keyframes pyreflyWiggle {
    0%, 100% { transform: skewX(15deg) scale(1) translate(0, 0); }
    50% { transform: skewX(15deg) scale(1.2) translate(-2px, -2px); }
}

/* Particle trail for cursor (Pseudo element) */
.menu-item:hover .cursor::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background: inherit;
    opacity: 0.5;
    animation: pyreflyTrail 1s infinite;
}

@keyframes pyreflyTrail {
    0% { transform: scale(1); opacity: 0.5; }
    100% { transform: scale(2.5); opacity: 0; }
}

.menu-footer {
    position: absolute;
    bottom: 30px;
    right: 40px;
    font-family: var(--font-ui);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 4px;
    text-transform: uppercase;
    text-align: right;
}
/* END GAME SPECIFIC */
#end-game-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    background: rgba(0, 5, 15, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

#end-game-menu.active {
    opacity: 1;
    pointer-events: auto;
}

.result-header {
    text-align: center;
    margin-bottom: 40px;
    transform: skewX(-10deg);
}

.result-title {
    font-family: var(--font-title);
    font-size: 72px;
    color: #fff;
    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
    letter-spacing: 5px;
    line-height: 1.0;
}

.result-subtitle {
    font-family: var(--font-spira);
    font-size: 18px;
    color: var(--ffx-gold);
    letter-spacing: 8px;
    margin-top: 5px;
}

.final-score-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    margin-bottom: 50px;
    background: linear-gradient(90deg, transparent, rgba(0, 20, 50, 0.8), transparent);
    padding: 20px 0;
    width: 100%;
}

.final-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 120px;
}

.final-score-digit {
    font-family: var(--font-data);
    font-size: 80px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    line-height: 1.0;
}

.final-team.home .final-score-digit { color: #00ffff; text-shadow: 0 0 20px #00ffff; }
.final-team.away .final-score-digit { color: #ff4444; text-shadow: 0 0 20px #ff4444; }

.final-team-name {
    font-family: var(--font-title);
    font-size: 14px;
    color: #aaa;
    letter-spacing: 2px;
    margin-top: 5px;
}

.final-vs {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.6;
}

.final-vs span {
    font-family: var(--font-spira);
    font-size: 24px;
    color: var(--ffx-gold);
    margin: 5px 0;
}

.vs-line {
    width: 2px; height: 30px;
    background: linear-gradient(to bottom, transparent, var(--ffx-gold), transparent);
}
/* --- PRACTICE OVERLAY --- */
/* --- PRACTICE OVERLAY (SPHERE POOL TERMINAL) --- */
#practice-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 5, 10, 0.4);
    backdrop-filter: blur(2px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    pointer-events: none;
}

#practice-overlay.active {
    display: flex;
}

.practice-panel {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    width: 300px;
    
    /* Holographic Glass */
    background: linear-gradient(160deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 10, 20, 0.95) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    
    /* Tech Shape */
    clip-path: polygon(
        20px 0, 100% 0, 
        100% calc(100% - 20px), calc(100% - 20px) 100%, 
        0 100%, 0 20px
    );
    
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-left: 2px solid var(--ffx-cyan);
    
    box-shadow: 
        0 0 30px rgba(0, 100, 255, 0.2),
        inset 0 0 50px rgba(0, 20, 60, 0.5);
        
    padding: 20px;
    pointer-events: auto;
    
    /* Grid Pattern Overlay */
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
    
    animation: panelFloat 4s ease-in-out infinite;
}

@keyframes panelFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.panel-header {
    margin-bottom: 20px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    padding-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.panel-title-group {
    display: flex;
    flex-direction: column;
}

.panel-title {
    font-family: var(--font-title);
    font-size: 22px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    letter-spacing: 2px;
}

.panel-subtitle {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-cyan);
    letter-spacing: 2px;
    opacity: 0.8;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.section-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-gold);
    margin-bottom: 8px;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-shadow: 0 0 5px rgba(255, 200, 0, 0.5);
}

.drill-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.drill-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    background: rgba(0, 20, 40, 0.6);
    border: 1px solid rgba(0, 255, 255, 0.1);
    cursor: pointer;
    font-family: var(--font-data);
    font-size: 11px;
    color: #88aacc;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.drill-btn:hover {
    background: rgba(0, 40, 80, 0.8);
    border-color: var(--ffx-cyan);
    color: #fff;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
}

.drill-btn.active {
    background: linear-gradient(135deg, rgba(0, 100, 200, 0.8) 0%, rgba(0, 40, 80, 0.8) 100%);
    border-color: #00ffff;
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3);
}

.drill-btn .icon {
    display: none; /* Hide icons for cleaner grid */
}

.option-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-toggle {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    font-size: 12px;
    color: #aaa;
    transition: all 0.2s;
}

.option-toggle:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
}

.option-toggle.active {
    border-color: #00ff00;
    color: #fff;
    background: rgba(0, 50, 0, 0.3);
    box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
}

.option-toggle .checkbox {
    margin-right: 10px;
    color: inherit;
    font-family: monospace;
}

.action-btn {
    text-align: center;
    background: linear-gradient(90deg, rgba(50, 0, 0, 0.6), rgba(20, 0, 0, 0.8));
    border: 1px solid #ff4444;
    padding: 8px;
    font-size: 12px;
    color: #ffaaaa;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: var(--font-title);
}

.action-btn:hover {
    background: #ff4444;
    color: #fff;
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
}

#p-reset-ball {
    background: linear-gradient(90deg, rgba(0, 50, 100, 0.6), rgba(0, 20, 40, 0.8));
    border-color: #00ffff;
    color: #00ffff;
}
#p-reset-ball:hover {
    background: #00ffff;
    color: #000;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

.panel-footer {
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

#offscreen-indicator {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    display: none;
    z-index: 1000;
    pointer-events: none;
}
#offscreen-indicator .arrow {
    width: 0; 
    height: 0; 
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 15px solid #00ffff;
    filter: drop-shadow(0 0 5px #00ffff);
}

#drill-instruction {
    font-size: 11px;
    color: #88aacc;
    margin-bottom: 8px;
    font-style: italic;
    font-family: var(--font-ui);
}

#drill-score {
    font-family: var(--font-data);
    font-size: 32px;
    color: var(--ffx-gold);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    letter-spacing: 2px;
}

.panel-minimize-btn {
    width: 24px; height: 24px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 22px;
    cursor: pointer;
    font-size: 16px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 10px var(--ffx-cyan);
}
.panel-minimize-btn {
    position: absolute;
    top: 10px; right: 10px;
    width: 20px; height: 20px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 14px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 5px var(--ffx-cyan);
}

#practice-restore-btn {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    padding: 8px 15px;
    background: linear-gradient(90deg, rgba(0, 20, 50, 0.9) 0%, rgba(0, 10, 20, 0.9) 100%);
    border: 1px solid var(--ffx-cyan);
    border-left: 3px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    font-family: var(--font-data);
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    z-index: 2400;
    display: none;
    pointer-events: auto;
    transform: skewX(-10deg);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.2);
    text-transform: uppercase;
}
#practice-restore-btn:hover {
    background: rgba(0, 40, 80, 0.9);
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

/* --- AIM JOYSTICK --- */
#aim-joystick-zone {
    position: absolute;
    bottom: max(150px, env(safe-area-inset-bottom));
    right: 0;
    width: 40%;
    height: 35%;
    z-index: 1000;
    background: rgba(0,0,0,0);
    touch-action: none;
    pointer-events: auto;
}

#aim-joystick-visual {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#aim-joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100px; height: 100px;
    border-radius: 50%;
    /* Ethereal Orange Ring */
    border: 1px dashed rgba(255, 150, 50, 0.4);
    box-shadow: 0 0 15px rgba(255, 100, 0, 0.2), inset 0 0 20px rgba(255, 50, 0, 0.1);
    background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(255, 100, 0, 0.05) 100%);
    animation: etherealSpin 12s linear infinite reverse;
}

#aim-joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 30px; height: 30px;
    border-radius: 50%;
    /* Firefly Light */
    background: radial-gradient(circle at 30% 30%, #fff 0%, #ffaa00 40%, #ff4400 100%);
    box-shadow: 0 0 15px #ff6600;
    transition: transform 0.05s linear;
    will-change: transform;
}

#aim-joystick-knob::after {
    content: "AIM";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8px;
    color: white;
    font-family: var(--font-data);
    text-shadow: 0 0 3px #000;
    opacity: 0.8;
}
/* --- TACKLE BUTTON --- */
#tackle-button {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 100px);
    right: max(40px, env(safe-area-inset-right));
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
z-index: 1500;
    border: 3px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.6), inset 0 0 15px rgba(255, 200, 200, 0.3);
    transition: transform 0.1s, filter 0.2s;
}

#tackle-button:active {
    transform: scale(0.9);
    filter: brightness(1.2);
}

#tackle-button.active {
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ff4444 40%, #aa0000 80%, #440000 100%);
    box-shadow: 0 0 25px rgba(255, 100, 100, 0.9);
}

#tackle-button .btn-text {
    font-family: var(--font-data);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#tackle-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
    pointer-events: none;
    border-radius: 50%;
    animation: glarePass 4s infinite;
}

#tackle-button.urgent {
    animation: urgentPulse 0.5s infinite alternate;
    background: radial-gradient(circle at 35% 35%, #ff5555 0%, #ff0000 40%, #880000 100%);
    border-color: #ffaaaa;
    box-shadow: 0 0 20px #ff0000;
}

@keyframes urgentPulse {
    from { transform: scale(1.0); }
    to { transform: scale(1.15); }
}

/* --- CHARGE POWER METER --- */
#charge-meter-container {
    position: absolute;
    bottom: max(250px, env(safe-area-inset-bottom) + 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 2000;
    background: rgba(0, 10, 30, 0.8);
    padding: 10px 15px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
}

.charge-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.charge-meter-track {
    width: 100%;
    height: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
}

#charge-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0af, #0f0);
    box-shadow: 0 0 10px #0f0;
    transition: width 0.05s linear, background 0.1s;
    border-radius: 5px;
}

.charge-hint {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    margin-top: 5px;
    opacity: 0.8;
    animation: blink 0.5s infinite;
}

/* --- GOAL DISTANCE INDICATOR --- */
#goal-distance-container {
    position: absolute;
    top: max(75px, env(safe-area-inset-top) + 55px);
    left: max(20px, env(safe-area-inset-left));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 100;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.7) 0%, transparent 100%);
    padding: 5px 15px 5px 10px;
    border-left: 2px solid var(--ffx-gold);
}

.distance-label {
    font-family: var(--font-spira);
    font-size: 8px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#goal-distance {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-gold);
}

/* --- SETTINGS BUTTON --- */
#settings-button {
    position: absolute;
    top: max(240px, env(safe-area-inset-top) + 100px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 8px 0;
    text-align: center;
    font-size: 10px;
    font-weight: bold;
    color: #888;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
z-index: 1500;
}
#settings-button:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: #888;
    color: #fff;
}

/* --- SETTINGS PANEL --- */
#settings-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.98) 0%, rgba(0, 10, 20, 0.99) 100%);
    border: 2px solid var(--ffx-cyan);
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(0, 100, 255, 0.4);
    z-index: 3500;
    pointer-events: auto;
    backdrop-filter: blur(10px);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(100, 200, 255, 0.3);
    background: rgba(0, 30, 60, 0.5);
}

.settings-header span {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-cyan);
    letter-spacing: 3px;
}

#settings-close {
    width: 30px;
    height: 30px;
    border: 1px solid #ff4444;
    background: rgba(50, 0, 0, 0.5);
    color: #ff4444;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
}

#settings-close:hover {
    background: #ff4444;
    color: white;
}

.settings-content {
    padding: 20px;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.setting-row label {
    font-family: var(--font-data);
    font-size: 14px;
    color: #ccc;
}

.setting-row input[type="range"] {
    width: 100px;
    accent-color: var(--ffx-cyan);
}

.setting-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--ffx-cyan);
    cursor: pointer;
}

/* --- GLARE ANIMATION --- */
@keyframes glarePass {
    0% { transform: translateX(-100%) rotate(45deg); }
    30% { transform: translateX(100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* --- STATUS TYPE FLOATING TEXT --- */
.floating-text-inner.status {
    font-family: var(--font-data);
    font-size: 28px;
    font-style: italic;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 2px 2px 0 #000;
    animation: statusPop 1.2s ease-out forwards;
}

@keyframes statusPop {
    0% { transform: scale(0.5) translateY(0); opacity: 0; }
    20% { transform: scale(1.3) translateY(-10px); opacity: 1; }
    100% { transform: scale(1.0) translateY(-40px); opacity: 0; }
}

.floating-text-inner.blind {
    font-family: var(--font-data);
    font-size: 32px;
    color: #333333;
    text-shadow: 0 0 10px #000000, 2px 2px 0 #111;
    background: linear-gradient(to bottom, #666 0%, #000 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 2s forwards;
}

.floating-text-inner.silence {
    font-family: var(--font-title);
    font-size: 32px;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff;
    opacity: 0.9;
    animation: shakeTech 0.5s ease-in-out;
}

.floating-text-inner.shield {
    font-family: var(--font-data);
    font-size: 36px;
    color: #00ffff;
    text-shadow: 0 0 15px #00ffff;
    border: 2px solid #00ffff;
    border-radius: 50%;
    padding: 5px 10px;
    background: rgba(0, 50, 100, 0.5);
    animation: popDamage 0.5s ease-out forwards;
}

.floating-text-inner.haste {
    font-family: var(--font-data);
    font-size: 36px;
    font-style: italic;
    color: #ffff00;
    text-shadow: 2px 2px 0 #ff8800;
    animation: floatUp 0.5s ease-out forwards;
}

.floating-text-inner.slow {
    font-family: var(--font-data);
    font-size: 36px;
    font-weight: 900;
    color: #885522;
    text-shadow: 2px 2px 0 #000;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.burn {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #ff4400;
    text-shadow: 0 0 10px #ff0000, 2px 2px 0 #440000;
    background: linear-gradient(to bottom, #ffff00 0%, #ff0000 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: burnStatus 1.5s infinite;
}

.floating-text-inner.freeze {
    font-family: var(--font-title);
    font-size: 42px;
    color: #aaddff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0088ff;
    animation: freezeStatus 2.0s forwards;
}

.floating-text-inner.shock {
    font-family: var(--font-data);
    font-size: 42px;
    font-weight: 900;
    color: #ffff00;
    text-shadow: 0 0 10px #ffff00, 2px 2px 0 #880088;
    animation: shockStatus 0.1s infinite alternate;
}

@keyframes burnStatus {
    0% { transform: scale(1) skewX(0deg); filter: brightness(1); }
    50% { transform: scale(1.1) skewX(-5deg); filter: brightness(1.5); }
    100% { transform: scale(1) skewX(0deg); filter: brightness(1); }
}

@keyframes freezeStatus {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; filter: brightness(2); }
}

@keyframes shockStatus {
    0% { transform: translate(2px, 0); }
100% { transform: translate(-2px, 0); }
}

/* --- GOAL TYPE FLOATING TEXT --- */
.floating-text-inner.goal {
    font-family: var(--font-data);
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #ff8800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.9));
    animation: goalPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes goalPop {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    100% { transform: scale(1.2) rotate(0deg); opacity: 0; }
}

/* --- DEFAULT TYPE FLOATING TEXT --- */
.floating-text-inner.default {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    animation: floatUp 0.8s ease-out forwards;
}

/* --- MOBILE PORTRAIT OPTIMIZATIONS --- */
/* --- MOBILE & RESPONSIVE OPTIMIZATIONS --- */

/* 1. Compact Landscape (Mobile Horizontal) */
@media screen and (max-height: 600px) and (orientation: landscape) {
    #hud-top {
        height: 100px;
        padding: 5px 40px; /* More side padding to clear notches */
    }

    .sb-wing {
        width: 220px;
        height: 70px;
    }

    .sb-wing.home .sb-wing-bg { transform: skewX(-15deg); }
    .sb-wing.away .sb-wing-bg { transform: skewX(15deg); }

    .sb-team-name { font-size: 18px; }
    .sb-team-sub { font-size: 8px; letter-spacing: 2px; }
    .sb-score { font-size: 48px; }
    
    .sb-chronosphere {
        width: 100px; height: 100px;
    }
    .chrono-core { width: 70px; height: 70px; }
    .chrono-ring.outer { width: 90px; height: 90px; }
    .chrono-ring.mid { width: 80px; height: 80px; }
    .chrono-ring.inner { width: 60px; height: 60px; }
    
    #timer-display { font-size: 24px; }
    
    /* Adjust controls for landscape */
    #action-container { bottom: 20px; right: 20px; transform: scale(0.8); transform-origin: bottom right; }
    #joystick-hit-zone { width: 40%; }
    
    #player-status-panel {
        bottom: 20px; left: 20px;
        transform: scale(0.8) skewX(-10deg); transform-origin: bottom left;
    }
}

/* 2. Portrait Mode (Mobile Vertical) */
@media screen and (orientation: portrait) {
    #hud-top {
        height: 140px;
        padding: max(10px, env(safe-area-inset-top)) 10px 0 10px;
        align-items: flex-start;
        gap: 5px;
    }

    /* Wings become top bars */
    .sb-wing {
        width: auto;
        flex: 1;
        height: 80px;
        margin: 0;
        background: none; /* Remove default bg container */
    }

    /* Custom BG for Portrait Wings */
    .sb-wing-bg {
        transform: skewX(0deg) !important; /* Remove skew */
        border-radius: 0 0 10px 10px;
        border-top: none;
        background: linear-gradient(180deg, rgba(0, 20, 40, 0.95) 0%, rgba(0, 10, 20, 0.8) 100%);
    }
    .sb-wing.home .sb-wing-bg { 
        border-left: none; 
        border-bottom: 2px solid var(--ffx-cyan);
        clip-path: polygon(0 0, 100% 0, 100% 80%, 85% 100%, 0 100%);
    }
    .sb-wing.away .sb-wing-bg { 
        border-right: none; 
        border-bottom: 2px solid #ff4444;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 15% 100%, 0 80%);
    }

    .sb-content-container {
        transform: skewX(0deg) !important;
        padding: 5px;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .sb-wing.home .sb-content-container { align-items: flex-start; padding-left: 15px; }
    .sb-wing.away .sb-content-container { align-items: flex-end; padding-right: 15px; }

    .sb-team-info {
        order: 2;
        text-align: left;
    }
    .sb-wing.away .sb-team-info { text-align: right; }

    .sb-team-name { font-size: 14px; letter-spacing: 1px; }
    .sb-team-sub { display: none; }

    .sb-score-wrapper {
        order: 1;
        width: 100%;
        height: 40px;
        justify-content: flex-start;
    }
    .sb-wing.away .sb-score-wrapper { justify-content: flex-end; }

    .sb-score {
        font-size: 48px;
        margin: 0 !important;
        line-height: 0.8;
    }

    .sb-crystal-deco { display: none; }
    .sb-energy-conduit { display: none; }

    /* Chronosphere Compact */
    .sb-chronosphere {
        width: 90px; height: 90px;
        margin-top: 5px;
        z-index: 1200;
    }
    .chrono-core { width: 70px; height: 70px; background: rgba(0, 10, 20, 0.95); }
    .chrono-ring.outer { width: 85px; height: 85px; opacity: 0.4; }
    .chrono-ring.mid { display: none; } /* Simplify */
    .chrono-ring.inner { width: 60px; height: 60px; }
    
    #timer-display { font-size: 20px; }
    #half-indicator { font-size: 10px; margin-bottom: 0; }

    /* UI Repositioning for Portrait */
    #minimap-container {
        top: max(160px, env(safe-area-inset-top) + 140px);
        right: 10px;
        transform: scale(0.8); transform-origin: top right;
    }
    
    #goal-distance-container {
        top: max(160px, env(safe-area-inset-top) + 140px);
        left: 10px;
    }

    #player-status-panel {
        bottom: max(180px, env(safe-area-inset-bottom) + 100px);
        left: 10px;
        width: 160px;
        transform: skewX(0deg); /* Remove skew for readability on narrow screens */
    }
    .char-name, .hp-gauge-container, .tech-gauge-container { transform: skewX(0deg); }

    /* Controls */
    #action-container {
        bottom: max(40px, env(safe-area-inset-bottom));
        right: max(20px, env(safe-area-inset-right));
        transform: scale(0.9); transform-origin: bottom right;
    }
    
    #tackle-button {
        bottom: max(60px, env(safe-area-inset-bottom));
        right: max(140px, env(safe-area-inset-right));
    }

    #joystick-hit-zone {
        height: 40%;
        bottom: 0;
    }
    
    /* Settings & Auto Buttons */
    #auto-toggle {
        top: max(220px, env(safe-area-inset-top) + 200px);
        right: 10px;
        width: 90px;
    }
    #settings-button {
        top: max(260px, env(safe-area-inset-top) + 240px);
        right: 10px;
        width: 90px;
    }
    #practice-restore-btn {
        top: max(220px, env(safe-area-inset-top) + 200px);
        right: 10px;
        width: 90px;
    }

    /* Menus */
    .menu-options { width: 100%; padding-right: 20px; }
    .ffx-logo-main { font-size: 60px; }
    
    /* Settings */
    #settings-panel { width: 90%; }
    
    /* Practice */
    .practice-panel { width: 95%; right: 2.5%; top: 120px; }
    
    /* Announcements */
    #announcement {
        font-size: 48px;
        top: 35%;
    }
    .announcement-slam {
        font-size: 64px !important;
    }
}</style>

    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
    <!-- Lil-GUI -->
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
<script type="importmap">{"imports":{"style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAoSEVSQ1VMRUFOIFNDT1JFQk9BUkQpIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDE2MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4Owp9CgovKiAtLS0gV0lOR1MgKFRlYW0gUGFuZWxzKSAtLS0gKi8KLnNiLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDM1MHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKLnNiLXdpbmcuaG9tZSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICBtYXJnaW4tbGVmdDogMjBweDsKfQoKLnNiLXdpbmcuYXdheSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBCYWNrZ3JvdW5kIFNoYXBlICovCi5zYi13aW5nLWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHotaW5kZXg6IDA7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgOTAlIDEwMCUsIDAgMTAwJSk7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgyMGRlZyk7CiAgICBib3JkZXItcmlnaHQ6IDRweCBzb2xpZCAjZmY0NDQ0OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCA2OCwgNjgsIDAuMyk7CiAgICBjbGlwLXBhdGg6IHBvbHlnb24oMTAlIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAwIDEwMCUpOwp9CgovKiBDb250ZW50IENvbnRhaW5lciAoQ291bnRlci1za2V3KSAqLwouc2ItY29udGVudC1jb250YWluZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwYWRkaW5nOiAwIDMwcHg7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1zdGFydDsKfQoKLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1lbmQ7Cn0KCi8qIFRlYW0gSW5mbyAqLwouc2ItdGVhbS1pbmZvIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXRlYW0taW5mbyB7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQoKLnNiLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LDI1NSwyNTUsMC41KTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5zYi10ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi10b3A6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIFNjb3JlIFdyYXBwZXIgKi8KLnNiLXNjb3JlLXdyYXBwZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnNiLXNjb3JlIHsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiAyOwp9Cgouc2Itd2luZy5ob21lIC5zYi1zY29yZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjMDBmZmZmIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDAgcmdiYSgwLDAsMCwwLjUpKSBkcm9wLXNoYWRvdygwIDAgMTVweCB2YXIoLS1mZngtY3lhbikpOwogICAgbWFyZ2luLWxlZnQ6IDIwcHg7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXNjb3JlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNmZmZmZmYgMCUsICNmZjQ0NDQgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggMCByZ2JhKDAsMCwwLDAuNSkpIGRyb3Atc2hhZG93KDAgMCAxNXB4ICNmZjQ0NDQpOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBTY29yZSBVcGRhdGUgQW5pbWF0aW9uICovCi5zYi1zY29yZS5zY29yZS11cGRhdGUgewogICAgYW5pbWF0aW9uOiBzY29yZVBvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKfQoKQGtleWZyYW1lcyBzY29yZVBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgZmlsdGVyOiBicmlnaHRuZXNzKDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQp9CgovKiBDcnlzdGFsIERlY28gKi8KLnNiLWNyeXN0YWwtZGVjbyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7CiAgICB3aWR0aDogNDBweDsKICAgIGhlaWdodDogNDBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSAwJSwgcmdiYSgwLDAsMCwwKSA3MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICB6LWluZGV4OiAzOwogICAgYW5pbWF0aW9uOiBwdWxzZS1nbG93IDNzIGluZmluaXRlOwp9Ci5zYi13aW5nLmhvbWUgLnNiLWNyeXN0YWwtZGVjbyB7IGxlZnQ6IC0xMHB4OyB9Ci5zYi13aW5nLmF3YXkgLnNiLWNyeXN0YWwtZGVjbyB7IHJpZ2h0OiAtMTBweDsgfQoKLyogRW5lcmd5IENvbmR1aXQgKEJhciBhdCBib3R0b20pICovCi5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7CiAgICBoZWlnaHQ6IDRweDsKICAgIHdpZHRoOiA4MCU7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggY3VycmVudENvbG9yOwogICAgei1pbmRleDogMjsKfQouc2Itd2luZy5ob21lIC5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBsZWZ0OiAwOwogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwp9Ci5zYi13aW5nLmF3YXkgLnNiLWVuZXJneS1jb25kdWl0IHsKICAgIHJpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOwp9CgovKiAtLS0gQ0hST05PU1BIRVJFIChDZW50ZXIgVGltZXIpIC0tLSAqLwouc2ItY2hyb25vc3BoZXJlIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogMTQwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLXRvcDogMTBweDsKfQoKLmNocm9uby1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDMwLCA2MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpOwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgouY2hyb25vLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hyb25vLXJpbmcub3V0ZXIgewogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggZGFzaGVkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblNsb3cgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmNocm9uby1yaW5nLm1pZCB7CiAgICB3aWR0aDogMTE1cHg7IGhlaWdodDogMTE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmlnaHQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBhbmltYXRpb246IHNwaW5TbG93IDE1cyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKLmNocm9uby1yaW5nLmlubmVyIHsKICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICBib3JkZXI6IDFweCBkb3R0ZWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOwogICAgYW5pbWF0aW9uOiBzcGluU2xvdyAxMHMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHNwaW5TbG93IHsgdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9IH0KCi5jaHJvbm8tZ2VtIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZiwgMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgei1pbmRleDogMTU7Cn0KLmNocm9uby1nZW0udG9wIHsgdG9wOiAwOyB9Ci5jaHJvbm8tZ2VtLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgojdGltZXItZGlzcGxheSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LXdlaWdodDogYm9sZDsKfQoKLyogLS0tIE1PQklMRSBBREpVU1RNRU5UUyBGT1IgSEVSQ1VMRUFOIEhVRCAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEyMHB4OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgIH0KCiAgICAuc2Itd2luZyB7CiAgICAgICAgd2lkdGg6IDEzMHB4OwogICAgICAgIGhlaWdodDogNzBweDsKICAgIH0KICAgIAogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTBkZWcpOyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQoKICAgIC5zYi10ZWFtLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIC5zYi10ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnNiLXNjb3JlIHsgZm9udC1zaXplOiA0MnB4OyB9CiAgICAuc2Itc2NvcmUtd3JhcHBlciB7IHdpZHRoOiA1MHB4OyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLXNjb3JlIHsgbWFyZ2luLWxlZnQ6IDVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itc2NvcmUgeyBtYXJnaW4tcmlnaHQ6IDVweDsgfQoKICAgIC5zYi1jaHJvbm9zcGhlcmUgewogICAgICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IH0KICAgIC5jaHJvbm8tcmluZy5vdXRlciB7IHdpZHRoOiA4NXB4OyBoZWlnaHQ6IDg1cHg7IH0KICAgIC5jaHJvbm8tcmluZy5taWQgeyB3aWR0aDogNzhweDsgaGVpZ2h0OiA3OHB4OyB9CiAgICAuY2hyb25vLXJpbmcuaW5uZXIgeyB3aWR0aDogNjVweDsgaGVpZ2h0OiA2NXB4OyB9CiAgICAKICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyMHB4OyB9CiAgICAjaGFsZi1pbmRpY2F0b3IgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIAogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KfQovKiAtLS0gUExBWUVSIFNUQVRVUyBQQU5FTCAoTElRVUlEIExJR0hUKSAtLS0gKi8KI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDQwcHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgd2lkdGg6IDIwMHB4OwogICAgcGFkZGluZzogMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjg1KSAwJSwgcmdiYSgwLCAyMCwgNDAsIDAuNikgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMik7CiAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDAgMTVweCAwIDE1cHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIE1hbmFnZWQgYnkgSlMgKi8KICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi8qIERlY29yYXRpdmUgYmFja2dyb3VuZCBzaGFyZCAqLwojcGxheWVyLXN0YXR1cy1wYW5lbDo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOyB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0NSUsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMykgNTAlLCB0cmFuc3BhcmVudCA1NSUpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDZzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Cn0KCi5ocC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA2cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQouaHAtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogOHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzMzNDQ1NTsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDVweCByZ2JhKDAsMCwwLDAuOCk7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMDBhYTQ0LCAjNDRmZjg4LCAjMDBhYTQ0KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDNzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmNDQ7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwp9Ci5ocC12YWx1ZSB7IAogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7IAogICAgY29sb3I6ICNmZmY7IAogICAgd2lkdGg6IDU1cHg7IAogICAgdGV4dC1hbGlnbjogcmlnaHQ7IAogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoudGVjaC1iYXItdHJhY2sgewogICAgZmxleC1ncm93OiAxOwogICAgaGVpZ2h0OiA0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQzMzIyOwogICAgbWFyZ2luOiAwIDhweDsKICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjYWE2NjAwLCAjZmZjYzAwLCAjYWE2NjAwKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDRzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKQGtleWZyYW1lcyBsaXF1aWRGbG93IHsKICAgIDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSAwOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogLTEwMCUgMDsgfQp9Ci8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgKEVUSEVSRUFMIElOVEVSRkFDRSkgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTQwcHg7IGhlaWdodDogMTQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBFdGhlcmVhbCBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLDAsMCwwKSA2MCUsIHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpIDEwMCUpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gMTBzIGxpbmVhciBpbmZpbml0ZTsKfQoKI2pveXN0aWNrLWJhc2U6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMCU7IGxlZnQ6IDEwJTsgd2lkdGg6IDgwJTsgaGVpZ2h0OiA4MCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gNXMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCkBrZXlmcmFtZXMgZXRoZXJlYWxTcGluIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0KfQoKI2pveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIFB5cmVmbHkgTGlnaHQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmZmZmZiAwJSwgI2EyZjlmZiA0MCUsICMwMGYyZmYgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmMmZmLCAwIDAgMzBweCAjMDBmMmZmOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07CiAgICBvcGFjaXR5OiAwLjg7Cn0KCiNqb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHVsc2UtZ2xvdyAycyBpbmZpbml0ZTsKfQoKLnRvdWNoLXJpcHBsZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjUpOwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsKICAgIGFuaW1hdGlvbjogcmlwcGxlQW5pbSAwLjZzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IGJvcmRlci13aWR0aDogNXB4OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgYm9yZGVyLXdpZHRoOiAwcHg7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp6LWluZGV4OiAxNTAwOwp9Ci5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDIyMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm90dG9tOiAyMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgY2VudGVyLCByZ2JhKDAsIDIwLCA2MCwgMC44KSAwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHotaW5kZXg6IC0xOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKfQouY29tbWFuZC1yaW5nOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0xMHB4OyBsZWZ0OiAtMTBweDsgcmlnaHQ6IC0xMHB4OyBib3R0b206IC0xMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZG90dGVkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4yKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTBzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBwYWRkaW5nOiA0cHggMTZweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICB6LWluZGV4OiAyMDsKfQoKLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDEwOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgLyogRGVlcCBTaGFkb3cgJiAzRCBDb250ZXh0ICovCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDMwcHggNjBweCByZ2JhKDAsIDAsIDAsIDAuOSksCiAgICAgICAgMCAwIDAgMnB4IHJnYmEoMCwgMCwgMCwgMS4wKTsKICAgIGJhY2tncm91bmQ6IG5vbmU7CiAgICBib3JkZXI6IG5vbmU7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4OwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKI2FjdGlvbi1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCi8qIEtleWZyYW1lcyBmb3IgTGl2aW5nIFVJICovCkBrZXlmcmFtZXMgcmluZy1neXJvLXogewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMzYwZGVnKTsgfQp9CgpAa2V5ZnJhbWVzIHJpbmctd29iYmxlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogcm90YXRlWCgxMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMTBkZWcpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoLTEwZGVnKSByb3RhdGVZKDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KfQoKQGtleWZyYW1lcyBydW5lLXNwaW4tZ2xvdyB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMDUpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdykpOyBvcGFjaXR5OiAxLjA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9Cn0KCkBrZXlmcmFtZXMgbGlxdWlkLXN1cmdlLWNvbXBsZXggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAxMDAlIDUwJTsgYm9yZGVyLXJhZGl1czogNDklOyBib3gtc2hhZG93OiAwIDAgNTBweCAjMDBmZmZmLCBpbnNldCAwIDAgNDBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9Cn0KCkBrZXlmcmFtZXMgY3J5c3RhbC1icmVhdGhlIHsKICAgIDAlLCAxMDAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMjBweCAjMDAwMDAwOyB9CiAgICA1MCUgeyBib3JkZXItY29sb3I6IHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7IGJveC1zaGFkb3c6IGluc2V0IDAgMCAzMHB4ICMwMDExMzMsIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7IH0KfQoKLyogTGF5ZXIgMTogT3V0ZXIgT3JuYXRlIFJpbmcgKE1ldGFsL0dvbGQpIC0gVGhlIEd5cm8gKi8KLmFiLW91dGVyLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtOHB4OyBsZWZ0OiAtOHB4OyByaWdodDogLThweDsgYm90dG9tOiAtOHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNiODg2MGIsICNmZmQ3MDAsICNmZmZhY2QsICNmZmQ3MDAsICNiODg2MGIsICM4YjQ1MDAsICNiODg2MGIKICAgICk7CiAgICBib3gtc2hhZG93OiAKICAgICAgICBpbnNldCAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCksCiAgICAgICAgMCAwIDI1cHggcmdiYSgyNTUsIDIxNSwgMCwgMC4zKTsKICAgIHotaW5kZXg6IDE7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNTUzMzAwOwogICAgLyogQ29tcGxleCByb3RhdGlvbiAqLwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAyMHMgbGluZWFyIGluZmluaXRlOwp9CgovKiBQc2V1ZG8tZWxlbWVudCBmb3IgM0QgZGVwdGgvd29iYmxlIGVmZmVjdCBvbiB0aGUgcmluZyAqLwouYWItb3V0ZXItcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7CiAgICBhbmltYXRpb246IHJpbmctd29iYmxlIDhzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDI6IFJ1bmUgUmluZyAoU3Bpbm5pbmcpICovCi5hYi1ydW5lLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICAvKiBib3gtc2hhZG93IGhhbmRsZWQgYnkgYW5pbWF0aW9uICovCiAgICB6LWluZGV4OiAyOwogICAgYW5pbWF0aW9uOiBydW5lLXNwaW4tZ2xvdyAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDM6IElubmVyIENyeXN0YWwgSG91c2luZyAoRGFyayBHbGFzcykgKi8KLmFiLWlubmVyLWNyeXN0YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA2cHg7IGxlZnQ6IDZweDsgcmlnaHQ6IDZweDsgYm90dG9tOiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOTUpIDYwJSwgIzAwMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAzOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYW5pbWF0aW9uOiBjcnlzdGFsLWJyZWF0aGUgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi8qIExheWVyIDQ6IExpcXVpZCBDb3JlIChBbmltYXRlZCBTdXJmYWNlKSAqLwouYWItbGlxdWlkLWNvcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMnB4OyBsZWZ0OiAxMnB4OyByaWdodDogMTJweDsgYm90dG9tOiAxMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogQ29tcGxleCBHcmFkaWVudCBmb3IgbGlxdWlkIG1vdGlvbiAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjMDBmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiAxMDAlKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTUwJSAxNTAlOwogICAgei1pbmRleDogNDsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLyogTGlxdWlkIG1vdmVtZW50IGVmZmVjdCAoSW50ZXJuYWwgcmVmbGVjdGlvbikgKi8KLmFiLWxpcXVpZC1jb3JlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNTAlIDUwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjUpIDAlLCB0cmFuc3BhcmVudCAyNSUpOwogICAgYW5pbWF0aW9uOiBsaXF1aWRNb3ZlIDVzIGluZmluaXRlIGVhc2UtaW4tb3V0OwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIExheWVyIDU6IExpbWl0IEJyZWFrIFJpbmcgKEhpZGRlbiBieSBkZWZhdWx0KSAqLwoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0yMnB4OyBsZWZ0OiAtMjJweDsgcmlnaHQ6IC0yMnB4OyBib3R0b206IC0yMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiA0cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY0NDAwOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogI2ZmYWEwMDsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIDAgNDBweCAjZmY0NDAwOwogICAgei1pbmRleDogMDsKICAgIG9wYWNpdHk6IDA7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAxLjVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgpAa2V5ZnJhbWVzIGxpbWl0U3BpbiB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlKDE4MGRlZykgc2NhbGUoMS4xKTsgZmlsdGVyOiBodWUtcm90YXRlKDE1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZykgc2NhbGUoMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgwZGVnKTsgfQp9CgovKiBMYXllciA2OiBUZXh0IExhYmVsICovCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAKICAgICAgICAwIDJweCAwICMwMDAsCiAgICAgICAgMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMS4wKSwKICAgICAgICAwIDAgMzBweCAjMDA4OGZmOwogICAgei1pbmRleDogNjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgdG9wOiAxcHg7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB0ZXh0RmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsgfQp9CgovKiBMYXllciA3OiBHbGFyZSAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC42KSAwJSwgdHJhbnNwYXJlbnQgNDUlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHotaW5kZXg6IDc7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIG1peC1ibGVuZC1tb2RlOiBzb2Z0LWxpZ2h0Owp9CgovKiBTVEFURTogU0hPT1QgTU9ERSAoT3JhbmdlL1JlZCkgKi8KI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItb3V0ZXItcmluZyB7CiAgICBiYWNrZ3JvdW5kOiBjb25pYy1ncmFkaWVudCgKICAgICAgICBmcm9tIDBkZWcsCiAgICAgICAgIzhiMDAwMCwgI2ZmNDQwMCwgI2ZmYWEwMCwgI2ZmNDQwMCwgIzhiMDAwMCwgIzQ0MDAwMCwgIzhiMDAwMAogICAgKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1MHB4IHJnYmEoMjU1LCA2OCwgMCwgMC45KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogNXMgbGluZWFyIGluZmluaXRlOyAvKiBGYXN0ZXIgc3BpbiAqLwp9CgojYWN0aW9uLWJ1dHRvbi5zaG9vdC1tb2RlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDQwJSA0MCUsICNmZmZmMDAgMCUsICNmZjQ0MDAgNTAlLCAjNjYwMDAwIDEwMCUpOwogICAgYW5pbWF0aW9uOiBjb3JlUHVsc2VSZWQgMC40cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgY29yZVB1bHNlUmVkIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA4KTsgYm94LXNoYWRvdzogMCAwIDgwcHggI2ZmYWEwMCwgMCAwIDIwcHggI2ZmZjsgZmlsdGVyOiBicmlnaHRuZXNzKDEuMyk7IH0KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYnRuLXRleHQgewogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDAgIzAwMCwgMCAwIDIwcHggI2ZmNDQwMDsKfQoKLyogU1RBVEU6IExJTUlUIFJFQURZIChIZXJjdWxlYW4gR29sZCkgKi8KI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmxpbWl0LXJpbmcgewogICAgb3BhY2l0eTogMTsKICAgIGJvcmRlci13aWR0aDogNnB4OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmZjsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmQ3MDA7CiAgICBib3gtc2hhZG93OiAwIDAgNjBweCAjZmZhYTAwLCBpbnNldCAwIDAgMjBweCAjZmY0NDAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC44cyBsaW5lYXIgaW5maW5pdGUsIGxpbWl0UHVsc2UgMC4zcyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4ICNmZmZmZmYpOwp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDIwcHggI2ZmYWEwMDsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIGluc2V0IDAgMCA0MHB4ICNmZmZmMDA7IH0KfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNmZmQ3MDAsICNmZmZmZmYsICNmZmFhMDAsICNmZmZmZmYsICNmZmQ3MDAsICNiODg2MGIsICNmZmQ3MDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjgpOwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAycyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItcnVuZS1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggIzAwZmZmZjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgM3MgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgMCUsICNmZmZmMDAgMjAlLCAjZmY4ODAwIDYwJSwgI2ZmMDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggMC41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYnRuLXRleHQgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDAwMCwgMCAwIDIwcHggI2ZmZmYwMCwgMCAwIDQwcHggI2ZmZmZmZjsKICAgIGFuaW1hdGlvbjogdGV4dEZsb2F0IDAuMnMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgovKiBTVEFURTogQUNUSVZFIChDaGFyZ2luZy9QcmVzc2VkKSAqLwojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgNDAlLCAjZmZmZmFhIDcwJSwgI2ZmYWEwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmZmZmYsIGluc2V0IDAgMCA1MHB4ICNmZmZmZmY7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMi4wKSBjb250cmFzdCgxLjIpOwogICAgYW5pbWF0aW9uOiBub25lOyAvKiBTb2xpZCBpbnRlbnNlIGxpZ2h0ICovCn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItb3V0ZXItcmluZyB7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDAuMnMgbGluZWFyIGluZmluaXRlOyAvKiBIeXBlciBzcGluICovCiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmxpbWl0LXJpbmcgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwMHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAwLjFzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDE7Cn0KLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKfQojYXV0by10b2dnbGU6aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogd2hpdGU7Cn0KI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAoRkFZVEggSU5URVJGQUNFKSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGZsZXgtZW5kOyAvKiBBc3ltbWV0cmljIFJpZ2h0IEFsaWduICovCiAgICBwYWRkaW5nLXJpZ2h0OiAxMCU7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgCiAgICAvKiBEZWVwIFZvaWQgQmFja2dyb3VuZCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgNTAlLCAjMDUxMDIwIDAlLCAjMDAwMDAwIDEwMCUpOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgovKiBTY2FubGluZXMgJiBWaWduZXR0ZSAqLwoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCgKICAgICAgICAgICAgMGRlZywKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMHB4LAogICAgICAgICAgICB0cmFuc3BhcmVudCAycHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDNweCwKICAgICAgICAgICAgcmdiYSgwLCAyNTUsIDI1NSwgMC4wMikgNHB4CiAgICAgICAgKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9Ci5tZW51LWJnLW92ZXJsYXk6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgwLDAsMCwwLjgpIDEwMCUpOwp9CgovKiBMT0dPIFNUWUxJTkcgKi8KLmZmeC1sb2dvLWNvbnRhaW5lciB7CiAgICBtYXJnaW4tYm90dG9tOiA2MHB4OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBtYXJnaW4tcmlnaHQ6IDIwcHg7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNjBweCwgMTJ2dywgMTAwcHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDEwcHg7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgCiAgICAvKiBDcnlzdGFsIEdyYWRpZW50ICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQ1JSwgIzAwODhmZiA1NSUsICMwMDIyNjYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIAogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsKICAgIGFuaW1hdGlvbjogbG9nb0Zsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGxvZ29GbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xMHB4KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpKTsgfQp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNHZ3LCAzMnB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KCi8qIE1FTlUgT1BUSU9OUyAoQXN5bW1ldHJpYyBMaXN0KSAqLwoubWVudS1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KICAgIHdpZHRoOiA0MDBweDsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQWxpZ24gaXRlbXMgdG8gcmlnaHQgKi8KfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHggNDBweCAxNXB4IDIwcHg7CiAgICAKICAgIC8qIEdsYXNzIFNoYXJkIExvb2sgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodDogM3B4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgY3Vyc29yOiBwb2ludGVyOwovKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1yaWdodDogNjBweDsgLyogU2xpZGUgbGVmdCBlZmZlY3QgKi8KICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5tZW51LWl0ZW0gLmxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiAjYWFhYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsgLyogQ291bnRlciBza2V3IHRleHQgKi8KICAgIHRyYW5zaXRpb246IGNvbG9yIDAuMnMsIHRleHQtc2hhZG93IDAuMnM7Cn0KCi5tZW51LWl0ZW06aG92ZXIgLmxhYmVsIHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDg4ZmY7Cn0KCi8qIFBZUkVGTFkgQ1VSU09SICovCi5tZW51LWl0ZW0gLmN1cnNvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICByaWdodDogMTVweDsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZkNzAwOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgb3BhY2l0eTogMDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDApOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMTBweCAjZmZkNzAwLAogICAgICAgIDAgMCAyMHB4ICNmZmFhMDAsCiAgICAgICAgMCAwIDQwcHggI2ZmNDQwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHJpZ2h0OiAzMHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMSk7CiAgICBhbmltYXRpb246IHB5cmVmbHlXaWdnbGUgMXMgaW5maW5pdGUgZWFzZS1pbi1vdXQ7Cn0KCkBrZXlmcmFtZXMgcHlyZWZseVdpZ2dsZSB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpIHRyYW5zbGF0ZSgwLCAwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMS4yKSB0cmFuc2xhdGUoLTJweCwgLTJweCk7IH0KfQoKLyogUGFydGljbGUgdHJhaWwgZm9yIGN1cnNvciAoUHNldWRvIGVsZW1lbnQpICovCi5tZW51LWl0ZW06aG92ZXIgLmN1cnNvcjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogaW5oZXJpdDsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHlyZWZseVRyYWlsIDFzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDAuNTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMi41KTsgb3BhY2l0eTogMDsgfQp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgcmlnaHQ6IDQwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwojZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUsIDE1LCAwLjkpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCiNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgKFNQSEVSRSBQT09MIFRFUk1JTkFMKSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC40KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI3ByYWN0aWNlLW92ZXJsYXkuYWN0aXZlIHsKICAgIGRpc3BsYXk6IGZsZXg7Cn0KCi5wcmFjdGljZS1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAzMDBweDsKICAgIAogICAgLyogSG9sb2dyYXBoaWMgR2xhc3MgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45NSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxNXB4KTsKICAgIAogICAgLyogVGVjaCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKAogICAgICAgIDIwcHggMCwgMTAwJSAwLCAKICAgICAgICAxMDAlIGNhbGMoMTAwJSAtIDIwcHgpLCBjYWxjKDEwMCUgLSAyMHB4KSAxMDAlLCAKICAgICAgICAwIDEwMCUsIDAgMjBweAogICAgKTsKICAgIAogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLAogICAgICAgIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgICAgIAogICAgcGFkZGluZzogMjBweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgCiAgICAvKiBHcmlkIFBhdHRlcm4gT3ZlcmxheSAqLwogICAgYmFja2dyb3VuZC1pbWFnZTogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KSwKICAgICAgICBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjBweCAyMHB4OwogICAgCiAgICBhbmltYXRpb246IHBhbmVsRmxvYXQgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgcGFuZWxGbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01cHgpOyB9Cn0KCi5wYW5lbC1oZWFkZXIgewogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0Owp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgb3BhY2l0eTogMC44Owp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMjBweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgyNTUsIDIwMCwgMCwgMC41KTsKfQoKLmRyaWxsLWxpc3QgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgIGdhcDogOHB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxMHB4IDVweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMjAsIDQwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICM4OGFhY2M7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOCk7CiAgICBib3JkZXItY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAxMDAsIDIwMCwgMC44KSAwJSwgcmdiYSgwLCA0MCwgODAsIDAuOCkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiBpbnNldCAwIDAgMTBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgouZHJpbGwtYnRuIC5pY29uIHsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIEhpZGUgaWNvbnMgZm9yIGNsZWFuZXIgZ3JpZCAqLwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDhweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5vcHRpb24tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSk7CiAgICBjb2xvcjogI2ZmZjsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGJvcmRlci1jb2xvcjogIzAwZmYwMDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1MCwgMCwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDAsIDAuMik7Cn0KCi5vcHRpb24tdG9nZ2xlIC5jaGVja2JveCB7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogaW5oZXJpdDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7Cn0KCi5hY3Rpb24tYnRuIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSg1MCwgMCwgMCwgMC42KSwgcmdiYSgyMCwgMCwgMCwgMC44KSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgcGFkZGluZzogOHB4OwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNmZmFhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNjgsIDY4LCAwLjUpOwp9CgojcC1yZXNldC1iYWxsIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA1MCwgMTAwLCAwLjYpLCByZ2JhKDAsIDIwLCA0MCwgMC44KSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwZmZmZjsKfQojcC1yZXNldC1iYWxsOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuNSk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMjBweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyAKICAgIGhlaWdodDogMDsgCiAgICBib3JkZXItbGVmdDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDE1cHggc29saWQgIzAwZmZmZjsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHdpZHRoOiAyNHB4OyBoZWlnaHQ6IDI0cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDIycHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgT3JhbmdlIFJpbmcgKi8KICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4xKTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDI1NSwgMTAwLCAwLCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEycyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAzMHB4OyBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBGaXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmYgMCUsICNmZmFhMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmNjYwMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJsaW5kIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMzMzMzMzM7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwMDAwMCwgMnB4IDJweCAwICMxMTE7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjNjY2IDAlLCAjMDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAycyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2lsZW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC41cyBlYXNlLWluLW91dDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2hpZWxkIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZjsKICAgIGJvcmRlcjogMnB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDEwMCwgMC41KTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhhc3RlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZmZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICNmZjg4MDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xvdyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogIzg4NTUyMjsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJ1cm4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmNDQwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMDAwLCAycHggMnB4IDAgIzQ0MDAwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmMDAgMCUsICNmZjAwMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogYnVyblN0YXR1cyAxLjVzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5mcmVlemUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNhYWRkZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogZnJlZXplU3RhdHVzIDIuMHMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNob2NrIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmZmMDAsIDJweCAycHggMCAjODgwMDg4OwogICAgYW5pbWF0aW9uOiBzaG9ja1N0YXR1cyAwLjFzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBidXJuU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSBza2V3WCgwZGVnKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgc2tld1goLTVkZWcpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSkgc2tld1goMGRlZyk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQp9CgpAa2V5ZnJhbWVzIGZyZWV6ZVN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJyaWdodG5lc3MoMik7IH0KfQoKQGtleWZyYW1lcyBzaG9ja1N0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDJweCwgMCk7IH0KMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0ycHgsIDApOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KLyogLS0tIE1PQklMRSAmIFJFU1BPTlNJVkUgT1BUSU1JWkFUSU9OUyAtLS0gKi8KCi8qIDEuIENvbXBhY3QgTGFuZHNjYXBlIChNb2JpbGUgSG9yaXpvbnRhbCkgKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC1oZWlnaHQ6IDYwMHB4KSBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICAgIHBhZGRpbmc6IDVweCA0MHB4OyAvKiBNb3JlIHNpZGUgcGFkZGluZyB0byBjbGVhciBub3RjaGVzICovCiAgICB9CgogICAgLnNiLXdpbmcgewogICAgICAgIHdpZHRoOiAyMjBweDsKICAgICAgICBoZWlnaHQ6IDcwcHg7CiAgICB9CgogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyB9CgogICAgLnNiLXRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMThweDsgfQogICAgLnNiLXRlYW0tc3ViIHsgZm9udC1zaXplOiA4cHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC5zYi1zY29yZSB7IGZvbnQtc2l6ZTogNDhweDsgfQogICAgCiAgICAuc2ItY2hyb25vc3BoZXJlIHsKICAgICAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICB9CiAgICAuY2hyb25vLWNvcmUgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAuY2hyb25vLXJpbmcub3V0ZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjRweDsgfQogICAgCiAgICAvKiBBZGp1c3QgY29udHJvbHMgZm9yIGxhbmRzY2FwZSAqLwogICAgI2FjdGlvbi1jb250YWluZXIgeyBib3R0b206IDIwcHg7IHJpZ2h0OiAyMHB4OyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IGJvdHRvbSByaWdodDsgfQogICAgI2pveXN0aWNrLWhpdC16b25lIHsgd2lkdGg6IDQwJTsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICAgICAgYm90dG9tOiAyMHB4OyBsZWZ0OiAyMHB4OwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC44KSBza2V3WCgtMTBkZWcpOyB0cmFuc2Zvcm0tb3JpZ2luOiBib3R0b20gbGVmdDsKICAgIH0KfQoKLyogMi4gUG9ydHJhaXQgTW9kZSAoTW9iaWxlIFZlcnRpY2FsKSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSB7CiAgICAjaHVkLXRvcCB7CiAgICAgICAgaGVpZ2h0OiAxNDBweDsKICAgICAgICBwYWRkaW5nOiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKSAxMHB4IDAgMTBweDsKICAgICAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgICAgICBnYXA6IDVweDsKICAgIH0KCiAgICAvKiBXaW5ncyBiZWNvbWUgdG9wIGJhcnMgKi8KICAgIC5zYi13aW5nIHsKICAgICAgICB3aWR0aDogYXV0bzsKICAgICAgICBmbGV4OiAxOwogICAgICAgIGhlaWdodDogODBweDsKICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgYmFja2dyb3VuZDogbm9uZTsgLyogUmVtb3ZlIGRlZmF1bHQgYmcgY29udGFpbmVyICovCiAgICB9CgogICAgLyogQ3VzdG9tIEJHIGZvciBQb3J0cmFpdCBXaW5ncyAqLwogICAgLnNiLXdpbmctYmcgewogICAgICAgIHRyYW5zZm9ybTogc2tld1goMGRlZykgIWltcG9ydGFudDsgLyogUmVtb3ZlIHNrZXcgKi8KICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgMTBweCAxMHB4OwogICAgICAgIGJvcmRlci10b3A6IG5vbmU7CiAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItbGVmdDogbm9uZTsgCiAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgODAlLCA4NSUgMTAwJSwgMCAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItcmlnaHQ6IG5vbmU7IAogICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjZmY0NDQ0OwogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAxNSUgMTAwJSwgMCA4MCUpOwogICAgfQoKICAgIC5zYi1jb250ZW50LWNvbnRhaW5lciB7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKSAhaW1wb3J0YW50OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7IHBhZGRpbmctbGVmdDogMTVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyBhbGlnbi1pdGVtczogZmxleC1lbmQ7IHBhZGRpbmctcmlnaHQ6IDE1cHg7IH0KCiAgICAuc2ItdGVhbS1pbmZvIHsKICAgICAgICBvcmRlcjogMjsKICAgICAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItdGVhbS1pbmZvIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCiAgICAuc2ItdGVhbS1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAuc2ItdGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CgogICAgLnNiLXNjb3JlLXdyYXBwZXIgewogICAgICAgIG9yZGVyOiAxOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgIGhlaWdodDogNDBweDsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICB9CiAgICAuc2Itd2luZy5hd2F5IC5zYi1zY29yZS13cmFwcGVyIHsganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsgfQoKICAgIC5zYi1zY29yZSB7CiAgICAgICAgZm9udC1zaXplOiA0OHB4OwogICAgICAgIG1hcmdpbjogMCAhaW1wb3J0YW50OwogICAgICAgIGxpbmUtaGVpZ2h0OiAwLjg7CiAgICB9CgogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIC5zYi1lbmVyZ3ktY29uZHVpdCB7IGRpc3BsYXk6IG5vbmU7IH0KCiAgICAvKiBDaHJvbm9zcGhlcmUgQ29tcGFjdCAqLwogICAgLnNiLWNocm9ub3NwaGVyZSB7CiAgICAgICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgICAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAgICAgei1pbmRleDogMTIwMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDIwLCAwLjk1KTsgfQogICAgLmNocm9uby1yaW5nLm91dGVyIHsgd2lkdGg6IDg1cHg7IGhlaWdodDogODVweDsgb3BhY2l0eTogMC40OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgZGlzcGxheTogbm9uZTsgfSAvKiBTaW1wbGlmeSAqLwogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjBweDsgfQogICAgI2hhbGYtaW5kaWNhdG9yIHsgZm9udC1zaXplOiAxMHB4OyBtYXJnaW4tYm90dG9tOiAwOyB9CgogICAgLyogVUkgUmVwb3NpdGlvbmluZyBmb3IgUG9ydHJhaXQgKi8KICAgICNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICAgICAgdG9wOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDE0MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IHRvcCByaWdodDsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgICAgICB0b3A6IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIGxlZnQ6IDEwcHg7CiAgICB9CgogICAgI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgICAgIGJvdHRvbTogbWF4KDE4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICAgICAgbGVmdDogMTBweDsKICAgICAgICB3aWR0aDogMTYwcHg7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKTsgLyogUmVtb3ZlIHNrZXcgZm9yIHJlYWRhYmlsaXR5IG9uIG5hcnJvdyBzY3JlZW5zICovCiAgICB9CiAgICAuY2hhci1uYW1lLCAuaHAtZ2F1Z2UtY29udGFpbmVyLCAudGVjaC1nYXVnZS1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKDBkZWcpOyB9CgogICAgLyogQ29udHJvbHMgKi8KICAgICNhY3Rpb24tY29udGFpbmVyIHsKICAgICAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsgdHJhbnNmb3JtLW9yaWdpbjogYm90dG9tIHJpZ2h0OwogICAgfQogICAgCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgYm90dG9tOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgICAgICByaWdodDogbWF4KDE0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CgogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsKICAgICAgICBib3R0b206IDA7CiAgICB9CiAgICAKICAgIC8qIFNldHRpbmdzICYgQXV0byBCdXR0b25zICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHRvcDogbWF4KDIyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAyMDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgd2lkdGg6IDkwcHg7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB0b3A6IG1heCgyNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB0b3A6IG1heCgyMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjAwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQoKICAgIC8qIE1lbnVzICovCiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDEwMCU7IHBhZGRpbmctcmlnaHQ6IDIwcHg7IH0KICAgIC5mZngtbG9nby1tYWluIHsgZm9udC1zaXplOiA2MHB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzICovCiAgICAjc2V0dGluZ3MtcGFuZWwgeyB3aWR0aDogOTAlOyB9CiAgICAKICAgIC8qIFByYWN0aWNlICovCiAgICAucHJhY3RpY2UtcGFuZWwgeyB3aWR0aDogOTUlOyByaWdodDogMi41JTsgdG9wOiAxMjBweDsgfQogICAgCiAgICAvKiBBbm5vdW5jZW1lbnRzICovCiAgICAjYW5ub3VuY2VtZW50IHsKICAgICAgICBmb250LXNpemU6IDQ4cHg7CiAgICAgICAgdG9wOiAzNSU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogNjRweCAhaW1wb3J0YW50OwogICAgfQp9","./style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAoSEVSQ1VMRUFOIFNDT1JFQk9BUkQpIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDE2MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4Owp9CgovKiAtLS0gV0lOR1MgKFRlYW0gUGFuZWxzKSAtLS0gKi8KLnNiLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDM1MHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKLnNiLXdpbmcuaG9tZSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICBtYXJnaW4tbGVmdDogMjBweDsKfQoKLnNiLXdpbmcuYXdheSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBCYWNrZ3JvdW5kIFNoYXBlICovCi5zYi13aW5nLWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHotaW5kZXg6IDA7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgOTAlIDEwMCUsIDAgMTAwJSk7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgyMGRlZyk7CiAgICBib3JkZXItcmlnaHQ6IDRweCBzb2xpZCAjZmY0NDQ0OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCA2OCwgNjgsIDAuMyk7CiAgICBjbGlwLXBhdGg6IHBvbHlnb24oMTAlIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAwIDEwMCUpOwp9CgovKiBDb250ZW50IENvbnRhaW5lciAoQ291bnRlci1za2V3KSAqLwouc2ItY29udGVudC1jb250YWluZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwYWRkaW5nOiAwIDMwcHg7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1zdGFydDsKfQoKLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1lbmQ7Cn0KCi8qIFRlYW0gSW5mbyAqLwouc2ItdGVhbS1pbmZvIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXRlYW0taW5mbyB7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQoKLnNiLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LDI1NSwyNTUsMC41KTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5zYi10ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi10b3A6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIFNjb3JlIFdyYXBwZXIgKi8KLnNiLXNjb3JlLXdyYXBwZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnNiLXNjb3JlIHsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiAyOwp9Cgouc2Itd2luZy5ob21lIC5zYi1zY29yZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjMDBmZmZmIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDAgcmdiYSgwLDAsMCwwLjUpKSBkcm9wLXNoYWRvdygwIDAgMTVweCB2YXIoLS1mZngtY3lhbikpOwogICAgbWFyZ2luLWxlZnQ6IDIwcHg7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXNjb3JlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNmZmZmZmYgMCUsICNmZjQ0NDQgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggMCByZ2JhKDAsMCwwLDAuNSkpIGRyb3Atc2hhZG93KDAgMCAxNXB4ICNmZjQ0NDQpOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBTY29yZSBVcGRhdGUgQW5pbWF0aW9uICovCi5zYi1zY29yZS5zY29yZS11cGRhdGUgewogICAgYW5pbWF0aW9uOiBzY29yZVBvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKfQoKQGtleWZyYW1lcyBzY29yZVBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgZmlsdGVyOiBicmlnaHRuZXNzKDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQp9CgovKiBDcnlzdGFsIERlY28gKi8KLnNiLWNyeXN0YWwtZGVjbyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7CiAgICB3aWR0aDogNDBweDsKICAgIGhlaWdodDogNDBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSAwJSwgcmdiYSgwLDAsMCwwKSA3MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICB6LWluZGV4OiAzOwogICAgYW5pbWF0aW9uOiBwdWxzZS1nbG93IDNzIGluZmluaXRlOwp9Ci5zYi13aW5nLmhvbWUgLnNiLWNyeXN0YWwtZGVjbyB7IGxlZnQ6IC0xMHB4OyB9Ci5zYi13aW5nLmF3YXkgLnNiLWNyeXN0YWwtZGVjbyB7IHJpZ2h0OiAtMTBweDsgfQoKLyogRW5lcmd5IENvbmR1aXQgKEJhciBhdCBib3R0b20pICovCi5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7CiAgICBoZWlnaHQ6IDRweDsKICAgIHdpZHRoOiA4MCU7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggY3VycmVudENvbG9yOwogICAgei1pbmRleDogMjsKfQouc2Itd2luZy5ob21lIC5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBsZWZ0OiAwOwogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwp9Ci5zYi13aW5nLmF3YXkgLnNiLWVuZXJneS1jb25kdWl0IHsKICAgIHJpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOwp9CgovKiAtLS0gQ0hST05PU1BIRVJFIChDZW50ZXIgVGltZXIpIC0tLSAqLwouc2ItY2hyb25vc3BoZXJlIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogMTQwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLXRvcDogMTBweDsKfQoKLmNocm9uby1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDMwLCA2MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpOwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgouY2hyb25vLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hyb25vLXJpbmcub3V0ZXIgewogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggZGFzaGVkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblNsb3cgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmNocm9uby1yaW5nLm1pZCB7CiAgICB3aWR0aDogMTE1cHg7IGhlaWdodDogMTE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmlnaHQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBhbmltYXRpb246IHNwaW5TbG93IDE1cyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKLmNocm9uby1yaW5nLmlubmVyIHsKICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICBib3JkZXI6IDFweCBkb3R0ZWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOwogICAgYW5pbWF0aW9uOiBzcGluU2xvdyAxMHMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHNwaW5TbG93IHsgdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9IH0KCi5jaHJvbm8tZ2VtIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZiwgMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgei1pbmRleDogMTU7Cn0KLmNocm9uby1nZW0udG9wIHsgdG9wOiAwOyB9Ci5jaHJvbm8tZ2VtLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgojdGltZXItZGlzcGxheSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LXdlaWdodDogYm9sZDsKfQoKLyogLS0tIE1PQklMRSBBREpVU1RNRU5UUyBGT1IgSEVSQ1VMRUFOIEhVRCAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEyMHB4OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgIH0KCiAgICAuc2Itd2luZyB7CiAgICAgICAgd2lkdGg6IDEzMHB4OwogICAgICAgIGhlaWdodDogNzBweDsKICAgIH0KICAgIAogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTBkZWcpOyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQoKICAgIC5zYi10ZWFtLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIC5zYi10ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnNiLXNjb3JlIHsgZm9udC1zaXplOiA0MnB4OyB9CiAgICAuc2Itc2NvcmUtd3JhcHBlciB7IHdpZHRoOiA1MHB4OyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLXNjb3JlIHsgbWFyZ2luLWxlZnQ6IDVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itc2NvcmUgeyBtYXJnaW4tcmlnaHQ6IDVweDsgfQoKICAgIC5zYi1jaHJvbm9zcGhlcmUgewogICAgICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IH0KICAgIC5jaHJvbm8tcmluZy5vdXRlciB7IHdpZHRoOiA4NXB4OyBoZWlnaHQ6IDg1cHg7IH0KICAgIC5jaHJvbm8tcmluZy5taWQgeyB3aWR0aDogNzhweDsgaGVpZ2h0OiA3OHB4OyB9CiAgICAuY2hyb25vLXJpbmcuaW5uZXIgeyB3aWR0aDogNjVweDsgaGVpZ2h0OiA2NXB4OyB9CiAgICAKICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyMHB4OyB9CiAgICAjaGFsZi1pbmRpY2F0b3IgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIAogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KfQovKiAtLS0gUExBWUVSIFNUQVRVUyBQQU5FTCAoTElRVUlEIExJR0hUKSAtLS0gKi8KI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDQwcHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgd2lkdGg6IDIwMHB4OwogICAgcGFkZGluZzogMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjg1KSAwJSwgcmdiYSgwLCAyMCwgNDAsIDAuNikgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMik7CiAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDAgMTVweCAwIDE1cHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIE1hbmFnZWQgYnkgSlMgKi8KICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi8qIERlY29yYXRpdmUgYmFja2dyb3VuZCBzaGFyZCAqLwojcGxheWVyLXN0YXR1cy1wYW5lbDo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOyB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0NSUsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMykgNTAlLCB0cmFuc3BhcmVudCA1NSUpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDZzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Cn0KCi5ocC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA2cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQouaHAtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogOHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzMzNDQ1NTsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDVweCByZ2JhKDAsMCwwLDAuOCk7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMDBhYTQ0LCAjNDRmZjg4LCAjMDBhYTQ0KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDNzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmNDQ7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwp9Ci5ocC12YWx1ZSB7IAogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7IAogICAgY29sb3I6ICNmZmY7IAogICAgd2lkdGg6IDU1cHg7IAogICAgdGV4dC1hbGlnbjogcmlnaHQ7IAogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoudGVjaC1iYXItdHJhY2sgewogICAgZmxleC1ncm93OiAxOwogICAgaGVpZ2h0OiA0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQzMzIyOwogICAgbWFyZ2luOiAwIDhweDsKICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjYWE2NjAwLCAjZmZjYzAwLCAjYWE2NjAwKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDRzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKQGtleWZyYW1lcyBsaXF1aWRGbG93IHsKICAgIDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSAwOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogLTEwMCUgMDsgfQp9Ci8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgKEVUSEVSRUFMIElOVEVSRkFDRSkgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTQwcHg7IGhlaWdodDogMTQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBFdGhlcmVhbCBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLDAsMCwwKSA2MCUsIHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpIDEwMCUpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gMTBzIGxpbmVhciBpbmZpbml0ZTsKfQoKI2pveXN0aWNrLWJhc2U6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMCU7IGxlZnQ6IDEwJTsgd2lkdGg6IDgwJTsgaGVpZ2h0OiA4MCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gNXMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCkBrZXlmcmFtZXMgZXRoZXJlYWxTcGluIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0KfQoKI2pveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIFB5cmVmbHkgTGlnaHQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmZmZmZiAwJSwgI2EyZjlmZiA0MCUsICMwMGYyZmYgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmMmZmLCAwIDAgMzBweCAjMDBmMmZmOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07CiAgICBvcGFjaXR5OiAwLjg7Cn0KCiNqb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHVsc2UtZ2xvdyAycyBpbmZpbml0ZTsKfQoKLnRvdWNoLXJpcHBsZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjUpOwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsKICAgIGFuaW1hdGlvbjogcmlwcGxlQW5pbSAwLjZzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IGJvcmRlci13aWR0aDogNXB4OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgYm9yZGVyLXdpZHRoOiAwcHg7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp6LWluZGV4OiAxNTAwOwp9Ci5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDIyMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm90dG9tOiAyMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgY2VudGVyLCByZ2JhKDAsIDIwLCA2MCwgMC44KSAwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHotaW5kZXg6IC0xOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKfQouY29tbWFuZC1yaW5nOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0xMHB4OyBsZWZ0OiAtMTBweDsgcmlnaHQ6IC0xMHB4OyBib3R0b206IC0xMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZG90dGVkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4yKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTBzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBwYWRkaW5nOiA0cHggMTZweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICB6LWluZGV4OiAyMDsKfQoKLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDEwOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgLyogRGVlcCBTaGFkb3cgJiAzRCBDb250ZXh0ICovCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDMwcHggNjBweCByZ2JhKDAsIDAsIDAsIDAuOSksCiAgICAgICAgMCAwIDAgMnB4IHJnYmEoMCwgMCwgMCwgMS4wKTsKICAgIGJhY2tncm91bmQ6IG5vbmU7CiAgICBib3JkZXI6IG5vbmU7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4OwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKI2FjdGlvbi1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCi8qIEtleWZyYW1lcyBmb3IgTGl2aW5nIFVJICovCkBrZXlmcmFtZXMgcmluZy1neXJvLXogewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMzYwZGVnKTsgfQp9CgpAa2V5ZnJhbWVzIHJpbmctd29iYmxlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogcm90YXRlWCgxMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMTBkZWcpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoLTEwZGVnKSByb3RhdGVZKDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KfQoKQGtleWZyYW1lcyBydW5lLXNwaW4tZ2xvdyB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMDUpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdykpOyBvcGFjaXR5OiAxLjA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9Cn0KCkBrZXlmcmFtZXMgbGlxdWlkLXN1cmdlLWNvbXBsZXggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAxMDAlIDUwJTsgYm9yZGVyLXJhZGl1czogNDklOyBib3gtc2hhZG93OiAwIDAgNTBweCAjMDBmZmZmLCBpbnNldCAwIDAgNDBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9Cn0KCkBrZXlmcmFtZXMgY3J5c3RhbC1icmVhdGhlIHsKICAgIDAlLCAxMDAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMjBweCAjMDAwMDAwOyB9CiAgICA1MCUgeyBib3JkZXItY29sb3I6IHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7IGJveC1zaGFkb3c6IGluc2V0IDAgMCAzMHB4ICMwMDExMzMsIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7IH0KfQoKLyogTGF5ZXIgMTogT3V0ZXIgT3JuYXRlIFJpbmcgKE1ldGFsL0dvbGQpIC0gVGhlIEd5cm8gKi8KLmFiLW91dGVyLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtOHB4OyBsZWZ0OiAtOHB4OyByaWdodDogLThweDsgYm90dG9tOiAtOHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNiODg2MGIsICNmZmQ3MDAsICNmZmZhY2QsICNmZmQ3MDAsICNiODg2MGIsICM4YjQ1MDAsICNiODg2MGIKICAgICk7CiAgICBib3gtc2hhZG93OiAKICAgICAgICBpbnNldCAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCksCiAgICAgICAgMCAwIDI1cHggcmdiYSgyNTUsIDIxNSwgMCwgMC4zKTsKICAgIHotaW5kZXg6IDE7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNTUzMzAwOwogICAgLyogQ29tcGxleCByb3RhdGlvbiAqLwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAyMHMgbGluZWFyIGluZmluaXRlOwp9CgovKiBQc2V1ZG8tZWxlbWVudCBmb3IgM0QgZGVwdGgvd29iYmxlIGVmZmVjdCBvbiB0aGUgcmluZyAqLwouYWItb3V0ZXItcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7CiAgICBhbmltYXRpb246IHJpbmctd29iYmxlIDhzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDI6IFJ1bmUgUmluZyAoU3Bpbm5pbmcpICovCi5hYi1ydW5lLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICAvKiBib3gtc2hhZG93IGhhbmRsZWQgYnkgYW5pbWF0aW9uICovCiAgICB6LWluZGV4OiAyOwogICAgYW5pbWF0aW9uOiBydW5lLXNwaW4tZ2xvdyAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDM6IElubmVyIENyeXN0YWwgSG91c2luZyAoRGFyayBHbGFzcykgKi8KLmFiLWlubmVyLWNyeXN0YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA2cHg7IGxlZnQ6IDZweDsgcmlnaHQ6IDZweDsgYm90dG9tOiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOTUpIDYwJSwgIzAwMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAzOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYW5pbWF0aW9uOiBjcnlzdGFsLWJyZWF0aGUgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi8qIExheWVyIDQ6IExpcXVpZCBDb3JlIChBbmltYXRlZCBTdXJmYWNlKSAqLwouYWItbGlxdWlkLWNvcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMnB4OyBsZWZ0OiAxMnB4OyByaWdodDogMTJweDsgYm90dG9tOiAxMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogQ29tcGxleCBHcmFkaWVudCBmb3IgbGlxdWlkIG1vdGlvbiAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjMDBmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiAxMDAlKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTUwJSAxNTAlOwogICAgei1pbmRleDogNDsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLyogTGlxdWlkIG1vdmVtZW50IGVmZmVjdCAoSW50ZXJuYWwgcmVmbGVjdGlvbikgKi8KLmFiLWxpcXVpZC1jb3JlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNTAlIDUwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjUpIDAlLCB0cmFuc3BhcmVudCAyNSUpOwogICAgYW5pbWF0aW9uOiBsaXF1aWRNb3ZlIDVzIGluZmluaXRlIGVhc2UtaW4tb3V0OwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIExheWVyIDU6IExpbWl0IEJyZWFrIFJpbmcgKEhpZGRlbiBieSBkZWZhdWx0KSAqLwoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0yMnB4OyBsZWZ0OiAtMjJweDsgcmlnaHQ6IC0yMnB4OyBib3R0b206IC0yMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiA0cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY0NDAwOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogI2ZmYWEwMDsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIDAgNDBweCAjZmY0NDAwOwogICAgei1pbmRleDogMDsKICAgIG9wYWNpdHk6IDA7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAxLjVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgpAa2V5ZnJhbWVzIGxpbWl0U3BpbiB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlKDE4MGRlZykgc2NhbGUoMS4xKTsgZmlsdGVyOiBodWUtcm90YXRlKDE1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZykgc2NhbGUoMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgwZGVnKTsgfQp9CgovKiBMYXllciA2OiBUZXh0IExhYmVsICovCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAKICAgICAgICAwIDJweCAwICMwMDAsCiAgICAgICAgMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMS4wKSwKICAgICAgICAwIDAgMzBweCAjMDA4OGZmOwogICAgei1pbmRleDogNjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgdG9wOiAxcHg7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB0ZXh0RmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsgfQp9CgovKiBMYXllciA3OiBHbGFyZSAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC42KSAwJSwgdHJhbnNwYXJlbnQgNDUlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHotaW5kZXg6IDc7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIG1peC1ibGVuZC1tb2RlOiBzb2Z0LWxpZ2h0Owp9CgovKiBTVEFURTogU0hPT1QgTU9ERSAoT3JhbmdlL1JlZCkgKi8KI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItb3V0ZXItcmluZyB7CiAgICBiYWNrZ3JvdW5kOiBjb25pYy1ncmFkaWVudCgKICAgICAgICBmcm9tIDBkZWcsCiAgICAgICAgIzhiMDAwMCwgI2ZmNDQwMCwgI2ZmYWEwMCwgI2ZmNDQwMCwgIzhiMDAwMCwgIzQ0MDAwMCwgIzhiMDAwMAogICAgKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1MHB4IHJnYmEoMjU1LCA2OCwgMCwgMC45KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogNXMgbGluZWFyIGluZmluaXRlOyAvKiBGYXN0ZXIgc3BpbiAqLwp9CgojYWN0aW9uLWJ1dHRvbi5zaG9vdC1tb2RlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDQwJSA0MCUsICNmZmZmMDAgMCUsICNmZjQ0MDAgNTAlLCAjNjYwMDAwIDEwMCUpOwogICAgYW5pbWF0aW9uOiBjb3JlUHVsc2VSZWQgMC40cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgY29yZVB1bHNlUmVkIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA4KTsgYm94LXNoYWRvdzogMCAwIDgwcHggI2ZmYWEwMCwgMCAwIDIwcHggI2ZmZjsgZmlsdGVyOiBicmlnaHRuZXNzKDEuMyk7IH0KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYnRuLXRleHQgewogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDAgIzAwMCwgMCAwIDIwcHggI2ZmNDQwMDsKfQoKLyogU1RBVEU6IExJTUlUIFJFQURZIChIZXJjdWxlYW4gR29sZCkgKi8KI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmxpbWl0LXJpbmcgewogICAgb3BhY2l0eTogMTsKICAgIGJvcmRlci13aWR0aDogNnB4OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmZjsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmQ3MDA7CiAgICBib3gtc2hhZG93OiAwIDAgNjBweCAjZmZhYTAwLCBpbnNldCAwIDAgMjBweCAjZmY0NDAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC44cyBsaW5lYXIgaW5maW5pdGUsIGxpbWl0UHVsc2UgMC4zcyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4ICNmZmZmZmYpOwp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDIwcHggI2ZmYWEwMDsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIGluc2V0IDAgMCA0MHB4ICNmZmZmMDA7IH0KfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNmZmQ3MDAsICNmZmZmZmYsICNmZmFhMDAsICNmZmZmZmYsICNmZmQ3MDAsICNiODg2MGIsICNmZmQ3MDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjgpOwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAycyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItcnVuZS1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggIzAwZmZmZjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgM3MgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgMCUsICNmZmZmMDAgMjAlLCAjZmY4ODAwIDYwJSwgI2ZmMDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggMC41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYnRuLXRleHQgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDAwMCwgMCAwIDIwcHggI2ZmZmYwMCwgMCAwIDQwcHggI2ZmZmZmZjsKICAgIGFuaW1hdGlvbjogdGV4dEZsb2F0IDAuMnMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgovKiBTVEFURTogQUNUSVZFIChDaGFyZ2luZy9QcmVzc2VkKSAqLwojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgNDAlLCAjZmZmZmFhIDcwJSwgI2ZmYWEwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmZmZmYsIGluc2V0IDAgMCA1MHB4ICNmZmZmZmY7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMi4wKSBjb250cmFzdCgxLjIpOwogICAgYW5pbWF0aW9uOiBub25lOyAvKiBTb2xpZCBpbnRlbnNlIGxpZ2h0ICovCn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItb3V0ZXItcmluZyB7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDAuMnMgbGluZWFyIGluZmluaXRlOyAvKiBIeXBlciBzcGluICovCiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmxpbWl0LXJpbmcgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwMHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAwLjFzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDE7Cn0KLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKfQojYXV0by10b2dnbGU6aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogd2hpdGU7Cn0KI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAoRkFZVEggSU5URVJGQUNFKSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGZsZXgtZW5kOyAvKiBBc3ltbWV0cmljIFJpZ2h0IEFsaWduICovCiAgICBwYWRkaW5nLXJpZ2h0OiAxMCU7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgCiAgICAvKiBEZWVwIFZvaWQgQmFja2dyb3VuZCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgNTAlLCAjMDUxMDIwIDAlLCAjMDAwMDAwIDEwMCUpOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgovKiBTY2FubGluZXMgJiBWaWduZXR0ZSAqLwoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCgKICAgICAgICAgICAgMGRlZywKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMHB4LAogICAgICAgICAgICB0cmFuc3BhcmVudCAycHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDNweCwKICAgICAgICAgICAgcmdiYSgwLCAyNTUsIDI1NSwgMC4wMikgNHB4CiAgICAgICAgKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9Ci5tZW51LWJnLW92ZXJsYXk6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgwLDAsMCwwLjgpIDEwMCUpOwp9CgovKiBMT0dPIFNUWUxJTkcgKi8KLmZmeC1sb2dvLWNvbnRhaW5lciB7CiAgICBtYXJnaW4tYm90dG9tOiA2MHB4OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBtYXJnaW4tcmlnaHQ6IDIwcHg7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNjBweCwgMTJ2dywgMTAwcHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDEwcHg7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgCiAgICAvKiBDcnlzdGFsIEdyYWRpZW50ICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQ1JSwgIzAwODhmZiA1NSUsICMwMDIyNjYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIAogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsKICAgIGFuaW1hdGlvbjogbG9nb0Zsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGxvZ29GbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xMHB4KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpKTsgfQp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNHZ3LCAzMnB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KCi8qIE1FTlUgT1BUSU9OUyAoQXN5bW1ldHJpYyBMaXN0KSAqLwoubWVudS1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KICAgIHdpZHRoOiA0MDBweDsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQWxpZ24gaXRlbXMgdG8gcmlnaHQgKi8KfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHggNDBweCAxNXB4IDIwcHg7CiAgICAKICAgIC8qIEdsYXNzIFNoYXJkIExvb2sgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodDogM3B4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgY3Vyc29yOiBwb2ludGVyOwovKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1yaWdodDogNjBweDsgLyogU2xpZGUgbGVmdCBlZmZlY3QgKi8KICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5tZW51LWl0ZW0gLmxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiAjYWFhYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsgLyogQ291bnRlciBza2V3IHRleHQgKi8KICAgIHRyYW5zaXRpb246IGNvbG9yIDAuMnMsIHRleHQtc2hhZG93IDAuMnM7Cn0KCi5tZW51LWl0ZW06aG92ZXIgLmxhYmVsIHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDg4ZmY7Cn0KCi8qIFBZUkVGTFkgQ1VSU09SICovCi5tZW51LWl0ZW0gLmN1cnNvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICByaWdodDogMTVweDsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZkNzAwOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgb3BhY2l0eTogMDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDApOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMTBweCAjZmZkNzAwLAogICAgICAgIDAgMCAyMHB4ICNmZmFhMDAsCiAgICAgICAgMCAwIDQwcHggI2ZmNDQwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHJpZ2h0OiAzMHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMSk7CiAgICBhbmltYXRpb246IHB5cmVmbHlXaWdnbGUgMXMgaW5maW5pdGUgZWFzZS1pbi1vdXQ7Cn0KCkBrZXlmcmFtZXMgcHlyZWZseVdpZ2dsZSB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpIHRyYW5zbGF0ZSgwLCAwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMS4yKSB0cmFuc2xhdGUoLTJweCwgLTJweCk7IH0KfQoKLyogUGFydGljbGUgdHJhaWwgZm9yIGN1cnNvciAoUHNldWRvIGVsZW1lbnQpICovCi5tZW51LWl0ZW06aG92ZXIgLmN1cnNvcjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogaW5oZXJpdDsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHlyZWZseVRyYWlsIDFzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDAuNTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMi41KTsgb3BhY2l0eTogMDsgfQp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgcmlnaHQ6IDQwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwojZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUsIDE1LCAwLjkpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCiNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgKFNQSEVSRSBQT09MIFRFUk1JTkFMKSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC40KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI3ByYWN0aWNlLW92ZXJsYXkuYWN0aXZlIHsKICAgIGRpc3BsYXk6IGZsZXg7Cn0KCi5wcmFjdGljZS1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAzMDBweDsKICAgIAogICAgLyogSG9sb2dyYXBoaWMgR2xhc3MgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45NSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxNXB4KTsKICAgIAogICAgLyogVGVjaCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKAogICAgICAgIDIwcHggMCwgMTAwJSAwLCAKICAgICAgICAxMDAlIGNhbGMoMTAwJSAtIDIwcHgpLCBjYWxjKDEwMCUgLSAyMHB4KSAxMDAlLCAKICAgICAgICAwIDEwMCUsIDAgMjBweAogICAgKTsKICAgIAogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLAogICAgICAgIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgICAgIAogICAgcGFkZGluZzogMjBweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgCiAgICAvKiBHcmlkIFBhdHRlcm4gT3ZlcmxheSAqLwogICAgYmFja2dyb3VuZC1pbWFnZTogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KSwKICAgICAgICBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjBweCAyMHB4OwogICAgCiAgICBhbmltYXRpb246IHBhbmVsRmxvYXQgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgcGFuZWxGbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01cHgpOyB9Cn0KCi5wYW5lbC1oZWFkZXIgewogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0Owp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgb3BhY2l0eTogMC44Owp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMjBweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgyNTUsIDIwMCwgMCwgMC41KTsKfQoKLmRyaWxsLWxpc3QgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgIGdhcDogOHB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxMHB4IDVweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMjAsIDQwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICM4OGFhY2M7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOCk7CiAgICBib3JkZXItY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAxMDAsIDIwMCwgMC44KSAwJSwgcmdiYSgwLCA0MCwgODAsIDAuOCkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiBpbnNldCAwIDAgMTBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgouZHJpbGwtYnRuIC5pY29uIHsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIEhpZGUgaWNvbnMgZm9yIGNsZWFuZXIgZ3JpZCAqLwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDhweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5vcHRpb24tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSk7CiAgICBjb2xvcjogI2ZmZjsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGJvcmRlci1jb2xvcjogIzAwZmYwMDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1MCwgMCwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDAsIDAuMik7Cn0KCi5vcHRpb24tdG9nZ2xlIC5jaGVja2JveCB7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogaW5oZXJpdDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7Cn0KCi5hY3Rpb24tYnRuIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSg1MCwgMCwgMCwgMC42KSwgcmdiYSgyMCwgMCwgMCwgMC44KSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgcGFkZGluZzogOHB4OwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNmZmFhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNjgsIDY4LCAwLjUpOwp9CgojcC1yZXNldC1iYWxsIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA1MCwgMTAwLCAwLjYpLCByZ2JhKDAsIDIwLCA0MCwgMC44KSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwZmZmZjsKfQojcC1yZXNldC1iYWxsOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuNSk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMjBweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyAKICAgIGhlaWdodDogMDsgCiAgICBib3JkZXItbGVmdDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDE1cHggc29saWQgIzAwZmZmZjsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHdpZHRoOiAyNHB4OyBoZWlnaHQ6IDI0cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDIycHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgT3JhbmdlIFJpbmcgKi8KICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4xKTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDI1NSwgMTAwLCAwLCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEycyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAzMHB4OyBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBGaXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmYgMCUsICNmZmFhMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmNjYwMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJsaW5kIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMzMzMzMzM7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwMDAwMCwgMnB4IDJweCAwICMxMTE7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjNjY2IDAlLCAjMDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAycyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2lsZW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC41cyBlYXNlLWluLW91dDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2hpZWxkIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZjsKICAgIGJvcmRlcjogMnB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDEwMCwgMC41KTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhhc3RlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZmZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICNmZjg4MDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xvdyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogIzg4NTUyMjsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJ1cm4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmNDQwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMDAwLCAycHggMnB4IDAgIzQ0MDAwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmMDAgMCUsICNmZjAwMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogYnVyblN0YXR1cyAxLjVzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5mcmVlemUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNhYWRkZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogZnJlZXplU3RhdHVzIDIuMHMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNob2NrIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmZmMDAsIDJweCAycHggMCAjODgwMDg4OwogICAgYW5pbWF0aW9uOiBzaG9ja1N0YXR1cyAwLjFzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBidXJuU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSBza2V3WCgwZGVnKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgc2tld1goLTVkZWcpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSkgc2tld1goMGRlZyk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQp9CgpAa2V5ZnJhbWVzIGZyZWV6ZVN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJyaWdodG5lc3MoMik7IH0KfQoKQGtleWZyYW1lcyBzaG9ja1N0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDJweCwgMCk7IH0KMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0ycHgsIDApOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KLyogLS0tIE1PQklMRSAmIFJFU1BPTlNJVkUgT1BUSU1JWkFUSU9OUyAtLS0gKi8KCi8qIDEuIENvbXBhY3QgTGFuZHNjYXBlIChNb2JpbGUgSG9yaXpvbnRhbCkgKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC1oZWlnaHQ6IDYwMHB4KSBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICAgIHBhZGRpbmc6IDVweCA0MHB4OyAvKiBNb3JlIHNpZGUgcGFkZGluZyB0byBjbGVhciBub3RjaGVzICovCiAgICB9CgogICAgLnNiLXdpbmcgewogICAgICAgIHdpZHRoOiAyMjBweDsKICAgICAgICBoZWlnaHQ6IDcwcHg7CiAgICB9CgogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyB9CgogICAgLnNiLXRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMThweDsgfQogICAgLnNiLXRlYW0tc3ViIHsgZm9udC1zaXplOiA4cHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC5zYi1zY29yZSB7IGZvbnQtc2l6ZTogNDhweDsgfQogICAgCiAgICAuc2ItY2hyb25vc3BoZXJlIHsKICAgICAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICB9CiAgICAuY2hyb25vLWNvcmUgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAuY2hyb25vLXJpbmcub3V0ZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjRweDsgfQogICAgCiAgICAvKiBBZGp1c3QgY29udHJvbHMgZm9yIGxhbmRzY2FwZSAqLwogICAgI2FjdGlvbi1jb250YWluZXIgeyBib3R0b206IDIwcHg7IHJpZ2h0OiAyMHB4OyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IGJvdHRvbSByaWdodDsgfQogICAgI2pveXN0aWNrLWhpdC16b25lIHsgd2lkdGg6IDQwJTsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICAgICAgYm90dG9tOiAyMHB4OyBsZWZ0OiAyMHB4OwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC44KSBza2V3WCgtMTBkZWcpOyB0cmFuc2Zvcm0tb3JpZ2luOiBib3R0b20gbGVmdDsKICAgIH0KfQoKLyogMi4gUG9ydHJhaXQgTW9kZSAoTW9iaWxlIFZlcnRpY2FsKSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSB7CiAgICAjaHVkLXRvcCB7CiAgICAgICAgaGVpZ2h0OiAxNDBweDsKICAgICAgICBwYWRkaW5nOiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKSAxMHB4IDAgMTBweDsKICAgICAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgICAgICBnYXA6IDVweDsKICAgIH0KCiAgICAvKiBXaW5ncyBiZWNvbWUgdG9wIGJhcnMgKi8KICAgIC5zYi13aW5nIHsKICAgICAgICB3aWR0aDogYXV0bzsKICAgICAgICBmbGV4OiAxOwogICAgICAgIGhlaWdodDogODBweDsKICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgYmFja2dyb3VuZDogbm9uZTsgLyogUmVtb3ZlIGRlZmF1bHQgYmcgY29udGFpbmVyICovCiAgICB9CgogICAgLyogQ3VzdG9tIEJHIGZvciBQb3J0cmFpdCBXaW5ncyAqLwogICAgLnNiLXdpbmctYmcgewogICAgICAgIHRyYW5zZm9ybTogc2tld1goMGRlZykgIWltcG9ydGFudDsgLyogUmVtb3ZlIHNrZXcgKi8KICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgMTBweCAxMHB4OwogICAgICAgIGJvcmRlci10b3A6IG5vbmU7CiAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItbGVmdDogbm9uZTsgCiAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgODAlLCA4NSUgMTAwJSwgMCAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItcmlnaHQ6IG5vbmU7IAogICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjZmY0NDQ0OwogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAxNSUgMTAwJSwgMCA4MCUpOwogICAgfQoKICAgIC5zYi1jb250ZW50LWNvbnRhaW5lciB7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKSAhaW1wb3J0YW50OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7IHBhZGRpbmctbGVmdDogMTVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyBhbGlnbi1pdGVtczogZmxleC1lbmQ7IHBhZGRpbmctcmlnaHQ6IDE1cHg7IH0KCiAgICAuc2ItdGVhbS1pbmZvIHsKICAgICAgICBvcmRlcjogMjsKICAgICAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItdGVhbS1pbmZvIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCiAgICAuc2ItdGVhbS1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAuc2ItdGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CgogICAgLnNiLXNjb3JlLXdyYXBwZXIgewogICAgICAgIG9yZGVyOiAxOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgIGhlaWdodDogNDBweDsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICB9CiAgICAuc2Itd2luZy5hd2F5IC5zYi1zY29yZS13cmFwcGVyIHsganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsgfQoKICAgIC5zYi1zY29yZSB7CiAgICAgICAgZm9udC1zaXplOiA0OHB4OwogICAgICAgIG1hcmdpbjogMCAhaW1wb3J0YW50OwogICAgICAgIGxpbmUtaGVpZ2h0OiAwLjg7CiAgICB9CgogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIC5zYi1lbmVyZ3ktY29uZHVpdCB7IGRpc3BsYXk6IG5vbmU7IH0KCiAgICAvKiBDaHJvbm9zcGhlcmUgQ29tcGFjdCAqLwogICAgLnNiLWNocm9ub3NwaGVyZSB7CiAgICAgICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgICAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAgICAgei1pbmRleDogMTIwMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDIwLCAwLjk1KTsgfQogICAgLmNocm9uby1yaW5nLm91dGVyIHsgd2lkdGg6IDg1cHg7IGhlaWdodDogODVweDsgb3BhY2l0eTogMC40OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgZGlzcGxheTogbm9uZTsgfSAvKiBTaW1wbGlmeSAqLwogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjBweDsgfQogICAgI2hhbGYtaW5kaWNhdG9yIHsgZm9udC1zaXplOiAxMHB4OyBtYXJnaW4tYm90dG9tOiAwOyB9CgogICAgLyogVUkgUmVwb3NpdGlvbmluZyBmb3IgUG9ydHJhaXQgKi8KICAgICNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICAgICAgdG9wOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDE0MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IHRvcCByaWdodDsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgICAgICB0b3A6IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIGxlZnQ6IDEwcHg7CiAgICB9CgogICAgI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgICAgIGJvdHRvbTogbWF4KDE4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICAgICAgbGVmdDogMTBweDsKICAgICAgICB3aWR0aDogMTYwcHg7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKTsgLyogUmVtb3ZlIHNrZXcgZm9yIHJlYWRhYmlsaXR5IG9uIG5hcnJvdyBzY3JlZW5zICovCiAgICB9CiAgICAuY2hhci1uYW1lLCAuaHAtZ2F1Z2UtY29udGFpbmVyLCAudGVjaC1nYXVnZS1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKDBkZWcpOyB9CgogICAgLyogQ29udHJvbHMgKi8KICAgICNhY3Rpb24tY29udGFpbmVyIHsKICAgICAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsgdHJhbnNmb3JtLW9yaWdpbjogYm90dG9tIHJpZ2h0OwogICAgfQogICAgCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgYm90dG9tOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgICAgICByaWdodDogbWF4KDE0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CgogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsKICAgICAgICBib3R0b206IDA7CiAgICB9CiAgICAKICAgIC8qIFNldHRpbmdzICYgQXV0byBCdXR0b25zICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHRvcDogbWF4KDIyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAyMDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgd2lkdGg6IDkwcHg7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB0b3A6IG1heCgyNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB0b3A6IG1heCgyMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjAwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQoKICAgIC8qIE1lbnVzICovCiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDEwMCU7IHBhZGRpbmctcmlnaHQ6IDIwcHg7IH0KICAgIC5mZngtbG9nby1tYWluIHsgZm9udC1zaXplOiA2MHB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzICovCiAgICAjc2V0dGluZ3MtcGFuZWwgeyB3aWR0aDogOTAlOyB9CiAgICAKICAgIC8qIFByYWN0aWNlICovCiAgICAucHJhY3RpY2UtcGFuZWwgeyB3aWR0aDogOTUlOyByaWdodDogMi41JTsgdG9wOiAxMjBweDsgfQogICAgCiAgICAvKiBBbm5vdW5jZW1lbnRzICovCiAgICAjYW5ub3VuY2VtZW50IHsKICAgICAgICBmb250LXNpemU6IDQ4cHg7CiAgICAgICAgdG9wOiAzNSU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogNjRweCAhaW1wb3J0YW50OwogICAgfQp9","/style.css":"data:text/css;base64,QGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q2luemVsOndnaHRANDAwOzUwMDs3MDA7OTAwJmRpc3BsYXk9c3dhcCcpOwoKOnJvb3QgewogICAgLyogLS0tIFRIRSBTUElSQU4gUEFMRVRURSAtLS0gKi8KICAgIC0tZmZ4LWJsdWUtZGVlcDogIzAxMDIwNTsgICAgICAgLyogVm9pZCAqLwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMDgxMjI2OyAgICAgICAvKiBNaWRuaWdodCBEZXB0aCAqLwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNjMyNUI7ICAgICAgICAvKiBaYW5hcmthbmQgU2VhICovCiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjM2I3NWJhOyAgICAgIC8qIFNwaGVyZSBXYXRlciAqLwogICAgCiAgICAtLWZmeC1jeWFuOiAjMDBmMmZmOyAgICAgICAgICAgIC8qIFNwaXJpdCBFbmVyZ3kgKi8KICAgIC0tZmZ4LWN5YW4tZ2xvdzogI2EyZjlmZjsgICAgICAgLyogUHlyZWZseSBDb3JlICovCiAgICAtLWZmeC1jeWFuLWRpbTogIzAwNWY3MzsgICAgICAgIC8qIERlZXAgTWFnaWMgKi8KCiAgICAtLWZmeC1nb2xkOiAjYzVhMDU5OyAgICAgICAgICAgIC8qIFlldm9uIFNjcmlwdCAqLwogICAgLS1mZngtZ29sZC1saWdodDogI2ZjZWViNTsgICAgICAvKiBIb2x5IEF1cmEgKi8KICAgIC0tZmZ4LWdvbGQtZGFyazogIzdhNWMyMjsgICAgICAgLyogQWdlZCBSZWxpYyAqLwogICAgCiAgICAtLWZmeC1nbGFzcy1iZzogcmdiYSg2LCAxMiwgMjQsIDAuODUpOwogICAgLS1mZngtZ2xhc3MtYm9yZGVyOiByZ2JhKDAsIDI0MiwgMjU1LCAwLjI1KTsKICAgIAogICAgLyogVHlwb2dyYXBoeSAqLwogICAgLS1mb250LXRpdGxlOiAnQ2luemVsJywgJ0dhcmFtb25kJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLyogLS0tIFNQSVJBTiBVVElMSVRJRVMgLS0tICovCgovKiBHbG9iYWwgS2V5ZnJhbWVzICovCkBrZXlmcmFtZXMgc2hpbW1lciB7CiAgICAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IC0yMDAlIGNlbnRlcjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtcG9zaXRpb246IDIwMCUgY2VudGVyOyB9Cn0KCkBrZXlmcmFtZXMgcHVsc2UtZ2xvdyB7CiAgICAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4tZGltKTsgfQogICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pLCAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7IH0KICAgIDEwMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuLWRpbSk7IH0KfQoKQGtleWZyYW1lcyBmbG9hdCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLThweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KTsgfQp9CgpAa2V5ZnJhbWVzIGhvbG9ncmFwaGljLWZsaWNrZXIgewogICAgMCUgeyBvcGFjaXR5OiAwLjk1OyB9CiAgICA1JSB7IG9wYWNpdHk6IDAuODsgfQogICAgMTAlIHsgb3BhY2l0eTogMC45NTsgfQogICAgMTAwJSB7IG9wYWNpdHk6IDAuOTU7IH0KfQoKLyogR2xhc3MgUGFuZWwgVXRpbGl0eSAtIFRoZSBGb3VuZGF0aW9uIG9mIHRoZSBVSSAqLwouZ2xhc3MtcGFuZWwgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSg2LCAxMiwgMjQsIDAuOSkgMCUsIHJnYmEoMTAsIDI1LCA1MCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxNnB4KSBzYXR1cmF0ZSgxMjAlKTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDE2cHgpIHNhdHVyYXRlKDEyMCUpOwogICAgCiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4wNSk7CiAgICAKICAgIGJveC1zaGFkb3c6IAogICAgICAgIDAgMTVweCAzNXB4IHJnYmEoMCwgMCwgMCwgMC42KSwKICAgICAgICBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjA1KTsKICAgICAgICAKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAKICAgIC8qIEFzeW1tZXRyaWMgQ3V0IC0gRkZYIFN0eWxlICovCiAgICBjbGlwLXBhdGg6IHBvbHlnb24oCiAgICAgICAgMCAwLCAKICAgICAgICAxMDAlIDAsIAogICAgICAgIDEwMCUgODUlLCAKICAgICAgICA5NSUgMTAwJSwgCiAgICAgICAgMCAxMDAlCiAgICApOwp9CgovKiBTaGltbWVyIEVmZmVjdCBmb3IgR2xhc3MgUGFuZWxzICovCi5nbGFzcy1wYW5lbDo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoCiAgICAgICAgMTA1ZGVnLCAKICAgICAgICB0cmFuc3BhcmVudCAyMCUsIAogICAgICAgIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSkgNDAlLCAKICAgICAgICByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpIDQ1JSwgCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSA1MCUsIAogICAgICAgIHRyYW5zcGFyZW50IDcwJQogICAgKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDhzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIERlY29yYXRpdmUgQ29ybmVyIEFjY2VudCAqLwouZ2xhc3MtcGFuZWw6OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHZhcigtLWZmeC1jeWFuKSwgdHJhbnNwYXJlbnQpOwogICAgb3BhY2l0eTogMC43OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KLyogLS0tIElNUEFDVCBGWCAoSlVJQ0VEKSAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMTVzIGN1YmljLWJlemllciguMzYsLjA3LC4xOSwuOTcpIGJvdGg7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMykgYnJpZ2h0bmVzcygxLjIpIHNhdHVyYXRlKDEuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3QtaGVhdnkgewogICAgYW5pbWF0aW9uOiBpbXBhY3RIZWF2eSAwLjI1cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgxLjUpIGJyaWdodG5lc3MoMS4zKSBzYXR1cmF0ZSgxLjUpIHNlcGlhKDAuMik7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBmaWx0ZXI7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYXR0ZXIgMC41cyBjdWJpYy1iZXppZXIoLjM2LC4wNywuMTksLjk3KSBib3RoOwogICAgZmlsdGVyOiBjb250cmFzdCgyLjApIGJyaWdodG5lc3MoMS41KSBzYXR1cmF0ZSgyLjApIGludmVydCgwLjA1KTsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIGZpbHRlcjsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgMCwgMCk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTNweCwgMnB4LCAwKSBzY2FsZSgxLjAxKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgzcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKC0zcHgsIC0ycHgsIDApIHNjYWxlKDEuMDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdEhlYXZ5IHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQogICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNnB4LCA0cHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDZweCwgLTRweCwgMCkgc2NhbGUoMS4wMik7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTRweCwgLTJweCwgMCkgc2NhbGUoMS4wNCk7IGZpbHRlcjogY29udHJhc3QoMS44KSBicmlnaHRuZXNzKDEuNSk7IH0KICAgIDcwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoNHB4LCAycHgsIDApIHNjYWxlKDEuMDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKSBzY2FsZSgxKTsgfQp9CgpAa2V5ZnJhbWVzIGltcGFjdFNoYXR0ZXIgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTEwcHgsIDVweCwgMCkgc2NhbGUoMS4wNSkgc2tld1goMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSg0NWRlZykgY29udHJhc3QoMi41KTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgxMHB4LCAtNXB4LCAwKSBzY2FsZSgxLjA1KSBza2V3WCgtMmRlZyk7IGZpbHRlcjogaHVlLXJvdGF0ZSgtNDVkZWcpOyB9CiAgICA0MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEuMSk7IGZpbHRlcjogaW52ZXJ0KDAuMik7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoLTVweCwgMCwgMCkgc2NhbGUoMS4wNSk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KfQoKLyogLS0tIENBTlZBUyAmIFJFTkRFUiAtLS0gKi8KY2FudmFzIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IAogICAgei1pbmRleDogMDsKfQoKLyogLS0tIEdJRiBPVkVSTEFZIC0tLSAqLwojc2NyZWVuLW92ZXJsYXktZ2lmIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBvYmplY3QtZml0OiBjb3ZlcjsKICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgb3BhY2l0eTogMS4wOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5NTA7CiAgICBpbWFnZS1yZW5kZXJpbmc6IHBpeGVsYXRlZDsKfQoKI3VpLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICB6LWluZGV4OiAxMDAwOwogICAgY29udGFpbjogc3RyaWN0Owp9CgovKiAtLS0gQ0lORU1BVElDIEJBUlMgLS0tICovCiNjaW5lbWF0aWMtYmFycyAuYmFyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDA7CiAgICBiYWNrZ3JvdW5kOiBibGFjazsKICAgIHRyYW5zaXRpb246IGhlaWdodCAwLjVzIGVhc2U7CiAgICB6LWluZGV4OiA4MDA7Cn0KI2NpbmVtYXRpYy1iYXJzIC5iYXIudG9wIHsgdG9wOiAwOyB9CiNjaW5lbWF0aWMtYmFycyAuYmFyLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFRFQ0ggRkxBU0ggT1ZFUkxBWSAoTElNSVQgQlJFQUsgU1RZTEUpIC0tLSAqLwojdGVjaC1mbGFzaC1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMjUlOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxNTBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgLyogTGltaXQgQnJlYWsgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgCiAgICAgICAgcmdiYSgwLDAsMCwwKSAwJSwgCiAgICAgICAgcmdiYSg1MCwgMCwgMCwgMC44KSAyMCUsIAogICAgICAgIHJnYmEoMTAwLCAyMCwgMCwgMC45KSA1MCUsIAogICAgICAgIHJnYmEoNTAsIDAsIDAsIDAuOCkgODAlLCAKICAgICAgICByZ2JhKDAsMCwwLDApIDEwMCUKICAgICk7CiAgICB6LWluZGV4OiAyMjAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgyNTUsIDEwMCwgMCwgMC41KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDI1NSwgMTAwLCAwLCAwLjUpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDUwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjMpOwogICAgYW5pbWF0aW9uOiBsaW1pdEJyZWFrRW50ZXIgMC4ycyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7Cn0KCkBrZXlmcmFtZXMgbGltaXRCcmVha0VudGVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpIHNjYWxlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKSBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLyogU2hhdHRlciBMaW5lcyAoUHNldWRvLWVsZW1lbnRzKSAqLwojdGVjaC1mbGFzaC1vdmVybGF5OjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXRpbmctbGluZWFyLWdyYWRpZW50KAogICAgICAgIDQ1ZGVnLAogICAgICAgIHRyYW5zcGFyZW50IDAsCiAgICAgICAgdHJhbnNwYXJlbnQgMTBweCwKICAgICAgICByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIDEwcHgsCiAgICAgICAgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSAyMHB4CiAgICApOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyAvKiBDb3VudGVyLXNrZXcgdGV4dCAqLwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMjsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7IC8qIENpbnplbCAqLwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNjRweCk7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICAKICAgIC8qIExpbWl0IEJyZWFrIEdvbGQvV2hpdGUgR3JhZGllbnQgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmZmYWEgNDAlLCAjZmZhYTAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC44KSkgZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDAsIDAsIDAuNCkpOwogICAgCiAgICBhbmltYXRpb246IGxpbWl0VGV4dFB1bHNlIDAuMXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgpAa2V5ZnJhbWVzIGxpbWl0VGV4dFB1bHNlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmdiYSgyNTUsIDIwMCwgMCwgMS4wKSk7IH0KfQoKLnRlY2gtc3ViLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHBhZGRpbmc6IDJweCAxMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDMwMHB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgyMCwgMCwgMCwgMC44KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0MDA7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDY4LCAwLCAwLjQpOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmYwMCwgI2ZmZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwp9CgovKiBTaGltbWVyIG9uIGJhciAqLwoudGVjaC10aW1lci1maWxsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDAuNXMgaW5maW5pdGUgbGluZWFyOwp9CgovKiAtLS0gSFVEIFRPUCAoSEVSQ1VMRUFOIFNDT1JFQk9BUkQpIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDE2MHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4Owp9CgovKiAtLS0gV0lOR1MgKFRlYW0gUGFuZWxzKSAtLS0gKi8KLnNiLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDM1MHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKLnNiLXdpbmcuaG9tZSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICBtYXJnaW4tbGVmdDogMjBweDsKfQoKLnNiLXdpbmcuYXdheSB7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBCYWNrZ3JvdW5kIFNoYXBlICovCi5zYi13aW5nLWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIHotaW5kZXg6IDA7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwogICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgOTAlIDEwMCUsIDAgMTAwJSk7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgewogICAgdHJhbnNmb3JtOiBza2V3WCgyMGRlZyk7CiAgICBib3JkZXItcmlnaHQ6IDRweCBzb2xpZCAjZmY0NDQ0OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCA2OCwgNjgsIDAuMyk7CiAgICBjbGlwLXBhdGg6IHBvbHlnb24oMTAlIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAwIDEwMCUpOwp9CgovKiBDb250ZW50IENvbnRhaW5lciAoQ291bnRlci1za2V3KSAqLwouc2ItY29udGVudC1jb250YWluZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwYWRkaW5nOiAwIDMwcHg7Cn0KCi5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1zdGFydDsKfQoKLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgewogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOyAvKiBDb3VudGVyIHNrZXcgKi8KICAgIGp1c3RpZnktY29udGVudDogZmxleC1lbmQ7Cn0KCi8qIFRlYW0gSW5mbyAqLwouc2ItdGVhbS1pbmZvIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXRlYW0taW5mbyB7CiAgICBhbGlnbi1pdGVtczogZmxleC1lbmQ7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQoKLnNiLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LDI1NSwyNTUsMC41KTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KCi5zYi10ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi10b3A6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIFNjb3JlIFdyYXBwZXIgKi8KLnNiLXNjb3JlLXdyYXBwZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLnNiLXNjb3JlIHsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogI2ZmZjsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB6LWluZGV4OiAyOwp9Cgouc2Itd2luZy5ob21lIC5zYi1zY29yZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjMDBmZmZmIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDAgcmdiYSgwLDAsMCwwLjUpKSBkcm9wLXNoYWRvdygwIDAgMTVweCB2YXIoLS1mZngtY3lhbikpOwogICAgbWFyZ2luLWxlZnQ6IDIwcHg7Cn0KCi5zYi13aW5nLmF3YXkgLnNiLXNjb3JlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNmZmZmZmYgMCUsICNmZjQ0NDQgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggMCByZ2JhKDAsMCwwLDAuNSkpIGRyb3Atc2hhZG93KDAgMCAxNXB4ICNmZjQ0NDQpOwogICAgbWFyZ2luLXJpZ2h0OiAyMHB4Owp9CgovKiBTY29yZSBVcGRhdGUgQW5pbWF0aW9uICovCi5zYi1zY29yZS5zY29yZS11cGRhdGUgewogICAgYW5pbWF0aW9uOiBzY29yZVBvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KTsKfQoKQGtleWZyYW1lcyBzY29yZVBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgZmlsdGVyOiBicmlnaHRuZXNzKDIpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQp9CgovKiBDcnlzdGFsIERlY28gKi8KLnNiLWNyeXN0YWwtZGVjbyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7CiAgICB3aWR0aDogNDBweDsKICAgIGhlaWdodDogNDBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LDI1NSwyNTUsMC44KSAwJSwgcmdiYSgwLDAsMCwwKSA3MCUpOwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7CiAgICB6LWluZGV4OiAzOwogICAgYW5pbWF0aW9uOiBwdWxzZS1nbG93IDNzIGluZmluaXRlOwp9Ci5zYi13aW5nLmhvbWUgLnNiLWNyeXN0YWwtZGVjbyB7IGxlZnQ6IC0xMHB4OyB9Ci5zYi13aW5nLmF3YXkgLnNiLWNyeXN0YWwtZGVjbyB7IHJpZ2h0OiAtMTBweDsgfQoKLyogRW5lcmd5IENvbmR1aXQgKEJhciBhdCBib3R0b20pICovCi5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7CiAgICBoZWlnaHQ6IDRweDsKICAgIHdpZHRoOiA4MCU7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggY3VycmVudENvbG9yOwogICAgei1pbmRleDogMjsKfQouc2Itd2luZy5ob21lIC5zYi1lbmVyZ3ktY29uZHVpdCB7CiAgICBsZWZ0OiAwOwogICAgYmFja2dyb3VuZDogdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMjBkZWcpOwp9Ci5zYi13aW5nLmF3YXkgLnNiLWVuZXJneS1jb25kdWl0IHsKICAgIHJpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIHRyYW5zZm9ybTogc2tld1goMjBkZWcpOwp9CgovKiAtLS0gQ0hST05PU1BIRVJFIChDZW50ZXIgVGltZXIpIC0tLSAqLwouc2ItY2hyb25vc3BoZXJlIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogMTQwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLXRvcDogMTBweDsKfQoKLmNocm9uby1jb3JlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDMwLCA2MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpOwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4zKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLDAsMCwwLjgpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAxMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgouY2hyb25vLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hyb25vLXJpbmcub3V0ZXIgewogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggZGFzaGVkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblNsb3cgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmNocm9uby1yaW5nLm1pZCB7CiAgICB3aWR0aDogMTE1cHg7IGhlaWdodDogMTE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjE1LCAwLCAwLjQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmlnaHQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBhbmltYXRpb246IHNwaW5TbG93IDE1cyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKLmNocm9uby1yaW5nLmlubmVyIHsKICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICBib3JkZXI6IDFweCBkb3R0ZWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOwogICAgYW5pbWF0aW9uOiBzcGluU2xvdyAxMHMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHNwaW5TbG93IHsgdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9IH0KCi5jaHJvbm8tZ2VtIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZiwgMCAwIDIwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgei1pbmRleDogMTU7Cn0KLmNocm9uby1nZW0udG9wIHsgdG9wOiAwOyB9Ci5jaHJvbm8tZ2VtLmJvdHRvbSB7IGJvdHRvbTogMDsgfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgojdGltZXItZGlzcGxheSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGNvbG9yOiAjZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LXdlaWdodDogYm9sZDsKfQoKLyogLS0tIE1PQklMRSBBREpVU1RNRU5UUyBGT1IgSEVSQ1VMRUFOIEhVRCAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEyMHB4OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgIH0KCiAgICAuc2Itd2luZyB7CiAgICAgICAgd2lkdGg6IDEzMHB4OwogICAgICAgIGhlaWdodDogNzBweDsKICAgIH0KICAgIAogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTBkZWcpOyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7IHBhZGRpbmc6IDAgMTBweDsgfQoKICAgIC5zYi10ZWFtLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIC5zYi10ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnNiLXNjb3JlIHsgZm9udC1zaXplOiA0MnB4OyB9CiAgICAuc2Itc2NvcmUtd3JhcHBlciB7IHdpZHRoOiA1MHB4OyB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLXNjb3JlIHsgbWFyZ2luLWxlZnQ6IDVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itc2NvcmUgeyBtYXJnaW4tcmlnaHQ6IDVweDsgfQoKICAgIC5zYi1jaHJvbm9zcGhlcmUgewogICAgICAgIHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7CiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IH0KICAgIC5jaHJvbm8tcmluZy5vdXRlciB7IHdpZHRoOiA4NXB4OyBoZWlnaHQ6IDg1cHg7IH0KICAgIC5jaHJvbm8tcmluZy5taWQgeyB3aWR0aDogNzhweDsgaGVpZ2h0OiA3OHB4OyB9CiAgICAuY2hyb25vLXJpbmcuaW5uZXIgeyB3aWR0aDogNjVweDsgaGVpZ2h0OiA2NXB4OyB9CiAgICAKICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyMHB4OyB9CiAgICAjaGFsZi1pbmRpY2F0b3IgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIAogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KfQovKiAtLS0gUExBWUVSIFNUQVRVUyBQQU5FTCAoTElRVUlEIExJR0hUKSAtLS0gKi8KI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDQwcHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgd2lkdGg6IDIwMHB4OwogICAgcGFkZGluZzogMTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjg1KSAwJSwgcmdiYSgwLCAyMCwgNDAsIDAuNikgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMik7CiAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDAgMTVweCAwIDE1cHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgIC13ZWJraXQtYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIE1hbmFnZWQgYnkgSlMgKi8KICAgIGJveC1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi8qIERlY29yYXRpdmUgYmFja2dyb3VuZCBzaGFyZCAqLwojcGxheWVyLXN0YXR1cy1wYW5lbDo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOyB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0NSUsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMykgNTAlLCB0cmFuc3BhcmVudCA1NSUpOwogICAgYW5pbWF0aW9uOiBzaGltbWVyIDZzIGluZmluaXRlIGxpbmVhcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Cn0KCi5ocC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA2cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQouaHAtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogOHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzMzNDQ1NTsKICAgIG1hcmdpbjogMCA4cHg7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAwIDVweCByZ2JhKDAsMCwwLDAuOCk7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMDBhYTQ0LCAjNDRmZjg4LCAjMDBhYTQ0KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDNzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmNDQ7CiAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwp9Ci5ocC12YWx1ZSB7IAogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7IAogICAgY29sb3I6ICNmZmY7IAogICAgd2lkdGg6IDU1cHg7IAogICAgdGV4dC1hbGlnbjogcmlnaHQ7IAogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyAKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsgCiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOyAKICAgIHdpZHRoOiAyNXB4OyAKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoudGVjaC1iYXItdHJhY2sgewogICAgZmxleC1ncm93OiAxOwogICAgaGVpZ2h0OiA0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQzMzIyOwogICAgbWFyZ2luOiAwIDhweDsKICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjYWE2NjAwLCAjZmZjYzAwLCAjYWE2NjAwKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjAwJSAxMDAlOwogICAgYW5pbWF0aW9uOiBsaXF1aWRGbG93IDRzIGxpbmVhciBpbmZpbml0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKQGtleWZyYW1lcyBsaXF1aWRGbG93IHsKICAgIDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogMTAwJSAwOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1wb3NpdGlvbjogLTEwMCUgMDsgfQp9Ci8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgKEVUSEVSRUFMIElOVEVSRkFDRSkgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTQwcHg7IGhlaWdodDogMTQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBFdGhlcmVhbCBSaW5nICovCiAgICBib3JkZXI6IDFweCBkYXNoZWQgcmdiYSgwLCAyNDIsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMSksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLDAsMCwwKSA2MCUsIHJnYmEoMCwgMjQyLCAyNTUsIDAuMDUpIDEwMCUpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gMTBzIGxpbmVhciBpbmZpbml0ZTsKfQoKI2pveXN0aWNrLWJhc2U6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMCU7IGxlZnQ6IDEwJTsgd2lkdGg6IDgwJTsgaGVpZ2h0OiA4MCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjEpOwogICAgYW5pbWF0aW9uOiBldGhlcmVhbFNwaW4gNXMgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCkBrZXlmcmFtZXMgZXRoZXJlYWxTcGluIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0KfQoKI2pveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIC8qIFB5cmVmbHkgTGlnaHQgKi8KICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmZmZmZiAwJSwgI2EyZjlmZiA0MCUsICMwMGYyZmYgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmMmZmLCAwIDAgMzBweCAjMDBmMmZmOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07CiAgICBvcGFjaXR5OiAwLjg7Cn0KCiNqb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHVsc2UtZ2xvdyAycyBpbmZpbml0ZTsKfQoKLnRvdWNoLXJpcHBsZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDAsIDI0MiwgMjU1LCAwLjUpOwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsKICAgIGFuaW1hdGlvbjogcmlwcGxlQW5pbSAwLjZzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IGJvcmRlci13aWR0aDogNXB4OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgYm9yZGVyLXdpZHRoOiAwcHg7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIChTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp6LWluZGV4OiAxNTAwOwp9Ci5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDIyMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm90dG9tOiAyMHB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgY2VudGVyLCByZ2JhKDAsIDIwLCA2MCwgMC44KSAwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHotaW5kZXg6IC0xOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZGFzaGVkIHJnYmEoMCwgMjQyLCAyNTUsIDAuMyk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMjBzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNDIsIDI1NSwgMC4xKTsKfQouY29tbWFuZC1yaW5nOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0xMHB4OyBsZWZ0OiAtMTBweDsgcmlnaHQ6IC0xMHB4OyBib3R0b206IC0xMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAxcHggZG90dGVkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4yKTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTBzIGxpbmVhciBpbmZpbml0ZSByZXZlcnNlOwp9CgpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBwYWRkaW5nOiA0cHggMTZweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI0MiwgMjU1LCAwLjMpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICB6LWluZGV4OiAyMDsKfQoKLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KLyogLS0tIEFDVElPTiBCVVRUT04gKEhFUkNVTEVBTiBTUEhFUkUgR1JJRCBOT0RFKSAtLS0gKi8KI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDE0MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDEwOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgLyogRGVlcCBTaGFkb3cgJiAzRCBDb250ZXh0ICovCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDMwcHggNjBweCByZ2JhKDAsIDAsIDAsIDAuOSksCiAgICAgICAgMCAwIDAgMnB4IHJnYmEoMCwgMCwgMCwgMS4wKTsKICAgIGJhY2tncm91bmQ6IG5vbmU7CiAgICBib3JkZXI6IG5vbmU7CiAgICBwZXJzcGVjdGl2ZTogMTAwMHB4OwogICAgdHJhbnNmb3JtLXN0eWxlOiBwcmVzZXJ2ZS0zZDsKfQoKI2FjdGlvbi1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7Cn0KCi8qIEtleWZyYW1lcyBmb3IgTGl2aW5nIFVJICovCkBrZXlmcmFtZXMgcmluZy1neXJvLXogewogICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZVooMzYwZGVnKTsgfQp9CgpAa2V5ZnJhbWVzIHJpbmctd29iYmxlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KICAgIDI1JSB7IHRyYW5zZm9ybTogcm90YXRlWCgxMGRlZykgcm90YXRlWSg1ZGVnKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMTBkZWcpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHJvdGF0ZVgoLTEwZGVnKSByb3RhdGVZKDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGVYKDBkZWcpIHJvdGF0ZVkoMGRlZyk7IH0KfQoKQGtleWZyYW1lcyBydW5lLXNwaW4tZ2xvdyB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpIHNjYWxlKDEuMDUpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA4cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdykpOyBvcGFjaXR5OiAxLjA7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAycHggdmFyKC0tZmZ4LWN5YW4pKTsgb3BhY2l0eTogMC44OyB9Cn0KCkBrZXlmcmFtZXMgbGlxdWlkLXN1cmdlLWNvbXBsZXggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAxMDAlIDUwJTsgYm9yZGVyLXJhZGl1czogNDklOyBib3gtc2hhZG93OiAwIDAgNTBweCAjMDBmZmZmLCBpbnNldCAwIDAgNDBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTgpOyBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwJSA1MCU7IGJvcmRlci1yYWRpdXM6IDUwJTsgYm94LXNoYWRvdzogMCAwIDMwcHggIzAwYWFmZiwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOyB9Cn0KCkBrZXlmcmFtZXMgY3J5c3RhbC1icmVhdGhlIHsKICAgIDAlLCAxMDAlIHsgYm9yZGVyLWNvbG9yOiByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOyBib3gtc2hhZG93OiBpbnNldCAwIDAgMjBweCAjMDAwMDAwOyB9CiAgICA1MCUgeyBib3JkZXItY29sb3I6IHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7IGJveC1zaGFkb3c6IGluc2V0IDAgMCAzMHB4ICMwMDExMzMsIDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7IH0KfQoKLyogTGF5ZXIgMTogT3V0ZXIgT3JuYXRlIFJpbmcgKE1ldGFsL0dvbGQpIC0gVGhlIEd5cm8gKi8KLmFiLW91dGVyLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtOHB4OyBsZWZ0OiAtOHB4OyByaWdodDogLThweDsgYm90dG9tOiAtOHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNiODg2MGIsICNmZmQ3MDAsICNmZmZhY2QsICNmZmQ3MDAsICNiODg2MGIsICM4YjQ1MDAsICNiODg2MGIKICAgICk7CiAgICBib3gtc2hhZG93OiAKICAgICAgICBpbnNldCAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCksCiAgICAgICAgMCAwIDI1cHggcmdiYSgyNTUsIDIxNSwgMCwgMC4zKTsKICAgIHotaW5kZXg6IDE7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNTUzMzAwOwogICAgLyogQ29tcGxleCByb3RhdGlvbiAqLwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAyMHMgbGluZWFyIGluZmluaXRlOwp9CgovKiBQc2V1ZG8tZWxlbWVudCBmb3IgM0QgZGVwdGgvd29iYmxlIGVmZmVjdCBvbiB0aGUgcmluZyAqLwouYWItb3V0ZXItcmluZzo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7CiAgICBhbmltYXRpb246IHJpbmctd29iYmxlIDhzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDI6IFJ1bmUgUmluZyAoU3Bpbm5pbmcpICovCi5hYi1ydW5lLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMnB4OyBsZWZ0OiAtMnB4OyByaWdodDogLTJweDsgYm90dG9tOiAtMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiAycHggZGFzaGVkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICAvKiBib3gtc2hhZG93IGhhbmRsZWQgYnkgYW5pbWF0aW9uICovCiAgICB6LWluZGV4OiAyOwogICAgYW5pbWF0aW9uOiBydW5lLXNwaW4tZ2xvdyAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi8qIExheWVyIDM6IElubmVyIENyeXN0YWwgSG91c2luZyAoRGFyayBHbGFzcykgKi8KLmFiLWlubmVyLWNyeXN0YWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA2cHg7IGxlZnQ6IDZweDsgcmlnaHQ6IDZweDsgYm90dG9tOiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOTUpIDYwJSwgIzAwMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAzOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYW5pbWF0aW9uOiBjcnlzdGFsLWJyZWF0aGUgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi8qIExheWVyIDQ6IExpcXVpZCBDb3JlIChBbmltYXRlZCBTdXJmYWNlKSAqLwouYWItbGlxdWlkLWNvcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMnB4OyBsZWZ0OiAxMnB4OyByaWdodDogMTJweDsgYm90dG9tOiAxMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogQ29tcGxleCBHcmFkaWVudCBmb3IgbGlxdWlkIG1vdGlvbiAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCA0MCUgNDAlLCAjMDBmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiAxMDAlKTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTUwJSAxNTAlOwogICAgei1pbmRleDogNDsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKLyogTGlxdWlkIG1vdmVtZW50IGVmZmVjdCAoSW50ZXJuYWwgcmVmbGVjdGlvbikgKi8KLmFiLWxpcXVpZC1jb3JlOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgNTAlIDUwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjUpIDAlLCB0cmFuc3BhcmVudCAyNSUpOwogICAgYW5pbWF0aW9uOiBsaXF1aWRNb3ZlIDVzIGluZmluaXRlIGVhc2UtaW4tb3V0OwogICAgbWl4LWJsZW5kLW1vZGU6IG92ZXJsYXk7Cn0KCi8qIExheWVyIDU6IExpbWl0IEJyZWFrIFJpbmcgKEhpZGRlbiBieSBkZWZhdWx0KSAqLwoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC0yMnB4OyBsZWZ0OiAtMjJweDsgcmlnaHQ6IC0yMnB4OyBib3R0b206IC0yMnB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYm9yZGVyOiA0cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY0NDAwOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogI2ZmYWEwMDsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIDAgNDBweCAjZmY0NDAwOwogICAgei1pbmRleDogMDsKICAgIG9wYWNpdHk6IDA7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAxLjVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgpAa2V5ZnJhbWVzIGxpbWl0U3BpbiB7CiAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpIHNjYWxlKDEpOyBmaWx0ZXI6IGh1ZS1yb3RhdGUoMGRlZyk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogcm90YXRlKDE4MGRlZykgc2NhbGUoMS4xKTsgZmlsdGVyOiBodWUtcm90YXRlKDE1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZykgc2NhbGUoMSk7IGZpbHRlcjogaHVlLXJvdGF0ZSgwZGVnKTsgfQp9CgovKiBMYXllciA2OiBUZXh0IExhYmVsICovCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtc2hhZG93OiAKICAgICAgICAwIDJweCAwICMwMDAsCiAgICAgICAgMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMS4wKSwKICAgICAgICAwIDAgMzBweCAjMDA4OGZmOwogICAgei1pbmRleDogNjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgdG9wOiAxcHg7CiAgICBhbmltYXRpb246IHRleHRGbG9hdCAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB0ZXh0RmxvYXQgewogICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsgfQp9CgovKiBMYXllciA3OiBHbGFyZSAqLwojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC42KSAwJSwgdHJhbnNwYXJlbnQgNDUlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHotaW5kZXg6IDc7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIG1peC1ibGVuZC1tb2RlOiBzb2Z0LWxpZ2h0Owp9CgovKiBTVEFURTogU0hPT1QgTU9ERSAoT3JhbmdlL1JlZCkgKi8KI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYWItb3V0ZXItcmluZyB7CiAgICBiYWNrZ3JvdW5kOiBjb25pYy1ncmFkaWVudCgKICAgICAgICBmcm9tIDBkZWcsCiAgICAgICAgIzhiMDAwMCwgI2ZmNDQwMCwgI2ZmYWEwMCwgI2ZmNDQwMCwgIzhiMDAwMCwgIzQ0MDAwMCwgIzhiMDAwMAogICAgKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1MHB4IHJnYmEoMjU1LCA2OCwgMCwgMC45KTsKICAgIGFuaW1hdGlvbjogcmluZy1neXJvLXogNXMgbGluZWFyIGluZmluaXRlOyAvKiBGYXN0ZXIgc3BpbiAqLwp9CgojYWN0aW9uLWJ1dHRvbi5zaG9vdC1tb2RlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDQwJSA0MCUsICNmZmZmMDAgMCUsICNmZjQ0MDAgNTAlLCAjNjYwMDAwIDEwMCUpOwogICAgYW5pbWF0aW9uOiBjb3JlUHVsc2VSZWQgMC40cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgY29yZVB1bHNlUmVkIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMDsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA4KTsgYm94LXNoYWRvdzogMCAwIDgwcHggI2ZmYWEwMCwgMCAwIDIwcHggI2ZmZjsgZmlsdGVyOiBicmlnaHRuZXNzKDEuMyk7IH0KfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSAuYnRuLXRleHQgewogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDAgIzAwMCwgMCAwIDIwcHggI2ZmNDQwMDsKfQoKLyogU1RBVEU6IExJTUlUIFJFQURZIChIZXJjdWxlYW4gR29sZCkgKi8KI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmxpbWl0LXJpbmcgewogICAgb3BhY2l0eTogMTsKICAgIGJvcmRlci13aWR0aDogNnB4OwogICAgYm9yZGVyLXRvcC1jb2xvcjogI2ZmZjsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6ICNmZmQ3MDA7CiAgICBib3gtc2hhZG93OiAwIDAgNjBweCAjZmZhYTAwLCBpbnNldCAwIDAgMjBweCAjZmY0NDAwOwogICAgYW5pbWF0aW9uOiBsaW1pdFNwaW4gMC44cyBsaW5lYXIgaW5maW5pdGUsIGxpbWl0UHVsc2UgMC4zcyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4ICNmZmZmZmYpOwp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgYm94LXNoYWRvdzogMCAwIDQwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDIwcHggI2ZmYWEwMDsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmFhMDAsIGluc2V0IDAgMCA0MHB4ICNmZmZmMDA7IH0KfQoKI2FjdGlvbi1idXR0b24ubGltaXQtcmVhZHkgLmFiLW91dGVyLXJpbmcgewogICAgYmFja2dyb3VuZDogY29uaWMtZ3JhZGllbnQoCiAgICAgICAgZnJvbSAwZGVnLAogICAgICAgICNmZmQ3MDAsICNmZmZmZmYsICNmZmFhMDAsICNmZmZmZmYsICNmZmQ3MDAsICNiODg2MGIsICNmZmQ3MDAKICAgICk7CiAgICBib3gtc2hhZG93OiAwIDAgODBweCByZ2JhKDI1NSwgMjE1LCAwLCAwLjgpOwogICAgYW5pbWF0aW9uOiByaW5nLWd5cm8teiAycyBsaW5lYXIgaW5maW5pdGU7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYWItcnVuZS1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDQwcHggIzAwZmZmZjsKICAgIGFuaW1hdGlvbjogcnVuZS1zcGluLWdsb3cgM3MgbGluZWFyIGluZmluaXRlIHJldmVyc2U7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgMCUsICNmZmZmMDAgMjAlLCAjZmY4ODAwIDYwJSwgI2ZmMDAwMCAxMDAlKTsKICAgIGFuaW1hdGlvbjogbGlxdWlkLXN1cmdlLWNvbXBsZXggMC41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAuYnRuLXRleHQgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDAwMCwgMCAwIDIwcHggI2ZmZmYwMCwgMCAwIDQwcHggI2ZmZmZmZjsKICAgIGFuaW1hdGlvbjogdGV4dEZsb2F0IDAuMnMgZWFzZS1pbi1vdXQgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgovKiBTVEFURTogQUNUSVZFIChDaGFyZ2luZy9QcmVzc2VkKSAqLwojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsKfQoKI2FjdGlvbi1idXR0b24uYWN0aXZlIC5hYi1saXF1aWQtY29yZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDUwJSA1MCUsICNmZmZmZmYgNDAlLCAjZmZmZmFhIDcwJSwgI2ZmYWEwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA4MHB4ICNmZmZmZmYsIGluc2V0IDAgMCA1MHB4ICNmZmZmZmY7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMi4wKSBjb250cmFzdCgxLjIpOwogICAgYW5pbWF0aW9uOiBub25lOyAvKiBTb2xpZCBpbnRlbnNlIGxpZ2h0ICovCn0KCiNhY3Rpb24tYnV0dG9uLmFjdGl2ZSAuYWItb3V0ZXItcmluZyB7CiAgICBhbmltYXRpb246IHJpbmctZ3lyby16IDAuMnMgbGluZWFyIGluZmluaXRlOyAvKiBIeXBlciBzcGluICovCiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMDBweCAjZmZmZmZmOwp9CgojYWN0aW9uLWJ1dHRvbi5hY3RpdmUgLmxpbWl0LXJpbmcgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwMHB4ICNmZmZmZmY7CiAgICBhbmltYXRpb246IGxpbWl0U3BpbiAwLjFzIGxpbmVhciBpbmZpbml0ZTsKICAgIG9wYWNpdHk6IDE7Cn0KLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKei1pbmRleDogMTUwMDsKfQojYXV0by10b2dnbGU6aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogd2hpdGU7Cn0KI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAoRkFZVEggSU5URVJGQUNFKSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGZsZXgtZW5kOyAvKiBBc3ltbWV0cmljIFJpZ2h0IEFsaWduICovCiAgICBwYWRkaW5nLXJpZ2h0OiAxMCU7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgCiAgICAvKiBEZWVwIFZvaWQgQmFja2dyb3VuZCAqLwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgNTAlLCAjMDUxMDIwIDAlLCAjMDAwMDAwIDEwMCUpOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgovKiBTY2FubGluZXMgJiBWaWduZXR0ZSAqLwoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCgKICAgICAgICAgICAgMGRlZywKICAgICAgICAgICAgdHJhbnNwYXJlbnQgMHB4LAogICAgICAgICAgICB0cmFuc3BhcmVudCAycHgsCiAgICAgICAgICAgIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDIpIDNweCwKICAgICAgICAgICAgcmdiYSgwLCAyNTUsIDI1NSwgMC4wMikgNHB4CiAgICAgICAgKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9Ci5tZW51LWJnLW92ZXJsYXk6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgwLDAsMCwwLjgpIDEwMCUpOwp9CgovKiBMT0dPIFNUWUxJTkcgKi8KLmZmeC1sb2dvLWNvbnRhaW5lciB7CiAgICBtYXJnaW4tYm90dG9tOiA2MHB4OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBtYXJnaW4tcmlnaHQ6IDIwcHg7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNjBweCwgMTJ2dywgMTAwcHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDEwcHg7CiAgICBsaW5lLWhlaWdodDogMC45OwogICAgCiAgICAvKiBDcnlzdGFsIEdyYWRpZW50ICovCiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQ1JSwgIzAwODhmZiA1NSUsICMwMDIyNjYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIAogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsKICAgIGFuaW1hdGlvbjogbG9nb0Zsb2F0IDRzIGVhc2UtaW4tb3V0IGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGxvZ29GbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjYpKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xMHB4KTsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjgpKTsgfQp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNHZ3LCAzMnB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45OwogICAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KCi8qIE1FTlUgT1BUSU9OUyAoQXN5bW1ldHJpYyBMaXN0KSAqLwoubWVudS1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwovKiBNRU5VIE9QVElPTlMgKEFzeW1tZXRyaWMgTGlzdCkgKi8KICAgIHdpZHRoOiA0MDBweDsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LWVuZDsgLyogQWxpZ24gaXRlbXMgdG8gcmlnaHQgKi8KfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHggNDBweCAxNXB4IDIwcHg7CiAgICAKICAgIC8qIEdsYXNzIFNoYXJkIExvb2sgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1yaWdodDogM3B4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgY3Vyc29yOiBwb2ludGVyOwovKiBHbGFzcyBTaGFyZCBMb29rICovCiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICAKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtZW5kOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgyNzBkZWcsIHJnYmEoMCwgMTAwLCAyMDAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1yaWdodDogNjBweDsgLyogU2xpZGUgbGVmdCBlZmZlY3QgKi8KICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMik7Cn0KCi5tZW51LWl0ZW0gLmxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiAjYWFhYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsgLyogQ291bnRlciBza2V3IHRleHQgKi8KICAgIHRyYW5zaXRpb246IGNvbG9yIDAuMnMsIHRleHQtc2hhZG93IDAuMnM7Cn0KCi5tZW51LWl0ZW06aG92ZXIgLmxhYmVsIHsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDg4ZmY7Cn0KCi8qIFBZUkVGTFkgQ1VSU09SICovCi5tZW51LWl0ZW0gLmN1cnNvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICByaWdodDogMTVweDsKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiAjZmZkNzAwOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgb3BhY2l0eTogMDsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDApOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMTBweCAjZmZkNzAwLAogICAgICAgIDAgMCAyMHB4ICNmZmFhMDAsCiAgICAgICAgMCAwIDQwcHggI2ZmNDQwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHJpZ2h0OiAzMHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMSk7CiAgICBhbmltYXRpb246IHB5cmVmbHlXaWdnbGUgMXMgaW5maW5pdGUgZWFzZS1pbi1vdXQ7Cn0KCkBrZXlmcmFtZXMgcHlyZWZseVdpZ2dsZSB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpIHNjYWxlKDEpIHRyYW5zbGF0ZSgwLCAwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBza2V3WCgxNWRlZykgc2NhbGUoMS4yKSB0cmFuc2xhdGUoLTJweCwgLTJweCk7IH0KfQoKLyogUGFydGljbGUgdHJhaWwgZm9yIGN1cnNvciAoUHNldWRvIGVsZW1lbnQpICovCi5tZW51LWl0ZW06aG92ZXIgLmN1cnNvcjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogaW5oZXJpdDsKICAgIG9wYWNpdHk6IDAuNTsKICAgIGFuaW1hdGlvbjogcHlyZWZseVRyYWlsIDFzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHB5cmVmbHlUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDAuNTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMi41KTsgb3BhY2l0eTogMDsgfQp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgcmlnaHQ6IDQwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKfQovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwojZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDUsIDE1LCAwLjkpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwogICAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCiNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgKFNQSEVSRSBQT09MIFRFUk1JTkFMKSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC40KTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDI1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI3ByYWN0aWNlLW92ZXJsYXkuYWN0aXZlIHsKICAgIGRpc3BsYXk6IGZsZXg7Cn0KCi5wcmFjdGljZS1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAzMDBweDsKICAgIAogICAgLyogSG9sb2dyYXBoaWMgR2xhc3MgKi8KICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45NSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTVweCk7CiAgICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cigxNXB4KTsKICAgIAogICAgLyogVGVjaCBTaGFwZSAqLwogICAgY2xpcC1wYXRoOiBwb2x5Z29uKAogICAgICAgIDIwcHggMCwgMTAwJSAwLCAKICAgICAgICAxMDAlIGNhbGMoMTAwJSAtIDIwcHgpLCBjYWxjKDEwMCUgLSAyMHB4KSAxMDAlLCAKICAgICAgICAwIDEwMCUsIDAgMjBweAogICAgKTsKICAgIAogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgCiAgICBib3gtc2hhZG93OiAKICAgICAgICAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLAogICAgICAgIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgICAgIAogICAgcGFkZGluZzogMjBweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgCiAgICAvKiBHcmlkIFBhdHRlcm4gT3ZlcmxheSAqLwogICAgYmFja2dyb3VuZC1pbWFnZTogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KSwKICAgICAgICBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMjBweCAyMHB4OwogICAgCiAgICBhbmltYXRpb246IHBhbmVsRmxvYXQgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgcGFuZWxGbG9hdCB7CiAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01cHgpOyB9Cn0KCi5wYW5lbC1oZWFkZXIgewogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0Owp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgb3BhY2l0eTogMC44Owp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMjBweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgyNTUsIDIwMCwgMCwgMC41KTsKfQoKLmRyaWxsLWxpc3QgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgIGdhcDogOHB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxMHB4IDVweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMjAsIDQwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICM4OGFhY2M7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOCk7CiAgICBib3JkZXItY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiAjZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4yKTsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAxMDAsIDIwMCwgMC44KSAwJSwgcmdiYSgwLCA0MCwgODAsIDAuOCkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiBpbnNldCAwIDAgMTBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgouZHJpbGwtYnRuIC5pY29uIHsKICAgIGRpc3BsYXk6IG5vbmU7IC8qIEhpZGUgaWNvbnMgZm9yIGNsZWFuZXIgZ3JpZCAqLwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDhweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5vcHRpb24tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSk7CiAgICBjb2xvcjogI2ZmZjsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGJvcmRlci1jb2xvcjogIzAwZmYwMDsKICAgIGNvbG9yOiAjZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1MCwgMCwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDAsIDAuMik7Cn0KCi5vcHRpb24tdG9nZ2xlIC5jaGVja2JveCB7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogaW5oZXJpdDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7Cn0KCi5hY3Rpb24tYnRuIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSg1MCwgMCwgMCwgMC42KSwgcmdiYSgyMCwgMCwgMCwgMC44KSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgcGFkZGluZzogOHB4OwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNmZmFhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNjgsIDY4LCAwLjUpOwp9CgojcC1yZXNldC1iYWxsIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA1MCwgMTAwLCAwLjYpLCByZ2JhKDAsIDIwLCA0MCwgMC44KSk7CiAgICBib3JkZXItY29sb3I6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwZmZmZjsKfQojcC1yZXNldC1iYWxsOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICMwMGZmZmY7CiAgICBjb2xvcjogIzAwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuNSk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMjBweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyAKICAgIGhlaWdodDogMDsgCiAgICBib3JkZXItbGVmdDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDE1cHggc29saWQgIzAwZmZmZjsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjODhhYWNjOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNik7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtbWluaW1pemUtYnRuIHsKICAgIHdpZHRoOiAyNHB4OyBoZWlnaHQ6IDI0cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDIycHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWN5YW4pOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgLyogRXRoZXJlYWwgT3JhbmdlIFJpbmcgKi8KICAgIGJvcmRlcjogMXB4IGRhc2hlZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4xKTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwwLDAsMCkgNjAlLCByZ2JhKDI1NSwgMTAwLCAwLCAwLjA1KSAxMDAlKTsKICAgIGFuaW1hdGlvbjogZXRoZXJlYWxTcGluIDEycyBsaW5lYXIgaW5maW5pdGUgcmV2ZXJzZTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAzMHB4OyBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAvKiBGaXJlZmx5IExpZ2h0ICovCiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmYgMCUsICNmZmFhMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggI2ZmNjYwMDsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp6LWluZGV4OiAxNTAwOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7CnotaW5kZXg6IDE1MDA7Cn0KI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJsaW5kIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzMnB4OwogICAgY29sb3I6ICMzMzMzMzM7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwMDAwMCwgMnB4IDJweCAwICMxMTE7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjNjY2IDAlLCAjMDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAycyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2lsZW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBzaGFrZVRlY2ggMC41cyBlYXNlLWluLW91dDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2hpZWxkIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICMwMGZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZjsKICAgIGJvcmRlcjogMnB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNTAsIDEwMCwgMC41KTsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhhc3RlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzNnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZmZmMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICNmZjg4MDA7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xvdyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzZweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBjb2xvcjogIzg4NTUyMjsKICAgIHRleHQtc2hhZG93OiAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogd2l0aGVyU3RhdHVzIDEuNXMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmJ1cm4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmNDQwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMDAwLCAycHggMnB4IDAgIzQ0MDAwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmMDAgMCUsICNmZjAwMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogYnVyblN0YXR1cyAxLjVzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5mcmVlemUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNhYWRkZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogZnJlZXplU3RhdHVzIDIuMHMgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLnNob2NrIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmZmMDAsIDJweCAycHggMCAjODgwMDg4OwogICAgYW5pbWF0aW9uOiBzaG9ja1N0YXR1cyAwLjFzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBidXJuU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSBza2V3WCgwZGVnKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgc2tld1goLTVkZWcpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSkgc2tld1goMGRlZyk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQp9CgpAa2V5ZnJhbWVzIGZyZWV6ZVN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyBmaWx0ZXI6IGJyaWdodG5lc3MoMik7IH0KfQoKQGtleWZyYW1lcyBzaG9ja1N0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDJweCwgMCk7IH0KMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0ycHgsIDApOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KLyogLS0tIE1PQklMRSAmIFJFU1BPTlNJVkUgT1BUSU1JWkFUSU9OUyAtLS0gKi8KCi8qIDEuIENvbXBhY3QgTGFuZHNjYXBlIChNb2JpbGUgSG9yaXpvbnRhbCkgKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG1heC1oZWlnaHQ6IDYwMHB4KSBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIHsKICAgICNodWQtdG9wIHsKICAgICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICAgIHBhZGRpbmc6IDVweCA0MHB4OyAvKiBNb3JlIHNpZGUgcGFkZGluZyB0byBjbGVhciBub3RjaGVzICovCiAgICB9CgogICAgLnNiLXdpbmcgewogICAgICAgIHdpZHRoOiAyMjBweDsKICAgICAgICBoZWlnaHQ6IDcwcHg7CiAgICB9CgogICAgLnNiLXdpbmcuaG9tZSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgfQogICAgLnNiLXdpbmcuYXdheSAuc2Itd2luZy1iZyB7IHRyYW5zZm9ybTogc2tld1goMTVkZWcpOyB9CgogICAgLnNiLXRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMThweDsgfQogICAgLnNiLXRlYW0tc3ViIHsgZm9udC1zaXplOiA4cHg7IGxldHRlci1zcGFjaW5nOiAycHg7IH0KICAgIC5zYi1zY29yZSB7IGZvbnQtc2l6ZTogNDhweDsgfQogICAgCiAgICAuc2ItY2hyb25vc3BoZXJlIHsKICAgICAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICB9CiAgICAuY2hyb25vLWNvcmUgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAuY2hyb25vLXJpbmcub3V0ZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjRweDsgfQogICAgCiAgICAvKiBBZGp1c3QgY29udHJvbHMgZm9yIGxhbmRzY2FwZSAqLwogICAgI2FjdGlvbi1jb250YWluZXIgeyBib3R0b206IDIwcHg7IHJpZ2h0OiAyMHB4OyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IGJvdHRvbSByaWdodDsgfQogICAgI2pveXN0aWNrLWhpdC16b25lIHsgd2lkdGg6IDQwJTsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICAgICAgYm90dG9tOiAyMHB4OyBsZWZ0OiAyMHB4OwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC44KSBza2V3WCgtMTBkZWcpOyB0cmFuc2Zvcm0tb3JpZ2luOiBib3R0b20gbGVmdDsKICAgIH0KfQoKLyogMi4gUG9ydHJhaXQgTW9kZSAoTW9iaWxlIFZlcnRpY2FsKSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSB7CiAgICAjaHVkLXRvcCB7CiAgICAgICAgaGVpZ2h0OiAxNDBweDsKICAgICAgICBwYWRkaW5nOiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKSAxMHB4IDAgMTBweDsKICAgICAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgICAgICBnYXA6IDVweDsKICAgIH0KCiAgICAvKiBXaW5ncyBiZWNvbWUgdG9wIGJhcnMgKi8KICAgIC5zYi13aW5nIHsKICAgICAgICB3aWR0aDogYXV0bzsKICAgICAgICBmbGV4OiAxOwogICAgICAgIGhlaWdodDogODBweDsKICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgYmFja2dyb3VuZDogbm9uZTsgLyogUmVtb3ZlIGRlZmF1bHQgYmcgY29udGFpbmVyICovCiAgICB9CgogICAgLyogQ3VzdG9tIEJHIGZvciBQb3J0cmFpdCBXaW5ncyAqLwogICAgLnNiLXdpbmctYmcgewogICAgICAgIHRyYW5zZm9ybTogc2tld1goMGRlZykgIWltcG9ydGFudDsgLyogUmVtb3ZlIHNrZXcgKi8KICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgMTBweCAxMHB4OwogICAgICAgIGJvcmRlci10b3A6IG5vbmU7CiAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC44KSAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmhvbWUgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItbGVmdDogbm9uZTsgCiAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgICAgICBjbGlwLXBhdGg6IHBvbHlnb24oMCAwLCAxMDAlIDAsIDEwMCUgODAlLCA4NSUgMTAwJSwgMCAxMDAlKTsKICAgIH0KICAgIC5zYi13aW5nLmF3YXkgLnNiLXdpbmctYmcgeyAKICAgICAgICBib3JkZXItcmlnaHQ6IG5vbmU7IAogICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjZmY0NDQ0OwogICAgICAgIGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgMCwgMTAwJSAxMDAlLCAxNSUgMTAwJSwgMCA4MCUpOwogICAgfQoKICAgIC5zYi1jb250ZW50LWNvbnRhaW5lciB7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKSAhaW1wb3J0YW50OwogICAgICAgIHBhZGRpbmc6IDVweDsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB9CiAgICAKICAgIC5zYi13aW5nLmhvbWUgLnNiLWNvbnRlbnQtY29udGFpbmVyIHsgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7IHBhZGRpbmctbGVmdDogMTVweDsgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItY29udGVudC1jb250YWluZXIgeyBhbGlnbi1pdGVtczogZmxleC1lbmQ7IHBhZGRpbmctcmlnaHQ6IDE1cHg7IH0KCiAgICAuc2ItdGVhbS1pbmZvIHsKICAgICAgICBvcmRlcjogMjsKICAgICAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgfQogICAgLnNiLXdpbmcuYXdheSAuc2ItdGVhbS1pbmZvIHsgdGV4dC1hbGlnbjogcmlnaHQ7IH0KCiAgICAuc2ItdGVhbS1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAuc2ItdGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CgogICAgLnNiLXNjb3JlLXdyYXBwZXIgewogICAgICAgIG9yZGVyOiAxOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgIGhlaWdodDogNDBweDsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICB9CiAgICAuc2Itd2luZy5hd2F5IC5zYi1zY29yZS13cmFwcGVyIHsganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsgfQoKICAgIC5zYi1zY29yZSB7CiAgICAgICAgZm9udC1zaXplOiA0OHB4OwogICAgICAgIG1hcmdpbjogMCAhaW1wb3J0YW50OwogICAgICAgIGxpbmUtaGVpZ2h0OiAwLjg7CiAgICB9CgogICAgLnNiLWNyeXN0YWwtZGVjbyB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIC5zYi1lbmVyZ3ktY29uZHVpdCB7IGRpc3BsYXk6IG5vbmU7IH0KCiAgICAvKiBDaHJvbm9zcGhlcmUgQ29tcGFjdCAqLwogICAgLnNiLWNocm9ub3NwaGVyZSB7CiAgICAgICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgICAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICAgICAgei1pbmRleDogMTIwMDsKICAgIH0KICAgIC5jaHJvbm8tY29yZSB7IHdpZHRoOiA3MHB4OyBoZWlnaHQ6IDcwcHg7IGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDIwLCAwLjk1KTsgfQogICAgLmNocm9uby1yaW5nLm91dGVyIHsgd2lkdGg6IDg1cHg7IGhlaWdodDogODVweDsgb3BhY2l0eTogMC40OyB9CiAgICAuY2hyb25vLXJpbmcubWlkIHsgZGlzcGxheTogbm9uZTsgfSAvKiBTaW1wbGlmeSAqLwogICAgLmNocm9uby1yaW5nLmlubmVyIHsgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsgfQogICAgCiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjBweDsgfQogICAgI2hhbGYtaW5kaWNhdG9yIHsgZm9udC1zaXplOiAxMHB4OyBtYXJnaW4tYm90dG9tOiAwOyB9CgogICAgLyogVUkgUmVwb3NpdGlvbmluZyBmb3IgUG9ydHJhaXQgKi8KICAgICNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICAgICAgdG9wOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDE0MHB4KTsKICAgICAgICByaWdodDogMTBweDsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IHRyYW5zZm9ybS1vcmlnaW46IHRvcCByaWdodDsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgICAgICB0b3A6IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTQwcHgpOwogICAgICAgIGxlZnQ6IDEwcHg7CiAgICB9CgogICAgI3BsYXllci1zdGF0dXMtcGFuZWwgewogICAgICAgIGJvdHRvbTogbWF4KDE4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICAgICAgbGVmdDogMTBweDsKICAgICAgICB3aWR0aDogMTYwcHg7CiAgICAgICAgdHJhbnNmb3JtOiBza2V3WCgwZGVnKTsgLyogUmVtb3ZlIHNrZXcgZm9yIHJlYWRhYmlsaXR5IG9uIG5hcnJvdyBzY3JlZW5zICovCiAgICB9CiAgICAuY2hhci1uYW1lLCAuaHAtZ2F1Z2UtY29udGFpbmVyLCAudGVjaC1nYXVnZS1jb250YWluZXIgeyB0cmFuc2Zvcm06IHNrZXdYKDBkZWcpOyB9CgogICAgLyogQ29udHJvbHMgKi8KICAgICNhY3Rpb24tY29udGFpbmVyIHsKICAgICAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsgdHJhbnNmb3JtLW9yaWdpbjogYm90dG9tIHJpZ2h0OwogICAgfQogICAgCiAgICAjdGFja2xlLWJ1dHRvbiB7CiAgICAgICAgYm90dG9tOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsKICAgICAgICByaWdodDogbWF4KDE0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB9CgogICAgI2pveXN0aWNrLWhpdC16b25lIHsKICAgICAgICBoZWlnaHQ6IDQwJTsKICAgICAgICBib3R0b206IDA7CiAgICB9CiAgICAKICAgIC8qIFNldHRpbmdzICYgQXV0byBCdXR0b25zICovCiAgICAjYXV0by10b2dnbGUgewogICAgICAgIHRvcDogbWF4KDIyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAyMDBweCk7CiAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgd2lkdGg6IDkwcHg7CiAgICB9CiAgICAjc2V0dGluZ3MtYnV0dG9uIHsKICAgICAgICB0b3A6IG1heCgyNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjQwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQogICAgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB0b3A6IG1heCgyMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMjAwcHgpOwogICAgICAgIHJpZ2h0OiAxMHB4OwogICAgICAgIHdpZHRoOiA5MHB4OwogICAgfQoKICAgIC8qIE1lbnVzICovCiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDEwMCU7IHBhZGRpbmctcmlnaHQ6IDIwcHg7IH0KICAgIC5mZngtbG9nby1tYWluIHsgZm9udC1zaXplOiA2MHB4OyB9CiAgICAKICAgIC8qIFNldHRpbmdzICovCiAgICAjc2V0dGluZ3MtcGFuZWwgeyB3aWR0aDogOTAlOyB9CiAgICAKICAgIC8qIFByYWN0aWNlICovCiAgICAucHJhY3RpY2UtcGFuZWwgeyB3aWR0aDogOTUlOyByaWdodDogMi41JTsgdG9wOiAxMjBweDsgfQogICAgCiAgICAvKiBBbm5vdW5jZW1lbnRzICovCiAgICAjYW5ub3VuY2VtZW50IHsKICAgICAgICBmb250LXNpemU6IDQ4cHg7CiAgICAgICAgdG9wOiAzNSU7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogNjRweCAhaW1wb3J0YW50OwogICAgfQp9","AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","./AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","/AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CnRoaXMuYWNjZWxlcmF0aW9uID0gMTguMDsgLy8gU25hcHBpZXIgbW92ZW1lbnQgKHdhcyAxMi4wKQogICAgICAgICAgICB0aGlzLmRyYWcgPSAzLjA7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA4LjA7CiAgICAgICAgICAgIC8vIEJvbmUgcmVmZXJlbmNlIGZvciBob2xkaW5nIGJhbGwKICAgICAgICAgICAgdGhpcy5oYW5kQm9uZSA9IG51bGw7CiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgYW5pbWF0aW9uIGJvbmUgcmVmcyAoZmlsbGVkIGluIHNldE1lc2gpCiAgICAgICAgICAgIHRoaXMuYm9uZXMgPSB7CiAgICAgICAgICAgICAgICBoaXBzOiBudWxsLAogICAgICAgICAgICAgICAgc3BpbmU6IG51bGwsCiAgICAgICAgICAgICAgICBjaGVzdDogbnVsbCwKICAgICAgICAgICAgICAgIG5lY2s6IG51bGwsCiAgICAgICAgICAgICAgICBoZWFkOiBudWxsLAogICAgICAgICAgICAgICAgclVwcGVyQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckZvcmVBcm06IG51bGwsCiAgICAgICAgICAgICAgICBySGFuZDogbnVsbCwKICAgICAgICAgICAgICAgIGxVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgbEhhbmQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5fYm9uZUJhc2VRdWF0cyA9IG51bGw7IC8vIE9wdGlvbmFsIGZ1dHVyZSB1c2UKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0sCiAgICAgICAgICAgICAgICBibGluZDogMCwKICAgICAgICAgICAgICAgIHNpbGVuY2U6IDAsCiAgICAgICAgICAgICAgICBzaGllbGQ6IDAsCiAgICAgICAgICAgICAgICBoYXN0ZTogMCwKICAgICAgICAgICAgICAgIHNsb3c6IDAsCiAgICAgICAgICAgICAgICBidXJuOiAwLAogICAgICAgICAgICAgICAgc2hvY2s6IDAKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107Cgp0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbiA9IG51bGw7IC8vIHsgdHlwZTogJ2ZpcmUnfCdpY2UnfCd2b2x0JywgZHVyYXRpb246IG51bWJlciB9CgogICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgIHRoaXMuYmFzZUNvbG9ySGV4ID0gMHhmZmZmZmY7CiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25PZmZzZXQgPSAwOwogICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSA9IDEuMTc7IC8vIEluY3JlYXNlZCB+OCUKCiAgICAgICAgICAgIC8vIFJlYWwtdGltZSBTdGF0cwogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuc3RhdHMuRU47CiAgICAgICAgICAgIHRoaXMudGFja2xlUmFkaXVzID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMi41IHRvIHJlZHVjZSBzd2FybSBsb2NrCgogICAgICAgICAgICB0aGlzLnNwZWVkID0gNC4wOwogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIERhc2ggU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFRvdGFsVGltZSA9IDAuNTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gRmVlZGJhY2sgQWNjdW11bGF0b3JzCiAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgdGhpcy5fZGFtYWdlVGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gSFAgQmFyCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBudWxsOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbCA9IG51bGw7CgogICAgICAgICAgICAvLyBHYW1lcGxheSBGbG93IFRpbWVycwogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBCYW5raW5nICYgVmVydGljYWxpdHkKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZID0gMDsKCiAgICAgICAgICAgIC8vIEVuY291bnRlciBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSBmYWxzZTsKdGhpcy5jbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMCwKICAgICAgICAgICAgICAgIGJsaW5kOiAwLAogICAgICAgICAgICAgICAgc2lsZW5jZTogMCwKICAgICAgICAgICAgICAgIHNoaWVsZDogMCwKICAgICAgICAgICAgICAgIGhhc3RlOiAwLAogICAgICAgICAgICAgICAgc2xvdzogMCwKICAgICAgICAgICAgICAgIGJ1cm46IDAsCiAgICAgICAgICAgICAgICBzaG9jazogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyID0gMDsgLy8gVGltZXIgZm9yIHN3aW0gc291bmQgZWZmZWN0cwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zbG93ID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2xvdywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSAwOyAvLyBPdmVyd3JpdGUgaGFzdGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMT1ciLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnVybicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJ1cm4gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5idXJuLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCVVJOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2NrJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hvY2sgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zaG9jaywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hPQ0siLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwp0aGlzLm1heFNwZWVkID0gNi4wICsgKHNwIC8gMTUuMCk7IC8vIEluY3JlYXNlZCBiYXNlIHNwZWVkICh3YXMgNS4wKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICB9CgogICAgICAgIHNldE1lc2goc291cmNlTWVzaCwgYW5pbWF0aW9ucykgewogICAgICAgICAgICB0aGlzLm1lc2ggPSBzb3VyY2VNZXNoOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwp0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVTdGF0dXNSaW5nKCk7IC8vIE5FVzogU3RhdHVzIFJpbmcKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQXVyYSgpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVBdXJhKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBDaGFyYWN0ZXIgU2NhbGluZwogICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNjsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgdGhpcy5iYXNlU2NhbGUgPSAxLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgdGhpcy5tZXNoLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2ggJiYgbm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gKG5vZGUubmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29yZSBzcGluZS9oZWFkIGNoYWluIChNaXhhbW8tZnJpZW5kbHkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhpcHMgJiYgbmFtZS5pbmNsdWRlcygnaGlwcycpKSB0aGlzLmJvbmVzLmhpcHMgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5zcGluZSAmJiBuYW1lLmluY2x1ZGVzKCdzcGluZScpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZTInKSAmJiAhbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSB0aGlzLmJvbmVzLnNwaW5lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuY2hlc3QgJiYgKG5hbWUuaW5jbHVkZXMoJ2NoZXN0JykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmUyJykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSkgdGhpcy5ib25lcy5jaGVzdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLm5lY2sgJiYgbmFtZS5pbmNsdWRlcygnbmVjaycpKSB0aGlzLmJvbmVzLm5lY2sgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5oZWFkICYmIG5hbWUuaW5jbHVkZXMoJ2hlYWQnKSkgdGhpcy5ib25lcy5oZWFkID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNSaWdodCA9IG5hbWUuaW5jbHVkZXMoJ3JpZ2h0JykgfHwgbmFtZS5lbmRzV2l0aCgncicpIHx8IG5hbWUuaW5jbHVkZXMoJ19yJykgfHwgbmFtZS5pbmNsdWRlcygnLnInKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0xlZnQgID0gbmFtZS5pbmNsdWRlcygnbGVmdCcpICB8fCBuYW1lLmVuZHNXaXRoKCdsJykgfHwgbmFtZS5pbmNsdWRlcygnX2wnKSB8fCBuYW1lLmluY2x1ZGVzKCcubCcpOwoKICAgICAgICAgICAgICAgICAgICAvLyBBcm1zL2hhbmRzIChNaXhhbW86IG1peGFtb3JpZ1JpZ2h0QXJtL1JpZ2h0Rm9yZUFybS9SaWdodEhhbmQpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnJVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRhcm0nKSB8fCAoaXNSaWdodCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMuclVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ3JpZ2h0Zm9yZWFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ2ZvcmVhcm0nKSkpKSB0aGlzLmJvbmVzLnJGb3JlQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckhhbmQgJiYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgaXNSaWdodCkgfHwgbmFtZS5pbmNsdWRlcygncmlnaHRoYW5kJykpKSB0aGlzLmJvbmVzLnJIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygnbGVmdGFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygndXBwZXJhcm0nKSkpKSB0aGlzLmJvbmVzLmxVcHBlckFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxGb3JlQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0Zm9yZWFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMubEZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5sSGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc0xlZnQpIHx8IG5hbWUuaW5jbHVkZXMoJ2xlZnRoYW5kJykpKSB0aGlzLmJvbmVzLmxIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQmFjay1jb21wYXQ6IGJhbGwgYXR0YWNobWVudCB1c2VzIGhhbmRCb25lCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhbmRCb25lICYmIHRoaXMuYm9uZXMuckhhbmQpIHRoaXMuaGFuZEJvbmUgPSB0aGlzLmJvbmVzLnJIYW5kOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIGlmIChhbmltYXRpb25zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBfbm9ybUNsaXBOYW1lID0gKHMpID0+IChzIHx8ICcnKQogICAgICAgICAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tfXC1dKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xzKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnRyaW0oKTsKCiAgICAgICAgICAgICAgICAvLyBIZWxwZXIgdG8gc3RyaXAgbGVnIHRyYWNrcyBmcm9tIGFjdGlvbiBjbGlwcwogICAgICAgICAgICAgICAgY29uc3QgX3N0cmlwTGVncyA9IChjbGlwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tzID0gW107CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVnZXggdG8gbWF0Y2ggbGVnIGJvbmVzIChNaXhhbW8gc3R5bGU6IFJpZ2h0VXBMZWcsIFJpZ2h0TGVnLCBSaWdodEZvb3QsIFJpZ2h0VG9lQmFzZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBnZW5lcmljICJMZWciLCAiRm9vdCIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0Lm5hbWUubWF0Y2goLyhVcExlZ3xMZWd8Rm9vdHxUb2UpL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja3MucHVzaCh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGNsaXAudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGlwOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBhbmltYXRpb25zLmZvckVhY2goKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gX25vcm1DbGlwTmFtZShjbGlwLm5hbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsZXQgaXNMb2NvbW90aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGlvbktleSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDb3JlIGxvY29tb3Rpb24gLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvdHJlYWR8dHJlYWRpbmd8aWRsZXxmbG9hdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvZGFzaHxzcHJpbnR8YnVyc3R8ZmFzdFxzKnN3aW18c3dpbVxzKmZhc3QvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnZGFzaCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3N3aW0nOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIGFjdGlvbktleSA9ICd0aHJvd19zaG90JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzKC9wYXNzLykpIGFjdGlvbktleSA9ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAndGhyb3cnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIGFjdGlvbktleSA9ICdjYXRjaF9qdW1wJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAnY2F0Y2gnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gSGl0IC8gUmVhY3QgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3JlYWN0fGhpdHxodXJ0fGRhbWFnZXxzdGFnZ2VyfGtub2NrLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3JlYWN0JzsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjaGFyZ2UnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90YWNrbGV8Y2hlY2t8cmFtLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3RhY2tsZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Jsb2NrfHNhdmUvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjZWxlYnJhdGUnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9IGNsaXAubmFtZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFN0cmlwIGxlZ3MgZnJvbSBub24tbG9jb21vdGlvbiBjbGlwcyB0byBhbGxvdyB0cmVhZGluZyB3YXRlciBvdmVybGF5CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0xvY29tb3Rpb24gJiYgYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zdHJpcExlZ3MoY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1thY3Rpb25LZXldID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdGFydCBkZWZhdWx0IGxvY29tb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uc1snaWRsZSddKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKCdpZGxlJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjawogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbGlzdGVuZXIKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIuYWRkRXZlbnRMaXN0ZW5lcignZmluaXNoZWQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5hY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgZmluaXNoZWQgYWN0aW9uIGlzIG91ciBjdXJyZW50IG9uZS1zaG90CiAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWN0aW9uID09PSB0aGlzLmFjdGl2ZU9uZVNob3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gbG9jb21vdGlvbiB1cGRhdGVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbSgwLjE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBOZXcgbWV0aG9kIGZvciBiYXNlIGxheWVyIChsZWdzL2JvZHkgbW92ZW1lbnQpCiAgICAgICAgcGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgY29uc3QgbmV3QWN0aW9uID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIW5ld0FjdGlvbiB8fCBuZXdBY3Rpb24gPT09IHRoaXMuYWN0aXZlTG9jb21vdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlTG9jb21vdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uLmZhZGVPdXQoZHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbihkdXJhdGlvbik7CiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlTG9jb21vdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5fbGFzdExvY29tb3Rpb24gPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgLy8gT3ZlcmhhdWxlZCBwbGF5IG1ldGhvZCB0byBoYW5kbGUgbGF5ZXJpbmcKICAgICAgICBwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIC8vIElmIGl0J3MgYSBsb2NvbW90aW9uIHN0YXRlLCByb3V0ZSB0byBwbGF5TG9jb21vdGlvbgogICAgICAgICAgICBpZiAoWydpZGxlJywgJ3N3aW0nLCAnZGFzaCddLmluY2x1ZGVzKGFjdGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHRyZWF0IGFzIGFuIGFjdGlvbiBsYXllcgogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGFuIGFjdGl2ZSBvbmUtc2hvdCwgZmFkZSBpdCBvdXQKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlT25lU2hvdCAmJiB0aGlzLmFjdGl2ZU9uZVNob3QgIT09IG5ld0FjdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90LmZhZGVPdXQoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oMC4xKTsgLy8gRmFzdCB0cmFuc2l0aW9uIGZvciBhY3Rpb25zCiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QgPSBuZXdBY3Rpb247CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUxvY29tb3Rpb25BbmltKGR1cmF0aW9uID0gMC4yKSB7CiAgICAgICAgICAgIC8vIE5vdGU6IFdlIE5PIExPTkdFUiBjaGVjayBfYW5pbUxvY2tlZCBoZXJlLgogICAgICAgICAgICAvLyBMb2NvbW90aW9uIHNob3VsZCB1cGRhdGUgY29udGludW91c2x5IGJhc2VkIG9uIHNwZWVkLCAKICAgICAgICAgICAgLy8gcnVubmluZyB1bmRlcm5lYXRoIHRoZSB1cHBlciBib2R5IGFjdGlvbi4KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KHZ4ICogdnggKyB2eiAqIHZ6KTsKCiAgICAgICAgICAgIC8vIFNtb290aCBzcGVlZAogICAgICAgICAgICBjb25zdCBzbW9vdGhLID0gMS4wIC0gTWF0aC5wb3coMC4wMDEsIGR1cmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCArPSAoc3BlZWQgLSB0aGlzLl9zbW9vdGhlZFNwZWVkKSAqIHNtb290aEs7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXMKICAgICAgICAgICAgY29uc3QgZW50ZXJNb3ZlID0gMC4xODsKICAgICAgICAgICAgY29uc3QgZXhpdE1vdmUgPSAwLjEwOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRNb3ZpbmcgPSB0aGlzLmlucHV0VmVjdG9yICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMDY7CiAgICAgICAgICAgIGNvbnN0IHZlbE1vdmluZyA9IHRoaXMuX3Ntb290aGVkU3BlZWQgPiAodGhpcy5fbW92aW5nTGF0Y2ggPyBleGl0TW92ZSA6IGVudGVyTW92ZSk7CgogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGlucHV0TW92aW5nIHx8IHZlbE1vdmluZzsKCiAgICAgICAgICAgIGxldCB0YXJnZXQgPSB0aGlzLl9tb3ZpbmdMYXRjaCA/ICdzd2ltJyA6ICdpZGxlJzsKICAgICAgICAgICAgaWYgKHRoaXMuX21vdmluZ0xhdGNoICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBVcGRhdGUgcGxheWJhY2sgcmF0ZQogICAgICAgICAgICBjb25zdCBhcHBseVJhdGUgPSAoa2V5KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKCiAgICAgICAgICAgICAgICAvLyBIYXN0ZS9TbG93IEFuaW1hdGlvbiBTY2FsaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSBhLnRpbWVTY2FsZSAqPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2xvdyA+IDApIGEudGltZVNjYWxlICo9IDAuNjsKfTsKCmFwcGx5UmF0ZSh0YXJnZXQpOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKfQoKICAgICAgICBwbGF5T25lU2hvdChhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuMSwgb3B0cyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gYWN0aW9uTmFtZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnRpbWVTY2FsZSA9IChvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICB9IGNhdGNoIChfKSB7fQoKICAgICAgICAgICAgLy8gVXNlIHRoZSBuZXcgcGxheSBtZXRob2Qgd2hpY2ggaGFuZGxlcyBsYXllcmluZwogICAgICAgICAgICB0aGlzLnBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHNldElucHV0KHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KHgsIDAsIHopOwogICAgICAgIH0KYXBwbHlFeHRlcm5hbEZvcmNlKHZlYykgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHZlYyk7CiAgICAgICAgfQogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIFNuYXBwaWVyIHRocm93czogRHJhc3RpY2FsbHkgcmVkdWNlZCB3aW5kdXAgdGltZXMgZm9yIGluc3RhbnQgcmVzcG9uc2UKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAyMDsgCiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAzLjA7IAoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSA2MDsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSA1LjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDI1MDsgCiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CmNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKLy8gQmxpbmQgUmFuZG9taXphdGlvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5ibGluZCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC40OwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICB9CgpmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRUxFTUVOVEFMIElORlVTSU9OIElOSkVDVElPTgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uICYmIHRoaXMuZWxlbWVudGFsSW5mdXNpb24uZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGVjaFBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHRlY2ggc2VsZWN0ZWQsIGluZnVzaW9uIGJlY29tZXMgdGhlIHRlY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGUsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24odGhpcy5lbGVtZW50YWxJbmZ1c2lvbi50eXBlLnRvVXBwZXJDYXNlKCkgKyAiIFNIT1QiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0ZWNoIGV4aXN0cyAoZS5nLiBKZWNodCBTaG90KSwgYWRkIGVsZW1lbnQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTT1VORDogQ2hhcmdlIFVwCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gVXNlIGEgc3ludGhlc2l6ZWQgY2hhcmdlIHNvdW5kIGlmICdjaGFyZ2UnIHNmeCBpc24ndCBsb2FkZWQKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnY2hhcmdlJywgeyB2b2x1bWU6IDAuNCwgcmF0ZTogMS4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVJbnB1dCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQb3dlciBDYWxjdWxhdGlvbgogICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7fTsKCiAgICAgICAgICAgIC8vIEJhc2UgbXVsdGlwbGllciAoZGVmYXVsdHM6IDEuMCB0byAxLjgpCiAgICAgICAgICAgIGxldCBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX0JBU0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX0JBU0UgOiAxLjApICsgKHJhdGlvICogKFRDLlBPV0VSX1JBTkdFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9SQU5HRSA6IDAuOCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRGV0ZWN0IExPQiAoVmVydGljYWwgVXAgU3dpcGUpCi8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQogICAgICAgICAgICBsZXQgaXNMb2IgPSBmYWxzZTsKICAgICAgICAgICAgLyogRElTQUJMRUQ6IFVzZXIgZmVlZGJhY2sgaW5kaWNhdGVzIGFjY2lkZW50YWwgdHJpZ2dlcnMgcHJldmVudGluZyBmb3J3YXJkIHRocm93cy4KICAgICAgICAgICAgaWYgKGR5IDwgLTgwICYmIE1hdGguYWJzKGR4KSA8IE1hdGguYWJzKGR5KSAqIDAuNikgewogICAgICAgICAgICAgICAgaXNMb2IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMT0IhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICovCgogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIC8vIEZvcm11bGE6IEN1cnZlID0gSW50ZW5zaXR5ICogU3BlZWQKICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChUQy5DVVJWRV9FTkFCTEVEICE9PSBmYWxzZSkgJiYgY3VydmVJbnB1dCAmJiBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSkgPiAoVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCA6IDAuMjUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXdJbnRlbnNpdHkgPSBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsgLy8gUG9zaXRpdmUgPSBSaWdodCBIdW1wID0gTGVmdCBDdXJ2ZQogICAgICAgICAgICAgICAgY29uc3Qgc3dpcGVTcGVlZCA9IGN1cnZlSW5wdXQuc3BlZWQgfHwgMS4wOwoKICAgICAgICAgICAgICAgIC8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoc3Bpbk1hZyA+IChUQy5DVVJWRV9QRVJGRUNUX1NQSU4gIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiA6IDUwMC4wKSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiUEVSRkVDVCBDVVJWRSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkUm9sbEltcHVsc2Uoc2lnbiAqIC0wLjMpOyAvLyBUaWx0IGNhbWVyYSBpbnRvIHRoZSBjdXJ2ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90R29hbCA9IGFpbVZlYy5kb3QoZ29hbERpcik7CgpsZXQgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIGlmIChpc0xvYikgewogICAgICAgICAgICAgICAgdHlwZSA9ICdMT0InOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUsIG11bHRpcGxpZXIsIHNwaW5WZWMpOwogICAgICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbChjb29sZG93biA9IDEuMCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmZvcmNlIGNvb2xkb3duIHRvIHByZXZlbnQgaW5zdGFudCByZS1ncmFiCiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IGNvb2xkb3duOwogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNhZmV0eTogTmFOIENoZWNrCiAgICAgICAgICAgIGlmIChpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueCkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnkpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi56KSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJQbGF5ZXIgcG9zaXRpb24gTmFOIGRldGVjdGVkLiBSZXNldHRpbmcuIiwgdGhpcy5yb2xlKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uIHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU1lOQyBGSVg6IElmIGJhbGwgdGhpbmtzIEkgaG9sZCBpdCwgYnV0IEkgZG9uJ3QsIGZvcmNlIHJlY2VpdmUKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyID09PSB0aGlzICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3luY2luZyBiYWxsIHBvc3Nlc3Npb24gdG8gcGxheWVyIik7CiAgICAgICAgICAgICAgICB0aGlzLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmlzR29kTW9kZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYyAoUGh5c2ljcyBwYXJ0IC0gVGltZXIpCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgcGh5c2ljcyBwcm9wcyB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBhbHRlcmVkCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIHJlc2V0IGhhcHBlbnMgaW4gdXBkYXRlVmlzdWFscwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyZ2VUaW1lID4gMy4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZUNoYXJnZSgwLCAwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuZXZhZGVDb29sZG93biA+IDApIHRoaXMuZXZhZGVDb29sZG93biAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duIDw9IDApIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFdmFzaW9uIExvZ2ljIChTcGluIE1vdmUpCiAgICAgICAgICAgIGlmICh0aGlzLmlzRXZhZGluZykgewogICAgICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdmlzdWFsIGhhbmRsZWQgaW4gdXBkYXRlVmlzdWFscywgYnV0IHdlIGFwcGx5IG1vdmVtZW50IGhlcmUKICAgICAgICAgICAgICAgIC8vIEZyaWN0aW9ubGVzcyBtb3ZlbWVudCBkdXJpbmcgZXZhZGUKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBkcmFnCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTUpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0V2YWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNSk7IC8vIFNsb3cgZG93biBhZnRlciBzcGluCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47IC8vIFNraXAgbm9ybWFsIHBoeXNpY3MKICAgICAgICAgICAgfQoKLy8gVGFja2xlIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAvLyBBdXRvLXJlbGVhc2UgaWYgaGVsZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGFja2xlQ2hhcmdlVGltZSA+IHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSArIDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZVRhY2tsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFRBQ0tMRSBTVEFURSAoU2xpZGUgJiBDb21taXQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3M6IEhpZ2ggRHJhZyAoU2xpZGUgdG8gc3RvcCkKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDMuMCAqIGR0KSkpOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKCiAgICAgICAgICAgICAgICAvLyBDb2xsaXNpb24gQ2hlY2sKICAgICAgICAgICAgICAgIC8vIENvbGxpc2lvbiBDaGVjawogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjU7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS42OyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7Cl9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFkgcG9zaXRpb24gY2FsY3VsYXRpb24gaXMgdmlzdWFsL3BoeXNpY3MgaHlicmlkLCBrZWVwaW5nIGhlcmUgZm9yIGNvbGxpc2lvbiBjb25zaXN0ZW5jeQogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5QXJlbmFCb3VuZGFyeShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gT3JwaGFuZWQgZWxzZSBibG9jayByZW1vdmVkCgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOyAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7Ci8vIFZlcnRpY2FsIERyYWcgKEVudmlyb25tZW50IGF3YXJlKQogICAgICAgICAgICBjb25zdCB2RHJhZyA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIpIAogICAgICAgICAgICAgICAgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSICogOC4wIAogICAgICAgICAgICAgICAgOiAyLjA7CnRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAodkRyYWcgKiBkdCkpOwogICAgICAgIH0KICAgIH0KICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbShkdCk7IC8vIEFuaW1hdGlvbiBzdGF0ZSBsb2dpYyBkcml2ZW4gYnkgcGh5c2ljcyBzdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDAgJiYgdGhpcy5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExldml0YXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGFrZSA9IDAuMDUgKyAoMC4xICogcmF0aW8pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscyBpZiBjaGFyZ2UgY2FuY2VsbGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBEYXNoIFZpc3VhbHMgKFBhcnRpY2xlcyAmIExlYW4pCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2subGVuZ3RoU3EoKSA8IDAuMSkgYmFjay5zZXQoMCwgMCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMi4wICsgTWF0aC5yYW5kb20oKSwgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LCBtb21lbnR1bVNjYWxlOiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KCl9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucm90YXRpb24ueSArPSAyNS4wICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyYWlsCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMS4wLCBsaWZlOiAwLjIgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBUYWNrbGUgQ2hhcmdlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLnRhY2tsZUNoYXJnZVRpbWUgLyB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAvLyBTaGFrZSBtZXNoCi8vIFJlZCB0aW50IHB1bHNlCiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAyKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweGZmMDAwMCksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIEhFUkNVTEVBTjogR2F0aGVyIFBhcnRpY2xlcwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjMpIHsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGluIGEgc3BoZXJlIGFyb3VuZCBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IE1hdGguYWNvcygyICogTWF0aC5yYW5kb20oKSAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gciAqIE1hdGguc2luKHBoaSkgKiBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguc2luKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IHIgKiBNYXRoLmNvcyhwaGkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoeCwgeSArIDEuMCwgeikpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4wLCAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSB0b3dhcmRzIGNlbnRlcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2ZWwgPSBjZW50ZXJQb3Muc3ViKHNwYXduUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig0LjApOyAvLyBTdWNrIGluIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZ2F0aGVyJywgc3Bhd25Qb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogdmVsLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LApjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQplbHNlIGlmICh0aGlzLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgLy8gUmVzZXQgY29sb3IgaWYgbm90IGNoYXJnaW5nL2Rhc2hpbmcvZmxhc2hpbmcvYmxvY2tpbmcKICAgICAgICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdHVuL05hcCBWaXN1YWwgUmVzZXQKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcpIHRoaXMucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgIH0KCnRoaXMuX3VwZGF0ZUhQQmFyKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzUmluZyhkdCk7IC8vIE5FVzogVXBkYXRlIFJpbmcKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDEuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICAgICAgICAgIG9mZnNldC55ID0gMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGUnLCB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4yNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjIKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbU9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjUgKyBNYXRoLnJhbmRvbSgpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnkgPSAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuODsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3dpbSBTb3VuZCBFZmZlY3QgTG9naWMKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAyLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ3N3aW0nICYmICF0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N3aW1TZnhUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYXkgc3dpbSBzb3VuZCB3aXRoIHNsaWdodCBwaXRjaCB2YXJpYW5jZQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC4zLCB2YXJpYW5jZTogMC4yIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB0aW1lciAoMC40cyB0byAwLjdzIGludGVydmFsKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3N3aW1TZnhUaW1lciA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zd2ltU2Z4VGltZXIgPSAwOyAvLyBSZXNldCBpZiBzdG9wcGVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KICAgICAgICBfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgICAgICAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lICs9IGR0OwoKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuYm9uZXM7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKCiAgICAgICAgICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gQnVpbGQgYSBkZXNpcmVkIHdvcmxkLXNwYWNlIGRpcmVjdGlvbiB3ZSB3YW50IHRoZSB0b3Jzby9oZWFkIHRvIGJpYXMgdG93YXJkLgogICAgICAgICAgICAvLyBOT1RFOiBXZSBhcHBseSB0aGlzIEFGVEVSIHRoZSBhbmltYXRpb24gbWl4ZXIgaGFzIHBvc2VkIGJvbmVzLCBhcyBhIHNtYWxsIGFkZGl0aXZlIG9mZnNldC4KICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBBaW0gZGlyZWN0aW9uIChwcmVmZXIgZXhwbGljaXQgYWltIHZlY3RvcikKICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5sb2NrZWRBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA4KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGhlIGJhbGwgaWYgaXQncyBpbiB0aGUgImF3YXJlbmVzcyIgcmFkaXVzCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnN1YlZlY3RvcnMoYmFsbC5tZXNoLnBvc2l0aW9uLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29udmVydCB0aGUgZGlyZWN0aW9uIGludG8gdGhlIHBsYXllcidzIGxvY2FsIHNwYWNlIHNvIHlhdy9waXRjaCBhcmUgc3RhYmxlLgogICAgICAgICAgICBfcEludlF1YXQuY29weSh0aGlzLm1lc2gucXVhdGVybmlvbikuaW52ZXJ0KCk7CiAgICAgICAgICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgbHggPSBfcFZlYy54LCBseSA9IF9wVmVjLnksIGx6ID0gX3BWZWMuejsKICAgICAgICAgICAgY29uc3QgeWF3ID0gTWF0aC5hdGFuMihseCwgbHopOwogICAgICAgICAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICAgICAgICAgIGNvbnN0IHlhd0MgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoeWF3LCAtMC45LCAwLjkpOwogICAgICAgICAgICBjb25zdCBwaXRjaEMgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAocGl0Y2gsIC0wLjYsIDAuNik7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgICAgICAgICAgY29uc3QgYWltVyA9ICh0aGlzLmhhc0JhbGwgPyAodGhpcy5pc0NoYXJnaW5nID8gMS4wIDogMC42NSkgOiAwLjM1KSAqICgxLjAgLSAwLjM1ICogc3BlZWROb3JtKTsKICAgICAgICAgICAgY29uc3QgaGVhZFcgPSAodGhpcy5oYXNCYWxsID8gMC41NSA6IDAuNzUpICogKDEuMCAtIDAuMjUgKiBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICAgICAgICAgIGlmIChiLmNoZXN0KSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yMCAqIGFpbVcsIHlhd0MgKiAwLjM1ICogYWltVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5jaGVzdC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5zcGluZSkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuc3BpbmUucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIZWFkL25lY2sgbG9vawogICAgICAgICAgICBpZiAoYi5uZWNrKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLm5lY2sucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChiLmhlYWQpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjMwICogaGVhZFcsIHlhd0MgKiAwLjU1ICogaGVhZFcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuaGVhZC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiAhdGhpcy5fYW5pbUxvY2tlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuX3Byb2NBbmltVGltZTsKICAgICAgICAgICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgICAgICAgICAgY29uc3Qgc3dheSA9IE1hdGguc2luKHQgKiA1LjApICogMC4wNSAqICgwLjUgKyBsaWZ0KTsKCiAgICAgICAgICAgICAgICBjb25zdCByYWlzZVggPSAtMC41NSAqIGxpZnQgKyBzd2F5OwogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICAgICAgICAgIGlmIChiLnJVcHBlckFybSkgewogICAgICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KHJhaXNlWCwgeWF3QyAqIDAuMTAgKiBsaWZ0LCByYWlzZVopOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5yVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtMC4zNSAqIGxpZnQgKyBzd2F5ICogMC41LCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvdW50ZXJiYWxhbmNlIGxlZnQgYXJtIHNsaWdodGx5IGZvciBhIG1vcmUgZHluYW1pYyBzaWxob3VldHRlCiAgICAgICAgICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgwLjE1ICogbGlmdCwgLXlhd0MgKiAwLjA1ICogbGlmdCwgMC4xNSAqIGxpZnQpOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIEhQIFJlZ2VuZXJhdGlvbiAoV2hlbiBub3QgaG9sZGluZyBiYWxsIGFuZCBub3QgcG9pc29uZWQpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFTiBSZWdlbmVyYXRpb24gKFN0YW1pbmEpCiAgICAgICAgICAgIC8vIFJlZ2VuZXJhdGUgaWYgbm90IGN1cnJlbnRseSBzcGVuZGluZyBpdCAoRGFzaGluZy9UYWNrbGluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGFzaGluZyAmJiAhdGhpcy5pc1RhY2tsaW5nICYmICF0aGlzLmlzRXZhZGluZyAmJiAhdGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtYXhFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IG1heEVOKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZ2VuUmF0ZSA9IDEwLjA7IC8vIEZhc3QgcmVnZW4gKHJlY292ZXIgdGFja2xlIGNvc3QgaW4gfjAuOHMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSByZWdlbiBpZiBzdHJ1Z2dsaW5nIChiZWluZyB0YWNrbGVkKSB0byBwcmV2ZW50IGluZmluaXRlIHN0YWxsaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2VuUmF0ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZW5SYXRlID0gNS4wOyAvLyBTbG93ZXIgcmVnZW4gd2hpbGUgY2FycnlpbmcgYmFsbAogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gKz0gcmVnZW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gbWF4RU4pIHRoaXMuY3VycmVudEVOID0gbWF4RU47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhQIERyYWluIHdoaWxlIGhvbGRpbmcgYmFsbCAoRmF0aWd1ZSkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy53aXRoZXJba2V5XSAtPSBkdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgdGhpcy5zdGF0dXMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgdGhpcy5zdGF0dXMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHRoaXMuc3RhdHVzLnNoaWVsZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgdGhpcy5zdGF0dXMuaGFzdGUgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgdGhpcy5zdGF0dXMuc2xvdyAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5idXJuID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuYnVybiAtPSBkdDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gOC4wICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hvY2sgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zaG9jayAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAxLjUpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCWlJUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50YWxJbmZ1c2lvbiAmJiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbi5kdXJhdGlvbiAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRhbEluZnVzaW9uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiSU5GVVNJT04gRU5EIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzVmlzdWFscyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaWxlbmNlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2lsZW5jZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA9IDAuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgPSAodGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2hhc3RlJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93ID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2xvdycsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJ1cm4gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLmJ1cm4gfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZmlyZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYnVybiA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaG9jayA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrIHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2hvY2sgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2b2x0JywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaG9jayA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICAvLyAtLS0gMS4gRkxBU0ggRUZGRUNUIC0tLQogICAgICAgICAgICBsZXQgZmxhc2hSYXRpbyA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmZsYXNoVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgcGFzc2VkIGR0IGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGFzc3VtZSAxNm1zIChzYWZldHkpCiAgICAgICAgICAgICAgICBjb25zdCBkZWx0YSA9IGR0IHx8IDAuMDE2OwogICAgICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyIC09IGRlbHRhOwogICAgICAgICAgICAgICAgZmxhc2hSYXRpbyA9IE1hdGgubWF4KDAsIHRoaXMuZmxhc2hUaW1lciAvIHRoaXMuZmxhc2hEdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZmxhc2hSYXRpbyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBMZXJwIHRvd2FyZHMgZmxhc2ggY29sb3IKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgdGhpcy5mbGFzaENvbG9yLCBmbGFzaFJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IuY29weShlbnRyeS5iYXNlQ29sb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIC0tLSAyLiBQUk9DRURVUkFMIFNRVUFTSCAmIFNUUkVUQ0ggKFNwcmluZyBQaHlzaWNzKSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDIwMC4wOwogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDE1LjA7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gWCBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVggPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLngpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICs9IGZvcmNlWCAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueCArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnggKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBZIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWSA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueSkgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKz0gZm9yY2VZICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC55ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueSAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIFogQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VaID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC56KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiArPSBmb3JjZVogKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnogKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS56ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gTWVzaCBTY2FsZSAoTXVsdGlwbGljYXRpdmUgd2l0aCBiYXNlU2NhbGUpCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0KAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLngsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2gueSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmbGFzaChjb2xvckhleCwgZHVyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yLnNldEhleChjb2xvckhleCk7CiAgICAgICAgICAgIHRoaXMuZmxhc2hEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLmZsYXNoVGltZXIgPSBkdXJhdGlvbjsKICAgICAgICB9CgogICAgICAgIHNxdWFzaCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC5zZXQoeCwgeSwgeik7CiAgICAgICAgICAgIC8vIFJlc2V0IHZlbG9jaXR5IGZvciBzbmFwIGZlZWwKICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvciAoRW5oYW5jZWQgUmV0aWNsZSkKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyAxLiBHcm91bmQgUmV0aWNsZSAoUm90YXRpbmcpCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IF9yZXRpY2xlVGV4dHVyZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAgLy8gR3JlZW4gZm9yIHBhc3MKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDMuMCwgMy4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZU1lc2gpOwoKICAgICAgICAgICAgLy8gMi4gVmVydGljYWwgUGlsbGFyIChMaWdodCBTaGFmdCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMS4wLCAxLjAsIDYsIDE2LCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDQ0ZmY0NCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIgPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5wb3NpdGlvbi55ID0gMy4wOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZVBpbGxhcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBGbG9hdGluZyBJY29uIChBYm92ZSBIZWFkKQogICAgICAgICAgICBjb25zdCBpY29uR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMS4wLCAxLjApOwogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uID0gbmV3IFRIUkVFLk1lc2goaWNvbkdlbywgbWF0KTsgLy8gUmV1c2UgdGV4dHVyZQogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uLnBvc2l0aW9uLnkgPSA0LjU7CiAgICAgICAgICAgIC8vIEJpbGxib2FyZCBiZWhhdmlvciBoYW5kbGVkIGluIHVwZGF0ZQogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZUljb24pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIHRvIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgZGVzdCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGRpc3RhbmNlIGlzIGxhcmdlIChzd2l0Y2hlZCB0YXJnZXQpLCBzbmFwLiBFbHNlIGxlcnAuCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlc3QpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5jb3B5KGRlc3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5sZXJwKGRlc3QsIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEtlZXAgWSBhdCBncm91bmQgbGV2ZWwKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMDU7CgogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3BpbiBncm91bmQgcmV0aWNsZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueiA9IC10aW1lICogMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gMS4wICsgTWF0aC5zaW4odGltZSAqIDUuMCkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2guc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZSBwaWxsYXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlUGlsbGFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5tYXRlcmlhbC5vcGFjaXR5ID0gMC4xICsgTWF0aC5zaW4odGltZSAqIDguMCkgKiAwLjA1OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucm90YXRpb24ueSA9IHRpbWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBCaWxsYm9hcmQgSWNvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVJY29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5yb3RhdGlvbi56ID0gdGltZSAqIDMuMDsgLy8gU3BpbiBpY29uCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSBDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wOwogICAgICAgICAgICBjb25zdCBoZWlnaHRMaW1pdCA9IEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFkaWFsIEJvdW5kYXJ5IChTcGhlcmUvQ3lsaW5kZXIgd2FsbHMpCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdCAtIHJhZGl1czsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIGJhY2sgdG8gY2VudGVyCiAgICAgICAgICAgICAgICBjb25zdCBueCA9IC1wb3MueCAvIGRpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBueiA9IC1wb3MueiAvIGRpc3Q7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwcmluZyBGb3JjZSAoSG9va2UncyBMYXcpIC0gIlN1Y2sgYmFjayIgZWZmZWN0CiAgICAgICAgICAgICAgICAvLyBTb2Z0ZW5lZCB0byBhbGxvdyAic3RyZXRjaGluZyIgb3V0IG9mIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgayA9IDMwLjA7IC8vIFdhcyAxNTAuMCAtIE11Y2ggc29mdGVyIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBwZW5ldHJhdGlvbiAqIGs7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbXBpbmcgKERyYWcpIHRvIHByZXZlbnQgaW5maW5pdGUgb3NjaWxsYXRpb24KICAgICAgICAgICAgICAgIC8vIFJlZHVjZWQgZGFtcGluZyB0byBhbGxvdyBtb21lbnR1bSB0byBjYXJyeSBwbGF5ZXIgZGVlcGVyIGludG8gdGhlICJ3YWxsIgogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDEuMCAtIE1hdGgubWluKDEuMCwgMy4wICogZHQpOyAvLyBXYXMgOC4wCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKj0gZGFtcGluZzsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiAqPSBkYW1waW5nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBUcmlnZ2VyIEFyZW5hIERpc3RvcnRpb24KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgcG9pbnQgb24gdGhlIGJvdW5kYXJ5IHN1cmZhY2UKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQocG9zLngsIHBvcy55LCBwb3Mueikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIocmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlbnNpdHkgYmFzZWQgb24gcGVuZXRyYXRpb24gZGVwdGggLSBCb29zdGVkIGZvciB2aXN1YWwgInN0cmV0Y2giCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZW5zaXR5ID0gTWF0aC5taW4ocGVuZXRyYXRpb24gKiA1LjAgKyB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpICogMC4xLCAyNS4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QoX3BWZWMsIGludGVuc2l0eSk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IEJvdW5kYXJ5IEJyZWFjaCBGWCAoU3Vjay1iYWNrIGRpc3RvcnRpb24pIC0tLQogICAgICAgICAgICAgICAgICAgIGlmIChwZW5ldHJhdGlvbiA+IDAuNSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuIENhbWVyYSBEaXN0b3J0aW9uIChBYmVycmF0aW9uICsgU2hha2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdsaXRjaCBlZmZlY3Qgc2NhbGVzIHdpdGggcGVuZXRyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAyLjApIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShwZW5ldHJhdGlvbiAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZXMgKFdhdGVyIGRpc3BsYWNlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNob2Nrd2F2ZSBvbiB0aGUgd2FsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIF9wVmVjLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAzLjAgKyBwZW5ldHJhdGlvbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhZmZmZiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3VjayBiYWNrIiBidWJibGVzIG1vdmluZyBpbndhcmQgdmlvbGVudGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMyhueCwgMCwgbnopLm11bHRpcGx5U2NhbGFyKDEwLjAgKyBwZW5ldHJhdGlvbiAqIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbndhcmRWZWwueSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUuMDsgLy8gVmVydGljYWwgc3BsYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBpbndhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZlcnRpY2FsIEJvdW5kYXJ5CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBoZWlnaHRMaW1pdCkgewogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihwb3MueSk7CiAgICAgICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IE1hdGguYWJzKHBvcy55KSAtIGhlaWdodExpbWl0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcHJpbmcgYmFjayAtIFNvZnRlbmVkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gc2lnbiAqIHBlbmV0cmF0aW9uICogMzAuMCAqIGR0OyAvLyBXYXMgMTUwLjAKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMy4wICogZHQpKTsgLy8gV2FzIDguMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weShwb3MpOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnkgPSBzaWduICogaGVpZ2h0TGltaXQ7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KF9wVmVjLCBwZW5ldHJhdGlvbiAqIDUuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IFZlcnRpY2FsIEJyZWFjaCBGWCAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAwLjUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgX3BWZWMsIHsgc2NhbGU6IDMuMCArIHBlbmV0cmF0aW9uLCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGxhc2ggaW53YXJkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjUsIC1zaWduICogMTAuMCwgKE1hdGgucmFuZG9tKCktMC41KSo1KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgeyB2ZWxvY2l0eTogaW53YXJkVmVsLCBzY2FsZTogMC41LCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIWdhbWUgfHwgIWdhbWUudGVhbXMpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CgogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCBpc0lucHV0QWN0aXZlID0gaW5wdXRMZW5TcSA+IDAuMDE7CgogICAgICAgICAgICBsZXQgY3VycmVudE1heFNwZWVkID0gdGhpcy5tYXhTcGVlZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNUUlVHR0xFIFNUQVRFOiBIaW5kZXIgbW92ZW1lbnQgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgLy8gSW5zdGVhZCBvZiBhIGJpbmFyeSAwLjggbXVsdGlwbGllciwgd2Ugc2NhbGUgYmFzZWQgb24gaW50ZW5zaXR5LgogICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgKDEuMCkgcmVkdWNlcyBzcGVlZCB0byA0MCUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9ICgxLjAgLSAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuNikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBzbGlnaHQgcmVkdWN0aW9uIGlmIGVuZ2FnZWQgYnV0IGxvdyBwcmVzc3VyZQogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9IDAuOTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKaWYgKHRoaXMuaXNDaGFyZ2luZyB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgfHwgdGhpcy5pc0Jsb2NraW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC40OyAvLyBTbG93IGRvd24gd2hlbiBjaGFyZ2luZy9ibG9ja2luZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFzdGUgLyBTbG93CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGN1cnJlbnRNYXhTcGVlZCAqPSAxLjU7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgY3VycmVudE1heFNwZWVkICo9IDAuNTsKCiAgICAgICAgICAgIGlmIChpc0lucHV0QWN0aXZlKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFN0cnVnZ2xlIEppdHRlciB0byBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB3cmVzdGxpbmcgZm9yIGNvbnRyb2wKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuODsKICAgICAgICAgICAgICAgICAgICBfcFZlYy54ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy56ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxYID0gX3BWZWMueCAqIGN1cnJlbnRNYXhTcGVlZDsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFogPSBfcFZlYy56ICogY3VycmVudE1heFNwZWVkOwoKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCBjdXJyZW50U3BlZWQgLyB0aGlzLm1heFNwZWVkKTsKCiAgICAgICAgICAgICAgICAvLyBBZ2lsaXR5IGlzIHJlZHVjZWQgd2hlbiBzdHJ1Z2dsaW5nCiAgICAgICAgICAgICAgICBsZXQgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIGFnaWxpdHkgKj0gMC41OwoKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjAxLCBkdCAqIGFnaWxpdHkpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAodGFyZ2V0VmVsWCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICh0YXJnZXRWZWxaIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYnJha2VGYWN0b3IgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4xLCBkdCAqIGJyYWtlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKDAgLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAoMCAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgdGhpcy52ZWxvY2l0eS55LCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CgoKICAgICAgICAgICAgbGV0IHRhcmdldFkgPSAwOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WSA9IGJhbGwubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZID0gMC41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB5RGlmZiA9IHRhcmdldFkgLSB0aGlzLm1lc2gucG9zaXRpb24ueTsKCiAgICAgICAgICAgIGNvbnN0IGxpZnQgPSB5RGlmZiAqIDEwLjAgKiBkdDsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IGxpZnQ7CgogICAgICAgICAgICBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPiA4LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPCAtOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IC04LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CiAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgX3BFdWxlci5zZXQoYm9iUGl0Y2gsIDAsIGJvYlJvbGwpOwogICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21FdWxlcihfcEV1bGVyKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwppZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gKGVuZ2FnZWRDb3VudCA+IDApOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IEVOIERyYWluIChDb250aW51b3VzKQogICAgICAgICAgICAgICAgLy8gU2NhbGluZzogMjAgQVQgcHJlc3N1cmUgLT4gYXBwcm94IDEwIEVOIGxvc3QgcGVyIHNlY29uZAogICAgICAgICAgICAgICAgY29uc3QgZHJhaW5SYXRlID0gdG90YWxQcmVzc3VyZSAqIDAuNTsgCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFN0cnVnZ2xlIEludGVuc2l0eSBmb3IgUGh5c2ljcyAoMC4wIHRvIDEuMCkKICAgICAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSBhdCByb3VnaGx5IDMwIHByZXNzdXJlCiAgICAgICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gTWF0aC5taW4oMS4wLCB0b3RhbFByZXNzdXJlIC8gMzAuMCk7CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBEcmFpbiAoQWNjdW11bGF0ZSB0byBhdm9pZCBzcGFtKQogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgKz0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke01hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UpfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHBsYXllciBpZiBlbmdhZ2VkIHRvbyBsb25nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbmNvdW50ZXJUaW1lciA+IDEuMCAmJiB0aGlzLmVuY291bnRlclRpbWVyIDwgMS4xICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQlJFQUshIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCnRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAyLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2JyZWFrJzsKCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQnJlYWsgR2x5cGggKEV4cGxvc2l2ZSBCdXJzdCkKICAgICAgICAgICAgICAgIGlmIChnYW1lLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZ2x5cGhNYW5hZ2VyLnNwYXduKCdzdGF0dXMnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDguMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIC8vIEhvbG9ncmFwaGljIEhQIEJhciBTaGFkZXIgd2l0aCBKdWljZSAoU2hha2UgJiBGbGFzaCkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjQsIDAuMTgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1RmlsbDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmMDApIH0sCiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjkgfSwKICAgICAgICAgICAgICAgICAgICB1U2hha2U6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVGbGFzaDogeyB2YWx1ZTogMC4wIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNoYWtlOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBTaGFrZSBFZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVTaGFrZSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gc2luKHQpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gY29zKHQgKiAwLjgpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVGaWxsOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZsYXNoOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRnJhbWUgZGltZW5zaW9ucyAoVVYgc3BhY2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclkgPSAwLjE1OwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJYID0gMC4wMjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElubmVyIGNvbnRlbnQgbWFzawogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblkgPSBzdGVwKGJvcmRlclksIHZVdi55KSAqIHN0ZXAodlV2LnksIDEuMCAtIGJvcmRlclkpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblggPSBzdGVwKGJvcmRlclgsIHZVdi54KSAqIHN0ZXAodlV2LngsIDEuMCAtIGJvcmRlclgpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBjb250ZW50TWFzayA9IGluWSAqIGluWDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJhY2tncm91bmQgKFRlY2ggR3JpZCkKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiZ0NvbCA9IHZlYzMoMC4wLCAwLjEsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdyaWQgPSBzdGVwKDAuOSwgZnJhY3QodlV2LnggKiAyMC4wICsgdlV2LnkgKiAxMC4wKSkgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnQ29sICs9IGdyaWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaWxsIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxNYXNrID0gc3RlcCh2VXYueCwgdUZpbGwpICogY29udGVudE1hc2s7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmVyZ3kgUHVsc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwdWxzZSA9IHNpbih2VXYueCAqIDEwLjAgLSB1VGltZSAqIDMuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgYmFyQ29sID0gbWl4KHVDb2xvciwgdUNvbG9yICsgdmVjMygwLjQpLCBwdWxzZSAqIDAuNik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3QgRWRnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gc21vb3Roc3RlcCh1RmlsbCAtIDAuMDUsIHVGaWxsLCB2VXYueCkgKiBmaWxsTWFzazsKICAgICAgICAgICAgICAgICAgICAgICAgYmFyQ29sICs9IHZlYzMoMS4wKSAqIGVkZ2U7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSAoSG9sb2dyYW0gZWZmZWN0KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogODAuMCArIHVUaW1lICogNS4wKSAqIDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBCb3JkZXIgR2xvdwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJNYXNrID0gKDEuMCAtIGNvbnRlbnRNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBib3JkZXJDb2wgPSB2ZWMzKDAuMCwgMC42LCAxLjApICogMC42OyAvLyBDeWFuIHRlY2ggYm9yZGVyCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSBtaXgoYmdDb2wsIGJhckNvbCwgZmlsbE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgYm9yZGVyQ29sLCBib3JkZXJNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gc2NhbjsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBGbGFzaCAoRGFtYWdlL0ltcGFjdCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVGbGFzaCA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgdmVjMygxLjAsIDEuMCwgMS4wKSwgdUZsYXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhY2tncm91bmQgYXJlYXMgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxNYXNrIDwgMC41ICYmIGJvcmRlck1hc2sgPCAwLjUpIGFscGhhICo9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZmluYWxDb2wsIGFscGhhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLCAvLyBSZW5kZXIgb24gdG9wCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmhwQmFyLnJlbmRlck9yZGVyID0gOTAwOyAvLyBFbnN1cmUgaXQgcmVuZGVycyBhYm92ZSBtb3N0IHRoaW5ncwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgpfY3JlYXRlU3RhdHVzUmluZygpIHsKICAgICAgICAgICAgLy8gQ29tcGFjdCBBZXN0aGV0aWMgUmluZyAoMi4wIHNpemUpCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMi4wLCAyLjApOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVIUDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUVOOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUhQOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUVOOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgI2RlZmluZSBQSSAzLjE0MTU5MjY1MzU5CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZW50ZXIgPSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHZVdiAtIGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChwKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbmZpZzogQ29tcGFjdCBSaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJNYWluID0gMC4zNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd01haW4gPSAwLjAzOyAvLyBUaGlubmVyIGJhcnMKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gMC4wOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdmVjMygwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gMS4gQmFja2dyb3VuZCBUcmFjayAoRGFyaykKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYmdSaW5nID0gMS4wIC0gc21vb3Roc3RlcCh3TWFpbiwgd01haW4gKyAwLjAxLCBhYnMoZGlzdCAtIHJNYWluKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHYXAgYXQgdG9wL2JvdHRvbSAoY2VudGVyIGF4aXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdhcCA9IHNtb290aHN0ZXAoMC4wLCAwLjA1LCBhYnMocC54KSk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnUmluZyA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDAuMCwgMC4wNSwgMC4xKTsgLy8gRGFyayBiYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuMyAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgcHJvZ3Jlc3M6IEJvdHRvbSAoLTAuMzUpIHRvIFRvcCAoMC4zNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxQb3MgPSAocC55ICsgck1haW4pIC8gKHJNYWluICogMi4wKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlZnQgU2lkZTogSFAgKEdyZWVuIC0+IFJlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnggPCAwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbFBvcyA8IHVIUCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGhwQ29sID0gbWl4KHZlYzMoMS4wLCAwLjAsIDAuMCksIHZlYzMoMC4wLCAxLjAsIDAuNCksIHNtb290aHN0ZXAoMC4yLCAwLjUsIHVIUCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodUhQIDwgMC4zKSBocENvbCArPSBzaW4odVRpbWUgKiAyMC4wKSAqIDAuMzsgLy8gUHVsc2Ugd2FybmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9IGhwQ29sOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGlwIGdsb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1SFAgLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpZ2h0IFNpZGU6IEVOIChHb2xkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPCB1RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDEuMCwgMC44LCAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1RU4gLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBPdXRlciBUZWFtIEluZGljYXRvciAoVGhpbiBwdWxzaW5nIHJpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJUZWFtID0gMC40NTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd1RlYW0gPSAwLjAwODsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdGVhbVJpbmcgPSAxLjAgLSBzbW9vdGhzdGVwKHdUZWFtLCB3VGVhbSArIDAuMDA1LCBhYnMoZGlzdCAtIHJUZWFtKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVhbVJpbmcgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFuZ2xlID0gYXRhbihwLnksIHAueCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzZWcgPSBzaW4oYW5nbGUgKiAzLjAgKyB1VGltZSAqIDIuMCk7IC8vIFJvdGF0aW5nIHNlZ21lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VnID4gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGEgPSAwLjY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID0gdUNvbG9yICogMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhID0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSAqIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZyA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucmVuZGVyT3JkZXIgPSAxMDsgLy8gQWJvdmUgZmxvb3IKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5zdGF0dXNSaW5nKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVTdGF0dXNSaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zdGF0dXNSaW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXNpYmlsaXR5IExvZ2ljCiAgICAgICAgICAgIGxldCB0YXJnZXRPcGFjaXR5ID0gMC4wOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpKSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQgYnkgdGhlIGh1bWFuIChIb21lIEFjdGl2ZSBQbGF5ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVQID0gKGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuaXNIdW1hbikgPyBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQWx3YXlzIHNob3cgZm9yIE1FIChBY3RpdmUgUGxheWVyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMgPT09IGFjdGl2ZVApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRPcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gQWx3YXlzIHNob3cgZm9yIEJBTEwgQ0FSUklFUiAoRnJpZW5kIG9yIEZvZSkKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAzLiBTaG93IGZvciBhbnlvbmUgaW4gUFJPWElNSVRZIHRvIEFjdGl2ZSBQbGF5ZXIKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFjdGl2ZVAgJiYgYWN0aXZlUC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGFjdGl2ZVAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSAyNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQgYXMgdGhleSBnZXQgZnVydGhlciBhd2F5CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xhbXAgbWluIG9wYWNpdHkgZm9yIHZpc2liaWxpdHkgaWYgcmVhc29uYWJseSBjbG9zZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDE1LjApIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjMsIHRhcmdldE9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU21vb3RoIE9wYWNpdHkgVHJhbnNpdGlvbgogICAgICAgICAgICBjb25zdCBjdXIgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWU7CiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IDUuMDsKICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlICs9ICh0YXJnZXRPcGFjaXR5IC0gY3VyKSAqIGR0ICogbGVycFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBIaWRlIGlmIGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDwgMC4wMSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhbnNmb3JtcwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24ueSA9IDAuMDU7IC8vIEp1c3QgYWJvdmUgZmxvb3IKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvdGF0ZSB0byBtYXRjaCBwbGF5ZXIgZmFjaW5nIChZYXcgb25seSkgc28gYmFycyBzdGF5IHJlbGF0aXZlIHRvIHBsYXllciBvcmllbnRhdGlvbgogICAgICAgICAgICAvLyBMZWZ0IGlzIGFsd2F5cyBQbGF5ZXIncyBMZWZ0CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi56ID0gLSh0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWw7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51SFAudmFsdWUgPSB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgY29uc3QgbWF4RU4gPSB0aGlzLnN0YXRzLkVOIHx8IDE7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RU4udmFsdWUgPSB0aGlzLmN1cnJlbnRFTiAvIG1heEVOOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbSBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh0aGlzLnRlYW0uY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFBCYXIoZHQgPSAwLjAxNikgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhbGxvd2VkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEpVSUNFOiBEYW1hZ2UgUmVhY3Rpb24gLS0tCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgX2xhc3RIUCBpZiB1bmRlZmluZWQgKGZpcnN0IHJ1bikKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RIUCA9PT0gdW5kZWZpbmVkKSB0aGlzLl9sYXN0SFAgPSB0aGlzLnN0YXRzLkhQOwoKICAgICAgICAgICAgY29uc3QgZGVsdGEgPSB0aGlzLl9sYXN0SFAgLSB0aGlzLnN0YXRzLkhQOwogICAgICAgICAgICBpZiAoZGVsdGEgPiAwLjEpIHsKICAgICAgICAgICAgICAgIC8vIEhQIERlY3JlYXNlZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWb2x1bnRhcnkgZXhlcnRpb24gKEFiaWxpdHkgY29zdCkgLT4gU21hbGwgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSBNYXRoLm1pbih0aGlzLmhwRmxhc2ggKyAwLjQsIDAuNik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEludm9sdW50YXJ5IGRhbWFnZSAoVmVub20sIERyYWluLCBldGMpIC0+IFNoYWtlICsgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwU2hha2UgPSBNYXRoLm1pbih0aGlzLmhwU2hha2UgKyAwLjA1LCAwLjE1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIC8vIERlY2F5IEZYCiAgICAgICAgICAgIHRoaXMuaHBTaGFrZSAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDguMCk7CiAgICAgICAgICAgIHRoaXMuaHBGbGFzaCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDUuMCk7CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgU2hhZGVyIFVuaWZvcm1zCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IHRoaXMuaHBCYXIubWF0ZXJpYWw7CiAgICAgICAgICAgIGlmIChtYXQudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RmlsbC52YWx1ZSA9IHBjdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51U2hha2UudmFsdWUgPSB0aGlzLmhwU2hha2U7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZsYXNoLnZhbHVlID0gdGhpcy5ocEZsYXNoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBjb2wgPSBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgY29sLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSBjb2wuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgICAgIGVsc2UgY29sLnNldEhleCgweGZmMDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgLy8gTkVXOiBBbHNvIGhpZGUgaWYgc3RhdHVzIHJpbmcgaXMgZnVsbHkgdmlzaWJsZSAob3BhY2l0eSA+IDAuOCkgdG8gYXZvaWQgcmVkdW5kYW5jeQogICAgICAgICAgICBjb25zdCByaW5nVmlzaWJsZSA9IHRoaXMuc3RhdHVzUmluZyAmJiB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPiAwLjg7CiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAoKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyB8fCB0aGlzLmhwRmxhc2ggPiAwLjEpICYmICFyaW5nVmlzaWJsZSk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY2hlY2tUYWNrbGVDb2xsaXNpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtIHx8IHRoaXMuX2hhc0hpdFRhY2tsZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSBhcyB0YWNrbGUgZGlyZWN0aW9uIChzaW5jZSB0YWNrbGUgaW1wYXJ0cyB2ZWxvY2l0eSkKICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZmFjaW5nIGlmIHZlbG9jaXR5IGlzIG5lZ2xpZ2libGUKICAgICAgICAgICAgbGV0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgdGFja2xlRGlyLnkgPSAwOwogICAgICAgICAgICBpZiAodGFja2xlRGlyLmxlbmd0aFNxKCkgPCAwLjEpIHsKICAgICAgICAgICAgICAgIHRhY2tsZURpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWNrbGVEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlY3RvciB0byBvcHBvbmVudAogICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBvcHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdG9PcHAueSA9IDA7IC8vIElnbm9yZSBoZWlnaHQgZGlmZmVyZW5jZSBmb3IgaGl0IGRldGVjdGlvbiBjeWxpbmRlcgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9PcHAubGVuZ3RoKCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmVhY2ggPSA0LjU7IC8vIEluY3JlYXNlZCByZWFjaCAod2FzIDMuNSkKCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJlYWNoKSB7CiAgICAgICAgICAgICAgICAgICAgdG9PcHAubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gdGFja2xlRGlyLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ29uZSBDaGVjazogV2lkZW5lZCB0byB+NjAgZGVncmVlcyAoZG90ID4gMC41KQogICAgICAgICAgICAgICAgICAgIC8vIFdhcyAwLjcgKH40NSBkZWcpLiBUaGlzIG1ha2VzIGxhbmRpbmcgdGFja2xlcyBlYXNpZXIuCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC41KSAvIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCnRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUYWNrbGUoZHgsIGR6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA4OyAvLyBSZWR1Y2VkIGZyb20gMTUgdG8gZW5jb3VyYWdlIGFnZ3Jlc3Npb24KICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgovLyBFeHBvcnQgdG8gZ2xvYmFsIHNjb3BlCiAgICB3aW5kb3cuZmx1eC5QbGF5ZXIgPSBQbGF5ZXI7Cn0pKCk7","./Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CnRoaXMuYWNjZWxlcmF0aW9uID0gMTguMDsgLy8gU25hcHBpZXIgbW92ZW1lbnQgKHdhcyAxMi4wKQogICAgICAgICAgICB0aGlzLmRyYWcgPSAzLjA7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA4LjA7CiAgICAgICAgICAgIC8vIEJvbmUgcmVmZXJlbmNlIGZvciBob2xkaW5nIGJhbGwKICAgICAgICAgICAgdGhpcy5oYW5kQm9uZSA9IG51bGw7CiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgYW5pbWF0aW9uIGJvbmUgcmVmcyAoZmlsbGVkIGluIHNldE1lc2gpCiAgICAgICAgICAgIHRoaXMuYm9uZXMgPSB7CiAgICAgICAgICAgICAgICBoaXBzOiBudWxsLAogICAgICAgICAgICAgICAgc3BpbmU6IG51bGwsCiAgICAgICAgICAgICAgICBjaGVzdDogbnVsbCwKICAgICAgICAgICAgICAgIG5lY2s6IG51bGwsCiAgICAgICAgICAgICAgICBoZWFkOiBudWxsLAogICAgICAgICAgICAgICAgclVwcGVyQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckZvcmVBcm06IG51bGwsCiAgICAgICAgICAgICAgICBySGFuZDogbnVsbCwKICAgICAgICAgICAgICAgIGxVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgbEhhbmQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5fYm9uZUJhc2VRdWF0cyA9IG51bGw7IC8vIE9wdGlvbmFsIGZ1dHVyZSB1c2UKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0sCiAgICAgICAgICAgICAgICBibGluZDogMCwKICAgICAgICAgICAgICAgIHNpbGVuY2U6IDAsCiAgICAgICAgICAgICAgICBzaGllbGQ6IDAsCiAgICAgICAgICAgICAgICBoYXN0ZTogMCwKICAgICAgICAgICAgICAgIHNsb3c6IDAsCiAgICAgICAgICAgICAgICBidXJuOiAwLAogICAgICAgICAgICAgICAgc2hvY2s6IDAKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107Cgp0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbiA9IG51bGw7IC8vIHsgdHlwZTogJ2ZpcmUnfCdpY2UnfCd2b2x0JywgZHVyYXRpb246IG51bWJlciB9CgogICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgIHRoaXMuYmFzZUNvbG9ySGV4ID0gMHhmZmZmZmY7CiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25PZmZzZXQgPSAwOwogICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSA9IDEuMTc7IC8vIEluY3JlYXNlZCB+OCUKCiAgICAgICAgICAgIC8vIFJlYWwtdGltZSBTdGF0cwogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuc3RhdHMuRU47CiAgICAgICAgICAgIHRoaXMudGFja2xlUmFkaXVzID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMi41IHRvIHJlZHVjZSBzd2FybSBsb2NrCgogICAgICAgICAgICB0aGlzLnNwZWVkID0gNC4wOwogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIERhc2ggU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFRvdGFsVGltZSA9IDAuNTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gRmVlZGJhY2sgQWNjdW11bGF0b3JzCiAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgdGhpcy5fZGFtYWdlVGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gSFAgQmFyCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBudWxsOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbCA9IG51bGw7CgogICAgICAgICAgICAvLyBHYW1lcGxheSBGbG93IFRpbWVycwogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBCYW5raW5nICYgVmVydGljYWxpdHkKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZID0gMDsKCiAgICAgICAgICAgIC8vIEVuY291bnRlciBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSBmYWxzZTsKdGhpcy5jbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMCwKICAgICAgICAgICAgICAgIGJsaW5kOiAwLAogICAgICAgICAgICAgICAgc2lsZW5jZTogMCwKICAgICAgICAgICAgICAgIHNoaWVsZDogMCwKICAgICAgICAgICAgICAgIGhhc3RlOiAwLAogICAgICAgICAgICAgICAgc2xvdzogMCwKICAgICAgICAgICAgICAgIGJ1cm46IDAsCiAgICAgICAgICAgICAgICBzaG9jazogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyID0gMDsgLy8gVGltZXIgZm9yIHN3aW0gc291bmQgZWZmZWN0cwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zbG93ID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2xvdywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSAwOyAvLyBPdmVyd3JpdGUgaGFzdGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMT1ciLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnVybicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJ1cm4gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5idXJuLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCVVJOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2NrJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hvY2sgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zaG9jaywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hPQ0siLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwp0aGlzLm1heFNwZWVkID0gNi4wICsgKHNwIC8gMTUuMCk7IC8vIEluY3JlYXNlZCBiYXNlIHNwZWVkICh3YXMgNS4wKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICB9CgogICAgICAgIHNldE1lc2goc291cmNlTWVzaCwgYW5pbWF0aW9ucykgewogICAgICAgICAgICB0aGlzLm1lc2ggPSBzb3VyY2VNZXNoOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwp0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVTdGF0dXNSaW5nKCk7IC8vIE5FVzogU3RhdHVzIFJpbmcKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQXVyYSgpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVBdXJhKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBDaGFyYWN0ZXIgU2NhbGluZwogICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNjsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgdGhpcy5iYXNlU2NhbGUgPSAxLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgdGhpcy5tZXNoLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2ggJiYgbm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gKG5vZGUubmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29yZSBzcGluZS9oZWFkIGNoYWluIChNaXhhbW8tZnJpZW5kbHkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhpcHMgJiYgbmFtZS5pbmNsdWRlcygnaGlwcycpKSB0aGlzLmJvbmVzLmhpcHMgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5zcGluZSAmJiBuYW1lLmluY2x1ZGVzKCdzcGluZScpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZTInKSAmJiAhbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSB0aGlzLmJvbmVzLnNwaW5lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuY2hlc3QgJiYgKG5hbWUuaW5jbHVkZXMoJ2NoZXN0JykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmUyJykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSkgdGhpcy5ib25lcy5jaGVzdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLm5lY2sgJiYgbmFtZS5pbmNsdWRlcygnbmVjaycpKSB0aGlzLmJvbmVzLm5lY2sgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5oZWFkICYmIG5hbWUuaW5jbHVkZXMoJ2hlYWQnKSkgdGhpcy5ib25lcy5oZWFkID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNSaWdodCA9IG5hbWUuaW5jbHVkZXMoJ3JpZ2h0JykgfHwgbmFtZS5lbmRzV2l0aCgncicpIHx8IG5hbWUuaW5jbHVkZXMoJ19yJykgfHwgbmFtZS5pbmNsdWRlcygnLnInKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0xlZnQgID0gbmFtZS5pbmNsdWRlcygnbGVmdCcpICB8fCBuYW1lLmVuZHNXaXRoKCdsJykgfHwgbmFtZS5pbmNsdWRlcygnX2wnKSB8fCBuYW1lLmluY2x1ZGVzKCcubCcpOwoKICAgICAgICAgICAgICAgICAgICAvLyBBcm1zL2hhbmRzIChNaXhhbW86IG1peGFtb3JpZ1JpZ2h0QXJtL1JpZ2h0Rm9yZUFybS9SaWdodEhhbmQpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnJVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRhcm0nKSB8fCAoaXNSaWdodCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMuclVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ3JpZ2h0Zm9yZWFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ2ZvcmVhcm0nKSkpKSB0aGlzLmJvbmVzLnJGb3JlQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckhhbmQgJiYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgaXNSaWdodCkgfHwgbmFtZS5pbmNsdWRlcygncmlnaHRoYW5kJykpKSB0aGlzLmJvbmVzLnJIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygnbGVmdGFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygndXBwZXJhcm0nKSkpKSB0aGlzLmJvbmVzLmxVcHBlckFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxGb3JlQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0Zm9yZWFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMubEZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5sSGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc0xlZnQpIHx8IG5hbWUuaW5jbHVkZXMoJ2xlZnRoYW5kJykpKSB0aGlzLmJvbmVzLmxIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQmFjay1jb21wYXQ6IGJhbGwgYXR0YWNobWVudCB1c2VzIGhhbmRCb25lCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhbmRCb25lICYmIHRoaXMuYm9uZXMuckhhbmQpIHRoaXMuaGFuZEJvbmUgPSB0aGlzLmJvbmVzLnJIYW5kOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIGlmIChhbmltYXRpb25zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBfbm9ybUNsaXBOYW1lID0gKHMpID0+IChzIHx8ICcnKQogICAgICAgICAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tfXC1dKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xzKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnRyaW0oKTsKCiAgICAgICAgICAgICAgICAvLyBIZWxwZXIgdG8gc3RyaXAgbGVnIHRyYWNrcyBmcm9tIGFjdGlvbiBjbGlwcwogICAgICAgICAgICAgICAgY29uc3QgX3N0cmlwTGVncyA9IChjbGlwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tzID0gW107CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVnZXggdG8gbWF0Y2ggbGVnIGJvbmVzIChNaXhhbW8gc3R5bGU6IFJpZ2h0VXBMZWcsIFJpZ2h0TGVnLCBSaWdodEZvb3QsIFJpZ2h0VG9lQmFzZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBnZW5lcmljICJMZWciLCAiRm9vdCIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0Lm5hbWUubWF0Y2goLyhVcExlZ3xMZWd8Rm9vdHxUb2UpL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja3MucHVzaCh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGNsaXAudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGlwOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBhbmltYXRpb25zLmZvckVhY2goKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gX25vcm1DbGlwTmFtZShjbGlwLm5hbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsZXQgaXNMb2NvbW90aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGlvbktleSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDb3JlIGxvY29tb3Rpb24gLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvdHJlYWR8dHJlYWRpbmd8aWRsZXxmbG9hdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvZGFzaHxzcHJpbnR8YnVyc3R8ZmFzdFxzKnN3aW18c3dpbVxzKmZhc3QvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnZGFzaCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3N3aW0nOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIGFjdGlvbktleSA9ICd0aHJvd19zaG90JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzKC9wYXNzLykpIGFjdGlvbktleSA9ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAndGhyb3cnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIGFjdGlvbktleSA9ICdjYXRjaF9qdW1wJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAnY2F0Y2gnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gSGl0IC8gUmVhY3QgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3JlYWN0fGhpdHxodXJ0fGRhbWFnZXxzdGFnZ2VyfGtub2NrLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3JlYWN0JzsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjaGFyZ2UnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90YWNrbGV8Y2hlY2t8cmFtLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3RhY2tsZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Jsb2NrfHNhdmUvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjZWxlYnJhdGUnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9IGNsaXAubmFtZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFN0cmlwIGxlZ3MgZnJvbSBub24tbG9jb21vdGlvbiBjbGlwcyB0byBhbGxvdyB0cmVhZGluZyB3YXRlciBvdmVybGF5CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0xvY29tb3Rpb24gJiYgYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zdHJpcExlZ3MoY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1thY3Rpb25LZXldID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdGFydCBkZWZhdWx0IGxvY29tb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uc1snaWRsZSddKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKCdpZGxlJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjawogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbGlzdGVuZXIKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIuYWRkRXZlbnRMaXN0ZW5lcignZmluaXNoZWQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5hY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgZmluaXNoZWQgYWN0aW9uIGlzIG91ciBjdXJyZW50IG9uZS1zaG90CiAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWN0aW9uID09PSB0aGlzLmFjdGl2ZU9uZVNob3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gbG9jb21vdGlvbiB1cGRhdGVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbSgwLjE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBOZXcgbWV0aG9kIGZvciBiYXNlIGxheWVyIChsZWdzL2JvZHkgbW92ZW1lbnQpCiAgICAgICAgcGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgY29uc3QgbmV3QWN0aW9uID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIW5ld0FjdGlvbiB8fCBuZXdBY3Rpb24gPT09IHRoaXMuYWN0aXZlTG9jb21vdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlTG9jb21vdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uLmZhZGVPdXQoZHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbihkdXJhdGlvbik7CiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlTG9jb21vdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5fbGFzdExvY29tb3Rpb24gPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgLy8gT3ZlcmhhdWxlZCBwbGF5IG1ldGhvZCB0byBoYW5kbGUgbGF5ZXJpbmcKICAgICAgICBwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIC8vIElmIGl0J3MgYSBsb2NvbW90aW9uIHN0YXRlLCByb3V0ZSB0byBwbGF5TG9jb21vdGlvbgogICAgICAgICAgICBpZiAoWydpZGxlJywgJ3N3aW0nLCAnZGFzaCddLmluY2x1ZGVzKGFjdGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHRyZWF0IGFzIGFuIGFjdGlvbiBsYXllcgogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGFuIGFjdGl2ZSBvbmUtc2hvdCwgZmFkZSBpdCBvdXQKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlT25lU2hvdCAmJiB0aGlzLmFjdGl2ZU9uZVNob3QgIT09IG5ld0FjdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90LmZhZGVPdXQoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oMC4xKTsgLy8gRmFzdCB0cmFuc2l0aW9uIGZvciBhY3Rpb25zCiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QgPSBuZXdBY3Rpb247CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUxvY29tb3Rpb25BbmltKGR1cmF0aW9uID0gMC4yKSB7CiAgICAgICAgICAgIC8vIE5vdGU6IFdlIE5PIExPTkdFUiBjaGVjayBfYW5pbUxvY2tlZCBoZXJlLgogICAgICAgICAgICAvLyBMb2NvbW90aW9uIHNob3VsZCB1cGRhdGUgY29udGludW91c2x5IGJhc2VkIG9uIHNwZWVkLCAKICAgICAgICAgICAgLy8gcnVubmluZyB1bmRlcm5lYXRoIHRoZSB1cHBlciBib2R5IGFjdGlvbi4KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KHZ4ICogdnggKyB2eiAqIHZ6KTsKCiAgICAgICAgICAgIC8vIFNtb290aCBzcGVlZAogICAgICAgICAgICBjb25zdCBzbW9vdGhLID0gMS4wIC0gTWF0aC5wb3coMC4wMDEsIGR1cmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCArPSAoc3BlZWQgLSB0aGlzLl9zbW9vdGhlZFNwZWVkKSAqIHNtb290aEs7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXMKICAgICAgICAgICAgY29uc3QgZW50ZXJNb3ZlID0gMC4xODsKICAgICAgICAgICAgY29uc3QgZXhpdE1vdmUgPSAwLjEwOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRNb3ZpbmcgPSB0aGlzLmlucHV0VmVjdG9yICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMDY7CiAgICAgICAgICAgIGNvbnN0IHZlbE1vdmluZyA9IHRoaXMuX3Ntb290aGVkU3BlZWQgPiAodGhpcy5fbW92aW5nTGF0Y2ggPyBleGl0TW92ZSA6IGVudGVyTW92ZSk7CgogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGlucHV0TW92aW5nIHx8IHZlbE1vdmluZzsKCiAgICAgICAgICAgIGxldCB0YXJnZXQgPSB0aGlzLl9tb3ZpbmdMYXRjaCA/ICdzd2ltJyA6ICdpZGxlJzsKICAgICAgICAgICAgaWYgKHRoaXMuX21vdmluZ0xhdGNoICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBVcGRhdGUgcGxheWJhY2sgcmF0ZQogICAgICAgICAgICBjb25zdCBhcHBseVJhdGUgPSAoa2V5KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKCiAgICAgICAgICAgICAgICAvLyBIYXN0ZS9TbG93IEFuaW1hdGlvbiBTY2FsaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSBhLnRpbWVTY2FsZSAqPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2xvdyA+IDApIGEudGltZVNjYWxlICo9IDAuNjsKfTsKCmFwcGx5UmF0ZSh0YXJnZXQpOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKfQoKICAgICAgICBwbGF5T25lU2hvdChhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuMSwgb3B0cyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gYWN0aW9uTmFtZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnRpbWVTY2FsZSA9IChvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICB9IGNhdGNoIChfKSB7fQoKICAgICAgICAgICAgLy8gVXNlIHRoZSBuZXcgcGxheSBtZXRob2Qgd2hpY2ggaGFuZGxlcyBsYXllcmluZwogICAgICAgICAgICB0aGlzLnBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHNldElucHV0KHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KHgsIDAsIHopOwogICAgICAgIH0KYXBwbHlFeHRlcm5hbEZvcmNlKHZlYykgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHZlYyk7CiAgICAgICAgfQogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIFNuYXBwaWVyIHRocm93czogRHJhc3RpY2FsbHkgcmVkdWNlZCB3aW5kdXAgdGltZXMgZm9yIGluc3RhbnQgcmVzcG9uc2UKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAyMDsgCiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAzLjA7IAoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSA2MDsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSA1LjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDI1MDsgCiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CmNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKLy8gQmxpbmQgUmFuZG9taXphdGlvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5ibGluZCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC40OwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICB9CgpmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRUxFTUVOVEFMIElORlVTSU9OIElOSkVDVElPTgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uICYmIHRoaXMuZWxlbWVudGFsSW5mdXNpb24uZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGVjaFBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHRlY2ggc2VsZWN0ZWQsIGluZnVzaW9uIGJlY29tZXMgdGhlIHRlY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGUsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24odGhpcy5lbGVtZW50YWxJbmZ1c2lvbi50eXBlLnRvVXBwZXJDYXNlKCkgKyAiIFNIT1QiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0ZWNoIGV4aXN0cyAoZS5nLiBKZWNodCBTaG90KSwgYWRkIGVsZW1lbnQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTT1VORDogQ2hhcmdlIFVwCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gVXNlIGEgc3ludGhlc2l6ZWQgY2hhcmdlIHNvdW5kIGlmICdjaGFyZ2UnIHNmeCBpc24ndCBsb2FkZWQKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnY2hhcmdlJywgeyB2b2x1bWU6IDAuNCwgcmF0ZTogMS4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVJbnB1dCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQb3dlciBDYWxjdWxhdGlvbgogICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7fTsKCiAgICAgICAgICAgIC8vIEJhc2UgbXVsdGlwbGllciAoZGVmYXVsdHM6IDEuMCB0byAxLjgpCiAgICAgICAgICAgIGxldCBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX0JBU0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX0JBU0UgOiAxLjApICsgKHJhdGlvICogKFRDLlBPV0VSX1JBTkdFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9SQU5HRSA6IDAuOCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRGV0ZWN0IExPQiAoVmVydGljYWwgVXAgU3dpcGUpCi8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQogICAgICAgICAgICBsZXQgaXNMb2IgPSBmYWxzZTsKICAgICAgICAgICAgLyogRElTQUJMRUQ6IFVzZXIgZmVlZGJhY2sgaW5kaWNhdGVzIGFjY2lkZW50YWwgdHJpZ2dlcnMgcHJldmVudGluZyBmb3J3YXJkIHRocm93cy4KICAgICAgICAgICAgaWYgKGR5IDwgLTgwICYmIE1hdGguYWJzKGR4KSA8IE1hdGguYWJzKGR5KSAqIDAuNikgewogICAgICAgICAgICAgICAgaXNMb2IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMT0IhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICovCgogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIC8vIEZvcm11bGE6IEN1cnZlID0gSW50ZW5zaXR5ICogU3BlZWQKICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChUQy5DVVJWRV9FTkFCTEVEICE9PSBmYWxzZSkgJiYgY3VydmVJbnB1dCAmJiBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSkgPiAoVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCA6IDAuMjUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXdJbnRlbnNpdHkgPSBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsgLy8gUG9zaXRpdmUgPSBSaWdodCBIdW1wID0gTGVmdCBDdXJ2ZQogICAgICAgICAgICAgICAgY29uc3Qgc3dpcGVTcGVlZCA9IGN1cnZlSW5wdXQuc3BlZWQgfHwgMS4wOwoKICAgICAgICAgICAgICAgIC8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoc3Bpbk1hZyA+IChUQy5DVVJWRV9QRVJGRUNUX1NQSU4gIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiA6IDUwMC4wKSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiUEVSRkVDVCBDVVJWRSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkUm9sbEltcHVsc2Uoc2lnbiAqIC0wLjMpOyAvLyBUaWx0IGNhbWVyYSBpbnRvIHRoZSBjdXJ2ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90R29hbCA9IGFpbVZlYy5kb3QoZ29hbERpcik7CgpsZXQgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIGlmIChpc0xvYikgewogICAgICAgICAgICAgICAgdHlwZSA9ICdMT0InOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUsIG11bHRpcGxpZXIsIHNwaW5WZWMpOwogICAgICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbChjb29sZG93biA9IDEuMCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmZvcmNlIGNvb2xkb3duIHRvIHByZXZlbnQgaW5zdGFudCByZS1ncmFiCiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IGNvb2xkb3duOwogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNhZmV0eTogTmFOIENoZWNrCiAgICAgICAgICAgIGlmIChpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueCkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnkpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi56KSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJQbGF5ZXIgcG9zaXRpb24gTmFOIGRldGVjdGVkLiBSZXNldHRpbmcuIiwgdGhpcy5yb2xlKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uIHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU1lOQyBGSVg6IElmIGJhbGwgdGhpbmtzIEkgaG9sZCBpdCwgYnV0IEkgZG9uJ3QsIGZvcmNlIHJlY2VpdmUKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyID09PSB0aGlzICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3luY2luZyBiYWxsIHBvc3Nlc3Npb24gdG8gcGxheWVyIik7CiAgICAgICAgICAgICAgICB0aGlzLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmlzR29kTW9kZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYyAoUGh5c2ljcyBwYXJ0IC0gVGltZXIpCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgcGh5c2ljcyBwcm9wcyB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBhbHRlcmVkCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIHJlc2V0IGhhcHBlbnMgaW4gdXBkYXRlVmlzdWFscwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyZ2VUaW1lID4gMy4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZUNoYXJnZSgwLCAwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuZXZhZGVDb29sZG93biA+IDApIHRoaXMuZXZhZGVDb29sZG93biAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duIDw9IDApIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFdmFzaW9uIExvZ2ljIChTcGluIE1vdmUpCiAgICAgICAgICAgIGlmICh0aGlzLmlzRXZhZGluZykgewogICAgICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdmlzdWFsIGhhbmRsZWQgaW4gdXBkYXRlVmlzdWFscywgYnV0IHdlIGFwcGx5IG1vdmVtZW50IGhlcmUKICAgICAgICAgICAgICAgIC8vIEZyaWN0aW9ubGVzcyBtb3ZlbWVudCBkdXJpbmcgZXZhZGUKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBkcmFnCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTUpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0V2YWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNSk7IC8vIFNsb3cgZG93biBhZnRlciBzcGluCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47IC8vIFNraXAgbm9ybWFsIHBoeXNpY3MKICAgICAgICAgICAgfQoKLy8gVGFja2xlIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAvLyBBdXRvLXJlbGVhc2UgaWYgaGVsZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGFja2xlQ2hhcmdlVGltZSA+IHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSArIDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZVRhY2tsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFRBQ0tMRSBTVEFURSAoU2xpZGUgJiBDb21taXQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3M6IEhpZ2ggRHJhZyAoU2xpZGUgdG8gc3RvcCkKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDMuMCAqIGR0KSkpOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKCiAgICAgICAgICAgICAgICAvLyBDb2xsaXNpb24gQ2hlY2sKICAgICAgICAgICAgICAgIC8vIENvbGxpc2lvbiBDaGVjawogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjU7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS42OyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7Cl9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFkgcG9zaXRpb24gY2FsY3VsYXRpb24gaXMgdmlzdWFsL3BoeXNpY3MgaHlicmlkLCBrZWVwaW5nIGhlcmUgZm9yIGNvbGxpc2lvbiBjb25zaXN0ZW5jeQogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5QXJlbmFCb3VuZGFyeShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gT3JwaGFuZWQgZWxzZSBibG9jayByZW1vdmVkCgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOyAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7Ci8vIFZlcnRpY2FsIERyYWcgKEVudmlyb25tZW50IGF3YXJlKQogICAgICAgICAgICBjb25zdCB2RHJhZyA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIpIAogICAgICAgICAgICAgICAgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSICogOC4wIAogICAgICAgICAgICAgICAgOiAyLjA7CnRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAodkRyYWcgKiBkdCkpOwogICAgICAgIH0KICAgIH0KICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbShkdCk7IC8vIEFuaW1hdGlvbiBzdGF0ZSBsb2dpYyBkcml2ZW4gYnkgcGh5c2ljcyBzdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDAgJiYgdGhpcy5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExldml0YXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGFrZSA9IDAuMDUgKyAoMC4xICogcmF0aW8pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscyBpZiBjaGFyZ2UgY2FuY2VsbGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBEYXNoIFZpc3VhbHMgKFBhcnRpY2xlcyAmIExlYW4pCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2subGVuZ3RoU3EoKSA8IDAuMSkgYmFjay5zZXQoMCwgMCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMi4wICsgTWF0aC5yYW5kb20oKSwgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LCBtb21lbnR1bVNjYWxlOiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KCl9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucm90YXRpb24ueSArPSAyNS4wICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyYWlsCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMS4wLCBsaWZlOiAwLjIgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBUYWNrbGUgQ2hhcmdlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLnRhY2tsZUNoYXJnZVRpbWUgLyB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAvLyBTaGFrZSBtZXNoCi8vIFJlZCB0aW50IHB1bHNlCiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAyKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweGZmMDAwMCksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIEhFUkNVTEVBTjogR2F0aGVyIFBhcnRpY2xlcwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjMpIHsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGluIGEgc3BoZXJlIGFyb3VuZCBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IE1hdGguYWNvcygyICogTWF0aC5yYW5kb20oKSAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gciAqIE1hdGguc2luKHBoaSkgKiBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguc2luKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IHIgKiBNYXRoLmNvcyhwaGkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoeCwgeSArIDEuMCwgeikpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4wLCAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSB0b3dhcmRzIGNlbnRlcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2ZWwgPSBjZW50ZXJQb3Muc3ViKHNwYXduUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig0LjApOyAvLyBTdWNrIGluIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZ2F0aGVyJywgc3Bhd25Qb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogdmVsLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LApjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQplbHNlIGlmICh0aGlzLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgLy8gUmVzZXQgY29sb3IgaWYgbm90IGNoYXJnaW5nL2Rhc2hpbmcvZmxhc2hpbmcvYmxvY2tpbmcKICAgICAgICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdHVuL05hcCBWaXN1YWwgUmVzZXQKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcpIHRoaXMucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgIH0KCnRoaXMuX3VwZGF0ZUhQQmFyKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzUmluZyhkdCk7IC8vIE5FVzogVXBkYXRlIFJpbmcKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDEuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICAgICAgICAgIG9mZnNldC55ID0gMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGUnLCB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4yNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjIKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbU9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjUgKyBNYXRoLnJhbmRvbSgpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnkgPSAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuODsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3dpbSBTb3VuZCBFZmZlY3QgTG9naWMKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAyLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ3N3aW0nICYmICF0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N3aW1TZnhUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYXkgc3dpbSBzb3VuZCB3aXRoIHNsaWdodCBwaXRjaCB2YXJpYW5jZQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC4zLCB2YXJpYW5jZTogMC4yIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB0aW1lciAoMC40cyB0byAwLjdzIGludGVydmFsKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3N3aW1TZnhUaW1lciA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zd2ltU2Z4VGltZXIgPSAwOyAvLyBSZXNldCBpZiBzdG9wcGVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KICAgICAgICBfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgICAgICAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lICs9IGR0OwoKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuYm9uZXM7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKCiAgICAgICAgICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gQnVpbGQgYSBkZXNpcmVkIHdvcmxkLXNwYWNlIGRpcmVjdGlvbiB3ZSB3YW50IHRoZSB0b3Jzby9oZWFkIHRvIGJpYXMgdG93YXJkLgogICAgICAgICAgICAvLyBOT1RFOiBXZSBhcHBseSB0aGlzIEFGVEVSIHRoZSBhbmltYXRpb24gbWl4ZXIgaGFzIHBvc2VkIGJvbmVzLCBhcyBhIHNtYWxsIGFkZGl0aXZlIG9mZnNldC4KICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBBaW0gZGlyZWN0aW9uIChwcmVmZXIgZXhwbGljaXQgYWltIHZlY3RvcikKICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5sb2NrZWRBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA4KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGhlIGJhbGwgaWYgaXQncyBpbiB0aGUgImF3YXJlbmVzcyIgcmFkaXVzCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnN1YlZlY3RvcnMoYmFsbC5tZXNoLnBvc2l0aW9uLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29udmVydCB0aGUgZGlyZWN0aW9uIGludG8gdGhlIHBsYXllcidzIGxvY2FsIHNwYWNlIHNvIHlhdy9waXRjaCBhcmUgc3RhYmxlLgogICAgICAgICAgICBfcEludlF1YXQuY29weSh0aGlzLm1lc2gucXVhdGVybmlvbikuaW52ZXJ0KCk7CiAgICAgICAgICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgbHggPSBfcFZlYy54LCBseSA9IF9wVmVjLnksIGx6ID0gX3BWZWMuejsKICAgICAgICAgICAgY29uc3QgeWF3ID0gTWF0aC5hdGFuMihseCwgbHopOwogICAgICAgICAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICAgICAgICAgIGNvbnN0IHlhd0MgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoeWF3LCAtMC45LCAwLjkpOwogICAgICAgICAgICBjb25zdCBwaXRjaEMgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAocGl0Y2gsIC0wLjYsIDAuNik7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgICAgICAgICAgY29uc3QgYWltVyA9ICh0aGlzLmhhc0JhbGwgPyAodGhpcy5pc0NoYXJnaW5nID8gMS4wIDogMC42NSkgOiAwLjM1KSAqICgxLjAgLSAwLjM1ICogc3BlZWROb3JtKTsKICAgICAgICAgICAgY29uc3QgaGVhZFcgPSAodGhpcy5oYXNCYWxsID8gMC41NSA6IDAuNzUpICogKDEuMCAtIDAuMjUgKiBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICAgICAgICAgIGlmIChiLmNoZXN0KSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yMCAqIGFpbVcsIHlhd0MgKiAwLjM1ICogYWltVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5jaGVzdC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5zcGluZSkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuc3BpbmUucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIZWFkL25lY2sgbG9vawogICAgICAgICAgICBpZiAoYi5uZWNrKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLm5lY2sucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChiLmhlYWQpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjMwICogaGVhZFcsIHlhd0MgKiAwLjU1ICogaGVhZFcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuaGVhZC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiAhdGhpcy5fYW5pbUxvY2tlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuX3Byb2NBbmltVGltZTsKICAgICAgICAgICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgICAgICAgICAgY29uc3Qgc3dheSA9IE1hdGguc2luKHQgKiA1LjApICogMC4wNSAqICgwLjUgKyBsaWZ0KTsKCiAgICAgICAgICAgICAgICBjb25zdCByYWlzZVggPSAtMC41NSAqIGxpZnQgKyBzd2F5OwogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICAgICAgICAgIGlmIChiLnJVcHBlckFybSkgewogICAgICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KHJhaXNlWCwgeWF3QyAqIDAuMTAgKiBsaWZ0LCByYWlzZVopOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5yVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtMC4zNSAqIGxpZnQgKyBzd2F5ICogMC41LCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvdW50ZXJiYWxhbmNlIGxlZnQgYXJtIHNsaWdodGx5IGZvciBhIG1vcmUgZHluYW1pYyBzaWxob3VldHRlCiAgICAgICAgICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgwLjE1ICogbGlmdCwgLXlhd0MgKiAwLjA1ICogbGlmdCwgMC4xNSAqIGxpZnQpOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIEhQIFJlZ2VuZXJhdGlvbiAoV2hlbiBub3QgaG9sZGluZyBiYWxsIGFuZCBub3QgcG9pc29uZWQpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFTiBSZWdlbmVyYXRpb24gKFN0YW1pbmEpCiAgICAgICAgICAgIC8vIFJlZ2VuZXJhdGUgaWYgbm90IGN1cnJlbnRseSBzcGVuZGluZyBpdCAoRGFzaGluZy9UYWNrbGluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGFzaGluZyAmJiAhdGhpcy5pc1RhY2tsaW5nICYmICF0aGlzLmlzRXZhZGluZyAmJiAhdGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtYXhFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IG1heEVOKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZ2VuUmF0ZSA9IDEwLjA7IC8vIEZhc3QgcmVnZW4gKHJlY292ZXIgdGFja2xlIGNvc3QgaW4gfjAuOHMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSByZWdlbiBpZiBzdHJ1Z2dsaW5nIChiZWluZyB0YWNrbGVkKSB0byBwcmV2ZW50IGluZmluaXRlIHN0YWxsaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2VuUmF0ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZW5SYXRlID0gNS4wOyAvLyBTbG93ZXIgcmVnZW4gd2hpbGUgY2FycnlpbmcgYmFsbAogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gKz0gcmVnZW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gbWF4RU4pIHRoaXMuY3VycmVudEVOID0gbWF4RU47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhQIERyYWluIHdoaWxlIGhvbGRpbmcgYmFsbCAoRmF0aWd1ZSkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy53aXRoZXJba2V5XSAtPSBkdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgdGhpcy5zdGF0dXMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgdGhpcy5zdGF0dXMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHRoaXMuc3RhdHVzLnNoaWVsZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgdGhpcy5zdGF0dXMuaGFzdGUgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgdGhpcy5zdGF0dXMuc2xvdyAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5idXJuID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuYnVybiAtPSBkdDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gOC4wICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hvY2sgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zaG9jayAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAxLjUpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCWlJUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50YWxJbmZ1c2lvbiAmJiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbi5kdXJhdGlvbiAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRhbEluZnVzaW9uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiSU5GVVNJT04gRU5EIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzVmlzdWFscyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaWxlbmNlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2lsZW5jZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA9IDAuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgPSAodGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2hhc3RlJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93ID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2xvdycsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJ1cm4gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLmJ1cm4gfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZmlyZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYnVybiA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaG9jayA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrIHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2hvY2sgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2b2x0JywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaG9jayA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICAvLyAtLS0gMS4gRkxBU0ggRUZGRUNUIC0tLQogICAgICAgICAgICBsZXQgZmxhc2hSYXRpbyA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmZsYXNoVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgcGFzc2VkIGR0IGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGFzc3VtZSAxNm1zIChzYWZldHkpCiAgICAgICAgICAgICAgICBjb25zdCBkZWx0YSA9IGR0IHx8IDAuMDE2OwogICAgICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyIC09IGRlbHRhOwogICAgICAgICAgICAgICAgZmxhc2hSYXRpbyA9IE1hdGgubWF4KDAsIHRoaXMuZmxhc2hUaW1lciAvIHRoaXMuZmxhc2hEdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZmxhc2hSYXRpbyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBMZXJwIHRvd2FyZHMgZmxhc2ggY29sb3IKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgdGhpcy5mbGFzaENvbG9yLCBmbGFzaFJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IuY29weShlbnRyeS5iYXNlQ29sb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIC0tLSAyLiBQUk9DRURVUkFMIFNRVUFTSCAmIFNUUkVUQ0ggKFNwcmluZyBQaHlzaWNzKSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDIwMC4wOwogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDE1LjA7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gWCBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVggPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLngpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICs9IGZvcmNlWCAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueCArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnggKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBZIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWSA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueSkgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKz0gZm9yY2VZICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC55ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueSAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIFogQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VaID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC56KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiArPSBmb3JjZVogKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnogKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS56ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gTWVzaCBTY2FsZSAoTXVsdGlwbGljYXRpdmUgd2l0aCBiYXNlU2NhbGUpCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0KAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLngsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2gueSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmbGFzaChjb2xvckhleCwgZHVyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yLnNldEhleChjb2xvckhleCk7CiAgICAgICAgICAgIHRoaXMuZmxhc2hEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLmZsYXNoVGltZXIgPSBkdXJhdGlvbjsKICAgICAgICB9CgogICAgICAgIHNxdWFzaCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC5zZXQoeCwgeSwgeik7CiAgICAgICAgICAgIC8vIFJlc2V0IHZlbG9jaXR5IGZvciBzbmFwIGZlZWwKICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvciAoRW5oYW5jZWQgUmV0aWNsZSkKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyAxLiBHcm91bmQgUmV0aWNsZSAoUm90YXRpbmcpCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IF9yZXRpY2xlVGV4dHVyZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAgLy8gR3JlZW4gZm9yIHBhc3MKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDMuMCwgMy4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZU1lc2gpOwoKICAgICAgICAgICAgLy8gMi4gVmVydGljYWwgUGlsbGFyIChMaWdodCBTaGFmdCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMS4wLCAxLjAsIDYsIDE2LCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDQ0ZmY0NCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIgPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5wb3NpdGlvbi55ID0gMy4wOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZVBpbGxhcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBGbG9hdGluZyBJY29uIChBYm92ZSBIZWFkKQogICAgICAgICAgICBjb25zdCBpY29uR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMS4wLCAxLjApOwogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uID0gbmV3IFRIUkVFLk1lc2goaWNvbkdlbywgbWF0KTsgLy8gUmV1c2UgdGV4dHVyZQogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uLnBvc2l0aW9uLnkgPSA0LjU7CiAgICAgICAgICAgIC8vIEJpbGxib2FyZCBiZWhhdmlvciBoYW5kbGVkIGluIHVwZGF0ZQogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZUljb24pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIHRvIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgZGVzdCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGRpc3RhbmNlIGlzIGxhcmdlIChzd2l0Y2hlZCB0YXJnZXQpLCBzbmFwLiBFbHNlIGxlcnAuCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlc3QpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5jb3B5KGRlc3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5sZXJwKGRlc3QsIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEtlZXAgWSBhdCBncm91bmQgbGV2ZWwKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMDU7CgogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3BpbiBncm91bmQgcmV0aWNsZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueiA9IC10aW1lICogMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gMS4wICsgTWF0aC5zaW4odGltZSAqIDUuMCkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2guc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZSBwaWxsYXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlUGlsbGFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5tYXRlcmlhbC5vcGFjaXR5ID0gMC4xICsgTWF0aC5zaW4odGltZSAqIDguMCkgKiAwLjA1OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucm90YXRpb24ueSA9IHRpbWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBCaWxsYm9hcmQgSWNvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVJY29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5yb3RhdGlvbi56ID0gdGltZSAqIDMuMDsgLy8gU3BpbiBpY29uCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSBDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wOwogICAgICAgICAgICBjb25zdCBoZWlnaHRMaW1pdCA9IEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFkaWFsIEJvdW5kYXJ5IChTcGhlcmUvQ3lsaW5kZXIgd2FsbHMpCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdCAtIHJhZGl1czsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIGJhY2sgdG8gY2VudGVyCiAgICAgICAgICAgICAgICBjb25zdCBueCA9IC1wb3MueCAvIGRpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBueiA9IC1wb3MueiAvIGRpc3Q7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwcmluZyBGb3JjZSAoSG9va2UncyBMYXcpIC0gIlN1Y2sgYmFjayIgZWZmZWN0CiAgICAgICAgICAgICAgICAvLyBTb2Z0ZW5lZCB0byBhbGxvdyAic3RyZXRjaGluZyIgb3V0IG9mIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgayA9IDMwLjA7IC8vIFdhcyAxNTAuMCAtIE11Y2ggc29mdGVyIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBwZW5ldHJhdGlvbiAqIGs7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbXBpbmcgKERyYWcpIHRvIHByZXZlbnQgaW5maW5pdGUgb3NjaWxsYXRpb24KICAgICAgICAgICAgICAgIC8vIFJlZHVjZWQgZGFtcGluZyB0byBhbGxvdyBtb21lbnR1bSB0byBjYXJyeSBwbGF5ZXIgZGVlcGVyIGludG8gdGhlICJ3YWxsIgogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDEuMCAtIE1hdGgubWluKDEuMCwgMy4wICogZHQpOyAvLyBXYXMgOC4wCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKj0gZGFtcGluZzsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiAqPSBkYW1waW5nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBUcmlnZ2VyIEFyZW5hIERpc3RvcnRpb24KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgcG9pbnQgb24gdGhlIGJvdW5kYXJ5IHN1cmZhY2UKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQocG9zLngsIHBvcy55LCBwb3Mueikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIocmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlbnNpdHkgYmFzZWQgb24gcGVuZXRyYXRpb24gZGVwdGggLSBCb29zdGVkIGZvciB2aXN1YWwgInN0cmV0Y2giCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZW5zaXR5ID0gTWF0aC5taW4ocGVuZXRyYXRpb24gKiA1LjAgKyB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpICogMC4xLCAyNS4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QoX3BWZWMsIGludGVuc2l0eSk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IEJvdW5kYXJ5IEJyZWFjaCBGWCAoU3Vjay1iYWNrIGRpc3RvcnRpb24pIC0tLQogICAgICAgICAgICAgICAgICAgIGlmIChwZW5ldHJhdGlvbiA+IDAuNSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuIENhbWVyYSBEaXN0b3J0aW9uIChBYmVycmF0aW9uICsgU2hha2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdsaXRjaCBlZmZlY3Qgc2NhbGVzIHdpdGggcGVuZXRyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAyLjApIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShwZW5ldHJhdGlvbiAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZXMgKFdhdGVyIGRpc3BsYWNlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNob2Nrd2F2ZSBvbiB0aGUgd2FsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIF9wVmVjLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAzLjAgKyBwZW5ldHJhdGlvbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhZmZmZiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3VjayBiYWNrIiBidWJibGVzIG1vdmluZyBpbndhcmQgdmlvbGVudGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMyhueCwgMCwgbnopLm11bHRpcGx5U2NhbGFyKDEwLjAgKyBwZW5ldHJhdGlvbiAqIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbndhcmRWZWwueSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUuMDsgLy8gVmVydGljYWwgc3BsYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBpbndhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZlcnRpY2FsIEJvdW5kYXJ5CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBoZWlnaHRMaW1pdCkgewogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihwb3MueSk7CiAgICAgICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IE1hdGguYWJzKHBvcy55KSAtIGhlaWdodExpbWl0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcHJpbmcgYmFjayAtIFNvZnRlbmVkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gc2lnbiAqIHBlbmV0cmF0aW9uICogMzAuMCAqIGR0OyAvLyBXYXMgMTUwLjAKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMy4wICogZHQpKTsgLy8gV2FzIDguMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weShwb3MpOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnkgPSBzaWduICogaGVpZ2h0TGltaXQ7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KF9wVmVjLCBwZW5ldHJhdGlvbiAqIDUuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IFZlcnRpY2FsIEJyZWFjaCBGWCAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAwLjUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgX3BWZWMsIHsgc2NhbGU6IDMuMCArIHBlbmV0cmF0aW9uLCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGxhc2ggaW53YXJkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjUsIC1zaWduICogMTAuMCwgKE1hdGgucmFuZG9tKCktMC41KSo1KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgeyB2ZWxvY2l0eTogaW53YXJkVmVsLCBzY2FsZTogMC41LCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIWdhbWUgfHwgIWdhbWUudGVhbXMpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CgogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCBpc0lucHV0QWN0aXZlID0gaW5wdXRMZW5TcSA+IDAuMDE7CgogICAgICAgICAgICBsZXQgY3VycmVudE1heFNwZWVkID0gdGhpcy5tYXhTcGVlZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNUUlVHR0xFIFNUQVRFOiBIaW5kZXIgbW92ZW1lbnQgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgLy8gSW5zdGVhZCBvZiBhIGJpbmFyeSAwLjggbXVsdGlwbGllciwgd2Ugc2NhbGUgYmFzZWQgb24gaW50ZW5zaXR5LgogICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgKDEuMCkgcmVkdWNlcyBzcGVlZCB0byA0MCUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9ICgxLjAgLSAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuNikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBzbGlnaHQgcmVkdWN0aW9uIGlmIGVuZ2FnZWQgYnV0IGxvdyBwcmVzc3VyZQogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9IDAuOTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKaWYgKHRoaXMuaXNDaGFyZ2luZyB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgfHwgdGhpcy5pc0Jsb2NraW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC40OyAvLyBTbG93IGRvd24gd2hlbiBjaGFyZ2luZy9ibG9ja2luZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFzdGUgLyBTbG93CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGN1cnJlbnRNYXhTcGVlZCAqPSAxLjU7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgY3VycmVudE1heFNwZWVkICo9IDAuNTsKCiAgICAgICAgICAgIGlmIChpc0lucHV0QWN0aXZlKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFN0cnVnZ2xlIEppdHRlciB0byBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB3cmVzdGxpbmcgZm9yIGNvbnRyb2wKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuODsKICAgICAgICAgICAgICAgICAgICBfcFZlYy54ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy56ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxYID0gX3BWZWMueCAqIGN1cnJlbnRNYXhTcGVlZDsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFogPSBfcFZlYy56ICogY3VycmVudE1heFNwZWVkOwoKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCBjdXJyZW50U3BlZWQgLyB0aGlzLm1heFNwZWVkKTsKCiAgICAgICAgICAgICAgICAvLyBBZ2lsaXR5IGlzIHJlZHVjZWQgd2hlbiBzdHJ1Z2dsaW5nCiAgICAgICAgICAgICAgICBsZXQgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIGFnaWxpdHkgKj0gMC41OwoKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjAxLCBkdCAqIGFnaWxpdHkpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAodGFyZ2V0VmVsWCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICh0YXJnZXRWZWxaIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYnJha2VGYWN0b3IgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4xLCBkdCAqIGJyYWtlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKDAgLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAoMCAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgdGhpcy52ZWxvY2l0eS55LCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CgoKICAgICAgICAgICAgbGV0IHRhcmdldFkgPSAwOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WSA9IGJhbGwubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZID0gMC41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB5RGlmZiA9IHRhcmdldFkgLSB0aGlzLm1lc2gucG9zaXRpb24ueTsKCiAgICAgICAgICAgIGNvbnN0IGxpZnQgPSB5RGlmZiAqIDEwLjAgKiBkdDsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IGxpZnQ7CgogICAgICAgICAgICBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPiA4LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPCAtOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IC04LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CiAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgX3BFdWxlci5zZXQoYm9iUGl0Y2gsIDAsIGJvYlJvbGwpOwogICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21FdWxlcihfcEV1bGVyKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwppZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gKGVuZ2FnZWRDb3VudCA+IDApOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IEVOIERyYWluIChDb250aW51b3VzKQogICAgICAgICAgICAgICAgLy8gU2NhbGluZzogMjAgQVQgcHJlc3N1cmUgLT4gYXBwcm94IDEwIEVOIGxvc3QgcGVyIHNlY29uZAogICAgICAgICAgICAgICAgY29uc3QgZHJhaW5SYXRlID0gdG90YWxQcmVzc3VyZSAqIDAuNTsgCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFN0cnVnZ2xlIEludGVuc2l0eSBmb3IgUGh5c2ljcyAoMC4wIHRvIDEuMCkKICAgICAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSBhdCByb3VnaGx5IDMwIHByZXNzdXJlCiAgICAgICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gTWF0aC5taW4oMS4wLCB0b3RhbFByZXNzdXJlIC8gMzAuMCk7CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBEcmFpbiAoQWNjdW11bGF0ZSB0byBhdm9pZCBzcGFtKQogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgKz0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke01hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UpfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHBsYXllciBpZiBlbmdhZ2VkIHRvbyBsb25nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbmNvdW50ZXJUaW1lciA+IDEuMCAmJiB0aGlzLmVuY291bnRlclRpbWVyIDwgMS4xICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQlJFQUshIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCnRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAyLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2JyZWFrJzsKCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQnJlYWsgR2x5cGggKEV4cGxvc2l2ZSBCdXJzdCkKICAgICAgICAgICAgICAgIGlmIChnYW1lLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZ2x5cGhNYW5hZ2VyLnNwYXduKCdzdGF0dXMnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDguMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIC8vIEhvbG9ncmFwaGljIEhQIEJhciBTaGFkZXIgd2l0aCBKdWljZSAoU2hha2UgJiBGbGFzaCkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjQsIDAuMTgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1RmlsbDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmMDApIH0sCiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjkgfSwKICAgICAgICAgICAgICAgICAgICB1U2hha2U6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVGbGFzaDogeyB2YWx1ZTogMC4wIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNoYWtlOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBTaGFrZSBFZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVTaGFrZSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gc2luKHQpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gY29zKHQgKiAwLjgpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVGaWxsOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZsYXNoOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRnJhbWUgZGltZW5zaW9ucyAoVVYgc3BhY2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclkgPSAwLjE1OwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJYID0gMC4wMjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElubmVyIGNvbnRlbnQgbWFzawogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblkgPSBzdGVwKGJvcmRlclksIHZVdi55KSAqIHN0ZXAodlV2LnksIDEuMCAtIGJvcmRlclkpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblggPSBzdGVwKGJvcmRlclgsIHZVdi54KSAqIHN0ZXAodlV2LngsIDEuMCAtIGJvcmRlclgpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBjb250ZW50TWFzayA9IGluWSAqIGluWDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJhY2tncm91bmQgKFRlY2ggR3JpZCkKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiZ0NvbCA9IHZlYzMoMC4wLCAwLjEsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdyaWQgPSBzdGVwKDAuOSwgZnJhY3QodlV2LnggKiAyMC4wICsgdlV2LnkgKiAxMC4wKSkgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnQ29sICs9IGdyaWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaWxsIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxNYXNrID0gc3RlcCh2VXYueCwgdUZpbGwpICogY29udGVudE1hc2s7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmVyZ3kgUHVsc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwdWxzZSA9IHNpbih2VXYueCAqIDEwLjAgLSB1VGltZSAqIDMuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgYmFyQ29sID0gbWl4KHVDb2xvciwgdUNvbG9yICsgdmVjMygwLjQpLCBwdWxzZSAqIDAuNik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3QgRWRnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gc21vb3Roc3RlcCh1RmlsbCAtIDAuMDUsIHVGaWxsLCB2VXYueCkgKiBmaWxsTWFzazsKICAgICAgICAgICAgICAgICAgICAgICAgYmFyQ29sICs9IHZlYzMoMS4wKSAqIGVkZ2U7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSAoSG9sb2dyYW0gZWZmZWN0KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogODAuMCArIHVUaW1lICogNS4wKSAqIDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBCb3JkZXIgR2xvdwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJNYXNrID0gKDEuMCAtIGNvbnRlbnRNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBib3JkZXJDb2wgPSB2ZWMzKDAuMCwgMC42LCAxLjApICogMC42OyAvLyBDeWFuIHRlY2ggYm9yZGVyCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSBtaXgoYmdDb2wsIGJhckNvbCwgZmlsbE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgYm9yZGVyQ29sLCBib3JkZXJNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gc2NhbjsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBGbGFzaCAoRGFtYWdlL0ltcGFjdCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVGbGFzaCA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgdmVjMygxLjAsIDEuMCwgMS4wKSwgdUZsYXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhY2tncm91bmQgYXJlYXMgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxNYXNrIDwgMC41ICYmIGJvcmRlck1hc2sgPCAwLjUpIGFscGhhICo9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZmluYWxDb2wsIGFscGhhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLCAvLyBSZW5kZXIgb24gdG9wCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmhwQmFyLnJlbmRlck9yZGVyID0gOTAwOyAvLyBFbnN1cmUgaXQgcmVuZGVycyBhYm92ZSBtb3N0IHRoaW5ncwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgpfY3JlYXRlU3RhdHVzUmluZygpIHsKICAgICAgICAgICAgLy8gQ29tcGFjdCBBZXN0aGV0aWMgUmluZyAoMi4wIHNpemUpCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMi4wLCAyLjApOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVIUDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUVOOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUhQOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUVOOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgI2RlZmluZSBQSSAzLjE0MTU5MjY1MzU5CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZW50ZXIgPSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHZVdiAtIGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChwKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbmZpZzogQ29tcGFjdCBSaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJNYWluID0gMC4zNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd01haW4gPSAwLjAzOyAvLyBUaGlubmVyIGJhcnMKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gMC4wOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdmVjMygwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gMS4gQmFja2dyb3VuZCBUcmFjayAoRGFyaykKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYmdSaW5nID0gMS4wIC0gc21vb3Roc3RlcCh3TWFpbiwgd01haW4gKyAwLjAxLCBhYnMoZGlzdCAtIHJNYWluKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHYXAgYXQgdG9wL2JvdHRvbSAoY2VudGVyIGF4aXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdhcCA9IHNtb290aHN0ZXAoMC4wLCAwLjA1LCBhYnMocC54KSk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnUmluZyA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDAuMCwgMC4wNSwgMC4xKTsgLy8gRGFyayBiYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuMyAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgcHJvZ3Jlc3M6IEJvdHRvbSAoLTAuMzUpIHRvIFRvcCAoMC4zNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxQb3MgPSAocC55ICsgck1haW4pIC8gKHJNYWluICogMi4wKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlZnQgU2lkZTogSFAgKEdyZWVuIC0+IFJlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnggPCAwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbFBvcyA8IHVIUCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGhwQ29sID0gbWl4KHZlYzMoMS4wLCAwLjAsIDAuMCksIHZlYzMoMC4wLCAxLjAsIDAuNCksIHNtb290aHN0ZXAoMC4yLCAwLjUsIHVIUCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodUhQIDwgMC4zKSBocENvbCArPSBzaW4odVRpbWUgKiAyMC4wKSAqIDAuMzsgLy8gUHVsc2Ugd2FybmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9IGhwQ29sOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGlwIGdsb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1SFAgLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpZ2h0IFNpZGU6IEVOIChHb2xkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPCB1RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDEuMCwgMC44LCAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1RU4gLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBPdXRlciBUZWFtIEluZGljYXRvciAoVGhpbiBwdWxzaW5nIHJpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJUZWFtID0gMC40NTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd1RlYW0gPSAwLjAwODsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdGVhbVJpbmcgPSAxLjAgLSBzbW9vdGhzdGVwKHdUZWFtLCB3VGVhbSArIDAuMDA1LCBhYnMoZGlzdCAtIHJUZWFtKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVhbVJpbmcgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFuZ2xlID0gYXRhbihwLnksIHAueCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzZWcgPSBzaW4oYW5nbGUgKiAzLjAgKyB1VGltZSAqIDIuMCk7IC8vIFJvdGF0aW5nIHNlZ21lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VnID4gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGEgPSAwLjY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID0gdUNvbG9yICogMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhID0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSAqIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZyA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucmVuZGVyT3JkZXIgPSAxMDsgLy8gQWJvdmUgZmxvb3IKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5zdGF0dXNSaW5nKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVTdGF0dXNSaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zdGF0dXNSaW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXNpYmlsaXR5IExvZ2ljCiAgICAgICAgICAgIGxldCB0YXJnZXRPcGFjaXR5ID0gMC4wOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpKSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQgYnkgdGhlIGh1bWFuIChIb21lIEFjdGl2ZSBQbGF5ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVQID0gKGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuaXNIdW1hbikgPyBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQWx3YXlzIHNob3cgZm9yIE1FIChBY3RpdmUgUGxheWVyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMgPT09IGFjdGl2ZVApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRPcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gQWx3YXlzIHNob3cgZm9yIEJBTEwgQ0FSUklFUiAoRnJpZW5kIG9yIEZvZSkKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAzLiBTaG93IGZvciBhbnlvbmUgaW4gUFJPWElNSVRZIHRvIEFjdGl2ZSBQbGF5ZXIKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFjdGl2ZVAgJiYgYWN0aXZlUC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGFjdGl2ZVAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSAyNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQgYXMgdGhleSBnZXQgZnVydGhlciBhd2F5CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xhbXAgbWluIG9wYWNpdHkgZm9yIHZpc2liaWxpdHkgaWYgcmVhc29uYWJseSBjbG9zZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDE1LjApIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjMsIHRhcmdldE9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU21vb3RoIE9wYWNpdHkgVHJhbnNpdGlvbgogICAgICAgICAgICBjb25zdCBjdXIgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWU7CiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IDUuMDsKICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlICs9ICh0YXJnZXRPcGFjaXR5IC0gY3VyKSAqIGR0ICogbGVycFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBIaWRlIGlmIGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDwgMC4wMSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhbnNmb3JtcwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24ueSA9IDAuMDU7IC8vIEp1c3QgYWJvdmUgZmxvb3IKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvdGF0ZSB0byBtYXRjaCBwbGF5ZXIgZmFjaW5nIChZYXcgb25seSkgc28gYmFycyBzdGF5IHJlbGF0aXZlIHRvIHBsYXllciBvcmllbnRhdGlvbgogICAgICAgICAgICAvLyBMZWZ0IGlzIGFsd2F5cyBQbGF5ZXIncyBMZWZ0CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi56ID0gLSh0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWw7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51SFAudmFsdWUgPSB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgY29uc3QgbWF4RU4gPSB0aGlzLnN0YXRzLkVOIHx8IDE7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RU4udmFsdWUgPSB0aGlzLmN1cnJlbnRFTiAvIG1heEVOOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbSBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh0aGlzLnRlYW0uY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFBCYXIoZHQgPSAwLjAxNikgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhbGxvd2VkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEpVSUNFOiBEYW1hZ2UgUmVhY3Rpb24gLS0tCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgX2xhc3RIUCBpZiB1bmRlZmluZWQgKGZpcnN0IHJ1bikKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RIUCA9PT0gdW5kZWZpbmVkKSB0aGlzLl9sYXN0SFAgPSB0aGlzLnN0YXRzLkhQOwoKICAgICAgICAgICAgY29uc3QgZGVsdGEgPSB0aGlzLl9sYXN0SFAgLSB0aGlzLnN0YXRzLkhQOwogICAgICAgICAgICBpZiAoZGVsdGEgPiAwLjEpIHsKICAgICAgICAgICAgICAgIC8vIEhQIERlY3JlYXNlZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWb2x1bnRhcnkgZXhlcnRpb24gKEFiaWxpdHkgY29zdCkgLT4gU21hbGwgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSBNYXRoLm1pbih0aGlzLmhwRmxhc2ggKyAwLjQsIDAuNik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEludm9sdW50YXJ5IGRhbWFnZSAoVmVub20sIERyYWluLCBldGMpIC0+IFNoYWtlICsgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwU2hha2UgPSBNYXRoLm1pbih0aGlzLmhwU2hha2UgKyAwLjA1LCAwLjE1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIC8vIERlY2F5IEZYCiAgICAgICAgICAgIHRoaXMuaHBTaGFrZSAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDguMCk7CiAgICAgICAgICAgIHRoaXMuaHBGbGFzaCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDUuMCk7CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgU2hhZGVyIFVuaWZvcm1zCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IHRoaXMuaHBCYXIubWF0ZXJpYWw7CiAgICAgICAgICAgIGlmIChtYXQudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RmlsbC52YWx1ZSA9IHBjdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51U2hha2UudmFsdWUgPSB0aGlzLmhwU2hha2U7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZsYXNoLnZhbHVlID0gdGhpcy5ocEZsYXNoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBjb2wgPSBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgY29sLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSBjb2wuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgICAgIGVsc2UgY29sLnNldEhleCgweGZmMDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgLy8gTkVXOiBBbHNvIGhpZGUgaWYgc3RhdHVzIHJpbmcgaXMgZnVsbHkgdmlzaWJsZSAob3BhY2l0eSA+IDAuOCkgdG8gYXZvaWQgcmVkdW5kYW5jeQogICAgICAgICAgICBjb25zdCByaW5nVmlzaWJsZSA9IHRoaXMuc3RhdHVzUmluZyAmJiB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPiAwLjg7CiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAoKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyB8fCB0aGlzLmhwRmxhc2ggPiAwLjEpICYmICFyaW5nVmlzaWJsZSk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY2hlY2tUYWNrbGVDb2xsaXNpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtIHx8IHRoaXMuX2hhc0hpdFRhY2tsZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSBhcyB0YWNrbGUgZGlyZWN0aW9uIChzaW5jZSB0YWNrbGUgaW1wYXJ0cyB2ZWxvY2l0eSkKICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZmFjaW5nIGlmIHZlbG9jaXR5IGlzIG5lZ2xpZ2libGUKICAgICAgICAgICAgbGV0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgdGFja2xlRGlyLnkgPSAwOwogICAgICAgICAgICBpZiAodGFja2xlRGlyLmxlbmd0aFNxKCkgPCAwLjEpIHsKICAgICAgICAgICAgICAgIHRhY2tsZURpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWNrbGVEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlY3RvciB0byBvcHBvbmVudAogICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBvcHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdG9PcHAueSA9IDA7IC8vIElnbm9yZSBoZWlnaHQgZGlmZmVyZW5jZSBmb3IgaGl0IGRldGVjdGlvbiBjeWxpbmRlcgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9PcHAubGVuZ3RoKCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmVhY2ggPSA0LjU7IC8vIEluY3JlYXNlZCByZWFjaCAod2FzIDMuNSkKCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJlYWNoKSB7CiAgICAgICAgICAgICAgICAgICAgdG9PcHAubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gdGFja2xlRGlyLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ29uZSBDaGVjazogV2lkZW5lZCB0byB+NjAgZGVncmVlcyAoZG90ID4gMC41KQogICAgICAgICAgICAgICAgICAgIC8vIFdhcyAwLjcgKH40NSBkZWcpLiBUaGlzIG1ha2VzIGxhbmRpbmcgdGFja2xlcyBlYXNpZXIuCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC41KSAvIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCnRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUYWNrbGUoZHgsIGR6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA4OyAvLyBSZWR1Y2VkIGZyb20gMTUgdG8gZW5jb3VyYWdlIGFnZ3Jlc3Npb24KICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgovLyBFeHBvcnQgdG8gZ2xvYmFsIHNjb3BlCiAgICB3aW5kb3cuZmx1eC5QbGF5ZXIgPSBQbGF5ZXI7Cn0pKCk7","/Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKd2luZG93LmZsdXguVGhyb3dDb25maWcgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7CiAgICAgICAgU1dJUEVfTUlOX1BYOiAyMCwKICAgICAgICBBSU1fRFhfU0NBTEU6IDEsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLAoKICAgICAgICBQT1dFUl9CQVNFOiAxLAogICAgICAgIFBPV0VSX1JBTkdFOiAwLjgsCiAgICAgICAgUE9XRVJfTUFYX0JPTlVTX1JBVElPOiAwLjk1LAogICAgICAgIFBPV0VSX01BWF9NVUxUSVBMSUVSOiAyLjUsCgogICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRDogMC4yNSwKICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxMDAwLAogICAgICAgIENVUlZFX1NQRUVEX01VTFQ6IDEuNSwKICAgICAgICBDVVJWRV9TUElOX0NBUDogMTUwMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMAogICAgfTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIG9iamVjdHMKICAgIGNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKICAgIC8vIC0tLSBORVc6IFJldGljbGUgVGV4dHVyZSBmb3IgUGFzcyBJbmRpY2F0b3IgLS0tCiAgICBjb25zdCBfcmV0aWNsZVRleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMjU2OyBjLmhlaWdodCA9IDI1NjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAxMjgsIGN5ID0gMTI4OwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDI1NiwyNTYpOwogICAgICAgIAogICAgICAgIC8vIEdsb3cKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICAvLyAxLiBPdXRlciBSaW5nIFNlZ21lbnRzCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA4OwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAKICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoaSAqIChNYXRoLlBJKjIpLzMpICsgMC4yOwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKGkrMSkgKiAoTWF0aC5QSSoyKS8zKSAtIDAuMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMTEwLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAyLiBJbm5lciBCcmFja2V0cwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGNvbnN0IHIgPSA2MDsKICAgICAgICBjb25zdCBsZW4gPSAyMDsKICAgICAgICAvLyBDb3JuZXJzCiAgICAgICAgY29uc3QgZHJhd0Nvcm5lciA9ICh4LCB5LCBkeCwgZHkpID0+IHsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKHgsIHktZHkqbGVuKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LCB5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyh4LWR4KmxlbiwgeSk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9OwogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3ktciwgLTEsIC0xKTsgLy8gVEwKICAgICAgICBkcmF3Q29ybmVyKGN4K3IsIGN5LXIsIDEsIC0xKTsgIC8vIFRSCiAgICAgICAgZHJhd0Nvcm5lcihjeCtyLCBjeStyLCAxLCAxKTsgICAvLyBCUgogICAgICAgIGRyYXdDb3JuZXIoY3gtciwgY3krciwgLTEsIDEpOyAgLy8gQkwKCiAgICAgICAgLy8gMy4gQ2VudGVyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CnRoaXMuYWNjZWxlcmF0aW9uID0gMTguMDsgLy8gU25hcHBpZXIgbW92ZW1lbnQgKHdhcyAxMi4wKQogICAgICAgICAgICB0aGlzLmRyYWcgPSAzLjA7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA4LjA7CiAgICAgICAgICAgIC8vIEJvbmUgcmVmZXJlbmNlIGZvciBob2xkaW5nIGJhbGwKICAgICAgICAgICAgdGhpcy5oYW5kQm9uZSA9IG51bGw7CiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgYW5pbWF0aW9uIGJvbmUgcmVmcyAoZmlsbGVkIGluIHNldE1lc2gpCiAgICAgICAgICAgIHRoaXMuYm9uZXMgPSB7CiAgICAgICAgICAgICAgICBoaXBzOiBudWxsLAogICAgICAgICAgICAgICAgc3BpbmU6IG51bGwsCiAgICAgICAgICAgICAgICBjaGVzdDogbnVsbCwKICAgICAgICAgICAgICAgIG5lY2s6IG51bGwsCiAgICAgICAgICAgICAgICBoZWFkOiBudWxsLAogICAgICAgICAgICAgICAgclVwcGVyQXJtOiBudWxsLAogICAgICAgICAgICAgICAgckZvcmVBcm06IG51bGwsCiAgICAgICAgICAgICAgICBySGFuZDogbnVsbCwKICAgICAgICAgICAgICAgIGxVcHBlckFybTogbnVsbCwKICAgICAgICAgICAgICAgIGxGb3JlQXJtOiBudWxsLAogICAgICAgICAgICAgICAgbEhhbmQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5fYm9uZUJhc2VRdWF0cyA9IG51bGw7IC8vIE9wdGlvbmFsIGZ1dHVyZSB1c2UKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0sCiAgICAgICAgICAgICAgICBibGluZDogMCwKICAgICAgICAgICAgICAgIHNpbGVuY2U6IDAsCiAgICAgICAgICAgICAgICBzaGllbGQ6IDAsCiAgICAgICAgICAgICAgICBoYXN0ZTogMCwKICAgICAgICAgICAgICAgIHNsb3c6IDAsCiAgICAgICAgICAgICAgICBidXJuOiAwLAogICAgICAgICAgICAgICAgc2hvY2s6IDAKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107Cgp0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbiA9IG51bGw7IC8vIHsgdHlwZTogJ2ZpcmUnfCdpY2UnfCd2b2x0JywgZHVyYXRpb246IG51bWJlciB9CgogICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgIHRoaXMuYmFzZUNvbG9ySGV4ID0gMHhmZmZmZmY7CiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25PZmZzZXQgPSAwOwogICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSA9IDEuMTc7IC8vIEluY3JlYXNlZCB+OCUKCiAgICAgICAgICAgIC8vIFJlYWwtdGltZSBTdGF0cwogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuc3RhdHMuRU47CiAgICAgICAgICAgIHRoaXMudGFja2xlUmFkaXVzID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMi41IHRvIHJlZHVjZSBzd2FybSBsb2NrCgogICAgICAgICAgICB0aGlzLnNwZWVkID0gNC4wOwogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIERhc2ggU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFRvdGFsVGltZSA9IDAuNTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gRmVlZGJhY2sgQWNjdW11bGF0b3JzCiAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgdGhpcy5fZGFtYWdlVGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gSFAgQmFyCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBudWxsOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbCA9IG51bGw7CgogICAgICAgICAgICAvLyBHYW1lcGxheSBGbG93IFRpbWVycwogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBCYW5raW5nICYgVmVydGljYWxpdHkKICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZID0gMDsKCiAgICAgICAgICAgIC8vIEVuY291bnRlciBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSBmYWxzZTsKdGhpcy5jbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMCwKICAgICAgICAgICAgICAgIGJsaW5kOiAwLAogICAgICAgICAgICAgICAgc2lsZW5jZTogMCwKICAgICAgICAgICAgICAgIHNoaWVsZDogMCwKICAgICAgICAgICAgICAgIGhhc3RlOiAwLAogICAgICAgICAgICAgICAgc2xvdzogMCwKICAgICAgICAgICAgICAgIGJ1cm46IDAsCiAgICAgICAgICAgICAgICBzaG9jazogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyID0gMDsgLy8gVGltZXIgZm9yIHN3aW0gc291bmQgZWZmZWN0cwogICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gMDsgLy8gQ29udGludW91cyBwcmVzc3VyZSBmYWN0b3IgKDAuMCB0byAxLjApCgogICAgICAgICAgICAvLyAtLS0gSlVJQ0U6IFZpc3VhbCBGZWVkYmFjayAtLS0KICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDEsIDEpOwogICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIUCBCYXIgRlggU3RhdGUKICAgICAgICAgICAgdGhpcy5ocFNoYWtlID0gMDsKICAgICAgICAgICAgdGhpcy5ocEZsYXNoID0gMDsKCgovLyAtLS0gTkVXOiBFdmFzaW9uICYgQ2hhcmdlZCBUYWNrbGUgLS0tCiAgICAgICAgICAgIHRoaXMuaXNFdmFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZXZhZGVUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5ldmFkZUNvb2xkb3duID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUgPSAxLjU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlQm9udXMgPSAwOwoKICAgICAgICAgICAgLy8gLS0tIE5FVzogVGFja2xlIE1lY2hhbmljcyAoUGhhc2UgMSkgLS0tCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlY292ZXJ5VGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIE5FVzogQmxvY2tpbmcgLS0tCiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgc3luY1JvdGF0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBldWxlciA9IG5ldyBUSFJFRS5FdWxlcigpLnNldEZyb21RdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uLCAnWVhaJyk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IGV1bGVyLnkgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgIH0KCmdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQmxvY2tpbmcgQm9udXMKICAgICAgICAgICAgaWYgKHRoaXMuaXNCbG9ja2luZyAmJiBuYW1lID09PSAnQkwnKSB7CiAgICAgICAgICAgICAgICB2YWwgKj0gMi4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICBhcHBseVN0YXR1cyh0eXBlLCBkdXJhdGlvbiwgc3ViVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0FjdGl2ZSA9IHRoaXMuc3RhdHVzLnZlbm9tID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy52ZW5vbSwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSBwb2lzb25lZCFgKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xFRVAiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJyAmJiBzdWJUeXBlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdIHx8IDA7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBjdXJyZW50VmFsID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW3N1YlR5cGVdID0gTWF0aC5tYXgoY3VycmVudFZhbCwgZHVyYXRpb24pOwoKICAgICAgICAgICAgICAgIGlmICghd2FzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB3aXRoZXJlZCAke3N1YlR5cGV9IWApOwppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFdJVEhFUiAke3N1YlR5cGV9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdibGluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJsaW5kID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuYmxpbmQsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTElORCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2lsZW5jZSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnNpbGVuY2UsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0UiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hpZWxkID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2hpZWxkLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2hhc3RlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5oYXN0ZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2xvdyA9IDA7IC8vIE92ZXJ3cml0ZSBzbG93CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJIQVNURSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zbG93ID0gTWF0aC5tYXgodGhpcy5zdGF0dXMuc2xvdywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuaGFzdGUgPSAwOyAvLyBPdmVyd3JpdGUgaGFzdGUKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMT1ciLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnVybicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLmJ1cm4gPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5idXJuLCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCVVJOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2NrJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuc2hvY2sgPSBNYXRoLm1heCh0aGlzLnN0YXR1cy5zaG9jaywgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hPQ0siLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl91cGRhdGVEZXJpdmVkU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHNwID0gdGhpcy5nZXRTdGF0KCdTUCcpOwp0aGlzLm1heFNwZWVkID0gNi4wICsgKHNwIC8gMTUuMCk7IC8vIEluY3JlYXNlZCBiYXNlIHNwZWVkICh3YXMgNS4wKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICB9CgogICAgICAgIHNldE1lc2goc291cmNlTWVzaCwgYW5pbWF0aW9ucykgewogICAgICAgICAgICB0aGlzLm1lc2ggPSBzb3VyY2VNZXNoOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwp0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVTdGF0dXNSaW5nKCk7IC8vIE5FVzogU3RhdHVzIFJpbmcKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQXVyYSgpOwogICAgICAgICAgICB0aGlzLl9jcmVhdGVBdXJhKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZVBhc3NUYXJnZXRJbmRpY2F0b3IoKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBDaGFyYWN0ZXIgU2NhbGluZwogICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNjsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgdGhpcy5iYXNlU2NhbGUgPSAxLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgdGhpcy5tZXNoLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2ggJiYgbm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gKG5vZGUubmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29yZSBzcGluZS9oZWFkIGNoYWluIChNaXhhbW8tZnJpZW5kbHkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhpcHMgJiYgbmFtZS5pbmNsdWRlcygnaGlwcycpKSB0aGlzLmJvbmVzLmhpcHMgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5zcGluZSAmJiBuYW1lLmluY2x1ZGVzKCdzcGluZScpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZTInKSAmJiAhbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSB0aGlzLmJvbmVzLnNwaW5lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuY2hlc3QgJiYgKG5hbWUuaW5jbHVkZXMoJ2NoZXN0JykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmUyJykgfHwgbmFtZS5pbmNsdWRlcygnc3BpbmVfMicpKSkgdGhpcy5ib25lcy5jaGVzdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLm5lY2sgJiYgbmFtZS5pbmNsdWRlcygnbmVjaycpKSB0aGlzLmJvbmVzLm5lY2sgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5oZWFkICYmIG5hbWUuaW5jbHVkZXMoJ2hlYWQnKSkgdGhpcy5ib25lcy5oZWFkID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNSaWdodCA9IG5hbWUuaW5jbHVkZXMoJ3JpZ2h0JykgfHwgbmFtZS5lbmRzV2l0aCgncicpIHx8IG5hbWUuaW5jbHVkZXMoJ19yJykgfHwgbmFtZS5pbmNsdWRlcygnLnInKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0xlZnQgID0gbmFtZS5pbmNsdWRlcygnbGVmdCcpICB8fCBuYW1lLmVuZHNXaXRoKCdsJykgfHwgbmFtZS5pbmNsdWRlcygnX2wnKSB8fCBuYW1lLmluY2x1ZGVzKCcubCcpOwoKICAgICAgICAgICAgICAgICAgICAvLyBBcm1zL2hhbmRzIChNaXhhbW86IG1peGFtb3JpZ1JpZ2h0QXJtL1JpZ2h0Rm9yZUFybS9SaWdodEhhbmQpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnJVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRhcm0nKSB8fCAoaXNSaWdodCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMuclVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ3JpZ2h0Zm9yZWFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ2ZvcmVhcm0nKSkpKSB0aGlzLmJvbmVzLnJGb3JlQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuckhhbmQgJiYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgaXNSaWdodCkgfHwgbmFtZS5pbmNsdWRlcygncmlnaHRoYW5kJykpKSB0aGlzLmJvbmVzLnJIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxVcHBlckFybSAmJiAobmFtZS5pbmNsdWRlcygnbGVmdGFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygndXBwZXJhcm0nKSkpKSB0aGlzLmJvbmVzLmxVcHBlckFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxGb3JlQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0Zm9yZWFybScpIHx8IChpc0xlZnQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMubEZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5sSGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc0xlZnQpIHx8IG5hbWUuaW5jbHVkZXMoJ2xlZnRoYW5kJykpKSB0aGlzLmJvbmVzLmxIYW5kID0gbm9kZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQmFjay1jb21wYXQ6IGJhbGwgYXR0YWNobWVudCB1c2VzIGhhbmRCb25lCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhbmRCb25lICYmIHRoaXMuYm9uZXMuckhhbmQpIHRoaXMuaGFuZEJvbmUgPSB0aGlzLmJvbmVzLnJIYW5kOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIGlmIChhbmltYXRpb25zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBfbm9ybUNsaXBOYW1lID0gKHMpID0+IChzIHx8ICcnKQogICAgICAgICAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tfXC1dKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xzKy9nLCAnICcpCiAgICAgICAgICAgICAgICAgICAgLnRyaW0oKTsKCiAgICAgICAgICAgICAgICAvLyBIZWxwZXIgdG8gc3RyaXAgbGVnIHRyYWNrcyBmcm9tIGFjdGlvbiBjbGlwcwogICAgICAgICAgICAgICAgY29uc3QgX3N0cmlwTGVncyA9IChjbGlwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tzID0gW107CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVnZXggdG8gbWF0Y2ggbGVnIGJvbmVzIChNaXhhbW8gc3R5bGU6IFJpZ2h0VXBMZWcsIFJpZ2h0TGVnLCBSaWdodEZvb3QsIFJpZ2h0VG9lQmFzZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBnZW5lcmljICJMZWciLCAiRm9vdCIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0Lm5hbWUubWF0Y2goLyhVcExlZ3xMZWd8Rm9vdHxUb2UpL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja3MucHVzaCh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGNsaXAudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGlwOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBhbmltYXRpb25zLmZvckVhY2goKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gX25vcm1DbGlwTmFtZShjbGlwLm5hbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsZXQgaXNMb2NvbW90aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGlvbktleSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDb3JlIGxvY29tb3Rpb24gLS0tCiAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvdHJlYWR8dHJlYWRpbmd8aWRsZXxmbG9hdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvZGFzaHxzcHJpbnR8YnVyc3R8ZmFzdFxzKnN3aW18c3dpbVxzKmZhc3QvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnZGFzaCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3N3aW0nOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIGFjdGlvbktleSA9ICd0aHJvd19zaG90JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzKC9wYXNzLykpIGFjdGlvbktleSA9ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAndGhyb3cnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIGFjdGlvbktleSA9ICdjYXRjaF9qdW1wJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb25LZXkgPSAnY2F0Y2gnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gSGl0IC8gUmVhY3QgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3JlYWN0fGhpdHxodXJ0fGRhbWFnZXxzdGFnZ2VyfGtub2NrLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3JlYWN0JzsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjaGFyZ2UnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90YWNrbGV8Y2hlY2t8cmFtLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ3RhY2tsZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Jsb2NrfHNhdmUvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdjZWxlYnJhdGUnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9IGNsaXAubmFtZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFN0cmlwIGxlZ3MgZnJvbSBub24tbG9jb21vdGlvbiBjbGlwcyB0byBhbGxvdyB0cmVhZGluZyB3YXRlciBvdmVybGF5CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0xvY29tb3Rpb24gJiYgYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zdHJpcExlZ3MoY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1thY3Rpb25LZXldID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdGFydCBkZWZhdWx0IGxvY29tb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uc1snaWRsZSddKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKCdpZGxlJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjawogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbGlzdGVuZXIKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIuYWRkRXZlbnRMaXN0ZW5lcignZmluaXNoZWQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5hY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgZmluaXNoZWQgYWN0aW9uIGlzIG91ciBjdXJyZW50IG9uZS1zaG90CiAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWN0aW9uID09PSB0aGlzLmFjdGl2ZU9uZVNob3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gbG9jb21vdGlvbiB1cGRhdGVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbSgwLjE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBOZXcgbWV0aG9kIGZvciBiYXNlIGxheWVyIChsZWdzL2JvZHkgbW92ZW1lbnQpCiAgICAgICAgcGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgY29uc3QgbmV3QWN0aW9uID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdOwogICAgICAgICAgICBpZiAoIW5ld0FjdGlvbiB8fCBuZXdBY3Rpb24gPT09IHRoaXMuYWN0aXZlTG9jb21vdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlTG9jb21vdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uLmZhZGVPdXQoZHVyYXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbihkdXJhdGlvbik7CiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlTG9jb21vdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5fbGFzdExvY29tb3Rpb24gPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgLy8gT3ZlcmhhdWxlZCBwbGF5IG1ldGhvZCB0byBoYW5kbGUgbGF5ZXJpbmcKICAgICAgICBwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIC8vIElmIGl0J3MgYSBsb2NvbW90aW9uIHN0YXRlLCByb3V0ZSB0byBwbGF5TG9jb21vdGlvbgogICAgICAgICAgICBpZiAoWydpZGxlJywgJ3N3aW0nLCAnZGFzaCddLmluY2x1ZGVzKGFjdGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlMb2NvbW90aW9uKGFjdGlvbk5hbWUsIGR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHRyZWF0IGFzIGFuIGFjdGlvbiBsYXllcgogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGFuIGFjdGl2ZSBvbmUtc2hvdCwgZmFkZSBpdCBvdXQKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlT25lU2hvdCAmJiB0aGlzLmFjdGl2ZU9uZVNob3QgIT09IG5ld0FjdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90LmZhZGVPdXQoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oMC4xKTsgLy8gRmFzdCB0cmFuc2l0aW9uIGZvciBhY3Rpb25zCiAgICAgICAgICAgIG5ld0FjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QgPSBuZXdBY3Rpb247CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBhY3Rpb25OYW1lOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUxvY29tb3Rpb25BbmltKGR1cmF0aW9uID0gMC4yKSB7CiAgICAgICAgICAgIC8vIE5vdGU6IFdlIE5PIExPTkdFUiBjaGVjayBfYW5pbUxvY2tlZCBoZXJlLgogICAgICAgICAgICAvLyBMb2NvbW90aW9uIHNob3VsZCB1cGRhdGUgY29udGludW91c2x5IGJhc2VkIG9uIHNwZWVkLCAKICAgICAgICAgICAgLy8gcnVubmluZyB1bmRlcm5lYXRoIHRoZSB1cHBlciBib2R5IGFjdGlvbi4KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KHZ4ICogdnggKyB2eiAqIHZ6KTsKCiAgICAgICAgICAgIC8vIFNtb290aCBzcGVlZAogICAgICAgICAgICBjb25zdCBzbW9vdGhLID0gMS4wIC0gTWF0aC5wb3coMC4wMDEsIGR1cmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5fc21vb3RoZWRTcGVlZCArPSAoc3BlZWQgLSB0aGlzLl9zbW9vdGhlZFNwZWVkKSAqIHNtb290aEs7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXMKICAgICAgICAgICAgY29uc3QgZW50ZXJNb3ZlID0gMC4xODsKICAgICAgICAgICAgY29uc3QgZXhpdE1vdmUgPSAwLjEwOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRNb3ZpbmcgPSB0aGlzLmlucHV0VmVjdG9yICYmIHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMDY7CiAgICAgICAgICAgIGNvbnN0IHZlbE1vdmluZyA9IHRoaXMuX3Ntb290aGVkU3BlZWQgPiAodGhpcy5fbW92aW5nTGF0Y2ggPyBleGl0TW92ZSA6IGVudGVyTW92ZSk7CgogICAgICAgICAgICB0aGlzLl9tb3ZpbmdMYXRjaCA9IGlucHV0TW92aW5nIHx8IHZlbE1vdmluZzsKCiAgICAgICAgICAgIGxldCB0YXJnZXQgPSB0aGlzLl9tb3ZpbmdMYXRjaCA/ICdzd2ltJyA6ICdpZGxlJzsKICAgICAgICAgICAgaWYgKHRoaXMuX21vdmluZ0xhdGNoICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBVcGRhdGUgcGxheWJhY2sgcmF0ZQogICAgICAgICAgICBjb25zdCBhcHBseVJhdGUgPSAoa2V5KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKCiAgICAgICAgICAgICAgICAvLyBIYXN0ZS9TbG93IEFuaW1hdGlvbiBTY2FsaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuaGFzdGUgPiAwKSBhLnRpbWVTY2FsZSAqPSAxLjU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2xvdyA+IDApIGEudGltZVNjYWxlICo9IDAuNjsKfTsKCmFwcGx5UmF0ZSh0YXJnZXQpOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1t0YXJnZXRdOwogICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgeyBhLnNldExvb3AoVEhSRUUuTG9vcFJlcGVhdCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5TG9jb21vdGlvbih0YXJnZXQsIGR1cmF0aW9uKTsKfQoKICAgICAgICBwbGF5T25lU2hvdChhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuMSwgb3B0cyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gYWN0aW9uTmFtZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgYS5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnRpbWVTY2FsZSA9IChvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICB9IGNhdGNoIChfKSB7fQoKICAgICAgICAgICAgLy8gVXNlIHRoZSBuZXcgcGxheSBtZXRob2Qgd2hpY2ggaGFuZGxlcyBsYXllcmluZwogICAgICAgICAgICB0aGlzLnBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHNldElucHV0KHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW5wdXRWZWN0b3Iuc2V0KHgsIDAsIHopOwogICAgICAgIH0KYXBwbHlFeHRlcm5hbEZvcmNlKHZlYykgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHZlYyk7CiAgICAgICAgfQogICAgICAgIHJlY2VpdmVCYWxsKCkgewogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFJlc2V0IHN0YXRlcyB0aGF0IG1pZ2h0IHByZXZlbnQgc2hvb3RpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAyLjA7Cgpjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlciAhPT0gdGhpcykgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5FeHAoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxZID0gKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgPyB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi55IDogMDsKICAgICAgICAgICAgY29uc3QgY2F0Y2hLZXkgPSAoYmFsbFkgPiAwLjI1ICYmIHRoaXMuYWN0aW9uc1snY2F0Y2hfanVtcCddKSA/ICdjYXRjaF9qdW1wJyA6ICdjYXRjaCc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSlVJQ0U6IENhdGNoIFNxdWFzaAogICAgICAgICAgICB0aGlzLnNxdWFzaCgxLjEsIDAuOSwgMS4xKTsgLy8gU2xpZ2h0IGNvbXByZXNzaW9uIG9uIGNhdGNoCgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU05BUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgppZiAoKHRoaXMuc3RhdHVzLnZlbm9tID4gMCB8fCB0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCi8vIFNuYXBwaWVyIHRocm93czogRHJhc3RpY2FsbHkgcmVkdWNlZCB3aW5kdXAgdGltZXMgZm9yIGluc3RhbnQgcmVzcG9uc2UKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAyMDsgCiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAzLjA7IAoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSA2MDsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSA1LjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDI1MDsgCiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCiAgICAgICAgICAgIHRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBUaHJvdyBTdHJldGNoCiAgICAgICAgICAgIHRoaXMuc3F1YXNoKDAuOCwgMS4yLCAwLjgpOyAvLyBTdHJldGNoIG9uIHJlbGVhc2UKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEb3QgPSBmaW5hbERpci5kb3QoZ29hbERpcik7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAyLCBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvR29hbCA9IGdvYWxQb3MuY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXNzaXN0RmFjdG9yID0gTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjEsIHNoIC8gMTAwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3Npc3RGYWN0b3IgKj0gMC4xOwogICAgICAgICAgICAgICAgICAgICAgICB9CgppZiAoZ29hbERvdCA+IDAuMiAmJiB0aGlzLnN0YXR1cy5ibGluZCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmQgZGlzYWJsZXMgYXNzaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuYmxpbmQgPiAwKSBhc3Npc3RGYWN0b3IgPSAwOwoKZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CmNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKLy8gQmxpbmQgUmFuZG9taXphdGlvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5ibGluZCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC40OwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuODsKICAgICAgICAgICAgICAgICAgICB9CgpmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRUxFTUVOVEFMIElORlVTSU9OIElOSkVDVElPTgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uICYmIHRoaXMuZWxlbWVudGFsSW5mdXNpb24uZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGVjaFBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHRlY2ggc2VsZWN0ZWQsIGluZnVzaW9uIGJlY29tZXMgdGhlIHRlY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGUsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24odGhpcy5lbGVtZW50YWxJbmZ1c2lvbi50eXBlLnRvVXBwZXJDYXNlKCkgKyAiIFNIT1QiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0ZWNoIGV4aXN0cyAoZS5nLiBKZWNodCBTaG90KSwgYWRkIGVsZW1lbnQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoUGF5bG9hZCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGVjaE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgUmVjb2lsCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY29pbEZvcmNlID0gKHR5cGUgPT09ICdTSCcgPyAyLjUgOiAxLjApICogKHBvd2VyTXVsdGlwbGllciB8fCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIHJlY29pbEZvcmNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci55ICogcmVjb2lsRm9yY2UgKiAwLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLWZpbmFsRGlyLnogKiByZWNvaWxGb3JjZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSBncmFjZSBwZXJpb2QgZm9yIEdvYWxpZSB0byBwcmV2ZW50IHBvaW50LWJsYW5rIGludGVyY2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGwuY2F0Y2hHcmFjZVBlcmlvZCA9IDAuNjsgLy8gMC42cyBpbW11bml0eSAoYXBwcm94IDEwLTEybSB0cmF2ZWwpCiAgICAgICAgICAgICAgICAgICAgfQoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdG9NYXRlID0gbWF0ZS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSBhaW1EaXIuZG90KHRvTWF0ZSk7CgogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gKGRvdCAqIDEwKSAtIChkaXN0ICogMC4xKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgogICAgICAgICAgICAvLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTT1VORDogQ2hhcmdlIFVwCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gVXNlIGEgc3ludGhlc2l6ZWQgY2hhcmdlIHNvdW5kIGlmICdjaGFyZ2UnIHNmeCBpc24ndCBsb2FkZWQKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnY2hhcmdlJywgeyB2b2x1bWU6IDAuNCwgcmF0ZTogMS4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVJbnB1dCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBQb3dlciBDYWxjdWxhdGlvbgogICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZyB8fCB7fTsKCiAgICAgICAgICAgIC8vIEJhc2UgbXVsdGlwbGllciAoZGVmYXVsdHM6IDEuMCB0byAxLjgpCiAgICAgICAgICAgIGxldCBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX0JBU0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX0JBU0UgOiAxLjApICsgKHJhdGlvICogKFRDLlBPV0VSX1JBTkdFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9SQU5HRSA6IDAuOCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRGV0ZWN0IExPQiAoVmVydGljYWwgVXAgU3dpcGUpCi8vIERldGVjdCBMT0IgKFZlcnRpY2FsIFVwIFN3aXBlKQogICAgICAgICAgICBsZXQgaXNMb2IgPSBmYWxzZTsKICAgICAgICAgICAgLyogRElTQUJMRUQ6IFVzZXIgZmVlZGJhY2sgaW5kaWNhdGVzIGFjY2lkZW50YWwgdHJpZ2dlcnMgcHJldmVudGluZyBmb3J3YXJkIHRocm93cy4KICAgICAgICAgICAgaWYgKGR5IDwgLTgwICYmIE1hdGguYWJzKGR4KSA8IE1hdGguYWJzKGR5KSAqIDAuNikgewogICAgICAgICAgICAgICAgaXNMb2IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMT0IhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICovCgogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIC8vIEZvcm11bGE6IEN1cnZlID0gSW50ZW5zaXR5ICogU3BlZWQKICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChUQy5DVVJWRV9FTkFCTEVEICE9PSBmYWxzZSkgJiYgY3VydmVJbnB1dCAmJiBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSkgPiAoVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCA6IDAuMjUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCByYXdJbnRlbnNpdHkgPSBNYXRoLmFicyhjdXJ2ZUlucHV0LmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsgLy8gUG9zaXRpdmUgPSBSaWdodCBIdW1wID0gTGVmdCBDdXJ2ZQogICAgICAgICAgICAgICAgY29uc3Qgc3dpcGVTcGVlZCA9IGN1cnZlSW5wdXQuc3BlZWQgfHwgMS4wOwoKICAgICAgICAgICAgICAgIC8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoc3Bpbk1hZyA+IChUQy5DVVJWRV9QRVJGRUNUX1NQSU4gIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiA6IDUwMC4wKSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiUEVSRkVDVCBDVVJWRSIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkUm9sbEltcHVsc2Uoc2lnbiAqIC0wLjMpOyAvLyBUaWx0IGNhbWVyYSBpbnRvIHRoZSBjdXJ2ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90R29hbCA9IGFpbVZlYy5kb3QoZ29hbERpcik7CgpsZXQgdHlwZSA9ICdQQSc7CiAgICAgICAgICAgIGlmIChpc0xvYikgewogICAgICAgICAgICAgICAgdHlwZSA9ICdMT0InOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ1NIJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUsIG11bHRpcGxpZXIsIHNwaW5WZWMpOwogICAgICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbChjb29sZG93biA9IDEuMCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmZvcmNlIGNvb2xkb3duIHRvIHByZXZlbnQgaW5zdGFudCByZS1ncmFiCiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IGNvb2xkb3duOwogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNhZmV0eTogTmFOIENoZWNrCiAgICAgICAgICAgIGlmIChpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueCkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnkpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi56KSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJQbGF5ZXIgcG9zaXRpb24gTmFOIGRldGVjdGVkLiBSZXNldHRpbmcuIiwgdGhpcy5yb2xlKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uIHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU1lOQyBGSVg6IElmIGJhbGwgdGhpbmtzIEkgaG9sZCBpdCwgYnV0IEkgZG9uJ3QsIGZvcmNlIHJlY2VpdmUKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyID09PSB0aGlzICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3luY2luZyBiYWxsIHBvc3Nlc3Npb24gdG8gcGxheWVyIik7CiAgICAgICAgICAgICAgICB0aGlzLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmlzR29kTW9kZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYyAoUGh5c2ljcyBwYXJ0IC0gVGltZXIpCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgcGh5c2ljcyBwcm9wcyB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBhbHRlcmVkCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIHJlc2V0IGhhcHBlbnMgaW4gdXBkYXRlVmlzdWFscwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFyZ2VUaW1lID4gMy4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZUNoYXJnZSgwLCAwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuZXZhZGVDb29sZG93biA+IDApIHRoaXMuZXZhZGVDb29sZG93biAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duIDw9IDApIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFdmFzaW9uIExvZ2ljIChTcGluIE1vdmUpCiAgICAgICAgICAgIGlmICh0aGlzLmlzRXZhZGluZykgewogICAgICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdmlzdWFsIGhhbmRsZWQgaW4gdXBkYXRlVmlzdWFscywgYnV0IHdlIGFwcGx5IG1vdmVtZW50IGhlcmUKICAgICAgICAgICAgICAgIC8vIEZyaWN0aW9ubGVzcyBtb3ZlbWVudCBkdXJpbmcgZXZhZGUKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBkcmFnCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTUpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmV2YWRlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0V2YWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNSk7IC8vIFNsb3cgZG93biBhZnRlciBzcGluCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47IC8vIFNraXAgbm9ybWFsIHBoeXNpY3MKICAgICAgICAgICAgfQoKLy8gVGFja2xlIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAvLyBBdXRvLXJlbGVhc2UgaWYgaGVsZCB0b28gbG9uZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGFja2xlQ2hhcmdlVGltZSA+IHRoaXMubWF4VGFja2xlQ2hhcmdlVGltZSArIDAuNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZVRhY2tsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFRBQ0tMRSBTVEFURSAoU2xpZGUgJiBDb21taXQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1RhY2tsaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZVRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3M6IEhpZ2ggRHJhZyAoU2xpZGUgdG8gc3RvcCkKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDMuMCAqIGR0KSkpOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKCiAgICAgICAgICAgICAgICAvLyBDb2xsaXNpb24gQ2hlY2sKICAgICAgICAgICAgICAgIC8vIENvbGxpc2lvbiBDaGVjawogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5faGFzSGl0VGFja2xlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBIaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzVGFja2xpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuMSk7IC8vIFN0b3AgbW9tZW50dW0KICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvdmVyeVRpbWUgPSAwLjU7IC8vIFF1aWNrIHJlY292ZXJ5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFja2xlVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWlzc2VkIFRhY2tsZSAoV2hpZmYpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1JlY292ZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lID0gMS42OyAvLyBQdW5pc2htZW50IChTdHVtYmxlKQogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3JlYWN0JywgMC4yKTsgLy8gU3R1bWJsZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNSVNTIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFJFQ09WRVJZIFNUQVRFIChTdHVtYmxlL1B1bmlzaG1lbnQpIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVjb3ZlcnlUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjkpOyAvLyBIZWF2eSBmcmljdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVjb3ZlcnlUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUmVjb3ZlcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAppZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gMDsgLy8gUmVzZXQgY2hhcmdlIGJvbnVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7Cl9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFkgcG9zaXRpb24gY2FsY3VsYXRpb24gaXMgdmlzdWFsL3BoeXNpY3MgaHlicmlkLCBrZWVwaW5nIGhlcmUgZm9yIGNvbGxpc2lvbiBjb25zaXN0ZW5jeQogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5QXJlbmFCb3VuZGFyeShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gT3JwaGFuZWQgZWxzZSBibG9jayByZW1vdmVkCgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOyAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7Ci8vIFZlcnRpY2FsIERyYWcgKEVudmlyb25tZW50IGF3YXJlKQogICAgICAgICAgICBjb25zdCB2RHJhZyA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIpIAogICAgICAgICAgICAgICAgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSICogOC4wIAogICAgICAgICAgICAgICAgOiAyLjA7CnRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAodkRyYWcgKiBkdCkpOwogICAgICAgIH0KICAgIH0KICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVMb2NvbW90aW9uQW5pbShkdCk7IC8vIEFuaW1hdGlvbiBzdGF0ZSBsb2dpYyBkcml2ZW4gYnkgcGh5c2ljcyBzdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDAgJiYgdGhpcy5zdHVuVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExldml0YXRpb24KICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGFrZSA9IDAuMDUgKyAoMC4xICogcmF0aW8pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYW5raW5nQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKHJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscyBpZiBjaGFyZ2UgY2FuY2VsbGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBEYXNoIFZpc3VhbHMgKFBhcnRpY2xlcyAmIExlYW4pCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2subGVuZ3RoU3EoKSA8IDAuMSkgYmFjay5zZXQoMCwgMCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMi4wICsgTWF0aC5yYW5kb20oKSwgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LCBtb21lbnR1bVNjYWxlOiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KCl9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucm90YXRpb24ueSArPSAyNS4wICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRyYWlsCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdkYXNoX3N0cmVhbScsIHBvcywgeyBzY2FsZTogMS4wLCBsaWZlOiAwLjIgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgovLyBUYWNrbGUgQ2hhcmdlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuaXNUYWNrbGVDaGFyZ2luZykgewogICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLnRhY2tsZUNoYXJnZVRpbWUgLyB0aGlzLm1heFRhY2tsZUNoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAvLyBTaGFrZSBtZXNoCi8vIFJlZCB0aW50IHB1bHNlCiAgICAgICAgICAgICAgICBjb25zdCBwdWxzZSA9IE1hdGguc2luKERhdGUubm93KCkgKiAwLjAyKSAqIDAuNSArIDAuNTsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IubGVycENvbG9ycyhlbnRyeS5iYXNlQ29sb3IsIG5ldyBUSFJFRS5Db2xvcigweGZmMDAwMCksIDAuNSAqIHB1bHNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIEhFUkNVTEVBTjogR2F0aGVyIFBhcnRpY2xlcwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjMpIHsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGluIGEgc3BoZXJlIGFyb3VuZCBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IDIuMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IE1hdGguYWNvcygyICogTWF0aC5yYW5kb20oKSAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gciAqIE1hdGguc2luKHBoaSkgKiBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSByICogTWF0aC5zaW4ocGhpKSAqIE1hdGguc2luKHRoZXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IHIgKiBNYXRoLmNvcyhwaGkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoeCwgeSArIDEuMCwgeikpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4wLCAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSB0b3dhcmRzIGNlbnRlcgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2ZWwgPSBjZW50ZXJQb3Muc3ViKHNwYXduUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig0LjApOyAvLyBTdWNrIGluIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZ2F0aGVyJywgc3Bhd25Qb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogdmVsLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMS41LApjb2xvcjogMHhmZjAwMDAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVGFja2xpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGRlbnNpdHkgdHJhaWwKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMC44OwogICAgICAgICAgICAgICAgICAgIC8vIE9mZnNldCBzbGlnaHRseSBiZWhpbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgcG9zLmFkZChiYWNrKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLjUsIAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmNDQwMCAvLyBGaWVyeSBvcmFuZ2UgdHJhaWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaWRlIHN0cmVhbXMKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZVBvcyA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWRlUG9zLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZVBvcy55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVQb3MueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZGFzaF9zdHJlYW0nLCBzaWRlUG9zLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmFhMDAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQplbHNlIGlmICh0aGlzLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC41ICsgMC41OwogICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKSwgMC41ICogcHVsc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgLy8gUmVzZXQgY29sb3IgaWYgbm90IGNoYXJnaW5nL2Rhc2hpbmcvZmxhc2hpbmcvYmxvY2tpbmcKICAgICAgICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzLmZvckVhY2goZW50cnkgPT4gewogICAgICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdHVuL05hcCBWaXN1YWwgUmVzZXQKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcpIHRoaXMucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgIH0KCnRoaXMuX3VwZGF0ZUhQQmFyKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzUmluZyhkdCk7IC8vIE5FVzogVXBkYXRlIFJpbmcKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDEuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICAgICAgICAgIG9mZnNldC55ID0gMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGUnLCB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4yNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjIKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbU9mZnNldCA9IGJhY2tEaXIuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjUgKyBNYXRoLnJhbmRvbSgpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnkgPSAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuODsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtT2Zmc2V0LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSowLjg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3dpbSBTb3VuZCBFZmZlY3QgTG9naWMKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAyLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ3N3aW0nICYmICF0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5fc3dpbVNmeFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N3aW1TZnhUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYXkgc3dpbSBzb3VuZCB3aXRoIHNsaWdodCBwaXRjaCB2YXJpYW5jZQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC4zLCB2YXJpYW5jZTogMC4yIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB0aW1lciAoMC40cyB0byAwLjdzIGludGVydmFsKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3N3aW1TZnhUaW1lciA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zd2ltU2Z4VGltZXIgPSAwOyAvLyBSZXNldCBpZiBzdG9wcGVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KICAgICAgICBfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgICAgICAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgICAgICAgICAgdGhpcy5fcHJvY0FuaW1UaW1lICs9IGR0OwoKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuYm9uZXM7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKCiAgICAgICAgICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gQnVpbGQgYSBkZXNpcmVkIHdvcmxkLXNwYWNlIGRpcmVjdGlvbiB3ZSB3YW50IHRoZSB0b3Jzby9oZWFkIHRvIGJpYXMgdG93YXJkLgogICAgICAgICAgICAvLyBOT1RFOiBXZSBhcHBseSB0aGlzIEFGVEVSIHRoZSBhbmltYXRpb24gbWl4ZXIgaGFzIHBvc2VkIGJvbmVzLCBhcyBhIHNtYWxsIGFkZGl0aXZlIG9mZnNldC4KICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBBaW0gZGlyZWN0aW9uIChwcmVmZXIgZXhwbGljaXQgYWltIHZlY3RvcikKICAgICAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5sb2NrZWRBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA4KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGhlIGJhbGwgaWYgaXQncyBpbiB0aGUgImF3YXJlbmVzcyIgcmFkaXVzCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnN1YlZlY3RvcnMoYmFsbC5tZXNoLnBvc2l0aW9uLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29udmVydCB0aGUgZGlyZWN0aW9uIGludG8gdGhlIHBsYXllcidzIGxvY2FsIHNwYWNlIHNvIHlhdy9waXRjaCBhcmUgc3RhYmxlLgogICAgICAgICAgICBfcEludlF1YXQuY29weSh0aGlzLm1lc2gucXVhdGVybmlvbikuaW52ZXJ0KCk7CiAgICAgICAgICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgbHggPSBfcFZlYy54LCBseSA9IF9wVmVjLnksIGx6ID0gX3BWZWMuejsKICAgICAgICAgICAgY29uc3QgeWF3ID0gTWF0aC5hdGFuMihseCwgbHopOwogICAgICAgICAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICAgICAgICAgIGNvbnN0IHlhd0MgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoeWF3LCAtMC45LCAwLjkpOwogICAgICAgICAgICBjb25zdCBwaXRjaEMgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAocGl0Y2gsIC0wLjYsIDAuNik7CgogICAgICAgICAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgICAgICAgICAgY29uc3QgYWltVyA9ICh0aGlzLmhhc0JhbGwgPyAodGhpcy5pc0NoYXJnaW5nID8gMS4wIDogMC42NSkgOiAwLjM1KSAqICgxLjAgLSAwLjM1ICogc3BlZWROb3JtKTsKICAgICAgICAgICAgY29uc3QgaGVhZFcgPSAodGhpcy5oYXNCYWxsID8gMC41NSA6IDAuNzUpICogKDEuMCAtIDAuMjUgKiBzcGVlZE5vcm0pOwoKICAgICAgICAgICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICAgICAgICAgIGlmIChiLmNoZXN0KSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yMCAqIGFpbVcsIHlhd0MgKiAwLjM1ICogYWltVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5jaGVzdC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5zcGluZSkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuc3BpbmUucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIZWFkL25lY2sgbG9vawogICAgICAgICAgICBpZiAoYi5uZWNrKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLm5lY2sucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChiLmhlYWQpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjMwICogaGVhZFcsIHlhd0MgKiAwLjU1ICogaGVhZFcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuaGVhZC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiAhdGhpcy5fYW5pbUxvY2tlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuX3Byb2NBbmltVGltZTsKICAgICAgICAgICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgICAgICAgICAgY29uc3Qgc3dheSA9IE1hdGguc2luKHQgKiA1LjApICogMC4wNSAqICgwLjUgKyBsaWZ0KTsKCiAgICAgICAgICAgICAgICBjb25zdCByYWlzZVggPSAtMC41NSAqIGxpZnQgKyBzd2F5OwogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICAgICAgICAgIGlmIChiLnJVcHBlckFybSkgewogICAgICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KHJhaXNlWCwgeWF3QyAqIDAuMTAgKiBsaWZ0LCByYWlzZVopOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5yVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtMC4zNSAqIGxpZnQgKyBzd2F5ICogMC41LCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvdW50ZXJiYWxhbmNlIGxlZnQgYXJtIHNsaWdodGx5IGZvciBhIG1vcmUgZHluYW1pYyBzaWxob3VldHRlCiAgICAgICAgICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgwLjE1ICogbGlmdCwgLXlhd0MgKiAwLjA1ICogbGlmdCwgMC4xNSAqIGxpZnQpOwogICAgICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CiAgICAgICAgfQoKX3VwZGF0ZVN0YXR1c0xvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIEhQIFJlZ2VuZXJhdGlvbiAoV2hlbiBub3QgaG9sZGluZyBiYWxsIGFuZCBub3QgcG9pc29uZWQpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFTiBSZWdlbmVyYXRpb24gKFN0YW1pbmEpCiAgICAgICAgICAgIC8vIFJlZ2VuZXJhdGUgaWYgbm90IGN1cnJlbnRseSBzcGVuZGluZyBpdCAoRGFzaGluZy9UYWNrbGluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGFzaGluZyAmJiAhdGhpcy5pc1RhY2tsaW5nICYmICF0aGlzLmlzRXZhZGluZyAmJiAhdGhpcy5pc1RhY2tsZUNoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtYXhFTiA9IHRoaXMuZ2V0U3RhdCgnRU4nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IG1heEVOKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZ2VuUmF0ZSA9IDEwLjA7IC8vIEZhc3QgcmVnZW4gKHJlY292ZXIgdGFja2xlIGNvc3QgaW4gfjAuOHMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSByZWdlbiBpZiBzdHJ1Z2dsaW5nIChiZWluZyB0YWNrbGVkKSB0byBwcmV2ZW50IGluZmluaXRlIHN0YWxsaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2VuUmF0ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZW5SYXRlID0gNS4wOyAvLyBTbG93ZXIgcmVnZW4gd2hpbGUgY2FycnlpbmcgYmFsbAogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gKz0gcmVnZW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gbWF4RU4pIHRoaXMuY3VycmVudEVOID0gbWF4RU47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhQIERyYWluIHdoaWxlIGhvbGRpbmcgYmFsbCAoRmF0aWd1ZSkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy53aXRoZXJba2V5XSAtPSBkdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgdGhpcy5zdGF0dXMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgdGhpcy5zdGF0dXMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHRoaXMuc3RhdHVzLnNoaWVsZCAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgdGhpcy5zdGF0dXMuaGFzdGUgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgdGhpcy5zdGF0dXMuc2xvdyAtPSBkdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5idXJuID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMuYnVybiAtPSBkdDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gOC4wICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMuc2hvY2sgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zaG9jayAtPSBkdDsKICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAxLjUpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwLjM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCWlJUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50YWxJbmZ1c2lvbiAmJiB0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50YWxJbmZ1c2lvbi5kdXJhdGlvbiAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRhbEluZnVzaW9uLmR1cmF0aW9uIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRhbEluZnVzaW9uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiSU5GVVNJT04gRU5EIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU3RhdHVzVmlzdWFscyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJsaW5kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdibGluZCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYmxpbmQgPSAwLjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaWxlbmNlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaWxlbmNlIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2lsZW5jZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2lsZW5jZSA9IDAuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNoaWVsZCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9ICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaGllbGQgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdzaGllbGQnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNoaWVsZCA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmhhc3RlID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgPSAodGhpcy5fcGFydGljbGVUaW1lcnMuaGFzdGUgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2hhc3RlJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5oYXN0ZSA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnNsb3cgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93ID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNsb3cgfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5zbG93IDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2xvdycsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuc2xvdyA9IDAuNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLmJ1cm4gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLmJ1cm4gfHwgMCkgLSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy5idXJuIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignZmlyZScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMuYnVybiA9IDAuMTU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zaG9jayA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrID0gKHRoaXMuX3BhcnRpY2xlVGltZXJzLnNob2NrIHx8IDApIC0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMuc2hvY2sgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2b2x0JywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5zaG9jayA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICAvLyAtLS0gMS4gRkxBU0ggRUZGRUNUIC0tLQogICAgICAgICAgICBsZXQgZmxhc2hSYXRpbyA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmZsYXNoVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgcGFzc2VkIGR0IGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGFzc3VtZSAxNm1zIChzYWZldHkpCiAgICAgICAgICAgICAgICBjb25zdCBkZWx0YSA9IGR0IHx8IDAuMDE2OwogICAgICAgICAgICAgICAgdGhpcy5mbGFzaFRpbWVyIC09IGRlbHRhOwogICAgICAgICAgICAgICAgZmxhc2hSYXRpbyA9IE1hdGgubWF4KDAsIHRoaXMuZmxhc2hUaW1lciAvIHRoaXMuZmxhc2hEdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZmxhc2hSYXRpbyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBMZXJwIHRvd2FyZHMgZmxhc2ggY29sb3IKICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5sZXJwQ29sb3JzKGVudHJ5LmJhc2VDb2xvciwgdGhpcy5mbGFzaENvbG9yLCBmbGFzaFJhdGlvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0ZXJpYWwuY29sb3IuY29weShlbnRyeS5iYXNlQ29sb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIC0tLSAyLiBQUk9DRURVUkFMIFNRVUFTSCAmIFNUUkVUQ0ggKFNwcmluZyBQaHlzaWNzKSAtLS0KICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBkdCB8fCAwLjAxNjsKICAgICAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDIwMC4wOwogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDE1LjA7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gWCBBeGlzCiAgICAgICAgICAgICAgICBjb25zdCBmb3JjZVggPSAodGFyZ2V0IC0gdGhpcy5jdXJyZW50U3F1YXNoLngpICogc3RpZmZuZXNzOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICs9IGZvcmNlWCAqIGRlbHRhOwogICAgICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS54ICo9IE1hdGgubWF4KDAsIDEuMCAtIGRhbXBpbmcgKiBkZWx0YSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTcXVhc2gueCArPSB0aGlzLnNxdWFzaFZlbG9jaXR5LnggKiBkZWx0YTsKCiAgICAgICAgICAgICAgICAvLyBZIEF4aXMKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlWSA9ICh0YXJnZXQgLSB0aGlzLmN1cnJlbnRTcXVhc2gueSkgKiBzdGlmZm5lc3M7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKz0gZm9yY2VZICogZGVsdGE7CiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaFZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZGFtcGluZyAqIGRlbHRhKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC55ICs9IHRoaXMuc3F1YXNoVmVsb2NpdHkueSAqIGRlbHRhOwoKICAgICAgICAgICAgICAgIC8vIFogQXhpcwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2VaID0gKHRhcmdldCAtIHRoaXMuY3VycmVudFNxdWFzaC56KSAqIHN0aWZmbmVzczsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiArPSBmb3JjZVogKiBkZWx0YTsKICAgICAgICAgICAgICAgIHRoaXMuc3F1YXNoVmVsb2NpdHkueiAqPSBNYXRoLm1heCgwLCAxLjAgLSBkYW1waW5nICogZGVsdGEpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3F1YXNoLnogKz0gdGhpcy5zcXVhc2hWZWxvY2l0eS56ICogZGVsdGE7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gTWVzaCBTY2FsZSAoTXVsdGlwbGljYXRpdmUgd2l0aCBiYXNlU2NhbGUpCiAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0KAogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVNjYWxlICogdGhpcy5jdXJyZW50U3F1YXNoLngsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU2NhbGUgKiB0aGlzLmN1cnJlbnRTcXVhc2gueSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTY2FsZSAqIHRoaXMuY3VycmVudFNxdWFzaC56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmbGFzaChjb2xvckhleCwgZHVyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5mbGFzaENvbG9yLnNldEhleChjb2xvckhleCk7CiAgICAgICAgICAgIHRoaXMuZmxhc2hEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLmZsYXNoVGltZXIgPSBkdXJhdGlvbjsKICAgICAgICB9CgogICAgICAgIHNxdWFzaCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFNxdWFzaC5zZXQoeCwgeSwgeik7CiAgICAgICAgICAgIC8vIFJlc2V0IHZlbG9jaXR5IGZvciBzbmFwIGZlZWwKICAgICAgICAgICAgdGhpcy5zcXVhc2hWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvciAoRW5oYW5jZWQgUmV0aWNsZSkKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyAxLiBHcm91bmQgUmV0aWNsZSAoUm90YXRpbmcpCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IF9yZXRpY2xlVGV4dHVyZSwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAgLy8gR3JlZW4gZm9yIHBhc3MKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDMuMCwgMy4wKTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5yZXRpY2xlTWVzaC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZU1lc2gpOwoKICAgICAgICAgICAgLy8gMi4gVmVydGljYWwgUGlsbGFyIChMaWdodCBTaGFmdCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMS4wLCAxLjAsIDYsIDE2LCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDQ0ZmY0NCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIgPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5wb3NpdGlvbi55ID0gMy4wOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZVBpbGxhcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBGbG9hdGluZyBJY29uIChBYm92ZSBIZWFkKQogICAgICAgICAgICBjb25zdCBpY29uR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMS4wLCAxLjApOwogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uID0gbmV3IFRIUkVFLk1lc2goaWNvbkdlbywgbWF0KTsgLy8gUmV1c2UgdGV4dHVyZQogICAgICAgICAgICB0aGlzLnJldGljbGVJY29uLnBvc2l0aW9uLnkgPSA0LjU7CiAgICAgICAgICAgIC8vIEJpbGxib2FyZCBiZWhhdmlvciBoYW5kbGVkIGluIHVwZGF0ZQogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IuYWRkKHRoaXMucmV0aWNsZUljb24pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIHRvIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgZGVzdCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGRpc3RhbmNlIGlzIGxhcmdlIChzd2l0Y2hlZCB0YXJnZXQpLCBzbmFwLiBFbHNlIGxlcnAuCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlc3QpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5jb3B5KGRlc3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi5sZXJwKGRlc3QsIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEtlZXAgWSBhdCBncm91bmQgbGV2ZWwKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMDU7CgogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3BpbiBncm91bmQgcmV0aWNsZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2gucm90YXRpb24ueiA9IC10aW1lICogMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gMS4wICsgTWF0aC5zaW4odGltZSAqIDUuMCkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZU1lc2guc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZSBwaWxsYXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXRpY2xlUGlsbGFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmV0aWNsZVBpbGxhci5tYXRlcmlhbC5vcGFjaXR5ID0gMC4xICsgTWF0aC5zaW4odGltZSAqIDguMCkgKiAwLjA1OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldGljbGVQaWxsYXIucm90YXRpb24ueSA9IHRpbWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBCaWxsYm9hcmQgSWNvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJldGljbGVJY29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXRpY2xlSWNvbi5yb3RhdGlvbi56ID0gdGltZSAqIDMuMDsgLy8gU3BpbiBpY29uCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlBcmVuYUJvdW5kYXJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSBDLkJPVU5EQVJZX1JBRElVUyB8fCA0Ni4wOwogICAgICAgICAgICBjb25zdCBoZWlnaHRMaW1pdCA9IEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFkaWFsIEJvdW5kYXJ5IChTcGhlcmUvQ3lsaW5kZXIgd2FsbHMpCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdCAtIHJhZGl1czsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIGJhY2sgdG8gY2VudGVyCiAgICAgICAgICAgICAgICBjb25zdCBueCA9IC1wb3MueCAvIGRpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBueiA9IC1wb3MueiAvIGRpc3Q7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwcmluZyBGb3JjZSAoSG9va2UncyBMYXcpIC0gIlN1Y2sgYmFjayIgZWZmZWN0CiAgICAgICAgICAgICAgICAvLyBTb2Z0ZW5lZCB0byBhbGxvdyAic3RyZXRjaGluZyIgb3V0IG9mIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgayA9IDMwLjA7IC8vIFdhcyAxNTAuMCAtIE11Y2ggc29mdGVyIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSBwZW5ldHJhdGlvbiAqIGs7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBueiAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbXBpbmcgKERyYWcpIHRvIHByZXZlbnQgaW5maW5pdGUgb3NjaWxsYXRpb24KICAgICAgICAgICAgICAgIC8vIFJlZHVjZWQgZGFtcGluZyB0byBhbGxvdyBtb21lbnR1bSB0byBjYXJyeSBwbGF5ZXIgZGVlcGVyIGludG8gdGhlICJ3YWxsIgogICAgICAgICAgICAgICAgY29uc3QgZGFtcGluZyA9IDEuMCAtIE1hdGgubWluKDEuMCwgMy4wICogZHQpOyAvLyBXYXMgOC4wCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKj0gZGFtcGluZzsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiAqPSBkYW1waW5nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzOiBUcmlnZ2VyIEFyZW5hIERpc3RvcnRpb24KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgcG9pbnQgb24gdGhlIGJvdW5kYXJ5IHN1cmZhY2UKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQocG9zLngsIHBvcy55LCBwb3Mueikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIocmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlbnNpdHkgYmFzZWQgb24gcGVuZXRyYXRpb24gZGVwdGggLSBCb29zdGVkIGZvciB2aXN1YWwgInN0cmV0Y2giCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZW5zaXR5ID0gTWF0aC5taW4ocGVuZXRyYXRpb24gKiA1LjAgKyB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpICogMC4xLCAyNS4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QoX3BWZWMsIGludGVuc2l0eSk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IEJvdW5kYXJ5IEJyZWFjaCBGWCAoU3Vjay1iYWNrIGRpc3RvcnRpb24pIC0tLQogICAgICAgICAgICAgICAgICAgIGlmIChwZW5ldHJhdGlvbiA+IDAuNSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuIENhbWVyYSBEaXN0b3J0aW9uIChBYmVycmF0aW9uICsgU2hha2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdsaXRjaCBlZmZlY3Qgc2NhbGVzIHdpdGggcGVuZXRyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAyLjApIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShwZW5ldHJhdGlvbiAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZXMgKFdhdGVyIGRpc3BsYWNlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNob2Nrd2F2ZSBvbiB0aGUgd2FsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIF9wVmVjLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAzLjAgKyBwZW5ldHJhdGlvbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhZmZmZiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3VjayBiYWNrIiBidWJibGVzIG1vdmluZyBpbndhcmQgdmlvbGVudGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMyhueCwgMCwgbnopLm11bHRpcGx5U2NhbGFyKDEwLjAgKyBwZW5ldHJhdGlvbiAqIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbndhcmRWZWwueSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUuMDsgLy8gVmVydGljYWwgc3BsYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBpbndhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZlcnRpY2FsIEJvdW5kYXJ5CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBoZWlnaHRMaW1pdCkgewogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihwb3MueSk7CiAgICAgICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IE1hdGguYWJzKHBvcy55KSAtIGhlaWdodExpbWl0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcHJpbmcgYmFjayAtIFNvZnRlbmVkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gc2lnbiAqIHBlbmV0cmF0aW9uICogMzAuMCAqIGR0OyAvLyBXYXMgMTUwLjAKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMy4wICogZHQpKTsgLy8gV2FzIDguMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxzCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weShwb3MpOwogICAgICAgICAgICAgICAgICAgIF9wVmVjLnkgPSBzaWduICogaGVpZ2h0TGltaXQ7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KF9wVmVjLCBwZW5ldHJhdGlvbiAqIDUuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBORVc6IFZlcnRpY2FsIEJyZWFjaCBGWCAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAocGVuZXRyYXRpb24gPiAwLjUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKHBlbmV0cmF0aW9uICogMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgX3BWZWMsIHsgc2NhbGU6IDMuMCArIHBlbmV0cmF0aW9uLCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGxhc2ggaW53YXJkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbndhcmRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjUsIC1zaWduICogMTAuMCwgKE1hdGgucmFuZG9tKCktMC41KSo1KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBfcFZlYywgeyB2ZWxvY2l0eTogaW53YXJkVmVsLCBzY2FsZTogMC41LCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIWdhbWUgfHwgIWdhbWUudGVhbXMpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5U29mdENvbGxpc2lvbihkdCk7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CgogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCBpc0lucHV0QWN0aXZlID0gaW5wdXRMZW5TcSA+IDAuMDE7CgogICAgICAgICAgICBsZXQgY3VycmVudE1heFNwZWVkID0gdGhpcy5tYXhTcGVlZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNUUlVHR0xFIFNUQVRFOiBIaW5kZXIgbW92ZW1lbnQgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgLy8gSW5zdGVhZCBvZiBhIGJpbmFyeSAwLjggbXVsdGlwbGllciwgd2Ugc2NhbGUgYmFzZWQgb24gaW50ZW5zaXR5LgogICAgICAgICAgICAvLyBNYXggc3RydWdnbGUgKDEuMCkgcmVkdWNlcyBzcGVlZCB0byA0MCUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9ICgxLjAgLSAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuNikpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBzbGlnaHQgcmVkdWN0aW9uIGlmIGVuZ2FnZWQgYnV0IGxvdyBwcmVzc3VyZQogICAgICAgICAgICAgICAgY3VycmVudE1heFNwZWVkICo9IDAuOTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKaWYgKHRoaXMuaXNDaGFyZ2luZyB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgfHwgdGhpcy5pc0Jsb2NraW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC40OyAvLyBTbG93IGRvd24gd2hlbiBjaGFyZ2luZy9ibG9ja2luZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFzdGUgLyBTbG93CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5oYXN0ZSA+IDApIGN1cnJlbnRNYXhTcGVlZCAqPSAxLjU7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5zbG93ID4gMCkgY3VycmVudE1heFNwZWVkICo9IDAuNTsKCiAgICAgICAgICAgIGlmIChpc0lucHV0QWN0aXZlKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IFN0cnVnZ2xlIEppdHRlciB0byBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRlcyB3cmVzdGxpbmcgZm9yIGNvbnRyb2wKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID4gMC4zKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zdHJ1Z2dsZUludGVuc2l0eSAqIDAuODsKICAgICAgICAgICAgICAgICAgICBfcFZlYy54ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy56ICs9IGppdHRlcjsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxYID0gX3BWZWMueCAqIGN1cnJlbnRNYXhTcGVlZDsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZlbFogPSBfcFZlYy56ICogY3VycmVudE1heFNwZWVkOwoKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCBjdXJyZW50U3BlZWQgLyB0aGlzLm1heFNwZWVkKTsKCiAgICAgICAgICAgICAgICAvLyBBZ2lsaXR5IGlzIHJlZHVjZWQgd2hlbiBzdHJ1Z2dsaW5nCiAgICAgICAgICAgICAgICBsZXQgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIGFnaWxpdHkgKj0gMC41OwoKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjAxLCBkdCAqIGFnaWxpdHkpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAodGFyZ2V0VmVsWCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICh0YXJnZXRWZWxaIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYnJha2VGYWN0b3IgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4xLCBkdCAqIGJyYWtlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKDAgLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAoMCAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgdGhpcy52ZWxvY2l0eS55LCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CnRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CgoKICAgICAgICAgICAgbGV0IHRhcmdldFkgPSAwOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IChnYW1lICYmIGdhbWUuZW50aXRpZXMpID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WSA9IGJhbGwubWVzaC5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZID0gMC41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB5RGlmZiA9IHRhcmdldFkgLSB0aGlzLm1lc2gucG9zaXRpb24ueTsKCiAgICAgICAgICAgIGNvbnN0IGxpZnQgPSB5RGlmZiAqIDEwLjAgKiBkdDsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IGxpZnQ7CgogICAgICAgICAgICBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPiA4LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZXNoLnBvc2l0aW9uLnkgPCAtOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IC04LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CiAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgX3BFdWxlci5zZXQoYm9iUGl0Y2gsIDAsIGJvYlJvbGwpOwogICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21FdWxlcihfcEV1bGVyKTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwppZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gKGVuZ2FnZWRDb3VudCA+IDApOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IEVOIERyYWluIChDb250aW51b3VzKQogICAgICAgICAgICAgICAgLy8gU2NhbGluZzogMjAgQVQgcHJlc3N1cmUgLT4gYXBwcm94IDEwIEVOIGxvc3QgcGVyIHNlY29uZAogICAgICAgICAgICAgICAgY29uc3QgZHJhaW5SYXRlID0gdG90YWxQcmVzc3VyZSAqIDAuNTsgCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFN0cnVnZ2xlIEludGVuc2l0eSBmb3IgUGh5c2ljcyAoMC4wIHRvIDEuMCkKICAgICAgICAgICAgICAgIC8vIE1heCBzdHJ1Z2dsZSBhdCByb3VnaGx5IDMwIHByZXNzdXJlCiAgICAgICAgICAgICAgICB0aGlzLnN0cnVnZ2xlSW50ZW5zaXR5ID0gTWF0aC5taW4oMS4wLCB0b3RhbFByZXNzdXJlIC8gMzAuMCk7CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBEcmFpbiAoQWNjdW11bGF0ZSB0byBhdm9pZCBzcGFtKQogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgKz0gZHJhaW5SYXRlICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke01hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UpfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHBsYXllciBpZiBlbmdhZ2VkIHRvbyBsb25nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbmNvdW50ZXJUaW1lciA+IDEuMCAmJiB0aGlzLmVuY291bnRlclRpbWVyIDwgMS4xICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQlJFQUshIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCnRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAyLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2JyZWFrJzsKCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQnJlYWsgR2x5cGggKEV4cGxvc2l2ZSBCdXJzdCkKICAgICAgICAgICAgICAgIGlmIChnYW1lLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZ2x5cGhNYW5hZ2VyLnNwYXduKCdzdGF0dXMnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDguMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCiAgICAgICAgICAgICAgICBjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIE5lcmZlZCBmcm9tIDE1LjAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2Rhc2gnKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDIwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiREFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCi8vIERFRkVOU0U6IEJMT0NLIC8gVEFDS0xFCiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gdGhpcy5kYXNoVG90YWxUaW1lOwogICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydCh4KnggKyB6KnopOwogICAgICAgICAgICBjb25zdCBueCA9IChsZW4gPiAwKSA/IHgvbGVuIDogMDsKICAgICAgICAgICAgY29uc3QgbnogPSAobGVuID4gMCkgPyB6L2xlbiA6IDA7CgogICAgICAgICAgICBpZiAobGVuID4gMCkgewogICAgICAgICAgICAgICAgLy8gU21vb3RoIHR1cm4gZm9yIGRhc2ggaW5zdGVhZCBvZiBzbmFwCiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IE1hdGguYXRhbjIobngsIG56KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCbG9ja0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAndmVydGljYWwnOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpclRvQmFsbCA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgZGlyVG9CYWxsLnkgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChkaXJUb0JhbGwubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJUb0JhbGwubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLmNvcHkoZGlyVG9CYWxsKS5tdWx0aXBseVNjYWxhcig4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGNhdGNoQWN0aW9uID0gdGhpcy5hY3Rpb25zWydjYXRjaCddOwogICAgICAgICAgICAgICAgaWYgKGNhdGNoQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnRpbWVTY2FsZSA9IDEuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnaG9yaXpvbnRhbCc7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ3Rocm93JywgMC4xKTsKCiAgICAgICAgICAgICAgICAvLyBKVUlDRTogU3RyZXRjaCBvbiBEYXNoCiAgICAgICAgICAgICAgICB0aGlzLnNxdWFzaCgwLjcsIDEuNCwgMC43KTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJyk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2ggUmVjb2lsIChLaWNrYmFjaykKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoLWRhc2hEaXIueCAqIDEuNSwgLTAuNSwgLWRhc2hEaXIueiAqIDEuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIC8vIEhvbG9ncmFwaGljIEhQIEJhciBTaGFkZXIgd2l0aCBKdWljZSAoU2hha2UgJiBGbGFzaCkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjQsIDAuMTgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1RmlsbDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmMDApIH0sCiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjkgfSwKICAgICAgICAgICAgICAgICAgICB1U2hha2U6IHsgdmFsdWU6IDAuMCB9LAogICAgICAgICAgICAgICAgICAgIHVGbGFzaDogeyB2YWx1ZTogMC4wIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNoYWtlOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBTaGFrZSBFZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVTaGFrZSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gc2luKHQpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gY29zKHQgKiAwLjgpICogdVNoYWtlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVGaWxsOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUZsYXNoOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRnJhbWUgZGltZW5zaW9ucyAoVVYgc3BhY2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGJvcmRlclkgPSAwLjE1OwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJYID0gMC4wMjsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElubmVyIGNvbnRlbnQgbWFzawogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblkgPSBzdGVwKGJvcmRlclksIHZVdi55KSAqIHN0ZXAodlV2LnksIDEuMCAtIGJvcmRlclkpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBpblggPSBzdGVwKGJvcmRlclgsIHZVdi54KSAqIHN0ZXAodlV2LngsIDEuMCAtIGJvcmRlclgpOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBjb250ZW50TWFzayA9IGluWSAqIGluWDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJhY2tncm91bmQgKFRlY2ggR3JpZCkKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBiZ0NvbCA9IHZlYzMoMC4wLCAwLjEsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdyaWQgPSBzdGVwKDAuOSwgZnJhY3QodlV2LnggKiAyMC4wICsgdlV2LnkgKiAxMC4wKSkgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnQ29sICs9IGdyaWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaWxsIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxNYXNrID0gc3RlcCh2VXYueCwgdUZpbGwpICogY29udGVudE1hc2s7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmVyZ3kgUHVsc2UgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBwdWxzZSA9IHNpbih2VXYueCAqIDEwLjAgLSB1VGltZSAqIDMuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgYmFyQ29sID0gbWl4KHVDb2xvciwgdUNvbG9yICsgdmVjMygwLjQpLCBwdWxzZSAqIDAuNik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3QgRWRnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gc21vb3Roc3RlcCh1RmlsbCAtIDAuMDUsIHVGaWxsLCB2VXYueCkgKiBmaWxsTWFzazsKICAgICAgICAgICAgICAgICAgICAgICAgYmFyQ29sICs9IHZlYzMoMS4wKSAqIGVkZ2U7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSAoSG9sb2dyYW0gZWZmZWN0KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogODAuMCArIHVUaW1lICogNS4wKSAqIDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBCb3JkZXIgR2xvdwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBib3JkZXJNYXNrID0gKDEuMCAtIGNvbnRlbnRNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBib3JkZXJDb2wgPSB2ZWMzKDAuMCwgMC42LCAxLjApICogMC42OyAvLyBDeWFuIHRlY2ggYm9yZGVyCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSBtaXgoYmdDb2wsIGJhckNvbCwgZmlsbE1hc2spOwogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgYm9yZGVyQ29sLCBib3JkZXJNYXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gc2NhbjsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1aWNlOiBGbGFzaCAoRGFtYWdlL0ltcGFjdCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVGbGFzaCA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCA9IG1peChmaW5hbENvbCwgdmVjMygxLjAsIDEuMCwgMS4wKSwgdUZsYXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhY2tncm91bmQgYXJlYXMgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxNYXNrIDwgMC41ICYmIGJvcmRlck1hc2sgPCAwLjUpIGFscGhhICo9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZmluYWxDb2wsIGFscGhhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLCAvLyBSZW5kZXIgb24gdG9wCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmhwQmFyLnJlbmRlck9yZGVyID0gOTAwOyAvLyBFbnN1cmUgaXQgcmVuZGVycyBhYm92ZSBtb3N0IHRoaW5ncwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgpfY3JlYXRlU3RhdHVzUmluZygpIHsKICAgICAgICAgICAgLy8gQ29tcGFjdCBBZXN0aGV0aWMgUmluZyAoMi4wIHNpemUpCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMi4wLCAyLjApOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIHVIUDogeyB2YWx1ZTogMS4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUVOOiB7IHZhbHVlOiAxLjAgfSwKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMC4wIH0sCiAgICAgICAgICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sCiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUhQOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUVOOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAgICAgI2RlZmluZSBQSSAzLjE0MTU5MjY1MzU5CgogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBjZW50ZXIgPSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHZVdiAtIGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChwKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbmZpZzogQ29tcGFjdCBSaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJNYWluID0gMC4zNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd01haW4gPSAwLjAzOyAvLyBUaGlubmVyIGJhcnMKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gMC4wOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdmVjMygwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gMS4gQmFja2dyb3VuZCBUcmFjayAoRGFyaykKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYmdSaW5nID0gMS4wIC0gc21vb3Roc3RlcCh3TWFpbiwgd01haW4gKyAwLjAxLCBhYnMoZGlzdCAtIHJNYWluKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHYXAgYXQgdG9wL2JvdHRvbSAoY2VudGVyIGF4aXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGdhcCA9IHNtb290aHN0ZXAoMC4wLCAwLjA1LCBhYnMocC54KSk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnUmluZyA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDAuMCwgMC4wNSwgMC4xKTsgLy8gRGFyayBiYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuMyAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgcHJvZ3Jlc3M6IEJvdHRvbSAoLTAuMzUpIHRvIFRvcCAoMC4zNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGZpbGxQb3MgPSAocC55ICsgck1haW4pIC8gKHJNYWluICogMi4wKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlZnQgU2lkZTogSFAgKEdyZWVuIC0+IFJlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnggPCAwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsbFBvcyA8IHVIUCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWMzIGhwQ29sID0gbWl4KHZlYzMoMS4wLCAwLjAsIDAuMCksIHZlYzMoMC4wLCAxLjAsIDAuNCksIHNtb290aHN0ZXAoMC4yLCAwLjUsIHVIUCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodUhQIDwgMC4zKSBocENvbCArPSBzaW4odVRpbWUgKiAyMC4wKSAqIDAuMzsgLy8gUHVsc2Ugd2FybmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9IGhwQ29sOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGlwIGdsb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1SFAgLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpZ2h0IFNpZGU6IEVOIChHb2xkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPCB1RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB2ZWMzKDEuMCwgMC44LCAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHBoYSA9IDAuOSAqIGdhcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGxQb3MgPiB1RU4gLSAwLjA1KSBjb2xvciArPSB2ZWMzKDAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyAyLiBPdXRlciBUZWFtIEluZGljYXRvciAoVGhpbiBwdWxzaW5nIHJpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJUZWFtID0gMC40NTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgd1RlYW0gPSAwLjAwODsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgdGVhbVJpbmcgPSAxLjAgLSBzbW9vdGhzdGVwKHdUZWFtLCB3VGVhbSArIDAuMDA1LCBhYnMoZGlzdCAtIHJUZWFtKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVhbVJpbmcgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGFuZ2xlID0gYXRhbihwLnksIHAueCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzZWcgPSBzaW4oYW5nbGUgKiAzLjAgKyB1VGltZSAqIDIuMCk7IC8vIFJvdGF0aW5nIHNlZ21lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VnID4gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSB1Q29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGEgPSAwLjY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID0gdUNvbG9yICogMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhID0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSAqIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZyA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucmVuZGVyT3JkZXIgPSAxMDsgLy8gQWJvdmUgZmxvb3IKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5zdGF0dXNSaW5nKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVTdGF0dXNSaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zdGF0dXNSaW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXNpYmlsaXR5IExvZ2ljCiAgICAgICAgICAgIGxldCB0YXJnZXRPcGFjaXR5ID0gMC4wOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUgJiYgKGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpKSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQgYnkgdGhlIGh1bWFuIChIb21lIEFjdGl2ZSBQbGF5ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVQID0gKGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuaXNIdW1hbikgPyBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQWx3YXlzIHNob3cgZm9yIE1FIChBY3RpdmUgUGxheWVyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMgPT09IGFjdGl2ZVApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRPcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gQWx3YXlzIHNob3cgZm9yIEJBTEwgQ0FSUklFUiAoRnJpZW5kIG9yIEZvZSkKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAzLiBTaG93IGZvciBhbnlvbmUgaW4gUFJPWElNSVRZIHRvIEFjdGl2ZSBQbGF5ZXIKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFjdGl2ZVAgJiYgYWN0aXZlUC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGFjdGl2ZVAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSAyNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQgYXMgdGhleSBnZXQgZnVydGhlciBhd2F5CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xhbXAgbWluIG9wYWNpdHkgZm9yIHZpc2liaWxpdHkgaWYgcmVhc29uYWJseSBjbG9zZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDE1LjApIHRhcmdldE9wYWNpdHkgPSBNYXRoLm1heCgwLjMsIHRhcmdldE9wYWNpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU21vb3RoIE9wYWNpdHkgVHJhbnNpdGlvbgogICAgICAgICAgICBjb25zdCBjdXIgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWU7CiAgICAgICAgICAgIGNvbnN0IGxlcnBTcGVlZCA9IDUuMDsKICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlICs9ICh0YXJnZXRPcGFjaXR5IC0gY3VyKSAqIGR0ICogbGVycFNwZWVkOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBIaWRlIGlmIGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXNSaW5nLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDwgMC4wMSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhbnNmb3JtcwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLnN0YXR1c1JpbmcucG9zaXRpb24ueSA9IDAuMDU7IC8vIEp1c3QgYWJvdmUgZmxvb3IKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvdGF0ZSB0byBtYXRjaCBwbGF5ZXIgZmFjaW5nIChZYXcgb25seSkgc28gYmFycyBzdGF5IHJlbGF0aXZlIHRvIHBsYXllciBvcmllbnRhdGlvbgogICAgICAgICAgICAvLyBMZWZ0IGlzIGFsd2F5cyBQbGF5ZXIncyBMZWZ0CiAgICAgICAgICAgIHRoaXMuc3RhdHVzUmluZy5yb3RhdGlvbi56ID0gLSh0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVbmlmb3JtcwogICAgICAgICAgICBjb25zdCBtYXQgPSB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWw7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51SFAudmFsdWUgPSB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgY29uc3QgbWF4RU4gPSB0aGlzLnN0YXRzLkVOIHx8IDE7CiAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RU4udmFsdWUgPSB0aGlzLmN1cnJlbnRFTiAvIG1heEVOOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbSBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh0aGlzLnRlYW0uY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlSFBCYXIoZHQgPSAwLjAxNikgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnIHx8IGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhbGxvd2VkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEpVSUNFOiBEYW1hZ2UgUmVhY3Rpb24gLS0tCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgX2xhc3RIUCBpZiB1bmRlZmluZWQgKGZpcnN0IHJ1bikKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RIUCA9PT0gdW5kZWZpbmVkKSB0aGlzLl9sYXN0SFAgPSB0aGlzLnN0YXRzLkhQOwoKICAgICAgICAgICAgY29uc3QgZGVsdGEgPSB0aGlzLl9sYXN0SFAgLSB0aGlzLnN0YXRzLkhQOwogICAgICAgICAgICBpZiAoZGVsdGEgPiAwLjEpIHsKICAgICAgICAgICAgICAgIC8vIEhQIERlY3JlYXNlZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWb2x1bnRhcnkgZXhlcnRpb24gKEFiaWxpdHkgY29zdCkgLT4gU21hbGwgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSBNYXRoLm1pbih0aGlzLmhwRmxhc2ggKyAwLjQsIDAuNik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEludm9sdW50YXJ5IGRhbWFnZSAoVmVub20sIERyYWluLCBldGMpIC0+IFNoYWtlICsgRmxhc2gKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwU2hha2UgPSBNYXRoLm1pbih0aGlzLmhwU2hha2UgKyAwLjA1LCAwLjE1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhwRmxhc2ggPSAxLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbGFzdEhQID0gdGhpcy5zdGF0cy5IUDsKCiAgICAgICAgICAgIC8vIERlY2F5IEZYCiAgICAgICAgICAgIHRoaXMuaHBTaGFrZSAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDguMCk7CiAgICAgICAgICAgIHRoaXMuaHBGbGFzaCAqPSBNYXRoLm1heCgwLCAxLjAgLSBkdCAqIDUuMCk7CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgU2hhZGVyIFVuaWZvcm1zCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IHRoaXMuaHBCYXIubWF0ZXJpYWw7CiAgICAgICAgICAgIGlmIChtYXQudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51RmlsbC52YWx1ZSA9IHBjdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgIG1hdC51bmlmb3Jtcy51U2hha2UudmFsdWUgPSB0aGlzLmhwU2hha2U7CiAgICAgICAgICAgICAgICBtYXQudW5pZm9ybXMudUZsYXNoLnZhbHVlID0gdGhpcy5ocEZsYXNoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBjb2wgPSBtYXQudW5pZm9ybXMudUNvbG9yLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgY29sLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSBjb2wuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgICAgIGVsc2UgY29sLnNldEhleCgweGZmMDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgLy8gTkVXOiBBbHNvIGhpZGUgaWYgc3RhdHVzIHJpbmcgaXMgZnVsbHkgdmlzaWJsZSAob3BhY2l0eSA+IDAuOCkgdG8gYXZvaWQgcmVkdW5kYW5jeQogICAgICAgICAgICBjb25zdCByaW5nVmlzaWJsZSA9IHRoaXMuc3RhdHVzUmluZyAmJiB0aGlzLnN0YXR1c1JpbmcubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPiAwLjg7CiAgICAgICAgICAgIGNvbnN0IGFsd2F5c1Nob3cgPSBnYW1lICYmIGdhbWUuZ2FtZU1vZGUgPT09ICdwcmFjdGljZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAoKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyB8fCB0aGlzLmhwRmxhc2ggPiAwLjEpICYmICFyaW5nVmlzaWJsZSk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfY2hlY2tUYWNrbGVDb2xsaXNpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtIHx8IHRoaXMuX2hhc0hpdFRhY2tsZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSBhcyB0YWNrbGUgZGlyZWN0aW9uIChzaW5jZSB0YWNrbGUgaW1wYXJ0cyB2ZWxvY2l0eSkKICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZmFjaW5nIGlmIHZlbG9jaXR5IGlzIG5lZ2xpZ2libGUKICAgICAgICAgICAgbGV0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgdGFja2xlRGlyLnkgPSAwOwogICAgICAgICAgICBpZiAodGFja2xlRGlyLmxlbmd0aFNxKCkgPCAwLjEpIHsKICAgICAgICAgICAgICAgIHRhY2tsZURpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YWNrbGVEaXIubm9ybWFsaXplKCk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlY3RvciB0byBvcHBvbmVudAogICAgICAgICAgICAgICAgY29uc3QgdG9PcHAgPSBvcHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdG9PcHAueSA9IDA7IC8vIElnbm9yZSBoZWlnaHQgZGlmZmVyZW5jZSBmb3IgaGl0IGRldGVjdGlvbiBjeWxpbmRlcgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9PcHAubGVuZ3RoKCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmVhY2ggPSA0LjU7IC8vIEluY3JlYXNlZCByZWFjaCAod2FzIDMuNSkKCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJlYWNoKSB7CiAgICAgICAgICAgICAgICAgICAgdG9PcHAubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gdGFja2xlRGlyLmRvdCh0b09wcCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ29uZSBDaGVjazogV2lkZW5lZCB0byB+NjAgZGVncmVlcyAoZG90ID4gMC41KQogICAgICAgICAgICAgICAgICAgIC8vIFdhcyAwLjcgKH40NSBkZWcpLiBUaGlzIG1ha2VzIGxhbmRpbmcgdGFja2xlcyBlYXNpZXIuCiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgSW1wYWN0IFF1YWxpdHkgKDAuMCB0byAxLjApCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEuMCA9IERlYWQgY2VudGVyIGhpdCwgMC4wID0gR2xhbmNpbmcgYmxvdyBhdCBlZGdlIG9mIGNvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YWxpdHkgPSAoZG90IC0gMC41KSAvIDAuNTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBxdWFsaXR5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCwgcXVhbGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT25seSBoaXQgb25lIHRhcmdldCBwZXIgdGFja2xlIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKX3Jlc29sdmVUYWNrbGVIaXQob3BwLCBxdWFsaXR5KSB7CiAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7IC8vIFN0b3AgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNDbGVhbkhpdCA9IHF1YWxpdHkgPiAwLjY7IC8vIFRocmVzaG9sZCBmb3IgIkNsZWFuIEhpdCIKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKEF0dGFja2VyKQogICAgICAgICAgICB0aGlzLmZsYXNoKDB4ZmZmZmZmLCAwLjE1KTsKICAgICAgICAgICAgdGhpcy5zcXVhc2goMS4yLCAwLjgsIDEuMik7IC8vIEltcGFjdCBjb21wcmVzc2lvbgoKICAgICAgICAgICAgLy8gSEVSQ1VMRUFOIElNUEFDVCBGWAogICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgLy8gMS4gRnJlZXplIEZyYW1lIChJbXBhY3QgU3RvcCkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMjUsICdzaGF0dGVyJyk7IC8vIEhlYXZ5IGZyZWV6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgWm9vbSBTbmFwICYgQWJlcnJhdGlvbgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMjApOyAvLyBab29tIElOCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRBYmVycmF0aW9uKDE1LjApOyAvLyBNYXNzaXZlIGdsaXRjaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIERpcmVjdGlvbmFsIERlYnJpcyAoQ29uZSBiZWhpbmQgdmljdGltKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0UG9zID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZURpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ja3dhdmUKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignc2hvY2t3YXZlJywgaW1wYWN0UG9zLCB7IHNjYWxlOiA2LjAsIGxpZmU6IDAuNCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdmbGFzaCcsIGltcGFjdFBvcywgeyBzY2FsZTogNS4wIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBEZWJyaXMgQ29uZQpmb3IobGV0IGk9MDsgaTw4OyBpKyspIHsgLy8gUmVkdWNlZCBmcm9tIDE1CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnJpc0RpciA9IHRhY2tsZURpci5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcHJlYWQKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVicmlzRGlyLnkgKz0gKE1hdGgucmFuZG9tKCkpICogMS4wOyAvLyBVcHdhcmQgYmlhcwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMS41OwogICAgICAgICAgICAgICAgICAgICAgICBkZWJyaXNEaXIubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoMTAuMCArIE1hdGgucmFuZG9tKCkgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgCnBtLnNwYXduKCdpbXBhY3Rfc2hhcmQnLCBpbXBhY3RQb3MsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBkZWJyaXNEaXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAyNS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZzogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTUuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHbGFuY2luZyBIaXQgRlgKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBQaXRjaCBzaGlmdCBiYXNlZCBvbiBxdWFsaXR5IChIaWdoZXIgcGl0Y2ggPSBjbGVhbmVyIGhpdCkKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJywgeyByYXRlOiAwLjggKyBxdWFsaXR5ICogMC40IH0pOwogICAgICAgICAgICAgICAgaWYgKGlzQ2xlYW5IaXQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCBib29tCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGlmIChpc0NsZWFuSGl0KSBkYW1hZ2UgKj0gMS41OwoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTSElFTEQgQ0hFQ0sKICAgICAgICAgICAgICAgIGxldCBmdW1ibGVDaGFuY2UgPSBpc0NsZWFuSGl0ID8gMS4wIDogMC4zOyAvLyBHbGFuY2luZyBoaXRzIHJhcmVseSBjYXVzZSBmdW1ibGVzIHVubGVzcyBFTiBkZXBsZXRlZAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAob3BwLnN0YXR1cy5zaGllbGQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICo9IDAuNTsKICAgICAgICAgICAgICAgICAgICBmdW1ibGVDaGFuY2UgPSAwLjA7IC8vIFNoaWVsZCBwcmV2ZW50cyBmdW1ibGUKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTERFRCIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGlzQ2xlYW5IaXQgPyAiQ1JJVElDQUwhIiA6ICJHTEFOQ0lORyI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBpc0NsZWFuSGl0ID8gImNvbWljLWltcGFjdCIgOiAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAvLyBEZWxheSBsYWJlbCBzbGlnaHRseSBmb3IgcmVhZGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCBvcHAubWVzaC5wb3NpdGlvbiwgc3R5bGUpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCAmJiBNYXRoLnJhbmRvbSgpIDwgZnVtYmxlQ2hhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdHVuIGxvZ2ljOiBDbGVhbiBoaXRzIHN0dW4gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjAgOiAwLjM7CiAgICAgICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEpVSUNFOiBJbXBhY3QgRmxhc2ggJiBTcXVhc2ggKFZpY3RpbSkKICAgICAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZjAwMDAsIGlzQ2xlYW5IaXQgPyAwLjMgOiAwLjEpOyAKICAgICAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMywgMC42LCAxLjMpOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQgJiYgaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaXQgcGxheWVyIHdpdGhvdXQgYmFsbAogICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IGlzQ2xlYW5IaXQgPyAxLjUgOiAwLjU7CiAgICAgICAgICAgICAgICBvcHAuZmxhc2goMHhmZmFhMDAsIDAuMik7CiAgICAgICAgICAgICAgICBvcHAuc3F1YXNoKDEuMiwgMC43LCAxLjIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGlzQ2xlYW5IaXQgPyAiU01BQ0shIiA6ICJCVU1QIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGh5c2ljcyBLbm9ja2JhY2sKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgY29uc3Qga25vY2tiYWNrRm9yY2UgPSBpc0NsZWFuSGl0ID8gMTguMCA6IDguMDsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKGtub2NrYmFja0ZvcmNlKSk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgJiBJbXBhY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZShpc0NsZWFuSGl0ID8gMS41IDogMC41KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KGlzQ2xlYW5IaXQgPyAwLjE1IDogMC4wNSwgaXNDbGVhbkhpdCA/ICdoZWF2eScgOiAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXJ0aWNsZXMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkLCBxdWFsaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RWZWwgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBpc0NsZWFuSGl0ID8gMzAgOiAxMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSBtaWQuY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSkpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJ1YmJsZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiBpbXBhY3RWZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtU2NhbGU6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNDbGVhbkhpdCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIG1pZCwgeyBzY2FsZTogMy4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlHb2FsQ3JlYXNlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQp9KTsKICAgICAgICB9CgpldmFkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZXZhZGVDb29sZG93biA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxMDsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKCnRoaXMuaXNFdmFkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5ldmFkZVRpbWUgPSAwLjQ7CiAgICAgICAgICAgIHRoaXMuZXZhZGVDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMC41OyAvLyBJbnZ1bG5lcmFiaWxpdHkgZnJhbWVzCgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwoKICAgICAgICAgICAgLy8gLS0tIFBFUkZFQ1QgRE9ER0UgQ0hFQ0sgLS0tCiAgICAgICAgICAgIGxldCBpc1BlcmZlY3QgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdhbWUgJiYgdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSBnYW1lLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAob3BwVGVhbSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBvcHBvbmVudCBpcyBkYXNoaW5nICh0YWNrbGluZykgYW5kIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHAuaXNEYXNoaW5nICYmIG9wcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNS4wIGlzIHNsaWdodGx5IGxhcmdlciB0aGFuIHRhY2tsZSByYWRpdXMgKDMuMCksIGNyZWF0aW5nIGEgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNQZXJmZWN0KSB7CiAgICAgICAgICAgICAgICAvLyAxLiBSZWZ1bmQgJiBCb251cwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSBNYXRoLm1pbih0aGlzLnN0YXRzLkVOLCB0aGlzLmN1cnJlbnRFTiArIGNvc3QgKyAxMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbHMKICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gVGVjaCBGbGFzaCBPdmVybGF5CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS51aSAmJiBnYW1lLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRmID0gZ2FtZS51aS50ZWNoRmxhc2g7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSB0Zi5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0Jyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdGYucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHh0KSB0eHQuaW5uZXJUZXh0ID0gIlBFUkZFQ1QgRE9ER0UiOwogICAgICAgICAgICAgICAgICAgIGlmIChzdWIpIHN1Yi5pbm5lclRleHQgPSB0aGlzLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgdGYuc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCksIHJnYmEoMCwgMjU1LCAyNTUsIDAuNiksIHJnYmEoMCwwLDAsMCkpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGYuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgODAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA0LiBNYXRyaXggVGltZSBTbG93CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRpbWVTY2FsZSA9IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSB8fCAwLjg7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjE7IC8vIFNsb3cgbW90aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgdGltZSBhZnRlciA4MDBtcyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IG9yaWdpbmFsVGltZVNjYWxlOwogICAgICAgICAgICAgICAgfSwgODAwKTsKCiAgICAgICAgICAgICAgICAvLyA1LiBDYW1lcmEgSnVpY2UKICAgICAgICAgICAgICAgIGlmIChnYW1lLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgtMTApOyAvLyBab29tIHNuYXAKICAgICAgICAgICAgICAgICAgICBnYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC41KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNi4gU0ZYCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyByYXRlOiAwLjUsIHZvbHVtZTogMS4yIH0pOyAvLyBEZWVwIHdob29zaAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDcuIFBhcnRpY2xlIEJ1cnN0CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgRXZhZGUKICAgICAgICAgICAgICAgIGlmIChnYW1lLmF1ZGlvTWFuYWdlcikgZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgcmF0ZTogMS41IH0pOwogICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRVZBREUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb21lbnR1bSBTaGlmdDogQWRkIHZlbG9jaXR5IHBlcnBlbmRpY3VsYXIgdG8gY3VycmVudCBmYWNpbmcgb3IgaW5wdXQKICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGRvZGdlIGRpcmVjdGlvbiBiYXNlZCBvbiBpbnB1dAogICAgICAgICAgICBsZXQgZG9kZ2VEaXIgPSByaWdodC5jbG9uZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIGRpcmVjdGlvbgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgZG9kZ2VEaXIubmVnYXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChkb2RnZURpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7IC8vIEJvb3N0ZWQgc3BlZWQKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoZndkLm11bHRpcGx5U2NhbGFyKDQuMCkpOyAvLyBTbGlnaHQgZm9yd2FyZCBtb21lbnR1bQogICAgICAgIH0KCnN0YXJ0VGFja2xlQ2hhcmdlKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuaXNUYWNrbGluZyB8fCB0aGlzLmlzUmVjb3ZlcmluZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLmlzVGFja2xlQ2hhcmdpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaXNUYWNrbGVDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGFja2xlQ2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyLjAsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuNSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWxlYXNlVGFja2xlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNUYWNrbGVDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzVGFja2xlQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy50YWNrbGVDaGFyZ2VUaW1lIC8gdGhpcy5tYXhUYWNrbGVDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICB0aGlzLnRhY2tsZUNoYXJnZUJvbnVzID0gcmF0aW87CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlyZWN0aW9uIGJhc2VkIG9uIGlucHV0CiAgICAgICAgICAgIGxldCBkeCA9IHRoaXMuaW5wdXRWZWN0b3IueDsKICAgICAgICAgICAgbGV0IGR6ID0gdGhpcy5pbnB1dFZlY3Rvci56OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgbm8gaW5wdXQsIHRhY2tsZSBmb3J3YXJkCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCAwLjEgJiYgTWF0aC5hYnMoZHopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgZHggPSBmd2QueDsKICAgICAgICAgICAgICAgIGR6ID0gZndkLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWNrbGUoZHgsIGR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGhpZ2ggY2hhcmdlLCBhZGQgZXh0cmEganVpY2UKICAgICAgICAgICAgaWYgKHJhdGlvID4gMC44KSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggVEFDS0xFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3RhY2tsZScsIHsgcmF0ZTogMC44IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUYWNrbGUoZHgsIGR6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA4OyAvLyBSZWR1Y2VkIGZyb20gMTUgdG8gZW5jb3VyYWdlIGFnZ3Jlc3Npb24KICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgdGhpcy5pc1RhY2tsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50YWNrbGVUaW1lID0gMC41OyAvLyBTbGlkZSBkdXJhdGlvbgogICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBEaXJlY3Rpb24KICAgICAgICAgICAgX3BWZWMuc2V0KGR4LCAwLCBkeik7CiAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIC8vIExvY2sgUm90YXRpb24gKENvbW1pdG1lbnQpCiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfcFZlYy54LCBfcFZlYy56KTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGFyZ2V0QW5nbGUgLSB0aGlzLnJvdGF0aW9uT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0YXJnZXRBbmdsZSk7CgogICAgICAgICAgICAvLyBJbml0aWFsIEltcHVsc2UgKEhpZ2ggVmVsb2NpdHkpCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gMjUuMDsgCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShfcFZlYykubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5pbWF0aW9uIChSZXVzZSB0aHJvdyBsdW5nZSBmb3Igbm93LCBsb29rcyBsaWtlIGEgc2hvdWxkZXIgYmFyZ2UpCiAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgIHBvcy55ID0gMC41OwogICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzdGFydEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuaXNFdmFkaW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNCbG9ja2luZyA9IHRydWU7CiAgICAgICAgICAgIC8vIFVzZSAnY2F0Y2gnIGFuaW1hdGlvbiBmb3IgYmxvY2sgc3RhbmNlCiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjIpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJsb2NrKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0Jsb2NraW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgovLyBFeHBvcnQgdG8gZ2xvYmFsIHNjb3BlCiAgICB3aW5kb3cuZmx1eC5QbGF5ZXIgPSBQbGF5ZXI7Cn0pKCk7","main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgovLyBFeHBvc2UgSW1wYWN0IFRyaWdnZXIKICAgIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCA9IGZ1bmN0aW9uKHBvcywgc3RyZW5ndGgpIHsKICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIGltcGFjdCBjZW50ZXIgdG8gbmV3IHBvc2l0aW9uIChMaXF1aWQgZmVlbCkKICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0UG9zLnZhbHVlLmxlcnAocG9zLCAwLjMpOwogICAgICAgIC8vIFN1c3RhaW4gc3RyZW5ndGggKEFjY3VtdWxhdGUgbWF4IHRvIGhhbmRsZSBjb250aW51b3VzIHByZXNzdXJlKQogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBNYXRoLm1heChfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlLCBzdHJlbmd0aCAqIDIuNSk7CiAgICB9OwoKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwaHlzaWNzL2xvZ2ljCiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKCiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKICAgIGxldCBfcG9zdFByb2Nlc3Npbmc7CgogICAgbGV0IF9jYW1lcmFNYW5hZ2VyOwogICAgbGV0IF93YXRlck92ZXJsYXk7CiAgICBsZXQgX2xpZ2h0U2hhZnRzOwogICAgbGV0IF9zdGFkaXVtOwpsZXQgX2dseXBoTWFuYWdlcjsKICAgIGxldCBfYXJlbmFUaGVtZU1hbmFnZXI7IC8vIERlcHJlY2F0ZWQsIG5vdyBpbiBHYW1lTWFuYWdlcgogICAgLy8gSU1QUk9WRUQ6IFNldHRpbmdzIG9iamVjdAogICAgY29uc3QgX3NldHRpbmdzID0gewogICAgICAgIGpveXN0aWNrU2Vuc2l0aXZpdHk6IDEuMCwKICAgICAgICBhaW1Bc3Npc3Q6IHRydWUsCiAgICAgICAgY2FtZXJhU2hha2U6IHRydWUsCiAgICAgICAgaGl0U3RvcDogdHJ1ZSwKICAgICAgICBpbnZlcnRDYW1lcmE6IGZhbHNlLAogICAgICAgIGF1dG9SZWNlbnRlcjogdHJ1ZQogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDY1LCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTAsIDE1KTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7CiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCmVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyLCBlbnRpdGllczoge30sIHRlYW1zOiB7IGhvbWU6IG51bGwsIGF3YXk6IG51bGwgfSB9OyAvLyBUZW1wIGhvb2sKX2NvbnRhaW5lci5hcHBlbmRDaGlsZChfcmVuZGVyZXIuZG9tRWxlbWVudCk7CgovLyAtLS0gVmlkZW8gT3ZlcmxheSBFbmZvcmNlbWVudCAtLS0KICAgICAgICAvLyAtLS0gT3ZlcmxheSBWaWRlbyBMb2dpYyBSZW1vdmVkIChTd2l0Y2hlZCB0byBHSUYpIC0tLQogICAgICAgIC8vIDUuIEVudmlyb25tZW50CiAgICAgICAgY3JlYXRlUGFydGljbGVzKCk7CiAgICAgICAgY3JlYXRlQXJlbmEoKTsKICAgICAgICBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCk7Ci8vIDUuNSBHYW1lIE1hbmFnZXIKX2dhbWVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyKF9zY2VuZSwgJ3VpLWxheWVyJywgX2NhbWVyYSwgX3JlbmRlcmVyKTsKICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSBfZ2FtZU1hbmFnZXI7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7Cl9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjUuMiBQb3N0IFByb2Nlc3NpbmcKX3Bvc3RQcm9jZXNzaW5nID0gbmV3IHdpbmRvdy5mbHV4LlBvc3RQcm9jZXNzaW5nKF9yZW5kZXJlciwgX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0KTsKICAgICAgICBfcG9zdFByb2Nlc3NpbmcuZW5hYmxlZCA9IGZhbHNlOyAvLyBEaXNhYmxlZCBieSBkZWZhdWx0IGZvciBwZXJmb3JtYW5jZQogICAgICAgIF9nYW1lTWFuYWdlci5wb3N0UHJvY2Vzc2luZyA9IF9wb3N0UHJvY2Vzc2luZzsKCiAgICAgICAgLy8gNS42IENhbWVyYSBNYW5hZ2VyCiAgICAgICAgX2NhbWVyYU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlcihfY2FtZXJhLCBfc2NlbmUpOwogICAgICAgIF9nYW1lTWFuYWdlci5jYW1lcmFNYW5hZ2VyID0gX2NhbWVyYU1hbmFnZXI7CgogICAgICAgIC8vIDUuNyBEZXYgVG9vbHMKaWYgKHdpbmRvdy5mbHV4LkRldlRvb2xzKSB7CiAgICAgICAgICAgIG5ldyB3aW5kb3cuZmx1eC5EZXZUb29scyhfZ2FtZU1hbmFnZXIpOwogICAgICAgIH0KLy8gNS44IFdhdGVyIE92ZXJsYXksIExpZ2h0IFNoYWZ0cywgU3RhZGl1bSwgR2x5cGhzCiAgICAgICAgX3dhdGVyT3ZlcmxheSA9IG5ldyB3aW5kb3cuZmx1eC5XYXRlck92ZXJsYXkoX2NhbWVyYSk7CiAgICAgICAgX2xpZ2h0U2hhZnRzID0gbmV3IHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzKF9zY2VuZSk7CiAgICAgICAgX3N0YWRpdW0gPSBuZXcgd2luZG93LmZsdXguU3RhZGl1bShfc2NlbmUpOwogICAgICAgIF9nbHlwaE1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyKF9zY2VuZSk7CiAgICAgICAgCgpfYXJlbmFUaGVtZU1hbmFnZXIgPSBudWxsOyAvLyBIYW5kbGVkIGJ5IEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwoKICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMTU7IC8vIFJlc3RvcmVkIENQVSBsZXZlbCBmb3IgY29tcGV0ZW5jZQogICAgICAgICAgICB3aW5kb3cuZmx1eC5UZWFtLmdlbmVyYXRlU3RhdHMocCwgcm9sZSwgdGVhbUxldmVsLCBpc0hvbWUpOwoKICAgICAgICAgICAgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgcC5zdGF0cy5TUCArPSAzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSAzOwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnQnJvdGhlcicpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH07CgogICAgICAgIGxldCBob21lTG9hZGVkID0gMDsKICAgICAgICBjb25zdCByb2xlR2x0ZnMgPSB7fTsKCiAgICAgICAgY29uc3QgZmluYWxpemVUZWFtcyA9ICgpID0+IHsKICAgICAgICAgICAgcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGdsdGYgPSByb2xlR2x0ZnNbcm9sZV0gfHwgcm9sZUdsdGZzLkxGOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkgPyBgQ1BVICR7ZW50cnkubmFtZX1gIDogJ0NQVSc7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBpZiAoZ2x0ZiAmJiBnbHRmLnNjZW5lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNzaW5nIEdMVEYgZm9yIGF3YXkgcm9sZTonLCByb2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfYXdheVRlYW0uYWRkUGxheWVyKHApOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbLi4uX2hvbWVUZWFtLnBsYXllcnMsIC4uLl9hd2F5VGVhbS5wbGF5ZXJzXTsKICAgICAgICAgICAgYWxsUGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKHAuYmFsbFJlZiA9PT0gbnVsbCkgcC5iYWxsUmVmID0gX2JhbGw7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciA9IF9ob21lVGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMudGFja2xlID0gJ3Zlbm9tJzsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMuc2hvb3QgPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcXVpcHBlZCBIb21lIE1GIHdpdGggVmVub20gVGFja2xlICYgU3BoZXJlIFNob3QnKTsKICAgICAgICAgICAgfQoKY29uc3QgYXdheU1GID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBXaXRoZXIgdGFja2xlIGZvciBBd2F5IE1GIHRvIHJlZHVjZSBkaWZmaWN1bHR5CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAvLyBSZW1vdmVkIGd1YXJhbnRlZWQgU3VwZXIgR29hbGllIGZvciBBd2F5IEdMIHRvIG1ha2Ugc2NvcmluZyBlYXNpZXIKCiAgICAgICAgICAgIF9ob21lVGVhbS5hc3NpZ25NYXJrcyhfYXdheVRlYW0pOwogICAgICAgICAgICBfYXdheVRlYW0uYXNzaWduTWFya3MoX2hvbWVUZWFtKTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnJlZ2lzdGVyVGVhbXMoX2hvbWVUZWFtLCBfYXdheVRlYW0sIF9iYWxsKTsKCiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguTWVudU1hbmFnZXIoX2dhbWVNYW5hZ2VyKTsKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICBpZiAoIWVudHJ5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvbkNvbXBsZXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaG9tZUxvYWRlZCsrOwogICAgICAgICAgICAgICAgaWYgKGhvbWVMb2FkZWQgPj0gcm9sZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxpemVUZWFtcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGVudHJ5LnVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IGdsdGY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICBwLnNldE1lc2goY2xvbmUsIGdsdGYuYW5pbWF0aW9ucyk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBtb2RlbCcsIGVudHJ5Lm5hbWUsIGVudHJ5LnVybCwgZXJyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgTWVzaCAoUmVkIEJveCkKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDEsIDIsIDEpOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZjAwMDAsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGZhbGxiYWNrR2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0b3JlIGR1bW15IGluIHJvbGVHbHRmcyBmb3IgYXdheSB0ZWFtIGNsb25pbmcKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IHsgc2NlbmU6IGZhbGxiYWNrTWVzaCwgYW5pbWF0aW9uczogW10gfTsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWUgKyAiIChFcnJvcikiOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGZhbGxiYWNrTWVzaC5jbG9uZSgpLCBbXSk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIDguIElucHV0CiAgICAgICAgc2V0dXBJbnB1dHMoKTsKCiAgICAgICAgLy8gOS4gTG9vcAogICAgICAgIF9jbG9jayA9IG5ldyBUSFJFRS5DbG9jaygpOwogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgLy8gSGFuZGxlIHJlc2l6ZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvblJlc2l6ZSk7CiAgICAgICAgb25SZXNpemUoKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZVBhcnRpY2xlcygpIHsKICAgICAgICBjb25zdCBjb3VudCA9IDIwMDsgLy8gT3B0aW1pemVkIGZvciBwZXJmb3JtYW5jZSAod2FzIDE1MDApCiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5qZWN0IEVsYXN0aWMgU2hhZGVyIGZvciBCYXNlIEFyZW5hCiAgICAgICAgbWF0ZXJpYWwub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSBfYXJlbmFVbmlmb3Jtcy51VGltZTsKICAgICAgICAgICAgc2hhZGVyLnVuaWZvcm1zLnVJbXBhY3RTdHIgPSBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyOwogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudUltcGFjdFBvcyA9IF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3M7CgogICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRWxhc3RpYyBCcmVhdGhpbmcgKEFtYmllbnQpCiAgICAgICAgICAgICAgICBmbG9hdCBicmVhdGggPSBzaW4ocG9zaXRpb24ueSAqIDAuMDggKyB1VGltZSAqIDEuMikgKiAxLjI7CiAgICAgICAgICAgICAgICBicmVhdGggKz0gc2luKHBvc2l0aW9uLnggKiAwLjA1ICsgdVRpbWUgKiAwLjgpICogMC44OwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogYnJlYXRoOwoKICAgICAgICAgICAgICAgIC8vIEltcGFjdCBSaXBwbGUgKFJlYWN0aXZlKQogICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGRpc3RhbmNlKHBvc2l0aW9uLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxNS4wKSAqIHVJbXBhY3RTdHIgKiAwLjg7CiAgICAgICAgICAgICAgICBmbG9hdCBtYXNrID0gc21vb3Roc3RlcCg0NS4wLCAwLjAsIGRpc3QpOwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogcmlwcGxlICogbWFzazsKICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgKTsKICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgSmVsbHkgV29iYmxlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgd29iYmxlID0gc2luKHBvcy55ICogMC4xICsgdVRpbWUgKiAyLjApICogMS41OwogICAgICAgICAgICAgICAgICAgIHdvYmJsZSArPSBjb3MocG9zLnogKiAwLjEgKyB1VGltZSAqIDEuNSkgKiAxLjU7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogd29iYmxlOwoKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgRGlzdG9ydGlvbgogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDM1LjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbW9vdGggY3ViaWMgZmFsbG9mZiBmb3Igb3JnYW5pYyBidWxnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVsZ2UgPSBidWxnZSAqIGJ1bGdlICogKDMuMCAtIDIuMCAqIGJ1bGdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpcHBsZSBlZmZlY3QgKENvbmNlbnRyaWMgd2F2ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxMi4wKSAqIDAuMjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGZyZXF1ZW5jeSBqaXR0ZXIgKFRlbnNpb24vRW5lcmd5KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBqaXR0ZXIgPSBzaW4ocG9zLnggKiAzLjAgKyB1VGltZSAqIDIwLjApICogc2luKHBvcy55ICogMy4wICsgdVRpbWUgKiAxNS4wKSAqIDAuMDg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBkaXN0b3J0aW9uOiBCdWxnZSBvdXQgKyBSaXBwbGVzICsgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyArPSBub3JtYWwgKiAoKGJ1bGdlICsgcmlwcGxlICogYnVsZ2UgKyBqaXR0ZXIgKiBidWxnZSkgKiB1SW1wYWN0U3RyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXhDb2xvciA9IHRleHR1cmUyRCh0TWFwLCB2VXYpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAzOyAKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjIsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcmVuYTIpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgPSBhcmVuYTI7CiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CmNvbnN0IGEgPSBpeSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGIgPSBpeSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSAoaXkgKyAxKSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSAoaXkgKyAxKSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChhLCBjLCBiKTsKICAgICAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYiwgYywgZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUocG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ25vcm1hbCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG5vcm1hbHMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh1dnMsIDIpKTsKICAgICAgICAgICAgZ2VvLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5NZXNoKGdlbywgYXJyb3dNYXQpOwogICAgICAgIH07CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQXJyb3dzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIG51bUFycm93cykgKiBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIC8vIFVwcGVyIGFycm93IHN0cmlwIChhYm92ZSBiYW5kKQogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIGFycm93SGVpZ2h0ICogMC41ICsgMiwgZmFsc2UpKTsKCiAgICAgICAgICAgIC8vIExvd2VyIGFycm93IHN0cmlwIChiZWxvdyBiYW5kKSAtIGZsaXAgViBzbyBhcnJvd3MgcG9pbnQgZG93bndhcmQKICAgICAgICAgICAgYXJyb3dHcm91cC5hZGQobWFrZUN1cnZlZFN0cmlwKGFuZ2xlLCAtYXJyb3dIZWlnaHQgKiAwLjUgLSAyLCB0cnVlKSk7CiAgICAgICAgfQoKICAgICAgICBfc2NlbmUuYWRkKGFycm93R3JvdXApOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzIGZvciBEZXZUb29scwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93R3JvdXAgPSBhcnJvd0dyb3VwOwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93TWF0ID0gYXJyb3dNYXQ7CgogICAgICAgIC8vIC0tLSA1LiBUT1AgR0xZUEhTIChEb21lKSAtLS0gKERvbWUpIC0tLQogICAgICAgIGNvbnN0IHRvcEdseXBoVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKDI1NiwgMjU2LCAyMDAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEludHJpY2F0ZSBwYXR0ZXJuCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IChpLzgpKk1hdGguUEkqMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAyNTYgKyBNYXRoLmNvcyhhKSoxNTA7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gMjU2ICsgTWF0aC5zaW4oYSkqMTUwOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmFyYyh4LCB5LCA0MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIC8vIENvbm5lY3RvcgogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygyNTYsIDI1Nik7Ci8vIENvbm5lY3RvcgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwoKICAgICAgICBjb25zdCB0b3BHbHlwaE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogdG9wR2x5cGhUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjQsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICBjb25zdCB0b3BHbHlwaEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDYwLCA2MCk7CiAgICAgICAgY29uc3QgdG9wR2x5cGggPSBuZXcgVEhSRUUuTWVzaCh0b3BHbHlwaEdlbywgdG9wR2x5cGhNYXQpOwogICAgICAgIHRvcEdseXBoLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgdG9wR2x5cGgucG9zaXRpb24ueSA9IDM1OyAvLyBOZWFyIHRvcCBvZiBkb21lCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodG9wR2x5cGgpOwoKICAgICAgICAvLyAtLS0gTkVXOiBGRlggR09BTCBNT0RFTFMgLS0tCiAgICAgICAgY29uc3QgZ29hbFVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJzsKICAgICAgICAKY29uc3Qgb25Hb2FsTG9hZGVkID0gKG1vZGVsLCBpc0ZhbGxiYWNrKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxBID0gbW9kZWw7CgogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFkgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgOiAtMTguMDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxTY2FsZSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSA6IDQ1LjA7CiAgICAgICAgICAgIGNvbnN0IHN4ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1gpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCA6IDEuMDsKICAgICAgICAgICAgY29uc3Qgc3kgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeiA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9aKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogOiAxLjA7CiAgICAgICAgICAgIApnb2FsQS5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIC1nb2FsRGlzdCk7CiAgICAgICAgICAgIGlmICghaXNGYWxsYmFjaykgewogICAgICAgICAgICAgICAgZ29hbEEuc2NhbGUuc2V0KGdvYWxTY2FsZSAqIHN4LCBnb2FsU2NhbGUgKiBzeSwgZ29hbFNjYWxlICogc3opOyAKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEEKICAgICAgICAgICAgZ29hbEEudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nCiAgICAgICAgICAgICAgICAgICAgYy5yZW5kZXJPcmRlciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1hdGVyaWFsIGlzIHZpc2libGUgYW5kIHVuaXF1ZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwgPSBjLm1hdGVyaWFsLmNsb25lKCk7IC8vIENsb25lIGZvciBpbmRlcGVuZGVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQWRkIGdvYWxzIHRvIFNDRU5FLCBub3QgYXJlbmFHcm91cCAodGhleSBzaG91bGRuJ3Qgcm90YXRlIHdpdGggdGhlIHNwaGVyZSkKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxBID0gZ29hbEE7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7Cgpnb2FsQi5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIGdvYWxEaXN0KTsKaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQi5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQgYW5kIGhhdmUgdW5pcXVlIG1hdGVyaWFscwogICAgICAgICAgICBnb2FsQi50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgYWdhaW4gZm9yIEIKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2FsQiA9IGdvYWxCOyAvLyBFeHBvc2UgZm9yIERldlRvb2xzCiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICAvLyBMb2FkIGZsb29yIGdseXBoIGZyb20gaW1hZ2UKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IHRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy92OENSODVkUS9GbG9vcmdseXBoLnBuZycpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgZmllbGQgPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICBmaWVsZC5wb3NpdGlvbi55ID0gLTguMDsgLy8gU3VuayBkZWVwCiAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2ggPSBmaWVsZDsKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0ID0gbWF0OwogICAgfQoKZnVuY3Rpb24gY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpIHsKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQpsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgpmdW5jdGlvbiBzZXR1cElucHV0cygpIHsKICAgICAgICAvLyBTa2lwIEludHJvIExpc3RlbmVyCiAgICAgICAgY29uc3Qgc2tpcEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBza2lwSGFuZGxlcik7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBza2lwSGFuZGxlciwge3Bhc3NpdmU6IHRydWV9KTsKCiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQovLyBORVc6IFRhY2tsZS9TcHJpbnQgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zZTogU3ByaW50L0JyZWFrIChJbnN0YW50KQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2U6IFN0YXJ0IENoYXJnZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaXNUYWNrbGVDaGFyZ2luZyAmJiAhcC5pc1RhY2tsaW5nICYmICFwLmlzUmVjb3ZlcmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogRXZhZGUgb24gJ0UnCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdLZXlFJykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5ldmFkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IAogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSBmYWxzZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBORVc6IFJlbGVhc2UgVGFja2xlIG9uIFNoaWZ0IFVwCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiBwLmlzVGFja2xlQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOyAKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWxsKSBwLnRocm93QmFsbChiYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERFRkVOU0U6IEJsb2NrCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiAhcC5pc0Rhc2hpbmcgJiYgIXAuaXNFdmFkaW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwICYmIHAuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0QmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdEVuZC5jbGllbnRYLCB5OiB0RW5kLmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGUuY2xpZW50WCwgeTogZS5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICAvLyBBbmFseXplIFN3aXBlCiAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnZlRGF0YSA9IHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCB3YXMgYSB0YXAgKHNob3J0IGR1cmF0aW9uLCBsb3cgbW92ZW1lbnQpCiAgICAgICAgICAgICAgICBjb25zdCBpc1RhcCA9IChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPCAyMDApICYmIChNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSkgPCAyMCk7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gU1BJTiBDQUxDVUxBVElPTiAoSWYgY3VydmUgaXMgc3Ryb25nIGVub3VnaCkKICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIHx8IDAuMjUpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSB8fCAxMDAwLjApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBhbmFseXNpcy5zcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQIHx8IDE1MDAuMCksIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0b3BCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKICAgICAgICAvLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAovLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCiAgICAgICAgbGV0IGhvbGRUaW1lciA9IG51bGw7CiAgICAgICAgbGV0IGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgIGxldCBsYXN0VGFwVGltZSA9IDA7CiAgICAgICAgY29uc3QgSE9MRF9USFJFU0hPTEQgPSAyMDA7IC8vIG1zCiAgICAgICAgY29uc3QgRE9VQkxFX1RBUF9USFJFU0hPTEQgPSAzMDA7IC8vIG1zCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjbGllbnRYID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYOwogICAgICAgICAgICAgICAgY2xpZW50WSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgICAgICAvLyBSZXNldCBIb2xkIFN0YXRlCiAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIC8vIFN0YXJ0IEhvbGQgVGltZXIKICAgICAgICAgICAgaG9sZFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gT25seSBjaGFyZ2UgaWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCAoRGVmZW5zaXZlIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsgLy8gVmlzdWFsIGN1ZSBmb3IgY2hhcmdlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIEhPTERfVEhSRVNIT0xEKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgaWYgKGhvbGRUaW1lcikgY2xlYXJUaW1lb3V0KGhvbGRUaW1lcik7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIGlmIChpc0hvbGRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBIT0xEIFJFTEVBU0UgKENoYXJnZWQgVGFja2xlKSAtLS0KICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBUQVAgKFRhY2tsZSAvIEV2YWRlKSAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lU2luY2VMYXN0ID0gbm93IC0gbGFzdFRhcFRpbWU7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVTaW5jZUxhc3QgPCBET1VCTEVfVEFQX1RIUkVTSE9MRCkgewogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBET1VCTEUgVEFQOiBFVkFERSAtLS0KICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBjYW5jZWwgZGFzaCBpZiBhY3RpdmUgdG8gYWxsb3cgaW1tZWRpYXRlIGV2YWRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuZGFzaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHAuZXZhZGUoKTsKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IDA7IC8vIFJlc2V0IHRvIHByZXZlbnQgdHJpcGxlLXRhcCBpc3N1ZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFNJTkdMRSBUQVA6IFRBQ0tMRSAvIEJSRUFLIC0tLQogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2l2ZSBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFogPSBwLmlucHV0VmVjdG9yLno7CgovLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiBwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zaXZlIEJyZWFrIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IG5vdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIAogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChpc0hvbGRpbmcgfHwgaG9sZFRpbWVyKSBoYW5kbGVFbmQoZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7Cl9hdWRpb01hbmFnZXIuc2V0TWFzdGVyVm9sdW1lKHZvbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gRXhpdCB0byBNZW51CiAgICAgICAgY29uc3QgZXhpdEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGl0LXRvLW1lbnUtYnRuJyk7CiAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfbWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgICAgIC8vIEZvcmNlIGltbWVkaWF0ZSBjYW1lcmEgdXBkYXRlIHRvIHByZXZlbnQganVtcAogICAgICAgICAgICBpZiAoX2NhbWVyYU1hbmFnZXIpIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZSgwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3RyaWN0bHkgMC41MCBhcyByZXF1ZXN0ZWQgZm9yIHBlcmZvcm1hbmNlCi8vIFBlcmZvcm1hbmNlIE9wdGltaXphdGlvbjogQ2FwIHJlc29sdXRpb24KY29uc3QgbWF4RGltZW5zaW9uID0gNDgwOyAvLyBIYXJkIGNhcCBvbiBpbnRlcm5hbCByZW5kZXIgcmVzb2x1dGlvbiAoUmVkdWNlZCBmb3IgcGVyZm9ybWFuY2UpCiAgICAgICAgY29uc3QgY3VycmVudE1heCA9IE1hdGgubWF4KHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGxldCByZXNTY2FsZSA9IDAuNTA7IC8vIEJhc2Ugc2NhbGUKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudE1heCAqIHJlc1NjYWxlID4gbWF4RGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJlc1NjYWxlID0gbWF4RGltZW5zaW9uIC8gY3VycmVudE1heDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbFdpZHRoID0gTWF0aC5mbG9vcih3aWR0aCAqIHJlc1NjYWxlKTsKICAgICAgICBfY29uZmlnLmludGVybmFsSGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQgKiByZXNTY2FsZSk7CmlmIChfcmVuZGVyZXIpIHsKICAgICAgICAgICAgX3JlbmRlcmVyLnNldFNpemUoX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0LCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIF9wb3N0UHJvY2Vzc2luZy5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgfQogICAgfQoKLy8gLS0tIEZJWEVEIFRJTUVTVEVQIFZBUklBQkxFUyAtLS0KICAgIGxldCBfYWNjdW11bGF0b3IgPSAwOwogICAgY29uc3QgX2ZpeGVkU3RlcCA9IDEgLyA2MDsKCiAgICBmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmKSB7CiAgICAgICAgICAgIGNvbnN0IHBlcmYgPSB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmOwogICAgICAgICAgICBwZXJmLmZyYW1lID0gKHBlcmYuZnJhbWUgfHwgMCkgKyAxOwogICAgICAgICAgICBwZXJmLnJhd0R0ID0gcmF3RHQ7CiAgICAgICAgICAgIHBlcmYuZHQgPSBkdDsKICAgICAgICAgICAgY29uc3QgZnBzID0gZHQgPiAwID8gKDEgLyBkdCkgOiAwOwogICAgICAgICAgICBwZXJmLmZwcyA9IGZwczsKICAgICAgICAgICAgcGVyZi5hdmdGcHMgPSAocGVyZi5hdmdGcHMgJiYgcGVyZi5hdmdGcHMgPiAwKSA/IChwZXJmLmF2Z0ZwcyAqIDAuOSArIGZwcyAqIDAuMSkgOiBmcHM7CiAgICAgICAgfQoKICAgICAgICAvLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KQovLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KSAtIERpc2FibGVkCiAgICAgICAgLy8gaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7IC4uLiB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCmlmIChfYWNjdW11bGF0b3IgPiAwLjEpIF9hY2N1bXVsYXRvciA9IDAuMTsgLy8gQ2FwIGF0IDEwMG1zIHRvIHByZXZlbnQgc3BpcmFsIG9mIGRlYXRoCgogICAgICAgIHdoaWxlIChfYWNjdW11bGF0b3IgPj0gX2ZpeGVkU3RlcCkgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX2ZpeGVkU3RlcDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIF9hY2N1bXVsYXRvciA9IDA7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgICAgICAvLyBVcGRhdGUgRW50aXRpZXMgKFBoeXNpY3MvQUkpCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9hd2F5VGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwgJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYgogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSdW50aW1lIFVwZGF0ZXJzIChlLmcuIFJpbmdzIGxvZ2ljKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2FjY3VtdWxhdG9yIC09IF9maXhlZFN0ZXA7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVklTVUFMIFVQREFURSBMT09QIChPbmNlIFBlciBGcmFtZSkgLS0tCiAgICAgICAgLy8gVGhlc2Ugc3lzdGVtcyBkb24ndCBhZmZlY3QgZ2FtZXBsYXkgb3V0Y29tZSwgc28gd2UgdXBkYXRlIHRoZW0gd2l0aCB0aGUgdmlzdWFsIGRlbHRhIGBkdGAKICAgICAgICAvLyB0byBlbnN1cmUgc21vb3RoIGFuaW1hdGlvbiBhdCBoaWdoIHJlZnJlc2ggcmF0ZXMgKDkwLzEyMEh6KSB3aXRob3V0IHdhc3RpbmcgQ1BVIG9uIHBoeXNpY3MuCgogICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgIC8vIENhbWVyYQogICAgICAgIGlmICghaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KTsKICAgICAgICB9CgogICAgICAgIC8vIFZpc3VhbCBGWCBTeXN0ZW1zCiAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX3N0YWRpdW0pIF9zdGFkaXVtLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKCmlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIAogICAgICAgIC8vIEFyZW5hVGhlbWVNYW5hZ2VyIHVwZGF0ZWQgaW4gR2FtZU1hbmFnZXIudXBkYXRlKCkgKFBoeXNpY3MgTG9vcCkKLy8gQXJlbmFUaGVtZU1hbmFnZXIgdXBkYXRlZCBpbiBHYW1lTWFuYWdlci51cGRhdGUoKSAoUGh5c2ljcyBMb29wKQpfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogMy4wKTsgLy8gU2xvd2VyIGRlY2F5IGZvciB2aXNjb3VzIHN0cmV0Y2gKCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCi8vIFJlbmRlcgogICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgaWYgKF9wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEsIGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9Cgp9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHAuaXNCbG9ja2luZykgewogICAgICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQkxPQ0siKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkJMT0NLIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOyAvLyBFbnN1cmUgdmlzdWFsIGZlZWRiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiREVGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCmlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFbGVtZW50YWwgU3RhdHVzIG9uIEZ1bWJsZQogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ2ZpcmUnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ2J1cm4nLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICdpY2UnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3Nsb3cnLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd2b2x0JykgZW50aXR5LmFwcGx5U3RhdHVzKCdzaG9jaycsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ3Zlbm9tJykgZW50aXR5LmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd3aXRoZXInKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdDQScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICduYXAnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ25hcCcsIDUuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVudGl0eS5jYXRjaENvb2xkb3duID0gMS4wOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","./main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgovLyBFeHBvc2UgSW1wYWN0IFRyaWdnZXIKICAgIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCA9IGZ1bmN0aW9uKHBvcywgc3RyZW5ndGgpIHsKICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIGltcGFjdCBjZW50ZXIgdG8gbmV3IHBvc2l0aW9uIChMaXF1aWQgZmVlbCkKICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0UG9zLnZhbHVlLmxlcnAocG9zLCAwLjMpOwogICAgICAgIC8vIFN1c3RhaW4gc3RyZW5ndGggKEFjY3VtdWxhdGUgbWF4IHRvIGhhbmRsZSBjb250aW51b3VzIHByZXNzdXJlKQogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBNYXRoLm1heChfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlLCBzdHJlbmd0aCAqIDIuNSk7CiAgICB9OwoKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwaHlzaWNzL2xvZ2ljCiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKCiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKICAgIGxldCBfcG9zdFByb2Nlc3Npbmc7CgogICAgbGV0IF9jYW1lcmFNYW5hZ2VyOwogICAgbGV0IF93YXRlck92ZXJsYXk7CiAgICBsZXQgX2xpZ2h0U2hhZnRzOwogICAgbGV0IF9zdGFkaXVtOwpsZXQgX2dseXBoTWFuYWdlcjsKICAgIGxldCBfYXJlbmFUaGVtZU1hbmFnZXI7IC8vIERlcHJlY2F0ZWQsIG5vdyBpbiBHYW1lTWFuYWdlcgogICAgLy8gSU1QUk9WRUQ6IFNldHRpbmdzIG9iamVjdAogICAgY29uc3QgX3NldHRpbmdzID0gewogICAgICAgIGpveXN0aWNrU2Vuc2l0aXZpdHk6IDEuMCwKICAgICAgICBhaW1Bc3Npc3Q6IHRydWUsCiAgICAgICAgY2FtZXJhU2hha2U6IHRydWUsCiAgICAgICAgaGl0U3RvcDogdHJ1ZSwKICAgICAgICBpbnZlcnRDYW1lcmE6IGZhbHNlLAogICAgICAgIGF1dG9SZWNlbnRlcjogdHJ1ZQogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDY1LCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTAsIDE1KTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7CiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCmVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyLCBlbnRpdGllczoge30sIHRlYW1zOiB7IGhvbWU6IG51bGwsIGF3YXk6IG51bGwgfSB9OyAvLyBUZW1wIGhvb2sKX2NvbnRhaW5lci5hcHBlbmRDaGlsZChfcmVuZGVyZXIuZG9tRWxlbWVudCk7CgovLyAtLS0gVmlkZW8gT3ZlcmxheSBFbmZvcmNlbWVudCAtLS0KICAgICAgICAvLyAtLS0gT3ZlcmxheSBWaWRlbyBMb2dpYyBSZW1vdmVkIChTd2l0Y2hlZCB0byBHSUYpIC0tLQogICAgICAgIC8vIDUuIEVudmlyb25tZW50CiAgICAgICAgY3JlYXRlUGFydGljbGVzKCk7CiAgICAgICAgY3JlYXRlQXJlbmEoKTsKICAgICAgICBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCk7Ci8vIDUuNSBHYW1lIE1hbmFnZXIKX2dhbWVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyKF9zY2VuZSwgJ3VpLWxheWVyJywgX2NhbWVyYSwgX3JlbmRlcmVyKTsKICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSBfZ2FtZU1hbmFnZXI7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7Cl9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjUuMiBQb3N0IFByb2Nlc3NpbmcKX3Bvc3RQcm9jZXNzaW5nID0gbmV3IHdpbmRvdy5mbHV4LlBvc3RQcm9jZXNzaW5nKF9yZW5kZXJlciwgX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0KTsKICAgICAgICBfcG9zdFByb2Nlc3NpbmcuZW5hYmxlZCA9IGZhbHNlOyAvLyBEaXNhYmxlZCBieSBkZWZhdWx0IGZvciBwZXJmb3JtYW5jZQogICAgICAgIF9nYW1lTWFuYWdlci5wb3N0UHJvY2Vzc2luZyA9IF9wb3N0UHJvY2Vzc2luZzsKCiAgICAgICAgLy8gNS42IENhbWVyYSBNYW5hZ2VyCiAgICAgICAgX2NhbWVyYU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlcihfY2FtZXJhLCBfc2NlbmUpOwogICAgICAgIF9nYW1lTWFuYWdlci5jYW1lcmFNYW5hZ2VyID0gX2NhbWVyYU1hbmFnZXI7CgogICAgICAgIC8vIDUuNyBEZXYgVG9vbHMKaWYgKHdpbmRvdy5mbHV4LkRldlRvb2xzKSB7CiAgICAgICAgICAgIG5ldyB3aW5kb3cuZmx1eC5EZXZUb29scyhfZ2FtZU1hbmFnZXIpOwogICAgICAgIH0KLy8gNS44IFdhdGVyIE92ZXJsYXksIExpZ2h0IFNoYWZ0cywgU3RhZGl1bSwgR2x5cGhzCiAgICAgICAgX3dhdGVyT3ZlcmxheSA9IG5ldyB3aW5kb3cuZmx1eC5XYXRlck92ZXJsYXkoX2NhbWVyYSk7CiAgICAgICAgX2xpZ2h0U2hhZnRzID0gbmV3IHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzKF9zY2VuZSk7CiAgICAgICAgX3N0YWRpdW0gPSBuZXcgd2luZG93LmZsdXguU3RhZGl1bShfc2NlbmUpOwogICAgICAgIF9nbHlwaE1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyKF9zY2VuZSk7CiAgICAgICAgCgpfYXJlbmFUaGVtZU1hbmFnZXIgPSBudWxsOyAvLyBIYW5kbGVkIGJ5IEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwoKICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMTU7IC8vIFJlc3RvcmVkIENQVSBsZXZlbCBmb3IgY29tcGV0ZW5jZQogICAgICAgICAgICB3aW5kb3cuZmx1eC5UZWFtLmdlbmVyYXRlU3RhdHMocCwgcm9sZSwgdGVhbUxldmVsLCBpc0hvbWUpOwoKICAgICAgICAgICAgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgcC5zdGF0cy5TUCArPSAzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSAzOwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnQnJvdGhlcicpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH07CgogICAgICAgIGxldCBob21lTG9hZGVkID0gMDsKICAgICAgICBjb25zdCByb2xlR2x0ZnMgPSB7fTsKCiAgICAgICAgY29uc3QgZmluYWxpemVUZWFtcyA9ICgpID0+IHsKICAgICAgICAgICAgcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGdsdGYgPSByb2xlR2x0ZnNbcm9sZV0gfHwgcm9sZUdsdGZzLkxGOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkgPyBgQ1BVICR7ZW50cnkubmFtZX1gIDogJ0NQVSc7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBpZiAoZ2x0ZiAmJiBnbHRmLnNjZW5lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNzaW5nIEdMVEYgZm9yIGF3YXkgcm9sZTonLCByb2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfYXdheVRlYW0uYWRkUGxheWVyKHApOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbLi4uX2hvbWVUZWFtLnBsYXllcnMsIC4uLl9hd2F5VGVhbS5wbGF5ZXJzXTsKICAgICAgICAgICAgYWxsUGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKHAuYmFsbFJlZiA9PT0gbnVsbCkgcC5iYWxsUmVmID0gX2JhbGw7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciA9IF9ob21lVGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMudGFja2xlID0gJ3Zlbm9tJzsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMuc2hvb3QgPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcXVpcHBlZCBIb21lIE1GIHdpdGggVmVub20gVGFja2xlICYgU3BoZXJlIFNob3QnKTsKICAgICAgICAgICAgfQoKY29uc3QgYXdheU1GID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBXaXRoZXIgdGFja2xlIGZvciBBd2F5IE1GIHRvIHJlZHVjZSBkaWZmaWN1bHR5CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAvLyBSZW1vdmVkIGd1YXJhbnRlZWQgU3VwZXIgR29hbGllIGZvciBBd2F5IEdMIHRvIG1ha2Ugc2NvcmluZyBlYXNpZXIKCiAgICAgICAgICAgIF9ob21lVGVhbS5hc3NpZ25NYXJrcyhfYXdheVRlYW0pOwogICAgICAgICAgICBfYXdheVRlYW0uYXNzaWduTWFya3MoX2hvbWVUZWFtKTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnJlZ2lzdGVyVGVhbXMoX2hvbWVUZWFtLCBfYXdheVRlYW0sIF9iYWxsKTsKCiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguTWVudU1hbmFnZXIoX2dhbWVNYW5hZ2VyKTsKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICBpZiAoIWVudHJ5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvbkNvbXBsZXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaG9tZUxvYWRlZCsrOwogICAgICAgICAgICAgICAgaWYgKGhvbWVMb2FkZWQgPj0gcm9sZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxpemVUZWFtcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGVudHJ5LnVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IGdsdGY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICBwLnNldE1lc2goY2xvbmUsIGdsdGYuYW5pbWF0aW9ucyk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBtb2RlbCcsIGVudHJ5Lm5hbWUsIGVudHJ5LnVybCwgZXJyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgTWVzaCAoUmVkIEJveCkKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDEsIDIsIDEpOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZjAwMDAsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGZhbGxiYWNrR2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0b3JlIGR1bW15IGluIHJvbGVHbHRmcyBmb3IgYXdheSB0ZWFtIGNsb25pbmcKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IHsgc2NlbmU6IGZhbGxiYWNrTWVzaCwgYW5pbWF0aW9uczogW10gfTsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWUgKyAiIChFcnJvcikiOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGZhbGxiYWNrTWVzaC5jbG9uZSgpLCBbXSk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIDguIElucHV0CiAgICAgICAgc2V0dXBJbnB1dHMoKTsKCiAgICAgICAgLy8gOS4gTG9vcAogICAgICAgIF9jbG9jayA9IG5ldyBUSFJFRS5DbG9jaygpOwogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgLy8gSGFuZGxlIHJlc2l6ZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvblJlc2l6ZSk7CiAgICAgICAgb25SZXNpemUoKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZVBhcnRpY2xlcygpIHsKICAgICAgICBjb25zdCBjb3VudCA9IDIwMDsgLy8gT3B0aW1pemVkIGZvciBwZXJmb3JtYW5jZSAod2FzIDE1MDApCiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5qZWN0IEVsYXN0aWMgU2hhZGVyIGZvciBCYXNlIEFyZW5hCiAgICAgICAgbWF0ZXJpYWwub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSBfYXJlbmFVbmlmb3Jtcy51VGltZTsKICAgICAgICAgICAgc2hhZGVyLnVuaWZvcm1zLnVJbXBhY3RTdHIgPSBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyOwogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudUltcGFjdFBvcyA9IF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3M7CgogICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRWxhc3RpYyBCcmVhdGhpbmcgKEFtYmllbnQpCiAgICAgICAgICAgICAgICBmbG9hdCBicmVhdGggPSBzaW4ocG9zaXRpb24ueSAqIDAuMDggKyB1VGltZSAqIDEuMikgKiAxLjI7CiAgICAgICAgICAgICAgICBicmVhdGggKz0gc2luKHBvc2l0aW9uLnggKiAwLjA1ICsgdVRpbWUgKiAwLjgpICogMC44OwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogYnJlYXRoOwoKICAgICAgICAgICAgICAgIC8vIEltcGFjdCBSaXBwbGUgKFJlYWN0aXZlKQogICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGRpc3RhbmNlKHBvc2l0aW9uLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxNS4wKSAqIHVJbXBhY3RTdHIgKiAwLjg7CiAgICAgICAgICAgICAgICBmbG9hdCBtYXNrID0gc21vb3Roc3RlcCg0NS4wLCAwLjAsIGRpc3QpOwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogcmlwcGxlICogbWFzazsKICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgKTsKICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgSmVsbHkgV29iYmxlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgd29iYmxlID0gc2luKHBvcy55ICogMC4xICsgdVRpbWUgKiAyLjApICogMS41OwogICAgICAgICAgICAgICAgICAgIHdvYmJsZSArPSBjb3MocG9zLnogKiAwLjEgKyB1VGltZSAqIDEuNSkgKiAxLjU7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogd29iYmxlOwoKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgRGlzdG9ydGlvbgogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDM1LjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbW9vdGggY3ViaWMgZmFsbG9mZiBmb3Igb3JnYW5pYyBidWxnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVsZ2UgPSBidWxnZSAqIGJ1bGdlICogKDMuMCAtIDIuMCAqIGJ1bGdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpcHBsZSBlZmZlY3QgKENvbmNlbnRyaWMgd2F2ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxMi4wKSAqIDAuMjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGZyZXF1ZW5jeSBqaXR0ZXIgKFRlbnNpb24vRW5lcmd5KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBqaXR0ZXIgPSBzaW4ocG9zLnggKiAzLjAgKyB1VGltZSAqIDIwLjApICogc2luKHBvcy55ICogMy4wICsgdVRpbWUgKiAxNS4wKSAqIDAuMDg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBkaXN0b3J0aW9uOiBCdWxnZSBvdXQgKyBSaXBwbGVzICsgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyArPSBub3JtYWwgKiAoKGJ1bGdlICsgcmlwcGxlICogYnVsZ2UgKyBqaXR0ZXIgKiBidWxnZSkgKiB1SW1wYWN0U3RyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXhDb2xvciA9IHRleHR1cmUyRCh0TWFwLCB2VXYpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAzOyAKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjIsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcmVuYTIpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgPSBhcmVuYTI7CiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CmNvbnN0IGEgPSBpeSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGIgPSBpeSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSAoaXkgKyAxKSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSAoaXkgKyAxKSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChhLCBjLCBiKTsKICAgICAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYiwgYywgZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUocG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ25vcm1hbCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG5vcm1hbHMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh1dnMsIDIpKTsKICAgICAgICAgICAgZ2VvLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5NZXNoKGdlbywgYXJyb3dNYXQpOwogICAgICAgIH07CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQXJyb3dzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIG51bUFycm93cykgKiBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIC8vIFVwcGVyIGFycm93IHN0cmlwIChhYm92ZSBiYW5kKQogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIGFycm93SGVpZ2h0ICogMC41ICsgMiwgZmFsc2UpKTsKCiAgICAgICAgICAgIC8vIExvd2VyIGFycm93IHN0cmlwIChiZWxvdyBiYW5kKSAtIGZsaXAgViBzbyBhcnJvd3MgcG9pbnQgZG93bndhcmQKICAgICAgICAgICAgYXJyb3dHcm91cC5hZGQobWFrZUN1cnZlZFN0cmlwKGFuZ2xlLCAtYXJyb3dIZWlnaHQgKiAwLjUgLSAyLCB0cnVlKSk7CiAgICAgICAgfQoKICAgICAgICBfc2NlbmUuYWRkKGFycm93R3JvdXApOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzIGZvciBEZXZUb29scwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93R3JvdXAgPSBhcnJvd0dyb3VwOwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93TWF0ID0gYXJyb3dNYXQ7CgogICAgICAgIC8vIC0tLSA1LiBUT1AgR0xZUEhTIChEb21lKSAtLS0gKERvbWUpIC0tLQogICAgICAgIGNvbnN0IHRvcEdseXBoVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKDI1NiwgMjU2LCAyMDAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEludHJpY2F0ZSBwYXR0ZXJuCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IChpLzgpKk1hdGguUEkqMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAyNTYgKyBNYXRoLmNvcyhhKSoxNTA7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gMjU2ICsgTWF0aC5zaW4oYSkqMTUwOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmFyYyh4LCB5LCA0MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIC8vIENvbm5lY3RvcgogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygyNTYsIDI1Nik7Ci8vIENvbm5lY3RvcgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwoKICAgICAgICBjb25zdCB0b3BHbHlwaE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogdG9wR2x5cGhUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjQsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICBjb25zdCB0b3BHbHlwaEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDYwLCA2MCk7CiAgICAgICAgY29uc3QgdG9wR2x5cGggPSBuZXcgVEhSRUUuTWVzaCh0b3BHbHlwaEdlbywgdG9wR2x5cGhNYXQpOwogICAgICAgIHRvcEdseXBoLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgdG9wR2x5cGgucG9zaXRpb24ueSA9IDM1OyAvLyBOZWFyIHRvcCBvZiBkb21lCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodG9wR2x5cGgpOwoKICAgICAgICAvLyAtLS0gTkVXOiBGRlggR09BTCBNT0RFTFMgLS0tCiAgICAgICAgY29uc3QgZ29hbFVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJzsKICAgICAgICAKY29uc3Qgb25Hb2FsTG9hZGVkID0gKG1vZGVsLCBpc0ZhbGxiYWNrKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxBID0gbW9kZWw7CgogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFkgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgOiAtMTguMDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxTY2FsZSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSA6IDQ1LjA7CiAgICAgICAgICAgIGNvbnN0IHN4ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1gpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCA6IDEuMDsKICAgICAgICAgICAgY29uc3Qgc3kgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeiA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9aKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogOiAxLjA7CiAgICAgICAgICAgIApnb2FsQS5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIC1nb2FsRGlzdCk7CiAgICAgICAgICAgIGlmICghaXNGYWxsYmFjaykgewogICAgICAgICAgICAgICAgZ29hbEEuc2NhbGUuc2V0KGdvYWxTY2FsZSAqIHN4LCBnb2FsU2NhbGUgKiBzeSwgZ29hbFNjYWxlICogc3opOyAKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEEKICAgICAgICAgICAgZ29hbEEudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nCiAgICAgICAgICAgICAgICAgICAgYy5yZW5kZXJPcmRlciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1hdGVyaWFsIGlzIHZpc2libGUgYW5kIHVuaXF1ZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwgPSBjLm1hdGVyaWFsLmNsb25lKCk7IC8vIENsb25lIGZvciBpbmRlcGVuZGVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQWRkIGdvYWxzIHRvIFNDRU5FLCBub3QgYXJlbmFHcm91cCAodGhleSBzaG91bGRuJ3Qgcm90YXRlIHdpdGggdGhlIHNwaGVyZSkKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxBID0gZ29hbEE7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7Cgpnb2FsQi5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIGdvYWxEaXN0KTsKaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQi5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQgYW5kIGhhdmUgdW5pcXVlIG1hdGVyaWFscwogICAgICAgICAgICBnb2FsQi50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgYWdhaW4gZm9yIEIKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2FsQiA9IGdvYWxCOyAvLyBFeHBvc2UgZm9yIERldlRvb2xzCiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICAvLyBMb2FkIGZsb29yIGdseXBoIGZyb20gaW1hZ2UKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IHRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy92OENSODVkUS9GbG9vcmdseXBoLnBuZycpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgZmllbGQgPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICBmaWVsZC5wb3NpdGlvbi55ID0gLTguMDsgLy8gU3VuayBkZWVwCiAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2ggPSBmaWVsZDsKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0ID0gbWF0OwogICAgfQoKZnVuY3Rpb24gY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpIHsKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQpsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgpmdW5jdGlvbiBzZXR1cElucHV0cygpIHsKICAgICAgICAvLyBTa2lwIEludHJvIExpc3RlbmVyCiAgICAgICAgY29uc3Qgc2tpcEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBza2lwSGFuZGxlcik7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBza2lwSGFuZGxlciwge3Bhc3NpdmU6IHRydWV9KTsKCiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQovLyBORVc6IFRhY2tsZS9TcHJpbnQgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zZTogU3ByaW50L0JyZWFrIChJbnN0YW50KQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2U6IFN0YXJ0IENoYXJnZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaXNUYWNrbGVDaGFyZ2luZyAmJiAhcC5pc1RhY2tsaW5nICYmICFwLmlzUmVjb3ZlcmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogRXZhZGUgb24gJ0UnCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdLZXlFJykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5ldmFkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IAogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSBmYWxzZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBORVc6IFJlbGVhc2UgVGFja2xlIG9uIFNoaWZ0IFVwCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiBwLmlzVGFja2xlQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOyAKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWxsKSBwLnRocm93QmFsbChiYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERFRkVOU0U6IEJsb2NrCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiAhcC5pc0Rhc2hpbmcgJiYgIXAuaXNFdmFkaW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwICYmIHAuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0QmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdEVuZC5jbGllbnRYLCB5OiB0RW5kLmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGUuY2xpZW50WCwgeTogZS5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICAvLyBBbmFseXplIFN3aXBlCiAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnZlRGF0YSA9IHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCB3YXMgYSB0YXAgKHNob3J0IGR1cmF0aW9uLCBsb3cgbW92ZW1lbnQpCiAgICAgICAgICAgICAgICBjb25zdCBpc1RhcCA9IChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPCAyMDApICYmIChNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSkgPCAyMCk7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gU1BJTiBDQUxDVUxBVElPTiAoSWYgY3VydmUgaXMgc3Ryb25nIGVub3VnaCkKICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIHx8IDAuMjUpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSB8fCAxMDAwLjApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBhbmFseXNpcy5zcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQIHx8IDE1MDAuMCksIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0b3BCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKICAgICAgICAvLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAovLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCiAgICAgICAgbGV0IGhvbGRUaW1lciA9IG51bGw7CiAgICAgICAgbGV0IGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgIGxldCBsYXN0VGFwVGltZSA9IDA7CiAgICAgICAgY29uc3QgSE9MRF9USFJFU0hPTEQgPSAyMDA7IC8vIG1zCiAgICAgICAgY29uc3QgRE9VQkxFX1RBUF9USFJFU0hPTEQgPSAzMDA7IC8vIG1zCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjbGllbnRYID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYOwogICAgICAgICAgICAgICAgY2xpZW50WSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgICAgICAvLyBSZXNldCBIb2xkIFN0YXRlCiAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIC8vIFN0YXJ0IEhvbGQgVGltZXIKICAgICAgICAgICAgaG9sZFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gT25seSBjaGFyZ2UgaWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCAoRGVmZW5zaXZlIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsgLy8gVmlzdWFsIGN1ZSBmb3IgY2hhcmdlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIEhPTERfVEhSRVNIT0xEKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgaWYgKGhvbGRUaW1lcikgY2xlYXJUaW1lb3V0KGhvbGRUaW1lcik7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIGlmIChpc0hvbGRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBIT0xEIFJFTEVBU0UgKENoYXJnZWQgVGFja2xlKSAtLS0KICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBUQVAgKFRhY2tsZSAvIEV2YWRlKSAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lU2luY2VMYXN0ID0gbm93IC0gbGFzdFRhcFRpbWU7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVTaW5jZUxhc3QgPCBET1VCTEVfVEFQX1RIUkVTSE9MRCkgewogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBET1VCTEUgVEFQOiBFVkFERSAtLS0KICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBjYW5jZWwgZGFzaCBpZiBhY3RpdmUgdG8gYWxsb3cgaW1tZWRpYXRlIGV2YWRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuZGFzaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHAuZXZhZGUoKTsKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IDA7IC8vIFJlc2V0IHRvIHByZXZlbnQgdHJpcGxlLXRhcCBpc3N1ZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFNJTkdMRSBUQVA6IFRBQ0tMRSAvIEJSRUFLIC0tLQogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2l2ZSBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFogPSBwLmlucHV0VmVjdG9yLno7CgovLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiBwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zaXZlIEJyZWFrIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IG5vdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIAogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChpc0hvbGRpbmcgfHwgaG9sZFRpbWVyKSBoYW5kbGVFbmQoZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7Cl9hdWRpb01hbmFnZXIuc2V0TWFzdGVyVm9sdW1lKHZvbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gRXhpdCB0byBNZW51CiAgICAgICAgY29uc3QgZXhpdEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGl0LXRvLW1lbnUtYnRuJyk7CiAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfbWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgICAgIC8vIEZvcmNlIGltbWVkaWF0ZSBjYW1lcmEgdXBkYXRlIHRvIHByZXZlbnQganVtcAogICAgICAgICAgICBpZiAoX2NhbWVyYU1hbmFnZXIpIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZSgwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3RyaWN0bHkgMC41MCBhcyByZXF1ZXN0ZWQgZm9yIHBlcmZvcm1hbmNlCi8vIFBlcmZvcm1hbmNlIE9wdGltaXphdGlvbjogQ2FwIHJlc29sdXRpb24KY29uc3QgbWF4RGltZW5zaW9uID0gNDgwOyAvLyBIYXJkIGNhcCBvbiBpbnRlcm5hbCByZW5kZXIgcmVzb2x1dGlvbiAoUmVkdWNlZCBmb3IgcGVyZm9ybWFuY2UpCiAgICAgICAgY29uc3QgY3VycmVudE1heCA9IE1hdGgubWF4KHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGxldCByZXNTY2FsZSA9IDAuNTA7IC8vIEJhc2Ugc2NhbGUKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudE1heCAqIHJlc1NjYWxlID4gbWF4RGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJlc1NjYWxlID0gbWF4RGltZW5zaW9uIC8gY3VycmVudE1heDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbFdpZHRoID0gTWF0aC5mbG9vcih3aWR0aCAqIHJlc1NjYWxlKTsKICAgICAgICBfY29uZmlnLmludGVybmFsSGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQgKiByZXNTY2FsZSk7CmlmIChfcmVuZGVyZXIpIHsKICAgICAgICAgICAgX3JlbmRlcmVyLnNldFNpemUoX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0LCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIF9wb3N0UHJvY2Vzc2luZy5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgfQogICAgfQoKLy8gLS0tIEZJWEVEIFRJTUVTVEVQIFZBUklBQkxFUyAtLS0KICAgIGxldCBfYWNjdW11bGF0b3IgPSAwOwogICAgY29uc3QgX2ZpeGVkU3RlcCA9IDEgLyA2MDsKCiAgICBmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmKSB7CiAgICAgICAgICAgIGNvbnN0IHBlcmYgPSB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmOwogICAgICAgICAgICBwZXJmLmZyYW1lID0gKHBlcmYuZnJhbWUgfHwgMCkgKyAxOwogICAgICAgICAgICBwZXJmLnJhd0R0ID0gcmF3RHQ7CiAgICAgICAgICAgIHBlcmYuZHQgPSBkdDsKICAgICAgICAgICAgY29uc3QgZnBzID0gZHQgPiAwID8gKDEgLyBkdCkgOiAwOwogICAgICAgICAgICBwZXJmLmZwcyA9IGZwczsKICAgICAgICAgICAgcGVyZi5hdmdGcHMgPSAocGVyZi5hdmdGcHMgJiYgcGVyZi5hdmdGcHMgPiAwKSA/IChwZXJmLmF2Z0ZwcyAqIDAuOSArIGZwcyAqIDAuMSkgOiBmcHM7CiAgICAgICAgfQoKICAgICAgICAvLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KQovLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KSAtIERpc2FibGVkCiAgICAgICAgLy8gaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7IC4uLiB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCmlmIChfYWNjdW11bGF0b3IgPiAwLjEpIF9hY2N1bXVsYXRvciA9IDAuMTsgLy8gQ2FwIGF0IDEwMG1zIHRvIHByZXZlbnQgc3BpcmFsIG9mIGRlYXRoCgogICAgICAgIHdoaWxlIChfYWNjdW11bGF0b3IgPj0gX2ZpeGVkU3RlcCkgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX2ZpeGVkU3RlcDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIF9hY2N1bXVsYXRvciA9IDA7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgICAgICAvLyBVcGRhdGUgRW50aXRpZXMgKFBoeXNpY3MvQUkpCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9hd2F5VGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwgJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYgogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSdW50aW1lIFVwZGF0ZXJzIChlLmcuIFJpbmdzIGxvZ2ljKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2FjY3VtdWxhdG9yIC09IF9maXhlZFN0ZXA7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVklTVUFMIFVQREFURSBMT09QIChPbmNlIFBlciBGcmFtZSkgLS0tCiAgICAgICAgLy8gVGhlc2Ugc3lzdGVtcyBkb24ndCBhZmZlY3QgZ2FtZXBsYXkgb3V0Y29tZSwgc28gd2UgdXBkYXRlIHRoZW0gd2l0aCB0aGUgdmlzdWFsIGRlbHRhIGBkdGAKICAgICAgICAvLyB0byBlbnN1cmUgc21vb3RoIGFuaW1hdGlvbiBhdCBoaWdoIHJlZnJlc2ggcmF0ZXMgKDkwLzEyMEh6KSB3aXRob3V0IHdhc3RpbmcgQ1BVIG9uIHBoeXNpY3MuCgogICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgIC8vIENhbWVyYQogICAgICAgIGlmICghaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KTsKICAgICAgICB9CgogICAgICAgIC8vIFZpc3VhbCBGWCBTeXN0ZW1zCiAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX3N0YWRpdW0pIF9zdGFkaXVtLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKCmlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIAogICAgICAgIC8vIEFyZW5hVGhlbWVNYW5hZ2VyIHVwZGF0ZWQgaW4gR2FtZU1hbmFnZXIudXBkYXRlKCkgKFBoeXNpY3MgTG9vcCkKLy8gQXJlbmFUaGVtZU1hbmFnZXIgdXBkYXRlZCBpbiBHYW1lTWFuYWdlci51cGRhdGUoKSAoUGh5c2ljcyBMb29wKQpfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogMy4wKTsgLy8gU2xvd2VyIGRlY2F5IGZvciB2aXNjb3VzIHN0cmV0Y2gKCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCi8vIFJlbmRlcgogICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgaWYgKF9wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEsIGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9Cgp9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHAuaXNCbG9ja2luZykgewogICAgICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQkxPQ0siKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkJMT0NLIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOyAvLyBFbnN1cmUgdmlzdWFsIGZlZWRiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiREVGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCmlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFbGVtZW50YWwgU3RhdHVzIG9uIEZ1bWJsZQogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ2ZpcmUnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ2J1cm4nLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICdpY2UnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3Nsb3cnLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd2b2x0JykgZW50aXR5LmFwcGx5U3RhdHVzKCdzaG9jaycsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ3Zlbm9tJykgZW50aXR5LmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd3aXRoZXInKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdDQScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICduYXAnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ25hcCcsIDUuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVudGl0eS5jYXRjaENvb2xkb3duID0gMS4wOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","/main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgovLyBFeHBvc2UgSW1wYWN0IFRyaWdnZXIKICAgIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCA9IGZ1bmN0aW9uKHBvcywgc3RyZW5ndGgpIHsKICAgICAgICAvLyBTbW9vdGhseSBtb3ZlIGltcGFjdCBjZW50ZXIgdG8gbmV3IHBvc2l0aW9uIChMaXF1aWQgZmVlbCkKICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0UG9zLnZhbHVlLmxlcnAocG9zLCAwLjMpOwogICAgICAgIC8vIFN1c3RhaW4gc3RyZW5ndGggKEFjY3VtdWxhdGUgbWF4IHRvIGhhbmRsZSBjb250aW51b3VzIHByZXNzdXJlKQogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBNYXRoLm1heChfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlLCBzdHJlbmd0aCAqIDIuNSk7CiAgICB9OwoKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwaHlzaWNzL2xvZ2ljCiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKCiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKICAgIGxldCBfcG9zdFByb2Nlc3Npbmc7CgogICAgbGV0IF9jYW1lcmFNYW5hZ2VyOwogICAgbGV0IF93YXRlck92ZXJsYXk7CiAgICBsZXQgX2xpZ2h0U2hhZnRzOwogICAgbGV0IF9zdGFkaXVtOwpsZXQgX2dseXBoTWFuYWdlcjsKICAgIGxldCBfYXJlbmFUaGVtZU1hbmFnZXI7IC8vIERlcHJlY2F0ZWQsIG5vdyBpbiBHYW1lTWFuYWdlcgogICAgLy8gSU1QUk9WRUQ6IFNldHRpbmdzIG9iamVjdAogICAgY29uc3QgX3NldHRpbmdzID0gewogICAgICAgIGpveXN0aWNrU2Vuc2l0aXZpdHk6IDEuMCwKICAgICAgICBhaW1Bc3Npc3Q6IHRydWUsCiAgICAgICAgY2FtZXJhU2hha2U6IHRydWUsCiAgICAgICAgaGl0U3RvcDogdHJ1ZSwKICAgICAgICBpbnZlcnRDYW1lcmE6IGZhbHNlLAogICAgICAgIGF1dG9SZWNlbnRlcjogdHJ1ZQogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDY1LCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTAsIDE1KTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7CiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCmVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyLCBlbnRpdGllczoge30sIHRlYW1zOiB7IGhvbWU6IG51bGwsIGF3YXk6IG51bGwgfSB9OyAvLyBUZW1wIGhvb2sKX2NvbnRhaW5lci5hcHBlbmRDaGlsZChfcmVuZGVyZXIuZG9tRWxlbWVudCk7CgovLyAtLS0gVmlkZW8gT3ZlcmxheSBFbmZvcmNlbWVudCAtLS0KICAgICAgICAvLyAtLS0gT3ZlcmxheSBWaWRlbyBMb2dpYyBSZW1vdmVkIChTd2l0Y2hlZCB0byBHSUYpIC0tLQogICAgICAgIC8vIDUuIEVudmlyb25tZW50CiAgICAgICAgY3JlYXRlUGFydGljbGVzKCk7CiAgICAgICAgY3JlYXRlQXJlbmEoKTsKICAgICAgICBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCk7Ci8vIDUuNSBHYW1lIE1hbmFnZXIKX2dhbWVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyKF9zY2VuZSwgJ3VpLWxheWVyJywgX2NhbWVyYSwgX3JlbmRlcmVyKTsKICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSBfZ2FtZU1hbmFnZXI7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7Cl9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjUuMiBQb3N0IFByb2Nlc3NpbmcKX3Bvc3RQcm9jZXNzaW5nID0gbmV3IHdpbmRvdy5mbHV4LlBvc3RQcm9jZXNzaW5nKF9yZW5kZXJlciwgX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0KTsKICAgICAgICBfcG9zdFByb2Nlc3NpbmcuZW5hYmxlZCA9IGZhbHNlOyAvLyBEaXNhYmxlZCBieSBkZWZhdWx0IGZvciBwZXJmb3JtYW5jZQogICAgICAgIF9nYW1lTWFuYWdlci5wb3N0UHJvY2Vzc2luZyA9IF9wb3N0UHJvY2Vzc2luZzsKCiAgICAgICAgLy8gNS42IENhbWVyYSBNYW5hZ2VyCiAgICAgICAgX2NhbWVyYU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlcihfY2FtZXJhLCBfc2NlbmUpOwogICAgICAgIF9nYW1lTWFuYWdlci5jYW1lcmFNYW5hZ2VyID0gX2NhbWVyYU1hbmFnZXI7CgogICAgICAgIC8vIDUuNyBEZXYgVG9vbHMKaWYgKHdpbmRvdy5mbHV4LkRldlRvb2xzKSB7CiAgICAgICAgICAgIG5ldyB3aW5kb3cuZmx1eC5EZXZUb29scyhfZ2FtZU1hbmFnZXIpOwogICAgICAgIH0KLy8gNS44IFdhdGVyIE92ZXJsYXksIExpZ2h0IFNoYWZ0cywgU3RhZGl1bSwgR2x5cGhzCiAgICAgICAgX3dhdGVyT3ZlcmxheSA9IG5ldyB3aW5kb3cuZmx1eC5XYXRlck92ZXJsYXkoX2NhbWVyYSk7CiAgICAgICAgX2xpZ2h0U2hhZnRzID0gbmV3IHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzKF9zY2VuZSk7CiAgICAgICAgX3N0YWRpdW0gPSBuZXcgd2luZG93LmZsdXguU3RhZGl1bShfc2NlbmUpOwogICAgICAgIF9nbHlwaE1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyKF9zY2VuZSk7CiAgICAgICAgCgpfYXJlbmFUaGVtZU1hbmFnZXIgPSBudWxsOyAvLyBIYW5kbGVkIGJ5IEdhbWVNYW5hZ2VyCiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwoKICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMTU7IC8vIFJlc3RvcmVkIENQVSBsZXZlbCBmb3IgY29tcGV0ZW5jZQogICAgICAgICAgICB3aW5kb3cuZmx1eC5UZWFtLmdlbmVyYXRlU3RhdHMocCwgcm9sZSwgdGVhbUxldmVsLCBpc0hvbWUpOwoKICAgICAgICAgICAgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgcC5zdGF0cy5TUCArPSAzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnV2Fra2EnKSkgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCArPSAzOwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnQnJvdGhlcicpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH07CgogICAgICAgIGxldCBob21lTG9hZGVkID0gMDsKICAgICAgICBjb25zdCByb2xlR2x0ZnMgPSB7fTsKCiAgICAgICAgY29uc3QgZmluYWxpemVUZWFtcyA9ICgpID0+IHsKICAgICAgICAgICAgcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGdsdGYgPSByb2xlR2x0ZnNbcm9sZV0gfHwgcm9sZUdsdGZzLkxGOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkgPyBgQ1BVICR7ZW50cnkubmFtZX1gIDogJ0NQVSc7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBpZiAoZ2x0ZiAmJiBnbHRmLnNjZW5lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNzaW5nIEdMVEYgZm9yIGF3YXkgcm9sZTonLCByb2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfYXdheVRlYW0uYWRkUGxheWVyKHApOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbLi4uX2hvbWVUZWFtLnBsYXllcnMsIC4uLl9hd2F5VGVhbS5wbGF5ZXJzXTsKICAgICAgICAgICAgYWxsUGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYgKHAuYmFsbFJlZiA9PT0gbnVsbCkgcC5iYWxsUmVmID0gX2JhbGw7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciA9IF9ob21lVGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMudGFja2xlID0gJ3Zlbm9tJzsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGVjaHMuc2hvb3QgPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcXVpcHBlZCBIb21lIE1GIHdpdGggVmVub20gVGFja2xlICYgU3BoZXJlIFNob3QnKTsKICAgICAgICAgICAgfQoKY29uc3QgYXdheU1GID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBXaXRoZXIgdGFja2xlIGZvciBBd2F5IE1GIHRvIHJlZHVjZSBkaWZmaWN1bHR5CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAvLyBSZW1vdmVkIGd1YXJhbnRlZWQgU3VwZXIgR29hbGllIGZvciBBd2F5IEdMIHRvIG1ha2Ugc2NvcmluZyBlYXNpZXIKCiAgICAgICAgICAgIF9ob21lVGVhbS5hc3NpZ25NYXJrcyhfYXdheVRlYW0pOwogICAgICAgICAgICBfYXdheVRlYW0uYXNzaWduTWFya3MoX2hvbWVUZWFtKTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnJlZ2lzdGVyVGVhbXMoX2hvbWVUZWFtLCBfYXdheVRlYW0sIF9iYWxsKTsKCiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguTWVudU1hbmFnZXIoX2dhbWVNYW5hZ2VyKTsKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKcm9sZXMuZm9yRWFjaChyb2xlID0+IHsKICAgICAgICAgICAgY29uc3QgZW50cnkgPSBob21lUm9zdGVyW3JvbGVdOwogICAgICAgICAgICBpZiAoIWVudHJ5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBvbkNvbXBsZXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaG9tZUxvYWRlZCsrOwogICAgICAgICAgICAgICAgaWYgKGhvbWVMb2FkZWQgPj0gcm9sZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxpemVUZWFtcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGVudHJ5LnVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IGdsdGY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICBwLnNldE1lc2goY2xvbmUsIGdsdGYuYW5pbWF0aW9ucyk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBtb2RlbCcsIGVudHJ5Lm5hbWUsIGVudHJ5LnVybCwgZXJyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgTWVzaCAoUmVkIEJveCkKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDEsIDIsIDEpOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZjAwMDAsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGZhbGxiYWNrR2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0b3JlIGR1bW15IGluIHJvbGVHbHRmcyBmb3IgYXdheSB0ZWFtIGNsb25pbmcKICAgICAgICAgICAgICAgIHJvbGVHbHRmc1tyb2xlXSA9IHsgc2NlbmU6IGZhbGxiYWNrTWVzaCwgYW5pbWF0aW9uczogW10gfTsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWUgKyAiIChFcnJvcikiOwogICAgICAgICAgICAgICAgYXBwbHlTdGF0cyhwLCByb2xlLCB0cnVlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGZhbGxiYWNrTWVzaC5jbG9uZSgpLCBbXSk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWRkUGxheWVyKHApOwoKICAgICAgICAgICAgICAgIG9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIDguIElucHV0CiAgICAgICAgc2V0dXBJbnB1dHMoKTsKCiAgICAgICAgLy8gOS4gTG9vcAogICAgICAgIF9jbG9jayA9IG5ldyBUSFJFRS5DbG9jaygpOwogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgLy8gSGFuZGxlIHJlc2l6ZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvblJlc2l6ZSk7CiAgICAgICAgb25SZXNpemUoKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZVBhcnRpY2xlcygpIHsKICAgICAgICBjb25zdCBjb3VudCA9IDIwMDsgLy8gT3B0aW1pemVkIGZvciBwZXJmb3JtYW5jZSAod2FzIDE1MDApCiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5qZWN0IEVsYXN0aWMgU2hhZGVyIGZvciBCYXNlIEFyZW5hCiAgICAgICAgbWF0ZXJpYWwub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSBfYXJlbmFVbmlmb3Jtcy51VGltZTsKICAgICAgICAgICAgc2hhZGVyLnVuaWZvcm1zLnVJbXBhY3RTdHIgPSBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyOwogICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudUltcGFjdFBvcyA9IF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3M7CgogICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRWxhc3RpYyBCcmVhdGhpbmcgKEFtYmllbnQpCiAgICAgICAgICAgICAgICBmbG9hdCBicmVhdGggPSBzaW4ocG9zaXRpb24ueSAqIDAuMDggKyB1VGltZSAqIDEuMikgKiAxLjI7CiAgICAgICAgICAgICAgICBicmVhdGggKz0gc2luKHBvc2l0aW9uLnggKiAwLjA1ICsgdVRpbWUgKiAwLjgpICogMC44OwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogYnJlYXRoOwoKICAgICAgICAgICAgICAgIC8vIEltcGFjdCBSaXBwbGUgKFJlYWN0aXZlKQogICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGRpc3RhbmNlKHBvc2l0aW9uLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxNS4wKSAqIHVJbXBhY3RTdHIgKiAwLjg7CiAgICAgICAgICAgICAgICBmbG9hdCBtYXNrID0gc21vb3Roc3RlcCg0NS4wLCAwLjAsIGRpc3QpOwogICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogcmlwcGxlICogbWFzazsKICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgKTsKICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICBjb25zdCBhcmVuYSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gMi4gSW5uZXIgSGV4IEdyaWQgKFdhcnAgRWZmZWN0KSAtLS0KICAgICAgICAvLyBSZXVzZSBleGlzdGluZyBoZXggZ2VuZXJhdGlvbiBsb2dpYyBidXQgYXR0YWNoIHRvIGdyb3VwCiAgICAgICAgY29uc3QgaGV4VGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgY29uc3QgciA9IDY0OwogICAgICAgICAgICBjb25zdCB3ID0gciAqIDI7CiAgICAgICAgICAgIGNvbnN0IGggPSBNYXRoLnNxcnQoMykgKiByOwogICAgICAgICAgICBmb3IobGV0IHkgPSAtMTsgeSA8IDUxMi9oICsgMjsgeSsrKSB7CiAgICAgICAgICAgICAgICBmb3IobGV0IHggPSAtMTsgeCA8IDUxMi8odyowLjc1KSArIDI7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN4ID0geCAqIHcgKiAwLjc1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0geSAqIGggKyAoeCUyPT09MCA/IDAgOiBoLzIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nID0gTWF0aC5QSS8zICogaTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGFuZykqciwgY3kgKyBNYXRoLnNpbihhbmcpKnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGhleFRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGhleFRleC5yZXBlYXQuc2V0KDQsIDIpOwoKICAgICAgICBjb25zdCBhcmVuYVVuaWZvcm1zID0gVEhSRUUuVW5pZm9ybXNVdGlscy5tZXJnZShbCiAgICAgICAgICAgIFRIUkVFLlVuaWZvcm1zTGliWydjb21tb24nXSwKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICB0TWFwOiB7IHZhbHVlOiBoZXhUZXggfSwKICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjEgfSAKICAgICAgICAgICAgfQogICAgICAgIF0pOwoKICAgICAgICBjb25zdCBtYXRlcmlhbDIgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gdmVjMyB1SW1wYWN0UG9zOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgSmVsbHkgV29iYmxlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgd29iYmxlID0gc2luKHBvcy55ICogMC4xICsgdVRpbWUgKiAyLjApICogMS41OwogICAgICAgICAgICAgICAgICAgIHdvYmJsZSArPSBjb3MocG9zLnogKiAwLjEgKyB1VGltZSAqIDEuNSkgKiAxLjU7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICBwb3MgKz0gbm9ybWFsICogd29iYmxlOwoKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgRGlzdG9ydGlvbgogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBkaXN0YW5jZShwb3MsIHVJbXBhY3RQb3MpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJhZGl1cyA9IDM1LjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTbW9vdGggY3ViaWMgZmFsbG9mZiBmb3Igb3JnYW5pYyBidWxnZQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVsZ2UgPSBidWxnZSAqIGJ1bGdlICogKDMuMCAtIDIuMCAqIGJ1bGdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJpcHBsZSBlZmZlY3QgKENvbmNlbnRyaWMgd2F2ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbihkaXN0ICogMC44IC0gdVRpbWUgKiAxMi4wKSAqIDAuMjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIGZyZXF1ZW5jeSBqaXR0ZXIgKFRlbnNpb24vRW5lcmd5KQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBqaXR0ZXIgPSBzaW4ocG9zLnggKiAzLjAgKyB1VGltZSAqIDIwLjApICogc2luKHBvcy55ICogMy4wICsgdVRpbWUgKiAxNS4wKSAqIDAuMDg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBkaXN0b3J0aW9uOiBCdWxnZSBvdXQgKyBSaXBwbGVzICsgSml0dGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyArPSBub3JtYWwgKiAoKGJ1bGdlICsgcmlwcGxlICogYnVsZ2UgKyBqaXR0ZXIgKiBidWxnZSkgKiB1SW1wYWN0U3RyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXhDb2xvciA9IHRleHR1cmUyRCh0TWFwLCB2VXYpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAzOyAKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjIsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcmVuYTIpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgPSBhcmVuYTI7CiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CmNvbnN0IGEgPSBpeSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGIgPSBpeSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSAoaXkgKyAxKSAqIHJvdyArIGl4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSAoaXkgKyAxKSAqIHJvdyArIChpeCArIDEpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChhLCBjLCBiKTsKICAgICAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYiwgYywgZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBnZW8uc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUocG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ25vcm1hbCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG5vcm1hbHMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh1dnMsIDIpKTsKICAgICAgICAgICAgZ2VvLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5NZXNoKGdlbywgYXJyb3dNYXQpOwogICAgICAgIH07CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQXJyb3dzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIG51bUFycm93cykgKiBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIC8vIFVwcGVyIGFycm93IHN0cmlwIChhYm92ZSBiYW5kKQogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIGFycm93SGVpZ2h0ICogMC41ICsgMiwgZmFsc2UpKTsKCiAgICAgICAgICAgIC8vIExvd2VyIGFycm93IHN0cmlwIChiZWxvdyBiYW5kKSAtIGZsaXAgViBzbyBhcnJvd3MgcG9pbnQgZG93bndhcmQKICAgICAgICAgICAgYXJyb3dHcm91cC5hZGQobWFrZUN1cnZlZFN0cmlwKGFuZ2xlLCAtYXJyb3dIZWlnaHQgKiAwLjUgLSAyLCB0cnVlKSk7CiAgICAgICAgfQoKICAgICAgICBfc2NlbmUuYWRkKGFycm93R3JvdXApOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzIGZvciBEZXZUb29scwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93R3JvdXAgPSBhcnJvd0dyb3VwOwogICAgICAgIHdpbmRvdy5mbHV4LmFycm93TWF0ID0gYXJyb3dNYXQ7CgogICAgICAgIC8vIC0tLSA1LiBUT1AgR0xZUEhTIChEb21lKSAtLS0gKERvbWUpIC0tLQogICAgICAgIGNvbnN0IHRvcEdseXBoVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gNTEyOyBjLmhlaWdodCA9IDUxMjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw1MTIsNTEyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuNSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKDI1NiwgMjU2LCAyMDAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEludHJpY2F0ZSBwYXR0ZXJuCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYSA9IChpLzgpKk1hdGguUEkqMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAyNTYgKyBNYXRoLmNvcyhhKSoxNTA7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gMjU2ICsgTWF0aC5zaW4oYSkqMTUwOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmFyYyh4LCB5LCA0MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIC8vIENvbm5lY3RvcgogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygyNTYsIDI1Nik7Ci8vIENvbm5lY3RvcgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwoKICAgICAgICBjb25zdCB0b3BHbHlwaE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgIG1hcDogdG9wR2x5cGhUZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjQsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICBjb25zdCB0b3BHbHlwaEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDYwLCA2MCk7CiAgICAgICAgY29uc3QgdG9wR2x5cGggPSBuZXcgVEhSRUUuTWVzaCh0b3BHbHlwaEdlbywgdG9wR2x5cGhNYXQpOwogICAgICAgIHRvcEdseXBoLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgdG9wR2x5cGgucG9zaXRpb24ueSA9IDM1OyAvLyBOZWFyIHRvcCBvZiBkb21lCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodG9wR2x5cGgpOwoKICAgICAgICAvLyAtLS0gTkVXOiBGRlggR09BTCBNT0RFTFMgLS0tCiAgICAgICAgY29uc3QgZ29hbFVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJzsKICAgICAgICAKY29uc3Qgb25Hb2FsTG9hZGVkID0gKG1vZGVsLCBpc0ZhbGxiYWNrKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxBID0gbW9kZWw7CgogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFkgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgOiAtMTguMDsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxTY2FsZSA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSA6IDQ1LjA7CiAgICAgICAgICAgIGNvbnN0IHN4ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1gpICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWCA6IDEuMDsKICAgICAgICAgICAgY29uc3Qgc3kgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfU0NBTEVfWSkgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9ZIDogMS4wOwogICAgICAgICAgICBjb25zdCBzeiA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRV9aKSAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogOiAxLjA7CiAgICAgICAgICAgIApnb2FsQS5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIC1nb2FsRGlzdCk7CiAgICAgICAgICAgIGlmICghaXNGYWxsYmFjaykgewogICAgICAgICAgICAgICAgZ29hbEEuc2NhbGUuc2V0KGdvYWxTY2FsZSAqIHN4LCBnb2FsU2NhbGUgKiBzeSwgZ29hbFNjYWxlICogc3opOyAKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEEKICAgICAgICAgICAgZ29hbEEudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nCiAgICAgICAgICAgICAgICAgICAgYy5yZW5kZXJPcmRlciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1hdGVyaWFsIGlzIHZpc2libGUgYW5kIHVuaXF1ZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwgPSBjLm1hdGVyaWFsLmNsb25lKCk7IC8vIENsb25lIGZvciBpbmRlcGVuZGVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQWRkIGdvYWxzIHRvIFNDRU5FLCBub3QgYXJlbmFHcm91cCAodGhleSBzaG91bGRuJ3Qgcm90YXRlIHdpdGggdGhlIHNwaGVyZSkKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxBID0gZ29hbEE7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7Cgpnb2FsQi5wb3NpdGlvbi5zZXQoMCwgZ29hbFksIGdvYWxEaXN0KTsKaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQi5zY2FsZS5zZXQoZ29hbFNjYWxlICogc3gsIGdvYWxTY2FsZSAqIHN5LCBnb2FsU2NhbGUgKiBzeik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQgYW5kIGhhdmUgdW5pcXVlIG1hdGVyaWFscwogICAgICAgICAgICBnb2FsQi50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgYWdhaW4gZm9yIEIKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2FsQiA9IGdvYWxCOyAvLyBFeHBvc2UgZm9yIERldlRvb2xzCiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICAvLyBMb2FkIGZsb29yIGdseXBoIGZyb20gaW1hZ2UKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IHRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy92OENSODVkUS9GbG9vcmdseXBoLnBuZycpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjM1LAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgZmllbGQgPSBuZXcgVEhSRUUuTWVzaChnZW8sIG1hdCk7CiAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICBmaWVsZC5wb3NpdGlvbi55ID0gLTguMDsgLy8gU3VuayBkZWVwCiAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2ggPSBmaWVsZDsKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0ID0gbWF0OwogICAgfQoKZnVuY3Rpb24gY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpIHsKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQpsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgpmdW5jdGlvbiBzZXR1cElucHV0cygpIHsKICAgICAgICAvLyBTa2lwIEludHJvIExpc3RlbmVyCiAgICAgICAgY29uc3Qgc2tpcEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBza2lwSGFuZGxlcik7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBza2lwSGFuZGxlciwge3Bhc3NpdmU6IHRydWV9KTsKCiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQovLyBORVc6IFRhY2tsZS9TcHJpbnQgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zZTogU3ByaW50L0JyZWFrIChJbnN0YW50KQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2U6IFN0YXJ0IENoYXJnZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaXNUYWNrbGVDaGFyZ2luZyAmJiAhcC5pc1RhY2tsaW5nICYmICFwLmlzUmVjb3ZlcmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogRXZhZGUgb24gJ0UnCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdLZXlFJykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5ldmFkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IAogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSBmYWxzZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBORVc6IFJlbGVhc2UgVGFja2xlIG9uIFNoaWZ0IFVwCiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiBwLmlzVGFja2xlQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOyAKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWxsKSBwLnRocm93QmFsbChiYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERFRkVOU0U6IEJsb2NrCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCAmJiAhcC5pc0Rhc2hpbmcgJiYgIXAuaXNFdmFkaW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwICYmIHAuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0QmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdEVuZC5jbGllbnRYLCB5OiB0RW5kLmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGUuY2xpZW50WCwgeTogZS5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICAvLyBBbmFseXplIFN3aXBlCiAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnZlRGF0YSA9IHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCB3YXMgYSB0YXAgKHNob3J0IGR1cmF0aW9uLCBsb3cgbW92ZW1lbnQpCiAgICAgICAgICAgICAgICBjb25zdCBpc1RhcCA9IChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPCAyMDApICYmIChNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSkgPCAyMCk7CiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gU1BJTiBDQUxDVUxBVElPTiAoSWYgY3VydmUgaXMgc3Ryb25nIGVub3VnaCkKICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIHx8IDAuMjUpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSB8fCAxMDAwLjApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBhbmFseXNpcy5zcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oKFRDLkNVUlZFX1NQSU5fQ0FQIHx8IDE1MDAuMCksIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBhbmFseXNpcy5pbnRlbnNpdHksIHNwZWVkOiBhbmFseXNpcy5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlzQmxvY2tpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwLnN0b3BCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKICAgICAgICAvLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwpoYW5kbGVBaW1FbmQoKTsKaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAovLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCiAgICAgICAgbGV0IGhvbGRUaW1lciA9IG51bGw7CiAgICAgICAgbGV0IGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgIGxldCBsYXN0VGFwVGltZSA9IDA7CiAgICAgICAgY29uc3QgSE9MRF9USFJFU0hPTEQgPSAyMDA7IC8vIG1zCiAgICAgICAgY29uc3QgRE9VQkxFX1RBUF9USFJFU0hPTEQgPSAzMDA7IC8vIG1zCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2s6IElucHV0IFJpcHBsZQogICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjbGllbnRYID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYOwogICAgICAgICAgICAgICAgY2xpZW50WSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgICAgICAvLyBSZXNldCBIb2xkIFN0YXRlCiAgICAgICAgICAgIGlzSG9sZGluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaG9sZFRpbWVyKSBjbGVhclRpbWVvdXQoaG9sZFRpbWVyKTsKCiAgICAgICAgICAgIC8vIFN0YXJ0IEhvbGQgVGltZXIKICAgICAgICAgICAgaG9sZFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gT25seSBjaGFyZ2UgaWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCAoRGVmZW5zaXZlIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydFRhY2tsZUNoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsgLy8gVmlzdWFsIGN1ZSBmb3IgY2hhcmdlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIEhPTERfVEhSRVNIT0xEKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgaWYgKGhvbGRUaW1lcikgY2xlYXJUaW1lb3V0KGhvbGRUaW1lcik7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CiAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgIGlmIChpc0hvbGRpbmcpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBIT0xEIFJFTEVBU0UgKENoYXJnZWQgVGFja2xlKSAtLS0KICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlVGFja2xlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpc0hvbGRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBUQVAgKFRhY2tsZSAvIEV2YWRlKSAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lU2luY2VMYXN0ID0gbm93IC0gbGFzdFRhcFRpbWU7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVTaW5jZUxhc3QgPCBET1VCTEVfVEFQX1RIUkVTSE9MRCkgewogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBET1VCTEUgVEFQOiBFVkFERSAtLS0KICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBjYW5jZWwgZGFzaCBpZiBhY3RpdmUgdG8gYWxsb3cgaW1tZWRpYXRlIGV2YWRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuZGFzaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHAuZXZhZGUoKTsKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IDA7IC8vIFJlc2V0IHRvIHByZXZlbnQgdHJpcGxlLXRhcCBpc3N1ZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFNJTkdMRSBUQVA6IFRBQ0tMRSAvIEJSRUFLIC0tLQogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuc2l2ZSBUYWNrbGUKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFogPSBwLmlucHV0VmVjdG9yLno7CgovLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiBwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2ZmZW5zaXZlIEJyZWFrIFRhY2tsZQogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsYXN0VGFwVGltZSA9IG5vdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIAogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChpc0hvbGRpbmcgfHwgaG9sZFRpbWVyKSBoYW5kbGVFbmQoZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7Cl9hdWRpb01hbmFnZXIuc2V0TWFzdGVyVm9sdW1lKHZvbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gRXhpdCB0byBNZW51CiAgICAgICAgY29uc3QgZXhpdEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGl0LXRvLW1lbnUtYnRuJyk7CiAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfbWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgICAgIC8vIEZvcmNlIGltbWVkaWF0ZSBjYW1lcmEgdXBkYXRlIHRvIHByZXZlbnQganVtcAogICAgICAgICAgICBpZiAoX2NhbWVyYU1hbmFnZXIpIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZSgwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3RyaWN0bHkgMC41MCBhcyByZXF1ZXN0ZWQgZm9yIHBlcmZvcm1hbmNlCi8vIFBlcmZvcm1hbmNlIE9wdGltaXphdGlvbjogQ2FwIHJlc29sdXRpb24KY29uc3QgbWF4RGltZW5zaW9uID0gNDgwOyAvLyBIYXJkIGNhcCBvbiBpbnRlcm5hbCByZW5kZXIgcmVzb2x1dGlvbiAoUmVkdWNlZCBmb3IgcGVyZm9ybWFuY2UpCiAgICAgICAgY29uc3QgY3VycmVudE1heCA9IE1hdGgubWF4KHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGxldCByZXNTY2FsZSA9IDAuNTA7IC8vIEJhc2Ugc2NhbGUKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudE1heCAqIHJlc1NjYWxlID4gbWF4RGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJlc1NjYWxlID0gbWF4RGltZW5zaW9uIC8gY3VycmVudE1heDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbFdpZHRoID0gTWF0aC5mbG9vcih3aWR0aCAqIHJlc1NjYWxlKTsKICAgICAgICBfY29uZmlnLmludGVybmFsSGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQgKiByZXNTY2FsZSk7CmlmIChfcmVuZGVyZXIpIHsKICAgICAgICAgICAgX3JlbmRlcmVyLnNldFNpemUoX2NvbmZpZy5pbnRlcm5hbFdpZHRoLCBfY29uZmlnLmludGVybmFsSGVpZ2h0LCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChfcG9zdFByb2Nlc3NpbmcpIF9wb3N0UHJvY2Vzc2luZy5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCk7CiAgICAgICAgfQogICAgfQoKLy8gLS0tIEZJWEVEIFRJTUVTVEVQIFZBUklBQkxFUyAtLS0KICAgIGxldCBfYWNjdW11bGF0b3IgPSAwOwogICAgY29uc3QgX2ZpeGVkU3RlcCA9IDEgLyA2MDsKCiAgICBmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmKSB7CiAgICAgICAgICAgIGNvbnN0IHBlcmYgPSB3aW5kb3cuZmx1eC5fZGVidWdJTy5wZXJmOwogICAgICAgICAgICBwZXJmLmZyYW1lID0gKHBlcmYuZnJhbWUgfHwgMCkgKyAxOwogICAgICAgICAgICBwZXJmLnJhd0R0ID0gcmF3RHQ7CiAgICAgICAgICAgIHBlcmYuZHQgPSBkdDsKICAgICAgICAgICAgY29uc3QgZnBzID0gZHQgPiAwID8gKDEgLyBkdCkgOiAwOwogICAgICAgICAgICBwZXJmLmZwcyA9IGZwczsKICAgICAgICAgICAgcGVyZi5hdmdGcHMgPSAocGVyZi5hdmdGcHMgJiYgcGVyZi5hdmdGcHMgPiAwKSA/IChwZXJmLmF2Z0ZwcyAqIDAuOSArIGZwcyAqIDAuMSkgOiBmcHM7CiAgICAgICAgfQoKICAgICAgICAvLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KQovLyBJbXBhY3QgRnJhbWVzIChGcmVlemUgRnJhbWUgRWZmZWN0KSAtIERpc2FibGVkCiAgICAgICAgLy8gaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7IC4uLiB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCmlmIChfYWNjdW11bGF0b3IgPiAwLjEpIF9hY2N1bXVsYXRvciA9IDAuMTsgLy8gQ2FwIGF0IDEwMG1zIHRvIHByZXZlbnQgc3BpcmFsIG9mIGRlYXRoCgogICAgICAgIHdoaWxlIChfYWNjdW11bGF0b3IgPj0gX2ZpeGVkU3RlcCkgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX2ZpeGVkU3RlcDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIF9hY2N1bXVsYXRvciA9IDA7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgICAgIGNvbnN0IGlzSW50cm8gPSBnbVN0YXRlID09PSAnaW50cm8nOwogICAgICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgICAgICAvLyBVcGRhdGUgRW50aXRpZXMgKFBoeXNpY3MvQUkpCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9hd2F5VGVhbSAmJiAhaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwgJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYgogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSdW50aW1lIFVwZGF0ZXJzIChlLmcuIFJpbmdzIGxvZ2ljKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2FjY3VtdWxhdG9yIC09IF9maXhlZFN0ZXA7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVklTVUFMIFVQREFURSBMT09QIChPbmNlIFBlciBGcmFtZSkgLS0tCiAgICAgICAgLy8gVGhlc2Ugc3lzdGVtcyBkb24ndCBhZmZlY3QgZ2FtZXBsYXkgb3V0Y29tZSwgc28gd2UgdXBkYXRlIHRoZW0gd2l0aCB0aGUgdmlzdWFsIGRlbHRhIGBkdGAKICAgICAgICAvLyB0byBlbnN1cmUgc21vb3RoIGFuaW1hdGlvbiBhdCBoaWdoIHJlZnJlc2ggcmF0ZXMgKDkwLzEyMEh6KSB3aXRob3V0IHdhc3RpbmcgQ1BVIG9uIHBoeXNpY3MuCgogICAgICAgIGNvbnN0IGdtU3RhdGUgPSBfZ2FtZU1hbmFnZXIgPyBfZ2FtZU1hbmFnZXIuc3RhdGUgOiAnJzsKICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICBjb25zdCBpc01lbnUgPSBnbVN0YXRlID09PSAnbWVudSc7CgogICAgICAgIC8vIENhbWVyYQogICAgICAgIGlmICghaXNJbnRybyAmJiAhaXNNZW51KSB7CiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KTsKICAgICAgICB9CgogICAgICAgIC8vIFZpc3VhbCBGWCBTeXN0ZW1zCiAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICBpZiAoX3N0YWRpdW0pIF9zdGFkaXVtLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKGR0KTsKCmlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgX2dhbWVNYW5hZ2VyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIAogICAgICAgIC8vIEFyZW5hVGhlbWVNYW5hZ2VyIHVwZGF0ZWQgaW4gR2FtZU1hbmFnZXIudXBkYXRlKCkgKFBoeXNpY3MgTG9vcCkKLy8gQXJlbmFUaGVtZU1hbmFnZXIgdXBkYXRlZCBpbiBHYW1lTWFuYWdlci51cGRhdGUoKSAoUGh5c2ljcyBMb29wKQpfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIGR0ICogMy4wKTsgLy8gU2xvd2VyIGRlY2F5IGZvciB2aXNjb3VzIHN0cmV0Y2gKCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCi8vIFJlbmRlcgogICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgaWYgKF9wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgX3Bvc3RQcm9jZXNzaW5nLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEsIGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9Cgp9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHAuaXNCbG9ja2luZykgewogICAgICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQkxPQ0siKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkJMT0NLIjsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOyAvLyBFbnN1cmUgdmlzdWFsIGZlZWRiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiREVGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCmlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBcHBseSBFbGVtZW50YWwgU3RhdHVzIG9uIEZ1bWJsZQogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ2ZpcmUnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ2J1cm4nLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICdpY2UnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3Nsb3cnLCA1LjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd2b2x0JykgZW50aXR5LmFwcGx5U3RhdHVzKCdzaG9jaycsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoX2JhbGwuZWxlbWVudCA9PT0gJ3Zlbm9tJykgZW50aXR5LmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICd3aXRoZXInKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdDQScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9iYWxsLmVsZW1lbnQgPT09ICduYXAnKSBlbnRpdHkuYXBwbHlTdGF0dXMoJ25hcCcsIDUuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERlZmxlY3Qgc2xpZ2h0bHkgYnV0IGtlZXAgbW92aW5nIGZhc3QgKEJsYXN0IFRocm91Z2gpCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzdG9wIGl0IGNvbXBsZXRlbHkgbGlrZSBhIGJsb2NrLCBqdXN0IHBlcnR1cmIgaXQKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuODUpOyAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnkgKz0gKE1hdGgucmFuZG9tKCkpICogNS4wOyAvLyBQb3AgdXAKICAgICAgICAgICAgICAgIF9iYWxsLnZlbG9jaXR5LnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JhbGwucG93ZXIgKj0gMC43OwoKICAgICAgICAgICAgICAgIGVudGl0eS5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gU3R1biBicmllZmx5CiAgICAgICAgICAgICAgICBlbnRpdHkuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgaWYoZW50aXR5LnBsYXkpIGVudGl0eS5wbGF5KCdyZWFjdCcsIDAuMSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVudGl0eS5jYXRjaENvb2xkb3duID0gMS4wOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIEdsb2JhbCBQaHlzaWNzCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBHUkFWSVRZOiAwLjAsIC8vIERlZmF1bHQgMCAoTmV1dHJhbCBidW95YW5jeSkKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBXYXRlciByZXNpc3RhbmNlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQsCiAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgIE1BR05VU19DQVA6IDYwLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIERlcHRoIGNvbnN0cmFpbnQKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLAogICAgICAgIERFUFRIX1NQUklORzogMSwKICAgICAgICBERVBUSF9EQU1QOiAxLjUsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIEJPVU5EQVJZX1JBRElVUzogNDYsCiAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAyMCwKICAgICAgICAKICAgICAgICAvLyBHb2FsIFNldHRpbmdzCiAgICAgICAgR09BTF9ESVNUQU5DRTogNDEuNSwKICAgICAgICBHT0FMX1lfT0ZGU0VUOiAtMi4zMSwKICAgICAgICBHT0FMX1NDQUxFOiA0NSwKICAgICAgICBHT0FMX1NDQUxFX1g6IDEuMzQ1NiwKICAgICAgICBHT0FMX1NDQUxFX1k6IDEsCiAgICAgICAgR09BTF9TQ0FMRV9aOiAxLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgVHJpZ2dlciAoSGl0Ym94KQogICAgICAgIEdPQUxfVFJJR0dFUl9UT1BfWTogOS4xNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9CT1RUT01fWTogLTQuMzU1NSwKICAgICAgICBHT0FMX1RSSUdHRVJfV0lEVEg6IDE3LjEsCiAgICAgICAgR09BTF9UUklHR0VSX09GRlNFVDogMSwKCiAgICAgICAgLy8gR29hbCBQb2NrZXQKICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLAogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLAogICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNTUsCgogICAgICAgIC8vIFdhbGxzCiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMywKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLAogICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zLAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40LAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFRocm93IG1hcHBpbmcKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMSwKICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NQogICAgfTsKCgogICAgCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsgLy8gTG9jYWwgYWxpYXMgZm9yIGJyZXZpdHkKICAgIC8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQogICAgY2xhc3MgVHJhaWxSZW5kZXJlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gMzA7IC8vIE1vcmUgc2VnbWVudHMgZm9yIHNtb290aGVyIGN1cnZlcwogICAgICAgICAgICB0aGlzLnBvaW50cyA9IFtdOwp0aGlzLmJhc2VXaWR0aCA9IDAuODsgLy8gSW5jcmVhc2VkIHdpZHRoIGZvciB2aXNpYmlsaXR5CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoID0gMC44OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgcG9zRGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5zZWdtZW50cyAqIDIgKiAzKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUocG9zRGF0YSwgMykpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5kaWNlcwogICAgICAgICAgICBjb25zdCBpbmRpY2VzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzLTE7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYmFzZSA9IGkqMjsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlLCBiYXNlKzEsIGJhc2UrMik7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSsxLCBiYXNlKzMsIGJhc2UrMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cnkuc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwYWFmZiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOSwgLy8gSW5jcmVhc2VkIG9wYWNpdHkKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgdGhpcy5tYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0IHBvaW50cwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzLnB1c2gobmV3IFRIUkVFLlZlY3RvcjMoKSk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXVzYWJsZSB0ZW1wcyAoYXZvaWQgcGVyLWZyYW1lIGFsbG9jYXRpb25zIG9uIG1vYmlsZSkKICAgICAgICAgICAgdGhpcy5fdG1wRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wVG9DYW0gPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBSaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KHBvcykgewogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzW2ldLmNvcHkocG9zKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzZXRDb2xvcihoZXgpIHsKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoaGV4KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlKGN1cnJlbnRQb3MsIHNwZWVkUmF0aW8gPSAwLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXNldChjdXJyZW50UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gRHluYW1pYyBXaWR0aCBiYXNlZCBvbiBzcGVlZCBBTkQgU1BJTiAoUG93ZXIgVmlzdWFsKQogICAgICAgICAgICAvLyBGYXN0IGJhbGwgPSBUaGlja2VyLiBTcGlubmluZyBiYWxsID0gRXZlbiBUaGlja2VyLgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBjb25zdCBzcGluUmF0aW8gPSBiYWxsID8gTWF0aC5taW4oMS4wLCBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKSAvIDMwLjApIDogMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFdpZHRoID0gdGhpcy5iYXNlV2lkdGggKiAoMC44ICsgc3BlZWRSYXRpbyAqIDEuMiArIHNwaW5SYXRpbyAqIDIuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoICs9ICh0YXJnZXRXaWR0aCAtIHRoaXMuY3VycmVudFdpZHRoKSAqIDAuMjsgLy8gU21vb3RoIHRyYW5zaXRpb24KCiAgICAgICAgICAgIC8vIFNoaWZ0IHBvaW50cwogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zZWdtZW50cyAtIDE7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRzW2ldLmNvcHkodGhpcy5wb2ludHNbaS0xXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wb2ludHNbMF0uY29weShjdXJyZW50UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR2VvbWV0cnkoKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBjb25zdCBjYW0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFjYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgY2FtUG9zID0gY2FtLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCB0ZW1wRGlyID0gdGhpcy5fdG1wRGlyOwogICAgICAgICAgICBjb25zdCB0ZW1wVG9DYW0gPSB0aGlzLl90bXBUb0NhbTsKICAgICAgICAgICAgY29uc3QgdGVtcFJpZ2h0ID0gdGhpcy5fdG1wUmlnaHQ7CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBvaW50c1tpXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFwZXIgd2lkdGggYWxvbmcgdHJhaWwgbGVuZ3RoCiAgICAgICAgICAgICAgICBjb25zdCB0YXBlciA9IDEuMCAtIE1hdGgucG93KGkgLyB0aGlzLnNlZ21lbnRzLCAyKTsgLy8gUXVhZHJhdGljIHRhcGVyCiAgICAgICAgICAgICAgICBjb25zdCB3ID0gdGhpcy5jdXJyZW50V2lkdGggKiB0YXBlcjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgaWYgKGkgPCB0aGlzLnNlZ21lbnRzIC0gMSkgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpXSwgdGhpcy5wb2ludHNbaSsxXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpLTFdLCB0aGlzLnBvaW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZW1wRGlyLmxlbmd0aFNxKCkgPCAwLjAwMDEpIHRlbXBEaXIuc2V0KDAsIDEsIDApOwogICAgICAgICAgICAgICAgdGVtcERpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGVtcFRvQ2FtLnN1YlZlY3RvcnMoY2FtUG9zLCBwKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRlbXBSaWdodC5jcm9zc1ZlY3RvcnModGVtcERpciwgdGVtcFRvQ2FtKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAxCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMF0gPSBwLnggLSB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAxXSA9IHAueSAtIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDJdID0gcC56IC0gdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMgogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDNdID0gcC54ICsgdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNF0gPSBwLnkgKyB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA1XSA9IHAueiArIHRlbXBSaWdodC56OwogICAgICAgICAgICB9CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgLy8gQyBpcyBhbHJlYWR5IGRlZmluZWQgaW4gdGhlIG91dGVyIHNjb3BlCiAgICBjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmV4dGVybmFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsgLy8gRW52aXJvbm1lbnRhbCBmb3JjZXMgKEN1cnJlbnRzLCBHcmF2aXR5IG92ZXJyaWRlcykKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdmcmVlJzsgLy8gJ2ZyZWUnLCAnaGVsZCcsICdtYWduZXRpemVkJwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CnRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyID0gMDsKICAgICAgICAgICAgLy8gQ29udGludW91cyBTdGF0cwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsgICAgICAvLyBDdXJyZW50IFBBIG9yIFNIIHZhbHVlCiAgICAgICAgICAgIHRoaXMucG93ZXJUeXBlID0gJ25vbmUnOyAvLyAnUEEnIG9yICdTSCcKICAgICAgICAgICAgdGhpcy5kZWNheVJhdGUgPSAzLjA7IC8vIFN0YXQgcG9pbnRzIGxvc3QgcGVyIHNlY29uZCAoV2F0ZXIgcmVzaXN0YW5jZSkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsgLy8gVGltZSBiZWZvcmUgYmFsbCBjYW4gYmUgY2F1Z2h0IGFnYWluCgogICAgICAgICAgICAvLyBNYWduZXQgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSAwLjI7IAogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBWaXN1YWxzIChTcXVhc2ggJiBTdHJldGNoKQogICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24gPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG51bGw7Cgp0aGlzLmluaXRNZXNoKCk7CnRoaXMudHJhaWwgPSBuZXcgVHJhaWxSZW5kZXJlcihzY2VuZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsc2FmZSBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwp9CgogICAgICAgIGluaXRNZXNoKCkgewogICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggKFBvcykgLT4gRGVmb3JtIChTcXVhc2gvU3RyZXRjaCkgLT4gU3BpbiAoUm90YXRpb24pIC0+IE1vZGVsCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwoKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC4zLCAxNiwgMTYpOyAvLyBTY2FsZWQgZG93biB+MTUlCiAgICAgICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIG1hcDogcGxhY2Vob2xkZXJUZXgsCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYsIAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiBmYWxzZSwgLy8gU29saWQKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiBmYWxzZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CgogICAgICAgICAgICAvLyBMb2FkIEdMQiBNb2RlbAogICAgICAgICAgICBjb25zdCB1cmwgPSAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzUyMWFlODc4OGU1ODRlMzc4YTc5ZDk3MzJhMDc1MzU2LmdsYic7CiAgICAgICAgICAgIAogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwodXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkRFQlVHOiBCYWxsIEdMQiBsb2FkZWQuIiwgZ2x0Zik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gZ2x0Zi5zY2VuZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBSZXNldCByb290IHRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgICAgIG1vZGVsLnVwZGF0ZU1hdHJpeFdvcmxkKHRydWUpOwoKICAgICAgICAgICAgICAgIC8vIDIuIEhhcmRlbiBNYXRlcmlhbHMgJiBWaXNpYmlsaXR5CiAgICAgICAgICAgICAgICBtb2RlbC50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nIGlmIGJvdW5kcyBhcmUgb2ZmCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0cyA9IEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkgPyBub2RlLm1hdGVyaWFsIDogW25vZGUubWF0ZXJpYWxdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmplY3QgSmVsbHkgV29iYmxlIFNoYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0ub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyID0gc2hhZGVyOyAvLyBTdG9yZSByZWZlcmVuY2UgdG8gdXBkYXRlIHRpbWUgbGF0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB3b2JibGUgPSBzaW4ocG9zaXRpb24ueSAqIDQuMCArIHVUaW1lICogMTUuMCkgKiAwLjA2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29iYmxlICs9IGNvcyhwb3NpdGlvbi54ICogNC4wICsgdVRpbWUgKiAxMi4wKSAqIDAuMDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b2JibGUgKz0gc2luKHBvc2l0aW9uLnogKiA0LjAgKyB1VGltZSAqIDEwLjApICogMC4wNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogd29iYmxlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIDMuIENvbXB1dGUgQm91bmRpbmcgQm94CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpOwogICAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0U2l6ZShzaXplKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0Q2VudGVyKGNlbnRlcik7CgogICAgICAgICAgICAgICAgLy8gNC4gVmFsaWRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgoc2l6ZS54LCBzaXplLnksIHNpemUueik7CiAgICAgICAgICAgICAgICBpZiAobWF4RGltIDw9IDAuMDAxIHx8ICFpc0Zpbml0ZShtYXhEaW0pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIG1vZGVsIGhhcyBpbnZhbGlkIGRpbWVuc2lvbnMuIEtlZXBpbmcgcGxhY2Vob2xkZXIuIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA1LiBDYWxjdWxhdGUgU2NhbGUKLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTaGFkZXIgVGltZSBmb3IgSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmlzTWVzaCAmJiBjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShjLm1hdGVyaWFsKSA/IGMubWF0ZXJpYWwgOiBbYy5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0udXNlckRhdGEuc2hhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyLnVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1hZ25ldGl6ZSh0YXJnZXQpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIG1vdmVkIHRvIGVuZCBvZiBmdW5jdGlvbgoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIEdyYXZpdHkgKEdsb2JhbCBPdmVycmlkZSkKICAgICAgICAgICAgICAgIGNvbnN0IGdyYXZpdHkgPSAoQy5HUkFWSVRZICE9PSB1bmRlZmluZWQgPyBDLkdSQVZJVFkgOiAwLjApOwogICAgICAgICAgICAgICAgaWYgKGdyYXZpdHkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gZ3Jhdml0eSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBFeHRlcm5hbCBFbnZpcm9ubWVudGFsIEZvcmNlIChDdXJyZW50cywgVmVudHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5leHRlcm5hbEZvcmNlLmxlbmd0aFNxKCkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKHRoaXMuZXh0ZXJuYWxGb3JjZSwgc3RlcER0KTsKICAgICAgICAgICAgICAgIH0KCi8vIEgpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIHNjb3BlCn0gLy8gRW5kIG9mIHN1YnN0ZXAgbG9vcAogICAgICAgIH0KCgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKCiAgICAgICAgICAgIC8vIC0tLSBFTEVNRU5UQUwgVFJBSUxTIC0tLQogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50ICYmIHNwZWVkU3EgPiA1LjApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnRhbFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChwbSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBwb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEppdHRlcgogICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBTY2FsZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBJbnRlcnZhbCA9IDAuMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQgPT09ICdmaXJlJykgeyBwVHlwZSA9ICdmaXJlJzsgcFNjYWxlID0gMC44OyBwSW50ZXJ2YWwgPSAwLjA1OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ljZScpIHsgcFR5cGUgPSAnaWNlJzsgcFNjYWxlID0gMC42OyBwSW50ZXJ2YWwgPSAwLjA4OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ3ZvbHQnKSB7IHBUeXBlID0gJ3ZvbHQnOyBwU2NhbGUgPSAwLjc7IHBJbnRlcnZhbCA9IDAuMDQ7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSB7IHBUeXBlID0gJ3Zlbm9tJzsgcFNjYWxlID0gMC40OyBwSW50ZXJ2YWwgPSAwLjE7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAnd2l0aGVyJykgeyBwVHlwZSA9ICd3aXRoZXInOyBwU2NhbGUgPSAwLjU7IHBJbnRlcnZhbCA9IDAuMTsgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSB7IHBUeXBlID0gJ25hcCc7IHBTY2FsZSA9IDAuNDsgcEludGVydmFsID0gMC4xNTsgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bihwVHlwZSwgcG9zLCB7IHNjYWxlOiBwU2NhbGUsIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuMikgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50YWxUaW1lciA9IHBJbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgUkVBQ1RJT04gVE8gRVhURVJOQUwgRk9SQ0VTIChDdXJyZW50cykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmV4dGVybmFsRm9yY2UubGVuZ3RoU3EoKSA+IDUuMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKHBtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMi4wOwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIG1vdmluZyB3aXRoIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHBvcywgewogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjEsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy5leHRlcm5hbEZvcmNlLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMi4wKSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg4OGZmZmYKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIFN0cmF5IGNvZGUgYmxvY2sgcmVtb3ZlZAoKZ3JhYihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQ6IFBvc3Nlc3Npb24gKGlmIHRha2luZyBmcm9tIGZyZWUgc3RhdGUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJQT1NTRVNTSU9OIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgVHVybm92ZXIgKFBvc3Nlc3Npb24gQ2hhbmdlKQogICAgICAgICAgICBjb25zdCBwcmV2aW91c1RlYW0gPSB0aGlzLmhvbGRlciA/IHRoaXMuaG9sZGVyLnRlYW0gOiAodGhpcy5sYXN0SG9sZGVyID8gdGhpcy5sYXN0SG9sZGVyLnRlYW0gOiBudWxsKTsKICAgICAgICAgICAgaWYgKHByZXZpb3VzVGVhbSAmJiBwcmV2aW91c1RlYW0gIT09IHBsYXllci50ZWFtKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRVUk5PVkVSIiwgcGxheWVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBzb21lb25lIGVsc2UgaGVsZCBpdCwgdGhleSBsb3NlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlciAhPT0gcGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhvbGRlciA9IHBsYXllcjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5PVEU6IFdlIGRvIE5PVCBwYXJlbnQgdGhlIG1lc2ggdG8gdGhlIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSBiYWxsIGZyb20gZmx5aW5nIGFyb3VuZCBkdWUgdG8gc3dpbSBhbmltYXRpb25zLgogICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSB1cGRhdGUgaXRzIHBvc2l0aW9uIG1hbnVhbGx5IGluIHVwZGF0ZUhlbGQoKS4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHBsYXllci5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgcGxheWVyLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJCYWxsIGdyYWJiZWQgYnkgIiArIHBsYXllci5yb2xlKTsKICAgICAgICB9CgogICAgICAgIGRyb3AoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IC8vIEVuc3VyZSB2aXNpYmxlCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBObyBuZWVkIHRvIGRldGFjaCBmcm9tIHNjZW5lIGdyYXBoIHNpbmNlIHdlIGFyZW4ndCBwYXJlbnRpbmcgdG8gcGxheWVyIGFueW1vcmUuCiAgICAgICAgICAgIC8vIEp1c3QgY2xlYXIgaG9sZGVyLgoKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIubG9zZUJhbGwpIHRoaXMuaG9sZGVyLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7CiAgICAgICAgfQovLyBTaG9vdC9QYXNzCi8vIFNob290L1Bhc3MKICAgICAgICBzaG9vdChkaXJlY3Rpb25WZWN0b3IsIGZvcmNlLCB0eXBlID0gJ1NIJywgdGVjaG5pcXVlID0gbnVsbCwgc3BpblZlY3RvciA9IG51bGwpIHsKCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICB0aGlzLmlzUmljb2NoZXQgPSAodHlwZSA9PT0gJ1JJQ09DSEVUJyB8fCAodGVjaG5pcXVlICYmIHRlY2huaXF1ZS50eXBlID09PSAncmljb2NoZXQnKSk7CiAgICAgICAgICAgIHRoaXMuaG9taW5nVGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuZHJvcCgpOyAvLyBEZXRhY2ggZmlyc3QKCi8vIFNldCBHcmFjZSBQZXJpb2QgdG8gcHJldmVudCBpbnN0YW50IGludGVyY2VwdGlvbnMvY2F0Y2hlcwogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CnRoaXMucG93ZXJUeXBlID0gdHlwZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERldGVybWluZSBFbGVtZW50CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUuZWxlbWVudCkgdGhpcy5lbGVtZW50ID0gdGVjaG5pcXVlLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChbJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCddLmluY2x1ZGVzKHRlY2huaXF1ZS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IHRlY2huaXF1ZS50eXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ZpcmUnKSBjb2xvciA9IDB4ZmY0NDAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICdpY2UnKSBjb2xvciA9IDB4YWFkZGZmOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd2b2x0JykgY29sb3IgPSAweGZmZmYwMDsKICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSBjb2xvciA9IDB4MDBmZjAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgpyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxGb3JjZS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc2V0RXh0ZXJuYWxGb3JjZSh2ZWMpIHsKICAgICAgICAgICAgdGhpcy5leHRlcm5hbEZvcmNlLmNvcHkodmVjKTsKICAgICAgICB9CgogICAgICAgIGlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKCl91cGRhdGVWaXN1YWxUcmFuc2Zvcm1zKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzcGVlZCA+IDEuMCAmJiB0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3F1YXNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uaWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEFwcGx5IEFjY3VtdWxhdGVkIFNwaW4KICAgICAgICAgICAgY29uc3QgaW52RGVmb3JtID0gdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uY2xvbmUoKS5pbnZlcnQoKTsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5xdWF0ZXJuaW9uLmNvcHkoaW52RGVmb3JtLm11bHRpcGx5KHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbikpOwoKICAgICAgICAgICAgLy8gMy4gVmlzdWFsIHJvdGF0aW9uIGludGVncmF0aW9uCiAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGluU3BlZWQgPSBNYXRoLnNxcnQoc3BpblNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF4aXMgPSBfdGVtcFZlYy5jb3B5KHRoaXMuYW5ndWxhclZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLnByZW11bHRpcGx5KHEpOwogICAgICAgICAgICB9IGVsc2UgewppZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tGYWlsc2FmZXMoZHQpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBtYXhSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgfHwgNDYuMCkgKyAxNS4wOyAvLyBHZW5lcm91cyBidWZmZXIKICAgICAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gKEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjApICsgMTUuMDsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcG9zLngqcG9zLnggKyBwb3Mueipwb3MuejsKCiAgICAgICAgICAgIC8vIDEuIE91dCBvZiBCb3VuZHMgQ2hlY2sKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IG1heFJhZGl1cyptYXhSYWRpdXMgfHwgTWF0aC5hYnMocG9zLnkpID4gbWF4SGVpZ2h0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRPZkJvdW5kc1RpbWVyID4gMS4wKSB7IC8vIDEgc2Vjb25kIE9PQgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBPT0IgZGV0ZWN0ZWQuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vdXRPZkJvdW5kc1RpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU3R1Y2sgQ2hlY2sgKEZyZWUgJiBTdGF0aW9uYXJ5KQogICAgICAgICAgICAvLyBPbmx5IGNoZWNrIGlmIGdhbWUgaXMgYWN0aXZlIHRvIGF2b2lkIHJlc2V0dGluZyBkdXJpbmcgY3V0c2NlbmVzL21lbnVzCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjA1KSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gNC4wKSB7IC8vIDQgc2Vjb25kcyBzdGF0aW9uYXJ5CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIHN0dWNrIHN0YXRpb25hcnkuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yY2VSZXNldFRvUGxheSgpIHsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwoKICAgICAgICAgICAgLy8gRmluZCBuZWFyZXN0IHBsYXllciB0byByZXNldCB0bwogICAgICAgICAgICBsZXQgbmVhcmVzdCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtaW5Ec3QgPSBJbmZpbml0eTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgbGV0IHRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOyAvLyBEZWZhdWx0IGNlbnRlcgoKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50ZWFtcy5hd2F5KSBhbGxQbGF5ZXJzLnB1c2goLi4uZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5Ec3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWFyZXN0ID0gcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobmVhcmVzdCAmJiBuZWFyZXN0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBwbGF5ZXIgaXMgd2l0aGluIHJlYXNvbmFibGUgYm91bmRzIGJlZm9yZSB0ZWxlcG9ydGluZyBiYWxsIHRvIHRoZW0KICAgICAgICAgICAgICAgIGNvbnN0IHBQb3MgPSBuZWFyZXN0Lm1lc2gucG9zaXRpb247CmlmIChwUG9zLmxlbmd0aFNxKCkgPCA2MCo2MCkgeyAvLyBXaXRoaW4gNjBtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihuZWFyZXN0Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmNvcHkocFBvcykuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigyLjApKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSA9IE1hdGgubWF4KDAsIHBQb3MueSArIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQp9CiAgICB9CndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","./Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIEdsb2JhbCBQaHlzaWNzCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBHUkFWSVRZOiAwLjAsIC8vIERlZmF1bHQgMCAoTmV1dHJhbCBidW95YW5jeSkKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBXYXRlciByZXNpc3RhbmNlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQsCiAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgIE1BR05VU19DQVA6IDYwLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIERlcHRoIGNvbnN0cmFpbnQKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLAogICAgICAgIERFUFRIX1NQUklORzogMSwKICAgICAgICBERVBUSF9EQU1QOiAxLjUsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIEJPVU5EQVJZX1JBRElVUzogNDYsCiAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAyMCwKICAgICAgICAKICAgICAgICAvLyBHb2FsIFNldHRpbmdzCiAgICAgICAgR09BTF9ESVNUQU5DRTogNDEuNSwKICAgICAgICBHT0FMX1lfT0ZGU0VUOiAtMi4zMSwKICAgICAgICBHT0FMX1NDQUxFOiA0NSwKICAgICAgICBHT0FMX1NDQUxFX1g6IDEuMzQ1NiwKICAgICAgICBHT0FMX1NDQUxFX1k6IDEsCiAgICAgICAgR09BTF9TQ0FMRV9aOiAxLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgVHJpZ2dlciAoSGl0Ym94KQogICAgICAgIEdPQUxfVFJJR0dFUl9UT1BfWTogOS4xNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9CT1RUT01fWTogLTQuMzU1NSwKICAgICAgICBHT0FMX1RSSUdHRVJfV0lEVEg6IDE3LjEsCiAgICAgICAgR09BTF9UUklHR0VSX09GRlNFVDogMSwKCiAgICAgICAgLy8gR29hbCBQb2NrZXQKICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLAogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLAogICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNTUsCgogICAgICAgIC8vIFdhbGxzCiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMywKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLAogICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zLAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40LAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFRocm93IG1hcHBpbmcKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMSwKICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NQogICAgfTsKCgogICAgCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsgLy8gTG9jYWwgYWxpYXMgZm9yIGJyZXZpdHkKICAgIC8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQogICAgY2xhc3MgVHJhaWxSZW5kZXJlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gMzA7IC8vIE1vcmUgc2VnbWVudHMgZm9yIHNtb290aGVyIGN1cnZlcwogICAgICAgICAgICB0aGlzLnBvaW50cyA9IFtdOwp0aGlzLmJhc2VXaWR0aCA9IDAuODsgLy8gSW5jcmVhc2VkIHdpZHRoIGZvciB2aXNpYmlsaXR5CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoID0gMC44OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgcG9zRGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5zZWdtZW50cyAqIDIgKiAzKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUocG9zRGF0YSwgMykpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5kaWNlcwogICAgICAgICAgICBjb25zdCBpbmRpY2VzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzLTE7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYmFzZSA9IGkqMjsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlLCBiYXNlKzEsIGJhc2UrMik7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSsxLCBiYXNlKzMsIGJhc2UrMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cnkuc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwYWFmZiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOSwgLy8gSW5jcmVhc2VkIG9wYWNpdHkKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgdGhpcy5tYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0IHBvaW50cwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzLnB1c2gobmV3IFRIUkVFLlZlY3RvcjMoKSk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXVzYWJsZSB0ZW1wcyAoYXZvaWQgcGVyLWZyYW1lIGFsbG9jYXRpb25zIG9uIG1vYmlsZSkKICAgICAgICAgICAgdGhpcy5fdG1wRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wVG9DYW0gPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBSaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KHBvcykgewogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzW2ldLmNvcHkocG9zKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzZXRDb2xvcihoZXgpIHsKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoaGV4KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlKGN1cnJlbnRQb3MsIHNwZWVkUmF0aW8gPSAwLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXNldChjdXJyZW50UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gRHluYW1pYyBXaWR0aCBiYXNlZCBvbiBzcGVlZCBBTkQgU1BJTiAoUG93ZXIgVmlzdWFsKQogICAgICAgICAgICAvLyBGYXN0IGJhbGwgPSBUaGlja2VyLiBTcGlubmluZyBiYWxsID0gRXZlbiBUaGlja2VyLgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBjb25zdCBzcGluUmF0aW8gPSBiYWxsID8gTWF0aC5taW4oMS4wLCBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKSAvIDMwLjApIDogMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFdpZHRoID0gdGhpcy5iYXNlV2lkdGggKiAoMC44ICsgc3BlZWRSYXRpbyAqIDEuMiArIHNwaW5SYXRpbyAqIDIuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoICs9ICh0YXJnZXRXaWR0aCAtIHRoaXMuY3VycmVudFdpZHRoKSAqIDAuMjsgLy8gU21vb3RoIHRyYW5zaXRpb24KCiAgICAgICAgICAgIC8vIFNoaWZ0IHBvaW50cwogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zZWdtZW50cyAtIDE7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRzW2ldLmNvcHkodGhpcy5wb2ludHNbaS0xXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wb2ludHNbMF0uY29weShjdXJyZW50UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR2VvbWV0cnkoKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBjb25zdCBjYW0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFjYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgY2FtUG9zID0gY2FtLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCB0ZW1wRGlyID0gdGhpcy5fdG1wRGlyOwogICAgICAgICAgICBjb25zdCB0ZW1wVG9DYW0gPSB0aGlzLl90bXBUb0NhbTsKICAgICAgICAgICAgY29uc3QgdGVtcFJpZ2h0ID0gdGhpcy5fdG1wUmlnaHQ7CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBvaW50c1tpXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFwZXIgd2lkdGggYWxvbmcgdHJhaWwgbGVuZ3RoCiAgICAgICAgICAgICAgICBjb25zdCB0YXBlciA9IDEuMCAtIE1hdGgucG93KGkgLyB0aGlzLnNlZ21lbnRzLCAyKTsgLy8gUXVhZHJhdGljIHRhcGVyCiAgICAgICAgICAgICAgICBjb25zdCB3ID0gdGhpcy5jdXJyZW50V2lkdGggKiB0YXBlcjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgaWYgKGkgPCB0aGlzLnNlZ21lbnRzIC0gMSkgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpXSwgdGhpcy5wb2ludHNbaSsxXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpLTFdLCB0aGlzLnBvaW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZW1wRGlyLmxlbmd0aFNxKCkgPCAwLjAwMDEpIHRlbXBEaXIuc2V0KDAsIDEsIDApOwogICAgICAgICAgICAgICAgdGVtcERpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGVtcFRvQ2FtLnN1YlZlY3RvcnMoY2FtUG9zLCBwKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRlbXBSaWdodC5jcm9zc1ZlY3RvcnModGVtcERpciwgdGVtcFRvQ2FtKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAxCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMF0gPSBwLnggLSB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAxXSA9IHAueSAtIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDJdID0gcC56IC0gdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMgogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDNdID0gcC54ICsgdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNF0gPSBwLnkgKyB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA1XSA9IHAueiArIHRlbXBSaWdodC56OwogICAgICAgICAgICB9CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgLy8gQyBpcyBhbHJlYWR5IGRlZmluZWQgaW4gdGhlIG91dGVyIHNjb3BlCiAgICBjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmV4dGVybmFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsgLy8gRW52aXJvbm1lbnRhbCBmb3JjZXMgKEN1cnJlbnRzLCBHcmF2aXR5IG92ZXJyaWRlcykKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdmcmVlJzsgLy8gJ2ZyZWUnLCAnaGVsZCcsICdtYWduZXRpemVkJwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CnRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyID0gMDsKICAgICAgICAgICAgLy8gQ29udGludW91cyBTdGF0cwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsgICAgICAvLyBDdXJyZW50IFBBIG9yIFNIIHZhbHVlCiAgICAgICAgICAgIHRoaXMucG93ZXJUeXBlID0gJ25vbmUnOyAvLyAnUEEnIG9yICdTSCcKICAgICAgICAgICAgdGhpcy5kZWNheVJhdGUgPSAzLjA7IC8vIFN0YXQgcG9pbnRzIGxvc3QgcGVyIHNlY29uZCAoV2F0ZXIgcmVzaXN0YW5jZSkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsgLy8gVGltZSBiZWZvcmUgYmFsbCBjYW4gYmUgY2F1Z2h0IGFnYWluCgogICAgICAgICAgICAvLyBNYWduZXQgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSAwLjI7IAogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBWaXN1YWxzIChTcXVhc2ggJiBTdHJldGNoKQogICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24gPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG51bGw7Cgp0aGlzLmluaXRNZXNoKCk7CnRoaXMudHJhaWwgPSBuZXcgVHJhaWxSZW5kZXJlcihzY2VuZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsc2FmZSBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwp9CgogICAgICAgIGluaXRNZXNoKCkgewogICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggKFBvcykgLT4gRGVmb3JtIChTcXVhc2gvU3RyZXRjaCkgLT4gU3BpbiAoUm90YXRpb24pIC0+IE1vZGVsCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwoKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC4zLCAxNiwgMTYpOyAvLyBTY2FsZWQgZG93biB+MTUlCiAgICAgICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIG1hcDogcGxhY2Vob2xkZXJUZXgsCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYsIAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiBmYWxzZSwgLy8gU29saWQKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiBmYWxzZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CgogICAgICAgICAgICAvLyBMb2FkIEdMQiBNb2RlbAogICAgICAgICAgICBjb25zdCB1cmwgPSAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzUyMWFlODc4OGU1ODRlMzc4YTc5ZDk3MzJhMDc1MzU2LmdsYic7CiAgICAgICAgICAgIAogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwodXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkRFQlVHOiBCYWxsIEdMQiBsb2FkZWQuIiwgZ2x0Zik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gZ2x0Zi5zY2VuZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBSZXNldCByb290IHRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgICAgIG1vZGVsLnVwZGF0ZU1hdHJpeFdvcmxkKHRydWUpOwoKICAgICAgICAgICAgICAgIC8vIDIuIEhhcmRlbiBNYXRlcmlhbHMgJiBWaXNpYmlsaXR5CiAgICAgICAgICAgICAgICBtb2RlbC50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nIGlmIGJvdW5kcyBhcmUgb2ZmCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0cyA9IEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkgPyBub2RlLm1hdGVyaWFsIDogW25vZGUubWF0ZXJpYWxdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmplY3QgSmVsbHkgV29iYmxlIFNoYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0ub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyID0gc2hhZGVyOyAvLyBTdG9yZSByZWZlcmVuY2UgdG8gdXBkYXRlIHRpbWUgbGF0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB3b2JibGUgPSBzaW4ocG9zaXRpb24ueSAqIDQuMCArIHVUaW1lICogMTUuMCkgKiAwLjA2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29iYmxlICs9IGNvcyhwb3NpdGlvbi54ICogNC4wICsgdVRpbWUgKiAxMi4wKSAqIDAuMDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b2JibGUgKz0gc2luKHBvc2l0aW9uLnogKiA0LjAgKyB1VGltZSAqIDEwLjApICogMC4wNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogd29iYmxlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIDMuIENvbXB1dGUgQm91bmRpbmcgQm94CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpOwogICAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0U2l6ZShzaXplKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0Q2VudGVyKGNlbnRlcik7CgogICAgICAgICAgICAgICAgLy8gNC4gVmFsaWRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgoc2l6ZS54LCBzaXplLnksIHNpemUueik7CiAgICAgICAgICAgICAgICBpZiAobWF4RGltIDw9IDAuMDAxIHx8ICFpc0Zpbml0ZShtYXhEaW0pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIG1vZGVsIGhhcyBpbnZhbGlkIGRpbWVuc2lvbnMuIEtlZXBpbmcgcGxhY2Vob2xkZXIuIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA1LiBDYWxjdWxhdGUgU2NhbGUKLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTaGFkZXIgVGltZSBmb3IgSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmlzTWVzaCAmJiBjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShjLm1hdGVyaWFsKSA/IGMubWF0ZXJpYWwgOiBbYy5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0udXNlckRhdGEuc2hhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyLnVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1hZ25ldGl6ZSh0YXJnZXQpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIG1vdmVkIHRvIGVuZCBvZiBmdW5jdGlvbgoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIEdyYXZpdHkgKEdsb2JhbCBPdmVycmlkZSkKICAgICAgICAgICAgICAgIGNvbnN0IGdyYXZpdHkgPSAoQy5HUkFWSVRZICE9PSB1bmRlZmluZWQgPyBDLkdSQVZJVFkgOiAwLjApOwogICAgICAgICAgICAgICAgaWYgKGdyYXZpdHkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gZ3Jhdml0eSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBFeHRlcm5hbCBFbnZpcm9ubWVudGFsIEZvcmNlIChDdXJyZW50cywgVmVudHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5leHRlcm5hbEZvcmNlLmxlbmd0aFNxKCkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKHRoaXMuZXh0ZXJuYWxGb3JjZSwgc3RlcER0KTsKICAgICAgICAgICAgICAgIH0KCi8vIEgpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIHNjb3BlCn0gLy8gRW5kIG9mIHN1YnN0ZXAgbG9vcAogICAgICAgIH0KCgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKCiAgICAgICAgICAgIC8vIC0tLSBFTEVNRU5UQUwgVFJBSUxTIC0tLQogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50ICYmIHNwZWVkU3EgPiA1LjApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnRhbFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChwbSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBwb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEppdHRlcgogICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBTY2FsZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBJbnRlcnZhbCA9IDAuMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQgPT09ICdmaXJlJykgeyBwVHlwZSA9ICdmaXJlJzsgcFNjYWxlID0gMC44OyBwSW50ZXJ2YWwgPSAwLjA1OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ljZScpIHsgcFR5cGUgPSAnaWNlJzsgcFNjYWxlID0gMC42OyBwSW50ZXJ2YWwgPSAwLjA4OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ3ZvbHQnKSB7IHBUeXBlID0gJ3ZvbHQnOyBwU2NhbGUgPSAwLjc7IHBJbnRlcnZhbCA9IDAuMDQ7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSB7IHBUeXBlID0gJ3Zlbm9tJzsgcFNjYWxlID0gMC40OyBwSW50ZXJ2YWwgPSAwLjE7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAnd2l0aGVyJykgeyBwVHlwZSA9ICd3aXRoZXInOyBwU2NhbGUgPSAwLjU7IHBJbnRlcnZhbCA9IDAuMTsgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSB7IHBUeXBlID0gJ25hcCc7IHBTY2FsZSA9IDAuNDsgcEludGVydmFsID0gMC4xNTsgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bihwVHlwZSwgcG9zLCB7IHNjYWxlOiBwU2NhbGUsIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuMikgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50YWxUaW1lciA9IHBJbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgUkVBQ1RJT04gVE8gRVhURVJOQUwgRk9SQ0VTIChDdXJyZW50cykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmV4dGVybmFsRm9yY2UubGVuZ3RoU3EoKSA+IDUuMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKHBtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMi4wOwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIG1vdmluZyB3aXRoIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHBvcywgewogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjEsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy5leHRlcm5hbEZvcmNlLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMi4wKSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg4OGZmZmYKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIFN0cmF5IGNvZGUgYmxvY2sgcmVtb3ZlZAoKZ3JhYihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQ6IFBvc3Nlc3Npb24gKGlmIHRha2luZyBmcm9tIGZyZWUgc3RhdGUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJQT1NTRVNTSU9OIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgVHVybm92ZXIgKFBvc3Nlc3Npb24gQ2hhbmdlKQogICAgICAgICAgICBjb25zdCBwcmV2aW91c1RlYW0gPSB0aGlzLmhvbGRlciA/IHRoaXMuaG9sZGVyLnRlYW0gOiAodGhpcy5sYXN0SG9sZGVyID8gdGhpcy5sYXN0SG9sZGVyLnRlYW0gOiBudWxsKTsKICAgICAgICAgICAgaWYgKHByZXZpb3VzVGVhbSAmJiBwcmV2aW91c1RlYW0gIT09IHBsYXllci50ZWFtKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRVUk5PVkVSIiwgcGxheWVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBzb21lb25lIGVsc2UgaGVsZCBpdCwgdGhleSBsb3NlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlciAhPT0gcGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhvbGRlciA9IHBsYXllcjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5PVEU6IFdlIGRvIE5PVCBwYXJlbnQgdGhlIG1lc2ggdG8gdGhlIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSBiYWxsIGZyb20gZmx5aW5nIGFyb3VuZCBkdWUgdG8gc3dpbSBhbmltYXRpb25zLgogICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSB1cGRhdGUgaXRzIHBvc2l0aW9uIG1hbnVhbGx5IGluIHVwZGF0ZUhlbGQoKS4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHBsYXllci5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgcGxheWVyLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJCYWxsIGdyYWJiZWQgYnkgIiArIHBsYXllci5yb2xlKTsKICAgICAgICB9CgogICAgICAgIGRyb3AoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IC8vIEVuc3VyZSB2aXNpYmxlCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBObyBuZWVkIHRvIGRldGFjaCBmcm9tIHNjZW5lIGdyYXBoIHNpbmNlIHdlIGFyZW4ndCBwYXJlbnRpbmcgdG8gcGxheWVyIGFueW1vcmUuCiAgICAgICAgICAgIC8vIEp1c3QgY2xlYXIgaG9sZGVyLgoKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIubG9zZUJhbGwpIHRoaXMuaG9sZGVyLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7CiAgICAgICAgfQovLyBTaG9vdC9QYXNzCi8vIFNob290L1Bhc3MKICAgICAgICBzaG9vdChkaXJlY3Rpb25WZWN0b3IsIGZvcmNlLCB0eXBlID0gJ1NIJywgdGVjaG5pcXVlID0gbnVsbCwgc3BpblZlY3RvciA9IG51bGwpIHsKCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICB0aGlzLmlzUmljb2NoZXQgPSAodHlwZSA9PT0gJ1JJQ09DSEVUJyB8fCAodGVjaG5pcXVlICYmIHRlY2huaXF1ZS50eXBlID09PSAncmljb2NoZXQnKSk7CiAgICAgICAgICAgIHRoaXMuaG9taW5nVGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuZHJvcCgpOyAvLyBEZXRhY2ggZmlyc3QKCi8vIFNldCBHcmFjZSBQZXJpb2QgdG8gcHJldmVudCBpbnN0YW50IGludGVyY2VwdGlvbnMvY2F0Y2hlcwogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CnRoaXMucG93ZXJUeXBlID0gdHlwZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERldGVybWluZSBFbGVtZW50CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUuZWxlbWVudCkgdGhpcy5lbGVtZW50ID0gdGVjaG5pcXVlLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChbJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCddLmluY2x1ZGVzKHRlY2huaXF1ZS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IHRlY2huaXF1ZS50eXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ZpcmUnKSBjb2xvciA9IDB4ZmY0NDAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICdpY2UnKSBjb2xvciA9IDB4YWFkZGZmOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd2b2x0JykgY29sb3IgPSAweGZmZmYwMDsKICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSBjb2xvciA9IDB4MDBmZjAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgpyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxGb3JjZS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc2V0RXh0ZXJuYWxGb3JjZSh2ZWMpIHsKICAgICAgICAgICAgdGhpcy5leHRlcm5hbEZvcmNlLmNvcHkodmVjKTsKICAgICAgICB9CgogICAgICAgIGlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKCl91cGRhdGVWaXN1YWxUcmFuc2Zvcm1zKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzcGVlZCA+IDEuMCAmJiB0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3F1YXNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uaWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEFwcGx5IEFjY3VtdWxhdGVkIFNwaW4KICAgICAgICAgICAgY29uc3QgaW52RGVmb3JtID0gdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uY2xvbmUoKS5pbnZlcnQoKTsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5xdWF0ZXJuaW9uLmNvcHkoaW52RGVmb3JtLm11bHRpcGx5KHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbikpOwoKICAgICAgICAgICAgLy8gMy4gVmlzdWFsIHJvdGF0aW9uIGludGVncmF0aW9uCiAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGluU3BlZWQgPSBNYXRoLnNxcnQoc3BpblNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF4aXMgPSBfdGVtcFZlYy5jb3B5KHRoaXMuYW5ndWxhclZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLnByZW11bHRpcGx5KHEpOwogICAgICAgICAgICB9IGVsc2UgewppZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tGYWlsc2FmZXMoZHQpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBtYXhSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgfHwgNDYuMCkgKyAxNS4wOyAvLyBHZW5lcm91cyBidWZmZXIKICAgICAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gKEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjApICsgMTUuMDsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcG9zLngqcG9zLnggKyBwb3Mueipwb3MuejsKCiAgICAgICAgICAgIC8vIDEuIE91dCBvZiBCb3VuZHMgQ2hlY2sKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IG1heFJhZGl1cyptYXhSYWRpdXMgfHwgTWF0aC5hYnMocG9zLnkpID4gbWF4SGVpZ2h0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRPZkJvdW5kc1RpbWVyID4gMS4wKSB7IC8vIDEgc2Vjb25kIE9PQgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBPT0IgZGV0ZWN0ZWQuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vdXRPZkJvdW5kc1RpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU3R1Y2sgQ2hlY2sgKEZyZWUgJiBTdGF0aW9uYXJ5KQogICAgICAgICAgICAvLyBPbmx5IGNoZWNrIGlmIGdhbWUgaXMgYWN0aXZlIHRvIGF2b2lkIHJlc2V0dGluZyBkdXJpbmcgY3V0c2NlbmVzL21lbnVzCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjA1KSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gNC4wKSB7IC8vIDQgc2Vjb25kcyBzdGF0aW9uYXJ5CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIHN0dWNrIHN0YXRpb25hcnkuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yY2VSZXNldFRvUGxheSgpIHsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwoKICAgICAgICAgICAgLy8gRmluZCBuZWFyZXN0IHBsYXllciB0byByZXNldCB0bwogICAgICAgICAgICBsZXQgbmVhcmVzdCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtaW5Ec3QgPSBJbmZpbml0eTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgbGV0IHRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOyAvLyBEZWZhdWx0IGNlbnRlcgoKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50ZWFtcy5hd2F5KSBhbGxQbGF5ZXJzLnB1c2goLi4uZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5Ec3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWFyZXN0ID0gcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobmVhcmVzdCAmJiBuZWFyZXN0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBwbGF5ZXIgaXMgd2l0aGluIHJlYXNvbmFibGUgYm91bmRzIGJlZm9yZSB0ZWxlcG9ydGluZyBiYWxsIHRvIHRoZW0KICAgICAgICAgICAgICAgIGNvbnN0IHBQb3MgPSBuZWFyZXN0Lm1lc2gucG9zaXRpb247CmlmIChwUG9zLmxlbmd0aFNxKCkgPCA2MCo2MCkgeyAvLyBXaXRoaW4gNjBtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihuZWFyZXN0Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmNvcHkocFBvcykuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigyLjApKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSA9IE1hdGgubWF4KDAsIHBQb3MueSArIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQp9CiAgICB9CndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","/Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIEdsb2JhbCBQaHlzaWNzCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBHUkFWSVRZOiAwLjAsIC8vIERlZmF1bHQgMCAoTmV1dHJhbCBidW95YW5jeSkKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBXYXRlciByZXNpc3RhbmNlCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQsCiAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgIE1BR05VU19DQVA6IDYwLAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIERlcHRoIGNvbnN0cmFpbnQKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLAogICAgICAgIERFUFRIX1NQUklORzogMSwKICAgICAgICBERVBUSF9EQU1QOiAxLjUsCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIEJPVU5EQVJZX1JBRElVUzogNDYsCiAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAyMCwKICAgICAgICAKICAgICAgICAvLyBHb2FsIFNldHRpbmdzCiAgICAgICAgR09BTF9ESVNUQU5DRTogNDEuNSwKICAgICAgICBHT0FMX1lfT0ZGU0VUOiAtMi4zMSwKICAgICAgICBHT0FMX1NDQUxFOiA0NSwKICAgICAgICBHT0FMX1NDQUxFX1g6IDEuMzQ1NiwKICAgICAgICBHT0FMX1NDQUxFX1k6IDEsCiAgICAgICAgR09BTF9TQ0FMRV9aOiAxLAogICAgICAgIAogICAgICAgIC8vIEdvYWwgVHJpZ2dlciAoSGl0Ym94KQogICAgICAgIEdPQUxfVFJJR0dFUl9UT1BfWTogOS4xNTU1LAogICAgICAgIEdPQUxfVFJJR0dFUl9CT1RUT01fWTogLTQuMzU1NSwKICAgICAgICBHT0FMX1RSSUdHRVJfV0lEVEg6IDE3LjEsCiAgICAgICAgR09BTF9UUklHR0VSX09GRlNFVDogMSwKCiAgICAgICAgLy8gR29hbCBQb2NrZXQKICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLAogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLAogICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNTUsCgogICAgICAgIC8vIFdhbGxzCiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMywKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLAogICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zLAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40LAoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFRocm93IG1hcHBpbmcKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMSwKICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NQogICAgfTsKCgogICAgCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsgLy8gTG9jYWwgYWxpYXMgZm9yIGJyZXZpdHkKICAgIC8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KLy8gLS0tIFRSQUlMIFJFTkRFUkVSIC0tLQogICAgY2xhc3MgVHJhaWxSZW5kZXJlciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnNlZ21lbnRzID0gMzA7IC8vIE1vcmUgc2VnbWVudHMgZm9yIHNtb290aGVyIGN1cnZlcwogICAgICAgICAgICB0aGlzLnBvaW50cyA9IFtdOwp0aGlzLmJhc2VXaWR0aCA9IDAuODsgLy8gSW5jcmVhc2VkIHdpZHRoIGZvciB2aXNpYmlsaXR5CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoID0gMC44OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VvbWV0cnkKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgcG9zRGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5zZWdtZW50cyAqIDIgKiAzKTsKICAgICAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUocG9zRGF0YSwgMykpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5kaWNlcwogICAgICAgICAgICBjb25zdCBpbmRpY2VzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzLTE7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYmFzZSA9IGkqMjsKICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiYXNlLCBiYXNlKzEsIGJhc2UrMik7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSsxLCBiYXNlKzMsIGJhc2UrMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cnkuc2V0SW5kZXgoaW5kaWNlcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwYWFmZiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOSwgLy8gSW5jcmVhc2VkIG9wYWNpdHkKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgdGhpcy5tYXRlcmlhbCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0IHBvaW50cwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzLnB1c2gobmV3IFRIUkVFLlZlY3RvcjMoKSk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXVzYWJsZSB0ZW1wcyAoYXZvaWQgcGVyLWZyYW1lIGFsbG9jYXRpb25zIG9uIG1vYmlsZSkKICAgICAgICAgICAgdGhpcy5fdG1wRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wVG9DYW0gPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLl90bXBSaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJlc2V0KHBvcykgewogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHRoaXMucG9pbnRzW2ldLmNvcHkocG9zKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVHZW9tZXRyeSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzZXRDb2xvcihoZXgpIHsKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoaGV4KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlKGN1cnJlbnRQb3MsIHNwZWVkUmF0aW8gPSAwLjApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXNldChjdXJyZW50UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gRHluYW1pYyBXaWR0aCBiYXNlZCBvbiBzcGVlZCBBTkQgU1BJTiAoUG93ZXIgVmlzdWFsKQogICAgICAgICAgICAvLyBGYXN0IGJhbGwgPSBUaGlja2VyLiBTcGlubmluZyBiYWxsID0gRXZlbiBUaGlja2VyLgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgICAgICBjb25zdCBzcGluUmF0aW8gPSBiYWxsID8gTWF0aC5taW4oMS4wLCBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKSAvIDMwLjApIDogMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFdpZHRoID0gdGhpcy5iYXNlV2lkdGggKiAoMC44ICsgc3BlZWRSYXRpbyAqIDEuMiArIHNwaW5SYXRpbyAqIDIuMCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFdpZHRoICs9ICh0YXJnZXRXaWR0aCAtIHRoaXMuY3VycmVudFdpZHRoKSAqIDAuMjsgLy8gU21vb3RoIHRyYW5zaXRpb24KCiAgICAgICAgICAgIC8vIFNoaWZ0IHBvaW50cwogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zZWdtZW50cyAtIDE7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRzW2ldLmNvcHkodGhpcy5wb2ludHNbaS0xXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wb2ludHNbMF0uY29weShjdXJyZW50UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR2VvbWV0cnkoKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBjb25zdCBjYW0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFjYW0pIHJldHVybjsKICAgICAgICAgICAgY29uc3QgY2FtUG9zID0gY2FtLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCB0ZW1wRGlyID0gdGhpcy5fdG1wRGlyOwogICAgICAgICAgICBjb25zdCB0ZW1wVG9DYW0gPSB0aGlzLl90bXBUb0NhbTsKICAgICAgICAgICAgY29uc3QgdGVtcFJpZ2h0ID0gdGhpcy5fdG1wUmlnaHQ7CiAgICAgICAgICAgIGZvciAobGV0IGk9MDsgaTx0aGlzLnNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBvaW50c1tpXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFwZXIgd2lkdGggYWxvbmcgdHJhaWwgbGVuZ3RoCiAgICAgICAgICAgICAgICBjb25zdCB0YXBlciA9IDEuMCAtIE1hdGgucG93KGkgLyB0aGlzLnNlZ21lbnRzLCAyKTsgLy8gUXVhZHJhdGljIHRhcGVyCiAgICAgICAgICAgICAgICBjb25zdCB3ID0gdGhpcy5jdXJyZW50V2lkdGggKiB0YXBlcjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgaWYgKGkgPCB0aGlzLnNlZ21lbnRzIC0gMSkgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpXSwgdGhpcy5wb2ludHNbaSsxXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBEaXIuc3ViVmVjdG9ycyh0aGlzLnBvaW50c1tpLTFdLCB0aGlzLnBvaW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZW1wRGlyLmxlbmd0aFNxKCkgPCAwLjAwMDEpIHRlbXBEaXIuc2V0KDAsIDEsIDApOwogICAgICAgICAgICAgICAgdGVtcERpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGVtcFRvQ2FtLnN1YlZlY3RvcnMoY2FtUG9zLCBwKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRlbXBSaWdodC5jcm9zc1ZlY3RvcnModGVtcERpciwgdGVtcFRvQ2FtKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih3KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVydCAxCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMF0gPSBwLnggLSB0ZW1wUmlnaHQueDsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAxXSA9IHAueSAtIHRlbXBSaWdodC55OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDJdID0gcC56IC0gdGVtcFJpZ2h0Lno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMgogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDNdID0gcC54ICsgdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNF0gPSBwLnkgKyB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyA1XSA9IHAueiArIHRlbXBSaWdodC56OwogICAgICAgICAgICB9CnRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgLy8gQyBpcyBhbHJlYWR5IGRlZmluZWQgaW4gdGhlIG91dGVyIHNjb3BlCiAgICBjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmV4dGVybmFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsgLy8gRW52aXJvbm1lbnRhbCBmb3JjZXMgKEN1cnJlbnRzLCBHcmF2aXR5IG92ZXJyaWRlcykKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdmcmVlJzsgLy8gJ2ZyZWUnLCAnaGVsZCcsICdtYWduZXRpemVkJwp0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CnRoaXMuaXNSaWNvY2hldCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyID0gMDsKICAgICAgICAgICAgLy8gQ29udGludW91cyBTdGF0cwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsgICAgICAvLyBDdXJyZW50IFBBIG9yIFNIIHZhbHVlCiAgICAgICAgICAgIHRoaXMucG93ZXJUeXBlID0gJ25vbmUnOyAvLyAnUEEnIG9yICdTSCcKICAgICAgICAgICAgdGhpcy5kZWNheVJhdGUgPSAzLjA7IC8vIFN0YXQgcG9pbnRzIGxvc3QgcGVyIHNlY29uZCAoV2F0ZXIgcmVzaXN0YW5jZSkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsgLy8gVGltZSBiZWZvcmUgYmFsbCBjYW4gYmUgY2F1Z2h0IGFnYWluCgogICAgICAgICAgICAvLyBNYWduZXQgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSAwLjI7IAogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBWaXN1YWxzIChTcXVhc2ggJiBTdHJldGNoKQogICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24gPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG51bGw7Cgp0aGlzLmluaXRNZXNoKCk7CnRoaXMudHJhaWwgPSBuZXcgVHJhaWxSZW5kZXJlcihzY2VuZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsc2FmZSBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwp9CgogICAgICAgIGluaXRNZXNoKCkgewogICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggKFBvcykgLT4gRGVmb3JtIChTcXVhc2gvU3RyZXRjaCkgLT4gU3BpbiAoUm90YXRpb24pIC0+IE1vZGVsCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwoKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC4zLCAxNiwgMTYpOyAvLyBTY2FsZWQgZG93biB+MTUlCiAgICAgICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIG1hcDogcGxhY2Vob2xkZXJUZXgsCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYsIAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiBmYWxzZSwgLy8gU29saWQKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiBmYWxzZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7CgogICAgICAgICAgICAvLyBMb2FkIEdMQiBNb2RlbAogICAgICAgICAgICBjb25zdCB1cmwgPSAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzUyMWFlODc4OGU1ODRlMzc4YTc5ZDk3MzJhMDc1MzU2LmdsYic7CiAgICAgICAgICAgIAogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwodXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkRFQlVHOiBCYWxsIEdMQiBsb2FkZWQuIiwgZ2x0Zik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gZ2x0Zi5zY2VuZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBSZXNldCByb290IHRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgICAgIG1vZGVsLnVwZGF0ZU1hdHJpeFdvcmxkKHRydWUpOwoKICAgICAgICAgICAgICAgIC8vIDIuIEhhcmRlbiBNYXRlcmlhbHMgJiBWaXNpYmlsaXR5CiAgICAgICAgICAgICAgICBtb2RlbC50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBDUklUSUNBTDogUHJldmVudCBjdWxsaW5nIGlmIGJvdW5kcyBhcmUgb2ZmCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0cyA9IEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkgPyBub2RlLm1hdGVyaWFsIDogW25vZGUubWF0ZXJpYWxdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbmplY3QgSmVsbHkgV29iYmxlIFNoYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0ub25CZWZvcmVDb21waWxlID0gKHNoYWRlcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyID0gc2hhZGVyOyAvLyBTdG9yZSByZWZlcmVuY2UgdG8gdXBkYXRlIHRpbWUgbGF0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRlci52ZXJ0ZXhTaGFkZXIgPSBzaGFkZXIudmVydGV4U2hhZGVyLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB3b2JibGUgPSBzaW4ocG9zaXRpb24ueSAqIDQuMCArIHVUaW1lICogMTUuMCkgKiAwLjA2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29iYmxlICs9IGNvcyhwb3NpdGlvbi54ICogNC4wICsgdVRpbWUgKiAxMi4wKSAqIDAuMDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b2JibGUgKz0gc2luKHBvc2l0aW9uLnogKiA0LjAgKyB1VGltZSAqIDEwLjApICogMC4wNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQgKz0gbm9ybWFsICogd29iYmxlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIDMuIENvbXB1dGUgQm91bmRpbmcgQm94CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpOwogICAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0U2l6ZShzaXplKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBib3guZ2V0Q2VudGVyKGNlbnRlcik7CgogICAgICAgICAgICAgICAgLy8gNC4gVmFsaWRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgoc2l6ZS54LCBzaXplLnksIHNpemUueik7CiAgICAgICAgICAgICAgICBpZiAobWF4RGltIDw9IDAuMDAxIHx8ICFpc0Zpbml0ZShtYXhEaW0pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIG1vZGVsIGhhcyBpbnZhbGlkIGRpbWVuc2lvbnMuIEtlZXBpbmcgcGxhY2Vob2xkZXIuIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA1LiBDYWxjdWxhdGUgU2NhbGUKLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCmlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tGYWlsc2FmZXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTaGFkZXIgVGltZSBmb3IgSmVsbHkgRWZmZWN0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmlzTWVzaCAmJiBjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShjLm1hdGVyaWFsKSA/IGMubWF0ZXJpYWwgOiBbYy5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG0udXNlckRhdGEuc2hhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udXNlckRhdGEuc2hhZGVyLnVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1hZ25ldGl6ZSh0YXJnZXQpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCl91cGRhdGVGcmVlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyBIb21pbmcgTG9naWMgKFN0ZWVyaW5nKQogICAgICAgICAgICBpZiAodGhpcy5ob21pbmdUYXJnZXQgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5zdWJWZWN0b3JzKHRoaXMuaG9taW5nVGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZWVyUmF0ZSA9IDIuNSAqIGR0OyAvLyBUdXJuIHJhdGUKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubGVycChfdGVtcFZlYy5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpLCBzdGVlclJhdGUpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihjdXJyZW50U3BlZWQpOyAvLyBNYWludGFpbiBzcGVlZAogICAgICAgICAgICB9Cgpjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKY29uc3Qgc3Vic3RlcHMgPSAoQy5TVUJTVEVQUyB8fCAxKTsKICAgICAgICAgICAgY29uc3Qgc3RlcER0ID0gZHQgLyBzdWJzdGVwczsKCiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3Vic3RlcHM7IHMrKykgewogICAgICAgICAgICAgICAgLy8gQSkgTWFnbnVzIGVmZmVjdAogICAgICAgICAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmVsU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9tYWdudXNWZWMuY29weSh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkuY3Jvc3ModGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoKEMuTUFHTlVTX0NPRUZGIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hZ0xlbiA9IF9tYWdudXNWZWMubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWdMZW4gPiBjYXApIF9tYWdudXNWZWMubXVsdGlwbHlTY2FsYXIoY2FwIC8gbWFnTGVuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoX21hZ251c1ZlYyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEIpIFNwaW4gZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5tdWx0aXBseVNjYWxhcihzcGluRHJhZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRZID0gKEMuREVQVEhfVEFSR0VUX1kgIT09IHVuZGVmaW5lZCA/IEMuREVQVEhfVEFSR0VUX1kgOiAwLjApOwogICAgICAgICAgICAgICAgY29uc3QgeUVyciA9ICh0aGlzLm1lc2gucG9zaXRpb24ueSAtIHRhcmdldFkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuREVQVEhfREFNUCB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gRCkgRHJhZwogICAgICAgICAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBpZiAodkxlbiA+IDAuMDAwMDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW4gPSAoQy5XQVRFUl9EUkFHX0xJTkVBUiAhPT0gdW5kZWZpbmVkID8gQy5XQVRFUl9EUkFHX0xJTkVBUiA6IChDLldBVEVSX0RSQUcgfHwgMCkpICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWcgPSBNYXRoLm1heCgwLCAxLjAgLSBsaW4gLSBxdWFkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWcpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcCA+IDAgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgc3RvcCAqIHN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIG1vdmVkIHRvIGVuZCBvZiBmdW5jdGlvbgoKICAgICAgICAgICAgICAgIC8vIEUpIE1vdmUKICAgICAgICAgICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3RlbXBWZWMpOwoKICAgICAgICAgICAgICAgIC8vIEYpIEdyYXZpdHkgKEdsb2JhbCBPdmVycmlkZSkKICAgICAgICAgICAgICAgIGNvbnN0IGdyYXZpdHkgPSAoQy5HUkFWSVRZICE9PSB1bmRlZmluZWQgPyBDLkdSQVZJVFkgOiAwLjApOwogICAgICAgICAgICAgICAgaWYgKGdyYXZpdHkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgLT0gZ3Jhdml0eSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBFeHRlcm5hbCBFbnZpcm9ubWVudGFsIEZvcmNlIChDdXJyZW50cywgVmVudHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5leHRlcm5hbEZvcmNlLmxlbmd0aFNxKCkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKHRoaXMuZXh0ZXJuYWxGb3JjZSwgc3RlcER0KTsKICAgICAgICAgICAgICAgIH0KCi8vIEgpIFN0YXQgcG93ZXIgZGVjYXkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucG93ZXIgLT0gdGhpcy5kZWNheVJhdGUgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHKSBCb3VuZGFyeSBsb2dpYwogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJ5UmFkaXVzID0gKEMuQk9VTkRBUllfUkFESVVTICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX1JBRElVUyA6IDMzLjApOwogICAgICAgICAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgICAgICAgICAgaWYgKEMuR09BTF9QT0NLRVRfRU5BQkxFRCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluR29hbFBvY2tldCA9IChNYXRoLmFicyhwb3MueCkgPCAoQy5HT0FMX1BPQ0tFVF9YIHx8IDEyLjApICYmIE1hdGguYWJzKHBvcy56KSA+IChDLkdPQUxfUE9DS0VUX1ogfHwgMjUuMCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNvZnRCdWZmZXIgPSBNYXRoLm1heCgwLjAxLCAoQy5XQUxMX1NPRlRfQlVGRkVSICE9PSB1bmRlZmluZWQgPyBDLldBTExfU09GVF9CVUZGRVIgOiAzLjApKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFhaID4gZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHBlbmV0cmF0aW9uIC8gc29mdEJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIGZvcmNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMuc2V0KC1wb3MueCwgMCwgLXBvcy56KTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IGRpc3RYWiAtIGVmZmVjdGl2ZUJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZEb3ROID0gdGhpcy52ZWxvY2l0eS5kb3QoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgIGlmICh2RG90TiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEwLjAgJiYgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmlnZ2VyQXJlbmFJbXBhY3QocG9zLCBNYXRoLm1pbihpbXBhY3RTcGVlZCAqIDAuNSwgMTUuMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogTWF0aC5taW4oMS4wLCBpbXBhY3RTcGVlZCAqIDAuMDUpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CmNvbnN0IGUgPSAodGhpcy5pc1JpY29jaGV0ID8gMC45NSA6IChDLldBTExfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0VMQVNUSUNJVFkgOiAwLjMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1wdWxzZSA9IF90ZW1wVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXZEb3ROICogKDEuMCArIGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBSaWNvY2hldCBTcGluIEtpY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSaWNvY2hldCAmJiB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRm9yY2UgPSBfdGVtcFZlYy5jcm9zcyh0aGlzLmFuZ3VsYXJWZWxvY2l0eSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKHNwaW5Gb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhbmdlbnQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkucHJvamVjdE9uUGxhbmUoX3RlbXBWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnN1Yih0YW5nZW50Lm11bHRpcGx5U2NhbGFyKDEuMCAtIGZyaWN0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgYmggPSAoQy5CT1VOREFSWV9IRUlHSFQgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfSEVJR0hUIDogMTUuMCk7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnkpID4gYmgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICAgICAgICAgIHBvcy55ID0gYmggKiBzaWduOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlID0gKEMuRkxPT1JfRUxBU1RJQ0lUWSAhPT0gdW5kZWZpbmVkID8gQy5GTE9PUl9FTEFTVElDSVRZIDogMC40KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwogICAgICAgICAgICAgICAgfQovLyBFbmQgb2Ygc3Vic3RlcCBsb29wIHNjb3BlCn0gLy8gRW5kIG9mIHN1YnN0ZXAgbG9vcAogICAgICAgIH0KCgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKCiAgICAgICAgICAgIC8vIC0tLSBFTEVNRU5UQUwgVFJBSUxTIC0tLQogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50ICYmIHNwZWVkU3EgPiA1LjApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRhbFRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnRhbFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChwbSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBwb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEppdHRlcgogICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBTY2FsZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBJbnRlcnZhbCA9IDAuMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQgPT09ICdmaXJlJykgeyBwVHlwZSA9ICdmaXJlJzsgcFNjYWxlID0gMC44OyBwSW50ZXJ2YWwgPSAwLjA1OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ljZScpIHsgcFR5cGUgPSAnaWNlJzsgcFNjYWxlID0gMC42OyBwSW50ZXJ2YWwgPSAwLjA4OyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ3ZvbHQnKSB7IHBUeXBlID0gJ3ZvbHQnOyBwU2NhbGUgPSAwLjc7IHBJbnRlcnZhbCA9IDAuMDQ7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSB7IHBUeXBlID0gJ3Zlbm9tJzsgcFNjYWxlID0gMC40OyBwSW50ZXJ2YWwgPSAwLjE7IH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAnd2l0aGVyJykgeyBwVHlwZSA9ICd3aXRoZXInOyBwU2NhbGUgPSAwLjU7IHBJbnRlcnZhbCA9IDAuMTsgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSB7IHBUeXBlID0gJ25hcCc7IHBTY2FsZSA9IDAuNDsgcEludGVydmFsID0gMC4xNTsgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bihwVHlwZSwgcG9zLCB7IHNjYWxlOiBwU2NhbGUsIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuMikgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50YWxUaW1lciA9IHBJbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ29udGludW91cyBCdWJibGUgU3RyZWFtIChUaGUgIkRhbW4gQmxpdHpiYWxsIiBFZmZlY3QpCiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZW1pc3Npb24gZnJlcXVlbmN5IGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCA9IHZlcnkgZnJlcXVlbnQgKDAuMDFzKSwgU2xvdyA9IGxlc3MgZnJlcXVlbnQgKDAuMDVzKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHNwZWVkU3EgLyAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjA1IC0gKDAuMDQgKiBzcGVlZFJhdGlvKTsgCgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcigtMC42KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgYmFzZVBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBNaWNybyBCdWJibGVzIChUaGUgdGlnaHQgc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIGEgY2x1c3RlciBmb3IgZGVuc2l0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMSArIE1hdGguZmxvb3Ioc3BlZWRSYXRpbyAqIDMpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IHRoaXMudmVsb2NpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bVNjYWxlOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAyLiBNYWluIEJ1YmJsZXMgKE9jY2FzaW9uYWwgbGFyZ2VyIG9uZXMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgaml0dGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjYKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIGJhc2VQb3MuY2xvbmUoKS5hZGQoaml0dGVyKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjggKyBNYXRoLnJhbmRvbSgpICogMC42LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wNQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIEhpZ2ggU3BlZWQgQ2F2aXRhdGlvbiAoSmV0IFN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlZWRTcSA+IDgwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2Rhc2hfc3RyZWFtJywgYmFzZVBvcywgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAxLjUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC4yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlclZlbG9jaXR5OiB0aGlzLnZlbG9jaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMC4wMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGFhY2NmZgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgUkVBQ1RJT04gVE8gRVhURVJOQUwgRk9SQ0VTIChDdXJyZW50cykgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmV4dGVybmFsRm9yY2UubGVuZ3RoU3EoKSA+IDUuMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4zKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKHBtKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMi4wOwogICAgICAgICAgICAgICAgICAgIHBvcy55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUGFydGljbGVzIG1vdmluZyB3aXRoIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHBvcywgewogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjEsCiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJWZWxvY2l0eTogdGhpcy5leHRlcm5hbEZvcmNlLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMi4wKSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1TY2FsZTogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHg4OGZmZmYKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIFN0cmF5IGNvZGUgYmxvY2sgcmVtb3ZlZAoKZ3JhYihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQ6IFBvc3Nlc3Npb24gKGlmIHRha2luZyBmcm9tIGZyZWUgc3RhdGUpCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJQT1NTRVNTSU9OIiwgIm5vcm1hbCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgVHVybm92ZXIgKFBvc3Nlc3Npb24gQ2hhbmdlKQogICAgICAgICAgICBjb25zdCBwcmV2aW91c1RlYW0gPSB0aGlzLmhvbGRlciA/IHRoaXMuaG9sZGVyLnRlYW0gOiAodGhpcy5sYXN0SG9sZGVyID8gdGhpcy5sYXN0SG9sZGVyLnRlYW0gOiBudWxsKTsKICAgICAgICAgICAgaWYgKHByZXZpb3VzVGVhbSAmJiBwcmV2aW91c1RlYW0gIT09IHBsYXllci50ZWFtKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRVUk5PVkVSIiwgcGxheWVyLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBzb21lb25lIGVsc2UgaGVsZCBpdCwgdGhleSBsb3NlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlciAhPT0gcGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhvbGRlciA9IHBsYXllcjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5PVEU6IFdlIGRvIE5PVCBwYXJlbnQgdGhlIG1lc2ggdG8gdGhlIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSBiYWxsIGZyb20gZmx5aW5nIGFyb3VuZCBkdWUgdG8gc3dpbSBhbmltYXRpb25zLgogICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSB1cGRhdGUgaXRzIHBvc2l0aW9uIG1hbnVhbGx5IGluIHVwZGF0ZUhlbGQoKS4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHBsYXllci5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgcGxheWVyLnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJCYWxsIGdyYWJiZWQgYnkgIiArIHBsYXllci5yb2xlKTsKICAgICAgICB9CgogICAgICAgIGRyb3AoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IC8vIEVuc3VyZSB2aXNpYmxlCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBObyBuZWVkIHRvIGRldGFjaCBmcm9tIHNjZW5lIGdyYXBoIHNpbmNlIHdlIGFyZW4ndCBwYXJlbnRpbmcgdG8gcGxheWVyIGFueW1vcmUuCiAgICAgICAgICAgIC8vIEp1c3QgY2xlYXIgaG9sZGVyLgoKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIubG9zZUJhbGwpIHRoaXMuaG9sZGVyLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZnJlZSc7CiAgICAgICAgfQovLyBTaG9vdC9QYXNzCi8vIFNob290L1Bhc3MKICAgICAgICBzaG9vdChkaXJlY3Rpb25WZWN0b3IsIGZvcmNlLCB0eXBlID0gJ1NIJywgdGVjaG5pcXVlID0gbnVsbCwgc3BpblZlY3RvciA9IG51bGwpIHsKCiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICB0aGlzLmlzUmljb2NoZXQgPSAodHlwZSA9PT0gJ1JJQ09DSEVUJyB8fCAodGVjaG5pcXVlICYmIHRlY2huaXF1ZS50eXBlID09PSAncmljb2NoZXQnKSk7CiAgICAgICAgICAgIHRoaXMuaG9taW5nVGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuZHJvcCgpOyAvLyBEZXRhY2ggZmlyc3QKCi8vIFNldCBHcmFjZSBQZXJpb2QgdG8gcHJldmVudCBpbnN0YW50IGludGVyY2VwdGlvbnMvY2F0Y2hlcwogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdMT0InKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuNyk7IC8vIFNsb3dlciBmb3J3YXJkCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAxOC4wOyAvLyBIaWdoIHZlcnRpY2FsIHBvcAogICAgICAgICAgICAgICAgaWYgKCFzcGluVmVjdG9yKSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoLTE1LCAwLCAwKTsgLy8gQmFja3NwaW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIT01JTkcnIHx8ICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdob21pbmcnKSkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gKHRoaXMudmVsb2NpdHkueiA+IDApID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmhvbWluZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIHRhcmdldFopOwogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob21pbmdUYXJnZXQuY29weSh0ZWNobmlxdWUudGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICAKLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CnRoaXMucG93ZXJUeXBlID0gdHlwZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERldGVybWluZSBFbGVtZW50CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUuZWxlbWVudCkgdGhpcy5lbGVtZW50ID0gdGVjaG5pcXVlLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChbJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCddLmluY2x1ZGVzKHRlY2huaXF1ZS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IHRlY2huaXF1ZS50eXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudCA9PT0gJ2ZpcmUnKSBjb2xvciA9IDB4ZmY0NDAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICdpY2UnKSBjb2xvciA9IDB4YWFkZGZmOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd2b2x0JykgY29sb3IgPSAweGZmZmYwMDsKICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lbGVtZW50ID09PSAndmVub20nKSBjb2xvciA9IDB4MDBmZjAwOwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVsZW1lbnQgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdzcGhlcmUnKSBjb2xvciA9IDB4MDBmZmZmOyAvLyBDeWFuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIGNvbG9yID0gMHhmZjAwMDA7IC8vIFJlZAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgY29sb3IgPSAweDQ0NDQ0NDsgLy8gRGFyayBHcmV5CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIEZYOiBQb29mCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgIC8vIEZYOiBSZXZlYWwgUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyICYmIHRoaXMubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi4wIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCgpyZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5yZXZlYWwoKTsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxGb3JjZS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc2V0RXh0ZXJuYWxGb3JjZSh2ZWMpIHsKICAgICAgICAgICAgdGhpcy5leHRlcm5hbEZvcmNlLmNvcHkodmVjKTsKICAgICAgICB9CgogICAgICAgIGlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKCl91cGRhdGVWaXN1YWxUcmFuc2Zvcm1zKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzcGVlZCA+IDEuMCAmJiB0aGlzLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3F1YXNoLCBzcXVhc2gsIHN0cmV0Y2gpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uaWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEFwcGx5IEFjY3VtdWxhdGVkIFNwaW4KICAgICAgICAgICAgY29uc3QgaW52RGVmb3JtID0gdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uY2xvbmUoKS5pbnZlcnQoKTsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5xdWF0ZXJuaW9uLmNvcHkoaW52RGVmb3JtLm11bHRpcGx5KHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbikpOwoKICAgICAgICAgICAgLy8gMy4gVmlzdWFsIHJvdGF0aW9uIGludGVncmF0aW9uCiAgICAgICAgICAgIGNvbnN0IHNwaW5TcSA9IHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGluU3BlZWQgPSBNYXRoLnNxcnQoc3BpblNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF4aXMgPSBfdGVtcFZlYy5jb3B5KHRoaXMuYW5ndWxhclZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLnByZW11bHRpcGx5KHEpOwogICAgICAgICAgICB9IGVsc2UgewppZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2hlY2tGYWlsc2FmZXMoZHQpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBtYXhSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgfHwgNDYuMCkgKyAxNS4wOyAvLyBHZW5lcm91cyBidWZmZXIKICAgICAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gKEMuQk9VTkRBUllfSEVJR0hUIHx8IDIwLjApICsgMTUuMDsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gcG9zLngqcG9zLnggKyBwb3Mueipwb3MuejsKCiAgICAgICAgICAgIC8vIDEuIE91dCBvZiBCb3VuZHMgQ2hlY2sKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IG1heFJhZGl1cyptYXhSYWRpdXMgfHwgTWF0aC5hYnMocG9zLnkpID4gbWF4SGVpZ2h0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRPZkJvdW5kc1RpbWVyID4gMS4wKSB7IC8vIDEgc2Vjb25kIE9PQgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBPT0IgZGV0ZWN0ZWQuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm91dE9mQm91bmRzVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQp9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vdXRPZkJvdW5kc1RpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU3R1Y2sgQ2hlY2sgKEZyZWUgJiBTdGF0aW9uYXJ5KQogICAgICAgICAgICAvLyBPbmx5IGNoZWNrIGlmIGdhbWUgaXMgYWN0aXZlIHRvIGF2b2lkIHJlc2V0dGluZyBkdXJpbmcgY3V0c2NlbmVzL21lbnVzCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjA1KSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gNC4wKSB7IC8vIDQgc2Vjb25kcyBzdGF0aW9uYXJ5CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIHN0dWNrIHN0YXRpb25hcnkuIFJlc2V0dGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcmNlUmVzZXRUb1BsYXkoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yY2VSZXNldFRvUGxheSgpIHsKICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMucG93ZXIgPSAwOwoKICAgICAgICAgICAgLy8gRmluZCBuZWFyZXN0IHBsYXllciB0byByZXNldCB0bwogICAgICAgICAgICBsZXQgbmVhcmVzdCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtaW5Ec3QgPSBJbmZpbml0eTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgbGV0IHRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOyAvLyBEZWZhdWx0IGNlbnRlcgoKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50ZWFtcy5hd2F5KSBhbGxQbGF5ZXJzLnB1c2goLi4uZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5Ec3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWFyZXN0ID0gcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobmVhcmVzdCAmJiBuZWFyZXN0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBwbGF5ZXIgaXMgd2l0aGluIHJlYXNvbmFibGUgYm91bmRzIGJlZm9yZSB0ZWxlcG9ydGluZyBiYWxsIHRvIHRoZW0KICAgICAgICAgICAgICAgIGNvbnN0IHBQb3MgPSBuZWFyZXN0Lm1lc2gucG9zaXRpb247CmlmIChwUG9zLmxlbmd0aFNxKCkgPCA2MCo2MCkgeyAvLyBXaXRoaW4gNjBtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihuZWFyZXN0Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmNvcHkocFBvcykuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigyLjApKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSA9IE1hdGgubWF4KDAsIHBQb3MueSArIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZ2FtZSAmJiBnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdhbWUgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQp9CiAgICB9CndpbmRvdy5mbHV4LkJhbGwgPSBCYWxsOwogICAgd2luZG93LmZsdXguVHJhaWxSZW5kZXJlciA9IFRyYWlsUmVuZGVyZXI7Cn0pKCk7","GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFyZW5hIFRoZW1lIE1hbmFnZXIgJiBBcHBseSBEZWZhdWx0CiAgICAgICAgICAgIHRoaXMuYXJlbmFUaGVtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIoc2NlbmUsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFyZW5hVGhlbWVNYW5hZ2VyLnNldFRoZW1lKCdTVEFOREFSRCcpOwoKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHdpbmdQdWxzZSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KSBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSkpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLndpbmctcHVsc2UgewogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogd2luZ1B1bHNlIDAuNHMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMgKEhlcmN1bGVhbiBIVUQpCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJpbmQgV2luZ3MgZm9yIEp1aWNlCiAgICAgICAgICAgIHRoaXMudWkud2luZ0hvbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5ob21lJyk7CiAgICAgICAgICAgIHRoaXMudWkud2luZ0F3YXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5hd2F5Jyk7CiAgICAgICAgICAgIC8vIFRlY2hjb3B5IFVJIGJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlY2gtZmxhc2gtb3ZlcmxheScpOwogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1YiA9IHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXN1Yi10ZXh0Jyk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5uYW1lID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLmNoYXItbmFtZScpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IHRoaXMudWkuc3RhdHVzUGFuZWwuY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoJy5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcuaHAtdmFsdWUnKTsKICAgICAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuZXhwQmFyID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLnRlY2gtYmFyLWZpbGwnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICBpZiAodGhpcy51aS50aW1lcikgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSAiMDA6MDAiOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRydWUpOyAvLyBGb3JjZSBpbml0aWFsIHJlbmRlciB3aXRob3V0IGFuaW1hdGlvbgogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KCl91cGRhdGVTY29yZVVJKHNraXBBbmltYXRpb24gPSBmYWxzZSkgewogICAgICAgICAgICBjb25zdCBob21lRWwgPSB0aGlzLnVpLnNjb3JlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhd2F5RWwgPSB0aGlzLnVpLnNjb3JlQ3B1OwogICAgICAgICAgICBjb25zdCBob21lV2luZyA9IHRoaXMudWkud2luZ0hvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXlXaW5nID0gdGhpcy51aS53aW5nQXdheTsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBhbmltYXRlIChTbGFtIEVmZmVjdCkKICAgICAgICAgICAgY29uc3QgdXBkYXRlRWxlbWVudCA9IChlbCwgd2luZywgbmV3VmFsKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBwYXJzZUludChlbC5pbm5lclRleHQpIHx8IDA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgb3IgZm9yY2VkCiAgICAgICAgICAgICAgICBpZiAobmV3VmFsICE9PSBvbGRWYWwgfHwgc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVsLmlubmVyVGV4dCA9IG5ld1ZhbDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBSZWZsb3cgZm9yIEFuaW1hdGlvbiBSZXN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB2b2lkIGVsLm9mZnNldFdpZHRoOyAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZCgnc2NvcmUtdXBkYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkIHdpbmcub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5nLmNsYXNzTGlzdC5hZGQoJ3dpbmctcHVsc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjbGVhbiBzdGF0ZSBvbiBpbml0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGhvbWVFbCkgdXBkYXRlRWxlbWVudChob21lRWwsIGhvbWVXaW5nLCB0aGlzLnNjb3JlLmhvbWUpOwogICAgICAgICAgICBpZiAoYXdheUVsKSB1cGRhdGVFbGVtZW50KGF3YXlFbCwgYXdheVdpbmcsIHRoaXMuc2NvcmUuYXdheSk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKLy8gVXBkYXRlIFBvd2VyVXBzCiAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyVXBNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvd2VyVXBNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBcmVuYSBIYXphcmRzIChQaHlzaWNzKQogICAgICAgICAgICBpZiAodGhpcy5hcmVuYVRoZW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hcmVuYVRoZW1lTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gUGxheWVyIFdhcm11cCBBbmltYXRpb25zCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVJbnRyb1dhcm11cChkdCk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmludHJvU2hvdHMgfHwgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90SW5kZXggPj0gdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOyAvLyBEb25lCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IHNob3Qgc3RhcnQKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0U2hvdC5vblN0YXJ0KSBuZXh0U2hvdC5vblN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBzaG90CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuaW50cm9TaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSAmJiBzaG90LnVwZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9QVUxBVEUgQVJFTkEgRk9SIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFVJCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlICYmIHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUud2lkdGggPSBgJHtwY3R9JWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgIGlmIChwY3QgPCAzMCkgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnI2ZmMDAwMCc7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZiknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCi8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFVwZGF0ZSBwYXJ0aWNsZXMgZHVyaW5nIGdhbWVwbGF5Ci8vIENSSVRJQ0FMIEZJWDogVXBkYXRlIHBhcnRpY2xlcyBkdXJpbmcgZ2FtZXBsYXkgd2l0aCBzYWZlIERUCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShNYXRoLm1heCgwLjAwMSwgZHQpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVBdWRpb1N0YXRlKCk7CnRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgovLyBLZWVwIEJHTSBwbGF5aW5nIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGVsZCA9ICEhYmFsbC5ob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIb21lIHNjb3JpbmcgZW5kIChHb2FsIGF0IC1aKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKE5lZ2F0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA8IC0wLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBd2F5IHNjb3JpbmcgZW5kIChHb2FsIGF0ICtaKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKFBvc2l0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU5DUkVNRU5UIFNDT1JFCiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlW3Njb3Jlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBHT0FMISAke3Njb3Jlcn0gc2NvcmVzLiBOZXcgU2NvcmU6IEhvbWUgJHt0aGlzLnNjb3JlLmhvbWV9IC0gQXdheSAke3RoaXMuc2NvcmUuYXdheX1gKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgIHRoaXMuYWRkSFVEU2hha2UoMjAuMCk7IC8vIEhVRCBTaGFrZQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCQVJSSUVSIFNIQVRURVIgTE9HSUMKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIEhvbWUgc2NvcmVzIGF0IC1aIChBd2F5IEdvYWwpLCBBd2F5IHNjb3JlcyBhdCArWiAoSG9tZSBHb2FsKQogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChzY29yZXIgPT09ICdob21lJykgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhcnJpZXIgPSAoc2NvcmVyID09PSAnaG9tZScpID8gdGhpcy5zdGFkaXVtLmJhcnJpZXJBIDogdGhpcy5zdGFkaXVtLmJhcnJpZXJCOwogICAgICAgICAgICAgICAgaWYgKGJhcnJpZXIpIGJhcnJpZXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxWZWwgPSB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcndhcmQgPSBiYWxsVmVsLmNsb25lKCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEltcGFjdCBQb2ludCBvbiBHb2FsIFBsYW5lIChUaGUgIkludmlzaWJsZSBCYXJyaWVyIikKICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFBvcyA9IGJhbGxQb3MuY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIFNuYXAgZWZmZWN0IHRvIHRoZSBiYXJyaWVyIHBsYW5lIChaKSBidXQga2VlcCBYL1kgb2YgZW50cnkKICAgICAgICAgICAgICAgIGltcGFjdFBvcy56ID0gZ29hbFo7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEdsYXNzIFNoYXR0ZXIgRWZmZWN0IChUaGUgSG9sZSkKICAgICAgICAgICAgICAgIHRoaXMuX3RyaWdnZXJHbGFzc1NoYXR0ZXIoaW1wYWN0UG9zLCBiYWxsVmVsKTsKCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRyaWFuZ2xlIEZyYW1lIFNoYXR0ZXIgKFRoZSBCYXJyaWVyKQogICAgICAgICAgICAgICAgdGhpcy5fc3Bhd25UcmlhbmdsZVNoYXR0ZXIoZ29hbFosIGZvcndhcmQpOwoKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDIwLjAsIGxpZmU6IDAuNiwgY29sb3I6IDB4MDBmZmZmIH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgaW1wYWN0UG9zLCB7IHNjYWxlOiAxMi4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSyAoU3VkZGVuIERlYXRoKQogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsb3cgbW90aW9uIGZpbmlzaAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjI7CgogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkgKDAuNXMgZ2FtZSB0aW1lIGF0IDAuMiBzY2FsZSA9IDIuNXMgcmVhbCB0aW1lKQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2xkZW5fZ29hbCc7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2dvYWwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMgKDIuMHMgZ2FtZSB0aW1lKQogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAyLjA7CiAgICAgICAgICAgIHRoaXMubmV4dFN0YXRlUGF5bG9hZCA9IGxvc2VyOwogICAgICAgIH0KCl9zcGF3blRyaWFuZ2xlU2hhdHRlcih6UG9zLCBmb3J3YXJkRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFRyaWFuZ2xlIFZlcnRpY2VzIChNYXRjaGVzIFN0YWRpdW0uanMgZ2VvbWV0cnkpCiAgICAgICAgICAgIC8vIFRvcCBZOiAxMi4wLCBCb3R0b20gWTogLTYuMC4gV2lkdGggYXQgdG9wOiAyOC4wICgrLy0gMTQuMCkuCmNvbnN0IHYxID0geyB4OiAtMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjIgPSB7IHg6IDE0LCB5OiA5IH07CiAgICAgICAgICAgIGNvbnN0IHYzID0geyB4OiAwLCB5OiAtNiB9OwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZWRnZXMgPSBbCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MSwgZW5kOiB2MiB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjIsIGVuZDogdjMgfSwKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYzLCBlbmQ6IHYxIH0KICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBkZW5zaXR5IGZvciAiYXBwZWFyaW5nIiBlZmZlY3QKLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdApjb25zdCBwYXJ0aWNsZXNQZXJFZGdlID0gNDsgLy8gUmVkdWNlZCBmcm9tIDEyIGZvciBsZXNzIGNsdXR0ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgIGVkZ2VzLmZvckVhY2goZWRnZSA9PiB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBwYXJ0aWNsZXNQZXJFZGdlOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gaSAvIHBhcnRpY2xlc1BlckVkZ2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IGVkZ2Uuc3RhcnQueCArIChlZGdlLmVuZC54IC0gZWRnZS5zdGFydC54KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGVkZ2Uuc3RhcnQueSArIChlZGdlLmVuZC55IC0gZWRnZS5zdGFydC55KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgelBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHNvbWUgcmFuZG9tbmVzcwogICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogT3V0d2FyZCBmcm9tIGNlbnRlciBvZiB0cmlhbmdsZSAoYXBwcm94IDAsIDQpICsgRm9yd2FyZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHsgeDogMCwgeTogMS41IH07IC8vIFJvdWdoIGNlbnRlciBvZiBtYXNzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoeCAtIGNlbnRlci54LCB5IC0gY2VudGVyLnksIDApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGRpci5tdWx0aXBseVNjYWxhcig4LjAgKyBNYXRoLnJhbmRvbSgpICogMTIuMCk7CiAgICAgICAgICAgICAgICAgICAgdmVsLmFkZChmb3J3YXJkRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMjAuMCkpOyAvLyBTdHJvbmcgZm9yd2FyZCBtb21lbnR1bQoKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogNi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS41ICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4NDRhYWZmLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxMC4wLCAvLyBTcGluCiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KSAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBvbiBwZXJpbWV0ZXIgdG8gb3V0bGluZSB0aGUgc2hhcGUgYXMgaXQgYnJlYWtzCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuMywgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX3RyaWdnZXJHbGFzc1NoYXR0ZXIocG9zLCB2ZWwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IHZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWF4KDIwLjAsIHZlbC5sZW5ndGgoKSk7IC8vIEVuc3VyZSBtaW5pbXVtIGV4cGxvc2lvbiBzcGVlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCi8vIDEuIFRoZSAiUGFuZSIgKFJhZGlhbCBidXJzdCBvbiB0aGUgZ29hbCBwbGFuZSkKICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHRoZSBiYXJyaWVyIHNoYXR0ZXJpbmcgb3V0d2FyZApjb25zdCBzaGFyZENvdW50ID0gMTU7IC8vIFJlZHVjZWQgZnJvbSA1MAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxzaGFyZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAxMC4wOyAvLyBMYXJnZXIgcmFkaXVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGguY29zKGFuZ2xlKSAqIHIsIE1hdGguc2luKGFuZ2xlKSAqIHIsIDApOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSBpcyByYWRpYWwgb3V0d2FyZCBmcm9tIGltcGFjdCBjZW50ZXIKICAgICAgICAgICAgICAgIGNvbnN0IHJhZGlhbERpciA9IG9mZnNldC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSByYWRpYWxEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCArIE1hdGgucmFuZG9tKCkgKiAyNS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQWRkIGZvcndhcmQgbW9tZW50dW0gKFRoZSBiYWxsIHB1bmNoZXMgdGhyb3VnaCkKICAgICAgICAgICAgICAgIHNoYXJkVmVsLmFkZChmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAwLjgpKTsKICAgICAgICAgICAgICAgIAp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwLCB7CiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHNoYXJkVmVsLAogICAgICAgICAgICAgICAgICAgIHNjYWxlOiA2LjAgKyBNYXRoLnJhbmRvbSgpICogOC4wLCAKICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIgKyBNYXRoLnJhbmRvbSgpICogMC44LAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDI1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4YWFmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7IC8vIFJlZHVjZWQgZnJvbSAyMAogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIHN0YXJ0IHBvcyBzbGlnaHRseSAoaW1wYWN0IHpvbmUpCiAgICAgICAgICAgICAgICBwLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgcC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDQuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHk6IE1vc3RseSBmb3J3YXJkLCBzb21lIHNwcmVhZAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSBmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAoMS4wICsgTWF0aC5yYW5kb20oKSAqIDAuNSkpOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDUuMCArIE1hdGgucmFuZG9tKCkgKiA3LjAsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMi4wICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAxNS4wLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyMC4wLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEltcGFjdCBGbGFzaCAmIFNvdW5kCiAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogMTUuMCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxMC4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEhpZ2ggcGl0Y2ggaW1wYWN0IHRvIHNpbXVsYXRlIGdsYXNzIGJyZWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wLCByYXRlOiAyLjUgfSk7IAogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCB3aG9vc2gKICAgICAgICAgICAgfQogICAgICAgIH0KCnNob3dBbm5vdW5jZW1lbnQodGV4dCwgdHlwZSA9ICdub3JtYWwnLCBkdXJhdGlvbiA9IDIwMDApIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLmFubm91bmNlbWVudDsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgcHJldmlvdXMgdGltZW91dAogICAgICAgICAgICBpZiAodGhpcy5fYW5ub3VuY2VUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fYW5ub3VuY2VUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbiBieSBjbG9uaW5nCiAgICAgICAgICAgIGNvbnN0IG5ld0VsID0gZWwuY2xvbmVOb2RlKHRydWUpOwogICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdFbCwgZWwpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IG5ld0VsOwoKICAgICAgICAgICAgbmV3RWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgbmV3RWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDbGFzcyBiYXNlZCBvbiB0eXBlCiAgICAgICAgICAgIG5ld0VsLmNsYXNzTmFtZSA9ICcnOyAvLyBSZXNldCBjbGFzc2VzCiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2xhbScpIHsKICAgICAgICAgICAgICAgIG5ld0VsLmNsYXNzTGlzdC5hZGQoJ2Fubm91bmNlbWVudC1zbGFtJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHN0eWxlCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBuZXdFbC5vZmZzZXRIZWlnaHQ7IC8qIHRyaWdnZXIgcmVmbG93ICovCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZQogICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZUFubm91bmNlbWVudCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRSb3VuZChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAncmVzZXQnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgcGVyc2lzdGVudCB2aXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmdseXBoTWFuYWdlcikgdGhpcy5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHRoaXMucG93ZXJVcE1hbmFnZXIucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogQ2xlYXIgcGFydGljbGVzIGlmIG5lZWRlZCwgdGhvdWdoIHRoZXkgc2VsZi1leHBpcmUgcXVpY2tseQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXN0b3JlIEJhcnJpZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckEpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckIpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQi52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuMTsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gcG9zc2Vzc2lvblRlYW1JZDsKICAgICAgICB9CgoKc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseQogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIHN0YW5kYXJkIGtpY2tvZmYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IHRoaXMudGVhbXNbcG9zc2Vzc2lvblRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAodGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1mID0gdGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgICAgIGlmIChtZiAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5iYWxsLmdyYWIobWYpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gbmV3IGhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KG1mLm1lc2gsIG1mLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAp0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC44OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTkVVVFJBTCBLSUNLT0ZGOiAiVGhlIEJsaXR6IE9mZiIgQ2luZW1hdGljIFNlcXVlbmNlCiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydE5ldXRyYWxCbGl0ek9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCl9zdGFydE5ldXRyYWxCbGl0ek9mZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9jaGFyZ2UnOwogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gUmVzZXQgQmFsbCB0byBDZW50ZXIgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgYmFsbC5kcm9wKCk7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KDAsIC01LCAwKTsgLy8gU3RhcnQgREVFUCAoLTVtKSBmb3IgImdyb3VuZCB1cCIgcmlzZQogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB2aXN1YWxzCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBQb3NpdGlvbiBDYXB0YWlucyAoTUZzKQogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoaG9tZU1GICYmIGhvbWVNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGhvbWVNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheU1GICYmIGF3YXlNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBhd2F5TUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIENhbWVyYSBGb2N1cwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyICYmIGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KGJhbGwubWVzaCwgbnVsbCk7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAvLyBab29tIGluIHRpZ2h0CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gLTEyOyAKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC40OyAvLyBMb29rIGRvd24gc3RlZXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQnVpbGQgVGVuc2lvbgogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlJFQURZLi4uIiwgJ25vcm1hbCcpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC41IH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUR1cmF0aW9uID0gMi4wOyAvLyBMb25nZXIgYnVpbGQgdXAgZm9yIGNpbmVtYXRpYyBmZWVsCgogICAgICAgICAgICAvLyBQSEFTRSAxOiBDSEFSR0UgKFJpc2luZyBmcm9tIGRlcHRocykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA8IGNoYXJnZUR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5ibGl0elRpbWVyIC8gY2hhcmdlRHVyYXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBlYXNlVCA9IHQgKiB0OyAvLyBRdWFkcmF0aWMgZWFzZSBpbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSaXNlIGZyb20gLTUgdG8gMCAoR3JvdW5kIHVwIGVmZmVjdCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi55ID0gLTUuMCArICg1LjAgKiBlYXNlVCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdXAgKEV4cG9uZW50aWFsKQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnkgKz0gKDEwLjAgKyA1MC4wICogdCkgKiBkdDsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi54ICs9ICg1LjAgKyAyMC4wICogdCkgKiBkdDsKCiAgICAgICAgICAgICAgICAvLyBTcXVhc2ggKEZsYXR0ZW4gbGlrZSBhIGRpc2MgYnVpbGRpbmcgZW5lcmd5KQogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJlbWUgc3F1YXNoIGF0IHRoZSBlbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLSAoMC43ICogZWFzZVQpOyAvLyBGbGF0dGVuIFkgdG8gMC4zCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArICgwLjUgKiBlYXNlVCk7IC8vIEV4cGFuZCBYWgogICAgICAgICAgICAgICAgICAgIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3RyZXRjaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgaW5jcmVhc2luZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMiAqIHQpOwoKICAgICAgICAgICAgICAgIC8vIFBhcnRpY2xlczogUmlzaW5nIEVuZXJneSBmcm9tIGdyb3VuZAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlcyByaXNpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5mbG9vcih0ICogOCkgKyAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAyLjAgKiAoMS4wIC0gdCk7IC8vIFJhZGl1cyBzaHJpbmtzIGFzIGl0IGdldHMgY2xvc2VyIHRvIGxhdW5jaAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBiYWxsLm1lc2gucG9zaXRpb24ueSAtIDEuMDsgLy8gQmVsb3cgYmFsbAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIG5ldyBUSFJFRS5WZWN0b3IzKHgsIHksIHopLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC40LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjIgKyB0ICogMC41IAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBIQVNFIDI6IExBVU5DSAogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnYmxpdHpfY2hhcmdlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9sYXVuY2gnOwogICAgICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsgLy8gUmVzZXQgZm9yIGxhdW5jaCBwaGFzZQoKICAgICAgICAgICAgICAgIC8vIFRJTUVEIEFOTk9VTkNFTUVOVAogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAgfSk7IC8vIEJvb20KICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCB9KTsgICAvLyBXaG9vc2gKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBMYXVuY2ggQmFsbAogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMzUsIDApOyAvLyBTaG9vdCBVUCBGQVNUCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDAuNCwgMy4wLCAwLjQpOyAvLyBFeHRyZW1lIHN0cmV0Y2ggdmVydGljYWwKCiAgICAgICAgICAgICAgICAvLyBGWDogTWFzc2l2ZSBHcm91bmQgRXJ1cHRpb24KICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDguMCB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDYuMCB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBzdHJlYW0KICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwxMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC55ICs9IGkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHAsIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gMTA7IC8vIFpvb20gb3V0IGZhc3QKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuMDsgLy8gTGV2ZWwgb3V0CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FwdGFpbnMgSnVtcAogICAgICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgICAgICBjb25zdCBqdW1wVG8gPSAocCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAxLjI7IC8vIFN0ZWVwIGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmNvcHkoZGlyKS5tdWx0aXBseVNjYWxhcigxOC4wKTsgLy8gRmFzdCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaF9qdW1wJywgMC4xKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganVtcFRvKGhvbWVNRik7CiAgICAgICAgICAgICAgICBqdW1wVG8oYXdheU1GKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGdyYXZpdHkgbWFudWFsbHkgZm9yIGNpbmVtYXRpYyBmZWVsIChJbmNyZWFzZWQgZ3Jhdml0eSBmb3Igc25hcHBpZXIgYXJjKQogICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnkgLT0gNDAuMCAqIGR0OyAKICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCBkdCk7CgogICAgICAgICAgICAvLyBNb3ZlIFBsYXllcnMgbWFudWFsbHkKICAgICAgICAgICAgY29uc3QgdXBkYXRlSnVtcGVyID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnkgLT0gMjUuMCAqIGR0OyAvLyBHcmF2aXR5CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihob21lTUYpOwogICAgICAgICAgICB1cGRhdGVKdW1wZXIoYXdheU1GKTsKCiAgICAgICAgICAgIC8vIFBIQVNFIDM6IEdSQUIgKEFwZXggfjAuN3MpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPiAwLjcgJiYgdGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBXaW5uZXIgKDUwLzUwICsgU3RhdCBiaWFzKQogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNwID0gaG9tZU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5U3AgPSBhd2F5TUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gaG9tZVNwICsgYXdheVNwOwogICAgICAgICAgICAgICAgY29uc3Qgcm9sbCA9IE1hdGgucmFuZG9tKCkgKiB0b3RhbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2lubmVyID0gKHJvbGwgPCBob21lU3ApID8gaG9tZU1GIDogYXdheU1GOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBiYWxsLmdyYWIod2lubmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiV09OISIsIHdpbm5lci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyYW5zaXRpb24gdG8gQWN0aXZlCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIHdpbm5lcgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQod2lubmVyLm1lc2gsIHdpbm5lci52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOyAvLyBPcHRpb25hbDogS2VlcCBzbW9vdGggb3Igc25hcAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CnRoaXMuX3VwZGF0ZVNjb3JlVUkodHJ1ZSk7IC8vIFJlc2V0IHNjb3JlIGRpc3BsYXkgd2l0aG91dCBzbGFtIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgpzdGFydEludHJvU2VxdWVuY2UoKSB7CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ludHJvJzsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsgLy8gUmVzZXQgcm9hciBmbGFnCiAgICAgICAgICAgIC8vIFN0b3AgQkdNIGZvciBjaW5lbWF0aWMgaW50cm8gKGxldCBTRlggc2hpbmUpCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnRleHQgaXMgcnVubmluZyBmb3IgaW50cm8gU0ZYCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsIHNldHVwCiAgICAgICAgICAgIC8vIEhJREUgQUxMIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLCAKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsIAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsIAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcsCiAgICAgICAgICAgICAgICAnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICB1aUVsZW1lbnRzLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICBpZiAoZWwpIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gU2hvdyBDaW5lbWF0aWMgQmFycwogICAgICAgICAgICBjb25zdCBiYXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NpbmVtYXRpYy1iYXJzJyk7CiAgICAgICAgICAgIGlmIChiYXJzKSB7CiAgICAgICAgICAgICAgICBiYXJzLnF1ZXJ5U2VsZWN0b3JBbGwoJy5iYXInKS5mb3JFYWNoKGIgPT4gYi5zdHlsZS5oZWlnaHQgPSAnMTAlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIGZpcnN0IHNob3Qgc3RhcnQKICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90cyAmJiB0aGlzLmludHJvU2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90c1swXS5vblN0YXJ0KSB0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZUludHJvV2FybXVwKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1peGVyIHVwZGF0ZXMgKHNpbmNlIGdhbWUgbG9vcCBtaWdodCBza2lwIHBsYXllci51cGRhdGUgaW4gaW50cm8gc3RhdGUpCiAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgd2FybXVwIHRpbWVyIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyID09PSB1bmRlZmluZWQpIHAuX3dhcm11cFRpbWVyID0gTWF0aC5yYW5kb20oKSAqIDIuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5fd2FybXVwVGltZXIgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBQaWNrIG5leHQgYWN0aW9uIHRpbWUgKDJzIHRvIDVzKQogICAgICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyID0gMi4wICsgTWF0aC5yYW5kb20oKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuNikgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ3N3aW0nLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3RyZXRjaCIgLyBDZWxlYnJhdGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjZWxlYnJhdGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC41KTsgLy8gQ2hlY2tpbmcgZ2xvdmVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdyZWFjdCcsIDAuNSk7IC8vIFNoYWtlIG9mZgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyAodHJlYWRpbmcgd2F0ZXIpCiAgICAgICAgICAgICAgICBpZiAocC5ob21lUG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMgKyBwLm1lc2guaWQpICogMC4zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gUGxheSBCR00gaW4gbWVudQogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgbWF0Y2ggdGVuc2lvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyLnNldE1hdGNoU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3Qgc3RhdGljVUkgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsCiAgICAgICAgICAgICAgICAncGxheWVyLXN0YXR1cy1wYW5lbCcsCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnZ29hbC1kaXN0YW5jZS1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBMaXN0IG9mIGR5bmFtaWMgZWxlbWVudHMgdG8gRk9SQ0UgSElERSBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNVSSA9IFsKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJywKICAgICAgICAgICAgICAgICd0ZWNoLWZsYXNoLW92ZXJsYXknLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBISURFIEFMTAogICAgICAgICAgICAgICAgWy4uLnN0YXRpY1VJLCAuLi5keW5hbWljVUldLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU0hPVyBTVEFUSUMgT05MWQogICAgICAgICAgICAgICAgc3RhdGljVUkuZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PT0gJ2h1ZC10b3AnIHx8IGlkID09PSAnYWN0aW9uLWNvbnRhaW5lcicpIGVsLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIG9uZXMgcmVtYWluIGhpZGRlbi9jb250cm9sbGVkIGJ5IHRoZWlyIGxvZ2ljCiAgICAgICAgICAgIH0KICAgICAgICB9CnRvZ2dsZURlbW9Nb2RlKCkgewogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSAhdGhpcy5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiRGVtbyBNb2RlOiIsIHRoaXMuaXNEZW1vTW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkgQnV0dG9uCiAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgICAgICBpZiAoYnRuKSB7CiAgICAgICAgICAgICAgICBidG4uaW5uZXJUZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBjb25zdCB0ZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCh0ZXh0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGbGFpcjogU3Bhd24gdGV4dCBhYm92ZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUgJiYgdGhpcy5mbG9hdGluZ1RleHQgJiYgdGhpcy50ZWFtcy5ob21lICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiQUkgRU5HQUdFRCIsIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlIGFubm91bmNlbWVudApzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCAmJiB0aGlzLnVpLmFubm91bmNlbWVudC5pbm5lclRleHQgPT09IHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMTUwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVEVDSENPUFkgU1lTVEVNIC0tLQoKICAgICAgICB0cmlnZ2VyVGVjaEV2ZW50KHNvdXJjZVBsYXllciwgdGVjaE5hbWUpIHsKICAgICAgICAgICAgaWYgKCFzb3VyY2VQbGF5ZXIgfHwgIXNvdXJjZVBsYXllci50ZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIG9wcG9zaW5nIHRlYW0KICAgICAgICAgICAgY29uc3Qgb3BwVGVhbUlkID0gc291cmNlUGxheWVyLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IHRoaXMudGVhbXNbb3BwVGVhbUlkXTsKICAgICAgICAgICAgaWYgKCFvcHBUZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIHdobyBpcyBtYXJraW5nIHRoaXMgc291cmNlCiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gb3BwVGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IHAubWFya2luZyA9PT0gc291cmNlUGxheWVyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChsZWFybmVycy5sZW5ndGggPT09IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9ubHkgc2hvdyBVSSBpZiB0aGUgbGVhcm5pbmcgdGVhbSBpcyBIdW1hbiAoSG9tZSkKICAgICAgICAgICAgLy8gKE9yIGlmIHdlIGFyZSBpbiBEZW1vIG1vZGUgYW5kIHdhbnQgdG8gc2VlIGl0IGhhcHBlbiBmb3IgSG9tZSB0ZWFtKQogICAgICAgICAgICBpZiAob3BwVGVhbS5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IHRob3NlIHdobyBhbHJlYWR5IGtub3cgaXQKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTGVhcm5lcnMgPSBsZWFybmVycy5maWx0ZXIocCA9PiAhcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaE5hbWUpKTsKICAgICAgICAgICAgICAgIGlmICh2YWxpZExlYXJuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIHZhbGlkTGVhcm5lcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgbGVhcm5lcnMpIHsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lID0gMC42OyAvLyAwLjZzIHdpbmRvdwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPSB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRlY2ggPSB0ZWNoTmFtZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzID0gbGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IFVJCmlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb250ZXh0IGlzIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOyAvLyBIaXQgc3RvcCBkaXNhYmxlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIEhVRCBTaGFrZSBiYXNlZCBvbiBpbXBhY3QgdHlwZQogICAgICAgICAgICBsZXQgc2hha2VBbW91bnQgPSA1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBzaGFrZUFtb3VudCA9IDE1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIHNoYWtlQW1vdW50ID0gMzAuMDsKICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZShzaGFrZUFtb3VudCk7CgogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0IHRvIHByZXZlbnQgZWFybHkgcmVtb3ZhbCBvZiBuZXcgY2xhc3MKICAgICAgICAgICAgaWYgKHRoaXMuX2ltcGFjdFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9pbXBhY3RUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBjbGFzc2VzIHRvIGVuc3VyZSBhbmltYXRpb24gcmVzdGFydHMgKHJlZmxvdyB0cmljaykKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ltcGFjdC1meCcsICdpbXBhY3QtaGVhdnknLCAnaW1wYWN0LXNoYXR0ZXInKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcmNlIHJlZmxvdwogICAgICAgICAgICB2b2lkIGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKCiAgICAgICAgICAgIGxldCBjbGFzc05hbWUgPSAnaW1wYWN0LWZ4JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIGNsYXNzTmFtZSA9ICdpbXBhY3QtaGVhdnknOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NoYXR0ZXInKSBjbGFzc05hbWUgPSAnaW1wYWN0LXNoYXR0ZXInOwoKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVtb3ZlIGNsYXNzIGFmdGVyIGR1cmF0aW9uICsgYnVmZmVyIGZvciBhbmltYXRpb24gdGFpbAogICAgICAgICAgICAvLyBXZSBhZGQgYSBiaXQgbW9yZSB0aW1lIHRoYW4gdGhlIHBhdXNlIGR1cmF0aW9uIHRvIGxldCB0aGUgQ1NTIGFuaW1hdGlvbiBmaW5pc2gKICAgICAgICAgICAgY29uc3QgYW5pbUR1cmF0aW9uID0gKHR5cGUgPT09ICdzaGF0dGVyJyA/IDUwMCA6ICh0eXBlID09PSAnaGVhdnknID8gMjUwIDogMTUwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0sIGFuaW1EdXJhdGlvbik7CiAgICAgICAgfQoKICAgICAgICBhZGRIVURTaGFrZShhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IE1hdGgubWluKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgKyBhbW91bnQsIDUwLjApOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhVRFNoYWtlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgLy8gRGVjYXkKICAgICAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgLT0gZHQgKiA2MC4wOyAvLyBEZWNheSBhcHByb3ggNjBweCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5odWRTaGFrZUludGVuc2l0eSA8IDApIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5OwogICAgICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4KWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIG1haW4gSFVEIGNvbnRhaW5lcnMKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgICAgICAvLyBQcmVzZXJ2ZSBleGlzdGluZyBza2V3CiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzUGFuZWwpIHN0YXR1c1BhbmVsLnN0eWxlLnRyYW5zZm9ybSA9IGBza2V3WCgtMTBkZWcpICR7dHJhbnNmb3JtfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CgogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faHVkU2hha2VEaXJ0eSkgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gY2xlYW4gc3RhdGUKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gJ3NrZXdYKC0xMGRlZyknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25Db250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICAgICAgaWYgKGFjdGlvbkNvbnRhaW5lcikgYWN0aW9uQ29udGFpbmVyLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlQXVkaW9TdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRlbnNpb24gPSAwOwoKICAgICAgICAgICAgLy8gMS4gQmFsbCBUaHJlYXQKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJyB8fCB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgY29uc3QgeiA9IGJhbGwubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGgubWluKE1hdGguYWJzKHogLSBnb2FsRGlzdCksIE1hdGguYWJzKHogKyBnb2FsRGlzdCkpOwogICAgICAgICAgICAgICAgY29uc3QgdGhyZWF0UmFuZ2UgPSAzNS4wOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFRocmVhdCA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0VG9Hb2FsIC8gdGhyZWF0UmFuZ2UpKTsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gYmFsbFRocmVhdCAqIGJhbGxUaHJlYXQ7IC8vIFF1YWRyYXRpYyByYW1wCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjb3JlIFByZXNzdXJlIChDbG9zZSBnYW1lKQogICAgICAgICAgICBjb25zdCBkaWZmID0gTWF0aC5hYnModGhpcy5zY29yZS5ob21lIC0gdGhpcy5zY29yZS5hd2F5KTsKICAgICAgICAgICAgaWYgKGRpZmYgPD0gMSkgdGVuc2lvbiArPSAwLjE1OwoKICAgICAgICAgICAgLy8gMy4gVGltZSBQcmVzc3VyZSAoTGFzdCBtaW51dGUpCiAgICAgICAgICAgIGNvbnN0IHRpbWVMZWZ0ID0gdGhpcy5oYWxmRHVyYXRpb24gLSB0aGlzLnRpbWU7CiAgICAgICAgICAgIGlmICh0aW1lTGVmdCA8IDYwICYmIHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0ZW5zaW9uICs9IDAuMiAqICgxLjAgLSAodGltZUxlZnQgLyA2MCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCB0aGlzLmlzT3ZlcnRpbWUpOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3VwZGF0ZUVudmlyb25tZW50YWxGWChkdCkgewogICAgICAgICAgICAvLyBPbmx5IGluIGFjdGl2ZSBnYW1lIG9yIG1lbnUKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gKHRoaXMuX2VudkJ1YmJsZVRpbWVyIHx8IDApIC0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5fZW52QnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gUmFuZG9tIGludGVydmFsOiAwLjJzIHRvIDAuOHMgKEZyZXF1ZW50IHN0cmVhbXMpCiAgICAgICAgICAgICAgICB0aGlzLl9lbnZCdWJibGVUaW1lciA9IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIFBpY2sgYSByYW5kb20gc3BvdCBvbiB0aGUgZmxvb3IKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNzA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDkwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHlCYXNlID0gLTIwOyAvLyBEZWVwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gYSAiU3RyZWFtIiAoQnVyc3Qgb2YgYnViYmxlcyByaXNpbmcgdG9nZXRoZXIpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSAzICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZWFtU3BlZWQgPSAzLjAgKyBNYXRoLnJhbmRvbSgpICogNC4wOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ICsgKE1hdGgucmFuZG9tKCktMC41KSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlIC0gKE1hdGgucmFuZG9tKCkgKiA1LjApLCAvLyBTdGFnZ2VyZWQgc3RhcnQgZGVwdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHogKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlX21pY3JvJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogMi4wLCAvLyBMb25nIGxpZmUgdG8gcmVhY2ggdG9wCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wOCArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBTaGltbWVyeSBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtU3BlZWQgKyAoTWF0aC5yYW5kb20oKSAqIDIuMCksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfYWR2YW5jZVN0YXRlKCkgewogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuc3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvYWwnOgogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCh0aGlzLm5leHRTdGF0ZVBheWxvYWQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncmVzZXQnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdraWNrb2ZmJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdoYWxmdGltZSc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Vjb25kSGFsZigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBPVCBvciBFbmQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdnb2xkZW5fZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7IC8vIFJlc3RvcmUgc3BlZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","./GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFyZW5hIFRoZW1lIE1hbmFnZXIgJiBBcHBseSBEZWZhdWx0CiAgICAgICAgICAgIHRoaXMuYXJlbmFUaGVtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIoc2NlbmUsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFyZW5hVGhlbWVNYW5hZ2VyLnNldFRoZW1lKCdTVEFOREFSRCcpOwoKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHdpbmdQdWxzZSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KSBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSkpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLndpbmctcHVsc2UgewogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogd2luZ1B1bHNlIDAuNHMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMgKEhlcmN1bGVhbiBIVUQpCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJpbmQgV2luZ3MgZm9yIEp1aWNlCiAgICAgICAgICAgIHRoaXMudWkud2luZ0hvbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5ob21lJyk7CiAgICAgICAgICAgIHRoaXMudWkud2luZ0F3YXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5hd2F5Jyk7CiAgICAgICAgICAgIC8vIFRlY2hjb3B5IFVJIGJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlY2gtZmxhc2gtb3ZlcmxheScpOwogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1YiA9IHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXN1Yi10ZXh0Jyk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5uYW1lID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLmNoYXItbmFtZScpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IHRoaXMudWkuc3RhdHVzUGFuZWwuY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoJy5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcuaHAtdmFsdWUnKTsKICAgICAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuZXhwQmFyID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLnRlY2gtYmFyLWZpbGwnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICBpZiAodGhpcy51aS50aW1lcikgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSAiMDA6MDAiOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRydWUpOyAvLyBGb3JjZSBpbml0aWFsIHJlbmRlciB3aXRob3V0IGFuaW1hdGlvbgogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KCl91cGRhdGVTY29yZVVJKHNraXBBbmltYXRpb24gPSBmYWxzZSkgewogICAgICAgICAgICBjb25zdCBob21lRWwgPSB0aGlzLnVpLnNjb3JlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhd2F5RWwgPSB0aGlzLnVpLnNjb3JlQ3B1OwogICAgICAgICAgICBjb25zdCBob21lV2luZyA9IHRoaXMudWkud2luZ0hvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXlXaW5nID0gdGhpcy51aS53aW5nQXdheTsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBhbmltYXRlIChTbGFtIEVmZmVjdCkKICAgICAgICAgICAgY29uc3QgdXBkYXRlRWxlbWVudCA9IChlbCwgd2luZywgbmV3VmFsKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBwYXJzZUludChlbC5pbm5lclRleHQpIHx8IDA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgb3IgZm9yY2VkCiAgICAgICAgICAgICAgICBpZiAobmV3VmFsICE9PSBvbGRWYWwgfHwgc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVsLmlubmVyVGV4dCA9IG5ld1ZhbDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBSZWZsb3cgZm9yIEFuaW1hdGlvbiBSZXN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB2b2lkIGVsLm9mZnNldFdpZHRoOyAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZCgnc2NvcmUtdXBkYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkIHdpbmcub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5nLmNsYXNzTGlzdC5hZGQoJ3dpbmctcHVsc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjbGVhbiBzdGF0ZSBvbiBpbml0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGhvbWVFbCkgdXBkYXRlRWxlbWVudChob21lRWwsIGhvbWVXaW5nLCB0aGlzLnNjb3JlLmhvbWUpOwogICAgICAgICAgICBpZiAoYXdheUVsKSB1cGRhdGVFbGVtZW50KGF3YXlFbCwgYXdheVdpbmcsIHRoaXMuc2NvcmUuYXdheSk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKLy8gVXBkYXRlIFBvd2VyVXBzCiAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyVXBNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvd2VyVXBNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBcmVuYSBIYXphcmRzIChQaHlzaWNzKQogICAgICAgICAgICBpZiAodGhpcy5hcmVuYVRoZW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hcmVuYVRoZW1lTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gUGxheWVyIFdhcm11cCBBbmltYXRpb25zCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVJbnRyb1dhcm11cChkdCk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmludHJvU2hvdHMgfHwgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90SW5kZXggPj0gdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOyAvLyBEb25lCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IHNob3Qgc3RhcnQKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0U2hvdC5vblN0YXJ0KSBuZXh0U2hvdC5vblN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBzaG90CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuaW50cm9TaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSAmJiBzaG90LnVwZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9QVUxBVEUgQVJFTkEgRk9SIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFVJCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlICYmIHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUud2lkdGggPSBgJHtwY3R9JWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgIGlmIChwY3QgPCAzMCkgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnI2ZmMDAwMCc7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZiknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCi8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFVwZGF0ZSBwYXJ0aWNsZXMgZHVyaW5nIGdhbWVwbGF5Ci8vIENSSVRJQ0FMIEZJWDogVXBkYXRlIHBhcnRpY2xlcyBkdXJpbmcgZ2FtZXBsYXkgd2l0aCBzYWZlIERUCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShNYXRoLm1heCgwLjAwMSwgZHQpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVBdWRpb1N0YXRlKCk7CnRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgovLyBLZWVwIEJHTSBwbGF5aW5nIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGVsZCA9ICEhYmFsbC5ob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIb21lIHNjb3JpbmcgZW5kIChHb2FsIGF0IC1aKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKE5lZ2F0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA8IC0wLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBd2F5IHNjb3JpbmcgZW5kIChHb2FsIGF0ICtaKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKFBvc2l0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU5DUkVNRU5UIFNDT1JFCiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlW3Njb3Jlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBHT0FMISAke3Njb3Jlcn0gc2NvcmVzLiBOZXcgU2NvcmU6IEhvbWUgJHt0aGlzLnNjb3JlLmhvbWV9IC0gQXdheSAke3RoaXMuc2NvcmUuYXdheX1gKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgIHRoaXMuYWRkSFVEU2hha2UoMjAuMCk7IC8vIEhVRCBTaGFrZQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCQVJSSUVSIFNIQVRURVIgTE9HSUMKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIEhvbWUgc2NvcmVzIGF0IC1aIChBd2F5IEdvYWwpLCBBd2F5IHNjb3JlcyBhdCArWiAoSG9tZSBHb2FsKQogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChzY29yZXIgPT09ICdob21lJykgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhcnJpZXIgPSAoc2NvcmVyID09PSAnaG9tZScpID8gdGhpcy5zdGFkaXVtLmJhcnJpZXJBIDogdGhpcy5zdGFkaXVtLmJhcnJpZXJCOwogICAgICAgICAgICAgICAgaWYgKGJhcnJpZXIpIGJhcnJpZXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxWZWwgPSB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcndhcmQgPSBiYWxsVmVsLmNsb25lKCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEltcGFjdCBQb2ludCBvbiBHb2FsIFBsYW5lIChUaGUgIkludmlzaWJsZSBCYXJyaWVyIikKICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFBvcyA9IGJhbGxQb3MuY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIFNuYXAgZWZmZWN0IHRvIHRoZSBiYXJyaWVyIHBsYW5lIChaKSBidXQga2VlcCBYL1kgb2YgZW50cnkKICAgICAgICAgICAgICAgIGltcGFjdFBvcy56ID0gZ29hbFo7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEdsYXNzIFNoYXR0ZXIgRWZmZWN0IChUaGUgSG9sZSkKICAgICAgICAgICAgICAgIHRoaXMuX3RyaWdnZXJHbGFzc1NoYXR0ZXIoaW1wYWN0UG9zLCBiYWxsVmVsKTsKCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRyaWFuZ2xlIEZyYW1lIFNoYXR0ZXIgKFRoZSBCYXJyaWVyKQogICAgICAgICAgICAgICAgdGhpcy5fc3Bhd25UcmlhbmdsZVNoYXR0ZXIoZ29hbFosIGZvcndhcmQpOwoKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDIwLjAsIGxpZmU6IDAuNiwgY29sb3I6IDB4MDBmZmZmIH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgaW1wYWN0UG9zLCB7IHNjYWxlOiAxMi4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSyAoU3VkZGVuIERlYXRoKQogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsb3cgbW90aW9uIGZpbmlzaAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjI7CgogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkgKDAuNXMgZ2FtZSB0aW1lIGF0IDAuMiBzY2FsZSA9IDIuNXMgcmVhbCB0aW1lKQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2xkZW5fZ29hbCc7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2dvYWwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMgKDIuMHMgZ2FtZSB0aW1lKQogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAyLjA7CiAgICAgICAgICAgIHRoaXMubmV4dFN0YXRlUGF5bG9hZCA9IGxvc2VyOwogICAgICAgIH0KCl9zcGF3blRyaWFuZ2xlU2hhdHRlcih6UG9zLCBmb3J3YXJkRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFRyaWFuZ2xlIFZlcnRpY2VzIChNYXRjaGVzIFN0YWRpdW0uanMgZ2VvbWV0cnkpCiAgICAgICAgICAgIC8vIFRvcCBZOiAxMi4wLCBCb3R0b20gWTogLTYuMC4gV2lkdGggYXQgdG9wOiAyOC4wICgrLy0gMTQuMCkuCmNvbnN0IHYxID0geyB4OiAtMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjIgPSB7IHg6IDE0LCB5OiA5IH07CiAgICAgICAgICAgIGNvbnN0IHYzID0geyB4OiAwLCB5OiAtNiB9OwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZWRnZXMgPSBbCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MSwgZW5kOiB2MiB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjIsIGVuZDogdjMgfSwKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYzLCBlbmQ6IHYxIH0KICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBkZW5zaXR5IGZvciAiYXBwZWFyaW5nIiBlZmZlY3QKLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdApjb25zdCBwYXJ0aWNsZXNQZXJFZGdlID0gNDsgLy8gUmVkdWNlZCBmcm9tIDEyIGZvciBsZXNzIGNsdXR0ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgIGVkZ2VzLmZvckVhY2goZWRnZSA9PiB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBwYXJ0aWNsZXNQZXJFZGdlOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gaSAvIHBhcnRpY2xlc1BlckVkZ2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IGVkZ2Uuc3RhcnQueCArIChlZGdlLmVuZC54IC0gZWRnZS5zdGFydC54KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGVkZ2Uuc3RhcnQueSArIChlZGdlLmVuZC55IC0gZWRnZS5zdGFydC55KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgelBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHNvbWUgcmFuZG9tbmVzcwogICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogT3V0d2FyZCBmcm9tIGNlbnRlciBvZiB0cmlhbmdsZSAoYXBwcm94IDAsIDQpICsgRm9yd2FyZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHsgeDogMCwgeTogMS41IH07IC8vIFJvdWdoIGNlbnRlciBvZiBtYXNzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoeCAtIGNlbnRlci54LCB5IC0gY2VudGVyLnksIDApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGRpci5tdWx0aXBseVNjYWxhcig4LjAgKyBNYXRoLnJhbmRvbSgpICogMTIuMCk7CiAgICAgICAgICAgICAgICAgICAgdmVsLmFkZChmb3J3YXJkRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMjAuMCkpOyAvLyBTdHJvbmcgZm9yd2FyZCBtb21lbnR1bQoKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogNi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS41ICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4NDRhYWZmLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxMC4wLCAvLyBTcGluCiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KSAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBvbiBwZXJpbWV0ZXIgdG8gb3V0bGluZSB0aGUgc2hhcGUgYXMgaXQgYnJlYWtzCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuMywgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX3RyaWdnZXJHbGFzc1NoYXR0ZXIocG9zLCB2ZWwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IHZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWF4KDIwLjAsIHZlbC5sZW5ndGgoKSk7IC8vIEVuc3VyZSBtaW5pbXVtIGV4cGxvc2lvbiBzcGVlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCi8vIDEuIFRoZSAiUGFuZSIgKFJhZGlhbCBidXJzdCBvbiB0aGUgZ29hbCBwbGFuZSkKICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHRoZSBiYXJyaWVyIHNoYXR0ZXJpbmcgb3V0d2FyZApjb25zdCBzaGFyZENvdW50ID0gMTU7IC8vIFJlZHVjZWQgZnJvbSA1MAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxzaGFyZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAxMC4wOyAvLyBMYXJnZXIgcmFkaXVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGguY29zKGFuZ2xlKSAqIHIsIE1hdGguc2luKGFuZ2xlKSAqIHIsIDApOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSBpcyByYWRpYWwgb3V0d2FyZCBmcm9tIGltcGFjdCBjZW50ZXIKICAgICAgICAgICAgICAgIGNvbnN0IHJhZGlhbERpciA9IG9mZnNldC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSByYWRpYWxEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCArIE1hdGgucmFuZG9tKCkgKiAyNS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQWRkIGZvcndhcmQgbW9tZW50dW0gKFRoZSBiYWxsIHB1bmNoZXMgdGhyb3VnaCkKICAgICAgICAgICAgICAgIHNoYXJkVmVsLmFkZChmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAwLjgpKTsKICAgICAgICAgICAgICAgIAp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwLCB7CiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHNoYXJkVmVsLAogICAgICAgICAgICAgICAgICAgIHNjYWxlOiA2LjAgKyBNYXRoLnJhbmRvbSgpICogOC4wLCAKICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIgKyBNYXRoLnJhbmRvbSgpICogMC44LAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDI1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4YWFmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7IC8vIFJlZHVjZWQgZnJvbSAyMAogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIHN0YXJ0IHBvcyBzbGlnaHRseSAoaW1wYWN0IHpvbmUpCiAgICAgICAgICAgICAgICBwLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgcC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDQuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHk6IE1vc3RseSBmb3J3YXJkLCBzb21lIHNwcmVhZAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSBmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAoMS4wICsgTWF0aC5yYW5kb20oKSAqIDAuNSkpOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDUuMCArIE1hdGgucmFuZG9tKCkgKiA3LjAsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMi4wICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAxNS4wLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyMC4wLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEltcGFjdCBGbGFzaCAmIFNvdW5kCiAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogMTUuMCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxMC4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEhpZ2ggcGl0Y2ggaW1wYWN0IHRvIHNpbXVsYXRlIGdsYXNzIGJyZWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wLCByYXRlOiAyLjUgfSk7IAogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCB3aG9vc2gKICAgICAgICAgICAgfQogICAgICAgIH0KCnNob3dBbm5vdW5jZW1lbnQodGV4dCwgdHlwZSA9ICdub3JtYWwnLCBkdXJhdGlvbiA9IDIwMDApIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLmFubm91bmNlbWVudDsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgcHJldmlvdXMgdGltZW91dAogICAgICAgICAgICBpZiAodGhpcy5fYW5ub3VuY2VUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fYW5ub3VuY2VUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbiBieSBjbG9uaW5nCiAgICAgICAgICAgIGNvbnN0IG5ld0VsID0gZWwuY2xvbmVOb2RlKHRydWUpOwogICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdFbCwgZWwpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IG5ld0VsOwoKICAgICAgICAgICAgbmV3RWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgbmV3RWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDbGFzcyBiYXNlZCBvbiB0eXBlCiAgICAgICAgICAgIG5ld0VsLmNsYXNzTmFtZSA9ICcnOyAvLyBSZXNldCBjbGFzc2VzCiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2xhbScpIHsKICAgICAgICAgICAgICAgIG5ld0VsLmNsYXNzTGlzdC5hZGQoJ2Fubm91bmNlbWVudC1zbGFtJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHN0eWxlCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBuZXdFbC5vZmZzZXRIZWlnaHQ7IC8qIHRyaWdnZXIgcmVmbG93ICovCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZQogICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZUFubm91bmNlbWVudCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRSb3VuZChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAncmVzZXQnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgcGVyc2lzdGVudCB2aXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmdseXBoTWFuYWdlcikgdGhpcy5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHRoaXMucG93ZXJVcE1hbmFnZXIucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogQ2xlYXIgcGFydGljbGVzIGlmIG5lZWRlZCwgdGhvdWdoIHRoZXkgc2VsZi1leHBpcmUgcXVpY2tseQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXN0b3JlIEJhcnJpZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckEpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckIpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQi52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuMTsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gcG9zc2Vzc2lvblRlYW1JZDsKICAgICAgICB9CgoKc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseQogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIHN0YW5kYXJkIGtpY2tvZmYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IHRoaXMudGVhbXNbcG9zc2Vzc2lvblRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAodGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1mID0gdGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgICAgIGlmIChtZiAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5iYWxsLmdyYWIobWYpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gbmV3IGhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KG1mLm1lc2gsIG1mLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAp0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC44OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTkVVVFJBTCBLSUNLT0ZGOiAiVGhlIEJsaXR6IE9mZiIgQ2luZW1hdGljIFNlcXVlbmNlCiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydE5ldXRyYWxCbGl0ek9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCl9zdGFydE5ldXRyYWxCbGl0ek9mZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9jaGFyZ2UnOwogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gUmVzZXQgQmFsbCB0byBDZW50ZXIgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgYmFsbC5kcm9wKCk7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KDAsIC01LCAwKTsgLy8gU3RhcnQgREVFUCAoLTVtKSBmb3IgImdyb3VuZCB1cCIgcmlzZQogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB2aXN1YWxzCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBQb3NpdGlvbiBDYXB0YWlucyAoTUZzKQogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoaG9tZU1GICYmIGhvbWVNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGhvbWVNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheU1GICYmIGF3YXlNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBhd2F5TUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIENhbWVyYSBGb2N1cwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyICYmIGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KGJhbGwubWVzaCwgbnVsbCk7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAvLyBab29tIGluIHRpZ2h0CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gLTEyOyAKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC40OyAvLyBMb29rIGRvd24gc3RlZXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQnVpbGQgVGVuc2lvbgogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlJFQURZLi4uIiwgJ25vcm1hbCcpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC41IH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUR1cmF0aW9uID0gMi4wOyAvLyBMb25nZXIgYnVpbGQgdXAgZm9yIGNpbmVtYXRpYyBmZWVsCgogICAgICAgICAgICAvLyBQSEFTRSAxOiBDSEFSR0UgKFJpc2luZyBmcm9tIGRlcHRocykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA8IGNoYXJnZUR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5ibGl0elRpbWVyIC8gY2hhcmdlRHVyYXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBlYXNlVCA9IHQgKiB0OyAvLyBRdWFkcmF0aWMgZWFzZSBpbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSaXNlIGZyb20gLTUgdG8gMCAoR3JvdW5kIHVwIGVmZmVjdCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi55ID0gLTUuMCArICg1LjAgKiBlYXNlVCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdXAgKEV4cG9uZW50aWFsKQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnkgKz0gKDEwLjAgKyA1MC4wICogdCkgKiBkdDsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi54ICs9ICg1LjAgKyAyMC4wICogdCkgKiBkdDsKCiAgICAgICAgICAgICAgICAvLyBTcXVhc2ggKEZsYXR0ZW4gbGlrZSBhIGRpc2MgYnVpbGRpbmcgZW5lcmd5KQogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJlbWUgc3F1YXNoIGF0IHRoZSBlbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLSAoMC43ICogZWFzZVQpOyAvLyBGbGF0dGVuIFkgdG8gMC4zCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArICgwLjUgKiBlYXNlVCk7IC8vIEV4cGFuZCBYWgogICAgICAgICAgICAgICAgICAgIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3RyZXRjaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgaW5jcmVhc2luZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMiAqIHQpOwoKICAgICAgICAgICAgICAgIC8vIFBhcnRpY2xlczogUmlzaW5nIEVuZXJneSBmcm9tIGdyb3VuZAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlcyByaXNpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5mbG9vcih0ICogOCkgKyAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAyLjAgKiAoMS4wIC0gdCk7IC8vIFJhZGl1cyBzaHJpbmtzIGFzIGl0IGdldHMgY2xvc2VyIHRvIGxhdW5jaAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBiYWxsLm1lc2gucG9zaXRpb24ueSAtIDEuMDsgLy8gQmVsb3cgYmFsbAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIG5ldyBUSFJFRS5WZWN0b3IzKHgsIHksIHopLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC40LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjIgKyB0ICogMC41IAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBIQVNFIDI6IExBVU5DSAogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnYmxpdHpfY2hhcmdlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9sYXVuY2gnOwogICAgICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsgLy8gUmVzZXQgZm9yIGxhdW5jaCBwaGFzZQoKICAgICAgICAgICAgICAgIC8vIFRJTUVEIEFOTk9VTkNFTUVOVAogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAgfSk7IC8vIEJvb20KICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCB9KTsgICAvLyBXaG9vc2gKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBMYXVuY2ggQmFsbAogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMzUsIDApOyAvLyBTaG9vdCBVUCBGQVNUCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDAuNCwgMy4wLCAwLjQpOyAvLyBFeHRyZW1lIHN0cmV0Y2ggdmVydGljYWwKCiAgICAgICAgICAgICAgICAvLyBGWDogTWFzc2l2ZSBHcm91bmQgRXJ1cHRpb24KICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDguMCB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDYuMCB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBzdHJlYW0KICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwxMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC55ICs9IGkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHAsIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gMTA7IC8vIFpvb20gb3V0IGZhc3QKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuMDsgLy8gTGV2ZWwgb3V0CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FwdGFpbnMgSnVtcAogICAgICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgICAgICBjb25zdCBqdW1wVG8gPSAocCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAxLjI7IC8vIFN0ZWVwIGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmNvcHkoZGlyKS5tdWx0aXBseVNjYWxhcigxOC4wKTsgLy8gRmFzdCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaF9qdW1wJywgMC4xKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganVtcFRvKGhvbWVNRik7CiAgICAgICAgICAgICAgICBqdW1wVG8oYXdheU1GKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGdyYXZpdHkgbWFudWFsbHkgZm9yIGNpbmVtYXRpYyBmZWVsIChJbmNyZWFzZWQgZ3Jhdml0eSBmb3Igc25hcHBpZXIgYXJjKQogICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnkgLT0gNDAuMCAqIGR0OyAKICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCBkdCk7CgogICAgICAgICAgICAvLyBNb3ZlIFBsYXllcnMgbWFudWFsbHkKICAgICAgICAgICAgY29uc3QgdXBkYXRlSnVtcGVyID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnkgLT0gMjUuMCAqIGR0OyAvLyBHcmF2aXR5CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihob21lTUYpOwogICAgICAgICAgICB1cGRhdGVKdW1wZXIoYXdheU1GKTsKCiAgICAgICAgICAgIC8vIFBIQVNFIDM6IEdSQUIgKEFwZXggfjAuN3MpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPiAwLjcgJiYgdGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBXaW5uZXIgKDUwLzUwICsgU3RhdCBiaWFzKQogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNwID0gaG9tZU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5U3AgPSBhd2F5TUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gaG9tZVNwICsgYXdheVNwOwogICAgICAgICAgICAgICAgY29uc3Qgcm9sbCA9IE1hdGgucmFuZG9tKCkgKiB0b3RhbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2lubmVyID0gKHJvbGwgPCBob21lU3ApID8gaG9tZU1GIDogYXdheU1GOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBiYWxsLmdyYWIod2lubmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiV09OISIsIHdpbm5lci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyYW5zaXRpb24gdG8gQWN0aXZlCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIHdpbm5lcgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQod2lubmVyLm1lc2gsIHdpbm5lci52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOyAvLyBPcHRpb25hbDogS2VlcCBzbW9vdGggb3Igc25hcAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CnRoaXMuX3VwZGF0ZVNjb3JlVUkodHJ1ZSk7IC8vIFJlc2V0IHNjb3JlIGRpc3BsYXkgd2l0aG91dCBzbGFtIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgpzdGFydEludHJvU2VxdWVuY2UoKSB7CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ludHJvJzsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsgLy8gUmVzZXQgcm9hciBmbGFnCiAgICAgICAgICAgIC8vIFN0b3AgQkdNIGZvciBjaW5lbWF0aWMgaW50cm8gKGxldCBTRlggc2hpbmUpCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnRleHQgaXMgcnVubmluZyBmb3IgaW50cm8gU0ZYCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsIHNldHVwCiAgICAgICAgICAgIC8vIEhJREUgQUxMIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLCAKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsIAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsIAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcsCiAgICAgICAgICAgICAgICAnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICB1aUVsZW1lbnRzLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICBpZiAoZWwpIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gU2hvdyBDaW5lbWF0aWMgQmFycwogICAgICAgICAgICBjb25zdCBiYXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NpbmVtYXRpYy1iYXJzJyk7CiAgICAgICAgICAgIGlmIChiYXJzKSB7CiAgICAgICAgICAgICAgICBiYXJzLnF1ZXJ5U2VsZWN0b3JBbGwoJy5iYXInKS5mb3JFYWNoKGIgPT4gYi5zdHlsZS5oZWlnaHQgPSAnMTAlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIGZpcnN0IHNob3Qgc3RhcnQKICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90cyAmJiB0aGlzLmludHJvU2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90c1swXS5vblN0YXJ0KSB0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZUludHJvV2FybXVwKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1peGVyIHVwZGF0ZXMgKHNpbmNlIGdhbWUgbG9vcCBtaWdodCBza2lwIHBsYXllci51cGRhdGUgaW4gaW50cm8gc3RhdGUpCiAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgd2FybXVwIHRpbWVyIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyID09PSB1bmRlZmluZWQpIHAuX3dhcm11cFRpbWVyID0gTWF0aC5yYW5kb20oKSAqIDIuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5fd2FybXVwVGltZXIgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBQaWNrIG5leHQgYWN0aW9uIHRpbWUgKDJzIHRvIDVzKQogICAgICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyID0gMi4wICsgTWF0aC5yYW5kb20oKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuNikgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ3N3aW0nLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3RyZXRjaCIgLyBDZWxlYnJhdGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjZWxlYnJhdGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC41KTsgLy8gQ2hlY2tpbmcgZ2xvdmVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdyZWFjdCcsIDAuNSk7IC8vIFNoYWtlIG9mZgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyAodHJlYWRpbmcgd2F0ZXIpCiAgICAgICAgICAgICAgICBpZiAocC5ob21lUG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMgKyBwLm1lc2guaWQpICogMC4zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gUGxheSBCR00gaW4gbWVudQogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgbWF0Y2ggdGVuc2lvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyLnNldE1hdGNoU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3Qgc3RhdGljVUkgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsCiAgICAgICAgICAgICAgICAncGxheWVyLXN0YXR1cy1wYW5lbCcsCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnZ29hbC1kaXN0YW5jZS1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBMaXN0IG9mIGR5bmFtaWMgZWxlbWVudHMgdG8gRk9SQ0UgSElERSBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNVSSA9IFsKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJywKICAgICAgICAgICAgICAgICd0ZWNoLWZsYXNoLW92ZXJsYXknLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBISURFIEFMTAogICAgICAgICAgICAgICAgWy4uLnN0YXRpY1VJLCAuLi5keW5hbWljVUldLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU0hPVyBTVEFUSUMgT05MWQogICAgICAgICAgICAgICAgc3RhdGljVUkuZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PT0gJ2h1ZC10b3AnIHx8IGlkID09PSAnYWN0aW9uLWNvbnRhaW5lcicpIGVsLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIG9uZXMgcmVtYWluIGhpZGRlbi9jb250cm9sbGVkIGJ5IHRoZWlyIGxvZ2ljCiAgICAgICAgICAgIH0KICAgICAgICB9CnRvZ2dsZURlbW9Nb2RlKCkgewogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSAhdGhpcy5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiRGVtbyBNb2RlOiIsIHRoaXMuaXNEZW1vTW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkgQnV0dG9uCiAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgICAgICBpZiAoYnRuKSB7CiAgICAgICAgICAgICAgICBidG4uaW5uZXJUZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBjb25zdCB0ZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCh0ZXh0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGbGFpcjogU3Bhd24gdGV4dCBhYm92ZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUgJiYgdGhpcy5mbG9hdGluZ1RleHQgJiYgdGhpcy50ZWFtcy5ob21lICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiQUkgRU5HQUdFRCIsIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlIGFubm91bmNlbWVudApzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCAmJiB0aGlzLnVpLmFubm91bmNlbWVudC5pbm5lclRleHQgPT09IHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMTUwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVEVDSENPUFkgU1lTVEVNIC0tLQoKICAgICAgICB0cmlnZ2VyVGVjaEV2ZW50KHNvdXJjZVBsYXllciwgdGVjaE5hbWUpIHsKICAgICAgICAgICAgaWYgKCFzb3VyY2VQbGF5ZXIgfHwgIXNvdXJjZVBsYXllci50ZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIG9wcG9zaW5nIHRlYW0KICAgICAgICAgICAgY29uc3Qgb3BwVGVhbUlkID0gc291cmNlUGxheWVyLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IHRoaXMudGVhbXNbb3BwVGVhbUlkXTsKICAgICAgICAgICAgaWYgKCFvcHBUZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIHdobyBpcyBtYXJraW5nIHRoaXMgc291cmNlCiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gb3BwVGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IHAubWFya2luZyA9PT0gc291cmNlUGxheWVyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChsZWFybmVycy5sZW5ndGggPT09IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9ubHkgc2hvdyBVSSBpZiB0aGUgbGVhcm5pbmcgdGVhbSBpcyBIdW1hbiAoSG9tZSkKICAgICAgICAgICAgLy8gKE9yIGlmIHdlIGFyZSBpbiBEZW1vIG1vZGUgYW5kIHdhbnQgdG8gc2VlIGl0IGhhcHBlbiBmb3IgSG9tZSB0ZWFtKQogICAgICAgICAgICBpZiAob3BwVGVhbS5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IHRob3NlIHdobyBhbHJlYWR5IGtub3cgaXQKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTGVhcm5lcnMgPSBsZWFybmVycy5maWx0ZXIocCA9PiAhcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaE5hbWUpKTsKICAgICAgICAgICAgICAgIGlmICh2YWxpZExlYXJuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIHZhbGlkTGVhcm5lcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgbGVhcm5lcnMpIHsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lID0gMC42OyAvLyAwLjZzIHdpbmRvdwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPSB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRlY2ggPSB0ZWNoTmFtZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzID0gbGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IFVJCmlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb250ZXh0IGlzIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOyAvLyBIaXQgc3RvcCBkaXNhYmxlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIEhVRCBTaGFrZSBiYXNlZCBvbiBpbXBhY3QgdHlwZQogICAgICAgICAgICBsZXQgc2hha2VBbW91bnQgPSA1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBzaGFrZUFtb3VudCA9IDE1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIHNoYWtlQW1vdW50ID0gMzAuMDsKICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZShzaGFrZUFtb3VudCk7CgogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0IHRvIHByZXZlbnQgZWFybHkgcmVtb3ZhbCBvZiBuZXcgY2xhc3MKICAgICAgICAgICAgaWYgKHRoaXMuX2ltcGFjdFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9pbXBhY3RUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBjbGFzc2VzIHRvIGVuc3VyZSBhbmltYXRpb24gcmVzdGFydHMgKHJlZmxvdyB0cmljaykKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ltcGFjdC1meCcsICdpbXBhY3QtaGVhdnknLCAnaW1wYWN0LXNoYXR0ZXInKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcmNlIHJlZmxvdwogICAgICAgICAgICB2b2lkIGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKCiAgICAgICAgICAgIGxldCBjbGFzc05hbWUgPSAnaW1wYWN0LWZ4JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIGNsYXNzTmFtZSA9ICdpbXBhY3QtaGVhdnknOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NoYXR0ZXInKSBjbGFzc05hbWUgPSAnaW1wYWN0LXNoYXR0ZXInOwoKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVtb3ZlIGNsYXNzIGFmdGVyIGR1cmF0aW9uICsgYnVmZmVyIGZvciBhbmltYXRpb24gdGFpbAogICAgICAgICAgICAvLyBXZSBhZGQgYSBiaXQgbW9yZSB0aW1lIHRoYW4gdGhlIHBhdXNlIGR1cmF0aW9uIHRvIGxldCB0aGUgQ1NTIGFuaW1hdGlvbiBmaW5pc2gKICAgICAgICAgICAgY29uc3QgYW5pbUR1cmF0aW9uID0gKHR5cGUgPT09ICdzaGF0dGVyJyA/IDUwMCA6ICh0eXBlID09PSAnaGVhdnknID8gMjUwIDogMTUwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0sIGFuaW1EdXJhdGlvbik7CiAgICAgICAgfQoKICAgICAgICBhZGRIVURTaGFrZShhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IE1hdGgubWluKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgKyBhbW91bnQsIDUwLjApOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhVRFNoYWtlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgLy8gRGVjYXkKICAgICAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgLT0gZHQgKiA2MC4wOyAvLyBEZWNheSBhcHByb3ggNjBweCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5odWRTaGFrZUludGVuc2l0eSA8IDApIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5OwogICAgICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4KWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIG1haW4gSFVEIGNvbnRhaW5lcnMKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgICAgICAvLyBQcmVzZXJ2ZSBleGlzdGluZyBza2V3CiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzUGFuZWwpIHN0YXR1c1BhbmVsLnN0eWxlLnRyYW5zZm9ybSA9IGBza2V3WCgtMTBkZWcpICR7dHJhbnNmb3JtfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CgogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faHVkU2hha2VEaXJ0eSkgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gY2xlYW4gc3RhdGUKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gJ3NrZXdYKC0xMGRlZyknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25Db250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICAgICAgaWYgKGFjdGlvbkNvbnRhaW5lcikgYWN0aW9uQ29udGFpbmVyLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlQXVkaW9TdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRlbnNpb24gPSAwOwoKICAgICAgICAgICAgLy8gMS4gQmFsbCBUaHJlYXQKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJyB8fCB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgY29uc3QgeiA9IGJhbGwubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGgubWluKE1hdGguYWJzKHogLSBnb2FsRGlzdCksIE1hdGguYWJzKHogKyBnb2FsRGlzdCkpOwogICAgICAgICAgICAgICAgY29uc3QgdGhyZWF0UmFuZ2UgPSAzNS4wOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFRocmVhdCA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0VG9Hb2FsIC8gdGhyZWF0UmFuZ2UpKTsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gYmFsbFRocmVhdCAqIGJhbGxUaHJlYXQ7IC8vIFF1YWRyYXRpYyByYW1wCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjb3JlIFByZXNzdXJlIChDbG9zZSBnYW1lKQogICAgICAgICAgICBjb25zdCBkaWZmID0gTWF0aC5hYnModGhpcy5zY29yZS5ob21lIC0gdGhpcy5zY29yZS5hd2F5KTsKICAgICAgICAgICAgaWYgKGRpZmYgPD0gMSkgdGVuc2lvbiArPSAwLjE1OwoKICAgICAgICAgICAgLy8gMy4gVGltZSBQcmVzc3VyZSAoTGFzdCBtaW51dGUpCiAgICAgICAgICAgIGNvbnN0IHRpbWVMZWZ0ID0gdGhpcy5oYWxmRHVyYXRpb24gLSB0aGlzLnRpbWU7CiAgICAgICAgICAgIGlmICh0aW1lTGVmdCA8IDYwICYmIHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0ZW5zaW9uICs9IDAuMiAqICgxLjAgLSAodGltZUxlZnQgLyA2MCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCB0aGlzLmlzT3ZlcnRpbWUpOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3VwZGF0ZUVudmlyb25tZW50YWxGWChkdCkgewogICAgICAgICAgICAvLyBPbmx5IGluIGFjdGl2ZSBnYW1lIG9yIG1lbnUKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gKHRoaXMuX2VudkJ1YmJsZVRpbWVyIHx8IDApIC0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5fZW52QnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gUmFuZG9tIGludGVydmFsOiAwLjJzIHRvIDAuOHMgKEZyZXF1ZW50IHN0cmVhbXMpCiAgICAgICAgICAgICAgICB0aGlzLl9lbnZCdWJibGVUaW1lciA9IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIFBpY2sgYSByYW5kb20gc3BvdCBvbiB0aGUgZmxvb3IKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNzA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDkwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHlCYXNlID0gLTIwOyAvLyBEZWVwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gYSAiU3RyZWFtIiAoQnVyc3Qgb2YgYnViYmxlcyByaXNpbmcgdG9nZXRoZXIpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSAzICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZWFtU3BlZWQgPSAzLjAgKyBNYXRoLnJhbmRvbSgpICogNC4wOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ICsgKE1hdGgucmFuZG9tKCktMC41KSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlIC0gKE1hdGgucmFuZG9tKCkgKiA1LjApLCAvLyBTdGFnZ2VyZWQgc3RhcnQgZGVwdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHogKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlX21pY3JvJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogMi4wLCAvLyBMb25nIGxpZmUgdG8gcmVhY2ggdG9wCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wOCArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBTaGltbWVyeSBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtU3BlZWQgKyAoTWF0aC5yYW5kb20oKSAqIDIuMCksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfYWR2YW5jZVN0YXRlKCkgewogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuc3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvYWwnOgogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCh0aGlzLm5leHRTdGF0ZVBheWxvYWQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncmVzZXQnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdraWNrb2ZmJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdoYWxmdGltZSc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Vjb25kSGFsZigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBPVCBvciBFbmQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdnb2xkZW5fZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7IC8vIFJlc3RvcmUgc3BlZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","/GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7CiAgICAgICAgICAgIHRoaXMudWlMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpTGF5ZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNjb3JlID0geyBob21lOiAwLCBhd2F5OiAwIH07CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDE7CiAgICAgICAgICAgIHRoaXMuaGFsZkR1cmF0aW9uID0gMzAwOyAvLyA1IG1pbnV0ZXMgKHNlY29uZHMpCiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSBmYWxzZTsKdGhpcy5nYW1lTW9kZSA9ICdub3JtYWwnOyAvLyAnbm9ybWFsJyBvciAncHJhY3RpY2UnCiAgICAgICAgICAgIHRoaXMuaXNGb3JnZU1vZGUgPSBmYWxzZTsgLy8gQXNzZXQgRm9yZ2UgU3RhdGUKICAgICAgICAgICAgLy8gSW1wYWN0IEZyYW1lcwp0aGlzLmltcGFjdFBhdXNlID0gMDsKICAgICAgICAgICAgLy8gLS0tIEhVRCBTaGFrZSBTeXN0ZW0gLS0tCiAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwp0aGlzLl9odWRTaGFrZURpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZVBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wb3dlclVwTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5Qb3dlclVwTWFuYWdlcihzY2VuZSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFyZW5hIFRoZW1lIE1hbmFnZXIgJiBBcHBseSBEZWZhdWx0CiAgICAgICAgICAgIHRoaXMuYXJlbmFUaGVtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIoc2NlbmUsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFyZW5hVGhlbWVNYW5hZ2VyLnNldFRoZW1lKCdTVEFOREFSRCcpOwoKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHdpbmdQdWxzZSB7CiAgICAgICAgICAgICAgICAgICAgMCUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KSBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSkpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLndpbmctcHVsc2UgewogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogd2luZ1B1bHNlIDAuNHMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXJUZWFtcyhob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpIHsKICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheSA9IGF3YXlUZWFtOwp0aGlzLmVudGl0aWVzLmJhbGwgPSBiYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBNaW5pTWFwCiAgICAgICAgICAgIGlmICh0aGlzLm1pbmlNYXApIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaU1hcC5pbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFVJKCkgewogICAgICAgICAgICAvLyBCaW5kIHRvIGV4aXN0aW5nIEhUTUwgZWxlbWVudHMgKEhlcmN1bGVhbiBIVUQpCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJpbmQgV2luZ3MgZm9yIEp1aWNlCiAgICAgICAgICAgIHRoaXMudWkud2luZ0hvbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5ob21lJyk7CiAgICAgICAgICAgIHRoaXMudWkud2luZ0F3YXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Itd2luZy5hd2F5Jyk7CiAgICAgICAgICAgIC8vIFRlY2hjb3B5IFVJIGJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlY2gtZmxhc2gtb3ZlcmxheScpOwogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1YiA9IHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXN1Yi10ZXh0Jyk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5uYW1lID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLmNoYXItbmFtZScpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IHRoaXMudWkuc3RhdHVzUGFuZWwuY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoJy5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcuaHAtdmFsdWUnKTsKICAgICAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuZXhwQmFyID0gdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIucXVlcnlTZWxlY3RvcignLnRlY2gtYmFyLWZpbGwnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICBpZiAodGhpcy51aS50aW1lcikgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSAiMDA6MDAiOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRydWUpOyAvLyBGb3JjZSBpbml0aWFsIHJlbmRlciB3aXRob3V0IGFuaW1hdGlvbgogICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgIH0KCl91cGRhdGVTY29yZVVJKHNraXBBbmltYXRpb24gPSBmYWxzZSkgewogICAgICAgICAgICBjb25zdCBob21lRWwgPSB0aGlzLnVpLnNjb3JlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhd2F5RWwgPSB0aGlzLnVpLnNjb3JlQ3B1OwogICAgICAgICAgICBjb25zdCBob21lV2luZyA9IHRoaXMudWkud2luZ0hvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXlXaW5nID0gdGhpcy51aS53aW5nQXdheTsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBhbmltYXRlIChTbGFtIEVmZmVjdCkKICAgICAgICAgICAgY29uc3QgdXBkYXRlRWxlbWVudCA9IChlbCwgd2luZywgbmV3VmFsKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBwYXJzZUludChlbC5pbm5lclRleHQpIHx8IDA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgb3IgZm9yY2VkCiAgICAgICAgICAgICAgICBpZiAobmV3VmFsICE9PSBvbGRWYWwgfHwgc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVsLmlubmVyVGV4dCA9IG5ld1ZhbDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBSZWZsb3cgZm9yIEFuaW1hdGlvbiBSZXN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB2b2lkIGVsLm9mZnNldFdpZHRoOyAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZCgnc2NvcmUtdXBkYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkIHdpbmcub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5nLmNsYXNzTGlzdC5hZGQoJ3dpbmctcHVsc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjbGVhbiBzdGF0ZSBvbiBpbml0CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ3Njb3JlLXVwZGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZykgd2luZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5nLXB1bHNlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGhvbWVFbCkgdXBkYXRlRWxlbWVudChob21lRWwsIGhvbWVXaW5nLCB0aGlzLnNjb3JlLmhvbWUpOwogICAgICAgICAgICBpZiAoYXdheUVsKSB1cGRhdGVFbGVtZW50KGF3YXlFbCwgYXdheVdpbmcsIHRoaXMuc2NvcmUuYXdheSk7CiAgICAgICAgfQoKdXBkYXRlUHJhY3RpY2UoZHQpIHsKICAgICAgICAgICAgLy8gRGVsZWdhdGUgbG9naWMgdG8gUHJhY3RpY2VNYW5hZ2VyCiAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAtLS0gU1RBVEUgVElNRVIgTE9HSUMgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgLT0gZHQ7CmlmICh0aGlzLnN0YXRlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2VTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gUEhZU0lDUyAmIExPR0lDIFVQREFURSAoRml4ZWQgVGltZXN0ZXApIC0tLQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cm8gJiBNZW51IGFyZSBwdXJlbHkgdmlzdWFsIHN0YXRlcywgaGFuZGxlZCBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nIHx8IHRoaXMuc3RhdGUgPT09ICdtZW51JykgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9jaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekNoYXJnZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCbGl0ekxhdW5jaChkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCmlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrSGFsZlRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IExvZ2ljIChUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kVGVjaENvcHlXaW5kb3coZmFsc2UpOwogICAgICAgICAgICAgICAgfQp9CiAgICAgICAgICAgIC8vIFVwZGF0ZSBQb3dlclVwcwovLyBVcGRhdGUgUG93ZXJVcHMKLy8gVXBkYXRlIFBvd2VyVXBzCiAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyVXBNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvd2VyVXBNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBcmVuYSBIYXphcmRzIChQaHlzaWNzKQogICAgICAgICAgICBpZiAodGhpcy5hcmVuYVRoZW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hcmVuYVRoZW1lTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgLy8gUGxheWVyIFdhcm11cCBBbmltYXRpb25zCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVJbnRyb1dhcm11cChkdCk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmludHJvU2hvdHMgfHwgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90SW5kZXggPj0gdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNraXBJbnRybygpOyAvLyBEb25lCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IHNob3Qgc3RhcnQKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFNob3QgPSB0aGlzLmludHJvU2hvdHNbdGhpcy5pbnRyb1Nob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0U2hvdC5vblN0YXJ0KSBuZXh0U2hvdC5vblN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBzaG90CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuaW50cm9TaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSAmJiBzaG90LnVwZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9QVUxBVEUgQVJFTkEgRk9SIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFVJCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlICYmIHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUud2lkdGggPSBgJHtwY3R9JWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgIGlmIChwY3QgPCAzMCkgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnI2ZmMDAwMCc7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZiknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZW5lcmFsIFZpc3VhbHMgKEFsd2F5cyBSdW4gZXhjZXB0IEludHJvL01lbnUpCi8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDUklUSUNBTCBGSVg6IFVwZGF0ZSBwYXJ0aWNsZXMgZHVyaW5nIGdhbWVwbGF5Ci8vIENSSVRJQ0FMIEZJWDogVXBkYXRlIHBhcnRpY2xlcyBkdXJpbmcgZ2FtZXBsYXkgd2l0aCBzYWZlIERUCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHRoaXMucGFydGljbGVNYW5hZ2VyLnVwZGF0ZShNYXRoLm1heCgwLjAwMSwgZHQpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVBdWRpb1N0YXRlKCk7CnRoaXMuX3VwZGF0ZUF1ZGlvU3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlciAmJiB0aGlzLmF1ZGlvTWFuYWdlci51cGRhdGUpIHRoaXMuYXVkaW9NYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIVURTaGFrZShkdCk7IC8vIEFwcGx5IEhVRCBTaGFrZQogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlRW52aXJvbm1lbnRhbEZYKGR0KTsgLy8gQW1iaWVudCBCdWJibGVzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgX3VwZGF0ZUdvYWxUcmFuc3BhcmVuY3koKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jYW1lcmEpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3dpbmRvdy5mbHV4LmdvYWxBLCB3aW5kb3cuZmx1eC5nb2FsQl07CiAgICAgICAgICAgIGNvbnN0IGZhZGVEaXN0ID0gMzUuMDsgLy8gRGlzdGFuY2UgdG8gc3RhcnQgZmFkaW5nCiAgICAgICAgICAgIGNvbnN0IG1pbkZhZGVEaXN0ID0gMTUuMDsgLy8gRGlzdGFuY2Ugd2hlcmUgaXQncyBtb3N0IHRyYW5zcGFyZW50CiAgICAgICAgICAgIGNvbnN0IG1pbk9wYWNpdHkgPSAwLjI7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnb2FsKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGdvYWwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi5kaXN0YW5jZVRvKGdvYWwucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgb3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgZmFkZURpc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgZmFkZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZGlzdCAtIG1pbkZhZGVEaXN0KSAvIChmYWRlRGlzdCAtIG1pbkZhZGVEaXN0KTsKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHQsIDAuMCwgMS4wKSAqICgxLjAgLSBtaW5PcGFjaXR5KSArIG1pbk9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IG9wYWNpdHkgPCAwLjk5OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIGFsbCBtZXNoZXMgaW4gZ29hbCBoaWVyYXJjaHkKICAgICAgICAgICAgICAgIGdvYWwudHJhdmVyc2UoY2hpbGQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gY2hpbGQubWF0ZXJpYWw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiBjaGFuZ2VkIHRvIG1pbmltaXplIG92ZXJoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhtYXQub3BhY2l0eSAtIG9wYWNpdHkpID4gMC4wMSB8fCBtYXQudHJhbnNwYXJlbnQgIT09IGlzVHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGRlcHRoV3JpdGUgd2hlbiB0cmFuc3BhcmVudCBzbyB3ZSBjYW4gc2VlIHRoZSBiYWxsIGluc2lkZSB0aGUgbmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQuZGVwdGhXcml0ZSA9ICFpc1RyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKfQogICAgICAgIF91cGRhdGVPZmZzY3JlZW5JbmRpY2F0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUgPyB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gdGhpcy51aS5vZmZzY3JlZW5JbmRpY2F0b3I7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCB8fCAhdGhpcy5jYW1lcmEgfHwgIWluZGljYXRvcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gR2V0IFBsYXllciBQb3NpdGlvbiAoQ2VudGVyIE1hc3MpCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBwb3MueSArPSAxLjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUHJvamVjdCB0byBOb3JtYWxpemVkIERldmljZSBDb29yZGluYXRlcyAoTkRDKSBbLTEsIDFdCiAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMuY29weShwb3MpLnByb2plY3QodGhpcy5jYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gQ2hlY2sgaWYgQmVoaW5kIENhbWVyYQogICAgICAgICAgICBjb25zdCBjYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihjYW1Gd2QpOwogICAgICAgICAgICBjb25zdCB0b1BsYXllciA9IHBvcy5jbG9uZSgpLnN1Yih0aGlzLmNhbWVyYS5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGNhbUZ3ZC5kb3QodG9QbGF5ZXIpOwogICAgICAgICAgICBjb25zdCBpc0JlaGluZCA9IGRvdCA8IDAuMjsgLy8gQnVmZmVyIHRvIHByZXZlbnQgZmxpcHBpbmcgYXQgZWRnZQoKICAgICAgICAgICAgLy8gNC4gQ2hlY2sgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IGlzT2ZmU2NyZWVuID0gKAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy54IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnggPiAwLjkgfHwKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueSA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy55ID4gMC45IHx8CiAgICAgICAgICAgICAgICBpc0JlaGluZAogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzT2ZmU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB4ID0gdGhpcy5fdGVtcFZlYy54OwogICAgICAgICAgICAgICAgbGV0IHkgPSB0aGlzLl90ZW1wVmVjLnk7CgogICAgICAgICAgICAgICAgLy8gSWYgYmVoaW5kLCBpbnZlcnQgY29vcmRpbmF0ZXMgdG8gcG9pbnQgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAoaXNCZWhpbmQpIHsKICAgICAgICAgICAgICAgICAgICB4ID0gLXg7CiAgICAgICAgICAgICAgICAgICAgeSA9IC15OwogICAgICAgICAgICAgICAgICAgIC8vIEZpeCBzaW5ndWxhcml0eSBpZiBleGFjdGx5IGJlaGluZCBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoeCkgPCAwLjAxICYmIE1hdGguYWJzKHkpIDwgMC4wMSkgeSA9IC0xOyAKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDbGFtcCB0byBzY3JlZW4gZWRnZXMKICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gZmluZCB0aGUgaW50ZXJzZWN0aW9uIG9mIHRoZSB2ZWN0b3IgKHgseSkgd2l0aCB0aGUgYm94IFstMC45LCAwLjldCiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gMC45OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gZ2V0IGRpcmVjdGlvbgogICAgICAgICAgICAgICAgY29uc3QgbWFnID0gTWF0aC5zcXJ0KHgqeCArIHkqeSk7CiAgICAgICAgICAgICAgICBjb25zdCBueCA9IHggLyBtYWc7CiAgICAgICAgICAgICAgICBjb25zdCBueSA9IHkgLyBtYWc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgdG8gYm94IGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBlZGdlczogeCA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGVkZ2VzOiB5ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aWRlIGJ5IHplcm8KICAgICAgICAgICAgICAgIGNvbnN0IHR4ID0gKE1hdGguYWJzKG54KSA+IDAuMDAxKSA/IChueCA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnggOiA5OTk7CiAgICAgICAgICAgICAgICBjb25zdCB0eSA9IChNYXRoLmFicyhueSkgPiAwLjAwMSkgPyAobnkgPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG55IDogOTk5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG5lYXJlc3QgaW50ZXJzZWN0aW9uIChzbWFsbGVzdCBwb3NpdGl2ZSB0KQogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgYXJlIHByb2plY3RpbmcgZnJvbSBjZW50ZXIgKDAsMCkgdG8gKG54LG55KSwgdCBtdXN0IGJlIHBvc2l0aXZlLgogICAgICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKE1hdGguYWJzKHR4KSwgTWF0aC5hYnModHkpKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IG54ICogdDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblkgPSBueSAqIHQ7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBOREMgdG8gUGl4ZWxzCiAgICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBweCA9IChzY3JlZW5YICogMC41ICsgMC41KSAqIHdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcHkgPSAoLShzY3JlZW5ZKSAqIDAuNSArIDAuNSkgKiBoZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBBcnJvdyBwb2ludHMgVVAgYnkgZGVmYXVsdC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgaXQgdG8gcG9pbnQgaW4gZGlyZWN0aW9uIChueCwgbnkpIG9uIHNjcmVlbi4KICAgICAgICAgICAgICAgIC8vIFNjcmVlbiBZIGlzIGRvd24gKGludmVydGVkIGZyb20gV2ViR0wgWSkuCiAgICAgICAgICAgICAgICAvLyBTbyAoMCwgMSkgaW4gTkRDIGlzIFVQLiAoMCwgLTEpIGluIE5EQyBpcyBET1dOLgogICAgICAgICAgICAgICAgLy8gYXRhbjIoeSwgeCkgZ2l2ZXMgYW5nbGUgZnJvbSArWC4KICAgICAgICAgICAgICAgIC8vIFdlIHdhbnQgYW5nbGUgZnJvbSArWSAoVXApLgogICAgICAgICAgICAgICAgLy8gUm90YXRpb24gPSBQSS8yIC0gYW5nbGUuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihueSwgbngpOwogICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gKE1hdGguUEkgLyAyKSAtIGFuZ2xlOwoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cHh9cHgsICR7cHl9cHgpIHJvdGF0ZSgke3JvdH1yYWQpYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVGltZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS50aW1lcikgcmV0dXJuOwogICAgICAgICAgICAvLyBDbGFtcCB0byBoYWxmIGR1cmF0aW9uIGZvciBkaXNwbGF5IGlmIHdlIGdvIHNsaWdodGx5IG92ZXIgYmVmb3JlIHRpY2sKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKHRoaXMudGltZSwgdGhpcy5oYWxmRHVyYXRpb24pOwogICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcih0IC8gNjApOwogICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcih0ICUgNjApOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9IGAke21pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfToke3NlY29uZHMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgfQogICAgICAgIF9jaGVja0hhbGZUaW1lKCkgewogICAgICAgICAgICBpZiAodGhpcy50aW1lID49IHRoaXMuaGFsZkR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZEhhbGYoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCmVuZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGFsZnRpbWUnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSB3aGlzdGxlIHNvdW5kIGhlcmUgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSA0LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFbmQgb2YgMm5kIEhhbGYgb3IgT3ZlcnRpbWUgUGVyaW9kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29yZS5ob21lID09PSB0aGlzLnNjb3JlLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUSUVEIC0gR28gdG8gT3ZlcnRpbWUgKEdvbGRlbiBHb2FsIC8gU3VkZGVuIERlYXRoKQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiU1VEREVOIERFQVRIIiwgIk5FWFQgR09BTCBXSU5TIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDQuMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGFydFNlY29uZEhhbGYoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZiA9IDI7CiAgICAgICAgICAgIHRoaXMudGltZSA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMm5kIEhBTEYiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiI7IC8vIFJlc2V0IGNvbG9yCiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgewogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJTVURERU4gREVBVEgiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLmNvbG9yID0gIiNmZjQ0NDQiOyAvLyBSZWQgZm9yIGRhbmdlci91cmdlbmN5CiAgICAgICAgICAgICAgICB0aGlzLnVpLmhhbGYuc3R5bGUudGV4dFNoYWRvdyA9ICIwIDAgMTBweCAjZmYwMDAwIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobnVsbCk7IC8vIE5ldXRyYWwgQmxpdHotb2ZmCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZSBzdGFydAogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlNVRERFTiBERUFUSCEiLCAic2xhbSIpOwogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgovLyBLZWVwIEJHTSBwbGF5aW5nIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSBDLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCiAgICAgICAgICAgIC8vIE1hdGNoZXMgRkZYIFN0eWxlIEdvYWwgTW9kZWwKICAgICAgICAgICAgY29uc3QgdHJpVG9wWSA9IChDLkdPQUxfVFJJR0dFUl9UT1BfWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1RPUF9ZIDogMi4wOwogICAgICAgICAgICBjb25zdCB0cmlCb3R0b21ZID0gKEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfQk9UVE9NX1kgOiAtMTguMDsKICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyT2Zmc2V0ID0gKEMuR09BTF9UUklHR0VSX09GRlNFVCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX09GRlNFVCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSBnb2FsRGlzdCAtIHRyaWdnZXJPZmZzZXQ7CgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoSW52ZXJ0ZWQgVHJpYW5nbGUpCiAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGFsbG93ZWQgd2lkdGggYXQgdGhpcyBoZWlnaHQgKExpbmVhciBpbnRlcnBvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIEF0IGJvdHRvbSAoLTYpLCB3aWR0aCBpcyAwLiBBdCB0b3AgKDEyKSwgd2lkdGggaXMgbWF4LgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsb3dlZFggPSB0ICogdHJpTWF4SGFsZldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGFsbG93ZWRYKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGVsZCA9ICEhYmFsbC5ob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIb21lIHNjb3JpbmcgZW5kIChHb2FsIGF0IC1aKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKE5lZ2F0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA8IC0wLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBd2F5IHNjb3JpbmcgZW5kIChHb2FsIGF0ICtaKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmFsaWQgaWYgaGVsZCAoYXR0YWNrZXIgY2FycnlpbmcpIE9SIG1vdmluZyB0b3dhcmRzIGdvYWwgKFBvc2l0aXZlIFopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIZWxkIHx8IGJhbGwudmVsb2NpdHkueiA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmdvYWxTY29yZWQoc2NvcmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnYWN0aXZlJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSU1QQUNUIEZSQU1FOiBHT0FMCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckltcGFjdCgwLjQsICdzaGF0dGVyJyk7IC8vIE1hc3NpdmUgZnJlZXplIGZvciBnb2FsCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU5DUkVNRU5UIFNDT1JFCiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlW3Njb3Jlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBHT0FMISAke3Njb3Jlcn0gc2NvcmVzLiBOZXcgU2NvcmU6IEhvbWUgJHt0aGlzLnNjb3JlLmhvbWV9IC0gQXdheSAke3RoaXMuc2NvcmUuYXdheX1gKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgIHRoaXMuYWRkSFVEU2hha2UoMjAuMCk7IC8vIEhVRCBTaGFrZQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCQVJSSUVSIFNIQVRURVIgTE9HSUMKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIEhvbWUgc2NvcmVzIGF0IC1aIChBd2F5IEdvYWwpLCBBd2F5IHNjb3JlcyBhdCArWiAoSG9tZSBHb2FsKQogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChzY29yZXIgPT09ICdob21lJykgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhcnJpZXIgPSAoc2NvcmVyID09PSAnaG9tZScpID8gdGhpcy5zdGFkaXVtLmJhcnJpZXJBIDogdGhpcy5zdGFkaXVtLmJhcnJpZXJCOwogICAgICAgICAgICAgICAgaWYgKGJhcnJpZXIpIGJhcnJpZXIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxWZWwgPSB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcndhcmQgPSBiYWxsVmVsLmNsb25lKCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEltcGFjdCBQb2ludCBvbiBHb2FsIFBsYW5lIChUaGUgIkludmlzaWJsZSBCYXJyaWVyIikKICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFBvcyA9IGJhbGxQb3MuY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIFNuYXAgZWZmZWN0IHRvIHRoZSBiYXJyaWVyIHBsYW5lIChaKSBidXQga2VlcCBYL1kgb2YgZW50cnkKICAgICAgICAgICAgICAgIGltcGFjdFBvcy56ID0gZ29hbFo7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEdsYXNzIFNoYXR0ZXIgRWZmZWN0IChUaGUgSG9sZSkKICAgICAgICAgICAgICAgIHRoaXMuX3RyaWdnZXJHbGFzc1NoYXR0ZXIoaW1wYWN0UG9zLCBiYWxsVmVsKTsKCiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRyaWFuZ2xlIEZyYW1lIFNoYXR0ZXIgKFRoZSBCYXJyaWVyKQogICAgICAgICAgICAgICAgdGhpcy5fc3Bhd25UcmlhbmdsZVNoYXR0ZXIoZ29hbFosIGZvcndhcmQpOwoKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBpbXBhY3RQb3MsIHsgc2NhbGU6IDIwLjAsIGxpZmU6IDAuNiwgY29sb3I6IDB4MDBmZmZmIH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgaW1wYWN0UG9zLCB7IHNjYWxlOiAxMi4wIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSyAoU3VkZGVuIERlYXRoKQogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNsb3cgbW90aW9uIGZpbmlzaAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjI7CgogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkgKDAuNXMgZ2FtZSB0aW1lIGF0IDAuMiBzY2FsZSA9IDIuNXMgcmVhbCB0aW1lKQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2xkZW5fZ29hbCc7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2dvYWwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMgKDIuMHMgZ2FtZSB0aW1lKQogICAgICAgICAgICB0aGlzLnN0YXRlVGltZXIgPSAyLjA7CiAgICAgICAgICAgIHRoaXMubmV4dFN0YXRlUGF5bG9hZCA9IGxvc2VyOwogICAgICAgIH0KCl9zcGF3blRyaWFuZ2xlU2hhdHRlcih6UG9zLCBmb3J3YXJkRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFRyaWFuZ2xlIFZlcnRpY2VzIChNYXRjaGVzIFN0YWRpdW0uanMgZ2VvbWV0cnkpCiAgICAgICAgICAgIC8vIFRvcCBZOiAxMi4wLCBCb3R0b20gWTogLTYuMC4gV2lkdGggYXQgdG9wOiAyOC4wICgrLy0gMTQuMCkuCmNvbnN0IHYxID0geyB4OiAtMTQsIHk6IDkgfTsKICAgICAgICAgICAgY29uc3QgdjIgPSB7IHg6IDE0LCB5OiA5IH07CiAgICAgICAgICAgIGNvbnN0IHYzID0geyB4OiAwLCB5OiAtNiB9OwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZWRnZXMgPSBbCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiB2MSwgZW5kOiB2MiB9LAogICAgICAgICAgICAgICAgeyBzdGFydDogdjIsIGVuZDogdjMgfSwKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHYzLCBlbmQ6IHYxIH0KICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBkZW5zaXR5IGZvciAiYXBwZWFyaW5nIiBlZmZlY3QKLy8gSW5jcmVhc2VkIGRlbnNpdHkgZm9yICJhcHBlYXJpbmciIGVmZmVjdApjb25zdCBwYXJ0aWNsZXNQZXJFZGdlID0gNDsgLy8gUmVkdWNlZCBmcm9tIDEyIGZvciBsZXNzIGNsdXR0ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgIGVkZ2VzLmZvckVhY2goZWRnZSA9PiB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBwYXJ0aWNsZXNQZXJFZGdlOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gaSAvIHBhcnRpY2xlc1BlckVkZ2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IGVkZ2Uuc3RhcnQueCArIChlZGdlLmVuZC54IC0gZWRnZS5zdGFydC54KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeSA9IGVkZ2Uuc3RhcnQueSArIChlZGdlLmVuZC55IC0gZWRnZS5zdGFydC55KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoeCwgeSwgelBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHNvbWUgcmFuZG9tbmVzcwogICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwoKICAgICAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eTogT3V0d2FyZCBmcm9tIGNlbnRlciBvZiB0cmlhbmdsZSAoYXBwcm94IDAsIDQpICsgRm9yd2FyZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHsgeDogMCwgeTogMS41IH07IC8vIFJvdWdoIGNlbnRlciBvZiBtYXNzCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoeCAtIGNlbnRlci54LCB5IC0gY2VudGVyLnksIDApLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbCA9IGRpci5tdWx0aXBseVNjYWxhcig4LjAgKyBNYXRoLnJhbmRvbSgpICogMTIuMCk7CiAgICAgICAgICAgICAgICAgICAgdmVsLmFkZChmb3J3YXJkRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMjAuMCkpOyAvLyBTdHJvbmcgZm9yd2FyZCBtb21lbnR1bQoKdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3NoYXJkJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogNi4wLCAKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS41ICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4NDRhYWZmLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxMC4wLCAvLyBTcGluCiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KSAvLyBSYW5kb20gc2hhcGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBvbiBwZXJpbWV0ZXIgdG8gb3V0bGluZSB0aGUgc2hhcGUgYXMgaXQgYnJlYWtzCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuMywgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX3RyaWdnZXJHbGFzc1NoYXR0ZXIocG9zLCB2ZWwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBhcnRpY2xlTWFuYWdlcikgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZm9yd2FyZCA9IHZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWF4KDIwLjAsIHZlbC5sZW5ndGgoKSk7IC8vIEVuc3VyZSBtaW5pbXVtIGV4cGxvc2lvbiBzcGVlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVGhlICJQYW5lIiAoUmFkaWFsIGJ1cnN0IG9uIHRoZSBnb2FsIHBsYW5lKQogICAgICAgICAgICAvLyBTaW11bGF0ZXMgdGhlIGJhcnJpZXIgc2hhdHRlcmluZyBvdXR3YXJkCi8vIDEuIFRoZSAiUGFuZSIgKFJhZGlhbCBidXJzdCBvbiB0aGUgZ29hbCBwbGFuZSkKICAgICAgICAgICAgLy8gU2ltdWxhdGVzIHRoZSBiYXJyaWVyIHNoYXR0ZXJpbmcgb3V0d2FyZApjb25zdCBzaGFyZENvdW50ID0gMTU7IC8vIFJlZHVjZWQgZnJvbSA1MAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxzaGFyZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IE1hdGgucmFuZG9tKCkgKiAxMC4wOyAvLyBMYXJnZXIgcmFkaXVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGguY29zKGFuZ2xlKSAqIHIsIE1hdGguc2luKGFuZ2xlKSAqIHIsIDApOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWxvY2l0eSBpcyByYWRpYWwgb3V0d2FyZCBmcm9tIGltcGFjdCBjZW50ZXIKICAgICAgICAgICAgICAgIGNvbnN0IHJhZGlhbERpciA9IG9mZnNldC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSByYWRpYWxEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCArIE1hdGgucmFuZG9tKCkgKiAyNS4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQWRkIGZvcndhcmQgbW9tZW50dW0gKFRoZSBiYWxsIHB1bmNoZXMgdGhyb3VnaCkKICAgICAgICAgICAgICAgIHNoYXJkVmVsLmFkZChmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAwLjgpKTsKICAgICAgICAgICAgICAgIAp0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hhcmQnLCBwLCB7CiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IHNoYXJkVmVsLAogICAgICAgICAgICAgICAgICAgIHNjYWxlOiA2LjAgKyBNYXRoLnJhbmRvbSgpICogOC4wLCAKICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIgKyBNYXRoLnJhbmRvbSgpICogMC44LAogICAgICAgICAgICAgICAgICAgIGdyYXZpdHk6IDI1LjAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4YWFmZmZmLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDE1LjAsCiAgICAgICAgICAgICAgICAgICAgZnJhbWU6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKLy8gMi4gVGhlICJIb2xlIiAoSGlnaCB2ZWxvY2l0eSBzaGFyZHMgbW92aW5nIGZvcndhcmQgd2l0aCB0aGUgYmFsbCkKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7IC8vIFJlZHVjZWQgZnJvbSAyMAogICAgICAgICAgICAgICAgY29uc3QgcCA9IHBvcy5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIHN0YXJ0IHBvcyBzbGlnaHRseSAoaW1wYWN0IHpvbmUpCiAgICAgICAgICAgICAgICBwLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNC4wOwogICAgICAgICAgICAgICAgcC55ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDQuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHk6IE1vc3RseSBmb3J3YXJkLCBzb21lIHNwcmVhZAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmRWZWwgPSBmb3J3YXJkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiAoMS4wICsgTWF0aC5yYW5kb20oKSAqIDAuNSkpOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgc2hhcmRWZWwueSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNS4wOwogICAgICAgICAgICAgICAgCnRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaGFyZCcsIHAsIHsKICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogc2hhcmRWZWwsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDUuMCArIE1hdGgucmFuZG9tKCkgKiA3LjAsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMi4wICsgTWF0aC5yYW5kb20oKSwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAxNS4wLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyMC4wLAogICAgICAgICAgICAgICAgICAgIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEltcGFjdCBGbGFzaCAmIFNvdW5kCiAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogMTUuMCwgY29sb3I6IDB4ZmZmZmZmIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gSW1wYWN0IEZsYXNoICYgU291bmQKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiAxMC4wLCBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEhpZ2ggcGl0Y2ggaW1wYWN0IHRvIHNpbXVsYXRlIGdsYXNzIGJyZWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wLCByYXRlOiAyLjUgfSk7IAogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAsIHJhdGU6IDAuNSB9KTsgLy8gRGVlcCB3aG9vc2gKICAgICAgICAgICAgfQogICAgICAgIH0KCnNob3dBbm5vdW5jZW1lbnQodGV4dCwgdHlwZSA9ICdub3JtYWwnLCBkdXJhdGlvbiA9IDIwMDApIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLmFubm91bmNlbWVudDsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ2xlYXIgcHJldmlvdXMgdGltZW91dAogICAgICAgICAgICBpZiAodGhpcy5fYW5ub3VuY2VUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fYW5ub3VuY2VUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbiBieSBjbG9uaW5nCiAgICAgICAgICAgIGNvbnN0IG5ld0VsID0gZWwuY2xvbmVOb2RlKHRydWUpOwogICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdFbCwgZWwpOwogICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudCA9IG5ld0VsOwoKICAgICAgICAgICAgbmV3RWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgbmV3RWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDbGFzcyBiYXNlZCBvbiB0eXBlCiAgICAgICAgICAgIG5ld0VsLmNsYXNzTmFtZSA9ICcnOyAvLyBSZXNldCBjbGFzc2VzCiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2xhbScpIHsKICAgICAgICAgICAgICAgIG5ld0VsLmNsYXNzTGlzdC5hZGQoJ2Fubm91bmNlbWVudC1zbGFtJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHN0eWxlCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBuZXdFbC5vZmZzZXRIZWlnaHQ7IC8qIHRyaWdnZXIgcmVmbG93ICovCiAgICAgICAgICAgICAgICBuZXdFbC5zdHlsZS5hbmltYXRpb24gPSAnYW5ub3VuY2VTbGlkZSAwLjVzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZQogICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZUFubm91bmNlbWVudCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmFubm91bmNlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRSb3VuZChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAncmVzZXQnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgcGVyc2lzdGVudCB2aXN1YWxzCiAgICAgICAgICAgIGlmICh0aGlzLmdseXBoTWFuYWdlcikgdGhpcy5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXJVcE1hbmFnZXIpIHRoaXMucG93ZXJVcE1hbmFnZXIucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogQ2xlYXIgcGFydGljbGVzIGlmIG5lZWRlZCwgdGhvdWdoIHRoZXkgc2VsZi1leHBpcmUgcXVpY2tseQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXN0b3JlIEJhcnJpZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckEpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0uYmFycmllckIpIHRoaXMuc3RhZGl1bS5iYXJyaWVyQi52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIHRoaXMuc3RhdGVUaW1lciA9IDAuMTsKICAgICAgICAgICAgdGhpcy5uZXh0U3RhdGVQYXlsb2FkID0gcG9zc2Vzc2lvblRlYW1JZDsKICAgICAgICB9CgoKc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseQogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIHN0YW5kYXJkIGtpY2tvZmYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAna2lja29mZic7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkJMSVRaIE9GRiEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IHRoaXMudGVhbXNbcG9zc2Vzc2lvblRlYW1JZF07CiAgICAgICAgICAgICAgICBpZiAodGVhbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1mID0gdGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgICAgIGlmIChtZiAmJiB0aGlzLmVudGl0aWVzLmJhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5iYWxsLmdyYWIobWYpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEgdG8gbmV3IGhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KG1mLm1lc2gsIG1mLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAp0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVRpbWVyID0gMC44OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTkVVVFJBTCBLSUNLT0ZGOiAiVGhlIEJsaXR6IE9mZiIgQ2luZW1hdGljIFNlcXVlbmNlCiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydE5ldXRyYWxCbGl0ek9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCl9zdGFydE5ldXRyYWxCbGl0ek9mZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9jaGFyZ2UnOwogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gUmVzZXQgQmFsbCB0byBDZW50ZXIgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgYmFsbC5kcm9wKCk7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KDAsIC01LCAwKTsgLy8gU3RhcnQgREVFUCAoLTVtKSBmb3IgImdyb3VuZCB1cCIgcmlzZQogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiYWxsLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBSZXNldCB2aXN1YWxzCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBQb3NpdGlvbiBDYXB0YWlucyAoTUZzKQogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoaG9tZU1GICYmIGhvbWVNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgOCk7IC8vIDhtIGJhY2sKICAgICAgICAgICAgICAgIGhvbWVNRi5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGhvbWVNRi5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheU1GICYmIGF3YXlNRi5tZXNoKSB7CiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBhd2F5TUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBhd2F5TUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIENhbWVyYSBGb2N1cwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyICYmIGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KGJhbGwubWVzaCwgbnVsbCk7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAvLyBab29tIGluIHRpZ2h0CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gLTEyOyAKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5tYW51YWxPcmJpdFBpdGNoID0gMC40OyAvLyBMb29rIGRvd24gc3RlZXAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQnVpbGQgVGVuc2lvbgogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIlJFQURZLi4uIiwgJ25vcm1hbCcpOwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3N3aW0nLCB7IHZvbHVtZTogMC41IH0pOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUR1cmF0aW9uID0gMi4wOyAvLyBMb25nZXIgYnVpbGQgdXAgZm9yIGNpbmVtYXRpYyBmZWVsCgogICAgICAgICAgICAvLyBQSEFTRSAxOiBDSEFSR0UgKFJpc2luZyBmcm9tIGRlcHRocykKICAgICAgICAgICAgaWYgKHRoaXMuYmxpdHpUaW1lciA8IGNoYXJnZUR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5ibGl0elRpbWVyIC8gY2hhcmdlRHVyYXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBlYXNlVCA9IHQgKiB0OyAvLyBRdWFkcmF0aWMgZWFzZSBpbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSaXNlIGZyb20gLTUgdG8gMCAoR3JvdW5kIHVwIGVmZmVjdCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi55ID0gLTUuMCArICg1LjAgKiBlYXNlVCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNwaW4gdXAgKEV4cG9uZW50aWFsKQogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnJvdGF0aW9uLnkgKz0gKDEwLjAgKyA1MC4wICogdCkgKiBkdDsKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi54ICs9ICg1LjAgKyAyMC4wICogdCkgKiBkdDsKCiAgICAgICAgICAgICAgICAvLyBTcXVhc2ggKEZsYXR0ZW4gbGlrZSBhIGRpc2MgYnVpbGRpbmcgZW5lcmd5KQogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJlbWUgc3F1YXNoIGF0IHRoZSBlbmQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLSAoMC43ICogZWFzZVQpOyAvLyBGbGF0dGVuIFkgdG8gMC4zCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZXRjaCA9IDEuMCArICgwLjUgKiBlYXNlVCk7IC8vIEV4cGFuZCBYWgogICAgICAgICAgICAgICAgICAgIGJhbGwuZGVmb3JtTm9kZS5zY2FsZS5zZXQoc3RyZXRjaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYW1lcmEgU2hha2UgaW5jcmVhc2luZwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMiAqIHQpOwoKICAgICAgICAgICAgICAgIC8vIFBhcnRpY2xlczogUmlzaW5nIEVuZXJneSBmcm9tIGdyb3VuZAogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlcyByaXNpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5mbG9vcih0ICogOCkgKyAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAyLjAgKiAoMS4wIC0gdCk7IC8vIFJhZGl1cyBzaHJpbmtzIGFzIGl0IGdldHMgY2xvc2VyIHRvIGxhdW5jaAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBiYWxsLm1lc2gucG9zaXRpb24ueSAtIDEuMDsgLy8gQmVsb3cgYmFsbAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIG5ldyBUSFJFRS5WZWN0b3IzKHgsIHksIHopLCB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC40LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlOiAwLjIgKyB0ICogMC41IAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBIQVNFIDI6IExBVU5DSAogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnYmxpdHpfY2hhcmdlJykgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdibGl0el9sYXVuY2gnOwogICAgICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsgLy8gUmVzZXQgZm9yIGxhdW5jaCBwaGFzZQoKICAgICAgICAgICAgICAgIC8vIFRJTUVEIEFOTk9VTkNFTUVOVAogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAxLjAgfSk7IC8vIEJvb20KICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDEuMCB9KTsgICAvLyBXaG9vc2gKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBMYXVuY2ggQmFsbAogICAgICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoMCwgMzUsIDApOyAvLyBTaG9vdCBVUCBGQVNUCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5kZWZvcm1Ob2RlKSBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KDAuNCwgMy4wLCAwLjQpOyAvLyBFeHRyZW1lIHN0cmV0Y2ggdmVydGljYWwKCiAgICAgICAgICAgICAgICAvLyBGWDogTWFzc2l2ZSBHcm91bmQgRXJ1cHRpb24KICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDguMCB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBiYWxsLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDYuMCB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBzdHJlYW0KICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwxMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC55ICs9IGkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkYXNoX3N0cmVhbScsIHAsIHsgc2NhbGU6IDMuMCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMy4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuY3VycmVudFB1bGxCYWNrID0gMTA7IC8vIFpvb20gb3V0IGZhc3QKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuMDsgLy8gTGV2ZWwgb3V0CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FwdGFpbnMgSnVtcAogICAgICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKCiAgICAgICAgICAgICAgICBjb25zdCBqdW1wVG8gPSAocCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAxLjI7IC8vIFN0ZWVwIGp1bXAKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmNvcHkoZGlyKS5tdWx0aXBseVNjYWxhcigxOC4wKTsgLy8gRmFzdCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaF9qdW1wJywgMC4xKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganVtcFRvKGhvbWVNRik7CiAgICAgICAgICAgICAgICBqdW1wVG8oYXdheU1GKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KSB7CiAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGdyYXZpdHkgbWFudWFsbHkgZm9yIGNpbmVtYXRpYyBmZWVsIChJbmNyZWFzZWQgZ3Jhdml0eSBmb3Igc25hcHBpZXIgYXJjKQogICAgICAgICAgICBiYWxsLnZlbG9jaXR5LnkgLT0gNDAuMCAqIGR0OyAKICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCBkdCk7CgogICAgICAgICAgICAvLyBNb3ZlIFBsYXllcnMgbWFudWFsbHkKICAgICAgICAgICAgY29uc3QgdXBkYXRlSnVtcGVyID0gKHApID0+IHsKICAgICAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnkgLT0gMjUuMCAqIGR0OyAvLyBHcmF2aXR5CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZUp1bXBlcihob21lTUYpOwogICAgICAgICAgICB1cGRhdGVKdW1wZXIoYXdheU1GKTsKCiAgICAgICAgICAgIC8vIFBIQVNFIDM6IEdSQUIgKEFwZXggfjAuN3MpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPiAwLjcgJiYgdGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBXaW5uZXIgKDUwLzUwICsgU3RhdCBiaWFzKQogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNwID0gaG9tZU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhd2F5U3AgPSBhd2F5TUYuZ2V0U3RhdCgnU1AnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gaG9tZVNwICsgYXdheVNwOwogICAgICAgICAgICAgICAgY29uc3Qgcm9sbCA9IE1hdGgucmFuZG9tKCkgKiB0b3RhbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2lubmVyID0gKHJvbGwgPCBob21lU3ApID8gaG9tZU1GIDogYXdheU1GOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBiYWxsLmdyYWIod2lubmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiV09OISIsIHdpbm5lci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyYW5zaXRpb24gdG8gQWN0aXZlCiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIHdpbm5lcgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQod2lubmVyLm1lc2gsIHdpbm5lci52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOyAvLyBPcHRpb25hbDogS2VlcCBzbW9vdGggb3Igc25hcAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CnRoaXMuX3VwZGF0ZVNjb3JlVUkodHJ1ZSk7IC8vIFJlc2V0IHNjb3JlIGRpc3BsYXkgd2l0aG91dCBzbGFtIGFuaW1hdGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBmYWxzZTsgLy8gUmVzZXQgU3VkZGVuIERlYXRoIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiMXN0IjsKICAgICAgICAgICAgICAgIHRoaXMudWkuaGFsZi5zdHlsZS5jb2xvciA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy51aS5oYWxmLnN0eWxlLnRleHRTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgpzdGFydEludHJvU2VxdWVuY2UoKSB7CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ludHJvJzsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9oYXNSb2FyZWQgPSBmYWxzZTsgLy8gUmVzZXQgcm9hciBmbGFnCiAgICAgICAgICAgIC8vIFN0b3AgQkdNIGZvciBjaW5lbWF0aWMgaW50cm8gKGxldCBTRlggc2hpbmUpCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnRleHQgaXMgcnVubmluZyBmb3IgaW50cm8gU0ZYCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsIHNldHVwCiAgICAgICAgICAgIC8vIEhJREUgQUxMIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLCAKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsIAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsIAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcsCiAgICAgICAgICAgICAgICAnY2hhcmdlLW1ldGVyLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICB1aUVsZW1lbnRzLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICBpZiAoZWwpIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gU2hvdyBDaW5lbWF0aWMgQmFycwogICAgICAgICAgICBjb25zdCBiYXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NpbmVtYXRpYy1iYXJzJyk7CiAgICAgICAgICAgIGlmIChiYXJzKSB7CiAgICAgICAgICAgICAgICBiYXJzLnF1ZXJ5U2VsZWN0b3JBbGwoJy5iYXInKS5mb3JFYWNoKGIgPT4gYi5zdHlsZS5oZWlnaHQgPSAnMTAlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIGZpcnN0IHNob3Qgc3RhcnQKICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90cyAmJiB0aGlzLmludHJvU2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90c1swXS5vblN0YXJ0KSB0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZUludHJvV2FybXVwKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGFsbFBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgYWxsUGxheWVycy5wdXNoKC4uLnRoaXMudGVhbXMuYXdheS5wbGF5ZXJzKTsKCiAgICAgICAgICAgIGFsbFBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlIG1peGVyIHVwZGF0ZXMgKHNpbmNlIGdhbWUgbG9vcCBtaWdodCBza2lwIHBsYXllci51cGRhdGUgaW4gaW50cm8gc3RhdGUpCiAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgd2FybXVwIHRpbWVyIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyID09PSB1bmRlZmluZWQpIHAuX3dhcm11cFRpbWVyID0gTWF0aC5yYW5kb20oKSAqIDIuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcC5fd2FybXVwVGltZXIgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHAuX3dhcm11cFRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBQaWNrIG5leHQgYWN0aW9uIHRpbWUgKDJzIHRvIDVzKQogICAgICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyID0gMi4wICsgTWF0aC5yYW5kb20oKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuNikgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ3N3aW0nLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAiU3RyZXRjaCIgLyBDZWxlYnJhdGUKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjZWxlYnJhdGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmFuZCA8IDAuOSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC41KTsgLy8gQ2hlY2tpbmcgZ2xvdmVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdyZWFjdCcsIDAuNSk7IC8vIFNoYWtlIG9mZgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyAodHJlYWRpbmcgd2F0ZXIpCiAgICAgICAgICAgICAgICBpZiAocC5ob21lUG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMgKyBwLm1lc2guaWQpICogMC4zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gUGxheSBCR00gaW4gbWVudQogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgbWF0Y2ggdGVuc2lvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyLnNldE1hdGNoU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zZXRNYXRjaFN0YXRlKDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3Qgc3RhdGljVUkgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsCiAgICAgICAgICAgICAgICAncGxheWVyLXN0YXR1cy1wYW5lbCcsCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay16b25lJywKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnZ29hbC1kaXN0YW5jZS1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3NldHRpbmdzLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLAogICAgICAgICAgICAgICAgJ3RhY2tsZS1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBMaXN0IG9mIGR5bmFtaWMgZWxlbWVudHMgdG8gRk9SQ0UgSElERSBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNVSSA9IFsKICAgICAgICAgICAgICAgICdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stdmlzdWFsJywKICAgICAgICAgICAgICAgICdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJywKICAgICAgICAgICAgICAgICd0ZWNoLWZsYXNoLW92ZXJsYXknLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBISURFIEFMTAogICAgICAgICAgICAgICAgWy4uLnN0YXRpY1VJLCAuLi5keW5hbWljVUldLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU0hPVyBTVEFUSUMgT05MWQogICAgICAgICAgICAgICAgc3RhdGljVUkuZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PT0gJ2h1ZC10b3AnIHx8IGlkID09PSAnYWN0aW9uLWNvbnRhaW5lcicpIGVsLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIG9uZXMgcmVtYWluIGhpZGRlbi9jb250cm9sbGVkIGJ5IHRoZWlyIGxvZ2ljCiAgICAgICAgICAgIH0KICAgICAgICB9CnRvZ2dsZURlbW9Nb2RlKCkgewogICAgICAgICAgICB0aGlzLmlzRGVtb01vZGUgPSAhdGhpcy5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiRGVtbyBNb2RlOiIsIHRoaXMuaXNEZW1vTW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkgQnV0dG9uCiAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgICAgICBpZiAoYnRuKSB7CiAgICAgICAgICAgICAgICBidG4uaW5uZXJUZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBjb25zdCB0ZXh0ID0gdGhpcy5pc0RlbW9Nb2RlID8gIkFVVE8gUElMT1QiIDogIk1BTlVBTCI7CiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCh0ZXh0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGbGFpcjogU3Bhd24gdGV4dCBhYm92ZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUgJiYgdGhpcy5mbG9hdGluZ1RleHQgJiYgdGhpcy50ZWFtcy5ob21lICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZsb2F0aW5nVGV4dC5zcGF3bigiQUkgRU5HQUdFRCIsIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlIGFubm91bmNlbWVudApzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCAmJiB0aGlzLnVpLmFubm91bmNlbWVudC5pbm5lclRleHQgPT09IHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMTUwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gVEVDSENPUFkgU1lTVEVNIC0tLQoKICAgICAgICB0cmlnZ2VyVGVjaEV2ZW50KHNvdXJjZVBsYXllciwgdGVjaE5hbWUpIHsKICAgICAgICAgICAgaWYgKCFzb3VyY2VQbGF5ZXIgfHwgIXNvdXJjZVBsYXllci50ZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIG9wcG9zaW5nIHRlYW0KICAgICAgICAgICAgY29uc3Qgb3BwVGVhbUlkID0gc291cmNlUGxheWVyLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IHRoaXMudGVhbXNbb3BwVGVhbUlkXTsKICAgICAgICAgICAgaWYgKCFvcHBUZWFtKSByZXR1cm47CgogICAgICAgICAgICAvLyBGaW5kIHdobyBpcyBtYXJraW5nIHRoaXMgc291cmNlCiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gb3BwVGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IHAubWFya2luZyA9PT0gc291cmNlUGxheWVyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChsZWFybmVycy5sZW5ndGggPT09IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9ubHkgc2hvdyBVSSBpZiB0aGUgbGVhcm5pbmcgdGVhbSBpcyBIdW1hbiAoSG9tZSkKICAgICAgICAgICAgLy8gKE9yIGlmIHdlIGFyZSBpbiBEZW1vIG1vZGUgYW5kIHdhbnQgdG8gc2VlIGl0IGhhcHBlbiBmb3IgSG9tZSB0ZWFtKQogICAgICAgICAgICBpZiAob3BwVGVhbS5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IHRob3NlIHdobyBhbHJlYWR5IGtub3cgaXQKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTGVhcm5lcnMgPSBsZWFybmVycy5maWx0ZXIocCA9PiAhcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaE5hbWUpKTsKICAgICAgICAgICAgICAgIGlmICh2YWxpZExlYXJuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIHZhbGlkTGVhcm5lcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgbGVhcm5lcnMpIHsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lID0gMC42OyAvLyAwLjZzIHdpbmRvdwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPSB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRlY2ggPSB0ZWNoTmFtZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzID0gbGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IFVJCmlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheUJHTSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb250ZXh0IGlzIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5hdWRpb01hbmFnZXIuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CgogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOyAvLyBIaXQgc3RvcCBkaXNhYmxlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIEhVRCBTaGFrZSBiYXNlZCBvbiBpbXBhY3QgdHlwZQogICAgICAgICAgICBsZXQgc2hha2VBbW91bnQgPSA1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBzaGFrZUFtb3VudCA9IDE1LjA7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIHNoYWtlQW1vdW50ID0gMzAuMDsKICAgICAgICAgICAgdGhpcy5hZGRIVURTaGFrZShzaGFrZUFtb3VudCk7CgogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0IHRvIHByZXZlbnQgZWFybHkgcmVtb3ZhbCBvZiBuZXcgY2xhc3MKICAgICAgICAgICAgaWYgKHRoaXMuX2ltcGFjdFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9pbXBhY3RUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2ltcGFjdFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBjbGFzc2VzIHRvIGVuc3VyZSBhbmltYXRpb24gcmVzdGFydHMgKHJlZmxvdyB0cmljaykKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ltcGFjdC1meCcsICdpbXBhY3QtaGVhdnknLCAnaW1wYWN0LXNoYXR0ZXInKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcmNlIHJlZmxvdwogICAgICAgICAgICB2b2lkIGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKCiAgICAgICAgICAgIGxldCBjbGFzc05hbWUgPSAnaW1wYWN0LWZ4JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdoZWF2eScpIGNsYXNzTmFtZSA9ICdpbXBhY3QtaGVhdnknOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NoYXR0ZXInKSBjbGFzc05hbWUgPSAnaW1wYWN0LXNoYXR0ZXInOwoKICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVtb3ZlIGNsYXNzIGFmdGVyIGR1cmF0aW9uICsgYnVmZmVyIGZvciBhbmltYXRpb24gdGFpbAogICAgICAgICAgICAvLyBXZSBhZGQgYSBiaXQgbW9yZSB0aW1lIHRoYW4gdGhlIHBhdXNlIGR1cmF0aW9uIHRvIGxldCB0aGUgQ1NTIGFuaW1hdGlvbiBmaW5pc2gKICAgICAgICAgICAgY29uc3QgYW5pbUR1cmF0aW9uID0gKHR5cGUgPT09ICdzaGF0dGVyJyA/IDUwMCA6ICh0eXBlID09PSAnaGVhdnknID8gMjUwIDogMTUwKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9pbXBhY3RUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdGhpcy5faW1wYWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIH0sIGFuaW1EdXJhdGlvbik7CiAgICAgICAgfQoKICAgICAgICBhZGRIVURTaGFrZShhbW91bnQpIHsKICAgICAgICAgICAgdGhpcy5odWRTaGFrZUludGVuc2l0eSA9IE1hdGgubWluKHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgKyBhbW91bnQsIDUwLjApOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUhVRFNoYWtlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgLy8gRGVjYXkKICAgICAgICAgICAgICAgIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgLT0gZHQgKiA2MC4wOyAvLyBEZWNheSBhcHByb3ggNjBweCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBpZiAodGhpcy5odWRTaGFrZUludGVuc2l0eSA8IDApIHRoaXMuaHVkU2hha2VJbnRlbnNpdHkgPSAwOwoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLmh1ZFNoYWtlSW50ZW5zaXR5OwogICAgICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuaHVkU2hha2VJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4KWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRvIG1haW4gSFVEIGNvbnRhaW5lcnMKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgICAgICAvLyBQcmVzZXJ2ZSBleGlzdGluZyBza2V3CiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzUGFuZWwpIHN0YXR1c1BhbmVsLnN0eWxlLnRyYW5zZm9ybSA9IGBza2V3WCgtMTBkZWcpICR7dHJhbnNmb3JtfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uQ29udGFpbmVyKSBhY3Rpb25Db250YWluZXIuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CgogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faHVkU2hha2VEaXJ0eSkgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gY2xlYW4gc3RhdGUKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUudHJhbnNmb3JtID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUudHJhbnNmb3JtID0gJ3NrZXdYKC0xMGRlZyknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25Db250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICAgICAgaWYgKGFjdGlvbkNvbnRhaW5lcikgYWN0aW9uQ29udGFpbmVyLnN0eWxlLnRyYW5zZm9ybSA9ICcnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAtY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICBpZiAobWluaW1hcCkgbWluaW1hcC5zdHlsZS50cmFuc2Zvcm0gPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5faHVkU2hha2VEaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlQXVkaW9TdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmF1ZGlvTWFuYWdlcikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHRlbnNpb24gPSAwOwoKICAgICAgICAgICAgLy8gMS4gQmFsbCBUaHJlYXQKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJyB8fCB0aGlzLnN0YXRlID09PSAnYmxpdHpfbGF1bmNoJykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgY29uc3QgeiA9IGJhbGwubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGgubWluKE1hdGguYWJzKHogLSBnb2FsRGlzdCksIE1hdGguYWJzKHogKyBnb2FsRGlzdCkpOwogICAgICAgICAgICAgICAgY29uc3QgdGhyZWF0UmFuZ2UgPSAzNS4wOwogICAgICAgICAgICAgICAgY29uc3QgYmFsbFRocmVhdCA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0VG9Hb2FsIC8gdGhyZWF0UmFuZ2UpKTsKICAgICAgICAgICAgICAgIHRlbnNpb24gKz0gYmFsbFRocmVhdCAqIGJhbGxUaHJlYXQ7IC8vIFF1YWRyYXRpYyByYW1wCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjb3JlIFByZXNzdXJlIChDbG9zZSBnYW1lKQogICAgICAgICAgICBjb25zdCBkaWZmID0gTWF0aC5hYnModGhpcy5zY29yZS5ob21lIC0gdGhpcy5zY29yZS5hd2F5KTsKICAgICAgICAgICAgaWYgKGRpZmYgPD0gMSkgdGVuc2lvbiArPSAwLjE1OwoKICAgICAgICAgICAgLy8gMy4gVGltZSBQcmVzc3VyZSAoTGFzdCBtaW51dGUpCiAgICAgICAgICAgIGNvbnN0IHRpbWVMZWZ0ID0gdGhpcy5oYWxmRHVyYXRpb24gLSB0aGlzLnRpbWU7CiAgICAgICAgICAgIGlmICh0aW1lTGVmdCA8IDYwICYmIHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0ZW5zaW9uICs9IDAuMiAqICgxLjAgLSAodGltZUxlZnQgLyA2MCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc2V0TWF0Y2hTdGF0ZSh0ZW5zaW9uLCB0aGlzLmlzT3ZlcnRpbWUpOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3VwZGF0ZUVudmlyb25tZW50YWxGWChkdCkgewogICAgICAgICAgICAvLyBPbmx5IGluIGFjdGl2ZSBnYW1lIG9yIG1lbnUKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuX2VudkJ1YmJsZVRpbWVyID0gKHRoaXMuX2VudkJ1YmJsZVRpbWVyIHx8IDApIC0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5fZW52QnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gUmFuZG9tIGludGVydmFsOiAwLjJzIHRvIDAuOHMgKEZyZXF1ZW50IHN0cmVhbXMpCiAgICAgICAgICAgICAgICB0aGlzLl9lbnZCdWJibGVUaW1lciA9IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIFBpY2sgYSByYW5kb20gc3BvdCBvbiB0aGUgZmxvb3IKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNzA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeiA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDkwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHlCYXNlID0gLTIwOyAvLyBEZWVwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gYSAiU3RyZWFtIiAoQnVyc3Qgb2YgYnViYmxlcyByaXNpbmcgdG9nZXRoZXIpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSAzICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZWFtU3BlZWQgPSAzLjAgKyBNYXRoLnJhbmRvbSgpICogNC4wOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ICsgKE1hdGgucmFuZG9tKCktMC41KSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlIC0gKE1hdGgucmFuZG9tKCkgKiA1LjApLCAvLyBTdGFnZ2VyZWQgc3RhcnQgZGVwdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHogKyAoTWF0aC5yYW5kb20oKS0wLjUpICogMS4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlX21pY3JvJywgcG9zLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiA0LjAgKyBNYXRoLnJhbmRvbSgpICogMi4wLCAvLyBMb25nIGxpZmUgdG8gcmVhY2ggdG9wCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4wOCArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBTaGltbWVyeSBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtU3BlZWQgKyAoTWF0aC5yYW5kb20oKSAqIDIuMCksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLjEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfYWR2YW5jZVN0YXRlKCkgewogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuc3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2dvYWwnOgogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCh0aGlzLm5leHRTdGF0ZVBheWxvYWQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncmVzZXQnOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHRoaXMubmV4dFN0YXRlUGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdraWNrb2ZmJzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdoYWxmdGltZSc6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Vjb25kSGFsZigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBPVCBvciBFbmQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdnb2xkZW5fZ29hbCc6CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4KSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7IC8vIFJlc3RvcmUgc3BlZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgQUlQbGF5ZXIgZXh0ZW5kcyAod2luZG93LmZsdXguUGxheWVyIHx8IGNsYXNzIHt9KSB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBTdGF0ZSBNYWNoaW5lCi8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwp0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjE1OyAvLyBTbmFwcGllciBkZWNpc2lvbnMgKHdhcyAwLjI1KQoKICAgICAgICAgICAgLy8gU3R1Y2sgRGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgPSAwOwogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDEuNTsgCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuMjsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSb2xlIENvbmZpZwogICAgICAgICAgICB0aGlzLmlzRm9yd2FyZCA9IFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKTsKICAgICAgICAgICAgdGhpcy5pc01pZGZpZWxkZXIgPSByb2xlID09PSAnTUYnOwogICAgICAgICAgICB0aGlzLmlzRGVmZW5kZXIgPSBbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSk7CgogICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICBjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICBjb25zdCBwaWNrID0gKGFycikgPT4gYXJyW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGFyci5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gKHByb2IpID0+IE1hdGgucmFuZG9tKCkgPCBwcm9iOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMuc2hvb3QgPSBwaWNrKHNob290VGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc1ByYWN0aWNlID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzQWN0aXZlICYmICFpc1ByYWN0aWNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICBjb25zdCBpc1RlYW1BSUVuYWJsZWQgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uYWlFbmFibGVkIDogdHJ1ZTsKCiAgICAgICAgICAgIGlmIChpc0luY2FwYWNpdGF0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOyAvLyBSZXNldCBzdHVjayBpZiBzdHVubmVkCiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gU1RVQ0sgREVURUNUSU9OIC0tLQogICAgICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja0NoZWNrVGltZXIgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubGFzdFN0dWNrUG9zKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0cnlpbmcgdG8gbW92ZSAoaW5wdXQgYWN0aXZlKSBidXQgbW92ZWQgdmVyeSBsaXR0bGUKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDAuNSAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RTdHVja1Bvcy5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCl9ldmFsdWF0ZVN0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwoKICAgICAgICAgICAgLy8gMS4gUG9zc2Vzc2lvbgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVW5zdHVjayBQcmlvcml0eQogICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnVU5TVFVDSyc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBDb250ZXh0CiAgICAgICAgICAgIGNvbnN0IG15UG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IG15UG9zLmRpc3RhbmNlVG9TcXVhcmVkKGJhbGxQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ291bnQgdGVhbW1hdGVzIGNsb3NlciB0byBiYWxsIChBbnRpLVN3YXJtKQogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsUG9zKSA8IG15RGlzdFNxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlckNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhbUlDbG9zZXN0ID0gKGNsb3NlckNvdW50ID09PSAwKTsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbS5zaWRlOyAvLyAxIChEZWZlbmRzICtaKSwgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIC8vIHJlbGF0aXZlWiA+IDAgaXMgZGVmZW5zaXZlIGhhbGYsIHJlbGF0aXZlWiA8IDAgaXMgYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVaID0gYmFsbFBvcy56ICogc2lkZTsgCgogICAgICAgICAgICAvLyA0LiBSb2xlLUJhc2VkIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwgLSBEZWZlbnNlIFBoYXNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaWN0IFN3YXJtIENvbnRyb2w6IE1heCAyIHBsYXllcnMgY2hhc2luZy9wcmVzc2luZwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYXNlTGltaXQgPSAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbkNoYXNlID0gKGNsb3NlckNvdW50IDwgY2hhc2VMaW1pdCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXJzOiBDb25zZXJ2YXRpdmUuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGFzZSBvbmx5IGlmIGJhbGwgaXMgaW4gZGVmZW5zaXZlIHRlcnJpdG9yeSAoPiAtMTApIE9SIGlmIEkgYW0gdGhlIGFic29sdXRlIGNsb3Nlc3QuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaG9sZCBmb3JtYXRpb24vbWFyay4KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5EZWZlbnNpdmVab25lID0gKHJlbGF0aXZlWiA+IC0xMCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChpbkRlZmVuc2l2ZVpvbmUgfHwgYW1JQ2xvc2VzdCkgJiYgY2FuQ2hhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yd2FyZHM6IFByZXNzIGhpZ2guCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoYXNlIGlmIGJhbGwgaXMgaW4gYXR0YWNraW5nIHRlcnJpdG9yeSAoPCAxNSkuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGdvZXMgZGVlcCBpbnRvIG91ciBkZWZlbnNlIChyZWxhdGl2ZVogPiAxNSksIHN0b3AgY2hhc2luZyBhbmQgc3RheSBoaWdoL21hcmsuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluUHJlc3Npbmdab25lID0gKHJlbGF0aXZlWiA8IDE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpblByZXNzaW5nWm9uZSAmJiBjYW5DaGFzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOyAvLyBXaWxsIHJldHVybiB0byBob21lIHBvcy9tYXJrCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogVGhlIEVuZ2luZS4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuIGNoYXNlIGFueXdoZXJlIGlmIHdpdGhpbiBsaW1pdC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbkNoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGlzIEZyZWUgKExvb3NlIEJhbGwpCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eTogQ2xvc2VzdCAyIHBsYXllcnMgZ28gZm9yIGl0IHJlZ2FyZGxlc3Mgb2Ygcm9sZSAoc2NyYW1ibGUpCiAgICAgICAgICAgICAgICBpZiAoY2xvc2VyQ291bnQgPCAyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewpjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdVTlNUVUNLJzogdGhpcy5fc3RhdGVVbnN0dWNrKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVVuc3R1Y2soZHQpIHsKICAgICAgICAgICAgIC8vIE1vdmUgaW4gYSByYW5kb20gZGlyZWN0aW9uIHRvIGJyZWFrIGZyZWUKICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4xKSB7IAogICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIC8vIFRyeSB0byBkYXNoIGlmIHN0dWNrCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gMTAgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2goTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIH0KfQogICAgICAgIH0KCl9zdGF0ZUF0dGFja0NhcnJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNUQVQgQkFTRUQgREVDSVNJT04gTUFLSU5HIC0tLQogICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgY29uc3QgZW4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICBjb25zdCBjdXJyZW50RU4gPSB0aGlzLmN1cnJlbnRFTjsKCiAgICAgICAgICAgIC8vIDEuIE1vdmVtZW50CiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBTaG9vdGluZyBEZWNpc2lvbgogICAgICAgICAgICAvLyBCYXNlIHJhbmdlIDIwbS4gSGlnaCBTSCBleHRlbmRzIGVmZmVjdGl2ZSByYW5nZSB1cCB0byB+NDBtLgogICAgICAgICAgICBjb25zdCBzaG9vdFJhbmdlID0gMjAuMCArIChzaCAqIDAuMik7IAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCBzaG9vdFJhbmdlICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIC8vIElmIHZlcnkgY2xvc2UsIGFsd2F5cyBzaG9vdAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIGZ1cnRoZXIgb3V0LCBjaGVjayBpZiB3ZSBwcmVmZXIgc2hvb3Rpbmcgb3ZlciBkcmliYmxpbmcKICAgICAgICAgICAgICAgIC8vIEhpZ2ggU0ggbWFrZXMgdXMgc2hvb3QgZWFybGllcgogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoc2ggLyAxNTAuMCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBQYXNzaW5nIC8gRHJpYmJsaW5nIERlY2lzaW9uCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IGN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVuZGVuY3kgdG8gUGFzcyB2cyBIb2xkCiAgICAgICAgICAgIC8vIEhpZ2ggUEEgcmVsYXRpdmUgdG8gRU4gLT4gUGFzcwogICAgICAgICAgICAvLyBIaWdoIEVOIC0+IEhvbGQKICAgICAgICAgICAgY29uc3QgcGFzc1RlbmRlbmN5ID0gKHBhIC8gKGVuICsgMSkpICogMS41OyAvLyA+IDEuMCBtZWFucyBwcmVmZXJzIHBhc3NpbmcKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBzaG91bGRMb29rRm9yUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCkgewogICAgICAgICAgICAgICAgLy8gVW5kZXIgcHJlc3N1cmUKICAgICAgICAgICAgICAgIC8vIElmIGN1cnJlbnQgRU4gaXMgbG93LCB3ZSBtdXN0IHBhc3MKICAgICAgICAgICAgICAgIGlmIChsb3dFTikgewogICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgRU4gaXMgaGlnaCBlbm91Z2ggdG8gdGFuayBhIHRhY2tsZSAoZS5nLiA+IDMwKSwgYW5kIHdlIGhhdmUgbG93IFBhc3MgdGVuZGVuY3ksIGhvbGQuCiAgICAgICAgICAgICAgICAgICAgLy8gIkhlcm8gQmFsbCIgY2hlY2sKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVOID4gMzAgJiYgcGFzc1RlbmRlbmN5IDwgMC44KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gZmFsc2U7IC8vIERyaWJibGUgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsgLy8gUGFuaWMgcGFzcwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE9wZW4gcGxheQogICAgICAgICAgICAgICAgLy8gSWYgUGxheW1ha2VyIChIaWdoIFBBKSwgbG9vayBmb3IgcGFzc2VzIGNvbnN0YW50bHkKICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBzaG91bGRMb29rRm9yUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzaG91bGRMb29rRm9yUGFzcyAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyZXNob2xkIHRvIHBhc3M6CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSSdtIGEgc2hvb3RlciAobG93IHBhc3NUZW5kZW5jeSksIG1hdGUgbXVzdCBiZSBzaWduaWZpY2FudGx5IGNsb3NlcgogICAgICAgICAgICAgICAgICAgIC8vIElmIEknbSBhIHBhc3NlciwgbWF0ZSBqdXN0IG5lZWRzIHRvIGJlIHNvbWV3aGF0IGJldHRlciBvciBvcGVuCiAgICAgICAgICAgICAgICAgICAgbGV0IGltcHJvdmVtZW50TmVlZGVkID0gNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjUpIGltcHJvdmVtZW50TmVlZGVkID0gLTUuMDsgLy8gV2lsbCBwYXNzIGJhY2t3YXJkcyB0byByZXNldAogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPCAwLjUpIGltcHJvdmVtZW50TmVlZGVkID0gMTUuMDsgLy8gQmFsbCBob2cKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSBpbXByb3ZlbWVudE5lZWRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWxzYWZlOiBJZiBzdXJyb3VuZGVkIGFuZCBkaWRuJ3QgcGFzcyAob3IgY291bGRuJ3QpLCB0cnkgdG8gc2hvb3QgaWYgY2xvc2UgZW5vdWdoCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiBkaXN0VG9Hb2FsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zdGF0ZUNoYXNlKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZJWDogQWxsb3cgZW50ZXJpbmcgZ29hbCBjcmVhc2UgaWYgYmFsbCBpcyBpbnNpZGUgaXQgKHByZXZlbnQgc3R1Y2sgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbEluQ3JlYXNlID0gdGhpcy5faXNQb3NJbkNyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgaWYgKCFiYWxsSW5DcmVhc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gQUkgVEFDS0xFIExPR0lDCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0ZW1wdFRhY2tsZShiYWxsLmhvbGRlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRk9SV0FSRFM6IFNlZWsgU2NvcmluZyBQb3NpdGlvbnMgJiBPcGVuIFNwYWNlCiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgLy8gV2VhdmUgdG8gc2hha2UgbWFya2VycwogICAgICAgICAgICAgICAgY29uc3Qgd2VhdmUgPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWRlYWwgcG9zaXRpb246IERlZXAgaW4gYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gKGJhbGxQb3MueiArIHRhcmdldEdvYWxaKSAqIDAuNTU7IC8vIEJpYXNlZCB0b3dhcmRzIGdvYWwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRG9uJ3QgcnVuIHRvbyBmYXIgYWhlYWQgb2YgdGhlIGJhbGwgKHN0YXkgY29ubmVjdGVkKQogICAgICAgICAgICAgICAgY29uc3QgbWF4TGVhZCA9IDI1LjA7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModGFyZ2V0WiAtIGJhbGxQb3MueikgPiBtYXhMZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiBtYXhMZWFkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCh0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmUgKiAwLjMsIDAsIHRhcmdldFopOwoKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgQ2hlY2s6IElzIHBhc3MgYmxvY2tlZD8KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3RyYXRlZ3kgMTogR28gV2lkZQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwKSA/IDIwIDogLTIwOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTdHJhdGVneSAyOiBDaGVjayBUbyBCYWxsIChDb21lIFNob3J0KQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDguMCk7IAogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzIsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1JREZJRUxERVJTOiBMaW5rIFBsYXkKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuNikgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgaW4gdHJvdWJsZTogQ29tZSBjbG9zZSB0byBvZmZlciBhbiBvdXRsZXQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWRlID0gKHRoaXMubWVzaC5wb3NpdGlvbi54ID4gYmFsbFBvcy54KSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKyAoc2lkZSAqIDguMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7IC8vIFNxdWFyZSBvciBzbGlnaHRseSBiYWNrCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgc2FmZTogUHVzaCBmb3J3YXJkIGludG8gcG9ja2V0CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTIuMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXZvaWQgY3Jvd2RpbmcgdGhlIGNhcnJpZXIgdG9vIG11Y2gKICAgICAgICAgICAgICAgIGlmIChfdGFyZ2V0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcykgPCA2LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyhfdGFyZ2V0UG9zLCBiYWxsUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig2LjApOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShiYWxsUG9zKS5hZGQoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZFTkRFUlM6IFNhZmV0eSBCdWZmZXIgKFByZXZlbnQgQ291bnRlcnMpCiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlCdWZmZXIgPSAxOC4wOwogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5QnVmZmVyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gT3duIGdvYWwgWgogICAgICAgICAgICAgICAgY29uc3Qgb3duR29hbFogPSAtdGFyZ2V0R29hbFo7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsYW1wIHNvIHRoZXkgZG9uJ3Qgc2l0IG9uIHRoZWlyIG93biBnb2FsaWUgaWYgdGhlIGJhbGwgaXMgaGlnaCB1cAogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7IC8vIEF0dGFja2luZyAtWiAoSG9tZSksIE93biBHb2FsICtaCiAgICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBNYXRoLm1pbihvd25Hb2FsWiAtIDE1LCB0YXJnZXRaKTsgCiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBBdHRhY2tpbmcgK1ogKEF3YXkpLCBPd24gR29hbCAtWgogICAgICAgICAgICAgICAgICAgICB0YXJnZXRaID0gTWF0aC5tYXgob3duR29hbFogKyAxNSwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQodGhpcy5ob21lUG9zaXRpb24ueCwgMCwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IHNsaWdodGx5IHRvd2FyZHMgYmFsbCBYIHRvIGNvdmVyIGNlbnRlcgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoX3RhcmdldFBvcy54LCBiYWxsUG9zLngsIDAuMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIFNpZGUgMSBkZWZlbmRzICtaLCBTaWRlIC0xIGRlZmVuZHMgLVoKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIGNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZWQgZmFjdG9ycyAoMC4wIHRvIDEuMCwgYXNzdW1pbmcgbWF4IH45OSkKICAgICAgICAgICAgY29uc3QgYWdncm9GYWN0b3IgPSBNYXRoLm1pbigxLjAsIGF0IC8gODAuMCk7IC8vIEhpZ2ggQVQgPSBBZ2dyZXNzaXZlCiAgICAgICAgICAgIGNvbnN0IGxhbmVGYWN0b3IgPSBNYXRoLm1pbigxLjAsIGJsIC8gODAuMCk7ICAvLyBIaWdoIEJMID0gU21hcnQgUG9zaXRpb25pbmcKCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBNQU4gTUFSS0lORyAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBHb2FsLVNpZGUgUG9zaXRpb24KICAgICAgICAgICAgICAgIC8vIFZlY3RvciBmcm9tIG1hcmsgdG8gbXkgZ29hbAogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBteUdvYWxaIC0gbWFya1Bvcy56KTsgCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGRpcmVjdGlvbiBvbmx5IG9uIFogZm9yIHN0YWJpbGl0eT8gTm8sIGZ1bGwgM0QgZGlyZWN0aW9uIHRvIGJsb2NrIHNob3QuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgc3RheWluZyAiZ29hbCBzaWRlIiB1c3VhbGx5IG1lYW5zIHN0YXlpbmcgb24gdGhlIGxpbmUgYmV0d2VlbiBwbGF5ZXIgYW5kIGdvYWwgY2VudGVyLgogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnggPSAwIC0gbWFya1Bvcy54OyAvLyBHb2FsIGNlbnRlciBYIGlzIDAKICAgICAgICAgICAgICAgIC8vIF90ZW1wVmVjMS56IGlzIGFscmVhZHkgc2V0CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEueSA9IDA7IC8vIFN0YXkgb24gZ3JvdW5kIHBsYW5lIGZvciBwb3NpdGlvbmluZyBsb2dpYwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0YW5jZSB0byBrZWVwIGZyb20gbWFyawogICAgICAgICAgICAgICAgLy8gSGlnaCBBVCA9IFRpZ2h0ZXIgKDEuNW0pLCBMb3cgQVQgPSBMb29zZXIgKDUuMG0pCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrRGlzdCA9IDUuMCAtIChhZ2dyb0ZhY3RvciAqIDMuNSk7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgbWFya0Rpc3QpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBMYW5lIEN1dHRpbmcgKEJMIFN0YXQpCiAgICAgICAgICAgICAgICAvLyBJZiBtYXJrIGRvZXNuJ3QgaGF2ZSBiYWxsLCB0cnkgdG8gaW50ZXJjZXB0IHBhc3MgZnJvbSBiYWxsIGhvbGRlcgogICAgICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuaG9sZGVyICE9PSB0aGlzLm1hcmtpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBiYWxsIHRvIG1hcmsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzIuc3ViVmVjdG9ycyhtYXJrUG9zLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcG9pbnQ6IHNsaWdodGx5IGluIGZyb250IG9mIG1hcmsgdG93YXJkcyBiYWxsCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJjZXB0UG9zID0gbWFya1Bvcy5jbG9uZSgpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzIsIC0yLjUpOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCbGVuZCBiYXNlZCBvbiBCTCBzdGF0IChIaWdoIEJMID0gcHJpb3JpdGl6ZSBpbnRlcmNlcHRpb24gbGFuZSkKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoaW50ZXJjZXB0UG9zLCBsYW5lRmFjdG9yICogMC43KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gUHJlc3NpbmcgKElmIG1hcmsgaGFzIGJhbGwpCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIC8vIElmIGhpZ2ggQVQsIGdldCB2ZXJ5IGNsb3NlIHRvIGZvcmNlIGFjdGlvbgogICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAobWFya1BvcywgYWdncm9GYWN0b3IgKiAwLjYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBaT05FIERFRkVOU0UgLS0tCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGZvcm1hdGlvbiB0b3dhcmRzIGJhbGwgKENvbXByZXNzaW9uKQogICAgICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyB3aXRoIGhpZ2ggQkwgcmVhZCB0aGUgZ2FtZSBiZXR0ZXIgYW5kIHNoaWZ0IG1vcmUgZWZmZWN0aXZlbHkKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGlmdFdlaWdodCA9IDAuMiArIChsYW5lRmFjdG9yICogMC40KTsgLy8gMC4yIHRvIDAuNgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLngsIGJhbGxQb3MueCwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLnosIGJhbGxQb3Mueiwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb21tb24gY29uc3RyYWludHMKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICAvLyBPcHBvcnR1bmlzdGljIFRhY2tsZQogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLmhvbGRlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIFRhY2tsZSByYW5nZSBpbmNyZWFzZXMgd2l0aCBBVCAoQ29uZmlkZW5jZSkKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVJhbmdlID0gOC4wICsgKGFnZ3JvRmFjdG9yICogNS4wKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGFja2xlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdHRlbXB0VGFja2xlKGJhbGwuaG9sZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9pc1Bvc0luQ3JlYXNlKHBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbeyB4OiAwLCB6OiAtZ29hbERpc3QgfSwgeyB4OiAwLCB6OiBnb2FsRGlzdCB9XTsKICAgICAgICAgICAgZm9yIChsZXQgZyBvZiBnb2FscykgewogICAgICAgICAgICAgICAgY29uc3QgZHggPSBwb3MueCAtIGcueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gcG9zLnogLSBnLno7CiAgICAgICAgICAgICAgICBpZiAoZHgqZHggKyBkeipkeiA8IGNyZWFzZVJhZGl1cypjcmVhc2VSYWRpdXMpIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDQuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChtYXRlLm1lc2gucG9zaXRpb24pKSBjb250aW51ZTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IDA7CiAgICAgICAgICAgICAgICBjb25zdCBteURpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0VG9Hb2FsID0gTWF0aC5hYnMobWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG15RGlzdFRvR29hbCAtIG1hdGVEaXN0VG9Hb2FsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzY29yZSArPSBwcm9ncmVzcyAqIDEuNTsgCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIGNvbnN0IG9wZW5uZXNzID0gdGhpcy5fY2FsY3VsYXRlT3Blbm5lc3MobWF0ZSk7CiAgICAgICAgICAgICAgICBzY29yZSArPSBvcGVubmVzcyAqIDMuMDsKCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKICAgICAgICAgICAgICAgIHNjb3JlIC09IGRpc3QgKiAwLjU7CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZU9wZW5uZXNzKHBsYXllcikgewogICAgICAgICAgICBsZXQgbWluRGVmRGlzdCA9IDk5OTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRGVmRGlzdCkgbWluRGVmRGlzdCA9IGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKG1pbkRlZkRpc3QsIDguMCk7CiAgICAgICAgfQoKICAgICAgICBfaXNQYXRoQmxvY2tlZCh0YXJnZXRQb3MsIHN0YXJ0UG9zID0gbnVsbCkgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHN0YXJ0UG9zIHx8IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgX3NjYW5EaXIuc3ViVmVjdG9ycyhlbmQsIHN0YXJ0KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3Qgc2FmZXR5UmFkaXVzID0gMi41OyAKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnMob3BwLm1lc2gucG9zaXRpb24sIHN0YXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBfc2NhblRvT3BwLmRvdChfc2NhbkRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlcnBEaXN0U3EgPSBfc2NhblRvT3BwLmxlbmd0aFNxKCkgLSAocHJvamVjdGlvbiAqIHByb2plY3Rpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChwZXJwRGlzdFNxIDwgKHNhZmV0eVJhZGl1cyAqIHNhZmV0eVJhZGl1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9tb3ZlVG8odGFyZ2V0KSB7CiAgICAgICAgICAgIF9haVZlYy5zdWJWZWN0b3JzKHRhcmdldCwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgX2FpVmVjLnkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gX2FpVmVjLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDEuMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAoYmFsbC5pc0ludmlzaWJsZSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGxldCByYW5nZSA9IDIuMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2JyYXdsZXInIHx8IHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2VsaXRlX2RlZmVuc2UnKSB7CiAgICAgICAgICAgICAgICByYW5nZSArPSAxLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBpZiAoZGlzdCA+IHJhbmdlKSByZXR1cm47CgogICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnModGhpcy5tZXNoLnBvc2l0aW9uLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGhlYWRpbmdEb3QgPSBfdGVtcFZlYzEuZG90KF9zY2FuVG9PcHApOwogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSAxLjU7CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID0gKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgfHwgMCkgKyBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7dmFsfWAsIGJhbGwubWVzaC5wb3NpdGlvbiwgImJsb2NrIiwgYmFsbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChfdGVtcFZlYzIsIDAuNik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgYmFsbC5wb3dlclR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXJUeXBlID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQkwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVByZXNzdXJlT25QbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIGlmICghcGxheWVyIHx8ICFwbGF5ZXIubWVzaCkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHBsYXllci50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBsZXQgcHJlc3N1cmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDEwLjApIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSArPSAoMTAuMCAtIGRpc3QpIC8gMTAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJlc3N1cmU7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRUZWFtbWF0ZXModGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5oYXNCYWxsKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRhcmdldFBvcy5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zdWJWZWN0b3JzKHRhcmdldFBvcywgbWF0ZS5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgNS4wIC0gZGlzdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KfQoKX2F0dGVtcHRUYWNrbGUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBFTjogTXVzdCBoYXZlIGVub3VnaCB0byB0YWNrbGUgKENvc3QgaXMgOCkKICAgICAgICAgICAgLy8gV2UgYWRkIGEgc21hbGwgYnVmZmVyICg5KSB0byBiZSBzYWZlIGFuZCBhdm9pZCBlZGdlIGNhc2Ugc3BhbSB3aGVyZSB0aGV5IHRyeSBhbmQgZmFpbAogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCA5KSByZXR1cm47IAoKICAgICAgICAgICAgLy8gMS4gUHJlZGljdCBUYXJnZXQgUG9zaXRpb24gKExlYWQgdGhlIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgbGVhZFRpbWUgPSAwLjI7IAogICAgICAgICAgICBjb25zdCBwcmVkaWN0ZWRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBwcmVkaWN0ZWRQb3MuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgbGVhZFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBDYWxjdWxhdGUgVmVjdG9yIHRvIFByZWRpY3RlZCBTcG90CiAgICAgICAgICAgIGNvbnN0IHRvUHJlZCA9IHByZWRpY3RlZFBvcy5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdG9QcmVkLnkgPSAwOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9QcmVkLmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUmFuZ2UgQ2hlY2sKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHJhbmdlIHRvIDE1LjBtCiAgICAgICAgICAgIGlmIChkaXN0IDwgMTUuMCkgewogICAgICAgICAgICAgICAgdG9QcmVkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBBbmdsZSBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGZ3ZC5kb3QodG9QcmVkKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBhbmdsZTogQWxsb3cgdGFja2xpbmcgaWYgdGFyZ2V0IGlzIGdlbmVyYWxseSBpbiBmcm9udCAoPiAwLjIgZG90KQogICAgICAgICAgICAgICAgLy8gU2xpZ2h0bHkgc3RyaWN0ZXIgdGhhbiAwLjAgdG8gcHJldmVudCB3ZWlyZCBzaWRlLWx1bmdlcwogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIDUuIFJlYWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICAgICAgLy8gSW50ZWxsaWdlbnQ6IERvbid0IGp1c3Qgc3BhbS4gUHJvYmFiaWxpdGllcyBwZXIgZnJhbWUgKGFzc3VtaW5nIH42MGZwcykuCiAgICAgICAgICAgICAgICAgICAgLy8gRmFyICg4LTE1bSk6IH4xIGF0dGVtcHQgcGVyIDEuNXMgKDAuMDEpCiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvc2UgKDMtOG0pOiB+MSBhdHRlbXB0IHBlciAwLjVzICgwLjAzKQogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rICg8M20pOiBBZ2dyZXNzaXZlICgwLjE1KQogICAgICAgICAgICAgICAgICAgIGxldCBjaGFuY2UgPSAwLjAxOyAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDguMCkgY2hhbmNlID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAzLjApIGNoYW5jZSA9IDAuMTU7IAoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGNoYW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTTkFQIFRVUk46IEFJIGNoZWF0cyByb3RhdGlvbiB0byBmYWNlIHRhcmdldCBwZXJmZWN0bHkgYmVmb3JlIGx1bmdpbmcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBlbnN1cmVzIHRoZSB0YWNrbGUgdmVjdG9yIGlzIGFjY3VyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMih0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSB0YXJnZXRBbmdsZSAtIHRoaXMucm90YXRpb25PZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRhY2tsZSh0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","./AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgQUlQbGF5ZXIgZXh0ZW5kcyAod2luZG93LmZsdXguUGxheWVyIHx8IGNsYXNzIHt9KSB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBTdGF0ZSBNYWNoaW5lCi8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwp0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjE1OyAvLyBTbmFwcGllciBkZWNpc2lvbnMgKHdhcyAwLjI1KQoKICAgICAgICAgICAgLy8gU3R1Y2sgRGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgPSAwOwogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDEuNTsgCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuMjsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSb2xlIENvbmZpZwogICAgICAgICAgICB0aGlzLmlzRm9yd2FyZCA9IFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKTsKICAgICAgICAgICAgdGhpcy5pc01pZGZpZWxkZXIgPSByb2xlID09PSAnTUYnOwogICAgICAgICAgICB0aGlzLmlzRGVmZW5kZXIgPSBbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSk7CgogICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICBjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICBjb25zdCBwaWNrID0gKGFycikgPT4gYXJyW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGFyci5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gKHByb2IpID0+IE1hdGgucmFuZG9tKCkgPCBwcm9iOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMuc2hvb3QgPSBwaWNrKHNob290VGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc1ByYWN0aWNlID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzQWN0aXZlICYmICFpc1ByYWN0aWNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICBjb25zdCBpc1RlYW1BSUVuYWJsZWQgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uYWlFbmFibGVkIDogdHJ1ZTsKCiAgICAgICAgICAgIGlmIChpc0luY2FwYWNpdGF0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOyAvLyBSZXNldCBzdHVjayBpZiBzdHVubmVkCiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gU1RVQ0sgREVURUNUSU9OIC0tLQogICAgICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja0NoZWNrVGltZXIgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubGFzdFN0dWNrUG9zKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0cnlpbmcgdG8gbW92ZSAoaW5wdXQgYWN0aXZlKSBidXQgbW92ZWQgdmVyeSBsaXR0bGUKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDAuNSAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RTdHVja1Bvcy5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCl9ldmFsdWF0ZVN0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwoKICAgICAgICAgICAgLy8gMS4gUG9zc2Vzc2lvbgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVW5zdHVjayBQcmlvcml0eQogICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnVU5TVFVDSyc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBDb250ZXh0CiAgICAgICAgICAgIGNvbnN0IG15UG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IG15UG9zLmRpc3RhbmNlVG9TcXVhcmVkKGJhbGxQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ291bnQgdGVhbW1hdGVzIGNsb3NlciB0byBiYWxsIChBbnRpLVN3YXJtKQogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsUG9zKSA8IG15RGlzdFNxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlckNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhbUlDbG9zZXN0ID0gKGNsb3NlckNvdW50ID09PSAwKTsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbS5zaWRlOyAvLyAxIChEZWZlbmRzICtaKSwgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIC8vIHJlbGF0aXZlWiA+IDAgaXMgZGVmZW5zaXZlIGhhbGYsIHJlbGF0aXZlWiA8IDAgaXMgYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVaID0gYmFsbFBvcy56ICogc2lkZTsgCgogICAgICAgICAgICAvLyA0LiBSb2xlLUJhc2VkIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwgLSBEZWZlbnNlIFBoYXNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaWN0IFN3YXJtIENvbnRyb2w6IE1heCAyIHBsYXllcnMgY2hhc2luZy9wcmVzc2luZwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYXNlTGltaXQgPSAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbkNoYXNlID0gKGNsb3NlckNvdW50IDwgY2hhc2VMaW1pdCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXJzOiBDb25zZXJ2YXRpdmUuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGFzZSBvbmx5IGlmIGJhbGwgaXMgaW4gZGVmZW5zaXZlIHRlcnJpdG9yeSAoPiAtMTApIE9SIGlmIEkgYW0gdGhlIGFic29sdXRlIGNsb3Nlc3QuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaG9sZCBmb3JtYXRpb24vbWFyay4KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5EZWZlbnNpdmVab25lID0gKHJlbGF0aXZlWiA+IC0xMCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChpbkRlZmVuc2l2ZVpvbmUgfHwgYW1JQ2xvc2VzdCkgJiYgY2FuQ2hhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yd2FyZHM6IFByZXNzIGhpZ2guCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoYXNlIGlmIGJhbGwgaXMgaW4gYXR0YWNraW5nIHRlcnJpdG9yeSAoPCAxNSkuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGdvZXMgZGVlcCBpbnRvIG91ciBkZWZlbnNlIChyZWxhdGl2ZVogPiAxNSksIHN0b3AgY2hhc2luZyBhbmQgc3RheSBoaWdoL21hcmsuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluUHJlc3Npbmdab25lID0gKHJlbGF0aXZlWiA8IDE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpblByZXNzaW5nWm9uZSAmJiBjYW5DaGFzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOyAvLyBXaWxsIHJldHVybiB0byBob21lIHBvcy9tYXJrCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogVGhlIEVuZ2luZS4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuIGNoYXNlIGFueXdoZXJlIGlmIHdpdGhpbiBsaW1pdC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbkNoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGlzIEZyZWUgKExvb3NlIEJhbGwpCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eTogQ2xvc2VzdCAyIHBsYXllcnMgZ28gZm9yIGl0IHJlZ2FyZGxlc3Mgb2Ygcm9sZSAoc2NyYW1ibGUpCiAgICAgICAgICAgICAgICBpZiAoY2xvc2VyQ291bnQgPCAyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewpjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdVTlNUVUNLJzogdGhpcy5fc3RhdGVVbnN0dWNrKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVVuc3R1Y2soZHQpIHsKICAgICAgICAgICAgIC8vIE1vdmUgaW4gYSByYW5kb20gZGlyZWN0aW9uIHRvIGJyZWFrIGZyZWUKICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4xKSB7IAogICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIC8vIFRyeSB0byBkYXNoIGlmIHN0dWNrCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gMTAgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2goTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIH0KfQogICAgICAgIH0KCl9zdGF0ZUF0dGFja0NhcnJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNUQVQgQkFTRUQgREVDSVNJT04gTUFLSU5HIC0tLQogICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgY29uc3QgZW4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICBjb25zdCBjdXJyZW50RU4gPSB0aGlzLmN1cnJlbnRFTjsKCiAgICAgICAgICAgIC8vIDEuIE1vdmVtZW50CiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBTaG9vdGluZyBEZWNpc2lvbgogICAgICAgICAgICAvLyBCYXNlIHJhbmdlIDIwbS4gSGlnaCBTSCBleHRlbmRzIGVmZmVjdGl2ZSByYW5nZSB1cCB0byB+NDBtLgogICAgICAgICAgICBjb25zdCBzaG9vdFJhbmdlID0gMjAuMCArIChzaCAqIDAuMik7IAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCBzaG9vdFJhbmdlICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIC8vIElmIHZlcnkgY2xvc2UsIGFsd2F5cyBzaG9vdAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIGZ1cnRoZXIgb3V0LCBjaGVjayBpZiB3ZSBwcmVmZXIgc2hvb3Rpbmcgb3ZlciBkcmliYmxpbmcKICAgICAgICAgICAgICAgIC8vIEhpZ2ggU0ggbWFrZXMgdXMgc2hvb3QgZWFybGllcgogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoc2ggLyAxNTAuMCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBQYXNzaW5nIC8gRHJpYmJsaW5nIERlY2lzaW9uCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IGN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVuZGVuY3kgdG8gUGFzcyB2cyBIb2xkCiAgICAgICAgICAgIC8vIEhpZ2ggUEEgcmVsYXRpdmUgdG8gRU4gLT4gUGFzcwogICAgICAgICAgICAvLyBIaWdoIEVOIC0+IEhvbGQKICAgICAgICAgICAgY29uc3QgcGFzc1RlbmRlbmN5ID0gKHBhIC8gKGVuICsgMSkpICogMS41OyAvLyA+IDEuMCBtZWFucyBwcmVmZXJzIHBhc3NpbmcKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBzaG91bGRMb29rRm9yUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCkgewogICAgICAgICAgICAgICAgLy8gVW5kZXIgcHJlc3N1cmUKICAgICAgICAgICAgICAgIC8vIElmIGN1cnJlbnQgRU4gaXMgbG93LCB3ZSBtdXN0IHBhc3MKICAgICAgICAgICAgICAgIGlmIChsb3dFTikgewogICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgRU4gaXMgaGlnaCBlbm91Z2ggdG8gdGFuayBhIHRhY2tsZSAoZS5nLiA+IDMwKSwgYW5kIHdlIGhhdmUgbG93IFBhc3MgdGVuZGVuY3ksIGhvbGQuCiAgICAgICAgICAgICAgICAgICAgLy8gIkhlcm8gQmFsbCIgY2hlY2sKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVOID4gMzAgJiYgcGFzc1RlbmRlbmN5IDwgMC44KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gZmFsc2U7IC8vIERyaWJibGUgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsgLy8gUGFuaWMgcGFzcwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE9wZW4gcGxheQogICAgICAgICAgICAgICAgLy8gSWYgUGxheW1ha2VyIChIaWdoIFBBKSwgbG9vayBmb3IgcGFzc2VzIGNvbnN0YW50bHkKICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBzaG91bGRMb29rRm9yUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzaG91bGRMb29rRm9yUGFzcyAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyZXNob2xkIHRvIHBhc3M6CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSSdtIGEgc2hvb3RlciAobG93IHBhc3NUZW5kZW5jeSksIG1hdGUgbXVzdCBiZSBzaWduaWZpY2FudGx5IGNsb3NlcgogICAgICAgICAgICAgICAgICAgIC8vIElmIEknbSBhIHBhc3NlciwgbWF0ZSBqdXN0IG5lZWRzIHRvIGJlIHNvbWV3aGF0IGJldHRlciBvciBvcGVuCiAgICAgICAgICAgICAgICAgICAgbGV0IGltcHJvdmVtZW50TmVlZGVkID0gNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjUpIGltcHJvdmVtZW50TmVlZGVkID0gLTUuMDsgLy8gV2lsbCBwYXNzIGJhY2t3YXJkcyB0byByZXNldAogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPCAwLjUpIGltcHJvdmVtZW50TmVlZGVkID0gMTUuMDsgLy8gQmFsbCBob2cKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSBpbXByb3ZlbWVudE5lZWRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWxzYWZlOiBJZiBzdXJyb3VuZGVkIGFuZCBkaWRuJ3QgcGFzcyAob3IgY291bGRuJ3QpLCB0cnkgdG8gc2hvb3QgaWYgY2xvc2UgZW5vdWdoCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiBkaXN0VG9Hb2FsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zdGF0ZUNoYXNlKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZJWDogQWxsb3cgZW50ZXJpbmcgZ29hbCBjcmVhc2UgaWYgYmFsbCBpcyBpbnNpZGUgaXQgKHByZXZlbnQgc3R1Y2sgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbEluQ3JlYXNlID0gdGhpcy5faXNQb3NJbkNyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgaWYgKCFiYWxsSW5DcmVhc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gQUkgVEFDS0xFIExPR0lDCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0ZW1wdFRhY2tsZShiYWxsLmhvbGRlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRk9SV0FSRFM6IFNlZWsgU2NvcmluZyBQb3NpdGlvbnMgJiBPcGVuIFNwYWNlCiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgLy8gV2VhdmUgdG8gc2hha2UgbWFya2VycwogICAgICAgICAgICAgICAgY29uc3Qgd2VhdmUgPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWRlYWwgcG9zaXRpb246IERlZXAgaW4gYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gKGJhbGxQb3MueiArIHRhcmdldEdvYWxaKSAqIDAuNTU7IC8vIEJpYXNlZCB0b3dhcmRzIGdvYWwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRG9uJ3QgcnVuIHRvbyBmYXIgYWhlYWQgb2YgdGhlIGJhbGwgKHN0YXkgY29ubmVjdGVkKQogICAgICAgICAgICAgICAgY29uc3QgbWF4TGVhZCA9IDI1LjA7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModGFyZ2V0WiAtIGJhbGxQb3MueikgPiBtYXhMZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiBtYXhMZWFkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCh0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmUgKiAwLjMsIDAsIHRhcmdldFopOwoKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgQ2hlY2s6IElzIHBhc3MgYmxvY2tlZD8KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3RyYXRlZ3kgMTogR28gV2lkZQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwKSA/IDIwIDogLTIwOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTdHJhdGVneSAyOiBDaGVjayBUbyBCYWxsIChDb21lIFNob3J0KQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDguMCk7IAogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzIsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1JREZJRUxERVJTOiBMaW5rIFBsYXkKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuNikgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgaW4gdHJvdWJsZTogQ29tZSBjbG9zZSB0byBvZmZlciBhbiBvdXRsZXQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWRlID0gKHRoaXMubWVzaC5wb3NpdGlvbi54ID4gYmFsbFBvcy54KSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKyAoc2lkZSAqIDguMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7IC8vIFNxdWFyZSBvciBzbGlnaHRseSBiYWNrCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgc2FmZTogUHVzaCBmb3J3YXJkIGludG8gcG9ja2V0CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTIuMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXZvaWQgY3Jvd2RpbmcgdGhlIGNhcnJpZXIgdG9vIG11Y2gKICAgICAgICAgICAgICAgIGlmIChfdGFyZ2V0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcykgPCA2LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyhfdGFyZ2V0UG9zLCBiYWxsUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig2LjApOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShiYWxsUG9zKS5hZGQoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZFTkRFUlM6IFNhZmV0eSBCdWZmZXIgKFByZXZlbnQgQ291bnRlcnMpCiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlCdWZmZXIgPSAxOC4wOwogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5QnVmZmVyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gT3duIGdvYWwgWgogICAgICAgICAgICAgICAgY29uc3Qgb3duR29hbFogPSAtdGFyZ2V0R29hbFo7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsYW1wIHNvIHRoZXkgZG9uJ3Qgc2l0IG9uIHRoZWlyIG93biBnb2FsaWUgaWYgdGhlIGJhbGwgaXMgaGlnaCB1cAogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7IC8vIEF0dGFja2luZyAtWiAoSG9tZSksIE93biBHb2FsICtaCiAgICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBNYXRoLm1pbihvd25Hb2FsWiAtIDE1LCB0YXJnZXRaKTsgCiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBBdHRhY2tpbmcgK1ogKEF3YXkpLCBPd24gR29hbCAtWgogICAgICAgICAgICAgICAgICAgICB0YXJnZXRaID0gTWF0aC5tYXgob3duR29hbFogKyAxNSwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQodGhpcy5ob21lUG9zaXRpb24ueCwgMCwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IHNsaWdodGx5IHRvd2FyZHMgYmFsbCBYIHRvIGNvdmVyIGNlbnRlcgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoX3RhcmdldFBvcy54LCBiYWxsUG9zLngsIDAuMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIFNpZGUgMSBkZWZlbmRzICtaLCBTaWRlIC0xIGRlZmVuZHMgLVoKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIGNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZWQgZmFjdG9ycyAoMC4wIHRvIDEuMCwgYXNzdW1pbmcgbWF4IH45OSkKICAgICAgICAgICAgY29uc3QgYWdncm9GYWN0b3IgPSBNYXRoLm1pbigxLjAsIGF0IC8gODAuMCk7IC8vIEhpZ2ggQVQgPSBBZ2dyZXNzaXZlCiAgICAgICAgICAgIGNvbnN0IGxhbmVGYWN0b3IgPSBNYXRoLm1pbigxLjAsIGJsIC8gODAuMCk7ICAvLyBIaWdoIEJMID0gU21hcnQgUG9zaXRpb25pbmcKCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBNQU4gTUFSS0lORyAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBHb2FsLVNpZGUgUG9zaXRpb24KICAgICAgICAgICAgICAgIC8vIFZlY3RvciBmcm9tIG1hcmsgdG8gbXkgZ29hbAogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBteUdvYWxaIC0gbWFya1Bvcy56KTsgCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGRpcmVjdGlvbiBvbmx5IG9uIFogZm9yIHN0YWJpbGl0eT8gTm8sIGZ1bGwgM0QgZGlyZWN0aW9uIHRvIGJsb2NrIHNob3QuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgc3RheWluZyAiZ29hbCBzaWRlIiB1c3VhbGx5IG1lYW5zIHN0YXlpbmcgb24gdGhlIGxpbmUgYmV0d2VlbiBwbGF5ZXIgYW5kIGdvYWwgY2VudGVyLgogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnggPSAwIC0gbWFya1Bvcy54OyAvLyBHb2FsIGNlbnRlciBYIGlzIDAKICAgICAgICAgICAgICAgIC8vIF90ZW1wVmVjMS56IGlzIGFscmVhZHkgc2V0CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEueSA9IDA7IC8vIFN0YXkgb24gZ3JvdW5kIHBsYW5lIGZvciBwb3NpdGlvbmluZyBsb2dpYwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0YW5jZSB0byBrZWVwIGZyb20gbWFyawogICAgICAgICAgICAgICAgLy8gSGlnaCBBVCA9IFRpZ2h0ZXIgKDEuNW0pLCBMb3cgQVQgPSBMb29zZXIgKDUuMG0pCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrRGlzdCA9IDUuMCAtIChhZ2dyb0ZhY3RvciAqIDMuNSk7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgbWFya0Rpc3QpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBMYW5lIEN1dHRpbmcgKEJMIFN0YXQpCiAgICAgICAgICAgICAgICAvLyBJZiBtYXJrIGRvZXNuJ3QgaGF2ZSBiYWxsLCB0cnkgdG8gaW50ZXJjZXB0IHBhc3MgZnJvbSBiYWxsIGhvbGRlcgogICAgICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuaG9sZGVyICE9PSB0aGlzLm1hcmtpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBiYWxsIHRvIG1hcmsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzIuc3ViVmVjdG9ycyhtYXJrUG9zLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcG9pbnQ6IHNsaWdodGx5IGluIGZyb250IG9mIG1hcmsgdG93YXJkcyBiYWxsCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJjZXB0UG9zID0gbWFya1Bvcy5jbG9uZSgpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzIsIC0yLjUpOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCbGVuZCBiYXNlZCBvbiBCTCBzdGF0IChIaWdoIEJMID0gcHJpb3JpdGl6ZSBpbnRlcmNlcHRpb24gbGFuZSkKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoaW50ZXJjZXB0UG9zLCBsYW5lRmFjdG9yICogMC43KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gUHJlc3NpbmcgKElmIG1hcmsgaGFzIGJhbGwpCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIC8vIElmIGhpZ2ggQVQsIGdldCB2ZXJ5IGNsb3NlIHRvIGZvcmNlIGFjdGlvbgogICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAobWFya1BvcywgYWdncm9GYWN0b3IgKiAwLjYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBaT05FIERFRkVOU0UgLS0tCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGZvcm1hdGlvbiB0b3dhcmRzIGJhbGwgKENvbXByZXNzaW9uKQogICAgICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyB3aXRoIGhpZ2ggQkwgcmVhZCB0aGUgZ2FtZSBiZXR0ZXIgYW5kIHNoaWZ0IG1vcmUgZWZmZWN0aXZlbHkKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGlmdFdlaWdodCA9IDAuMiArIChsYW5lRmFjdG9yICogMC40KTsgLy8gMC4yIHRvIDAuNgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLngsIGJhbGxQb3MueCwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLnosIGJhbGxQb3Mueiwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb21tb24gY29uc3RyYWludHMKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICAvLyBPcHBvcnR1bmlzdGljIFRhY2tsZQogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLmhvbGRlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIFRhY2tsZSByYW5nZSBpbmNyZWFzZXMgd2l0aCBBVCAoQ29uZmlkZW5jZSkKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVJhbmdlID0gOC4wICsgKGFnZ3JvRmFjdG9yICogNS4wKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGFja2xlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdHRlbXB0VGFja2xlKGJhbGwuaG9sZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9pc1Bvc0luQ3JlYXNlKHBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbeyB4OiAwLCB6OiAtZ29hbERpc3QgfSwgeyB4OiAwLCB6OiBnb2FsRGlzdCB9XTsKICAgICAgICAgICAgZm9yIChsZXQgZyBvZiBnb2FscykgewogICAgICAgICAgICAgICAgY29uc3QgZHggPSBwb3MueCAtIGcueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gcG9zLnogLSBnLno7CiAgICAgICAgICAgICAgICBpZiAoZHgqZHggKyBkeipkeiA8IGNyZWFzZVJhZGl1cypjcmVhc2VSYWRpdXMpIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDQuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChtYXRlLm1lc2gucG9zaXRpb24pKSBjb250aW51ZTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IDA7CiAgICAgICAgICAgICAgICBjb25zdCBteURpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0VG9Hb2FsID0gTWF0aC5hYnMobWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG15RGlzdFRvR29hbCAtIG1hdGVEaXN0VG9Hb2FsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzY29yZSArPSBwcm9ncmVzcyAqIDEuNTsgCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIGNvbnN0IG9wZW5uZXNzID0gdGhpcy5fY2FsY3VsYXRlT3Blbm5lc3MobWF0ZSk7CiAgICAgICAgICAgICAgICBzY29yZSArPSBvcGVubmVzcyAqIDMuMDsKCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKICAgICAgICAgICAgICAgIHNjb3JlIC09IGRpc3QgKiAwLjU7CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZU9wZW5uZXNzKHBsYXllcikgewogICAgICAgICAgICBsZXQgbWluRGVmRGlzdCA9IDk5OTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRGVmRGlzdCkgbWluRGVmRGlzdCA9IGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKG1pbkRlZkRpc3QsIDguMCk7CiAgICAgICAgfQoKICAgICAgICBfaXNQYXRoQmxvY2tlZCh0YXJnZXRQb3MsIHN0YXJ0UG9zID0gbnVsbCkgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHN0YXJ0UG9zIHx8IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgX3NjYW5EaXIuc3ViVmVjdG9ycyhlbmQsIHN0YXJ0KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3Qgc2FmZXR5UmFkaXVzID0gMi41OyAKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnMob3BwLm1lc2gucG9zaXRpb24sIHN0YXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBfc2NhblRvT3BwLmRvdChfc2NhbkRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlcnBEaXN0U3EgPSBfc2NhblRvT3BwLmxlbmd0aFNxKCkgLSAocHJvamVjdGlvbiAqIHByb2plY3Rpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChwZXJwRGlzdFNxIDwgKHNhZmV0eVJhZGl1cyAqIHNhZmV0eVJhZGl1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9tb3ZlVG8odGFyZ2V0KSB7CiAgICAgICAgICAgIF9haVZlYy5zdWJWZWN0b3JzKHRhcmdldCwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgX2FpVmVjLnkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gX2FpVmVjLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDEuMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAoYmFsbC5pc0ludmlzaWJsZSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGxldCByYW5nZSA9IDIuMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2JyYXdsZXInIHx8IHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2VsaXRlX2RlZmVuc2UnKSB7CiAgICAgICAgICAgICAgICByYW5nZSArPSAxLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBpZiAoZGlzdCA+IHJhbmdlKSByZXR1cm47CgogICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnModGhpcy5tZXNoLnBvc2l0aW9uLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGhlYWRpbmdEb3QgPSBfdGVtcFZlYzEuZG90KF9zY2FuVG9PcHApOwogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSAxLjU7CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID0gKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgfHwgMCkgKyBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7dmFsfWAsIGJhbGwubWVzaC5wb3NpdGlvbiwgImJsb2NrIiwgYmFsbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChfdGVtcFZlYzIsIDAuNik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgYmFsbC5wb3dlclR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXJUeXBlID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQkwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVByZXNzdXJlT25QbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIGlmICghcGxheWVyIHx8ICFwbGF5ZXIubWVzaCkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHBsYXllci50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBsZXQgcHJlc3N1cmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDEwLjApIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSArPSAoMTAuMCAtIGRpc3QpIC8gMTAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJlc3N1cmU7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRUZWFtbWF0ZXModGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5oYXNCYWxsKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRhcmdldFBvcy5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zdWJWZWN0b3JzKHRhcmdldFBvcywgbWF0ZS5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgNS4wIC0gZGlzdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KfQoKX2F0dGVtcHRUYWNrbGUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBFTjogTXVzdCBoYXZlIGVub3VnaCB0byB0YWNrbGUgKENvc3QgaXMgOCkKICAgICAgICAgICAgLy8gV2UgYWRkIGEgc21hbGwgYnVmZmVyICg5KSB0byBiZSBzYWZlIGFuZCBhdm9pZCBlZGdlIGNhc2Ugc3BhbSB3aGVyZSB0aGV5IHRyeSBhbmQgZmFpbAogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCA5KSByZXR1cm47IAoKICAgICAgICAgICAgLy8gMS4gUHJlZGljdCBUYXJnZXQgUG9zaXRpb24gKExlYWQgdGhlIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgbGVhZFRpbWUgPSAwLjI7IAogICAgICAgICAgICBjb25zdCBwcmVkaWN0ZWRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBwcmVkaWN0ZWRQb3MuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgbGVhZFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBDYWxjdWxhdGUgVmVjdG9yIHRvIFByZWRpY3RlZCBTcG90CiAgICAgICAgICAgIGNvbnN0IHRvUHJlZCA9IHByZWRpY3RlZFBvcy5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdG9QcmVkLnkgPSAwOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9QcmVkLmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUmFuZ2UgQ2hlY2sKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHJhbmdlIHRvIDE1LjBtCiAgICAgICAgICAgIGlmIChkaXN0IDwgMTUuMCkgewogICAgICAgICAgICAgICAgdG9QcmVkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBBbmdsZSBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGZ3ZC5kb3QodG9QcmVkKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBhbmdsZTogQWxsb3cgdGFja2xpbmcgaWYgdGFyZ2V0IGlzIGdlbmVyYWxseSBpbiBmcm9udCAoPiAwLjIgZG90KQogICAgICAgICAgICAgICAgLy8gU2xpZ2h0bHkgc3RyaWN0ZXIgdGhhbiAwLjAgdG8gcHJldmVudCB3ZWlyZCBzaWRlLWx1bmdlcwogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIDUuIFJlYWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICAgICAgLy8gSW50ZWxsaWdlbnQ6IERvbid0IGp1c3Qgc3BhbS4gUHJvYmFiaWxpdGllcyBwZXIgZnJhbWUgKGFzc3VtaW5nIH42MGZwcykuCiAgICAgICAgICAgICAgICAgICAgLy8gRmFyICg4LTE1bSk6IH4xIGF0dGVtcHQgcGVyIDEuNXMgKDAuMDEpCiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvc2UgKDMtOG0pOiB+MSBhdHRlbXB0IHBlciAwLjVzICgwLjAzKQogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rICg8M20pOiBBZ2dyZXNzaXZlICgwLjE1KQogICAgICAgICAgICAgICAgICAgIGxldCBjaGFuY2UgPSAwLjAxOyAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDguMCkgY2hhbmNlID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAzLjApIGNoYW5jZSA9IDAuMTU7IAoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGNoYW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTTkFQIFRVUk46IEFJIGNoZWF0cyByb3RhdGlvbiB0byBmYWNlIHRhcmdldCBwZXJmZWN0bHkgYmVmb3JlIGx1bmdpbmcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBlbnN1cmVzIHRoZSB0YWNrbGUgdmVjdG9yIGlzIGFjY3VyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMih0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSB0YXJnZXRBbmdsZSAtIHRoaXMucm90YXRpb25PZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRhY2tsZSh0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","/AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgQUlQbGF5ZXIgZXh0ZW5kcyAod2luZG93LmZsdXguUGxheWVyIHx8IGNsYXNzIHt9KSB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBTdGF0ZSBNYWNoaW5lCi8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwp0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjE1OyAvLyBTbmFwcGllciBkZWNpc2lvbnMgKHdhcyAwLjI1KQoKICAgICAgICAgICAgLy8gU3R1Y2sgRGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFN0dWNrUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgPSAwOwogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDEuNTsgCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuMjsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSb2xlIENvbmZpZwogICAgICAgICAgICB0aGlzLmlzRm9yd2FyZCA9IFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKTsKICAgICAgICAgICAgdGhpcy5pc01pZGZpZWxkZXIgPSByb2xlID09PSAnTUYnOwogICAgICAgICAgICB0aGlzLmlzRGVmZW5kZXIgPSBbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSk7CgogICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICBjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICBjb25zdCBwaWNrID0gKGFycikgPT4gYXJyW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGFyci5sZW5ndGgpXTsKICAgICAgICAgICAgY29uc3QgY2hhbmNlID0gKHByb2IpID0+IE1hdGgucmFuZG9tKCkgPCBwcm9iOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMuc2hvb3QgPSBwaWNrKHNob290VGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjEpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCnVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc1ByYWN0aWNlID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IGdhbWUgJiYgZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzQWN0aXZlICYmICFpc1ByYWN0aWNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICBjb25zdCBpc1RlYW1BSUVuYWJsZWQgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uYWlFbmFibGVkIDogdHJ1ZTsKCiAgICAgICAgICAgIGlmIChpc0luY2FwYWNpdGF0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOyAvLyBSZXNldCBzdHVjayBpZiBzdHVubmVkCiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gU1RVQ0sgREVURUNUSU9OIC0tLQogICAgICAgICAgICAgICAgdGhpcy5zdHVja0NoZWNrVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHVja0NoZWNrVGltZXIgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrQ2hlY2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubGFzdFN0dWNrUG9zKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0cnlpbmcgdG8gbW92ZSAoaW5wdXQgYWN0aXZlKSBidXQgbW92ZWQgdmVyeSBsaXR0bGUKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDAuNSAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHVja1RpbWVyICs9IDAuNTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWNrVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RTdHVja1Bvcy5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc3R1Y2tUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCl9ldmFsdWF0ZVN0YXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwoKICAgICAgICAgICAgLy8gMS4gUG9zc2Vzc2lvbgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVW5zdHVjayBQcmlvcml0eQogICAgICAgICAgICBpZiAodGhpcy5zdHVja1RpbWVyID4gMi4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnVU5TVFVDSyc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBDb250ZXh0CiAgICAgICAgICAgIGNvbnN0IG15UG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IG15UG9zLmRpc3RhbmNlVG9TcXVhcmVkKGJhbGxQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ291bnQgdGVhbW1hdGVzIGNsb3NlciB0byBiYWxsIChBbnRpLVN3YXJtKQogICAgICAgICAgICBsZXQgY2xvc2VyQ291bnQgPSAwOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcyB8fCAhcC5tZXNoIHx8IHAucm9sZSA9PT0gJ0dMJyB8fCBwLnN0YXR1cy5uYXAgPiAwIHx8IHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZChiYWxsUG9zKSA8IG15RGlzdFNxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlckNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhbUlDbG9zZXN0ID0gKGNsb3NlckNvdW50ID09PSAwKTsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbS5zaWRlOyAvLyAxIChEZWZlbmRzICtaKSwgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIC8vIHJlbGF0aXZlWiA+IDAgaXMgZGVmZW5zaXZlIGhhbGYsIHJlbGF0aXZlWiA8IDAgaXMgYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVaID0gYmFsbFBvcy56ICogc2lkZTsgCgogICAgICAgICAgICAvLyA0LiBSb2xlLUJhc2VkIExvZ2ljCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3Bwb25lbnQgaGFzIGJhbGwgLSBEZWZlbnNlIFBoYXNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaWN0IFN3YXJtIENvbnRyb2w6IE1heCAyIHBsYXllcnMgY2hhc2luZy9wcmVzc2luZwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYXNlTGltaXQgPSAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbkNoYXNlID0gKGNsb3NlckNvdW50IDwgY2hhc2VMaW1pdCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXJzOiBDb25zZXJ2YXRpdmUuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGFzZSBvbmx5IGlmIGJhbGwgaXMgaW4gZGVmZW5zaXZlIHRlcnJpdG9yeSAoPiAtMTApIE9SIGlmIEkgYW0gdGhlIGFic29sdXRlIGNsb3Nlc3QuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaG9sZCBmb3JtYXRpb24vbWFyay4KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5EZWZlbnNpdmVab25lID0gKHJlbGF0aXZlWiA+IC0xMCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChpbkRlZmVuc2l2ZVpvbmUgfHwgYW1JQ2xvc2VzdCkgJiYgY2FuQ2hhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yd2FyZHM6IFByZXNzIGhpZ2guCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoYXNlIGlmIGJhbGwgaXMgaW4gYXR0YWNraW5nIHRlcnJpdG9yeSAoPCAxNSkuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGdvZXMgZGVlcCBpbnRvIG91ciBkZWZlbnNlIChyZWxhdGl2ZVogPiAxNSksIHN0b3AgY2hhc2luZyBhbmQgc3RheSBoaWdoL21hcmsuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluUHJlc3Npbmdab25lID0gKHJlbGF0aXZlWiA8IDE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpblByZXNzaW5nWm9uZSAmJiBjYW5DaGFzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOyAvLyBXaWxsIHJldHVybiB0byBob21lIHBvcy9tYXJrCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogVGhlIEVuZ2luZS4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuIGNoYXNlIGFueXdoZXJlIGlmIHdpdGhpbiBsaW1pdC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbkNoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGlzIEZyZWUgKExvb3NlIEJhbGwpCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eTogQ2xvc2VzdCAyIHBsYXllcnMgZ28gZm9yIGl0IHJlZ2FyZGxlc3Mgb2Ygcm9sZSAoc2NyYW1ibGUpCiAgICAgICAgICAgICAgICBpZiAoY2xvc2VyQ291bnQgPCAyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewpjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdVTlNUVUNLJzogdGhpcy5fc3RhdGVVbnN0dWNrKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVVuc3R1Y2soZHQpIHsKICAgICAgICAgICAgIC8vIE1vdmUgaW4gYSByYW5kb20gZGlyZWN0aW9uIHRvIGJyZWFrIGZyZWUKICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4xKSB7IAogICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIC8vIFRyeSB0byBkYXNoIGlmIHN0dWNrCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOID4gMTAgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2goTWF0aC5jb3MoYW5nbGUpLCBNYXRoLnNpbihhbmdsZSkpOwogICAgICAgICAgICAgICAgIH0KfQogICAgICAgIH0KCl9zdGF0ZUF0dGFja0NhcnJ5KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNUQVQgQkFTRUQgREVDSVNJT04gTUFLSU5HIC0tLQogICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgY29uc3QgZW4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgIGNvbnN0IHNoID0gdGhpcy5nZXRTdGF0KCdTSCcpOwogICAgICAgICAgICBjb25zdCBjdXJyZW50RU4gPSB0aGlzLmN1cnJlbnRFTjsKCiAgICAgICAgICAgIC8vIDEuIE1vdmVtZW50CiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBTaG9vdGluZyBEZWNpc2lvbgogICAgICAgICAgICAvLyBCYXNlIHJhbmdlIDIwbS4gSGlnaCBTSCBleHRlbmRzIGVmZmVjdGl2ZSByYW5nZSB1cCB0byB+NDBtLgogICAgICAgICAgICBjb25zdCBzaG9vdFJhbmdlID0gMjAuMCArIChzaCAqIDAuMik7IAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCBzaG9vdFJhbmdlICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIC8vIElmIHZlcnkgY2xvc2UsIGFsd2F5cyBzaG9vdAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0dvYWwgPCAxNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIGZ1cnRoZXIgb3V0LCBjaGVjayBpZiB3ZSBwcmVmZXIgc2hvb3Rpbmcgb3ZlciBkcmliYmxpbmcKICAgICAgICAgICAgICAgIC8vIEhpZ2ggU0ggbWFrZXMgdXMgc2hvb3QgZWFybGllcgogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoc2ggLyAxNTAuMCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBQYXNzaW5nIC8gRHJpYmJsaW5nIERlY2lzaW9uCiAgICAgICAgICAgIGNvbnN0IGlzU3Vycm91bmRlZCA9IHRoaXMuX2lzU3Vycm91bmRlZCgpOwogICAgICAgICAgICBjb25zdCBsb3dFTiA9IGN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVuZGVuY3kgdG8gUGFzcyB2cyBIb2xkCiAgICAgICAgICAgIC8vIEhpZ2ggUEEgcmVsYXRpdmUgdG8gRU4gLT4gUGFzcwogICAgICAgICAgICAvLyBIaWdoIEVOIC0+IEhvbGQKICAgICAgICAgICAgY29uc3QgcGFzc1RlbmRlbmN5ID0gKHBhIC8gKGVuICsgMSkpICogMS41OyAvLyA+IDEuMCBtZWFucyBwcmVmZXJzIHBhc3NpbmcKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBzaG91bGRMb29rRm9yUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCkgewogICAgICAgICAgICAgICAgLy8gVW5kZXIgcHJlc3N1cmUKICAgICAgICAgICAgICAgIC8vIElmIGN1cnJlbnQgRU4gaXMgbG93LCB3ZSBtdXN0IHBhc3MKICAgICAgICAgICAgICAgIGlmIChsb3dFTikgewogICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgRU4gaXMgaGlnaCBlbm91Z2ggdG8gdGFuayBhIHRhY2tsZSAoZS5nLiA+IDMwKSwgYW5kIHdlIGhhdmUgbG93IFBhc3MgdGVuZGVuY3ksIGhvbGQuCiAgICAgICAgICAgICAgICAgICAgLy8gIkhlcm8gQmFsbCIgY2hlY2sKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVOID4gMzAgJiYgcGFzc1RlbmRlbmN5IDwgMC44KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gZmFsc2U7IC8vIERyaWJibGUgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZExvb2tGb3JQYXNzID0gdHJ1ZTsgLy8gUGFuaWMgcGFzcwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE9wZW4gcGxheQogICAgICAgICAgICAgICAgLy8gSWYgUGxheW1ha2VyIChIaWdoIFBBKSwgbG9vayBmb3IgcGFzc2VzIGNvbnN0YW50bHkKICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBzaG91bGRMb29rRm9yUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzaG91bGRMb29rRm9yUGFzcyAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyZXNob2xkIHRvIHBhc3M6CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSSdtIGEgc2hvb3RlciAobG93IHBhc3NUZW5kZW5jeSksIG1hdGUgbXVzdCBiZSBzaWduaWZpY2FudGx5IGNsb3NlcgogICAgICAgICAgICAgICAgICAgIC8vIElmIEknbSBhIHBhc3NlciwgbWF0ZSBqdXN0IG5lZWRzIHRvIGJlIHNvbWV3aGF0IGJldHRlciBvciBvcGVuCiAgICAgICAgICAgICAgICAgICAgbGV0IGltcHJvdmVtZW50TmVlZGVkID0gNS4wOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPiAxLjUpIGltcHJvdmVtZW50TmVlZGVkID0gLTUuMDsgLy8gV2lsbCBwYXNzIGJhY2t3YXJkcyB0byByZXNldAogICAgICAgICAgICAgICAgICAgIGlmIChwYXNzVGVuZGVuY3kgPCAwLjUpIGltcHJvdmVtZW50TmVlZGVkID0gMTUuMDsgLy8gQmFsbCBob2cKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSBpbXByb3ZlbWVudE5lZWRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWxzYWZlOiBJZiBzdXJyb3VuZGVkIGFuZCBkaWRuJ3QgcGFzcyAob3IgY291bGRuJ3QpLCB0cnkgdG8gc2hvb3QgaWYgY2xvc2UgZW5vdWdoCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZyAmJiBkaXN0VG9Hb2FsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zdGF0ZUNoYXNlKGR0KSB7CiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZJWDogQWxsb3cgZW50ZXJpbmcgZ29hbCBjcmVhc2UgaWYgYmFsbCBpcyBpbnNpZGUgaXQgKHByZXZlbnQgc3R1Y2sgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbEluQ3JlYXNlID0gdGhpcy5faXNQb3NJbkNyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgaWYgKCFiYWxsSW5DcmVhc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gQUkgVEFDS0xFIExPR0lDCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0ZW1wdFRhY2tsZShiYWxsLmhvbGRlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlU3VwcG9ydChkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBjb25zdCBjYXJyaWVyID0gYmFsbC5ob2xkZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNhcnJpZXIgfHwgIWNhcnJpZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IGNhcnJpZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRk9SV0FSRFM6IFNlZWsgU2NvcmluZyBQb3NpdGlvbnMgJiBPcGVuIFNwYWNlCiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxOwogICAgICAgICAgICAgICAgLy8gV2VhdmUgdG8gc2hha2UgbWFya2VycwogICAgICAgICAgICAgICAgY29uc3Qgd2VhdmUgPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWRlYWwgcG9zaXRpb246IERlZXAgaW4gYXR0YWNraW5nIGhhbGYKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gKGJhbGxQb3MueiArIHRhcmdldEdvYWxaKSAqIDAuNTU7IC8vIEJpYXNlZCB0b3dhcmRzIGdvYWwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRG9uJ3QgcnVuIHRvbyBmYXIgYWhlYWQgb2YgdGhlIGJhbGwgKHN0YXkgY29ubmVjdGVkKQogICAgICAgICAgICAgICAgY29uc3QgbWF4TGVhZCA9IDI1LjA7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModGFyZ2V0WiAtIGJhbGxQb3MueikgPiBtYXhMZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiBtYXhMZWFkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCh0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmUgKiAwLjMsIDAsIHRhcmdldFopOwoKICAgICAgICAgICAgICAgIC8vIFJheWNhc3QgQ2hlY2s6IElzIHBhc3MgYmxvY2tlZD8KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3RyYXRlZ3kgMTogR28gV2lkZQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwKSA/IDIwIDogLTIwOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTdHJhdGVneSAyOiBDaGVjayBUbyBCYWxsIChDb21lIFNob3J0KQogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDguMCk7IAogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzIsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1JREZJRUxERVJTOiBMaW5rIFBsYXkKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuNikgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgaW4gdHJvdWJsZTogQ29tZSBjbG9zZSB0byBvZmZlciBhbiBvdXRsZXQKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWRlID0gKHRoaXMubWVzaC5wb3NpdGlvbi54ID4gYmFsbFBvcy54KSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKyAoc2lkZSAqIDguMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7IC8vIFNxdWFyZSBvciBzbGlnaHRseSBiYWNrCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhcnJpZXIgc2FmZTogUHVzaCBmb3J3YXJkIGludG8gcG9ja2V0CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTIuMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXZvaWQgY3Jvd2RpbmcgdGhlIGNhcnJpZXIgdG9vIG11Y2gKICAgICAgICAgICAgICAgIGlmIChfdGFyZ2V0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcykgPCA2LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyhfdGFyZ2V0UG9zLCBiYWxsUG9zKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcig2LjApOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShiYWxsUG9zKS5hZGQoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZFTkRFUlM6IFNhZmV0eSBCdWZmZXIgKFByZXZlbnQgQ291bnRlcnMpCiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlCdWZmZXIgPSAxOC4wOwogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5QnVmZmVyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gT3duIGdvYWwgWgogICAgICAgICAgICAgICAgY29uc3Qgb3duR29hbFogPSAtdGFyZ2V0R29hbFo7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsYW1wIHNvIHRoZXkgZG9uJ3Qgc2l0IG9uIHRoZWlyIG93biBnb2FsaWUgaWYgdGhlIGJhbGwgaXMgaGlnaCB1cAogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7IC8vIEF0dGFja2luZyAtWiAoSG9tZSksIE93biBHb2FsICtaCiAgICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBNYXRoLm1pbihvd25Hb2FsWiAtIDE1LCB0YXJnZXRaKTsgCiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBBdHRhY2tpbmcgK1ogKEF3YXkpLCBPd24gR29hbCAtWgogICAgICAgICAgICAgICAgICAgICB0YXJnZXRaID0gTWF0aC5tYXgob3duR29hbFogKyAxNSwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQodGhpcy5ob21lUG9zaXRpb24ueCwgMCwgdGFyZ2V0Wik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IHNsaWdodGx5IHRvd2FyZHMgYmFsbCBYIHRvIGNvdmVyIGNlbnRlcgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoX3RhcmdldFBvcy54LCBiYWxsUG9zLngsIDAuMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIC8vIFNpZGUgMSBkZWZlbmRzICtaLCBTaWRlIC0xIGRlZmVuZHMgLVoKICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyBnb2FsRGlzdCA6IC1nb2FsRGlzdDsKCiAgICAgICAgICAgIC8vIFN0YXRzCiAgICAgICAgICAgIGNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZWQgZmFjdG9ycyAoMC4wIHRvIDEuMCwgYXNzdW1pbmcgbWF4IH45OSkKICAgICAgICAgICAgY29uc3QgYWdncm9GYWN0b3IgPSBNYXRoLm1pbigxLjAsIGF0IC8gODAuMCk7IC8vIEhpZ2ggQVQgPSBBZ2dyZXNzaXZlCiAgICAgICAgICAgIGNvbnN0IGxhbmVGYWN0b3IgPSBNYXRoLm1pbigxLjAsIGJsIC8gODAuMCk7ICAvLyBIaWdoIEJMID0gU21hcnQgUG9zaXRpb25pbmcKCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBNQU4gTUFSS0lORyAtLS0KICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBHb2FsLVNpZGUgUG9zaXRpb24KICAgICAgICAgICAgICAgIC8vIFZlY3RvciBmcm9tIG1hcmsgdG8gbXkgZ29hbAogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCBteUdvYWxaIC0gbWFya1Bvcy56KTsgCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGRpcmVjdGlvbiBvbmx5IG9uIFogZm9yIHN0YWJpbGl0eT8gTm8sIGZ1bGwgM0QgZGlyZWN0aW9uIHRvIGJsb2NrIHNob3QuCiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgc3RheWluZyAiZ29hbCBzaWRlIiB1c3VhbGx5IG1lYW5zIHN0YXlpbmcgb24gdGhlIGxpbmUgYmV0d2VlbiBwbGF5ZXIgYW5kIGdvYWwgY2VudGVyLgogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnggPSAwIC0gbWFya1Bvcy54OyAvLyBHb2FsIGNlbnRlciBYIGlzIDAKICAgICAgICAgICAgICAgIC8vIF90ZW1wVmVjMS56IGlzIGFscmVhZHkgc2V0CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEueSA9IDA7IC8vIFN0YXkgb24gZ3JvdW5kIHBsYW5lIGZvciBwb3NpdGlvbmluZyBsb2dpYwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0YW5jZSB0byBrZWVwIGZyb20gbWFyawogICAgICAgICAgICAgICAgLy8gSGlnaCBBVCA9IFRpZ2h0ZXIgKDEuNW0pLCBMb3cgQVQgPSBMb29zZXIgKDUuMG0pCiAgICAgICAgICAgICAgICBjb25zdCBtYXJrRGlzdCA9IDUuMCAtIChhZ2dyb0ZhY3RvciAqIDMuNSk7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgbWFya0Rpc3QpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBMYW5lIEN1dHRpbmcgKEJMIFN0YXQpCiAgICAgICAgICAgICAgICAvLyBJZiBtYXJrIGRvZXNuJ3QgaGF2ZSBiYWxsLCB0cnkgdG8gaW50ZXJjZXB0IHBhc3MgZnJvbSBiYWxsIGhvbGRlcgogICAgICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuaG9sZGVyICE9PSB0aGlzLm1hcmtpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBiYWxsIHRvIG1hcmsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzIuc3ViVmVjdG9ycyhtYXJrUG9zLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcG9pbnQ6IHNsaWdodGx5IGluIGZyb250IG9mIG1hcmsgdG93YXJkcyBiYWxsCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJjZXB0UG9zID0gbWFya1Bvcy5jbG9uZSgpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzIsIC0yLjUpOyAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCbGVuZCBiYXNlZCBvbiBCTCBzdGF0IChIaWdoIEJMID0gcHJpb3JpdGl6ZSBpbnRlcmNlcHRpb24gbGFuZSkKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoaW50ZXJjZXB0UG9zLCBsYW5lRmFjdG9yICogMC43KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMy4gUHJlc3NpbmcgKElmIG1hcmsgaGFzIGJhbGwpCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcy5tYXJraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgIC8vIElmIGhpZ2ggQVQsIGdldCB2ZXJ5IGNsb3NlIHRvIGZvcmNlIGFjdGlvbgogICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAobWFya1BvcywgYWdncm9GYWN0b3IgKiAwLjYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBaT05FIERFRkVOU0UgLS0tCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGZvcm1hdGlvbiB0b3dhcmRzIGJhbGwgKENvbXByZXNzaW9uKQogICAgICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyB3aXRoIGhpZ2ggQkwgcmVhZCB0aGUgZ2FtZSBiZXR0ZXIgYW5kIHNoaWZ0IG1vcmUgZWZmZWN0aXZlbHkKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGlmdFdlaWdodCA9IDAuMiArIChsYW5lRmFjdG9yICogMC40KTsgLy8gMC4yIHRvIDAuNgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLngsIGJhbGxQb3MueCwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHRoaXMuaG9tZVBvc2l0aW9uLnosIGJhbGxQb3Mueiwgc2hpZnRXZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb21tb24gY29uc3RyYWludHMKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICAvLyBPcHBvcnR1bmlzdGljIFRhY2tsZQogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLmhvbGRlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIFRhY2tsZSByYW5nZSBpbmNyZWFzZXMgd2l0aCBBVCAoQ29uZmlkZW5jZSkKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVJhbmdlID0gOC4wICsgKGFnZ3JvRmFjdG9yICogNS4wKTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGFja2xlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdHRlbXB0VGFja2xlKGJhbGwuaG9sZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9pc1Bvc0luQ3JlYXNlKHBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbeyB4OiAwLCB6OiAtZ29hbERpc3QgfSwgeyB4OiAwLCB6OiBnb2FsRGlzdCB9XTsKICAgICAgICAgICAgZm9yIChsZXQgZyBvZiBnb2FscykgewogICAgICAgICAgICAgICAgY29uc3QgZHggPSBwb3MueCAtIGcueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gcG9zLnogLSBnLno7CiAgICAgICAgICAgICAgICBpZiAoZHgqZHggKyBkeipkeiA8IGNyZWFzZVJhZGl1cypjcmVhc2VSYWRpdXMpIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDQuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChtYXRlLm1lc2gucG9zaXRpb24pKSBjb250aW51ZTsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IDA7CiAgICAgICAgICAgICAgICBjb25zdCBteURpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0VG9Hb2FsID0gTWF0aC5hYnMobWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG15RGlzdFRvR29hbCAtIG1hdGVEaXN0VG9Hb2FsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzY29yZSArPSBwcm9ncmVzcyAqIDEuNTsgCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIGNvbnN0IG9wZW5uZXNzID0gdGhpcy5fY2FsY3VsYXRlT3Blbm5lc3MobWF0ZSk7CiAgICAgICAgICAgICAgICBzY29yZSArPSBvcGVubmVzcyAqIDMuMDsKCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKICAgICAgICAgICAgICAgIHNjb3JlIC09IGRpc3QgKiAwLjU7CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlID4gbWF4U2NvcmUpIHsKICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiZXN0VGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZU9wZW5uZXNzKHBsYXllcikgewogICAgICAgICAgICBsZXQgbWluRGVmRGlzdCA9IDk5OTsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRGVmRGlzdCkgbWluRGVmRGlzdCA9IGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKG1pbkRlZkRpc3QsIDguMCk7CiAgICAgICAgfQoKICAgICAgICBfaXNQYXRoQmxvY2tlZCh0YXJnZXRQb3MsIHN0YXJ0UG9zID0gbnVsbCkgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHN0YXJ0UG9zIHx8IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgX3NjYW5EaXIuc3ViVmVjdG9ycyhlbmQsIHN0YXJ0KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3Qgc2FmZXR5UmFkaXVzID0gMi41OyAKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnMob3BwLm1lc2gucG9zaXRpb24sIHN0YXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSBfc2NhblRvT3BwLmRvdChfc2NhbkRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlcnBEaXN0U3EgPSBfc2NhblRvT3BwLmxlbmd0aFNxKCkgLSAocHJvamVjdGlvbiAqIHByb2plY3Rpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChwZXJwRGlzdFNxIDwgKHNhZmV0eVJhZGl1cyAqIHNhZmV0eVJhZGl1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIF9tb3ZlVG8odGFyZ2V0KSB7CiAgICAgICAgICAgIF9haVZlYy5zdWJWZWN0b3JzKHRhcmdldCwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgX2FpVmVjLnkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gX2FpVmVjLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDEuMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAoYmFsbC5pc0ludmlzaWJsZSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHJldHVybjsKCiAgICAgICAgICAgIGxldCByYW5nZSA9IDIuMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2JyYXdsZXInIHx8IHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2VsaXRlX2RlZmVuc2UnKSB7CiAgICAgICAgICAgICAgICByYW5nZSArPSAxLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBpZiAoZGlzdCA+IHJhbmdlKSByZXR1cm47CgogICAgICAgICAgICBfc2NhblRvT3BwLnN1YlZlY3RvcnModGhpcy5tZXNoLnBvc2l0aW9uLCBiYWxsLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGhlYWRpbmdEb3QgPSBfdGVtcFZlYzEuZG90KF9zY2FuVG9PcHApOwogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSAxLjU7CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID0gKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgfHwgMCkgKyBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7dmFsfWAsIGJhbGwubWVzaC5wb3NpdGlvbiwgImJsb2NrIiwgYmFsbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChfdGVtcFZlYzIsIDAuNik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgYmFsbC5wb3dlclR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXJUeXBlID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQkwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVByZXNzdXJlT25QbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIGlmICghcGxheWVyIHx8ICFwbGF5ZXIubWVzaCkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHBsYXllci50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBsZXQgcHJlc3N1cmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDEwLjApIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSArPSAoMTAuMCAtIGRpc3QpIC8gMTAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJlc3N1cmU7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRUZWFtbWF0ZXModGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5oYXNCYWxsKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRhcmdldFBvcy5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDUuMCkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zdWJWZWN0b3JzKHRhcmdldFBvcywgbWF0ZS5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgNS4wIC0gZGlzdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KfQoKX2F0dGVtcHRUYWNrbGUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVGFja2xpbmcgfHwgdGhpcy5pc1JlY292ZXJpbmcgfHwgdGhpcy5pc0Rhc2hpbmcgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBFTjogTXVzdCBoYXZlIGVub3VnaCB0byB0YWNrbGUgKENvc3QgaXMgOCkKICAgICAgICAgICAgLy8gV2UgYWRkIGEgc21hbGwgYnVmZmVyICg5KSB0byBiZSBzYWZlIGFuZCBhdm9pZCBlZGdlIGNhc2Ugc3BhbSB3aGVyZSB0aGV5IHRyeSBhbmQgZmFpbAogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCA5KSByZXR1cm47IAoKICAgICAgICAgICAgLy8gMS4gUHJlZGljdCBUYXJnZXQgUG9zaXRpb24gKExlYWQgdGhlIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgbGVhZFRpbWUgPSAwLjI7IAogICAgICAgICAgICBjb25zdCBwcmVkaWN0ZWRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBwcmVkaWN0ZWRQb3MuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgbGVhZFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBDYWxjdWxhdGUgVmVjdG9yIHRvIFByZWRpY3RlZCBTcG90CiAgICAgICAgICAgIGNvbnN0IHRvUHJlZCA9IHByZWRpY3RlZFBvcy5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdG9QcmVkLnkgPSAwOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gdG9QcmVkLmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUmFuZ2UgQ2hlY2sKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHJhbmdlIHRvIDE1LjBtCiAgICAgICAgICAgIGlmIChkaXN0IDwgMTUuMCkgewogICAgICAgICAgICAgICAgdG9QcmVkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBBbmdsZSBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGZ3ZC5kb3QodG9QcmVkKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBhbmdsZTogQWxsb3cgdGFja2xpbmcgaWYgdGFyZ2V0IGlzIGdlbmVyYWxseSBpbiBmcm9udCAoPiAwLjIgZG90KQogICAgICAgICAgICAgICAgLy8gU2xpZ2h0bHkgc3RyaWN0ZXIgdGhhbiAwLjAgdG8gcHJldmVudCB3ZWlyZCBzaWRlLWx1bmdlcwogICAgICAgICAgICAgICAgaWYgKGRvdCA+IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIDUuIFJlYWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICAgICAgLy8gSW50ZWxsaWdlbnQ6IERvbid0IGp1c3Qgc3BhbS4gUHJvYmFiaWxpdGllcyBwZXIgZnJhbWUgKGFzc3VtaW5nIH42MGZwcykuCiAgICAgICAgICAgICAgICAgICAgLy8gRmFyICg4LTE1bSk6IH4xIGF0dGVtcHQgcGVyIDEuNXMgKDAuMDEpCiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvc2UgKDMtOG0pOiB+MSBhdHRlbXB0IHBlciAwLjVzICgwLjAzKQogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rICg8M20pOiBBZ2dyZXNzaXZlICgwLjE1KQogICAgICAgICAgICAgICAgICAgIGxldCBjaGFuY2UgPSAwLjAxOyAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDguMCkgY2hhbmNlID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAzLjApIGNoYW5jZSA9IDAuMTU7IAoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGNoYW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTTkFQIFRVUk46IEFJIGNoZWF0cyByb3RhdGlvbiB0byBmYWNlIHRhcmdldCBwZXJmZWN0bHkgYmVmb3JlIGx1bmdpbmcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBlbnN1cmVzIHRoZSB0YWNrbGUgdmVjdG9yIGlzIGFjY3VyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMih0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSB0YXJnZXRBbmdsZSAtIHRoaXMucm90YXRpb25PZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRhY2tsZSh0b1ByZWQueCwgdG9QcmVkLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwpjYXNlICdMRCc6IGNhc2UgJ1JEJzogLy8gRGVmZW5kZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5BVCArPSAxMjsgYmFzZS5CTCArPSAxMDsgYmFzZS5QQSArPSA1OyBiYXNlLkVOICs9IDE1OyAvLyBCb29zdCBFTiBmb3IgdGFja2xpbmcKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","./Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwpjYXNlICdMRCc6IGNhc2UgJ1JEJzogLy8gRGVmZW5kZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5BVCArPSAxMjsgYmFzZS5CTCArPSAxMDsgYmFzZS5QQSArPSA1OyBiYXNlLkVOICs9IDE1OyAvLyBCb29zdCBFTiBmb3IgdGFja2xpbmcKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","/Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwpjYXNlICdMRCc6IGNhc2UgJ1JEJzogLy8gRGVmZW5kZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5BVCArPSAxMjsgYmFzZS5CTCArPSAxMDsgYmFzZS5QQSArPSA1OyBiYXNlLkVOICs9IDE1OyAvLyBCb29zdCBFTiBmb3IgdGFja2xpbmcKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQovLyAzLiBIdW1hbiBQbGF5ZXIgQm9udXMgKFRoZSAiSGVybyIgRmVlbCkKICAgICAgICAgICAgaWYgKGlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCArPSAzMDA7IC8vIFRhbmtpZXIgKHdhcyAxNTApCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gODsgICAvLyBGYXN0ZXIgKHdhcyA1KQogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOICs9IDEwOyAgIC8vIEhhcmRlciB0byB0YWNrbGUgKHdhcyA1KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBLZXkgU3RhdCBCb29zdAogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRicgfHwgcm9sZSA9PT0gJ1JGJykgcGxheWVyLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ01GJykgcGxheWVyLnN0YXRzLlBBICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xEJyB8fCByb2xlID09PSAnUkQnKSBwbGF5ZXIuc3RhdHMuQVQgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnR0wnKSBwbGF5ZXIuc3RhdHMuQ0EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gRmluYWxpemUKICAgICAgICAgICAgcGxheWVyLnN0YXRzLm1heEhQID0gcGxheWVyLnN0YXRzLkhQOwogICAgICAgICAgICBwbGF5ZXIubGV2ZWwgPSBsZXZlbDsKICAgICAgICAgICAgcGxheWVyLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKICAgICAgICB9Cgpjb25zdHJ1Y3RvcihzY2VuZSwgaWQsIHNpZGUsIGNvbG9yLCBpc0h1bWFuKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOyAvLyAnaG9tZScgb3IgJ2F3YXknCiAgICAgICAgICAgIHRoaXMuc2lkZSA9IHNpZGU7IC8vIDEgKERlZmVuZHMgK1opIG9yIC0xIChEZWZlbmRzIC1aKQogICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuaXNIdW1hbiA9IGlzSHVtYW47CiAgICAgICAgICAgIHRoaXMuYWlFbmFibGVkID0gdHJ1ZTsgLy8gTWFzdGVyIHN3aXRjaCBmb3IgQUkgbG9naWMKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycyA9IFtdOwogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IG51bGw7IC8vIFRoZSBwbGF5ZXIgY3VycmVudGx5IGNvbnRyb2xsZWQvZm9jdXNlZAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9ybWF0aW9uIEFuY2hvcnMKdGhpcy5jdXJyZW50Rm9ybWF0aW9uID0gJ05vcm1hbCc7CgogICAgICAgICAgICAvLyBBdXRvLVN3aXRjaCBTbW9vdGhpbmcKICAgICAgICAgICAgdGhpcy5sYXN0U3dpdGNoVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc3dpdGNoQ29vbGRvd24gPSAwLjU7IC8vIFNlY29uZHMgYmVmb3JlIGF1dG8tc3dpdGNoIGNhbiBoYXBwZW4gYWdhaW4KICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKLy8gWCBQb3NpdGlvbjoKICAgICAgICAgICAgICAgIC8vIEZvcm1hdGlvbnM6IC1YIGlzIExlZnQsICtYIGlzIFJpZ2h0LgogICAgICAgICAgICAgICAgLy8gSG9tZSBUZWFtIChTaWRlIDEpIGZhY2VzIC1aLiBMZWZ0IGlzIC1YLiBVc2Ugb2Zmc2V0LnggYXMgaXMuCiAgICAgICAgICAgICAgICBsZXQgeFBvcyA9IG9mZnNldC54OwogICAgICAgICAgICAgICAgbGV0IHpQb3MgPSBvZmZzZXQueiAqIHRoaXMuc2lkZTsKCiAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnNldCh4UG9zLCAwLCB6UG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXdheSBUZWFtIChTaWRlIC0xKSBmYWNlcyArWi4gTGVmdCBpcyArWC4gRmxpcCBYLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2lkZSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaG9tZVBvc2l0aW9uLnggKj0gLTE7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBwb3NpdGlvbgogICAgICAgICAgICBpZiAocGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLnBvc2l0aW9uLmNvcHkocGxheWVyLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciAoMCwwLDApCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlUGh5c2ljcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgaWYgbm90IHNwbGl0IHlldAogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllcnNbaV0udXBkYXRlVmlzdWFscykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBNVVNUIGJlIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNtYXJ0IFN3aXRjaGluZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29vbGRvd24gY2hlY2sgKFRpbWUgaW4gc2Vjb25kcykKICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKSAvIDEwMDA7CiAgICAgICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RTd2l0Y2hUaW1lIDwgdGhpcy5zd2l0Y2hDb29sZG93bikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQWN0aW9uIExvY2tpbmc6IERvbid0IHN3aXRjaCBpZiBjdXJyZW50IHBsYXllciBpcyBjb21taXR0aW5nIHRvIGFuIGFjdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIC8vIElmIGRhc2hpbmcsIGNoYXJnaW5nIGEgdGFja2xlLCBldmFkaW5nLCBvciBpbiB0aGUgbWlkZGxlIG9mIGEgdGFja2xlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgaWYgKHAuaXNEYXNoaW5nIHx8IHAuaXNUYWNrbGVDaGFyZ2luZyB8fCBwLmlzRXZhZGluZyB8fCBwLmlzVGFja2xpbmcgfHwgcC5pc1JlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiZXN0Q2FuZGlkYXRlID0gdGhpcy5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEh5c3RlcmVzaXM6IFRoZSBjdXJyZW50IHBsYXllciBnZXRzIGEgInZpcnR1YWwgZGlzdGFuY2UgcmVkdWN0aW9uIgogICAgICAgICAgICAvLyBUaGlzIG1lYW5zIGEgbmV3IGNhbmRpZGF0ZSBtdXN0IGJlIHNpZ25pZmljYW50bHkgY2xvc2VyIHRvIG92ZXJyaWRlIHRoZSBjdXJyZW50IG9uZS4KICAgICAgICAgICAgY29uc3QgaHlzdGVyZXNpcyA9IDUuMDsgLy8gNSBtZXRlcnMgc3RpY2tpbmVzcwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZQogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEb24ndCBzd2l0Y2ggdG8gaW5jYXBhY2l0YXRlZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMubmFwID4gMCB8fCBwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSBkaXN0OwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGJpYXMgdG8gY3VycmVudCBwbGF5ZXIKICAgICAgICAgICAgICAgIGlmIChwID09PSB0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIHNjb3JlIC09IGh5c3RlcmVzaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdENhbmRpZGF0ZSA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiZXN0Q2FuZGlkYXRlICYmIGJlc3RDYW5kaWRhdGUgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiZXN0Q2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFN3aXRjaFRpbWUgPSBub3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRBY3RpdmVQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIC8vIFJlc2V0IGlucHV0IG9uIHByZXZpb3VzCiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBwbGF5ZXI7CgogICAgICAgICAgICAvLyBWaXN1YWwgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICAvLyAxLiBHcmVlbiBBcnJvdyBmb3IgQWN0aXZlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJBcnJvdyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZCh0aGlzLnBsYXllckFycm93KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnBvc2l0aW9uLnNldCgwLCAzLjUsIDApOyAvLyBGbG9hdCBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gV2hpdGUgQXJyb3dzIGZvciBPdGhlcnMKICAgICAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChwLnRlYW1tYXRlQXJyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC50ZWFtbWF0ZUFycm93LnZpc2libGUgPSAocCAhPT0gcGxheWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0UG9zaXRpb25zKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmNvcHkocC5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBoeXNpY3MKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBwLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwpwLmxvc2VCYWxsKCk7IC8vIERyb3AgYmFsbCBpZiBob2xkaW5nCiAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIEZvcmNlIHJlc2V0IGNhcGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBTdGF0cwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICAKLy8gT3JpZW50YXRpb246IEZhY2UgQ2VudGVyCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC4xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZXNldCBhY3RpdmUgcGxheWVyIHRvIE1GCiAgICAgICAgICAgIGNvbnN0IG1mID0gdGhpcy5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICBpZiAobWYpIHRoaXMuc2V0QWN0aXZlUGxheWVyKG1mKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguVGVhbSA9IFRlYW07Cn0pKCk7","Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgR29hbGllIGV4dGVuZHMgKHdpbmRvdy5mbHV4LlBsYXllciB8fCBjbGFzcyB7fSkgewpjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHb2FsaWUgU3BlY2lmaWMgU3RhdHMgKEJ1ZmZlZCBmb3IgUGxheWFiaWxpdHkpCiAgICAgICAgICAgIHRoaXMuc3RhdHMuQ0EgPSAzMDsgLy8gQ2F0Y2gKICAgICAgICAgICAgdGhpcy5zdGF0cy5TUCA9IDQwOyAvLyBTcGVlZAogICAgICAgICAgICB0aGlzLnN0YXRzLkVOID0gNTA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCVUZGRUQ6IFN0cm9uZyBhcm0gZm9yIGNsZWFyaW5nIHRoZSB6b25lCiAgICAgICAgICAgIHRoaXMuc3RhdHMuUEEgPSA0NTsgLy8gV2FzIDIwIC0gTm93IHN0cm9uZyBlbm91Z2ggdG8gcmVhY2ggbWlkZmllbGQKICAgICAgICAgICAgdGhpcy5zdGF0cy5TSCA9IDM1OyAvLyBXYXMgMTAgLSBEZWNlbnQgY2xlYXJhbmNlIGtpY2sKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gR29hbCBEaW1lbnNpb25zIChTYXZlIEJveCkgLSBNYXRjaGVzIEdhbWVNYW5hZ2VyIGRldGVjdGlvbgogICAgICAgICAgICB0aGlzLmdvYWxXaWR0aCA9IDIyLjA7IAogICAgICAgICAgICB0aGlzLmdvYWxIZWlnaHQgPSAxOC4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNhdmUgTWVjaGFuaWNzCi8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gZ2FtZSAmJiB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyAmJiAhZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNIdW1hbkNvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBEZWZlbnNlIC8gU2F2ZSBMb2dpYyAoTm8gQmFsbCkKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgfQoKX2NvbnN0cmFpbkJvdW5kcygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKCiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwovLyBZIEJvdW5kcyAoRXhwYW5kZWQgZm9yIGRlZXBlciBnb2FsKQogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxOC4wOyAKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIDIuMCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci56ICogMi4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCmlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCi8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlciAoQWRqdXN0ZWQgZm9yIG5ldyBZIG9mZnNldCAtOC4wKQogICAgICAgICAgICAgICAgX2dvYWxDZW50ZXIuc2V0KDAsIC04LjAsIG15R29hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBWZWN0b3IgZnJvbSBHb2FsIHRvIEJhbGwKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5zdWJWZWN0b3JzKF9iYWxsUG9zLCBfZ29hbENlbnRlcik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gX3RlbXBWZWNHLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWNHLm5vcm1hbGl6ZSgpOyAvLyBOb3cgaG9sZHMgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBFeHRlbnNpb24gKEhvdyBmYXIgb3V0IHRvIHN0ZXApCiAgICAgICAgICAgICAgICAvLyBCYXNlOiAxLjVtIG9mZiBsaW5lLgogICAgICAgICAgICAgICAgLy8gTWF4OiA2LjBtIG9mZiBsaW5lIChDdXR0aW5nIGFuZ2xlKS4KICAgICAgICAgICAgICAgIC8vIFNjYWxlIGJhc2VkIG9uIGJhbGwgcHJveGltaXR5OiBDbG9zZXIgYmFsbCA9IE1vcmUgZXh0ZW5zaW9uICh0byBhIHBvaW50KQpsZXQgZXh0ZW5zaW9uID0gMS41OwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAzMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSAxLjAgLSAoTWF0aC5tYXgoMCwgZGlzdFRvQmFsbCAtIDUuMCkgLyAyNS4wKTsgCiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gMS41ICsgKDQuNSAqIHJhdGlvKTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gU2FmZXR5OiBEb24ndCBnbyBwYXN0IHRoZSBiYWxsIChrZWVwIDFtIGJ1ZmZlcikKICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IE1hdGgubWluKGV4dGVuc2lvbiwgZGlzdFRvQmFsbCAtIDEuMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIENhbGN1bGF0ZSBUYXJnZXQgUG9zaXRpb24gKEJhc2UgSW50ZXJjZXB0aW9uKQogICAgICAgICAgICAgICAgX2dQb3MuY29weShfZ29hbENlbnRlcikuYWRkKF90ZW1wVmVjRy5tdWx0aXBseVNjYWxhcihleHRlbnNpb24pKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNS4gVmVydGljYWwgT3ZlcnJpZGUgKEp1bXAgdG8gbWVldCBiYWxsKQogICAgICAgICAgICAgICAgLy8gRXhwbGljaXRseSBzZXQgWSB0byBtYXRjaCBiYWxsIGhlaWdodCBpZiBpdCdzIGhpZ2gKICAgICAgICAgICAgICAgIGlmIChfYmFsbFBvcy55ID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IF9iYWxsUG9zLnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSAwLjU7IC8vIERlZmF1bHQgc3RhbmNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNi4gQ2xhbXAgdG8gR29hbCBCb3ggRGltZW5zaW9ucyAoTGF0ZXJhbC9WZXJ0aWNhbCBMaW1pdHMpCiAgICAgICAgICAgICAgICAvLyBHb2FsIFdpZHRoIDIyICgrLy0gMTEpLCBIZWlnaHQgMTggKCsvLSA5KS4KICAgICAgICAgICAgICAgIC8vIEFsbG93IHNsaWdodGx5IG91dHNpZGUgcG9zdHMgdG8gY292ZXIgYW5nbGVzLgogICAgICAgICAgICAgICAgY29uc3QgY2xhbXBYID0gdGhpcy5nb2FsV2lkdGggKiAwLjY7IC8vICsvLSAxMy4yCmNvbnN0IGNsYW1wWSA9IDE4LjA7IC8vIEluY3JlYXNlZCBtYXgganVtcCBoZWlnaHQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2dQb3MueCA9IE1hdGgubWF4KC1jbGFtcFgsIE1hdGgubWluKGNsYW1wWCwgX2dQb3MueCkpOwogICAgICAgICAgICAgICAgX2dQb3MueSA9IE1hdGgubWF4KC1jbGFtcFksIE1hdGgubWluKGNsYW1wWSwgX2dQb3MueSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA2LiBMZWFkIHRoZSBiYWxsIHNsaWdodGx5IGlmIGl0IGhhcyBsYXRlcmFsIHZlbG9jaXR5IChBbnRpY2lwYXRpb24pCmlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnRpY2lwYXRpb24gPSBiYWxsLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC4yNSk7IC8vIDAuMjVzIGxlYWQKICAgICAgICAgICAgICAgICAgICBhbnRpY2lwYXRpb24ueiA9IDA7IC8vIE9ubHkgbGF0ZXJhbCBsZWFkCiAgICAgICAgICAgICAgICAgICAgX2dQb3MuYWRkKGFudGljaXBhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oZ29hbERpc3QgLSAwLjUsIF9nUG9zLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2dQb3MueiA9IE1hdGgubWF4KC1nb2FsRGlzdCArIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3ZlIHRvd2FyZHMgdGFyZ2V0CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb1RhcmdldCA9IG1vdmVEaXIubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9UYXJnZXQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1cnN0IHNwZWVkIGZvciBzYXZlcyBpZiBiYWxsIGlzIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJnZW5jeSA9IChkaXN0VG9CYWxsIDwgMTAuMCkgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLm1heFNwZWVkICogdXJnZW5jeTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgYmFsbAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNBVkUgTUVDSEFOSUMgLS0tCiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIHdpdGhpbiByYW5nZSwgYXBwbHkgQ0EgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnNhdmVSYWRpdXMpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIElETEUgLyBSRVRVUk4gVE8gUE9TVCAtLS0KICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBob21lIHBvc2l0aW9uICh1c3VhbGx5IGNlbnRlciBvZiBnb2FsKQogICAgICAgICAgICAgICAgX2dQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1vdmVEaXIubGVuZ3RoKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcih0aGlzLm1heFNwZWVkICogMC42ICogZHQpKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciBmaWVsZAogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KSB7CiAgICAgICAgICAgIC8vIElmIEdvYWxpZSBpcyBBc2xlZXAsIHRoZXkgY2Fubm90IHNhdmUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gU1VQRVIgR09BTElFIFRSSUdHRVIgLS0tCiAgICAgICAgICAgIC8vIFRyaWdnZXIgaWY6IFRlY2ggZXF1aXBwZWQsIE5vdCBhY3RpdmUsIEJhbGwgaGFzIHBvd2VyLCBCYWxsIGlzIGNsb3NlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLmFjdGl2ZSA9PT0gJ3N1cGVyX2dvYWxpZScgJiYgIXRoaXMuaXNTdXBlckdvYWxpZSAmJiBiYWxsLnBvd2VyID4gNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBDaGFuY2UgdG8gdHJpZ2dlciAoSGlnaCBjaGFuY2UgZm9yIEFJLCBvciBjaGVjayBIUCkKICAgICAgICAgICAgICAgIC8vIENvc3Q6IDEwIEhQCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+PSAxMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gMTA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAxLjU7IC8vIExhc3RzIDEuNXMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHVzZWQgU1VQRVIgR09BTElFIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNVUEVSIEdPQUxJRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzYXZlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVGVjaGNvcHkgRXZlbnQKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsICdzdXBlcl9nb2FsaWUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBFZmZlY3RpdmUgQ0EKICAgICAgICAgICAgbGV0IGNhID0gdGhpcy5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3VwZXIgR29hbGllIEJvbnVzIChlLmcuICs1MCUgKyBGbGF0IDEwKQogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICBjYSA9IChjYSAqIDEuNSkgKyAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgR3JpcCBHbG92ZXMgKFBhc3NpdmUpCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdncmlwX2dsb3ZlcycpIHsKICAgICAgICAgICAgICAgIGNhICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQcmVzc3VyZQogICAgICAgICAgICAvLyBQcmVzc3VyZSA9IENBICogZHQgKiBNdWx0aXBsaWVyCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gY2EgKiBkdCAqIHRoaXMucHJlc3N1cmVNdWx0aXBsaWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSArPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIC8vIFRIUk9UVExFOiBJbmNyZWFzZWQgdGhyZXNob2xkIHRvIDEyLjAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPj0gMTIuMCkgeyAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCi8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQ0EnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgUmVzdWx0CiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgIC8vIENBVENICiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQmFsbChiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","./Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgR29hbGllIGV4dGVuZHMgKHdpbmRvdy5mbHV4LlBsYXllciB8fCBjbGFzcyB7fSkgewpjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHb2FsaWUgU3BlY2lmaWMgU3RhdHMgKEJ1ZmZlZCBmb3IgUGxheWFiaWxpdHkpCiAgICAgICAgICAgIHRoaXMuc3RhdHMuQ0EgPSAzMDsgLy8gQ2F0Y2gKICAgICAgICAgICAgdGhpcy5zdGF0cy5TUCA9IDQwOyAvLyBTcGVlZAogICAgICAgICAgICB0aGlzLnN0YXRzLkVOID0gNTA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCVUZGRUQ6IFN0cm9uZyBhcm0gZm9yIGNsZWFyaW5nIHRoZSB6b25lCiAgICAgICAgICAgIHRoaXMuc3RhdHMuUEEgPSA0NTsgLy8gV2FzIDIwIC0gTm93IHN0cm9uZyBlbm91Z2ggdG8gcmVhY2ggbWlkZmllbGQKICAgICAgICAgICAgdGhpcy5zdGF0cy5TSCA9IDM1OyAvLyBXYXMgMTAgLSBEZWNlbnQgY2xlYXJhbmNlIGtpY2sKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gR29hbCBEaW1lbnNpb25zIChTYXZlIEJveCkgLSBNYXRjaGVzIEdhbWVNYW5hZ2VyIGRldGVjdGlvbgogICAgICAgICAgICB0aGlzLmdvYWxXaWR0aCA9IDIyLjA7IAogICAgICAgICAgICB0aGlzLmdvYWxIZWlnaHQgPSAxOC4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNhdmUgTWVjaGFuaWNzCi8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gZ2FtZSAmJiB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyAmJiAhZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNIdW1hbkNvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBEZWZlbnNlIC8gU2F2ZSBMb2dpYyAoTm8gQmFsbCkKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgfQoKX2NvbnN0cmFpbkJvdW5kcygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKCiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwovLyBZIEJvdW5kcyAoRXhwYW5kZWQgZm9yIGRlZXBlciBnb2FsKQogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxOC4wOyAKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIDIuMCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci56ICogMi4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCmlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCi8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlciAoQWRqdXN0ZWQgZm9yIG5ldyBZIG9mZnNldCAtOC4wKQogICAgICAgICAgICAgICAgX2dvYWxDZW50ZXIuc2V0KDAsIC04LjAsIG15R29hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBWZWN0b3IgZnJvbSBHb2FsIHRvIEJhbGwKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5zdWJWZWN0b3JzKF9iYWxsUG9zLCBfZ29hbENlbnRlcik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gX3RlbXBWZWNHLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWNHLm5vcm1hbGl6ZSgpOyAvLyBOb3cgaG9sZHMgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBFeHRlbnNpb24gKEhvdyBmYXIgb3V0IHRvIHN0ZXApCiAgICAgICAgICAgICAgICAvLyBCYXNlOiAxLjVtIG9mZiBsaW5lLgogICAgICAgICAgICAgICAgLy8gTWF4OiA2LjBtIG9mZiBsaW5lIChDdXR0aW5nIGFuZ2xlKS4KICAgICAgICAgICAgICAgIC8vIFNjYWxlIGJhc2VkIG9uIGJhbGwgcHJveGltaXR5OiBDbG9zZXIgYmFsbCA9IE1vcmUgZXh0ZW5zaW9uICh0byBhIHBvaW50KQpsZXQgZXh0ZW5zaW9uID0gMS41OwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAzMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSAxLjAgLSAoTWF0aC5tYXgoMCwgZGlzdFRvQmFsbCAtIDUuMCkgLyAyNS4wKTsgCiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gMS41ICsgKDQuNSAqIHJhdGlvKTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gU2FmZXR5OiBEb24ndCBnbyBwYXN0IHRoZSBiYWxsIChrZWVwIDFtIGJ1ZmZlcikKICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IE1hdGgubWluKGV4dGVuc2lvbiwgZGlzdFRvQmFsbCAtIDEuMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIENhbGN1bGF0ZSBUYXJnZXQgUG9zaXRpb24gKEJhc2UgSW50ZXJjZXB0aW9uKQogICAgICAgICAgICAgICAgX2dQb3MuY29weShfZ29hbENlbnRlcikuYWRkKF90ZW1wVmVjRy5tdWx0aXBseVNjYWxhcihleHRlbnNpb24pKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNS4gVmVydGljYWwgT3ZlcnJpZGUgKEp1bXAgdG8gbWVldCBiYWxsKQogICAgICAgICAgICAgICAgLy8gRXhwbGljaXRseSBzZXQgWSB0byBtYXRjaCBiYWxsIGhlaWdodCBpZiBpdCdzIGhpZ2gKICAgICAgICAgICAgICAgIGlmIChfYmFsbFBvcy55ID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IF9iYWxsUG9zLnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSAwLjU7IC8vIERlZmF1bHQgc3RhbmNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNi4gQ2xhbXAgdG8gR29hbCBCb3ggRGltZW5zaW9ucyAoTGF0ZXJhbC9WZXJ0aWNhbCBMaW1pdHMpCiAgICAgICAgICAgICAgICAvLyBHb2FsIFdpZHRoIDIyICgrLy0gMTEpLCBIZWlnaHQgMTggKCsvLSA5KS4KICAgICAgICAgICAgICAgIC8vIEFsbG93IHNsaWdodGx5IG91dHNpZGUgcG9zdHMgdG8gY292ZXIgYW5nbGVzLgogICAgICAgICAgICAgICAgY29uc3QgY2xhbXBYID0gdGhpcy5nb2FsV2lkdGggKiAwLjY7IC8vICsvLSAxMy4yCmNvbnN0IGNsYW1wWSA9IDE4LjA7IC8vIEluY3JlYXNlZCBtYXgganVtcCBoZWlnaHQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2dQb3MueCA9IE1hdGgubWF4KC1jbGFtcFgsIE1hdGgubWluKGNsYW1wWCwgX2dQb3MueCkpOwogICAgICAgICAgICAgICAgX2dQb3MueSA9IE1hdGgubWF4KC1jbGFtcFksIE1hdGgubWluKGNsYW1wWSwgX2dQb3MueSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA2LiBMZWFkIHRoZSBiYWxsIHNsaWdodGx5IGlmIGl0IGhhcyBsYXRlcmFsIHZlbG9jaXR5IChBbnRpY2lwYXRpb24pCmlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnRpY2lwYXRpb24gPSBiYWxsLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC4yNSk7IC8vIDAuMjVzIGxlYWQKICAgICAgICAgICAgICAgICAgICBhbnRpY2lwYXRpb24ueiA9IDA7IC8vIE9ubHkgbGF0ZXJhbCBsZWFkCiAgICAgICAgICAgICAgICAgICAgX2dQb3MuYWRkKGFudGljaXBhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oZ29hbERpc3QgLSAwLjUsIF9nUG9zLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2dQb3MueiA9IE1hdGgubWF4KC1nb2FsRGlzdCArIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3ZlIHRvd2FyZHMgdGFyZ2V0CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb1RhcmdldCA9IG1vdmVEaXIubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9UYXJnZXQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1cnN0IHNwZWVkIGZvciBzYXZlcyBpZiBiYWxsIGlzIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJnZW5jeSA9IChkaXN0VG9CYWxsIDwgMTAuMCkgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLm1heFNwZWVkICogdXJnZW5jeTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgYmFsbAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNBVkUgTUVDSEFOSUMgLS0tCiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIHdpdGhpbiByYW5nZSwgYXBwbHkgQ0EgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnNhdmVSYWRpdXMpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIElETEUgLyBSRVRVUk4gVE8gUE9TVCAtLS0KICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBob21lIHBvc2l0aW9uICh1c3VhbGx5IGNlbnRlciBvZiBnb2FsKQogICAgICAgICAgICAgICAgX2dQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1vdmVEaXIubGVuZ3RoKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcih0aGlzLm1heFNwZWVkICogMC42ICogZHQpKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciBmaWVsZAogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KSB7CiAgICAgICAgICAgIC8vIElmIEdvYWxpZSBpcyBBc2xlZXAsIHRoZXkgY2Fubm90IHNhdmUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gU1VQRVIgR09BTElFIFRSSUdHRVIgLS0tCiAgICAgICAgICAgIC8vIFRyaWdnZXIgaWY6IFRlY2ggZXF1aXBwZWQsIE5vdCBhY3RpdmUsIEJhbGwgaGFzIHBvd2VyLCBCYWxsIGlzIGNsb3NlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLmFjdGl2ZSA9PT0gJ3N1cGVyX2dvYWxpZScgJiYgIXRoaXMuaXNTdXBlckdvYWxpZSAmJiBiYWxsLnBvd2VyID4gNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBDaGFuY2UgdG8gdHJpZ2dlciAoSGlnaCBjaGFuY2UgZm9yIEFJLCBvciBjaGVjayBIUCkKICAgICAgICAgICAgICAgIC8vIENvc3Q6IDEwIEhQCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+PSAxMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gMTA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAxLjU7IC8vIExhc3RzIDEuNXMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHVzZWQgU1VQRVIgR09BTElFIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNVUEVSIEdPQUxJRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzYXZlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVGVjaGNvcHkgRXZlbnQKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsICdzdXBlcl9nb2FsaWUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBFZmZlY3RpdmUgQ0EKICAgICAgICAgICAgbGV0IGNhID0gdGhpcy5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3VwZXIgR29hbGllIEJvbnVzIChlLmcuICs1MCUgKyBGbGF0IDEwKQogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICBjYSA9IChjYSAqIDEuNSkgKyAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgR3JpcCBHbG92ZXMgKFBhc3NpdmUpCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdncmlwX2dsb3ZlcycpIHsKICAgICAgICAgICAgICAgIGNhICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQcmVzc3VyZQogICAgICAgICAgICAvLyBQcmVzc3VyZSA9IENBICogZHQgKiBNdWx0aXBsaWVyCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gY2EgKiBkdCAqIHRoaXMucHJlc3N1cmVNdWx0aXBsaWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSArPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIC8vIFRIUk9UVExFOiBJbmNyZWFzZWQgdGhyZXNob2xkIHRvIDEyLjAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPj0gMTIuMCkgeyAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCi8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQ0EnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgUmVzdWx0CiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgIC8vIENBVENICiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQmFsbChiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","/Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKY2xhc3MgR29hbGllIGV4dGVuZHMgKHdpbmRvdy5mbHV4LlBsYXllciB8fCBjbGFzcyB7fSkgewpjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHb2FsaWUgU3BlY2lmaWMgU3RhdHMgKEJ1ZmZlZCBmb3IgUGxheWFiaWxpdHkpCiAgICAgICAgICAgIHRoaXMuc3RhdHMuQ0EgPSAzMDsgLy8gQ2F0Y2gKICAgICAgICAgICAgdGhpcy5zdGF0cy5TUCA9IDQwOyAvLyBTcGVlZAogICAgICAgICAgICB0aGlzLnN0YXRzLkVOID0gNTA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCVUZGRUQ6IFN0cm9uZyBhcm0gZm9yIGNsZWFyaW5nIHRoZSB6b25lCiAgICAgICAgICAgIHRoaXMuc3RhdHMuUEEgPSA0NTsgLy8gV2FzIDIwIC0gTm93IHN0cm9uZyBlbm91Z2ggdG8gcmVhY2ggbWlkZmllbGQKICAgICAgICAgICAgdGhpcy5zdGF0cy5TSCA9IDM1OyAvLyBXYXMgMTAgLSBEZWNlbnQgY2xlYXJhbmNlIGtpY2sKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gR29hbCBEaW1lbnNpb25zIChTYXZlIEJveCkgLSBNYXRjaGVzIEdhbWVNYW5hZ2VyIGRldGVjdGlvbgogICAgICAgICAgICB0aGlzLmdvYWxXaWR0aCA9IDIyLjA7IAogICAgICAgICAgICB0aGlzLmdvYWxIZWlnaHQgPSAxOC4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNhdmUgTWVjaGFuaWNzCi8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gZ2FtZSAmJiB0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyAmJiAhZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNIdW1hbkNvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBEZWZlbnNlIC8gU2F2ZSBMb2dpYyAoTm8gQmFsbCkKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgdGhpcy5fY29uc3RyYWluQm91bmRzKCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNWaXN1YWxzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgfQoKX2NvbnN0cmFpbkJvdW5kcygpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKCiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwovLyBZIEJvdW5kcyAoRXhwYW5kZWQgZm9yIGRlZXBlciBnb2FsKQogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxOC4wOyAKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSZWNvaWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtZmluYWxEaXIueCAqIDIuMCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1maW5hbERpci56ICogMi4wCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKdGhpcy5sb3NlQmFsbCgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCmlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcykgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCi8vIDEuIENhbGN1bGF0ZSBHb2FsIENlbnRlciAoQWRqdXN0ZWQgZm9yIG5ldyBZIG9mZnNldCAtOC4wKQogICAgICAgICAgICAgICAgX2dvYWxDZW50ZXIuc2V0KDAsIC04LjAsIG15R29hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAyLiBWZWN0b3IgZnJvbSBHb2FsIHRvIEJhbGwKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5zdWJWZWN0b3JzKF9iYWxsUG9zLCBfZ29hbENlbnRlcik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gX3RlbXBWZWNHLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWNHLm5vcm1hbGl6ZSgpOyAvLyBOb3cgaG9sZHMgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIERldGVybWluZSBFeHRlbnNpb24gKEhvdyBmYXIgb3V0IHRvIHN0ZXApCiAgICAgICAgICAgICAgICAvLyBCYXNlOiAxLjVtIG9mZiBsaW5lLgogICAgICAgICAgICAgICAgLy8gTWF4OiA2LjBtIG9mZiBsaW5lIChDdXR0aW5nIGFuZ2xlKS4KICAgICAgICAgICAgICAgIC8vIFNjYWxlIGJhc2VkIG9uIGJhbGwgcHJveGltaXR5OiBDbG9zZXIgYmFsbCA9IE1vcmUgZXh0ZW5zaW9uICh0byBhIHBvaW50KQpsZXQgZXh0ZW5zaW9uID0gMS41OwogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAzMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSAxLjAgLSAoTWF0aC5tYXgoMCwgZGlzdFRvQmFsbCAtIDUuMCkgLyAyNS4wKTsgCiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uID0gMS41ICsgKDQuNSAqIHJhdGlvKTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gU2FmZXR5OiBEb24ndCBnbyBwYXN0IHRoZSBiYWxsIChrZWVwIDFtIGJ1ZmZlcikKICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IE1hdGgubWluKGV4dGVuc2lvbiwgZGlzdFRvQmFsbCAtIDEuMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDQuIENhbGN1bGF0ZSBUYXJnZXQgUG9zaXRpb24gKEJhc2UgSW50ZXJjZXB0aW9uKQogICAgICAgICAgICAgICAgX2dQb3MuY29weShfZ29hbENlbnRlcikuYWRkKF90ZW1wVmVjRy5tdWx0aXBseVNjYWxhcihleHRlbnNpb24pKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gNS4gVmVydGljYWwgT3ZlcnJpZGUgKEp1bXAgdG8gbWVldCBiYWxsKQogICAgICAgICAgICAgICAgLy8gRXhwbGljaXRseSBzZXQgWSB0byBtYXRjaCBiYWxsIGhlaWdodCBpZiBpdCdzIGhpZ2gKICAgICAgICAgICAgICAgIGlmIChfYmFsbFBvcy55ID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgX2dQb3MueSA9IF9iYWxsUG9zLnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSAwLjU7IC8vIERlZmF1bHQgc3RhbmNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNi4gQ2xhbXAgdG8gR29hbCBCb3ggRGltZW5zaW9ucyAoTGF0ZXJhbC9WZXJ0aWNhbCBMaW1pdHMpCiAgICAgICAgICAgICAgICAvLyBHb2FsIFdpZHRoIDIyICgrLy0gMTEpLCBIZWlnaHQgMTggKCsvLSA5KS4KICAgICAgICAgICAgICAgIC8vIEFsbG93IHNsaWdodGx5IG91dHNpZGUgcG9zdHMgdG8gY292ZXIgYW5nbGVzLgogICAgICAgICAgICAgICAgY29uc3QgY2xhbXBYID0gdGhpcy5nb2FsV2lkdGggKiAwLjY7IC8vICsvLSAxMy4yCmNvbnN0IGNsYW1wWSA9IDE4LjA7IC8vIEluY3JlYXNlZCBtYXgganVtcCBoZWlnaHQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2dQb3MueCA9IE1hdGgubWF4KC1jbGFtcFgsIE1hdGgubWluKGNsYW1wWCwgX2dQb3MueCkpOwogICAgICAgICAgICAgICAgX2dQb3MueSA9IE1hdGgubWF4KC1jbGFtcFksIE1hdGgubWluKGNsYW1wWSwgX2dQb3MueSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA2LiBMZWFkIHRoZSBiYWxsIHNsaWdodGx5IGlmIGl0IGhhcyBsYXRlcmFsIHZlbG9jaXR5IChBbnRpY2lwYXRpb24pCmlmIChiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAxLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnRpY2lwYXRpb24gPSBiYWxsLnZlbG9jaXR5LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC4yNSk7IC8vIDAuMjVzIGxlYWQKICAgICAgICAgICAgICAgICAgICBhbnRpY2lwYXRpb24ueiA9IDA7IC8vIE9ubHkgbGF0ZXJhbCBsZWFkCiAgICAgICAgICAgICAgICAgICAgX2dQb3MuYWRkKGFudGljaXBhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5zaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oZ29hbERpc3QgLSAwLjUsIF9nUG9zLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2dQb3MueiA9IE1hdGgubWF4KC1nb2FsRGlzdCArIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3ZlIHRvd2FyZHMgdGFyZ2V0CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb1RhcmdldCA9IG1vdmVEaXIubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9UYXJnZXQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1cnN0IHNwZWVkIGZvciBzYXZlcyBpZiBiYWxsIGlzIGNsb3NlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJnZW5jeSA9IChkaXN0VG9CYWxsIDwgMTAuMCkgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLm1heFNwZWVkICogdXJnZW5jeTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgYmFsbAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNBVkUgTUVDSEFOSUMgLS0tCiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIHdpdGhpbiByYW5nZSwgYXBwbHkgQ0EgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCB0aGlzLnNhdmVSYWRpdXMpIHsgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLS0tIElETEUgLyBSRVRVUk4gVE8gUE9TVCAtLS0KICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBob21lIHBvc2l0aW9uICh1c3VhbGx5IGNlbnRlciBvZiBnb2FsKQogICAgICAgICAgICAgICAgX2dQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBtb3ZlRGlyID0gX2dWZWMuc3ViVmVjdG9ycyhfZ1BvcywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1vdmVEaXIubGVuZ3RoKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlRGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcih0aGlzLm1heFNwZWVkICogMC42ICogZHQpKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWNlIGNlbnRlciBmaWVsZAogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KSB7CiAgICAgICAgICAgIC8vIElmIEdvYWxpZSBpcyBBc2xlZXAsIHRoZXkgY2Fubm90IHNhdmUuCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gU1VQRVIgR09BTElFIFRSSUdHRVIgLS0tCiAgICAgICAgICAgIC8vIFRyaWdnZXIgaWY6IFRlY2ggZXF1aXBwZWQsIE5vdCBhY3RpdmUsIEJhbGwgaGFzIHBvd2VyLCBCYWxsIGlzIGNsb3NlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLmFjdGl2ZSA9PT0gJ3N1cGVyX2dvYWxpZScgJiYgIXRoaXMuaXNTdXBlckdvYWxpZSAmJiBiYWxsLnBvd2VyID4gNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBDaGFuY2UgdG8gdHJpZ2dlciAoSGlnaCBjaGFuY2UgZm9yIEFJLCBvciBjaGVjayBIUCkKICAgICAgICAgICAgICAgIC8vIENvc3Q6IDEwIEhQCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+PSAxMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gMTA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAxLjU7IC8vIExhc3RzIDEuNXMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHVzZWQgU1VQRVIgR09BTElFIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNVUEVSIEdPQUxJRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzYXZlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgVGVjaGNvcHkgRXZlbnQKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsICdzdXBlcl9nb2FsaWUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBFZmZlY3RpdmUgQ0EKICAgICAgICAgICAgbGV0IGNhID0gdGhpcy5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3VwZXIgR29hbGllIEJvbnVzIChlLmcuICs1MCUgKyBGbGF0IDEwKQogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICBjYSA9IChjYSAqIDEuNSkgKyAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgR3JpcCBHbG92ZXMgKFBhc3NpdmUpCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdncmlwX2dsb3ZlcycpIHsKICAgICAgICAgICAgICAgIGNhICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQcmVzc3VyZQogICAgICAgICAgICAvLyBQcmVzc3VyZSA9IENBICogZHQgKiBNdWx0aXBsaWVyCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gY2EgKiBkdCAqIHRoaXMucHJlc3N1cmVNdWx0aXBsaWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSArPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIC8vIFRIUk9UVExFOiBJbmNyZWFzZWQgdGhyZXNob2xkIHRvIDEyLjAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPj0gMTIuMCkgeyAKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCi8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlY2hJbW11bml0eVRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdGVjaCA9IGJhbGwudGVjaG5pcXVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygndmVub20nLCAxNS4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ25hcCcsIDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxNS4wLCAnQ0EnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgUmVzdWx0CiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyIDw9IDAgJiYgdGhpcy5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgIC8vIENBVENICiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoQmFsbChiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","./MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","/MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwplbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ0JVUk4nKSkgY2xhc3Nlcy5wdXNoKCdidXJuJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdGUkVFWkUnKSB8fCB1cHBlci5pbmNsdWRlcygnRlJPWkVOJykpIGNsYXNzZXMucHVzaCgnZnJlZXplJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdTSE9DSycpKSBjbGFzc2VzLnB1c2goJ3Nob2NrJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdibGluZCcpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2lsZW5jZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2hpZWxkJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMTAuMDsgLy8gRmxvYXQgdXAgZmFzdAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdoYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTIwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgNS4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nsb3cnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDIwLjA7IC8vIEhlYXZ5IGRyb3AKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAtMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwppbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2J1cm4nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC04LjA7IC8vIEZsb2F0IHVwIGxpa2UgZmlyZQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMS4wLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZnJlZXplJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOyAvLyBTdXNwZW5kZWQKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nob2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7IC8vIFNsb3cgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMjsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","./FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwplbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ0JVUk4nKSkgY2xhc3Nlcy5wdXNoKCdidXJuJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdGUkVFWkUnKSB8fCB1cHBlci5pbmNsdWRlcygnRlJPWkVOJykpIGNsYXNzZXMucHVzaCgnZnJlZXplJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdTSE9DSycpKSBjbGFzc2VzLnB1c2goJ3Nob2NrJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdibGluZCcpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2lsZW5jZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2hpZWxkJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMTAuMDsgLy8gRmxvYXQgdXAgZmFzdAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdoYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTIwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgNS4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nsb3cnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDIwLjA7IC8vIEhlYXZ5IGRyb3AKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAtMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwppbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2J1cm4nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC04LjA7IC8vIEZsb2F0IHVwIGxpa2UgZmlyZQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMS4wLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZnJlZXplJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOyAvLyBTdXNwZW5kZWQKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nob2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7IC8vIFNsb3cgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMjsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","/FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwplbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdzYXZlJyB8fCB0eXBlID09PSAnYmxvY2snKSBjbGFzc2VzLnB1c2goJ3NhdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5ldyBTdGF0dXNlcwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnQkxJTkQnKSkgY2xhc3Nlcy5wdXNoKCdibGluZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0lMRU5DRScpKSBjbGFzc2VzLnB1c2goJ3NpbGVuY2UnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NISUVMRCcpKSBjbGFzc2VzLnB1c2goJ3NoaWVsZCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnSEFTVEUnKSkgY2xhc3Nlcy5wdXNoKCdoYXN0ZScpOwplbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xPVycpKSBjbGFzc2VzLnB1c2goJ3Nsb3cnKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ0JVUk4nKSkgY2xhc3Nlcy5wdXNoKCdidXJuJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdGUkVFWkUnKSB8fCB1cHBlci5pbmNsdWRlcygnRlJPWkVOJykpIGNsYXNzZXMucHVzaCgnZnJlZXplJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdTSE9DSycpKSBjbGFzc2VzLnB1c2goJ3Nob2NrJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdibGluZCcpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2lsZW5jZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAxLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnc2hpZWxkJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMTAuMDsgLy8gRmxvYXQgdXAgZmFzdAogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdoYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTIwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgNS4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nsb3cnKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDIwLjA7IC8vIEhlYXZ5IGRyb3AKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAtMi4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS41OwppbnN0YW5jZS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2J1cm4nKSkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IC04LjA7IC8vIEZsb2F0IHVwIGxpa2UgZmlyZQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMS4wLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnZnJlZXplJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOyAvLyBTdXNwZW5kZWQKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAyLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3Nob2NrJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7IC8vIFNsb3cgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDEuMjsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAxLjI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMy4wLCAwKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSA1LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDEuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CgogICAgICAgICAgICB0aGlzLnRleHRzLnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKGluc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy50ZXh0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dHNbaV07CiAgICAgICAgICAgICAgICB0LmxpZmUgLT0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAtPSB0LmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5kcmFnID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICh0LmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueSAqPSAtdC5lbGFzdGljaXR5OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnggKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnogKj0gMC43OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModC52ZWxvY2l0eS55KSA8IDIuMCkgdC52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9vbC5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVBvc2l0aW9uKHQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMuX3RlbXBWLmNvcHkodC53b3JsZFBvcykuYWRkKHQub2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5fdGVtcFYucHJvamVjdCh0aGlzLmNhbWVyYSk7CgogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IENoZWNrIGJvdW5kcyBiZWZvcmUgc2V0dGluZyBzdHlsZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSBwYWludAogICAgICAgICAgICBpZiAodGhpcy5fdGVtcFYueiA+IDEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueCkgPiAxLjEgfHwgTWF0aC5hYnModGhpcy5fdGVtcFYueSkgPiAxLjEpIHsKICAgICAgICAgICAgICAgICAvLyBPZmZzY3JlZW4KICAgICAgICAgICAgICAgICBpZiAodC5lbC5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScpIHQuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoLSh0aGlzLl90ZW1wVi55ICogLjUpICsgLjUpICogdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgdHJhbnNsYXRlM2QgZm9yIEdQVSBhY2NlbGVyYXRpb24KICAgICAgICAgICAgICAgIHQuZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eC50b0ZpeGVkKDEpfXB4LCAke3kudG9GaXhlZCgxKX1weCwgMClgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCmFkZFJlY29pbCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnggKz0geDsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueSArPSB5OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC56ICs9IHo7CiAgICAgICAgfQoKICAgICAgICBhZGRBYmVycmF0aW9uKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gTWF0aC5tYXgodGhpcy5hYmVycmF0aW9uSW1wdWxzZSwgYW1vdW50KTsKICAgICAgICB9CgpzbmFwVG9UYXJnZXQoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlSWRlYWxTdGF0ZSgwKTsKCiAgICAgICAgICAgIHRoaXMucG9zLmNvcHkoX2lkZWFsUG9zKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQuY29weShfaWRlYWxMb29rKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGhpcy50YXJnZXRZYXc7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2luZW1hdGljKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaW5lbWF0aWMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzYWZlRHQgPSBNYXRoLm1pbihkdCwgMC4wNSk7CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXV0by1yZWNlbnRlciBsb2dpYyAoT25seSBpZiBub3QgYWltaW5nKQogICAgICAgICAgICBpZiAoIXRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgKz0gc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPiB0aGlzLmF1dG9SZWNlbnRlckRlbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZW50ZXJTcGVlZCA9IDIuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKj0gKDEuMCAtIHJlY2VudGVyU3BlZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogU21hcnQgcHVsbC1iYWNrIGJhc2VkIG9uIGJhbGwgc3BlZWQKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbCAmJiB0aGlzLmJhbGwudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IHRoaXMuYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFB1bGxCYWNrID0gTWF0aC5taW4odGhpcy5tYXhQdWxsQmFjaywgYmFsbFNwZWVkICogMC4zKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICs9ICh0YXJnZXRQdWxsQmFjayAtIHRoaXMuY3VycmVudFB1bGxCYWNrKSAqIHNhZmVEdCAqIDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICo9ICgxLjAgLSBzYWZlRHQgKiAyLjApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAxLiBVcGRhdGUgVGFyZ2V0IEluZm8KICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoc2FmZUR0KTsKCiAgICAgICAgICAgIC8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKLy8gMy4gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAvLyBEeW5hbWljIGZvbGxvdyBzcGVlZCBiYXNlZCBvbiBkaXN0YW5jZSBlcnJvciAoQ2F0Y2gtdXAgbG9naWMpCiAgICAgICAgICAgIGNvbnN0IGRpc3RFcnJvciA9IHRoaXMucG9zLmRpc3RhbmNlVG8oX2lkZWFsUG9zKTsKICAgICAgICAgICAgY29uc3QgZHluYW1pY0ZvbGxvdyA9IHRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICsgKGRpc3RFcnJvciAqIDAuMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZE11bHQgPSB0aGlzLmlzQWltaW5nID8gMi4wIDogMS4wOwogICAgICAgICAgICBjb25zdCBsb29rRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmxvb2tTcGVlZCAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC1keW5hbWljRm9sbG93ICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCnRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwp0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZWNvaWwgRGVjYXkKdGhpcy5yZWNvaWxPZmZzZXQubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDguMCAqIHNhZmVEdCkpKTsKCiAgICAgICAgICAgIC8vIEFiZXJyYXRpb24gRGVjYXkgJiBBcHBseQogICAgICAgICAgICBpZiAodGhpcy5hYmVycmF0aW9uSW1wdWxzZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDUuMCAqIHNhZmVEdCkpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPCAwLjEpIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgMS41ICsgSW1wdWxzZQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA9IDEuNSArIHRoaXMuYWJlcnJhdGlvbkltcHVsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gYmFzZSBpZiBubyBpbXB1bHNlIChhbmQgbm90IGRpcnR5KQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA+IDEuNikgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjUuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC0xMCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEZvdiA9IHRoaXMuY29uZmlnLmZvdkJhc2UgKyAodGhpcy5jb25maWcuZm92TWF4IC0gdGhpcy5jb25maWcuZm92QmFzZSkgKiB3YXJwICsgdGhpcy5mb3ZJbXB1bHNlICsgYWltWm9vbTsKCiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoNi4wICogc2FmZUR0KSk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5mb3YgKz0gKHRhcmdldEZvdiAtIHRoaXMuY2FtZXJhLmZvdikgKiA0LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCi8vIDYuIEFwcGx5IHRvIENhbWVyYQogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKS5hZGQodGhpcy5zaGFrZU9mZnNldCkuYWRkKHRoaXMucmVjb2lsT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCi8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50Ci8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50CiAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHRoaXMuY2FtZXJhLmFzcGVjdDsKICAgICAgICAgICAgLy8gOToxNiBpcyB+MC41Ni4gV2UgdHJpZ2dlciBhZGp1c3RtZW50IGlmIG5hcnJvd2VyIHRoYW4gc3F1YXJlLgogICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMC44NTsgCiAgICAgICAgICAgIGNvbnN0IHBvcnRyYWl0TXVsdCA9IGlzUG9ydHJhaXQgPyAxLjcgOiAxLjA7IC8vIFB1bGwgYmFjayA3MCUgbW9yZSBpbiBwb3J0cmFpdCB0byBzZWUgdGhlIGZpZWxkCiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9ICh0aGlzLmNvbmZpZy5iYXNlRGlzdGFuY2UgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayArIHRocmVhdFB1bGxiYWNrKSAqIHBvcnRyYWl0TXVsdDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gKHRoaXMuY29uZmlnLmJhc2VIZWlnaHQgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayAqIDAuMyArIHRocmVhdFB1bGxiYWNrICogMC41ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTApICogcG9ydHJhaXRNdWx0OwoKICAgICAgICAgICAgLy8gQmFzZSBvZmZzZXQgKENhbWVyYSB1c3VhbGx5IHNpdHMgYXQgK1ogcmVsYXRpdmUgdG8gdGFyZ2V0KQogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbENhbVggPSBjYW1aICogTWF0aC5zaW4odGhpcy5tYW51YWxPcmJpdFlhdyk7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsQ2FtWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKCiAgICAgICAgICAgIF9pZGVhbFBvcy5zZXQodFBvcy54ICsgZmluYWxDYW1YLCB0UG9zLnkgKyBlZmZlY3RpdmVIZWlnaHQsIHRQb3MueiArIGZpbmFsQ2FtWik7CgogICAgICAgICAgICAvLyBDbGFtcCB0byBhcmVuYSBib3VuZHMgKHJvdWdobHkpIHRvIHByZXZlbnQgY2xpcHBpbmcgdGhyb3VnaCB3YWxscwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPiA0OC4wKSBfaWRlYWxQb3MueiA9IDQ4LjA7CiAgICAgICAgICAgIGlmIChfaWRlYWxQb3MueiA8IC00OC4wKSBfaWRlYWxQb3MueiA9IC00OC4wOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIExvb2tBdCB3aXRoIElNUFJPVkVEIGxvb2stYWhlYWQKICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFZlbG9jaXR5LWJhc2VkIGxvb2stYWhlYWQKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0VmVsLmxlbmd0aFNxKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBsb29rQWhlYWRGYWN0b3IgPSBNYXRoLm1pbigxLjAsIHNwZWVkIC8gMTUuMCkgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWREaXN0YW5jZTsKCiAgICAgICAgICAgICAgICBjb25zdCB2ZWxEaXIgPSB0aGlzLnRhcmdldFZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgX2xvb2tBaGVhZC5jb3B5KHZlbERpcikubXVsdGlwbHlTY2FsYXIobG9va0FoZWFkRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdGhlIGxvb2stYWhlYWQKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubGVycChfbG9va0FoZWFkLCBkdCAqIHRoaXMuY29uZmlnLmxvb2tBaGVhZFNtb290aGluZyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmFkZCh0aGlzLnNtb290aGVkTG9va0FoZWFkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZHQgKiAzLjApOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9pZGVhbExvb2sueSAqPSAwLjU7IC8vIExvb2sgc2xpZ2h0bHkgbG93ZXIgdGhhbiBhY3R1YWwgdGFyZ2V0IGhlaWdodAoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEluY2x1ZGUgYmFsbCBpbiBmcmFtaW5nIHdoZW4gbmVhcmJ5CiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLm1lc2ggJiYgdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IHRoaXMuYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRQb3MuZGlzdGFuY2VUbyhiYWxsUG9zKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDI1ICYmIGRpc3RUb0JhbGwgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFdlaWdodCA9IE1hdGgubWF4KDAsIDEgLSBkaXN0VG9CYWxsIC8gMjUpICogdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0OwogICAgICAgICAgICAgICAgICAgIF9pZGVhbExvb2subGVycChiYWxsUG9zLCBiYWxsV2VpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSW5wdXQgQW50aWNpcGF0aW9uIChTbW9vdGhlZCkKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0LmxlcnAodGhpcy50YXJnZXRJbnB1dCwgZHQgKiAzLjApOwoKICAgICAgICAgICAgaWYgKHRoaXMuc21vb3RoZWRJbnB1dC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgX2lkZWFsTG9vay54ICs9IHRoaXMuc21vb3RoZWRJbnB1dC54ICogNC4wOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay56ICs9IHRoaXMuc21vb3RoZWRJbnB1dC56ICogNC4wOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlVGhyZWF0TGV2ZWwoY2VudGVyUG9zKSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSByZXR1cm4gMDsKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lLnRlYW1zKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBkZW5zaXR5ID0gMDsKICAgICAgICAgICAgY29uc3QgY2hlY2tUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZWFtLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gdGVhbS5wbGF5ZXJzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoICE9PSB0aGlzLnRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoY2VudGVyUG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRTcSA8IDY0LjApIHsgLy8gOG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZW5zaXR5ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2hlY2tUZWFtKGdhbWUudGVhbXMuaG9tZSk7CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmF3YXkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKDEuMCwgZGVuc2l0eSAvIDQuMCk7IC8vIENhcCBhdCA0IHBsYXllcnMKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IGZvcndhcmQgZGlyZWN0aW9uIGZvciBVSSByZWZlcmVuY2UKICAgICAgICBnZXRGb3J3YXJkRGlyZWN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfY2FtRndkLmNsb25lKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCByaWdodCBkaXJlY3Rpb24KICAgICAgICBnZXRSaWdodERpcmVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZndkID0gdGhpcy5nZXRGb3J3YXJkRGlyZWN0aW9uKCk7CiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHJldHVybiBfY2FtUmlnaHQuY2xvbmUoKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlciA9IENhbWVyYU1hbmFnZXI7Cn0pKCk7Cg==","./CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCmFkZFJlY29pbCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnggKz0geDsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueSArPSB5OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC56ICs9IHo7CiAgICAgICAgfQoKICAgICAgICBhZGRBYmVycmF0aW9uKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gTWF0aC5tYXgodGhpcy5hYmVycmF0aW9uSW1wdWxzZSwgYW1vdW50KTsKICAgICAgICB9CgpzbmFwVG9UYXJnZXQoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlSWRlYWxTdGF0ZSgwKTsKCiAgICAgICAgICAgIHRoaXMucG9zLmNvcHkoX2lkZWFsUG9zKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQuY29weShfaWRlYWxMb29rKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGhpcy50YXJnZXRZYXc7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2luZW1hdGljKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaW5lbWF0aWMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzYWZlRHQgPSBNYXRoLm1pbihkdCwgMC4wNSk7CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXV0by1yZWNlbnRlciBsb2dpYyAoT25seSBpZiBub3QgYWltaW5nKQogICAgICAgICAgICBpZiAoIXRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgKz0gc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPiB0aGlzLmF1dG9SZWNlbnRlckRlbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZW50ZXJTcGVlZCA9IDIuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKj0gKDEuMCAtIHJlY2VudGVyU3BlZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogU21hcnQgcHVsbC1iYWNrIGJhc2VkIG9uIGJhbGwgc3BlZWQKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbCAmJiB0aGlzLmJhbGwudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IHRoaXMuYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFB1bGxCYWNrID0gTWF0aC5taW4odGhpcy5tYXhQdWxsQmFjaywgYmFsbFNwZWVkICogMC4zKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICs9ICh0YXJnZXRQdWxsQmFjayAtIHRoaXMuY3VycmVudFB1bGxCYWNrKSAqIHNhZmVEdCAqIDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICo9ICgxLjAgLSBzYWZlRHQgKiAyLjApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAxLiBVcGRhdGUgVGFyZ2V0IEluZm8KICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoc2FmZUR0KTsKCiAgICAgICAgICAgIC8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKLy8gMy4gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAvLyBEeW5hbWljIGZvbGxvdyBzcGVlZCBiYXNlZCBvbiBkaXN0YW5jZSBlcnJvciAoQ2F0Y2gtdXAgbG9naWMpCiAgICAgICAgICAgIGNvbnN0IGRpc3RFcnJvciA9IHRoaXMucG9zLmRpc3RhbmNlVG8oX2lkZWFsUG9zKTsKICAgICAgICAgICAgY29uc3QgZHluYW1pY0ZvbGxvdyA9IHRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICsgKGRpc3RFcnJvciAqIDAuMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZE11bHQgPSB0aGlzLmlzQWltaW5nID8gMi4wIDogMS4wOwogICAgICAgICAgICBjb25zdCBsb29rRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmxvb2tTcGVlZCAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC1keW5hbWljRm9sbG93ICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCnRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwp0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZWNvaWwgRGVjYXkKdGhpcy5yZWNvaWxPZmZzZXQubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDguMCAqIHNhZmVEdCkpKTsKCiAgICAgICAgICAgIC8vIEFiZXJyYXRpb24gRGVjYXkgJiBBcHBseQogICAgICAgICAgICBpZiAodGhpcy5hYmVycmF0aW9uSW1wdWxzZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDUuMCAqIHNhZmVEdCkpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPCAwLjEpIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgMS41ICsgSW1wdWxzZQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA9IDEuNSArIHRoaXMuYWJlcnJhdGlvbkltcHVsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gYmFzZSBpZiBubyBpbXB1bHNlIChhbmQgbm90IGRpcnR5KQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA+IDEuNikgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjUuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC0xMCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEZvdiA9IHRoaXMuY29uZmlnLmZvdkJhc2UgKyAodGhpcy5jb25maWcuZm92TWF4IC0gdGhpcy5jb25maWcuZm92QmFzZSkgKiB3YXJwICsgdGhpcy5mb3ZJbXB1bHNlICsgYWltWm9vbTsKCiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoNi4wICogc2FmZUR0KSk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5mb3YgKz0gKHRhcmdldEZvdiAtIHRoaXMuY2FtZXJhLmZvdikgKiA0LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCi8vIDYuIEFwcGx5IHRvIENhbWVyYQogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKS5hZGQodGhpcy5zaGFrZU9mZnNldCkuYWRkKHRoaXMucmVjb2lsT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCi8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50Ci8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50CiAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHRoaXMuY2FtZXJhLmFzcGVjdDsKICAgICAgICAgICAgLy8gOToxNiBpcyB+MC41Ni4gV2UgdHJpZ2dlciBhZGp1c3RtZW50IGlmIG5hcnJvd2VyIHRoYW4gc3F1YXJlLgogICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMC44NTsgCiAgICAgICAgICAgIGNvbnN0IHBvcnRyYWl0TXVsdCA9IGlzUG9ydHJhaXQgPyAxLjcgOiAxLjA7IC8vIFB1bGwgYmFjayA3MCUgbW9yZSBpbiBwb3J0cmFpdCB0byBzZWUgdGhlIGZpZWxkCiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9ICh0aGlzLmNvbmZpZy5iYXNlRGlzdGFuY2UgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayArIHRocmVhdFB1bGxiYWNrKSAqIHBvcnRyYWl0TXVsdDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gKHRoaXMuY29uZmlnLmJhc2VIZWlnaHQgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayAqIDAuMyArIHRocmVhdFB1bGxiYWNrICogMC41ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTApICogcG9ydHJhaXRNdWx0OwoKICAgICAgICAgICAgLy8gQmFzZSBvZmZzZXQgKENhbWVyYSB1c3VhbGx5IHNpdHMgYXQgK1ogcmVsYXRpdmUgdG8gdGFyZ2V0KQogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbENhbVggPSBjYW1aICogTWF0aC5zaW4odGhpcy5tYW51YWxPcmJpdFlhdyk7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsQ2FtWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKCiAgICAgICAgICAgIF9pZGVhbFBvcy5zZXQodFBvcy54ICsgZmluYWxDYW1YLCB0UG9zLnkgKyBlZmZlY3RpdmVIZWlnaHQsIHRQb3MueiArIGZpbmFsQ2FtWik7CgogICAgICAgICAgICAvLyBDbGFtcCB0byBhcmVuYSBib3VuZHMgKHJvdWdobHkpIHRvIHByZXZlbnQgY2xpcHBpbmcgdGhyb3VnaCB3YWxscwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPiA0OC4wKSBfaWRlYWxQb3MueiA9IDQ4LjA7CiAgICAgICAgICAgIGlmIChfaWRlYWxQb3MueiA8IC00OC4wKSBfaWRlYWxQb3MueiA9IC00OC4wOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIExvb2tBdCB3aXRoIElNUFJPVkVEIGxvb2stYWhlYWQKICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFZlbG9jaXR5LWJhc2VkIGxvb2stYWhlYWQKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0VmVsLmxlbmd0aFNxKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBsb29rQWhlYWRGYWN0b3IgPSBNYXRoLm1pbigxLjAsIHNwZWVkIC8gMTUuMCkgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWREaXN0YW5jZTsKCiAgICAgICAgICAgICAgICBjb25zdCB2ZWxEaXIgPSB0aGlzLnRhcmdldFZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgX2xvb2tBaGVhZC5jb3B5KHZlbERpcikubXVsdGlwbHlTY2FsYXIobG9va0FoZWFkRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdGhlIGxvb2stYWhlYWQKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubGVycChfbG9va0FoZWFkLCBkdCAqIHRoaXMuY29uZmlnLmxvb2tBaGVhZFNtb290aGluZyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmFkZCh0aGlzLnNtb290aGVkTG9va0FoZWFkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZHQgKiAzLjApOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9pZGVhbExvb2sueSAqPSAwLjU7IC8vIExvb2sgc2xpZ2h0bHkgbG93ZXIgdGhhbiBhY3R1YWwgdGFyZ2V0IGhlaWdodAoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEluY2x1ZGUgYmFsbCBpbiBmcmFtaW5nIHdoZW4gbmVhcmJ5CiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLm1lc2ggJiYgdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IHRoaXMuYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRQb3MuZGlzdGFuY2VUbyhiYWxsUG9zKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDI1ICYmIGRpc3RUb0JhbGwgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFdlaWdodCA9IE1hdGgubWF4KDAsIDEgLSBkaXN0VG9CYWxsIC8gMjUpICogdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0OwogICAgICAgICAgICAgICAgICAgIF9pZGVhbExvb2subGVycChiYWxsUG9zLCBiYWxsV2VpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSW5wdXQgQW50aWNpcGF0aW9uIChTbW9vdGhlZCkKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0LmxlcnAodGhpcy50YXJnZXRJbnB1dCwgZHQgKiAzLjApOwoKICAgICAgICAgICAgaWYgKHRoaXMuc21vb3RoZWRJbnB1dC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgX2lkZWFsTG9vay54ICs9IHRoaXMuc21vb3RoZWRJbnB1dC54ICogNC4wOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay56ICs9IHRoaXMuc21vb3RoZWRJbnB1dC56ICogNC4wOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlVGhyZWF0TGV2ZWwoY2VudGVyUG9zKSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSByZXR1cm4gMDsKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lLnRlYW1zKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBkZW5zaXR5ID0gMDsKICAgICAgICAgICAgY29uc3QgY2hlY2tUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZWFtLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gdGVhbS5wbGF5ZXJzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoICE9PSB0aGlzLnRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoY2VudGVyUG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRTcSA8IDY0LjApIHsgLy8gOG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZW5zaXR5ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2hlY2tUZWFtKGdhbWUudGVhbXMuaG9tZSk7CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmF3YXkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKDEuMCwgZGVuc2l0eSAvIDQuMCk7IC8vIENhcCBhdCA0IHBsYXllcnMKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IGZvcndhcmQgZGlyZWN0aW9uIGZvciBVSSByZWZlcmVuY2UKICAgICAgICBnZXRGb3J3YXJkRGlyZWN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfY2FtRndkLmNsb25lKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCByaWdodCBkaXJlY3Rpb24KICAgICAgICBnZXRSaWdodERpcmVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZndkID0gdGhpcy5nZXRGb3J3YXJkRGlyZWN0aW9uKCk7CiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHJldHVybiBfY2FtUmlnaHQuY2xvbmUoKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlciA9IENhbWVyYU1hbmFnZXI7Cn0pKCk7Cg==","/CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCnRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMTQuMCwgICAvLyBDbG9zZXIgZm9yIGltbWVyc2lvbiAod2FzIDIwLjApCiAgICAgICAgICAgICAgICBiYXNlSGVpZ2h0OiA4LjAsICAgICAgLy8gTG93ZXIgYW5nbGUgZm9yIGNoYXNlIGZlZWwgKHdhcyAxMi4wKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA2LjAsICAgICAvLyBTbmFwcGllciBmb2xsb3cKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogNC4wLCAgICAgICAvLyBSZXNwb25zaXZlIGxvb2stYXQKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNjUsICAgICAgICAgIC8vIEhpZ2hlciBiYXNlIEZPViAod2FzIDUwKQogICAgICAgICAgICAgICAgZm92TWF4OiA4NSwgICAgICAgICAgIC8vIEhpZ2hlciBtYXggZm9yIHNwZWVkIHNlbnNhdGlvbiAod2FzIDcwKQoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogMTAuMCwgLy8gTG9vayBmdXJ0aGVyIGFoZWFkCiAgICAgICAgICAgICAgICBsb29rQWhlYWRTbW9vdGhpbmc6IDQuMCwKCiAgICAgICAgICAgICAgICAvLyBTbWFydCBmcmFtaW5nCiAgICAgICAgICAgICAgICBiYWxsVHJhY2tXZWlnaHQ6IDAuMTUsIAogICAgICAgICAgICAgICAgdGhyZWF0QXdhcmVuZXNzOiB0cnVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBTdGF0ZQogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7IC8vIERpcmVjdCBiYWxsIHJlZmVyZW5jZSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgICAgICB0aGlzLnRhcmdldFZlbCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0SW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIENhbWVyYSBTdGF0ZQogICAgICAgICAgICB0aGlzLnBvcyA9IGNhbWVyYS5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICB0aGlzLmxvb2tBdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gT3JiaXQgU3RhdGUKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gTWF0aC5QSTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLlBJOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IE1hbnVhbCBvcmJpdCBmcm9tIHRvdWNoIChyaWdodCBzaWRlIG9mIHNjcmVlbikKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgICAgIHRoaXMub3JiaXRTZW5zaXRpdml0eSA9IDAuMDA0OwogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJEZWxheSA9IDMuMDsKCi8vIFNoYWtlCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IDA7IC8vIE5FVzogUm90YXRpb25hbCBzaGFrZQp0aGlzLnNoYWtlT2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlID0gMDsKdGhpcy5yb2xsSW1wdWxzZSA9IDA7IC8vIE5FVzogRHluYW1pYyB0aWx0IGZvciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBORVc6IERpcmVjdGlvbmFsIFJlY29pbAp0aGlzLnJlY29pbE9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIE5FVzogRGlyZWN0aW9uYWwgUmVjb2lsCiAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOyAvLyBORVc6IENocm9tYXRpYyBBYmVycmF0aW9uIEtpY2sKICAgICAgICAgICAgLy8gQ2luZW1hdGljIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSAnZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1N0YXJ0TG9vayA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljRW5kUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBEeW5hbWljIHB1bGwtYmFjayBiYXNlZCBvbiBhY3Rpb24KICAgICAgICAgICAgdGhpcy5jdXJyZW50UHVsbEJhY2sgPSAwOwogICAgICAgICAgICB0aGlzLm1heFB1bGxCYWNrID0gODsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0IGJhbGwgcmVmZXJlbmNlIGZvciBzbWFydCBmcmFtaW5nCiAgICAgICAgc2V0QmFsbChiYWxsKSB7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IGJhbGw7CiAgICAgICAgfQoKICAgICAgICAvLyBJTVBST1ZFRDogR2V0IGNhbWVyYS1yZWxhdGl2ZSBpbnB1dCB0cmFuc2Zvcm1hdGlvbgogICAgICAgIGdldENhbWVyYVJlbGF0aXZlSW5wdXQoaW5wdXRYLCBpbnB1dFopIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIF9jYW1Gd2QpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgLy8gVHJhbnNmb3JtIGlucHV0IHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChpbnB1dFggKiBfY2FtUmlnaHQueCkgKyAoaW5wdXRaICogX2NhbUZ3ZC54KTsKICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKGlucHV0WCAqIF9jYW1SaWdodC56KSArIChpbnB1dFogKiBfY2FtRndkLnopOwoKICAgICAgICAgICAgcmV0dXJuIHsgeDogd29ybGRYLCB6OiB3b3JsZFogfTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogTWFudWFsIG9yYml0IGlucHV0IGZyb20gdG91Y2gKICAgICAgICBoYW5kbGVPcmJpdElucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICs9IGR4ICogdGhpcy5vcmJpdFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKz0gZHkgKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgKiAwLjU7CgogICAgICAgICAgICAvLyBDbGFtcCBwaXRjaAogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSBNYXRoLm1heCgtMC4zLCBNYXRoLm1pbigwLjUsIHRoaXMubWFudWFsT3JiaXRQaXRjaCkpOwoKICAgICAgICAgICAgLy8gUmVzZXQgYXV0by1yZWNlbnRlciB0aW1lcgogICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogUmVjZW50ZXIgY2FtZXJhCiAgICAgICAgcmVjZW50ZXIoKSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgIH0KCiAgICAgICAgcGxheUNpbmVtYXRpYyh0eXBlLCB0YXJnZXQsIGR1cmF0aW9uID0gMS41KSB7CiAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUeXBlID0gdHlwZTsKCiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRQb3MuY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rLmNvcHkodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRGb3ZJbXB1bHNlKC0xNSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlQ2luZW1hdGljKGR0KSB7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oMS4wLCB0aGlzLmNpbmVtYXRpY1RpbWVyIC8gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbik7CgogICAgICAgICAgICBjb25zdCB0ID0gMSAtIE1hdGgucG93KDEgLSBwcm9ncmVzcywgMyk7CgogICAgICAgICAgICBsZXQgYWN0aXZlVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CiAgICAgICAgICAgIGxldCBpc0JhbGxUcmFja2luZyA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoICYmIGJhbGwuc3RhdGUgPT09ICdmcmVlJyAmJiBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAyLjApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGJhbGwubWVzaDsKICAgICAgICAgICAgICAgIGlzQmFsbFRyYWNraW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZlVGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGVuZExvb2sgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKICAgICAgICAgICAgbGV0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIGxldCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAoaXNCYWxsVHJhY2tpbmcpIHsKICAgICAgICAgICAgICAgIGVuZExvb2suYWRkU2NhbGVkVmVjdG9yKGJhbGwudmVsb2NpdHksIDAuMyk7CgogICAgICAgICAgICAgICAgZndkLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBmd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAxKSBmd2Quc2V0KDAsMCwxKTsKICAgICAgICAgICAgICAgIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICByaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kTG9vay55ICs9IDEuNTsKICAgICAgICAgICAgICAgIGZ3ZC5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGFjdGl2ZVRhcmdldC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHJpZ2h0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBfdGFyZ2V0V29ybGRQb3MuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdqZWNodCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDMuMCkpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ3NwaGVyZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE2LjAgOiAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gMTAuMDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNpbmVtYXRpY1R5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0ICogMC41KS5hZGQocmlnaHQuY2xvbmUoKS5tdWx0aXBseVNjYWxhcihkaXN0KSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA1LjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gaXNCYWxsVHJhY2tpbmcgPyAxNC4wIDogMTAuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ3ZC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC1kaXN0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wb3MubGVycChlbmRQb3MsIGR0ICogNC4wKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQubGVycChlbmRMb29rLCBkdCAqIDYuMCk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNpbmVtYXRpY1RpbWVyID49IHRoaXMuY2luZW1hdGljRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNDaW5lbWF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldFRhcmdldChtZXNoLCB2ZWxvY2l0eSwgaW5wdXQsIGlzQWltaW5nID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBtZXNoOwogICAgICAgICAgICBpZiAodmVsb2NpdHkpIHRoaXMudGFyZ2V0VmVsLmNvcHkodmVsb2NpdHkpOwogICAgICAgICAgICBpZiAoaW5wdXQpIHRoaXMudGFyZ2V0SW5wdXQuY29weShpbnB1dCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy50YXJnZXRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuaXNBaW1pbmcgPSBpc0FpbWluZzsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgZm9yIGNvbXBhdGliaWxpdHkKICAgICAgICBoYW5kbGVJbnB1dChkeCwgZHkpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVPcmJpdElucHV0KGR4LCBkeSk7CiAgICAgICAgfQoKICAgICAgICBnZXRZYXcoKSB7IHJldHVybiB0aGlzLmN1cnJlbnRZYXc7IH0KCiAgICAgICAgYWRkU2hha2UoYW1vdW50KSB7CgogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gTWF0aC5taW4odGhpcy5zaGFrZUludGVuc2l0eSArIGFtb3VudCwgNC4wKTsgLy8gSW5jcmVhc2VkIGNhcAogICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCA9IE1hdGgubWluKHRoaXMuc2hha2VSb2xsICsgYW1vdW50ICogMC4yLCAwLjgpOyAvLyBBZGQgcm9sbAogICAgICAgIH0KICAgICAgICBhZGRGb3ZJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmZvdkltcHVsc2UgPSBNYXRoLm1pbih0aGlzLmZvdkltcHVsc2UgKyBhbW91bnQsIDMwKTsKCiAgICAgICAgfQogICAgICAgIGFkZFJvbGxJbXB1bHNlKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICs9IGFtb3VudDsKdGhpcy5yb2xsSW1wdWxzZSA9IE1hdGgubWF4KC0wLjUsIE1hdGgubWluKDAuNSwgdGhpcy5yb2xsSW1wdWxzZSkpOwogICAgICAgIH0KCmFkZFJlY29pbCh4LCB5LCB6KSB7CiAgICAgICAgICAgIHRoaXMucmVjb2lsT2Zmc2V0LnggKz0geDsKICAgICAgICAgICAgdGhpcy5yZWNvaWxPZmZzZXQueSArPSB5OwogICAgICAgICAgICB0aGlzLnJlY29pbE9mZnNldC56ICs9IHo7CiAgICAgICAgfQoKICAgICAgICBhZGRBYmVycmF0aW9uKGFtb3VudCkgewogICAgICAgICAgICB0aGlzLmFiZXJyYXRpb25JbXB1bHNlID0gTWF0aC5tYXgodGhpcy5hYmVycmF0aW9uSW1wdWxzZSwgYW1vdW50KTsKICAgICAgICB9CgpzbmFwVG9UYXJnZXQoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlSWRlYWxTdGF0ZSgwKTsKCiAgICAgICAgICAgIHRoaXMucG9zLmNvcHkoX2lkZWFsUG9zKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQuY29weShfaWRlYWxMb29rKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gdGhpcy50YXJnZXRZYXc7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQuc2V0KDAsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2luZW1hdGljKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaW5lbWF0aWMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzYWZlRHQgPSBNYXRoLm1pbihkdCwgMC4wNSk7CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXV0by1yZWNlbnRlciBsb2dpYyAoT25seSBpZiBub3QgYWltaW5nKQogICAgICAgICAgICBpZiAoIXRoaXMuaXNBaW1pbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgKz0gc2FmZUR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPiB0aGlzLmF1dG9SZWNlbnRlckRlbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZW50ZXJTcGVlZCA9IDIuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0WWF3ICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKj0gKDEuMCAtIHJlY2VudGVyU3BlZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJTVBST1ZFRDogU21hcnQgcHVsbC1iYWNrIGJhc2VkIG9uIGJhbGwgc3BlZWQKICAgICAgICAgICAgaWYgKHRoaXMuYmFsbCAmJiB0aGlzLmJhbGwudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IHRoaXMuYmFsbC52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFB1bGxCYWNrID0gTWF0aC5taW4odGhpcy5tYXhQdWxsQmFjaywgYmFsbFNwZWVkICogMC4zKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICs9ICh0YXJnZXRQdWxsQmFjayAtIHRoaXMuY3VycmVudFB1bGxCYWNrKSAqIHNhZmVEdCAqIDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFB1bGxCYWNrICo9ICgxLjAgLSBzYWZlRHQgKiAyLjApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAxLiBVcGRhdGUgVGFyZ2V0IEluZm8KICAgICAgICAgICAgdGhpcy50YXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoc2FmZUR0KTsKCiAgICAgICAgICAgIC8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKLy8gMy4gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAvLyBEeW5hbWljIGZvbGxvdyBzcGVlZCBiYXNlZCBvbiBkaXN0YW5jZSBlcnJvciAoQ2F0Y2gtdXAgbG9naWMpCiAgICAgICAgICAgIGNvbnN0IGRpc3RFcnJvciA9IHRoaXMucG9zLmRpc3RhbmNlVG8oX2lkZWFsUG9zKTsKICAgICAgICAgICAgY29uc3QgZHluYW1pY0ZvbGxvdyA9IHRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICsgKGRpc3RFcnJvciAqIDAuMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZE11bHQgPSB0aGlzLmlzQWltaW5nID8gMi4wIDogMS4wOwogICAgICAgICAgICBjb25zdCBsb29rRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmxvb2tTcGVlZCAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC1keW5hbWljRm9sbG93ICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCnRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwp0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZWNvaWwgRGVjYXkKdGhpcy5yZWNvaWxPZmZzZXQubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDguMCAqIHNhZmVEdCkpKTsKCiAgICAgICAgICAgIC8vIEFiZXJyYXRpb24gRGVjYXkgJiBBcHBseQogICAgICAgICAgICBpZiAodGhpcy5hYmVycmF0aW9uSW1wdWxzZSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgKj0gTWF0aC5tYXgoMCwgMS4wIC0gKDUuMCAqIHNhZmVEdCkpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPCAwLjEpIHRoaXMuYWJlcnJhdGlvbkltcHVsc2UgPSAwOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgMS41ICsgSW1wdWxzZQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA9IDEuNSArIHRoaXMuYWJlcnJhdGlvbkltcHVsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZykgewogICAgICAgICAgICAgICAgLy8gUmVzZXQgdG8gYmFzZSBpZiBubyBpbXB1bHNlIChhbmQgbm90IGRpcnR5KQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wb3N0UHJvY2Vzc2luZy51bmlmb3Jtcy51QWJlcnJhdGlvbi52YWx1ZSA+IDEuNikgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucG9zdFByb2Nlc3NpbmcudW5pZm9ybXMudUFiZXJyYXRpb24udmFsdWUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjUuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC0xMCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEZvdiA9IHRoaXMuY29uZmlnLmZvdkJhc2UgKyAodGhpcy5jb25maWcuZm92TWF4IC0gdGhpcy5jb25maWcuZm92QmFzZSkgKiB3YXJwICsgdGhpcy5mb3ZJbXB1bHNlICsgYWltWm9vbTsKCiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoNi4wICogc2FmZUR0KSk7CgogICAgICAgICAgICB0aGlzLmNhbWVyYS5mb3YgKz0gKHRhcmdldEZvdiAtIHRoaXMuY2FtZXJhLmZvdikgKiA0LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCi8vIDYuIEFwcGx5IHRvIENhbWVyYQogICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5jb3B5KHRoaXMucG9zKS5hZGQodGhpcy5zaGFrZU9mZnNldCkuYWRkKHRoaXMucmVjb2lsT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCi8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50Ci8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQgJiBQb3J0cmFpdCBBZGp1c3RtZW50CiAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHRoaXMuY2FtZXJhLmFzcGVjdDsKICAgICAgICAgICAgLy8gOToxNiBpcyB+MC41Ni4gV2UgdHJpZ2dlciBhZGp1c3RtZW50IGlmIG5hcnJvd2VyIHRoYW4gc3F1YXJlLgogICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMC44NTsgCiAgICAgICAgICAgIGNvbnN0IHBvcnRyYWl0TXVsdCA9IGlzUG9ydHJhaXQgPyAxLjcgOiAxLjA7IC8vIFB1bGwgYmFjayA3MCUgbW9yZSBpbiBwb3J0cmFpdCB0byBzZWUgdGhlIGZpZWxkCiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9ICh0aGlzLmNvbmZpZy5iYXNlRGlzdGFuY2UgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayArIHRocmVhdFB1bGxiYWNrKSAqIHBvcnRyYWl0TXVsdDsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gKHRoaXMuY29uZmlnLmJhc2VIZWlnaHQgKyB0aGlzLmN1cnJlbnRQdWxsQmFjayAqIDAuMyArIHRocmVhdFB1bGxiYWNrICogMC41ICsgdGhpcy5tYW51YWxPcmJpdFBpdGNoICogMTApICogcG9ydHJhaXRNdWx0OwoKICAgICAgICAgICAgLy8gQmFzZSBvZmZzZXQgKENhbWVyYSB1c3VhbGx5IHNpdHMgYXQgK1ogcmVsYXRpdmUgdG8gdGFyZ2V0KQogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbENhbVggPSBjYW1aICogTWF0aC5zaW4odGhpcy5tYW51YWxPcmJpdFlhdyk7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsQ2FtWiA9IGNhbVogKiBNYXRoLmNvcyh0aGlzLm1hbnVhbE9yYml0WWF3KTsKCiAgICAgICAgICAgIF9pZGVhbFBvcy5zZXQodFBvcy54ICsgZmluYWxDYW1YLCB0UG9zLnkgKyBlZmZlY3RpdmVIZWlnaHQsIHRQb3MueiArIGZpbmFsQ2FtWik7CgogICAgICAgICAgICAvLyBDbGFtcCB0byBhcmVuYSBib3VuZHMgKHJvdWdobHkpIHRvIHByZXZlbnQgY2xpcHBpbmcgdGhyb3VnaCB3YWxscwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPiA0OC4wKSBfaWRlYWxQb3MueiA9IDQ4LjA7CiAgICAgICAgICAgIGlmIChfaWRlYWxQb3MueiA8IC00OC4wKSBfaWRlYWxQb3MueiA9IC00OC4wOwoKICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIElkZWFsIExvb2tBdCB3aXRoIElNUFJPVkVEIGxvb2stYWhlYWQKICAgICAgICAgICAgX2lkZWFsTG9vay5jb3B5KHRQb3MpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFZlbG9jaXR5LWJhc2VkIGxvb2stYWhlYWQKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0VmVsLmxlbmd0aFNxKCkgPiAwLjUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy50YXJnZXRWZWwubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCBsb29rQWhlYWRGYWN0b3IgPSBNYXRoLm1pbigxLjAsIHNwZWVkIC8gMTUuMCkgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWREaXN0YW5jZTsKCiAgICAgICAgICAgICAgICBjb25zdCB2ZWxEaXIgPSB0aGlzLnRhcmdldFZlbC5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgX2xvb2tBaGVhZC5jb3B5KHZlbERpcikubXVsdGlwbHlTY2FsYXIobG9va0FoZWFkRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdGhlIGxvb2stYWhlYWQKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubGVycChfbG9va0FoZWFkLCBkdCAqIHRoaXMuY29uZmlnLmxvb2tBaGVhZFNtb290aGluZyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmFkZCh0aGlzLnNtb290aGVkTG9va0FoZWFkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc21vb3RoZWRMb29rQWhlYWQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZHQgKiAzLjApOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9pZGVhbExvb2sueSAqPSAwLjU7IC8vIExvb2sgc2xpZ2h0bHkgbG93ZXIgdGhhbiBhY3R1YWwgdGFyZ2V0IGhlaWdodAoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEluY2x1ZGUgYmFsbCBpbiBmcmFtaW5nIHdoZW4gbmVhcmJ5CiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLm1lc2ggJiYgdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbFBvcyA9IHRoaXMuYmFsbC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRQb3MuZGlzdGFuY2VUbyhiYWxsUG9zKTsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDI1ICYmIGRpc3RUb0JhbGwgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbFdlaWdodCA9IE1hdGgubWF4KDAsIDEgLSBkaXN0VG9CYWxsIC8gMjUpICogdGhpcy5jb25maWcuYmFsbFRyYWNrV2VpZ2h0OwogICAgICAgICAgICAgICAgICAgIF9pZGVhbExvb2subGVycChiYWxsUG9zLCBiYWxsV2VpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSW5wdXQgQW50aWNpcGF0aW9uIChTbW9vdGhlZCkKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0LmxlcnAodGhpcy50YXJnZXRJbnB1dCwgZHQgKiAzLjApOwoKICAgICAgICAgICAgaWYgKHRoaXMuc21vb3RoZWRJbnB1dC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgX2lkZWFsTG9vay54ICs9IHRoaXMuc21vb3RoZWRJbnB1dC54ICogNC4wOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay56ICs9IHRoaXMuc21vb3RoZWRJbnB1dC56ICogNC4wOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlVGhyZWF0TGV2ZWwoY2VudGVyUG9zKSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlKSByZXR1cm4gMDsKY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lLnRlYW1zKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBkZW5zaXR5ID0gMDsKICAgICAgICAgICAgY29uc3QgY2hlY2tUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZWFtLnBsYXllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gdGVhbS5wbGF5ZXJzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoICE9PSB0aGlzLnRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQoY2VudGVyUG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRTcSA8IDY0LjApIHsgLy8gOG0gcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZW5zaXR5ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2hlY2tUZWFtKGdhbWUudGVhbXMuaG9tZSk7CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmF3YXkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKDEuMCwgZGVuc2l0eSAvIDQuMCk7IC8vIENhcCBhdCA0IHBsYXllcnMKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IGZvcndhcmQgZGlyZWN0aW9uIGZvciBVSSByZWZlcmVuY2UKICAgICAgICBnZXRGb3J3YXJkRGlyZWN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfY2FtRndkLmNsb25lKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCByaWdodCBkaXJlY3Rpb24KICAgICAgICBnZXRSaWdodERpcmVjdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZndkID0gdGhpcy5nZXRGb3J3YXJkRGlyZWN0aW9uKCk7CiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHJldHVybiBfY2FtUmlnaHQuY2xvbmUoKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQ2FtZXJhTWFuYWdlciA9IENhbWVyYU1hbmFnZXI7Cn0pKCk7Cg==","ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKLy8gMTUuIEZpcmUgKE9yYikKICAgIGNvbnN0IF9maXJlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDIwMCwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjIsICdyZ2JhKDI1NSwgMjAwLCAwLCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC42LCAncmdiYSgyNTUsIDUwLCAwLCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMTAwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMTYuIEljZSAoU2hhcmQpCiAgICBjb25zdCBfaWNlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNhYWRkZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCAwKTsKICAgICAgICBjdHgubGluZVRvKDQ4LCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNjQpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAvLyBJbm5lciBnbGludAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oMzIsIDEwKTsKICAgICAgICBjdHgubGluZVRvKDQwLCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTQpOwogICAgICAgIGN0eC5saW5lVG8oMjQsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDE3LiBWb2x0IChTcGFyaykKICAgIGNvbnN0IF92b2x0VGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCA0KTsKICAgICAgICBjdHgubGluZVRvKDE2LCAyNCk7CiAgICAgICAgY3R4LmxpbmVUbyg0OCwgMzIpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDQwKTsKICAgICAgICBjdHgubGluZVRvKDMyLCA2MCk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjYWEwMGZmJzsKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwogICAgICAgICAgICAKLy8gMTcuIFZvbHQgKFNwYXJrKQovLyBEdXBsaWNhdGUgX3ZvbHRUZXggcmVtb3ZlZAoKY2xhc3MgUGFydGljbGVCYXRjaCB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHRleHR1cmUsIG1heFBhcnRpY2xlcywgYmxlbmRpbmcsIGdyaWQpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAwLCAvLyBORVc6IEluZGl2aWR1YWwgcm90YXRpb24gc3BlZWQKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMSwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogMCAvLyBORVc6IFRleHR1cmUgZnJhbWUgaW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHUFUgQnVmZmVycwogICAgICAgICAgICB0aGlzLnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuc2l6ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLm9wYWNpdGllcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyAqIDMpOwogICAgICAgICAgICB0aGlzLmZyYW1lcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsgLy8gTkVXCgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdmcmFtZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5mcmFtZXMsIDEpKTsgLy8gTkVXCgogICAgICAgICAgICAvLyBTaGFkZXIgTWF0ZXJpYWwKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgbWFwOiB7IHZhbHVlOiB0ZXh0dXJlIH0sCiAgICAgICAgICAgICAgICAgICAgdUdyaWQ6IHsgdmFsdWU6IGdyaWQgfHwgbmV3IFRIUkVFLlZlY3RvcjIoMSwgMSkgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBzaXplOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMyBjb2xvcjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIHZPcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgdkNvbG9yID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIHZGcmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVHcmlkOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZGcmFtZTsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSBnbF9Qb2ludENvb3JkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGNlbnRlcmVkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSBjb3ModlJvdGF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcyA9IHNpbih2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHJvdGF0ZWQgPSB2ZWMyKGNlbnRlcmVkLnggKiBjIC0gY2VudGVyZWQueSAqIHMsIGNlbnRlcmVkLnggKiBzICsgY2VudGVyZWQueSAqIGMpICsgMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXRsYXMgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnggPSBtb2QodkZyYW1lLCB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnkgPSBmbG9vcih2RnJhbWUgLyB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCB0byBncmlkIGNlbGwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RhbmRhcmQgVVYgKDAsMCBib3R0b20tbGVmdCkuIFdlIGFzc3VtZSByb3cgMCBpcyB0b3AuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZsaXAgcm93IGluZGV4IGZvciBHTCBjb29yZHMgaWYgbmVlZGVkLCBidXQgbGV0J3MgYXNzdW1lIHN0YW5kYXJkIGdyaWQgb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdyAwID0gVG9wIChIaWdoIFYpLCBSb3cgMSA9IEJvdHRvbSAoTG93IFYpLgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ2xSb3cgPSAodUdyaWQueSAtIDEuMCkgLSBmeTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VsbFVWID0gcm90YXRlZCAvIHVHcmlkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIG9mZnNldCA9IHZlYzIoZnggLyB1R3JpZC54LCBnbFJvdyAvIHVHcmlkLnkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXggPSB0ZXh0dXJlMkQobWFwLCBjZWxsVVYgKyBvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCh0ZXgucmdiICogdkNvbG9yLCB0ZXguYSAqIHZPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBibGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICBzY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvZ2ljIGhvb2sKICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBzcGF3bihwb3MsIG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gRmluZCBmaXJzdCBpbmFjdGl2ZQogICAgICAgICAgICBsZXQgcCA9IG51bGw7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLnBhcnRpY2xlc1tpXS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOyAvLyBQb29sIGZ1bGwKCiAgICAgICAgICAgIHAuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgcC5wb3MuY29weShwb3MpOwogICAgICAgICAgICBwLmxpZmUgPSBvcHRpb25zLmxpZmUgfHwgMS4wOwogICAgICAgICAgICBwLm1heExpZmUgPSBwLmxpZmU7CiAgICAgICAgICAgIHAuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICBwLnJvdGF0aW9uID0gb3B0aW9ucy5yb3RhdGlvbiB8fCAwOwogICAgICAgICAgICBwLnJvdGF0aW9uU3BlZWQgPSBvcHRpb25zLnJvdGF0aW9uU3BlZWQgfHwgMDsgLy8gTkVXCiAgICAgICAgICAgIHAudmVsLmNvcHkob3B0aW9ucy52ZWxvY2l0eSB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgcC5ncmF2aXR5ID0gb3B0aW9ucy5ncmF2aXR5IHx8IDA7CiAgICAgICAgICAgIHAuZHJhZyA9IG9wdGlvbnMuZHJhZyB8fCAwOwogICAgICAgICAgICBpZiAob3B0aW9ucy5jb2xvcikgcC5jb2xvci5zZXQob3B0aW9ucy5jb2xvcik7CiAgICAgICAgICAgIGVsc2UgcC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwogICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgIHAuZnJhbWUgPSBvcHRpb25zLmZyYW1lIHx8IDA7IC8vIE5FVwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGxldCBhY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eSBjaGVjayBmb3IgTmFOIGxpZmUKICAgICAgICAgICAgICAgIGlmIChpc05hTihwLmxpZmUpKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWlsc2FmZTogRm9yY2Uga2lsbCBpZiBsaWZlIGlzIE5hTiBvciB1bnJlYXNvbmFibHkgaGlnaCAoc3R1Y2sgcGFydGljbGUpCiAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocC5saWZlKSB8fCBwLmxpZmUgPiAxMC4wKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CiAgICAgICAgICAgICAgICBwLnBvcy5hZGRTY2FsZWRWZWN0b3IocC52ZWwsIGR0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gcC5yb3RhdGlvblNwZWVkICogZHQ7IC8vIEFwcGx5IHJvdGF0aW9uIHNwZWVkCgogICAgICAgICAgICAgICAgLy8gTG9naWMKY29uc3QgdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEuMCwgMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZUxvZ2ljKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyhwLCB0LCBkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJ1ZmZlcnMKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqM10gPSBwLnBvcy54OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzFdID0gcC5wb3MueTsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysyXSA9IHAucG9zLno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSBwLnNjYWxlOwogICAgICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnNbaV0gPSBwLnJvdGF0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5vcGFjaXRpZXNbaV0gPSBwLm9wYWNpdHk7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lc1tpXSA9IHAuZnJhbWU7IC8vIFVwZGF0ZSBmcmFtZSBidWZmZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozXSA9IHAuY29sb3IucjsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysxXSA9IHAuY29sb3IuZzsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysyXSA9IHAuY29sb3IuYjsKCiAgICAgICAgICAgICAgICBhY3RpdmVDb3VudCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWN0aXZlQ291bnQgPiAwIHx8IHRoaXMuYWN0aXZlQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5zaXplLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKLy8gSW5pdGlhbGl6ZSBCYXRjaGVzIChPcHRpbWl6ZWQgQ291bnRzKQp0aGlzLl9jcmVhdGVCYXRjaCgndmVub20nLCBfdmVub21UZXgsIDEwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy55KSAqIDAuMDU7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCduYXAnLCBfbmFwVGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiA1KSAqIDAuMDI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3dpdGhlcicsIF93aXRoZXJUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCA1LCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnZmxhc2gnLCBfZmxhc2hUZXgsIDMwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OyAvLyBFeHBsaWNpdCBmYWRlIG91dAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZpcmUnLCBfZmlyZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAyLjA7IC8vIFJpc2UKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gNS4wICogdDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnaWNlJywgX2ljZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IHAucm90YXRpb25TcGVlZCAqIDAuMTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgndm9sdCcsIF92b2x0VGV4LCAyMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBGbGlja2VyIHNpemUKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGgucmFuZG9tKCk7IC8vIEZsaWNrZXIgb3BhY2l0eQogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsgLy8gSml0dGVyIHJvdGF0aW9uCiAgICAgICAgICAgIH0pOwp0aGlzLl9jcmVhdGVCYXRjaCgnc2hhcmQnLCBfZGVicmlzVGV4LCA1MDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOwogICAgICAgICAgICAvLyAtLS0gSEVSQ1VMRUFOIFRBQ0tMRSBGWCAtLS0KICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2dhdGhlcicsIF9mbGFzaFRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXMgc3Vja2luZyBpbgogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBGYWRlIGluL291dAogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgwLjIgKyB0ICogMC44KTsgLy8gU2hyaW5rIGFzIHRoZXkgZGllICh0IGdvZXMgMS0+MD8gTm8sIHQgaXMgMS4wIC0gbGlmZS9tYXhMaWZlLiBXYWl0LgogICAgICAgICAgICAgICAgLy8gSW4gdXBkYXRlKCksIHQgPSAxLjAgLSAocC5saWZlIC8gcC5tYXhMaWZlKS4gU28gdCBnb2VzIDAgLT4gMS4KICAgICAgICAgICAgICAgIC8vIEFjdHVhbGx5IGxldCdzIGNoZWNrIHVwZGF0ZSgpOiBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICAvLyBZZXMsIHQgZ29lcyAwIHRvIDEuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGdhdGhlciBwYXJ0aWNsZXMgdG8gc3RhcnQgZmFyIGFuZCBtb3ZlIGluLiBQaHlzaWNzIGhhbmRsZXMgcG9zLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0aGVtIHRvIHNocmluayBhcyB0aGV5IHJlYWNoIGNlbnRlcj8KICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCAqIDAuNSk7IAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2ltcGFjdF9zaGFyZCcsIF9kZWJyaXNUZXgsIDEwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOyAvLyBTaHJpbmsgb3ZlciB0aW1lCiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCiAgICAgICAgfQoKX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYywgZ3JpZCkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBncmlkKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgYmFzZSB2ZWxvY2l0eSBmcm9tIG9wdGlvbnMgb3IgemVybwogICAgICAgICAgICAgICAgbGV0IGJhc2VWZWwgPSAob3B0cy52ZWxvY2l0eSkgPyBvcHRzLnZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuMyArIE1hdGgucmFuZG9tKCkgKiAwLjI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZHJhZyA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvblNwZWVkID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAuMDsgLy8gUmFuZG9tIHNwaW4KICAgICAgICAgICAgICAgICAgICBvcHRzLmZyYW1lID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCk7IC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmxpbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuODsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC42OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaGFzdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmaXJlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wICsgTWF0aC5yYW5kb20oKSwgKE1hdGgucmFuZG9tKCktMC41KSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaWNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAndm9sdCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMywgKE1hdGgucmFuZG9tKCktMC41KSozLCAoTWF0aC5yYW5kb20oKS0wLjUpKjMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIC0tLSBNT01FTlRVTSBJTkhFUklUQU5DRSAtLS0KICAgICAgICAgICAgICAgIGlmIChvcHRzLmVtaXR0ZXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vbWVudHVtU2NhbGUgPSAob3B0cy5tb21lbnR1bVNjYWxlICE9PSB1bmRlZmluZWQpID8gb3B0cy5tb21lbnR1bVNjYWxlIDogMC4yOwogICAgICAgICAgICAgICAgICAgIGlmIChtb21lbnR1bVNjYWxlICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkU2NhbGVkVmVjdG9yKG9wdHMuZW1pdHRlclZlbG9jaXR5LCBtb21lbnR1bVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IGJhc2VWZWw7CgogICAgICAgICAgICAgICAgYmF0Y2guc3Bhd24ocG9zLCBvcHRzKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","./ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKLy8gMTUuIEZpcmUgKE9yYikKICAgIGNvbnN0IF9maXJlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDIwMCwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjIsICdyZ2JhKDI1NSwgMjAwLCAwLCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC42LCAncmdiYSgyNTUsIDUwLCAwLCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMTAwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMTYuIEljZSAoU2hhcmQpCiAgICBjb25zdCBfaWNlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNhYWRkZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCAwKTsKICAgICAgICBjdHgubGluZVRvKDQ4LCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNjQpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAvLyBJbm5lciBnbGludAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oMzIsIDEwKTsKICAgICAgICBjdHgubGluZVRvKDQwLCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTQpOwogICAgICAgIGN0eC5saW5lVG8oMjQsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDE3LiBWb2x0IChTcGFyaykKICAgIGNvbnN0IF92b2x0VGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCA0KTsKICAgICAgICBjdHgubGluZVRvKDE2LCAyNCk7CiAgICAgICAgY3R4LmxpbmVUbyg0OCwgMzIpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDQwKTsKICAgICAgICBjdHgubGluZVRvKDMyLCA2MCk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjYWEwMGZmJzsKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwogICAgICAgICAgICAKLy8gMTcuIFZvbHQgKFNwYXJrKQovLyBEdXBsaWNhdGUgX3ZvbHRUZXggcmVtb3ZlZAoKY2xhc3MgUGFydGljbGVCYXRjaCB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHRleHR1cmUsIG1heFBhcnRpY2xlcywgYmxlbmRpbmcsIGdyaWQpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAwLCAvLyBORVc6IEluZGl2aWR1YWwgcm90YXRpb24gc3BlZWQKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMSwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogMCAvLyBORVc6IFRleHR1cmUgZnJhbWUgaW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHUFUgQnVmZmVycwogICAgICAgICAgICB0aGlzLnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuc2l6ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLm9wYWNpdGllcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyAqIDMpOwogICAgICAgICAgICB0aGlzLmZyYW1lcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsgLy8gTkVXCgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdmcmFtZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5mcmFtZXMsIDEpKTsgLy8gTkVXCgogICAgICAgICAgICAvLyBTaGFkZXIgTWF0ZXJpYWwKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgbWFwOiB7IHZhbHVlOiB0ZXh0dXJlIH0sCiAgICAgICAgICAgICAgICAgICAgdUdyaWQ6IHsgdmFsdWU6IGdyaWQgfHwgbmV3IFRIUkVFLlZlY3RvcjIoMSwgMSkgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBzaXplOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMyBjb2xvcjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIHZPcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgdkNvbG9yID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIHZGcmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVHcmlkOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZGcmFtZTsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSBnbF9Qb2ludENvb3JkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGNlbnRlcmVkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSBjb3ModlJvdGF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcyA9IHNpbih2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHJvdGF0ZWQgPSB2ZWMyKGNlbnRlcmVkLnggKiBjIC0gY2VudGVyZWQueSAqIHMsIGNlbnRlcmVkLnggKiBzICsgY2VudGVyZWQueSAqIGMpICsgMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXRsYXMgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnggPSBtb2QodkZyYW1lLCB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnkgPSBmbG9vcih2RnJhbWUgLyB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCB0byBncmlkIGNlbGwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RhbmRhcmQgVVYgKDAsMCBib3R0b20tbGVmdCkuIFdlIGFzc3VtZSByb3cgMCBpcyB0b3AuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZsaXAgcm93IGluZGV4IGZvciBHTCBjb29yZHMgaWYgbmVlZGVkLCBidXQgbGV0J3MgYXNzdW1lIHN0YW5kYXJkIGdyaWQgb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdyAwID0gVG9wIChIaWdoIFYpLCBSb3cgMSA9IEJvdHRvbSAoTG93IFYpLgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ2xSb3cgPSAodUdyaWQueSAtIDEuMCkgLSBmeTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VsbFVWID0gcm90YXRlZCAvIHVHcmlkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIG9mZnNldCA9IHZlYzIoZnggLyB1R3JpZC54LCBnbFJvdyAvIHVHcmlkLnkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXggPSB0ZXh0dXJlMkQobWFwLCBjZWxsVVYgKyBvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCh0ZXgucmdiICogdkNvbG9yLCB0ZXguYSAqIHZPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBibGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICBzY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvZ2ljIGhvb2sKICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBzcGF3bihwb3MsIG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gRmluZCBmaXJzdCBpbmFjdGl2ZQogICAgICAgICAgICBsZXQgcCA9IG51bGw7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLnBhcnRpY2xlc1tpXS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOyAvLyBQb29sIGZ1bGwKCiAgICAgICAgICAgIHAuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgcC5wb3MuY29weShwb3MpOwogICAgICAgICAgICBwLmxpZmUgPSBvcHRpb25zLmxpZmUgfHwgMS4wOwogICAgICAgICAgICBwLm1heExpZmUgPSBwLmxpZmU7CiAgICAgICAgICAgIHAuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICBwLnJvdGF0aW9uID0gb3B0aW9ucy5yb3RhdGlvbiB8fCAwOwogICAgICAgICAgICBwLnJvdGF0aW9uU3BlZWQgPSBvcHRpb25zLnJvdGF0aW9uU3BlZWQgfHwgMDsgLy8gTkVXCiAgICAgICAgICAgIHAudmVsLmNvcHkob3B0aW9ucy52ZWxvY2l0eSB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgcC5ncmF2aXR5ID0gb3B0aW9ucy5ncmF2aXR5IHx8IDA7CiAgICAgICAgICAgIHAuZHJhZyA9IG9wdGlvbnMuZHJhZyB8fCAwOwogICAgICAgICAgICBpZiAob3B0aW9ucy5jb2xvcikgcC5jb2xvci5zZXQob3B0aW9ucy5jb2xvcik7CiAgICAgICAgICAgIGVsc2UgcC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwogICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgIHAuZnJhbWUgPSBvcHRpb25zLmZyYW1lIHx8IDA7IC8vIE5FVwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGxldCBhY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eSBjaGVjayBmb3IgTmFOIGxpZmUKICAgICAgICAgICAgICAgIGlmIChpc05hTihwLmxpZmUpKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWlsc2FmZTogRm9yY2Uga2lsbCBpZiBsaWZlIGlzIE5hTiBvciB1bnJlYXNvbmFibHkgaGlnaCAoc3R1Y2sgcGFydGljbGUpCiAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocC5saWZlKSB8fCBwLmxpZmUgPiAxMC4wKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CiAgICAgICAgICAgICAgICBwLnBvcy5hZGRTY2FsZWRWZWN0b3IocC52ZWwsIGR0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gcC5yb3RhdGlvblNwZWVkICogZHQ7IC8vIEFwcGx5IHJvdGF0aW9uIHNwZWVkCgogICAgICAgICAgICAgICAgLy8gTG9naWMKY29uc3QgdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEuMCwgMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZUxvZ2ljKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyhwLCB0LCBkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJ1ZmZlcnMKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqM10gPSBwLnBvcy54OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzFdID0gcC5wb3MueTsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysyXSA9IHAucG9zLno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSBwLnNjYWxlOwogICAgICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnNbaV0gPSBwLnJvdGF0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5vcGFjaXRpZXNbaV0gPSBwLm9wYWNpdHk7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lc1tpXSA9IHAuZnJhbWU7IC8vIFVwZGF0ZSBmcmFtZSBidWZmZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozXSA9IHAuY29sb3IucjsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysxXSA9IHAuY29sb3IuZzsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysyXSA9IHAuY29sb3IuYjsKCiAgICAgICAgICAgICAgICBhY3RpdmVDb3VudCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWN0aXZlQ291bnQgPiAwIHx8IHRoaXMuYWN0aXZlQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5zaXplLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKLy8gSW5pdGlhbGl6ZSBCYXRjaGVzIChPcHRpbWl6ZWQgQ291bnRzKQp0aGlzLl9jcmVhdGVCYXRjaCgndmVub20nLCBfdmVub21UZXgsIDEwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy55KSAqIDAuMDU7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCduYXAnLCBfbmFwVGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiA1KSAqIDAuMDI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3dpdGhlcicsIF93aXRoZXJUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCA1LCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnZmxhc2gnLCBfZmxhc2hUZXgsIDMwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OyAvLyBFeHBsaWNpdCBmYWRlIG91dAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZpcmUnLCBfZmlyZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAyLjA7IC8vIFJpc2UKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gNS4wICogdDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnaWNlJywgX2ljZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IHAucm90YXRpb25TcGVlZCAqIDAuMTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgndm9sdCcsIF92b2x0VGV4LCAyMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBGbGlja2VyIHNpemUKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGgucmFuZG9tKCk7IC8vIEZsaWNrZXIgb3BhY2l0eQogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsgLy8gSml0dGVyIHJvdGF0aW9uCiAgICAgICAgICAgIH0pOwp0aGlzLl9jcmVhdGVCYXRjaCgnc2hhcmQnLCBfZGVicmlzVGV4LCA1MDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOwogICAgICAgICAgICAvLyAtLS0gSEVSQ1VMRUFOIFRBQ0tMRSBGWCAtLS0KICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2dhdGhlcicsIF9mbGFzaFRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXMgc3Vja2luZyBpbgogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBGYWRlIGluL291dAogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgwLjIgKyB0ICogMC44KTsgLy8gU2hyaW5rIGFzIHRoZXkgZGllICh0IGdvZXMgMS0+MD8gTm8sIHQgaXMgMS4wIC0gbGlmZS9tYXhMaWZlLiBXYWl0LgogICAgICAgICAgICAgICAgLy8gSW4gdXBkYXRlKCksIHQgPSAxLjAgLSAocC5saWZlIC8gcC5tYXhMaWZlKS4gU28gdCBnb2VzIDAgLT4gMS4KICAgICAgICAgICAgICAgIC8vIEFjdHVhbGx5IGxldCdzIGNoZWNrIHVwZGF0ZSgpOiBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICAvLyBZZXMsIHQgZ29lcyAwIHRvIDEuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGdhdGhlciBwYXJ0aWNsZXMgdG8gc3RhcnQgZmFyIGFuZCBtb3ZlIGluLiBQaHlzaWNzIGhhbmRsZXMgcG9zLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0aGVtIHRvIHNocmluayBhcyB0aGV5IHJlYWNoIGNlbnRlcj8KICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCAqIDAuNSk7IAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2ltcGFjdF9zaGFyZCcsIF9kZWJyaXNUZXgsIDEwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOyAvLyBTaHJpbmsgb3ZlciB0aW1lCiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCiAgICAgICAgfQoKX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYywgZ3JpZCkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBncmlkKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgYmFzZSB2ZWxvY2l0eSBmcm9tIG9wdGlvbnMgb3IgemVybwogICAgICAgICAgICAgICAgbGV0IGJhc2VWZWwgPSAob3B0cy52ZWxvY2l0eSkgPyBvcHRzLnZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuMyArIE1hdGgucmFuZG9tKCkgKiAwLjI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZHJhZyA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvblNwZWVkID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAuMDsgLy8gUmFuZG9tIHNwaW4KICAgICAgICAgICAgICAgICAgICBvcHRzLmZyYW1lID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCk7IC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmxpbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuODsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC42OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaGFzdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmaXJlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wICsgTWF0aC5yYW5kb20oKSwgKE1hdGgucmFuZG9tKCktMC41KSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaWNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAndm9sdCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMywgKE1hdGgucmFuZG9tKCktMC41KSozLCAoTWF0aC5yYW5kb20oKS0wLjUpKjMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIC0tLSBNT01FTlRVTSBJTkhFUklUQU5DRSAtLS0KICAgICAgICAgICAgICAgIGlmIChvcHRzLmVtaXR0ZXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vbWVudHVtU2NhbGUgPSAob3B0cy5tb21lbnR1bVNjYWxlICE9PSB1bmRlZmluZWQpID8gb3B0cy5tb21lbnR1bVNjYWxlIDogMC4yOwogICAgICAgICAgICAgICAgICAgIGlmIChtb21lbnR1bVNjYWxlICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkU2NhbGVkVmVjdG9yKG9wdHMuZW1pdHRlclZlbG9jaXR5LCBtb21lbnR1bVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IGJhc2VWZWw7CgogICAgICAgICAgICAgICAgYmF0Y2guc3Bhd24ocG9zLCBvcHRzKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","/ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgovLyA2LiBEZWJyaXMgU2hhcmQgKEF0bGFzIDJ4MikKICAgIGNvbnN0IF9kZWJyaXNUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMTI4OyBjLmhlaWdodCA9IDEyODsgLy8gNjR4NjQgc2xvdHMKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAKICAgICAgICBjb25zdCBkcmF3UG9seSA9IChveCwgb3ksIHB0cykgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKG94LCBveSk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwdHNbMF1bMF0sIHB0c1swXVsxXSk7CiAgICAgICAgICAgIGZvcihsZXQgaT0xOyBpPHB0cy5sZW5ndGg7IGkrKykgY3R4LmxpbmVUbyhwdHNbaV1bMF0sIHB0c1tpXVsxXSk7CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBTbG90IDA6IEphZ2dlZAogICAgICAgIGRyYXdQb2x5KDAsIDAsIFtbMzIsIDVdLCBbNTAsIDYwXSwgWzIwLCA0NV0sIFsxMCwgNTVdLCBbNSwgMTBdXSk7CiAgICAgICAgLy8gU2xvdCAxOiBUcmlhbmdsZQogICAgICAgIGRyYXdQb2x5KDY0LCAwLCBbWzMyLCA1XSwgWzYwLCA2MF0sIFs1LCA1MF1dKTsKICAgICAgICAvLyBTbG90IDI6IENodW5rCiAgICAgICAgZHJhd1BvbHkoMCwgNjQsIFtbMTAsIDEwXSwgWzU1LCAxNV0sIFs1MCwgNTBdLCBbMTUsIDU1XV0pOwogICAgICAgIC8vIFNsb3QgMzogU2xpdmVyCiAgICAgICAgZHJhd1BvbHkoNjQsIDY0LCBbWzIwLCA1XSwgWzQwLCA2MF0sIFszMCwgMjBdXSk7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCA2NCwgNjQpOwoKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAyOCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSknKTsgCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC4zLCAncmdiYSgyMDAsIDI0MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguYXJjKDIwLCAyMCwgNCwgMCwgTWF0aC5QSSAqIDIpOyAKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gOC4gTWljcm8gQnViYmxlIChOZXc6IFNoYXJwLCBoaWdoLXZpcyBjYXZpdGF0aW9uKQogICAgY29uc3QgX21pY3JvQnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoU3F1YXJlIGZvciBQb2ludHMpCiAgICBjb25zdCBfZGFzaFN0cmVhbVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBhIHN0cmVhayBpbiB0aGUgbWlkZGxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCA2NCwgMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDI4LCA2NCwgOCk7IC8vIENlbnRlcmVkIHZlcnRpY2FsbHkKICAgICAgICAKcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxMC4gQmxpbmQgKERhcmsgQ2xvdWQpCiAgICBjb25zdCBfYmxpbmRUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMTYsIDE2LCAwLCAxNiwgMTYsIDE2KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMCwgMjAsIDIwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDExLiBTaWxlbmNlIChNdXRlIFgpCiAgICBjb25zdCBfc2lsZW5jZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmZjAwZmYnOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDgsIDgpOyBjdHgubGluZVRvKDI0LCAyNCk7CiAgICAgICAgY3R4Lm1vdmVUbygyNCwgOCk7IGN0eC5saW5lVG8oOCwgMjQpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEyLiBTaGllbGQgKFJpbmcpCiAgICBjb25zdCBfc2hpZWxkVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzAwZmZmZic7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTIsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDEzLiBIYXN0ZSAoQXJyb3cpCiAgICBjb25zdCBfaGFzdGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oOCwgMjQpOyBjdHgubGluZVRvKDE2LCA4KTsgY3R4LmxpbmVUbygyNCwgMjQpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyAxNC4gU2xvdyAoU3F1YXJlKQogICAgY29uc3QgX3Nsb3dUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzg4ODg4OCc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDgsIDgsIDE2LCAxNik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKLy8gMTUuIEZpcmUgKE9yYikKICAgIGNvbnN0IF9maXJlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDIwMCwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjIsICdyZ2JhKDI1NSwgMjAwLCAwLCAwLjgpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC42LCAncmdiYSgyNTUsIDUwLCAwLCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMTAwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMTYuIEljZSAoU2hhcmQpCiAgICBjb25zdCBfaWNlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNhYWRkZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCAwKTsKICAgICAgICBjdHgubGluZVRvKDQ4LCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNjQpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAvLyBJbm5lciBnbGludAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oMzIsIDEwKTsKICAgICAgICBjdHgubGluZVRvKDQwLCAzMik7CiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTQpOwogICAgICAgIGN0eC5saW5lVG8oMjQsIDMyKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDE3LiBWb2x0IChTcGFyaykKICAgIGNvbnN0IF92b2x0VGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnI2ZmZmYwMCc7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDMyLCA0KTsKICAgICAgICBjdHgubGluZVRvKDE2LCAyNCk7CiAgICAgICAgY3R4LmxpbmVUbyg0OCwgMzIpOwogICAgICAgIGN0eC5saW5lVG8oMTYsIDQwKTsKICAgICAgICBjdHgubGluZVRvKDMyLCA2MCk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICcjYWEwMGZmJzsKICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwogICAgICAgICAgICAKLy8gMTcuIFZvbHQgKFNwYXJrKQovLyBEdXBsaWNhdGUgX3ZvbHRUZXggcmVtb3ZlZAoKY2xhc3MgUGFydGljbGVCYXRjaCB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHRleHR1cmUsIG1heFBhcnRpY2xlcywgYmxlbmRpbmcsIGdyaWQpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiAwLCAvLyBORVc6IEluZGl2aWR1YWwgcm90YXRpb24gc3BlZWQKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMSwKICAgICAgICAgICAgICAgICAgICBmcmFtZTogMCAvLyBORVc6IFRleHR1cmUgZnJhbWUgaW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHUFUgQnVmZmVycwogICAgICAgICAgICB0aGlzLnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CiAgICAgICAgICAgIHRoaXMuc2l6ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMucm90YXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLm9wYWNpdGllcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyAqIDMpOwogICAgICAgICAgICB0aGlzLmZyYW1lcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsgLy8gTkVXCgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdmcmFtZScsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodGhpcy5mcmFtZXMsIDEpKTsgLy8gTkVXCgogICAgICAgICAgICAvLyBTaGFkZXIgTWF0ZXJpYWwKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgbWFwOiB7IHZhbHVlOiB0ZXh0dXJlIH0sCiAgICAgICAgICAgICAgICAgICAgdUdyaWQ6IHsgdmFsdWU6IGdyaWQgfHwgbmV3IFRIUkVFLlZlY3RvcjIoMSwgMSkgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBzaXplOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCByb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMyBjb2xvcjsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkZyYW1lOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdlJvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIHZPcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgdkNvbG9yID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIHZGcmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVHcmlkOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZGcmFtZTsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSBnbF9Qb2ludENvb3JkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIGNlbnRlcmVkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSBjb3ModlJvdGF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcyA9IHNpbih2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHJvdGF0ZWQgPSB2ZWMyKGNlbnRlcmVkLnggKiBjIC0gY2VudGVyZWQueSAqIHMsIGNlbnRlcmVkLnggKiBzICsgY2VudGVyZWQueSAqIGMpICsgMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXRsYXMgTG9naWMKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnggPSBtb2QodkZyYW1lLCB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZnkgPSBmbG9vcih2RnJhbWUgLyB1R3JpZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCB0byBncmlkIGNlbGwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RhbmRhcmQgVVYgKDAsMCBib3R0b20tbGVmdCkuIFdlIGFzc3VtZSByb3cgMCBpcyB0b3AuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZsaXAgcm93IGluZGV4IGZvciBHTCBjb29yZHMgaWYgbmVlZGVkLCBidXQgbGV0J3MgYXNzdW1lIHN0YW5kYXJkIGdyaWQgb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdyAwID0gVG9wIChIaWdoIFYpLCBSb3cgMSA9IEJvdHRvbSAoTG93IFYpLgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ2xSb3cgPSAodUdyaWQueSAtIDEuMCkgLSBmeTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VsbFVWID0gcm90YXRlZCAvIHVHcmlkOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIG9mZnNldCA9IHZlYzIoZnggLyB1R3JpZC54LCBnbFJvdyAvIHVHcmlkLnkpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdmVjNCB0ZXggPSB0ZXh0dXJlMkQobWFwLCBjZWxsVVYgKyBvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCh0ZXgucmdiICogdkNvbG9yLCB0ZXguYSAqIHZPcGFjaXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBibGVuZGluZwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICBzY2VuZS5hZGQodGhpcy5tZXNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvZ2ljIGhvb2sKICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBzcGF3bihwb3MsIG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gRmluZCBmaXJzdCBpbmFjdGl2ZQogICAgICAgICAgICBsZXQgcCA9IG51bGw7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMubWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLnBhcnRpY2xlc1tpXS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOyAvLyBQb29sIGZ1bGwKCiAgICAgICAgICAgIHAuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgcC5wb3MuY29weShwb3MpOwogICAgICAgICAgICBwLmxpZmUgPSBvcHRpb25zLmxpZmUgfHwgMS4wOwogICAgICAgICAgICBwLm1heExpZmUgPSBwLmxpZmU7CiAgICAgICAgICAgIHAuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICBwLnJvdGF0aW9uID0gb3B0aW9ucy5yb3RhdGlvbiB8fCAwOwogICAgICAgICAgICBwLnJvdGF0aW9uU3BlZWQgPSBvcHRpb25zLnJvdGF0aW9uU3BlZWQgfHwgMDsgLy8gTkVXCiAgICAgICAgICAgIHAudmVsLmNvcHkob3B0aW9ucy52ZWxvY2l0eSB8fCBuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgcC5ncmF2aXR5ID0gb3B0aW9ucy5ncmF2aXR5IHx8IDA7CiAgICAgICAgICAgIHAuZHJhZyA9IG9wdGlvbnMuZHJhZyB8fCAwOwogICAgICAgICAgICBpZiAob3B0aW9ucy5jb2xvcikgcC5jb2xvci5zZXQob3B0aW9ucy5jb2xvcik7CiAgICAgICAgICAgIGVsc2UgcC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwogICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgIHAuZnJhbWUgPSBvcHRpb25zLmZyYW1lIHx8IDA7IC8vIE5FVwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGxldCBhY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eSBjaGVjayBmb3IgTmFOIGxpZmUKICAgICAgICAgICAgICAgIGlmIChpc05hTihwLmxpZmUpKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmICghcC5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsgLy8gSGlkZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWlsc2FmZTogRm9yY2Uga2lsbCBpZiBsaWZlIGlzIE5hTiBvciB1bnJlYXNvbmFibHkgaGlnaCAoc3R1Y2sgcGFydGljbGUpCiAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocC5saWZlKSB8fCBwLmxpZmUgPiAxMC4wKSBwLmxpZmUgPSAwOwoKICAgICAgICAgICAgICAgIGlmIChwLmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplc1tpXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGh5c2ljcwogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSAhPT0gMCkgcC52ZWwueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgIT09IDApIHAudmVsLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIHAuZHJhZyAqIGR0KSk7CiAgICAgICAgICAgICAgICBwLnBvcy5hZGRTY2FsZWRWZWN0b3IocC52ZWwsIGR0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gcC5yb3RhdGlvblNwZWVkICogZHQ7IC8vIEFwcGx5IHJvdGF0aW9uIHNwZWVkCgogICAgICAgICAgICAgICAgLy8gTG9naWMKY29uc3QgdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEuMCwgMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSkpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZUxvZ2ljKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMb2dpYyhwLCB0LCBkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJ1ZmZlcnMKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqM10gPSBwLnBvcy54OwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbaSozKzFdID0gcC5wb3MueTsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysyXSA9IHAucG9zLno7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSBwLnNjYWxlOwogICAgICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnNbaV0gPSBwLnJvdGF0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5vcGFjaXRpZXNbaV0gPSBwLm9wYWNpdHk7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lc1tpXSA9IHAuZnJhbWU7IC8vIFVwZGF0ZSBmcmFtZSBidWZmZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozXSA9IHAuY29sb3IucjsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysxXSA9IHAuY29sb3IuZzsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2kqMysyXSA9IHAuY29sb3IuYjsKCiAgICAgICAgICAgICAgICBhY3RpdmVDb3VudCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWN0aXZlQ291bnQgPiAwIHx8IHRoaXMuYWN0aXZlQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5zaXplLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnJvdGF0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLm9wYWNpdHkubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMuZnJhbWUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyBVcGRhdGUgZnJhbWUgYnVmZmVyCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKLy8gSW5pdGlhbGl6ZSBCYXRjaGVzIChPcHRpbWl6ZWQgQ291bnRzKQp0aGlzLl9jcmVhdGVCYXRjaCgndmVub20nLCBfdmVub21UZXgsIDEwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy55KSAqIDAuMDU7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCduYXAnLCBfbmFwVGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiA1KSAqIDAuMDI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3dpdGhlcicsIF93aXRoZXJUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCA1LCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnZmxhc2gnLCBfZmxhc2hUZXgsIDMwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OyAvLyBFeHBsaWNpdCBmYWRlIG91dAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2RlYnJpcycsIF9kZWJyaXNUZXgsIDIwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMzAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAxMDAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDI1LjAgKyBwLnBvcy55ICogMC41KSAqIDAuMDE1OyAvLyBIaWdoIGZyZXEgc2hpbW1lcgogICAgICAgICAgICAgICAgcC5wb3MueiArPSBNYXRoLmNvcyh0ICogMjAuMCArIHAucG9zLnkgKiAwLjUpICogMC4wMTU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2Rhc2hfc3RyZWFtJywgX2Rhc2hTdHJlYW1UZXgsIDIwMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYmxpbmQnLCBfYmxpbmRUZXgsIDEwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCk7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAwLjU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3NpbGVuY2UnLCBfc2lsZW5jZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMC41OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaGllbGQnLCBfc2hpZWxkVGV4LCAxMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdoYXN0ZScsIF9oYXN0ZVRleCwgMTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSArPSB0ICogMS4wOyAvLyBGYXN0IHJpc2UKICAgICAgICAgICAgfSk7Cgp0aGlzLl9jcmVhdGVCYXRjaCgnc2xvdycsIF9zbG93VGV4LCAxMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5wb3MueSAtPSB0ICogMC41OyAvLyBTaW5rCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZpcmUnLCBfZmlyZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnBvcy55ICs9IHQgKiAyLjA7IC8vIFJpc2UKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gNS4wICogdDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnaWNlJywgX2ljZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0ICogMC41KTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMCAtIHQ7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IHAucm90YXRpb25TcGVlZCAqIDAuMTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgndm9sdCcsIF92b2x0VGV4LCAyMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBGbGlja2VyIHNpemUKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IE1hdGgucmFuZG9tKCk7IC8vIEZsaWNrZXIgb3BhY2l0eQogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsgLy8gSml0dGVyIHJvdGF0aW9uCiAgICAgICAgICAgIH0pOwp0aGlzLl9jcmVhdGVCYXRjaCgnc2hhcmQnLCBfZGVicmlzVGV4LCA1MDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gdDsKICAgICAgICAgICAgfSwgbmV3IFRIUkVFLlZlY3RvcjIoMiwgMikpOwogICAgICAgICAgICAvLyAtLS0gSEVSQ1VMRUFOIFRBQ0tMRSBGWCAtLS0KICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2dhdGhlcicsIF9mbGFzaFRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXMgc3Vja2luZyBpbgogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBGYWRlIGluL291dAogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgwLjIgKyB0ICogMC44KTsgLy8gU2hyaW5rIGFzIHRoZXkgZGllICh0IGdvZXMgMS0+MD8gTm8sIHQgaXMgMS4wIC0gbGlmZS9tYXhMaWZlLiBXYWl0LgogICAgICAgICAgICAgICAgLy8gSW4gdXBkYXRlKCksIHQgPSAxLjAgLSAocC5saWZlIC8gcC5tYXhMaWZlKS4gU28gdCBnb2VzIDAgLT4gMS4KICAgICAgICAgICAgICAgIC8vIEFjdHVhbGx5IGxldCdzIGNoZWNrIHVwZGF0ZSgpOiBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICAvLyBZZXMsIHQgZ29lcyAwIHRvIDEuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGdhdGhlciBwYXJ0aWNsZXMgdG8gc3RhcnQgZmFyIGFuZCBtb3ZlIGluLiBQaHlzaWNzIGhhbmRsZXMgcG9zLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0aGVtIHRvIHNocmluayBhcyB0aGV5IHJlYWNoIGNlbnRlcj8KICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCAqIDAuNSk7IAogICAgICAgICAgICAgICAgcC5yb3RhdGlvbiArPSAwLjI7CiAgICAgICAgICAgIH0pOwoKdGhpcy5fY3JlYXRlQmF0Y2goJ2ltcGFjdF9zaGFyZCcsIF9kZWJyaXNUZXgsIDEwMCwgVEhSRUUuTm9ybWFsQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOyAvLyBTaHJpbmsgb3ZlciB0aW1lCiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICB9LCBuZXcgVEhSRUUuVmVjdG9yMigyLCAyKSk7IC8vIDJ4MiBHcmlkCiAgICAgICAgfQoKX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYywgZ3JpZCkgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBncmlkKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgYmFzZSB2ZWxvY2l0eSBmcm9tIG9wdGlvbnMgb3IgemVybwogICAgICAgICAgICAgICAgbGV0IGJhc2VWZWwgPSAob3B0cy52ZWxvY2l0eSkgPyBvcHRzLnZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuMyArIE1hdGgucmFuZG9tKCkgKiAwLjI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSAqIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZHJhZyA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvblNwZWVkID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAuMDsgLy8gUmFuZG9tIHNwaW4KICAgICAgICAgICAgICAgICAgICBvcHRzLmZyYW1lID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCk7IC8vIFJhbmRvbSBzaGFwZQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gKG9wdHMuc2NhbGUgfHwgMC4xNSkgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNDsKICAgICAgICAgICAgICAgICAgICBiYXNlVmVsLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwovLyBEdXBsaWNhdGUgcmVtb3ZlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmxpbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWxlbmNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC40OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hpZWxkJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuODsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gMC42OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaGFzdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7Cn0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nsb3cnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmaXJlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wICsgTWF0aC5yYW5kb20oKSwgKE1hdGgucmFuZG9tKCktMC41KSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaWNlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb25TcGVlZCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgYmFzZVZlbC5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAndm9sdCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMywgKE1hdGgucmFuZG9tKCktMC41KSozLCAoTWF0aC5yYW5kb20oKS0wLjUpKjMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIC0tLSBNT01FTlRVTSBJTkhFUklUQU5DRSAtLS0KICAgICAgICAgICAgICAgIGlmIChvcHRzLmVtaXR0ZXJWZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vbWVudHVtU2NhbGUgPSAob3B0cy5tb21lbnR1bVNjYWxlICE9PSB1bmRlZmluZWQpID8gb3B0cy5tb21lbnR1bVNjYWxlIDogMC4yOwogICAgICAgICAgICAgICAgICAgIGlmIChtb21lbnR1bVNjYWxlICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VWZWwuYWRkU2NhbGVkVmVjdG9yKG9wdHMuZW1pdHRlclZlbG9jaXR5LCBtb21lbnR1bVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IGJhc2VWZWw7CgogICAgICAgICAgICAgICAgYmF0Y2guc3Bhd24ocG9zLCBvcHRzKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwp0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVGhlbWVzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CiAgICAgICAgX3NldHVwUnVudGltZU1vbml0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUnVudGltZSBNb25pdG9yJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgRE9NIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm1vbml0b3JFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICAgICAgICB0b3A6ICc4MHB4JywgCiAgICAgICAgICAgICAgICBsZWZ0OiAnMTBweCcsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnOHB4JywKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICdyZ2JhKDAsIDAsIDAsIDAuOCknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMXB4IHNvbGlkICMwMGZmMDAnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjMDBmZjAwJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxMXB4JywKICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ6ICcxLjQnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgbWluV2lkdGg6ICcxNTBweCcsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc0cHgnLAogICAgICAgICAgICAgICAgdGV4dFNoYWRvdzogJzFweCAxcHggMCAjMDAwJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLm1vbml0b3JFbCk7CgogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBzaG93T3ZlcmxheTogZmFsc2UKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnc2hvd092ZXJsYXknKS5uYW1lKCdTaG93IE92ZXJsYXknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCB1cGRhdGUgbG9vcAogICAgICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLnNob3dPdmVybGF5KSB0aGlzLl91cGRhdGVNb25pdG9yKCk7CiAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVNb25pdG9yKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IGdtLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBsZXQgaHRtbCA9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgZm9udC13ZWlnaHQ6Ym9sZDsgY29sb3I6I2ZmZiI+R0FNRSBTVEFURTwvZGl2PmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6I2ZmZiI+JHtnbS5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlIFRpbWVyOiAke2dtLnN0YXRlVGltZXIudG9GaXhlZCgyKX1zPGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYE1hdGNoIFRpbWU6ICR7TWF0aC5mbG9vcihnbS50aW1lLzYwKX06JHtNYXRoLmZsb29yKGdtLnRpbWUlNjApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwnMCcpfSAoSCR7Z20uaGFsZn0pPGJyPmA7CiAgICAgICAgICAgIAogICAgICAgICAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgbWFyZ2luLXRvcDo4cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkJBTEw8L2Rpdj5gOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlQ29sb3IgPSBiYWxsLnN0YXRlID09PSAnZnJlZScgPyAnIzBhZicgOiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnID8gJyNmYTAnIDogJyNmMGYnKTsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6JHtzdGF0ZUNvbG9yfSI+JHtiYWxsLnN0YXRlfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IGhvbGRlclN0ciA9ICdOb25lJzsKICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IGJhbGwuaG9sZGVyLnRlYW0gPyBiYWxsLmhvbGRlci50ZWFtLmlkLnRvVXBwZXJDYXNlKCkgOiAnPyc7CiAgICAgICAgICAgICAgICAgICAgaG9sZGVyU3RyID0gYCR7bmFtZX0gKCR7dGVhbX0pYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGh0bWwgKz0gYEhvbGRlcjogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7aG9sZGVyU3RyfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFBvczogJHtwLngudG9GaXhlZCgxKX0sICR7cC55LnRvRml4ZWQoMSl9LCAke3Auei50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgaHRtbCArPSBgU3BlZWQ6ICR7YmFsbC52ZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICBodG1sICs9IGBQb3dlcjogJHtiYWxsLnBvd2VyLnRvRml4ZWQoMSl9ICgke2JhbGwucG93ZXJUeXBlfSk8YnI+YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYE9GRkxJTkU8YnI+YDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRvb2x0aXBzKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgVG9vbHRpcCBET00KICAgICAgICAgICAgdGhpcy50b29sdGlwRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRvb2x0aXBFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICAgICAgICAgICAgICB0b3A6ICc1MCUnLAogICAgICAgICAgICAgICAgbGVmdDogJzUwJScsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoLTUwJSwgLTUwJSknLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLCAxMCwgMzAsIDAuOTUpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzJweCBzb2xpZCAjMDBmZmZmJywKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICcyMHB4JywKICAgICAgICAgICAgICAgIGNvbG9yOiAnI2ZmZicsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTRweCcsCiAgICAgICAgICAgICAgICBtYXhXaWR0aDogJzMwMHB4JywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIGJveFNoYWRvdzogJzAgMCAyMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyknLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnOHB4JywKICAgICAgICAgICAgICAgIHRleHRBbGlnbjogJ2NlbnRlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwRWwpOwoKICAgICAgICAgICAgLy8gUmVjdXJzaXZlIGZ1bmN0aW9uIHRvIGF0dGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgY29uc3QgYXR0YWNoID0gKGd1aSkgPT4gewogICAgICAgICAgICAgICAgLy8gQ29udHJvbGxlcnMKICAgICAgICAgICAgICAgIGlmIChndWkuY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuY29udHJvbGxlcnMuZm9yRWFjaChjID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9tID0gYy5kb21FbGVtZW50LmNsb3Nlc3QoJy5jb250cm9sbGVyJyk7IC8vIGxpbC1ndWkgc3RydWN0dXJlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBkb20ucXVlcnlTZWxlY3RvcignLm5hbWUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWRkTG9uZ1ByZXNzKGxhYmVsLCBjLnByb3BlcnR5LCBjLl9uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gU3ViLWZvbGRlcnMKICAgICAgICAgICAgICAgIGlmKGd1aS5mb2xkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmZvbGRlcnMuZm9yRWFjaChmID0+IGF0dGFjaChmKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBXYWl0IGEgdGljayBmb3IgR1VJIHRvIGZ1bGx5IHJlbmRlciBET00KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBhdHRhY2godGhpcy5ndWkpLCAxMDApOwogICAgICAgIH0KCiAgICAgICAgX2FkZExvbmdQcmVzcyhlbGVtZW50LCBwcm9wZXJ0eSwgbmFtZSkgewogICAgICAgICAgICBsZXQgdGltZXIgPSBudWxsOwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IDUwMDsgLy8gMC41cwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93VG9vbHRpcChwcm9wZXJ0eSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aW1lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faGlkZVRvb2x0aXAoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgc3RhcnQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBzdGFydCwge3Bhc3NpdmU6IHRydWV9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgZW5kKTsKICAgICAgICB9CgogICAgICAgIF9zaG93VG9vbHRpcChwcm9wLCBuYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGRlc2MgPSBUT09MVElQX0RFU0NSSVBUSU9OU1twcm9wXTsKICAgICAgICAgICAgaWYoZGVzYykgewogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuaW5uZXJIVE1MID0gYDxzdHJvbmcgc3R5bGU9ImNvbG9yOiMwMGZmZmY7IGZvbnQtc2l6ZToxNnB4OyI+JHtuYW1lIHx8IHByb3B9PC9zdHJvbmc+PGJyPjxicj4ke2Rlc2N9YDsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVRvb2x0aXAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRvb2x0aXBFbCkgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgoKX3NldHVwR2VuZXJhbCgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHZW5lcmFsJyk7CiAgICAgICAgICAgIApjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICB0aW1lU2NhbGU6IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSwKICAgICAgICAgICAgICAgIGRlbW9Nb2RlOiB0aGlzLmdhbWUuaXNEZW1vTW9kZSwKICAgICAgICAgICAgICAgIHRvZ2dsZUhVRDogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlc29sdXRpb246IDAuNTAsCmFyZW5hT3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgYXJlbmEyT3BhY2l0eTogMC4yNQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0aW1lU2NhbGUnLCAwLjAsIDUuMCkubmFtZSgnR2FtZSBTcGVlZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgd2luZG93LmZsdXgudGltZVNjYWxlID0gdjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2RlbW9Nb2RlJykubmFtZSgnRGVtbyBNb2RlJykubGlzdGVuKCkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlzRGVtb01vZGUgIT09IHYpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RvZ2dsZUhVRCcpLm5hbWUoJ1Nob3cgSFVEJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgICAgIGlmIChodWQpIHsKICAgICAgICAgICAgICAgICAgICBodWQuc3R5bGUudmlzaWJpbGl0eSA9IHYgPyAndmlzaWJsZScgOiAnaGlkZGVuJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc29sdXRpb24nLCAwLjEsIDIuMCkubmFtZSgnUmVzb2x1dGlvbiBTY2FsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdyA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVyID0gdGhpcy5nYW1lLnJlbmRlcmVyOwogICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSh3ICogdiwgaCAqIHYsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7Cgpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAxIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKcGFyYW1zLmFyZW5hQmxlbmQgPSAnTm9ybWFsJzsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAxIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcmVuYSAyIENvbnRyb2xzCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAyIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCnBhcmFtcy5hcmVuYTJCbGVuZCA9ICdBZGRpdGl2ZSc7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMiBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGRlZmF1bHRzCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYU9wYWNpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hMk9wYWNpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBBcmVuYSBHcmFwaGljcyBDb250cm9scyAtLS0KICAgICAgICAgICAgdGhpcy5fc2V0dXBBcmVuYUdyYXBoaWNzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBBcmVuYUdyYXBoaWNzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0FyZW5hIEdyYXBoaWNzJyk7CgogICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gLS0tIEJsdWUgQmFuZCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmx1ZSBCYW5kJyk7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCA/IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCkgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBibHVlRm9sZGVyLmFkZChibHVlUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBHb2xkIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29sZEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0dvbGQgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgZ29sZFBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgfHwgMC4zNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ05vcm1hbCcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNZXNoKSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdvbGRGb2xkZXIuYWRkKGdvbGRQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFllbGxvdyBBcnJvd3MgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdZZWxsb3cgQXJyb3dzJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJvd1BhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwID8gd2luZG93LmZsdXguYXJyb3dHcm91cC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5hcnJvd01hdC5vcGFjaXR5IHx8IDAuOCwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFycm93R3JvdXApIHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBGbG9vciBHbHlwaCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignRmxvb3IgR2x5cGgnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoID8gd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZsb29yRm9sZGVyLmFkZChmbG9vclBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwT3ZlcmxheXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignT3ZlcmxheXMgJiBGWCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gR0lGIE92ZXJsYXkKICAgICAgICAgICAgY29uc3QgZ2lmRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyZWVuLW92ZXJsYXktZ2lmJyk7CiAgICAgICAgICAgIGlmIChnaWZFbCkgewogICAgICAgICAgICAgICAgY29uc3QgZ2lmUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCm9wYWNpdHk6IDAuNjIsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdvdmVybGF5JwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1NjcmVlbiBHSUYnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUub3BhY2l0eSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gWwogICAgICAgICAgICAgICAgICAgICdub3JtYWwnLCAnbXVsdGlwbHknLCAnc2NyZWVuJywgJ292ZXJsYXknLCAKICAgICAgICAgICAgICAgICAgICAnZGFya2VuJywgJ2xpZ2h0ZW4nLCAnY29sb3ItZG9kZ2UnLCAnY29sb3ItYnVybicsIAogICAgICAgICAgICAgICAgICAgICdoYXJkLWxpZ2h0JywgJ3NvZnQtbGlnaHQnLCAnZGlmZmVyZW5jZScsICdleGNsdXNpb24nLCAKICAgICAgICAgICAgICAgICAgICAnaHVlJywgJ3NhdHVyYXRpb24nLCAnY29sb3InLCAnbHVtaW5vc2l0eScKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdibGVuZCcsIGJsZW5kTW9kZXMpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUubWl4QmxlbmRNb2RlID0gdik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFdhdGVyIE92ZXJsYXkKICAgICAgICAgICAgY29uc3Qgd28gPSB0aGlzLmdhbWUud2F0ZXJPdmVybGF5OwogICAgICAgICAgICBpZiAod28gJiYgd28ubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3Qgd0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1dhdGVyIFNoYWRlcicpOwogICAgICAgICAgICAgICAgY29uc3Qgd1BhcmFtcyA9IHsgCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSA/IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDogMC41LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gd28ubWVzaC52aXNpYmxlID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAyLjApLm9uQ2hhbmdlKHYgPT4gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICBjb25zdCBscyA9IHRoaXMuZ2FtZS5saWdodFNoYWZ0czsKICAgICAgICAgICAgaWYgKGxzICYmIGxzLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgY29uc3QgbFBhcmFtcyA9IHsgdmlzaWJsZTogdHJ1ZSB9OwogICAgICAgICAgICAgICAgZm9sZGVyLmFkZChsUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ0xpZ2h0IFNoYWZ0cycpLm9uQ2hhbmdlKHYgPT4gbHMuY29udGFpbmVyLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cEdhbWVTdGF0ZSgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHYW1lIFN0YXRlJyk7CiAgICAgICAgICAgIGNvbnN0IGdtID0gdGhpcy5nYW1lOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZm9yY2VIb21lR29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VBd2F5R29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2F3YXknKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUhhbGZ0aW1lOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5lbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVzZXRSb3VuZDogKCkgPT4gZ20ucmVzZXRSb3VuZCgpLAogICAgICAgICAgICAgICAgZXhpdFRvTWVudTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIb21lR29hbCcpLm5hbWUoJ1RyaWdnZXIgSG9tZSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VBd2F5R29hbCcpLm5hbWUoJ1RyaWdnZXIgQXdheSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIYWxmdGltZScpLm5hbWUoJ0ZvcmNlIEhhbGZ0aW1lJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzZXRSb3VuZCcpLm5hbWUoJ1Jlc2V0IFJvdW5kJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZXhpdFRvTWVudScpLm5hbWUoJ0V4aXQgdG8gTWVudScpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVGVhbXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVGVhbXMnKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUudGVhbXMuaG9tZSB8fCAhdGhpcy5nYW1lLnRlYW1zLmF3YXkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwoKICAgICAgICAgICAgLy8gSG9tZQogICAgICAgICAgICBjb25zdCBoRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignSG9tZSBUZWFtJyk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKICAgICAgICAgICAgLy8gQXdheQogICAgICAgICAgICBjb25zdCBhRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQXdheSBUZWFtJyk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKfQoKICAgICAgICBfc2V0dXBUaGVtZXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXJlbmEgVGhlbWVzJyk7CiAgICAgICAgICAgIGNvbnN0IGF0bSA9IHRoaXMuZ2FtZS5hcmVuYVRoZW1lTWFuYWdlcjsKICAgICAgICAgICAgaWYgKCFhdG0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRoZW1lcyA9IE9iamVjdC5rZXlzKHdpbmRvdy5mbHV4LlRIRU1FUyB8fCB7fSk7CiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRoZW1lOiBhdG0uY3VycmVudFRoZW1lLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogdGhpcy5nYW1lLnNjZW5lLmZvZyA/IHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA6IDAuMDAwMSwKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5XQVRFUl9EUkFHX0xJTkVBUiA6IDAuMTUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGhlbWUnLCB0aGVtZXMpLm5hbWUoJ1NlbGVjdCBUaGVtZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgYXRtLnNldFRoZW1lKHYpOwogICAgICAgICAgICAgICAgLy8gU3luYyBwYXJhbXMgdG8gbmV3IHRoZW1lIGRlZmF1bHRzCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNjZW5lLmZvZykgcGFyYW1zLmZvZ0RlbnNpdHkgPSB0aGlzLmdhbWUuc2NlbmUuZm9nLmRlbnNpdHk7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbENvbmZpZykgcGFyYW1zLndhdGVyRHJhZyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgbGl2ZSA9IGZvbGRlci5hZGRGb2xkZXIoJ0xpdmUgVHdlYWtzJyk7CiAgICAgICAgICAgIGxpdmUuYWRkKHBhcmFtcywgJ2ZvZ0RlbnNpdHknLCAwLCAwLjA1KS5uYW1lKCdGb2cgRGVuc2l0eScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zY2VuZS5mb2cpIHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA9IHY7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsaXZlLmFkZChwYXJhbXMsICd3YXRlckRyYWcnLCAwLCAxLjApLm5hbWUoJ1dhdGVyIERyYWcnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSID0gdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQpfc2V0dXBQbGF5ZXJJbnNwZWN0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUGxheWVyIEluc3BlY3RvciAoSG9tZSBBY3RpdmUpJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZWxwZXIgdG8gZ2V0IGN1cnJlbnQgYWN0aXZlIHBsYXllciBzYWZlbHkKICAgICAgICAgICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLmdhbWUudGVhbXMuaG9tZSAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIAogICAgICAgICAgICAgICAgICAgID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIAogICAgICAgICAgICAgICAgICAgIDogbnVsbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFByb3h5IG9iamVjdCB0byBiaW5kIEdVSSB0byBkeW5hbWljIHRhcmdldAogICAgICAgICAgICBjb25zdCBwcm94eSA9IHsKICAgICAgICAgICAgICAgIGdldCBSb2xlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnJvbGUgOiAnLSc7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEdvZE1vZGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuaXNHb2RNb2RlIDogZmFsc2U7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBHb2RNb2RlKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuaXNHb2RNb2RlID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIFJ1bnRpbWUgVmFsdWVzCiAgICAgICAgICAgICAgICBnZXQgSFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuSFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgSFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5IUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEN1cnJlbnRFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5jdXJyZW50RU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ3VycmVudEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuY3VycmVudEVOID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEJhc2UgU3RhdHMKICAgICAgICAgICAgICAgIGdldCBNYXhIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5tYXhIUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBNYXhIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLm1heEhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gdjsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOyAKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgRU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuRU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sIAogICAgICAgICAgICAgICAgc2V0IEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IHY7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQVQoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQVQgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQVQodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5BVCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgUEEoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuUEEgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgUEEodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5QQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQkwoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQkwgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQkwodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5CTCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU0goKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU0ggOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU0godikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5TSCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQ0EoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQ0EgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ0EodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5DQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBBY3Rpb25zCiAgICAgICAgICAgICAgICBMZXZlbFVwOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmxldmVsVXAoKTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRnVsbEhlYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyAKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5nZXRTdGF0KCdFTicpOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBwLnN0YXR1cy53aXRoZXIpIHAuc3RhdHVzLndpdGhlcltrXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZVTEwgSEVBTCIsIHAubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRHJhaW5FTjogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZnVtYmxlKCk7IC8vIFRyaWdnZXIgZnVtYmxlIGxvZ2ljCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ1JvbGUnKS5saXN0ZW4oKS5kaXNhYmxlKCk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdHb2RNb2RlJykubmFtZSgnR29kIE1vZGUgKEluZiBIUC9FTiknKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHJ0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignUnVudGltZSBTdGF0dXMnKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnSFAnLCAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnQ3VycmVudEVOJywgMCwgMTAwKS5uYW1lKCdDdXJyZW50IEVOJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBzdGF0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmFzZSBTdGF0cycpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ01heEhQJywgMTAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdFTicsIDAsIDk5KS5uYW1lKCdNYXggRU4nKS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTUCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdBVCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdQQScsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdCTCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTSCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdDQScsIDAsIDk5KS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IGFjdGlvbkZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0FjdGlvbnMnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0xldmVsVXAnKS5uYW1lKCdJbnN0YW50IExldmVsIFVwJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdGdWxsSGVhbCcpLm5hbWUoJ0Z1bGwgSGVhbCAmIEN1cmUnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0RyYWluRU4nKS5uYW1lKCdEcmFpbiBFTiAoRnVtYmxlKScpOwogICAgICAgIH0KCl9zZXR1cEJhbGxTYW5kYm94KCkgewogICAgY29uc3Qgcm9vdCA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQmFsbCBMYWIgKFRocm93ICYgUGh5c2ljcyknKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFNoYXJlZCBzdGF0ZSBvYmplY3QgKGxpdmVzIG9uIHdpbmRvdy5mbHV4IHNvIGl0IHN1cnZpdmVzIHJlbG9hZHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGxhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiIHx8IHt9OwogICAgbGFiLmdhbWUgPSB0aGlzLmdhbWU7CgogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7CiAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnOwoKICAgIGlmICghQyB8fCAhVEMpIHsKICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgTGFiOiBNaXNzaW5nIEJhbGxDb25maWcgb3IgVGhyb3dDb25maWcuIik7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSGVscGVycwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBnZXRCYWxsID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS5lbnRpdGllcyA/IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUudGVhbXMgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwoKICAgIGNvbnN0IGVuc3VyZVByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHJldHVybjsKICAgICAgICBpZiAoIXRoaXMuZ2FtZSB8fCAhdGhpcy5nYW1lLnNjZW5lKSByZXR1cm47CgogICAgICAgIGNvbnN0IGdlb20gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTGluZUJhc2ljTWF0ZXJpYWwoeyB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC45NSB9KTsKICAgICAgICBjb25zdCBsaW5lID0gbmV3IFRIUkVFLkxpbmUoZ2VvbSwgbWF0KTsKICAgICAgICBsaW5lLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICBsaW5lLnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQobGluZSk7CiAgICAgICAgbGFiLnByZXZpZXdMaW5lID0gbGluZTsKICAgIH07CgogICAgY29uc3QgY2xlYXJQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lICYmIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSkgewogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEEgc2FmZSAiZ2hvc3QgYmFsbCIgdGhhdCBjYW4gdXNlIEJhbGwudXBkYXRlRnJlZSB3aXRob3V0IHNwYXduaW5nIEZYCiAgICBjb25zdCBtYWtlR2hvc3RCYWxsID0gKHBvcywgdmVsLCBzcGluKSA9PiB7CiAgICAgICAgY29uc3QgZ2IgPSB7CiAgICAgICAgICAgIG1lc2g6IHsgcG9zaXRpb246IHBvcy5jbG9uZSgpIH0sCiAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwuY2xvbmUoKSwKICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiAoc3BpbiA/IHNwaW4uY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCkpLAogICAgICAgICAgICBhY2N1bXVsYXRlZFJvdGF0aW9uOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICBwb3dlcjogMCwKICAgICAgICAgICAgZGVjYXlSYXRlOiAwLAogICAgICAgICAgICBfYnViYmxlVGltZXI6IDk5OSwKICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICBkZWZvcm1Ob2RlOiBudWxsCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZ2I7CiAgICB9OwoKICAgIC8vIFVzZSBCYWxsLnVwZGF0ZUZyZWUgZm9yIGZhaXRoZnVsIHRyYWplY3RvcnkgcHJlZGljdGlvbgogICAgY29uc3Qgc2ltdWxhdGUgPSAoZ2hvc3RCYWxsLCBzdGVwcywgc3RlcER0KSA9PiB7CiAgICAgICAgY29uc3QgcHRzID0gW107CiAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgY29uc3QgcHJvdG8gPSB3aW5kb3cuZmx1eC5CYWxsICYmIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlOwogICAgICAgIGlmICghcHJvdG8gfHwgdHlwZW9mIHByb3RvLnVwZGF0ZUZyZWUgIT09ICdmdW5jdGlvbicpIHJldHVybiBwdHM7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RlcHM7IGkrKykgewogICAgICAgICAgICBwcm90by51cGRhdGVGcmVlLmNhbGwoZ2hvc3RCYWxsLCBzdGVwRHQpOwogICAgICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHB0czsKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQcmV2aWV3ICsgcmVjb3JkL3JlcGxheSBydW50aW1lIGxvb3AKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpsYWIucHJldmlldyA9IGxhYi5wcmV2aWV3IHx8IHsKICAgICAgICBlbmFibGVkOiBmYWxzZSwKICAgICAgICBzb3VyY2U6ICdDYW5ub24nLAogICAgICAgIHN0ZXBzOiAxMjAsCiAgICAgICAgc3RlcER0OiAxLzYwLAogICAgICAgIHJlZnJlc2hIejogMTAsCiAgICAgICAgc2hvd09uSGVsZE9ubHk6IGZhbHNlCiAgICB9OwoKbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBlbGVtZW50OiAnbm9uZScsCiAgICAgICAgc3Bpblg6IDAsCiAgICAgICAgc3Bpblk6IDAsCiAgICAgICAgc3Bpblo6IDAsCiAgICAgICAgZmlyZUJ1cnN0OiAxLAogICAgICAgIHNwcmVhZERlZzogMAogICAgfTsKICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgPT09IHVuZGVmaW5lZCkgbGFiLmNhbm5vbi5lbGVtZW50ID0gJ25vbmUnOwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CmFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ESVNUQU5DRScsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnogPSAtdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnogPSB2OwogICAgICAgIC8vIFVwZGF0ZSBEZWJ1ZyBWaXN1YWxzIGlmIGFjdGl2ZQogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQp9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ZX09GRlNFVCcsIC01MC4wLCAyMC4wKS5uYW1lKCdHb2FsIFkgUG9zJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi55ID0gdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnkgPSB2OwogICAgfSk7CiAgICBhcmVuYS5hZGQoQywgJ0dPQUxfU0NBTEUnLCAxLjAsIDEwMC4wKS5uYW1lKCdHb2FsIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5zY2FsZS5zZXRTY2FsYXIodik7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxCKSB3aW5kb3cuZmx1eC5nb2FsQi5zY2FsZS5zZXRTY2FsYXIodik7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIAogICAgY29uc3QgZWxlbVR5cGVzID0gWydub25lJywgJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCcsICdzcGhlcmUnLCAnamVjaHQnLCAnaW52aXNpYmxlJ107CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdlbGVtZW50JywgZWxlbVR5cGVzKS5uYW1lKCdFbGVtZW50Jyk7CgogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB0ZWNoID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgJiYgbGFiLmNhbm5vbi5lbGVtZW50ICE9PSAnbm9uZScpIHsKICAgICAgICAgICAgICAgICAgICB0ZWNoID0geyB0eXBlOiBsYWIuY2Fubm9uLmVsZW1lbnQsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCB0ZWNoLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","./DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwp0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVGhlbWVzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CiAgICAgICAgX3NldHVwUnVudGltZU1vbml0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUnVudGltZSBNb25pdG9yJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgRE9NIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm1vbml0b3JFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICAgICAgICB0b3A6ICc4MHB4JywgCiAgICAgICAgICAgICAgICBsZWZ0OiAnMTBweCcsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnOHB4JywKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICdyZ2JhKDAsIDAsIDAsIDAuOCknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMXB4IHNvbGlkICMwMGZmMDAnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjMDBmZjAwJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxMXB4JywKICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ6ICcxLjQnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgbWluV2lkdGg6ICcxNTBweCcsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc0cHgnLAogICAgICAgICAgICAgICAgdGV4dFNoYWRvdzogJzFweCAxcHggMCAjMDAwJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLm1vbml0b3JFbCk7CgogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBzaG93T3ZlcmxheTogZmFsc2UKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnc2hvd092ZXJsYXknKS5uYW1lKCdTaG93IE92ZXJsYXknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCB1cGRhdGUgbG9vcAogICAgICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLnNob3dPdmVybGF5KSB0aGlzLl91cGRhdGVNb25pdG9yKCk7CiAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVNb25pdG9yKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IGdtLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBsZXQgaHRtbCA9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgZm9udC13ZWlnaHQ6Ym9sZDsgY29sb3I6I2ZmZiI+R0FNRSBTVEFURTwvZGl2PmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6I2ZmZiI+JHtnbS5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlIFRpbWVyOiAke2dtLnN0YXRlVGltZXIudG9GaXhlZCgyKX1zPGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYE1hdGNoIFRpbWU6ICR7TWF0aC5mbG9vcihnbS50aW1lLzYwKX06JHtNYXRoLmZsb29yKGdtLnRpbWUlNjApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwnMCcpfSAoSCR7Z20uaGFsZn0pPGJyPmA7CiAgICAgICAgICAgIAogICAgICAgICAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgbWFyZ2luLXRvcDo4cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkJBTEw8L2Rpdj5gOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlQ29sb3IgPSBiYWxsLnN0YXRlID09PSAnZnJlZScgPyAnIzBhZicgOiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnID8gJyNmYTAnIDogJyNmMGYnKTsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6JHtzdGF0ZUNvbG9yfSI+JHtiYWxsLnN0YXRlfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IGhvbGRlclN0ciA9ICdOb25lJzsKICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IGJhbGwuaG9sZGVyLnRlYW0gPyBiYWxsLmhvbGRlci50ZWFtLmlkLnRvVXBwZXJDYXNlKCkgOiAnPyc7CiAgICAgICAgICAgICAgICAgICAgaG9sZGVyU3RyID0gYCR7bmFtZX0gKCR7dGVhbX0pYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGh0bWwgKz0gYEhvbGRlcjogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7aG9sZGVyU3RyfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFBvczogJHtwLngudG9GaXhlZCgxKX0sICR7cC55LnRvRml4ZWQoMSl9LCAke3Auei50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgaHRtbCArPSBgU3BlZWQ6ICR7YmFsbC52ZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICBodG1sICs9IGBQb3dlcjogJHtiYWxsLnBvd2VyLnRvRml4ZWQoMSl9ICgke2JhbGwucG93ZXJUeXBlfSk8YnI+YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYE9GRkxJTkU8YnI+YDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRvb2x0aXBzKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgVG9vbHRpcCBET00KICAgICAgICAgICAgdGhpcy50b29sdGlwRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRvb2x0aXBFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICAgICAgICAgICAgICB0b3A6ICc1MCUnLAogICAgICAgICAgICAgICAgbGVmdDogJzUwJScsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoLTUwJSwgLTUwJSknLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLCAxMCwgMzAsIDAuOTUpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzJweCBzb2xpZCAjMDBmZmZmJywKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICcyMHB4JywKICAgICAgICAgICAgICAgIGNvbG9yOiAnI2ZmZicsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTRweCcsCiAgICAgICAgICAgICAgICBtYXhXaWR0aDogJzMwMHB4JywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIGJveFNoYWRvdzogJzAgMCAyMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyknLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnOHB4JywKICAgICAgICAgICAgICAgIHRleHRBbGlnbjogJ2NlbnRlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwRWwpOwoKICAgICAgICAgICAgLy8gUmVjdXJzaXZlIGZ1bmN0aW9uIHRvIGF0dGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgY29uc3QgYXR0YWNoID0gKGd1aSkgPT4gewogICAgICAgICAgICAgICAgLy8gQ29udHJvbGxlcnMKICAgICAgICAgICAgICAgIGlmIChndWkuY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuY29udHJvbGxlcnMuZm9yRWFjaChjID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9tID0gYy5kb21FbGVtZW50LmNsb3Nlc3QoJy5jb250cm9sbGVyJyk7IC8vIGxpbC1ndWkgc3RydWN0dXJlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBkb20ucXVlcnlTZWxlY3RvcignLm5hbWUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWRkTG9uZ1ByZXNzKGxhYmVsLCBjLnByb3BlcnR5LCBjLl9uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gU3ViLWZvbGRlcnMKICAgICAgICAgICAgICAgIGlmKGd1aS5mb2xkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmZvbGRlcnMuZm9yRWFjaChmID0+IGF0dGFjaChmKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBXYWl0IGEgdGljayBmb3IgR1VJIHRvIGZ1bGx5IHJlbmRlciBET00KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBhdHRhY2godGhpcy5ndWkpLCAxMDApOwogICAgICAgIH0KCiAgICAgICAgX2FkZExvbmdQcmVzcyhlbGVtZW50LCBwcm9wZXJ0eSwgbmFtZSkgewogICAgICAgICAgICBsZXQgdGltZXIgPSBudWxsOwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IDUwMDsgLy8gMC41cwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93VG9vbHRpcChwcm9wZXJ0eSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aW1lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faGlkZVRvb2x0aXAoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgc3RhcnQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBzdGFydCwge3Bhc3NpdmU6IHRydWV9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgZW5kKTsKICAgICAgICB9CgogICAgICAgIF9zaG93VG9vbHRpcChwcm9wLCBuYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGRlc2MgPSBUT09MVElQX0RFU0NSSVBUSU9OU1twcm9wXTsKICAgICAgICAgICAgaWYoZGVzYykgewogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuaW5uZXJIVE1MID0gYDxzdHJvbmcgc3R5bGU9ImNvbG9yOiMwMGZmZmY7IGZvbnQtc2l6ZToxNnB4OyI+JHtuYW1lIHx8IHByb3B9PC9zdHJvbmc+PGJyPjxicj4ke2Rlc2N9YDsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVRvb2x0aXAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRvb2x0aXBFbCkgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgoKX3NldHVwR2VuZXJhbCgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHZW5lcmFsJyk7CiAgICAgICAgICAgIApjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICB0aW1lU2NhbGU6IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSwKICAgICAgICAgICAgICAgIGRlbW9Nb2RlOiB0aGlzLmdhbWUuaXNEZW1vTW9kZSwKICAgICAgICAgICAgICAgIHRvZ2dsZUhVRDogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlc29sdXRpb246IDAuNTAsCmFyZW5hT3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgYXJlbmEyT3BhY2l0eTogMC4yNQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0aW1lU2NhbGUnLCAwLjAsIDUuMCkubmFtZSgnR2FtZSBTcGVlZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgd2luZG93LmZsdXgudGltZVNjYWxlID0gdjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2RlbW9Nb2RlJykubmFtZSgnRGVtbyBNb2RlJykubGlzdGVuKCkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlzRGVtb01vZGUgIT09IHYpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RvZ2dsZUhVRCcpLm5hbWUoJ1Nob3cgSFVEJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgICAgIGlmIChodWQpIHsKICAgICAgICAgICAgICAgICAgICBodWQuc3R5bGUudmlzaWJpbGl0eSA9IHYgPyAndmlzaWJsZScgOiAnaGlkZGVuJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc29sdXRpb24nLCAwLjEsIDIuMCkubmFtZSgnUmVzb2x1dGlvbiBTY2FsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdyA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVyID0gdGhpcy5nYW1lLnJlbmRlcmVyOwogICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSh3ICogdiwgaCAqIHYsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7Cgpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAxIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKcGFyYW1zLmFyZW5hQmxlbmQgPSAnTm9ybWFsJzsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAxIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcmVuYSAyIENvbnRyb2xzCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAyIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCnBhcmFtcy5hcmVuYTJCbGVuZCA9ICdBZGRpdGl2ZSc7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMiBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGRlZmF1bHRzCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYU9wYWNpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hMk9wYWNpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBBcmVuYSBHcmFwaGljcyBDb250cm9scyAtLS0KICAgICAgICAgICAgdGhpcy5fc2V0dXBBcmVuYUdyYXBoaWNzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBBcmVuYUdyYXBoaWNzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0FyZW5hIEdyYXBoaWNzJyk7CgogICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gLS0tIEJsdWUgQmFuZCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmx1ZSBCYW5kJyk7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCA/IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCkgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBibHVlRm9sZGVyLmFkZChibHVlUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBHb2xkIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29sZEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0dvbGQgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgZ29sZFBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgfHwgMC4zNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ05vcm1hbCcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNZXNoKSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdvbGRGb2xkZXIuYWRkKGdvbGRQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFllbGxvdyBBcnJvd3MgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdZZWxsb3cgQXJyb3dzJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJvd1BhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwID8gd2luZG93LmZsdXguYXJyb3dHcm91cC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5hcnJvd01hdC5vcGFjaXR5IHx8IDAuOCwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFycm93R3JvdXApIHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBGbG9vciBHbHlwaCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignRmxvb3IgR2x5cGgnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoID8gd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZsb29yRm9sZGVyLmFkZChmbG9vclBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwT3ZlcmxheXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignT3ZlcmxheXMgJiBGWCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gR0lGIE92ZXJsYXkKICAgICAgICAgICAgY29uc3QgZ2lmRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyZWVuLW92ZXJsYXktZ2lmJyk7CiAgICAgICAgICAgIGlmIChnaWZFbCkgewogICAgICAgICAgICAgICAgY29uc3QgZ2lmUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCm9wYWNpdHk6IDAuNjIsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdvdmVybGF5JwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1NjcmVlbiBHSUYnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUub3BhY2l0eSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gWwogICAgICAgICAgICAgICAgICAgICdub3JtYWwnLCAnbXVsdGlwbHknLCAnc2NyZWVuJywgJ292ZXJsYXknLCAKICAgICAgICAgICAgICAgICAgICAnZGFya2VuJywgJ2xpZ2h0ZW4nLCAnY29sb3ItZG9kZ2UnLCAnY29sb3ItYnVybicsIAogICAgICAgICAgICAgICAgICAgICdoYXJkLWxpZ2h0JywgJ3NvZnQtbGlnaHQnLCAnZGlmZmVyZW5jZScsICdleGNsdXNpb24nLCAKICAgICAgICAgICAgICAgICAgICAnaHVlJywgJ3NhdHVyYXRpb24nLCAnY29sb3InLCAnbHVtaW5vc2l0eScKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdibGVuZCcsIGJsZW5kTW9kZXMpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUubWl4QmxlbmRNb2RlID0gdik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFdhdGVyIE92ZXJsYXkKICAgICAgICAgICAgY29uc3Qgd28gPSB0aGlzLmdhbWUud2F0ZXJPdmVybGF5OwogICAgICAgICAgICBpZiAod28gJiYgd28ubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3Qgd0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1dhdGVyIFNoYWRlcicpOwogICAgICAgICAgICAgICAgY29uc3Qgd1BhcmFtcyA9IHsgCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSA/IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDogMC41LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gd28ubWVzaC52aXNpYmxlID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAyLjApLm9uQ2hhbmdlKHYgPT4gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICBjb25zdCBscyA9IHRoaXMuZ2FtZS5saWdodFNoYWZ0czsKICAgICAgICAgICAgaWYgKGxzICYmIGxzLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgY29uc3QgbFBhcmFtcyA9IHsgdmlzaWJsZTogdHJ1ZSB9OwogICAgICAgICAgICAgICAgZm9sZGVyLmFkZChsUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ0xpZ2h0IFNoYWZ0cycpLm9uQ2hhbmdlKHYgPT4gbHMuY29udGFpbmVyLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cEdhbWVTdGF0ZSgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHYW1lIFN0YXRlJyk7CiAgICAgICAgICAgIGNvbnN0IGdtID0gdGhpcy5nYW1lOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZm9yY2VIb21lR29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VBd2F5R29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2F3YXknKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUhhbGZ0aW1lOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5lbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVzZXRSb3VuZDogKCkgPT4gZ20ucmVzZXRSb3VuZCgpLAogICAgICAgICAgICAgICAgZXhpdFRvTWVudTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIb21lR29hbCcpLm5hbWUoJ1RyaWdnZXIgSG9tZSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VBd2F5R29hbCcpLm5hbWUoJ1RyaWdnZXIgQXdheSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIYWxmdGltZScpLm5hbWUoJ0ZvcmNlIEhhbGZ0aW1lJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzZXRSb3VuZCcpLm5hbWUoJ1Jlc2V0IFJvdW5kJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZXhpdFRvTWVudScpLm5hbWUoJ0V4aXQgdG8gTWVudScpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVGVhbXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVGVhbXMnKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUudGVhbXMuaG9tZSB8fCAhdGhpcy5nYW1lLnRlYW1zLmF3YXkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwoKICAgICAgICAgICAgLy8gSG9tZQogICAgICAgICAgICBjb25zdCBoRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignSG9tZSBUZWFtJyk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKICAgICAgICAgICAgLy8gQXdheQogICAgICAgICAgICBjb25zdCBhRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQXdheSBUZWFtJyk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKfQoKICAgICAgICBfc2V0dXBUaGVtZXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXJlbmEgVGhlbWVzJyk7CiAgICAgICAgICAgIGNvbnN0IGF0bSA9IHRoaXMuZ2FtZS5hcmVuYVRoZW1lTWFuYWdlcjsKICAgICAgICAgICAgaWYgKCFhdG0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRoZW1lcyA9IE9iamVjdC5rZXlzKHdpbmRvdy5mbHV4LlRIRU1FUyB8fCB7fSk7CiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRoZW1lOiBhdG0uY3VycmVudFRoZW1lLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogdGhpcy5nYW1lLnNjZW5lLmZvZyA/IHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA6IDAuMDAwMSwKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5XQVRFUl9EUkFHX0xJTkVBUiA6IDAuMTUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGhlbWUnLCB0aGVtZXMpLm5hbWUoJ1NlbGVjdCBUaGVtZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgYXRtLnNldFRoZW1lKHYpOwogICAgICAgICAgICAgICAgLy8gU3luYyBwYXJhbXMgdG8gbmV3IHRoZW1lIGRlZmF1bHRzCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNjZW5lLmZvZykgcGFyYW1zLmZvZ0RlbnNpdHkgPSB0aGlzLmdhbWUuc2NlbmUuZm9nLmRlbnNpdHk7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbENvbmZpZykgcGFyYW1zLndhdGVyRHJhZyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgbGl2ZSA9IGZvbGRlci5hZGRGb2xkZXIoJ0xpdmUgVHdlYWtzJyk7CiAgICAgICAgICAgIGxpdmUuYWRkKHBhcmFtcywgJ2ZvZ0RlbnNpdHknLCAwLCAwLjA1KS5uYW1lKCdGb2cgRGVuc2l0eScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zY2VuZS5mb2cpIHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA9IHY7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsaXZlLmFkZChwYXJhbXMsICd3YXRlckRyYWcnLCAwLCAxLjApLm5hbWUoJ1dhdGVyIERyYWcnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSID0gdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQpfc2V0dXBQbGF5ZXJJbnNwZWN0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUGxheWVyIEluc3BlY3RvciAoSG9tZSBBY3RpdmUpJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZWxwZXIgdG8gZ2V0IGN1cnJlbnQgYWN0aXZlIHBsYXllciBzYWZlbHkKICAgICAgICAgICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLmdhbWUudGVhbXMuaG9tZSAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIAogICAgICAgICAgICAgICAgICAgID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIAogICAgICAgICAgICAgICAgICAgIDogbnVsbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFByb3h5IG9iamVjdCB0byBiaW5kIEdVSSB0byBkeW5hbWljIHRhcmdldAogICAgICAgICAgICBjb25zdCBwcm94eSA9IHsKICAgICAgICAgICAgICAgIGdldCBSb2xlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnJvbGUgOiAnLSc7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEdvZE1vZGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuaXNHb2RNb2RlIDogZmFsc2U7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBHb2RNb2RlKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuaXNHb2RNb2RlID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIFJ1bnRpbWUgVmFsdWVzCiAgICAgICAgICAgICAgICBnZXQgSFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuSFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgSFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5IUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEN1cnJlbnRFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5jdXJyZW50RU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ3VycmVudEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuY3VycmVudEVOID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEJhc2UgU3RhdHMKICAgICAgICAgICAgICAgIGdldCBNYXhIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5tYXhIUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBNYXhIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLm1heEhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gdjsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOyAKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgRU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuRU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sIAogICAgICAgICAgICAgICAgc2V0IEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IHY7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQVQoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQVQgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQVQodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5BVCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgUEEoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuUEEgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgUEEodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5QQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQkwoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQkwgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQkwodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5CTCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU0goKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU0ggOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU0godikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5TSCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQ0EoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQ0EgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ0EodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5DQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBBY3Rpb25zCiAgICAgICAgICAgICAgICBMZXZlbFVwOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmxldmVsVXAoKTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRnVsbEhlYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyAKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5nZXRTdGF0KCdFTicpOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBwLnN0YXR1cy53aXRoZXIpIHAuc3RhdHVzLndpdGhlcltrXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZVTEwgSEVBTCIsIHAubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRHJhaW5FTjogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZnVtYmxlKCk7IC8vIFRyaWdnZXIgZnVtYmxlIGxvZ2ljCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ1JvbGUnKS5saXN0ZW4oKS5kaXNhYmxlKCk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdHb2RNb2RlJykubmFtZSgnR29kIE1vZGUgKEluZiBIUC9FTiknKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHJ0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignUnVudGltZSBTdGF0dXMnKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnSFAnLCAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnQ3VycmVudEVOJywgMCwgMTAwKS5uYW1lKCdDdXJyZW50IEVOJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBzdGF0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmFzZSBTdGF0cycpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ01heEhQJywgMTAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdFTicsIDAsIDk5KS5uYW1lKCdNYXggRU4nKS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTUCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdBVCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdQQScsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdCTCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTSCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdDQScsIDAsIDk5KS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IGFjdGlvbkZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0FjdGlvbnMnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0xldmVsVXAnKS5uYW1lKCdJbnN0YW50IExldmVsIFVwJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdGdWxsSGVhbCcpLm5hbWUoJ0Z1bGwgSGVhbCAmIEN1cmUnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0RyYWluRU4nKS5uYW1lKCdEcmFpbiBFTiAoRnVtYmxlKScpOwogICAgICAgIH0KCl9zZXR1cEJhbGxTYW5kYm94KCkgewogICAgY29uc3Qgcm9vdCA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQmFsbCBMYWIgKFRocm93ICYgUGh5c2ljcyknKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFNoYXJlZCBzdGF0ZSBvYmplY3QgKGxpdmVzIG9uIHdpbmRvdy5mbHV4IHNvIGl0IHN1cnZpdmVzIHJlbG9hZHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGxhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiIHx8IHt9OwogICAgbGFiLmdhbWUgPSB0aGlzLmdhbWU7CgogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7CiAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnOwoKICAgIGlmICghQyB8fCAhVEMpIHsKICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgTGFiOiBNaXNzaW5nIEJhbGxDb25maWcgb3IgVGhyb3dDb25maWcuIik7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSGVscGVycwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBnZXRCYWxsID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS5lbnRpdGllcyA/IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUudGVhbXMgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwoKICAgIGNvbnN0IGVuc3VyZVByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHJldHVybjsKICAgICAgICBpZiAoIXRoaXMuZ2FtZSB8fCAhdGhpcy5nYW1lLnNjZW5lKSByZXR1cm47CgogICAgICAgIGNvbnN0IGdlb20gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTGluZUJhc2ljTWF0ZXJpYWwoeyB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC45NSB9KTsKICAgICAgICBjb25zdCBsaW5lID0gbmV3IFRIUkVFLkxpbmUoZ2VvbSwgbWF0KTsKICAgICAgICBsaW5lLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICBsaW5lLnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQobGluZSk7CiAgICAgICAgbGFiLnByZXZpZXdMaW5lID0gbGluZTsKICAgIH07CgogICAgY29uc3QgY2xlYXJQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lICYmIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSkgewogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEEgc2FmZSAiZ2hvc3QgYmFsbCIgdGhhdCBjYW4gdXNlIEJhbGwudXBkYXRlRnJlZSB3aXRob3V0IHNwYXduaW5nIEZYCiAgICBjb25zdCBtYWtlR2hvc3RCYWxsID0gKHBvcywgdmVsLCBzcGluKSA9PiB7CiAgICAgICAgY29uc3QgZ2IgPSB7CiAgICAgICAgICAgIG1lc2g6IHsgcG9zaXRpb246IHBvcy5jbG9uZSgpIH0sCiAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwuY2xvbmUoKSwKICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiAoc3BpbiA/IHNwaW4uY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCkpLAogICAgICAgICAgICBhY2N1bXVsYXRlZFJvdGF0aW9uOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICBwb3dlcjogMCwKICAgICAgICAgICAgZGVjYXlSYXRlOiAwLAogICAgICAgICAgICBfYnViYmxlVGltZXI6IDk5OSwKICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICBkZWZvcm1Ob2RlOiBudWxsCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZ2I7CiAgICB9OwoKICAgIC8vIFVzZSBCYWxsLnVwZGF0ZUZyZWUgZm9yIGZhaXRoZnVsIHRyYWplY3RvcnkgcHJlZGljdGlvbgogICAgY29uc3Qgc2ltdWxhdGUgPSAoZ2hvc3RCYWxsLCBzdGVwcywgc3RlcER0KSA9PiB7CiAgICAgICAgY29uc3QgcHRzID0gW107CiAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgY29uc3QgcHJvdG8gPSB3aW5kb3cuZmx1eC5CYWxsICYmIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlOwogICAgICAgIGlmICghcHJvdG8gfHwgdHlwZW9mIHByb3RvLnVwZGF0ZUZyZWUgIT09ICdmdW5jdGlvbicpIHJldHVybiBwdHM7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RlcHM7IGkrKykgewogICAgICAgICAgICBwcm90by51cGRhdGVGcmVlLmNhbGwoZ2hvc3RCYWxsLCBzdGVwRHQpOwogICAgICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHB0czsKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQcmV2aWV3ICsgcmVjb3JkL3JlcGxheSBydW50aW1lIGxvb3AKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpsYWIucHJldmlldyA9IGxhYi5wcmV2aWV3IHx8IHsKICAgICAgICBlbmFibGVkOiBmYWxzZSwKICAgICAgICBzb3VyY2U6ICdDYW5ub24nLAogICAgICAgIHN0ZXBzOiAxMjAsCiAgICAgICAgc3RlcER0OiAxLzYwLAogICAgICAgIHJlZnJlc2hIejogMTAsCiAgICAgICAgc2hvd09uSGVsZE9ubHk6IGZhbHNlCiAgICB9OwoKbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBlbGVtZW50OiAnbm9uZScsCiAgICAgICAgc3Bpblg6IDAsCiAgICAgICAgc3Bpblk6IDAsCiAgICAgICAgc3Bpblo6IDAsCiAgICAgICAgZmlyZUJ1cnN0OiAxLAogICAgICAgIHNwcmVhZERlZzogMAogICAgfTsKICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgPT09IHVuZGVmaW5lZCkgbGFiLmNhbm5vbi5lbGVtZW50ID0gJ25vbmUnOwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CmFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ESVNUQU5DRScsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnogPSAtdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnogPSB2OwogICAgICAgIC8vIFVwZGF0ZSBEZWJ1ZyBWaXN1YWxzIGlmIGFjdGl2ZQogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQp9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ZX09GRlNFVCcsIC01MC4wLCAyMC4wKS5uYW1lKCdHb2FsIFkgUG9zJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi55ID0gdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnkgPSB2OwogICAgfSk7CiAgICBhcmVuYS5hZGQoQywgJ0dPQUxfU0NBTEUnLCAxLjAsIDEwMC4wKS5uYW1lKCdHb2FsIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5zY2FsZS5zZXRTY2FsYXIodik7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxCKSB3aW5kb3cuZmx1eC5nb2FsQi5zY2FsZS5zZXRTY2FsYXIodik7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIAogICAgY29uc3QgZWxlbVR5cGVzID0gWydub25lJywgJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCcsICdzcGhlcmUnLCAnamVjaHQnLCAnaW52aXNpYmxlJ107CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdlbGVtZW50JywgZWxlbVR5cGVzKS5uYW1lKCdFbGVtZW50Jyk7CgogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB0ZWNoID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgJiYgbGFiLmNhbm5vbi5lbGVtZW50ICE9PSAnbm9uZScpIHsKICAgICAgICAgICAgICAgICAgICB0ZWNoID0geyB0eXBlOiBsYWIuY2Fubm9uLmVsZW1lbnQsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCB0ZWNoLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","/DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCidHT0FMX0RJU1RBTkNFJzogIkRpc3RhbmNlIG9mIHRoZSBnb2FscyBmcm9tIHRoZSBjZW50ZXIgKFotYXhpcykuIiwKICAgICAgICAnc2NhbmxpbmUnOiAiU3RyZW5ndGggb2YgdGhlIENSVCBzY2FubGluZSBlZmZlY3QuIiwKICAgICAgICAndmlnbmV0dGUnOiAiRGFya2VuaW5nIG9mIHRoZSBzY3JlZW4gY29ybmVycy4iLAogICAgICAgICdub2lzZSc6ICJGaWxtIGdyYWluIGludGVuc2l0eS4iLAogICAgICAgICdhYmVycmF0aW9uJzogIlJHQiBjb2xvciBzZXBhcmF0aW9uIG9mZnNldCAoQ2hyb21hdGljIEFiZXJyYXRpb24pLiIsCiAgICAgICAgJ2NvbnRyYXN0JzogIkdsb2JhbCBjb250cmFzdCBhZGp1c3RtZW50LiIsCiAgICAgICAgJ3NhdHVyYXRpb24nOiAiR2xvYmFsIGNvbG9yIHNhdHVyYXRpb24gYWRqdXN0bWVudC4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwp0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVGhlbWVzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwp0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUG9zdFByb2Nlc3NpbmcoKTsKLy8gRHVwbGljYXRlIHJlbW92ZWQKICAgICAgICAgICAgdGhpcy5fc2V0dXBSdW50aW1lTW9uaXRvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7Cgp9CiAgICAgICAgX3NldHVwUnVudGltZU1vbml0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUnVudGltZSBNb25pdG9yJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgRE9NIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm1vbml0b3JFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICAgICAgICB0b3A6ICc4MHB4JywgCiAgICAgICAgICAgICAgICBsZWZ0OiAnMTBweCcsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnOHB4JywKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICdyZ2JhKDAsIDAsIDAsIDAuOCknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMXB4IHNvbGlkICMwMGZmMDAnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjMDBmZjAwJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxMXB4JywKICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ6ICcxLjQnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgbWluV2lkdGg6ICcxNTBweCcsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc0cHgnLAogICAgICAgICAgICAgICAgdGV4dFNoYWRvdzogJzFweCAxcHggMCAjMDAwJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLm1vbml0b3JFbCk7CgogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBzaG93T3ZlcmxheTogZmFsc2UKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnc2hvd092ZXJsYXknKS5uYW1lKCdTaG93IE92ZXJsYXknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMubW9uaXRvckVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCB1cGRhdGUgbG9vcAogICAgICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLnNob3dPdmVybGF5KSB0aGlzLl91cGRhdGVNb25pdG9yKCk7CiAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVNb25pdG9yKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IGdtLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBsZXQgaHRtbCA9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgZm9udC13ZWlnaHQ6Ym9sZDsgY29sb3I6I2ZmZiI+R0FNRSBTVEFURTwvZGl2PmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6I2ZmZiI+JHtnbS5zdGF0ZX08L3NwYW4+PGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlIFRpbWVyOiAke2dtLnN0YXRlVGltZXIudG9GaXhlZCgyKX1zPGJyPmA7CiAgICAgICAgICAgIGh0bWwgKz0gYE1hdGNoIFRpbWU6ICR7TWF0aC5mbG9vcihnbS50aW1lLzYwKX06JHtNYXRoLmZsb29yKGdtLnRpbWUlNjApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwnMCcpfSAoSCR7Z20uaGFsZn0pPGJyPmA7CiAgICAgICAgICAgIAogICAgICAgICAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJib3JkZXItYm90dG9tOjFweCBzb2xpZCAjNDQ0OyBtYXJnaW4tYm90dG9tOjRweDsgbWFyZ2luLXRvcDo4cHg7IGZvbnQtd2VpZ2h0OmJvbGQ7IGNvbG9yOiNmZmYiPkJBTEw8L2Rpdj5gOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlQ29sb3IgPSBiYWxsLnN0YXRlID09PSAnZnJlZScgPyAnIzBhZicgOiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnID8gJyNmYTAnIDogJyNmMGYnKTsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFN0YXRlOiA8c3BhbiBzdHlsZT0iY29sb3I6JHtzdGF0ZUNvbG9yfSI+JHtiYWxsLnN0YXRlfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IGhvbGRlclN0ciA9ICdOb25lJzsKICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLnJvbGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVhbSA9IGJhbGwuaG9sZGVyLnRlYW0gPyBiYWxsLmhvbGRlci50ZWFtLmlkLnRvVXBwZXJDYXNlKCkgOiAnPyc7CiAgICAgICAgICAgICAgICAgICAgaG9sZGVyU3RyID0gYCR7bmFtZX0gKCR7dGVhbX0pYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGh0bWwgKz0gYEhvbGRlcjogPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmYiPiR7aG9sZGVyU3RyfTwvc3Bhbj48YnI+YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcCA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYFBvczogJHtwLngudG9GaXhlZCgxKX0sICR7cC55LnRvRml4ZWQoMSl9LCAke3Auei50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgaHRtbCArPSBgU3BlZWQ6ICR7YmFsbC52ZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfTxicj5gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICBodG1sICs9IGBQb3dlcjogJHtiYWxsLnBvd2VyLnRvRml4ZWQoMSl9ICgke2JhbGwucG93ZXJUeXBlfSk8YnI+YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGh0bWwgKz0gYE9GRkxJTkU8YnI+YDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tb25pdG9yRWwuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRvb2x0aXBzKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgVG9vbHRpcCBET00KICAgICAgICAgICAgdGhpcy50b29sdGlwRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRvb2x0aXBFbC5zdHlsZSwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICAgICAgICAgICAgICB0b3A6ICc1MCUnLAogICAgICAgICAgICAgICAgbGVmdDogJzUwJScsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoLTUwJSwgLTUwJSknLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLCAxMCwgMzAsIDAuOTUpJywKICAgICAgICAgICAgICAgIGJvcmRlcjogJzJweCBzb2xpZCAjMDBmZmZmJywKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICcyMHB4JywKICAgICAgICAgICAgICAgIGNvbG9yOiAnI2ZmZicsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAnbW9ub3NwYWNlJywKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAnMTRweCcsCiAgICAgICAgICAgICAgICBtYXhXaWR0aDogJzMwMHB4JywKICAgICAgICAgICAgICAgIHpJbmRleDogJzEwMDAwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJywKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJywKICAgICAgICAgICAgICAgIGJveFNoYWRvdzogJzAgMCAyMHB4IHJnYmEoMCwgMjU1LCAyNTUsIDAuMyknLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnOHB4JywKICAgICAgICAgICAgICAgIHRleHRBbGlnbjogJ2NlbnRlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwRWwpOwoKICAgICAgICAgICAgLy8gUmVjdXJzaXZlIGZ1bmN0aW9uIHRvIGF0dGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgY29uc3QgYXR0YWNoID0gKGd1aSkgPT4gewogICAgICAgICAgICAgICAgLy8gQ29udHJvbGxlcnMKICAgICAgICAgICAgICAgIGlmIChndWkuY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuY29udHJvbGxlcnMuZm9yRWFjaChjID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9tID0gYy5kb21FbGVtZW50LmNsb3Nlc3QoJy5jb250cm9sbGVyJyk7IC8vIGxpbC1ndWkgc3RydWN0dXJlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBkb20ucXVlcnlTZWxlY3RvcignLm5hbWUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWRkTG9uZ1ByZXNzKGxhYmVsLCBjLnByb3BlcnR5LCBjLl9uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gU3ViLWZvbGRlcnMKICAgICAgICAgICAgICAgIGlmKGd1aS5mb2xkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmZvbGRlcnMuZm9yRWFjaChmID0+IGF0dGFjaChmKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBXYWl0IGEgdGljayBmb3IgR1VJIHRvIGZ1bGx5IHJlbmRlciBET00KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBhdHRhY2godGhpcy5ndWkpLCAxMDApOwogICAgICAgIH0KCiAgICAgICAgX2FkZExvbmdQcmVzcyhlbGVtZW50LCBwcm9wZXJ0eSwgbmFtZSkgewogICAgICAgICAgICBsZXQgdGltZXIgPSBudWxsOwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IDUwMDsgLy8gMC41cwoKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93VG9vbHRpcChwcm9wZXJ0eSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aW1lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faGlkZVRvb2x0aXAoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgc3RhcnQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBzdGFydCwge3Bhc3NpdmU6IHRydWV9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgZW5kKTsKICAgICAgICB9CgogICAgICAgIF9zaG93VG9vbHRpcChwcm9wLCBuYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGRlc2MgPSBUT09MVElQX0RFU0NSSVBUSU9OU1twcm9wXTsKICAgICAgICAgICAgaWYoZGVzYykgewogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuaW5uZXJIVE1MID0gYDxzdHJvbmcgc3R5bGU9ImNvbG9yOiMwMGZmZmY7IGZvbnQtc2l6ZToxNnB4OyI+JHtuYW1lIHx8IHByb3B9PC9zdHJvbmc+PGJyPjxicj4ke2Rlc2N9YDsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaGlkZVRvb2x0aXAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRvb2x0aXBFbCkgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CgoKX3NldHVwR2VuZXJhbCgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHZW5lcmFsJyk7CiAgICAgICAgICAgIApjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICB0aW1lU2NhbGU6IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSwKICAgICAgICAgICAgICAgIGRlbW9Nb2RlOiB0aGlzLmdhbWUuaXNEZW1vTW9kZSwKICAgICAgICAgICAgICAgIHRvZ2dsZUhVRDogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlc29sdXRpb246IDAuNTAsCmFyZW5hT3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgYXJlbmEyT3BhY2l0eTogMC4yNQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0aW1lU2NhbGUnLCAwLjAsIDUuMCkubmFtZSgnR2FtZSBTcGVlZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgd2luZG93LmZsdXgudGltZVNjYWxlID0gdjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2RlbW9Nb2RlJykubmFtZSgnRGVtbyBNb2RlJykubGlzdGVuKCkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlzRGVtb01vZGUgIT09IHYpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RvZ2dsZUhVRCcpLm5hbWUoJ1Nob3cgSFVEJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgICAgIGlmIChodWQpIHsKICAgICAgICAgICAgICAgICAgICBodWQuc3R5bGUudmlzaWJpbGl0eSA9IHYgPyAndmlzaWJsZScgOiAnaGlkZGVuJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc29sdXRpb24nLCAwLjEsIDIuMCkubmFtZSgnUmVzb2x1dGlvbiBTY2FsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdyA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgaCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVyID0gdGhpcy5nYW1lLnJlbmRlcmVyOwogICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSh3ICogdiwgaCAqIHYsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7Cgpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAxIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKcGFyYW1zLmFyZW5hQmxlbmQgPSAnTm9ybWFsJzsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAxIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcmVuYSAyIENvbnRyb2xzCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyT3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdBcmVuYSAyIE9wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCnBhcmFtcy5hcmVuYTJCbGVuZCA9ICdBZGRpdGl2ZSc7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmEyQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMiBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IGRlZmF1bHRzCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYU9wYWNpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hMk9wYWNpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBBcmVuYSBHcmFwaGljcyBDb250cm9scyAtLS0KICAgICAgICAgICAgdGhpcy5fc2V0dXBBcmVuYUdyYXBoaWNzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBBcmVuYUdyYXBoaWNzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0FyZW5hIEdyYXBoaWNzJyk7CgogICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gLS0tIEJsdWUgQmFuZCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmx1ZSBCYW5kJyk7CiAgICAgICAgICAgICAgICBjb25zdCBibHVlUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCA/IHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCkgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBibHVlRm9sZGVyLmFkZChibHVlUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWF0KSB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBHb2xkIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29sZEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0dvbGQgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgZ29sZFBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgfHwgMC4zNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ05vcm1hbCcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNZXNoKSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdvbGRGb2xkZXIuYWRkKGdvbGRQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFllbGxvdyBBcnJvd3MgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdZZWxsb3cgQXJyb3dzJyk7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJvd1BhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwID8gd2luZG93LmZsdXguYXJyb3dHcm91cC52aXNpYmxlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5hcnJvd01hdC5vcGFjaXR5IHx8IDAuOCwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFycm93R3JvdXApIHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFycm93Rm9sZGVyLmFkZChhcnJvd1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd01hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcnJvd01hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBGbG9vciBHbHlwaCAtLS0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignRmxvb3IgR2x5cGgnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29yUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoID8gd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gudmlzaWJsZSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZsb29yRm9sZGVyLmFkZChmbG9vclBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0LmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwT3ZlcmxheXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignT3ZlcmxheXMgJiBGWCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gR0lGIE92ZXJsYXkKICAgICAgICAgICAgY29uc3QgZ2lmRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyZWVuLW92ZXJsYXktZ2lmJyk7CiAgICAgICAgICAgIGlmIChnaWZFbCkgewogICAgICAgICAgICAgICAgY29uc3QgZ2lmUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCm9wYWNpdHk6IDAuNjIsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdvdmVybGF5JwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1NjcmVlbiBHSUYnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLmRpc3BsYXkgPSB2ID8gJ2Jsb2NrJyA6ICdub25lJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUub3BhY2l0eSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gWwogICAgICAgICAgICAgICAgICAgICdub3JtYWwnLCAnbXVsdGlwbHknLCAnc2NyZWVuJywgJ292ZXJsYXknLCAKICAgICAgICAgICAgICAgICAgICAnZGFya2VuJywgJ2xpZ2h0ZW4nLCAnY29sb3ItZG9kZ2UnLCAnY29sb3ItYnVybicsIAogICAgICAgICAgICAgICAgICAgICdoYXJkLWxpZ2h0JywgJ3NvZnQtbGlnaHQnLCAnZGlmZmVyZW5jZScsICdleGNsdXNpb24nLCAKICAgICAgICAgICAgICAgICAgICAnaHVlJywgJ3NhdHVyYXRpb24nLCAnY29sb3InLCAnbHVtaW5vc2l0eScKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICdibGVuZCcsIGJsZW5kTW9kZXMpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUubWl4QmxlbmRNb2RlID0gdik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFdhdGVyIE92ZXJsYXkKICAgICAgICAgICAgY29uc3Qgd28gPSB0aGlzLmdhbWUud2F0ZXJPdmVybGF5OwogICAgICAgICAgICBpZiAod28gJiYgd28ubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3Qgd0ZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1dhdGVyIFNoYWRlcicpOwogICAgICAgICAgICAgICAgY29uc3Qgd1BhcmFtcyA9IHsgCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSA/IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlIDogMC41LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gd28ubWVzaC52aXNpYmxlID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eSkgewogICAgICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAyLjApLm9uQ2hhbmdlKHYgPT4gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgPSB2KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0aHJlZUJsZW5kcyA9IHsKICAgICAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLmJsZW5kaW5nID0gdGhyZWVCbGVuZHNbdl07CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICBjb25zdCBscyA9IHRoaXMuZ2FtZS5saWdodFNoYWZ0czsKICAgICAgICAgICAgaWYgKGxzICYmIGxzLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgY29uc3QgbFBhcmFtcyA9IHsgdmlzaWJsZTogdHJ1ZSB9OwogICAgICAgICAgICAgICAgZm9sZGVyLmFkZChsUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ0xpZ2h0IFNoYWZ0cycpLm9uQ2hhbmdlKHYgPT4gbHMuY29udGFpbmVyLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cEdhbWVTdGF0ZSgpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdHYW1lIFN0YXRlJyk7CiAgICAgICAgICAgIGNvbnN0IGdtID0gdGhpcy5nYW1lOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZm9yY2VIb21lR29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2hvbWUnKTsgCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VBd2F5R29hbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmdvYWxTY29yZWQoJ2F3YXknKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUhhbGZ0aW1lOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5lbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVzZXRSb3VuZDogKCkgPT4gZ20ucmVzZXRSb3VuZCgpLAogICAgICAgICAgICAgICAgZXhpdFRvTWVudTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIb21lR29hbCcpLm5hbWUoJ1RyaWdnZXIgSG9tZSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VBd2F5R29hbCcpLm5hbWUoJ1RyaWdnZXIgQXdheSBHb2FsJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZm9yY2VIYWxmdGltZScpLm5hbWUoJ0ZvcmNlIEhhbGZ0aW1lJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzZXRSb3VuZCcpLm5hbWUoJ1Jlc2V0IFJvdW5kJyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZXhpdFRvTWVudScpLm5hbWUoJ0V4aXQgdG8gTWVudScpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVGVhbXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVGVhbXMnKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmdhbWUudGVhbXMuaG9tZSB8fCAhdGhpcy5nYW1lLnRlYW1zLmF3YXkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwoKICAgICAgICAgICAgLy8gSG9tZQogICAgICAgICAgICBjb25zdCBoRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignSG9tZSBUZWFtJyk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKICAgICAgICAgICAgLy8gQXdheQogICAgICAgICAgICBjb25zdCBhRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQXdheSBUZWFtJyk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdpc0h1bWFuJykubmFtZSgnSXMgSHVtYW4gQ29udHJvbGxlZCcpLmxpc3RlbigpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnYWlFbmFibGVkJykubmFtZSgnQUkgTG9naWMgRW5hYmxlZCcpLmxpc3RlbigpOwoKfQoKICAgICAgICBfc2V0dXBUaGVtZXMoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXJlbmEgVGhlbWVzJyk7CiAgICAgICAgICAgIGNvbnN0IGF0bSA9IHRoaXMuZ2FtZS5hcmVuYVRoZW1lTWFuYWdlcjsKICAgICAgICAgICAgaWYgKCFhdG0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHRoZW1lcyA9IE9iamVjdC5rZXlzKHdpbmRvdy5mbHV4LlRIRU1FUyB8fCB7fSk7CiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRoZW1lOiBhdG0uY3VycmVudFRoZW1lLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogdGhpcy5nYW1lLnNjZW5lLmZvZyA/IHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA6IDAuMDAwMSwKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5XQVRFUl9EUkFHX0xJTkVBUiA6IDAuMTUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGhlbWUnLCB0aGVtZXMpLm5hbWUoJ1NlbGVjdCBUaGVtZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgYXRtLnNldFRoZW1lKHYpOwogICAgICAgICAgICAgICAgLy8gU3luYyBwYXJhbXMgdG8gbmV3IHRoZW1lIGRlZmF1bHRzCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNjZW5lLmZvZykgcGFyYW1zLmZvZ0RlbnNpdHkgPSB0aGlzLmdhbWUuc2NlbmUuZm9nLmRlbnNpdHk7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbENvbmZpZykgcGFyYW1zLndhdGVyRHJhZyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgbGl2ZSA9IGZvbGRlci5hZGRGb2xkZXIoJ0xpdmUgVHdlYWtzJyk7CiAgICAgICAgICAgIGxpdmUuYWRkKHBhcmFtcywgJ2ZvZ0RlbnNpdHknLCAwLCAwLjA1KS5uYW1lKCdGb2cgRGVuc2l0eScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zY2VuZS5mb2cpIHRoaXMuZ2FtZS5zY2VuZS5mb2cuZGVuc2l0eSA9IHY7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsaXZlLmFkZChwYXJhbXMsICd3YXRlckRyYWcnLCAwLCAxLjApLm5hbWUoJ1dhdGVyIERyYWcnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLldBVEVSX0RSQUdfTElORUFSID0gdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQpfc2V0dXBQbGF5ZXJJbnNwZWN0b3IoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignUGxheWVyIEluc3BlY3RvciAoSG9tZSBBY3RpdmUpJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZWxwZXIgdG8gZ2V0IGN1cnJlbnQgYWN0aXZlIHBsYXllciBzYWZlbHkKICAgICAgICAgICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLmdhbWUudGVhbXMuaG9tZSAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIAogICAgICAgICAgICAgICAgICAgID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIAogICAgICAgICAgICAgICAgICAgIDogbnVsbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFByb3h5IG9iamVjdCB0byBiaW5kIEdVSSB0byBkeW5hbWljIHRhcmdldAogICAgICAgICAgICBjb25zdCBwcm94eSA9IHsKICAgICAgICAgICAgICAgIGdldCBSb2xlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnJvbGUgOiAnLSc7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEdvZE1vZGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuaXNHb2RNb2RlIDogZmFsc2U7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBHb2RNb2RlKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuaXNHb2RNb2RlID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIFJ1bnRpbWUgVmFsdWVzCiAgICAgICAgICAgICAgICBnZXQgSFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuSFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgSFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5IUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZ2V0IEN1cnJlbnRFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5jdXJyZW50RU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ3VycmVudEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuY3VycmVudEVOID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEJhc2UgU3RhdHMKICAgICAgICAgICAgICAgIGdldCBNYXhIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5tYXhIUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBNYXhIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLm1heEhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLlNQID0gdjsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuX3VwZGF0ZURlcml2ZWRTdGF0cygpOyAKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgRU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuRU4gOiAwOyAKICAgICAgICAgICAgICAgIH0sIAogICAgICAgICAgICAgICAgc2V0IEVOKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IHY7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQVQoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQVQgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQVQodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5BVCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgUEEoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuUEEgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgUEEodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5QQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQkwoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQkwgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQkwodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5CTCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU0goKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU0ggOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU0godikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5TSCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgQ0EoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuQ0EgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgQ0EodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5DQSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBBY3Rpb25zCiAgICAgICAgICAgICAgICBMZXZlbFVwOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmxldmVsVXAoKTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRnVsbEhlYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyAKICAgICAgICAgICAgICAgICAgICBpZihwKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5nZXRTdGF0KCdFTicpOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBwLnN0YXR1cy53aXRoZXIpIHAuc3RhdHVzLndpdGhlcltrXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZVTEwgSEVBTCIsIHAubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRHJhaW5FTjogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZnVtYmxlKCk7IC8vIFRyaWdnZXIgZnVtYmxlIGxvZ2ljCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ1JvbGUnKS5saXN0ZW4oKS5kaXNhYmxlKCk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdHb2RNb2RlJykubmFtZSgnR29kIE1vZGUgKEluZiBIUC9FTiknKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHJ0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignUnVudGltZSBTdGF0dXMnKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnSFAnLCAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgcnRGb2xkZXIuYWRkKHByb3h5LCAnQ3VycmVudEVOJywgMCwgMTAwKS5uYW1lKCdDdXJyZW50IEVOJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBzdGF0Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQmFzZSBTdGF0cycpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ01heEhQJywgMTAwLCA5OTk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdFTicsIDAsIDk5KS5uYW1lKCdNYXggRU4nKS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTUCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdBVCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdQQScsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdCTCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdTSCcsIDAsIDk5KS5saXN0ZW4oKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdDQScsIDAsIDk5KS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IGFjdGlvbkZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0FjdGlvbnMnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0xldmVsVXAnKS5uYW1lKCdJbnN0YW50IExldmVsIFVwJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdGdWxsSGVhbCcpLm5hbWUoJ0Z1bGwgSGVhbCAmIEN1cmUnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0RyYWluRU4nKS5uYW1lKCdEcmFpbiBFTiAoRnVtYmxlKScpOwogICAgICAgIH0KCl9zZXR1cEJhbGxTYW5kYm94KCkgewogICAgY29uc3Qgcm9vdCA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQmFsbCBMYWIgKFRocm93ICYgUGh5c2ljcyknKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFNoYXJlZCBzdGF0ZSBvYmplY3QgKGxpdmVzIG9uIHdpbmRvdy5mbHV4IHNvIGl0IHN1cnZpdmVzIHJlbG9hZHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGxhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiIHx8IHt9OwogICAgbGFiLmdhbWUgPSB0aGlzLmdhbWU7CgogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7CiAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnOwoKICAgIGlmICghQyB8fCAhVEMpIHsKICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgTGFiOiBNaXNzaW5nIEJhbGxDb25maWcgb3IgVGhyb3dDb25maWcuIik7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSGVscGVycwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBnZXRCYWxsID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS5lbnRpdGllcyA/IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUudGVhbXMgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwoKICAgIGNvbnN0IGVuc3VyZVByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHJldHVybjsKICAgICAgICBpZiAoIXRoaXMuZ2FtZSB8fCAhdGhpcy5nYW1lLnNjZW5lKSByZXR1cm47CgogICAgICAgIGNvbnN0IGdlb20gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTGluZUJhc2ljTWF0ZXJpYWwoeyB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC45NSB9KTsKICAgICAgICBjb25zdCBsaW5lID0gbmV3IFRIUkVFLkxpbmUoZ2VvbSwgbWF0KTsKICAgICAgICBsaW5lLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICBsaW5lLnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQobGluZSk7CiAgICAgICAgbGFiLnByZXZpZXdMaW5lID0gbGluZTsKICAgIH07CgogICAgY29uc3QgY2xlYXJQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lICYmIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSkgewogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEEgc2FmZSAiZ2hvc3QgYmFsbCIgdGhhdCBjYW4gdXNlIEJhbGwudXBkYXRlRnJlZSB3aXRob3V0IHNwYXduaW5nIEZYCiAgICBjb25zdCBtYWtlR2hvc3RCYWxsID0gKHBvcywgdmVsLCBzcGluKSA9PiB7CiAgICAgICAgY29uc3QgZ2IgPSB7CiAgICAgICAgICAgIG1lc2g6IHsgcG9zaXRpb246IHBvcy5jbG9uZSgpIH0sCiAgICAgICAgICAgIHZlbG9jaXR5OiB2ZWwuY2xvbmUoKSwKICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiAoc3BpbiA/IHNwaW4uY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCkpLAogICAgICAgICAgICBhY2N1bXVsYXRlZFJvdGF0aW9uOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICBwb3dlcjogMCwKICAgICAgICAgICAgZGVjYXlSYXRlOiAwLAogICAgICAgICAgICBfYnViYmxlVGltZXI6IDk5OSwKICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICBkZWZvcm1Ob2RlOiBudWxsCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZ2I7CiAgICB9OwoKICAgIC8vIFVzZSBCYWxsLnVwZGF0ZUZyZWUgZm9yIGZhaXRoZnVsIHRyYWplY3RvcnkgcHJlZGljdGlvbgogICAgY29uc3Qgc2ltdWxhdGUgPSAoZ2hvc3RCYWxsLCBzdGVwcywgc3RlcER0KSA9PiB7CiAgICAgICAgY29uc3QgcHRzID0gW107CiAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgY29uc3QgcHJvdG8gPSB3aW5kb3cuZmx1eC5CYWxsICYmIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlOwogICAgICAgIGlmICghcHJvdG8gfHwgdHlwZW9mIHByb3RvLnVwZGF0ZUZyZWUgIT09ICdmdW5jdGlvbicpIHJldHVybiBwdHM7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RlcHM7IGkrKykgewogICAgICAgICAgICBwcm90by51cGRhdGVGcmVlLmNhbGwoZ2hvc3RCYWxsLCBzdGVwRHQpOwogICAgICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHB0czsKICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQcmV2aWV3ICsgcmVjb3JkL3JlcGxheSBydW50aW1lIGxvb3AKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpsYWIucHJldmlldyA9IGxhYi5wcmV2aWV3IHx8IHsKICAgICAgICBlbmFibGVkOiBmYWxzZSwKICAgICAgICBzb3VyY2U6ICdDYW5ub24nLAogICAgICAgIHN0ZXBzOiAxMjAsCiAgICAgICAgc3RlcER0OiAxLzYwLAogICAgICAgIHJlZnJlc2hIejogMTAsCiAgICAgICAgc2hvd09uSGVsZE9ubHk6IGZhbHNlCiAgICB9OwoKbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBlbGVtZW50OiAnbm9uZScsCiAgICAgICAgc3Bpblg6IDAsCiAgICAgICAgc3Bpblk6IDAsCiAgICAgICAgc3Bpblo6IDAsCiAgICAgICAgZmlyZUJ1cnN0OiAxLAogICAgICAgIHNwcmVhZERlZzogMAogICAgfTsKICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgPT09IHVuZGVmaW5lZCkgbGFiLmNhbm5vbi5lbGVtZW50ID0gJ25vbmUnOwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CmFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ESVNUQU5DRScsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEEpIHdpbmRvdy5mbHV4LmdvYWxBLnBvc2l0aW9uLnogPSAtdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnogPSB2OwogICAgICAgIC8vIFVwZGF0ZSBEZWJ1ZyBWaXN1YWxzIGlmIGFjdGl2ZQogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQp9KTsKICAgIGFyZW5hLmFkZChDLCAnR09BTF9ZX09GRlNFVCcsIC01MC4wLCAyMC4wKS5uYW1lKCdHb2FsIFkgUG9zJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi55ID0gdjsKICAgICAgICBpZiAod2luZG93LmZsdXguZ29hbEIpIHdpbmRvdy5mbHV4LmdvYWxCLnBvc2l0aW9uLnkgPSB2OwogICAgfSk7CiAgICBhcmVuYS5hZGQoQywgJ0dPQUxfU0NBTEUnLCAxLjAsIDEwMC4wKS5uYW1lKCdHb2FsIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5zY2FsZS5zZXRTY2FsYXIodik7CiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxCKSB3aW5kb3cuZmx1eC5nb2FsQi5zY2FsZS5zZXRTY2FsYXIodik7CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNvbnN0IGNhbm5vbiA9IHJvb3QuYWRkRm9sZGVyKCdTaG90IENhbm5vbicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAneWF3JywgLTE4MCwgMTgwLCAxKS5uYW1lKCdZYXcgKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3BpdGNoJywgLTg5LCA4OSwgMSkubmFtZSgnUGl0Y2ggKGRlZyknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3Bvd2VyJywgMCwgMTIwLCAwLjEpLm5hbWUoJ1Bvd2VyJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd0eXBlJywgWydQQScsJ1NIJ10pLm5hbWUoJ1R5cGUnKTsKICAgIAogICAgY29uc3QgZWxlbVR5cGVzID0gWydub25lJywgJ2ZpcmUnLCAnaWNlJywgJ3ZvbHQnLCAndmVub20nLCAnd2l0aGVyJywgJ25hcCcsICdzcGhlcmUnLCAnamVjaHQnLCAnaW52aXNpYmxlJ107CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdlbGVtZW50JywgZWxlbVR5cGVzKS5uYW1lKCdFbGVtZW50Jyk7CgogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB0ZWNoID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLmVsZW1lbnQgJiYgbGFiLmNhbm5vbi5lbGVtZW50ICE9PSAnbm9uZScpIHsKICAgICAgICAgICAgICAgICAgICB0ZWNoID0geyB0eXBlOiBsYWIuY2Fubm9uLmVsZW1lbnQsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5zaG9vdChkaXIsIGxhYi5jYW5ub24ucG93ZXIgfHwgMjAsIGxhYi5jYW5ub24udHlwZSB8fCAnU0gnLCB0ZWNoLCBzcGluKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBjYW5ub24uYWRkKGZpcmVQYXJhbXMsICdGaXJlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRyYWplY3RvcnkgUHJldmlldwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmV2aWV3ID0gcm9vdC5hZGRGb2xkZXIoJ1RyYWplY3RvcnkgUHJldmlldycpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdlbmFibGVkJykubmFtZSgnRW5hYmxlZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc291cmNlJywgWydDYW5ub24nLCAnTGl2ZSBCYWxsJ10pLm5hbWUoJ1NvdXJjZScpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcHMnLCAxMCwgNjAwLCAxKS5uYW1lKCdTdGVwcycpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc3RlcER0JywgMS8yNDAsIDEvMTUsIDEvMjQwKS5uYW1lKCdTdGVwIGR0Jykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdyZWZyZXNoSHonLCAxLCA2MCwgMSkubmFtZSgnUmVmcmVzaCBIeicpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzaG93T25IZWxkT25seScpLm5hbWUoJ09ubHkgd2hlbiBIZWxkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwoKICAgIGNvbnN0IHByZXZpZXdCdG5zID0gewogICAgICAgIFJlZnJlc2g6ICgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpLAogICAgICAgIEhpZGU6ICgpID0+IHsgbGFiLnByZXZpZXcuZW5hYmxlZCA9IGZhbHNlOyBjbGVhclByZXZpZXdMaW5lKCk7IH0KICAgIH07CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ1JlZnJlc2gnKTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnSGlkZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBSZWNvcmQgLyBSZXBsYXkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcnIgPSByb290LmFkZEZvbGRlcignUmVjb3JkIC8gUmVwbGF5Jyk7CiAgICBjb25zdCByclBhcmFtcyA9IHsKICAgICAgICBSZWNvcmQ6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgfSwKICAgICAgICBTdG9wOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIFVzZVJlY29yZGluZ0ZvclJlcGxheTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IChsYWIucmVjb3JkaW5nLmZyYW1lcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGxheTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIGxhYi50YXJnZXRCYWxsID0gYjsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgIH0sCiAgICAgICAgUGF1c2U6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIENsZWFyOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gW107CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICAgICAgbGFiLnJlcGxheS5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9OwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUmVjb3JkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdTdG9wJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdVc2VSZWNvcmRpbmdGb3JSZXBsYXknKS5uYW1lKCdDb3B5IFJlYyAtPiBSZXBsYXknKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnbG9vcCcpLm5hbWUoJ0xvb3AnKTsKICAgIHJyLmFkZChsYWIucmVwbGF5LCAnc3BlZWQnLCAwLjI1LCA2LjAsIDAuMjUpLm5hbWUoJ1JlcGxheSBTcGVlZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGxheScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnUGF1c2UnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ0NsZWFyJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFByZXNldHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJlc2V0cyA9IHJvb3QuYWRkRm9sZGVyKCdQcmVzZXRzJyk7CiAgICBjb25zdCBQID0gewogICAgICAgIFZhbmlsbGE6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBTVUJTVEVQUzogMiwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNDAsCiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDYwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgICAgICAgICAgREVQVEhfU1BSSU5HOiAxLjAsCiAgICAgICAgICAgICAgICBERVBUSF9EQU1QOiAxLjUsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9SQURJVVM6IDMzLjAsCiAgICAgICAgICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDE1LjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfQlVGRkVSOiAzLjAsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsCiAgICAgICAgICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsCiAgICAgICAgICAgICAgICBXQUxMX0ZSSUNUSU9OOiAwLjk1LAogICAgICAgICAgICAgICAgRkxPT1JfRUxBU1RJQ0lUWTogMC40MCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWjogMjUuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1JBRElVUzogNDUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogODUuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBBcmNhZGVDdXJ2ZTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjE2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogOTAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjEyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMSwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMzUuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDExMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKFRDLCB7CiAgICAgICAgICAgICAgICBDVVJWRV9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9TQ0FMRTogMTUwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDMwMDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1BFUkZFQ1RfU1BJTjogNzAwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgU25hcHB5UmVhbGlzdGljOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDA2LAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA1LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNDAuMCwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC43NSwKICAgICAgICAgICAgICAgIFNUT1BfU1BFRUQ6IDAuMDUsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA3MC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9CiAgICB9OwogICAgcHJlc2V0cy5hZGQoUCwgJ1ZhbmlsbGEnKTsKICAgIHByZXNldHMuYWRkKFAsICdBcmNhZGVDdXJ2ZScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ1NuYXBweVJlYWxpc3RpYycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTbmFwc2hvdCAvIEV4cG9ydAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBzbmFwc2hvdCA9IHJvb3QuYWRkRm9sZGVyKCdTbmFwc2hvdCAvIEV4cG9ydCcpOwoKICAgIGNvbnN0IF9yb3VuZCA9IChuLCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcGxhY2VzKTsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChuICogcCkgLyBwOwogICAgfTsKCiAgICBjb25zdCBfdjMgPSAodiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghdikgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIFtfcm91bmQodi54LCBwbGFjZXMpLCBfcm91bmQodi55LCBwbGFjZXMpLCBfcm91bmQodi56LCBwbGFjZXMpXTsKICAgIH07CgogICAgY29uc3QgX2Nsb25lSnNvbiA9IChvYmopID0+IHsKICAgICAgICBpZiAoIW9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdHJ5IHsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgIH07CgogICAgY29uc3QgX3BsYXllclNuYXAgPSAocCkgPT4gewogICAgICAgIGlmICghcCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYW5pbSA9IChwLmFjdGl2ZUFjdGlvbiAmJiBwLmFjdGl2ZUFjdGlvbi5fY2xpcCkgPyBwLmFjdGl2ZUFjdGlvbi5fY2xpcC5uYW1lIDogKHAuc3RhdGUgfHwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmFtZTogcC5jaGFyYWN0ZXJOYW1lIHx8IHAubmFtZSB8fCBudWxsLAogICAgICAgICAgICByb2xlOiBwLnJvbGUgfHwgbnVsbCwKICAgICAgICAgICAgc3RhdGU6IHAuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaGFzQmFsbDogISFwLmhhc0JhbGwsCiAgICAgICAgICAgIGlzVGhyb3dpbmc6ICEhcC5pc1Rocm93aW5nLAogICAgICAgICAgICBpc0NoYXJnaW5nOiAhIXAuaXNDaGFyZ2luZywKICAgICAgICAgICAgaXNEYXNoaW5nOiAhIXAuaXNEYXNoaW5nLAogICAgICAgICAgICBkYXNoQ29vbGRvd246IF9yb3VuZChwLmRhc2hDb29sZG93biwgNCksCiAgICAgICAgICAgIHBvczogX3YzKHAubWVzaCAmJiBwLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhwLnZlbG9jaXR5KSwKICAgICAgICAgICAgaW5wdXQ6IF92MyhwLmlucHV0VmVjdG9yKSwKICAgICAgICAgICAgc3RhdHM6IHAuc3RhdHMgPyBfY2xvbmVKc29uKHAuc3RhdHMpIDogbnVsbCwKICAgICAgICAgICAgYW5pbQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF90ZWFtU25hcCA9ICh0KSA9PiB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhY3RpdmUgPSB0LmFjdGl2ZVBsYXllciA/IF9wbGF5ZXJTbmFwKHQuYWN0aXZlUGxheWVyKSA6IG51bGw7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQ6IHQuaWQgfHwgbnVsbCwKICAgICAgICAgICAgc2lkZTogdC5zaWRlLAogICAgICAgICAgICBpc0h1bWFuOiAhIXQuaXNIdW1hbiwKICAgICAgICAgICAgYWlFbmFibGVkOiAhIXQuYWlFbmFibGVkLAogICAgICAgICAgICBjdXJyZW50Rm9ybWF0aW9uOiB0LmN1cnJlbnRGb3JtYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgYWN0aXZlUGxheWVyOiBhY3RpdmUsCiAgICAgICAgICAgIHBsYXllcnM6IEFycmF5LmlzQXJyYXkodC5wbGF5ZXJzKSA/IHQucGxheWVycy5tYXAoX3BsYXllclNuYXApIDogW10KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBidWlsZFNuYXBzaG90ID0gKCkgPT4gewogICAgICAgIGNvbnN0IGdhbWUgPSB0aGlzLmdhbWUgfHwgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IG51bGw7CiAgICAgICAgY29uc3QgYmFsbCA9IGdhbWUgJiYgZ2FtZS5lbnRpdGllcyA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtTWdyID0gZ2FtZSA/IGdhbWUuY2FtZXJhTWFuYWdlciA6IG51bGw7CiAgICAgICAgY29uc3QgY2FtID0gKGNhbU1nciAmJiBjYW1NZ3IuY2FtZXJhKSA/IGNhbU1nci5jYW1lcmEgOiAoZ2FtZSA/IGdhbWUuY2FtZXJhIDogbnVsbCk7CgogICAgICAgIGNvbnN0IGJhbGxTbmFwID0gYmFsbCA/IHsKICAgICAgICAgICAgc3RhdGU6IGJhbGwuc3RhdGUgfHwgbnVsbCwKICAgICAgICAgICAgaXNJbnZpc2libGU6ICEhYmFsbC5pc0ludmlzaWJsZSwKICAgICAgICAgICAgaG9sZGVyOiBiYWxsLmhvbGRlciA/IChiYWxsLmhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwuaG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBsYXN0SG9sZGVyOiBiYWxsLmxhc3RIb2xkZXIgPyAoYmFsbC5sYXN0SG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5sYXN0SG9sZGVyLm5hbWUgfHwgbnVsbCkgOiBudWxsLAogICAgICAgICAgICBwb3M6IF92MyhiYWxsLm1lc2ggJiYgYmFsbC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMoYmFsbC52ZWxvY2l0eSksCiAgICAgICAgICAgIGFuZ1ZlbDogX3YzKGJhbGwuYW5ndWxhclZlbG9jaXR5KSwKICAgICAgICAgICAgcG93ZXI6IF9yb3VuZChiYWxsLnBvd2VyLCA0KSwKICAgICAgICAgICAgc2hvdFR5cGU6IGJhbGwuc2hvdFR5cGUgfHwgbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1lcmFTbmFwID0gY2FtID8gewogICAgICAgICAgICBwb3M6IF92MyhjYW0ucG9zaXRpb24pLAogICAgICAgICAgICByb3Q6IGNhbS5yb3RhdGlvbiA/IFtfcm91bmQoY2FtLnJvdGF0aW9uLngsIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnksIDQpLCBfcm91bmQoY2FtLnJvdGF0aW9uLnosIDQpXSA6IG51bGwsCiAgICAgICAgICAgIGZvdjogX3JvdW5kKGNhbS5mb3YsIDQpLAogICAgICAgICAgICBuZWFyOiBfcm91bmQoY2FtLm5lYXIsIDYpLAogICAgICAgICAgICBmYXI6IF9yb3VuZChjYW0uZmFyLCA0KQogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBjYW1NZ3JTbmFwID0gY2FtTWdyID8gewogICAgICAgICAgICBtb2RlOiBjYW1NZ3IubW9kZSB8fCBudWxsLAogICAgICAgICAgICB0YXJnZXROYW1lOiAoY2FtTWdyLnRhcmdldCAmJiAoY2FtTWdyLnRhcmdldC5jaGFyYWN0ZXJOYW1lIHx8IGNhbU1nci50YXJnZXQubmFtZSkpIHx8IG51bGwsCiAgICAgICAgICAgIHNldHRpbmdzOiBjYW1NZ3Iuc2V0dGluZ3MgPyBfY2xvbmVKc29uKGNhbU1nci5zZXR0aW5ncykgOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGRlYnVnSU8gPSB3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICBjb25zdCBpbnB1dFNuYXAgPSBkZWJ1Z0lPID8gewogICAgICAgICAgICBzZXR0aW5nczogZGVidWdJTy5zZXR0aW5ncyA/IF9jbG9uZUpzb24oZGVidWdJTy5zZXR0aW5ncykgOiBudWxsLAogICAgICAgICAgICBwZXJmOiBkZWJ1Z0lPLnBlcmYgPyBfY2xvbmVKc29uKGRlYnVnSU8ucGVyZikgOiBudWxsLAogICAgICAgICAgICBtb3ZlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0Lm1vdmUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5tb3ZlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQubW92ZS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5tb3ZlLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBhaW06IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuYWltKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuYWltLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGRyYWdnaW5nOiAhIWRlYnVnSU8uaW5wdXQuYWltLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvcikgOiBudWxsCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBzd2lwZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5zd2lwZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnRvdWNoSWQgPz8gbnVsbCwKICAgICAgICAgICAgICAgIHN0YXJ0OiBkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0ID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LnN3aXBlLnN0YXJ0KSA6IG51bGwsCiAgICAgICAgICAgICAgICBwb2ludHM6IEFycmF5LmlzQXJyYXkoZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMpID8gZGVidWdJTy5pbnB1dC5zd2lwZS5wb2ludHMuc2xpY2UoLTMyKS5tYXAoX2Nsb25lSnNvbikgOiBbXQogICAgICAgICAgICB9IDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICB0aW1lc3RhbXBJU086IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgIGhyZWY6ICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYpID8gbG9jYXRpb24uaHJlZiA6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhbWU6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBzY29yZTogZ2FtZS5zY29yZSA/IF9jbG9uZUpzb24oZ2FtZS5zY29yZSkgOiBudWxsLAogICAgICAgICAgICAgICAgdGltZTogX3JvdW5kKGdhbWUudGltZSwgNCksCiAgICAgICAgICAgICAgICBoYWxmOiBnYW1lLmhhbGYgPz8gbnVsbCwKICAgICAgICAgICAgICAgIGhhbGZEdXJhdGlvbjogX3JvdW5kKGdhbWUuaGFsZkR1cmF0aW9uLCA0KSwKICAgICAgICAgICAgICAgIGlzT3ZlcnRpbWU6ICEhZ2FtZS5pc092ZXJ0aW1lLAogICAgICAgICAgICAgICAgaXNEZW1vTW9kZTogISFnYW1lLmlzRGVtb01vZGUKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA6IG51bGwsCiAgICAgICAgICAgICAgICBUaHJvd0NvbmZpZzogKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguVGhyb3dDb25maWcpIDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lcmE6IGNhbWVyYVNuYXAsCiAgICAgICAgICAgIGNhbWVyYU1hbmFnZXI6IGNhbU1nclNuYXAsCiAgICAgICAgICAgIGJhbGw6IGJhbGxTbmFwLAogICAgICAgICAgICB0ZWFtczogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIGhvbWU6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuaG9tZSksCiAgICAgICAgICAgICAgICBhd2F5OiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmF3YXkpCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBpbnB1dDogaW5wdXRTbmFwCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX2NvcHlUZXh0ID0gYXN5bmMgKHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLmNsaXBib2FyZCAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCkgewogICAgICAgICAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgIHRhLnZhbHVlID0gdGV4dDsKICAgICAgICAgICAgdGEuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB0YS5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnOwogICAgICAgICAgICB0YS5zdHlsZS50b3AgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpOwogICAgICAgICAgICB0YS5mb2N1cygpOwogICAgICAgICAgICB0YS5zZWxlY3QoKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRhKTsKICAgICAgICAgICAgcmV0dXJuIG9rOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBjb25zdCBfZG93bmxvYWRUZXh0ID0gKGZpbGVuYW1lLCB0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgICAgICAgICBhLmNsaWNrKCk7CiAgICAgICAgICAgIGEucmVtb3ZlKCk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignU25hcHNob3QgZG93bmxvYWQgZmFpbGVkOicsIGUpOwogICAgICAgIH0KICAgIH07Cgpjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0sCiAgICAgICAgQ29weUNvbmZpZ3M6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2ZnID0gewogICAgICAgICAgICAgICAgQmFsbENvbmZpZzogd2luZG93LmZsdXguQmFsbENvbmZpZywKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoY2ZnLCBudWxsLCA0KTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGlmIChvaykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkNvbmZpZ3MgY29waWVkIHRvIGNsaXBib2FyZCEiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJDb25maWdzIGNvcGllZCB0byBjbGlwYm9hcmQhIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkNvcHkgZmFpbGVkIik7CiAgICAgICAgICAgICAgICBhbGVydCgiQ29weSBmYWlsZWQuIENoZWNrIGNvbnNvbGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdDb3B5U25hcHNob3QnKS5uYW1lKCdDb3B5IEpTT04gU25hcHNob3QnKTsKICAgIHNuYXBzaG90LmFkZChzbmFwc2hvdEFjdGlvbnMsICdEb3dubG9hZFNuYXBzaG90JykubmFtZSgnRG93bmxvYWQgc25hcHNob3QuanNvbicpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlDb25maWdzJykubmFtZSgnQ29weSBDb25maWdzIChGb3IgRGV2KScpOwoKfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgogICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbERlYnVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdWaXN1YWwgRGVidWdnaW5nJyk7CiAgICAgICAgY29uc3QgZHYgPSB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyOwogICAgICAgIGlmICghZHYpIHJldHVybjsKCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUksCiAgICAgICAgICAgIGdvYWxWb2x1bWU6IGR2LnNob3dHb2FsVm9sdW1lLAogICAgICAgICAgICBnb2FsRGlzdDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjUsCiAgICAgICAgICAgIHRyaWdnZXJPZmZzZXQ6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX09GRlNFVCB8fCAxLjAKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgRW50aXR5IFZpeicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICAgICAgCmNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2FsIFZvbHVtZSBTZXR0aW5ncycpOwogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgIGR2LnNob3dHb2FsVm9sdW1lID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wxKSBkdi5nb2FsVm9sMS52aXNpYmxlID0gdjsKICAgICAgICAgICAgaWYgKGR2LmdvYWxWb2wyKSBkdi5nb2FsVm9sMi52aXNpYmxlID0gdjsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZChwYXJhbXMsICdnb2FsRGlzdCcsIDIwLjAsIDYwLjApLm5hbWUoJ0dvYWwgRGlzdGFuY2UnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFID0gdjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvYWxBKSB3aW5kb3cuZmx1eC5nb2FsQS5wb3NpdGlvbi56ID0gLXY7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGdGb2xkZXIuYWRkKHBhcmFtcywgJ3RyaWdnZXJPZmZzZXQnLCAtNS4wLCAxMC4wKS5uYW1lKCdUcmlnZ2VyIE9mZnNldCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9PRkZTRVQgPSB2OwogICAgICAgICAgICBkdi51cGRhdGVHb2FsVm9sdW1lcygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIERpbWVuc2lvbnMKLy8gVHJpZ2dlciBEaW1lbnNpb25zICYgUG9zaXRpb24KICAgICAgICBjb25zdCB0cmlnUGFyYW1zID0gewogICAgICAgICAgICB3aWR0aDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1RSSUdHRVJfV0lEVEggfHwgMjguMCwKICAgICAgICAgICAgY2VudGVyWTogKCh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApICsgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKSkgLyAyLAogICAgICAgICAgICBoZWlnaHQ6ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSB8fCAyLjApIC0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZIHx8IC0xOC4wKQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBoYWxmID0gdHJpZ1BhcmFtcy5oZWlnaHQgLyAyOwogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9UT1BfWSA9IHRyaWdQYXJhbXMuY2VudGVyWSArIGhhbGY7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9UUklHR0VSX0JPVFRPTV9ZID0gdHJpZ1BhcmFtcy5jZW50ZXJZIC0gaGFsZjsKICAgICAgICAgICAgZHYudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9OwoKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnY2VudGVyWScsIC0zMCwgMzApLm5hbWUoJ1RyaWdnZXIgQ2VudGVyIFknKS5vbkNoYW5nZSh1cGRhdGVUcmlnZ2VyRnJvbUNlbnRlcik7CiAgICAgICAgZ0ZvbGRlci5hZGQodHJpZ1BhcmFtcywgJ2hlaWdodCcsIDEsIDYwKS5uYW1lKCdUcmlnZ2VyIEhlaWdodCcpLm9uQ2hhbmdlKHVwZGF0ZVRyaWdnZXJGcm9tQ2VudGVyKTsKICAgICAgICAKICAgICAgICBnRm9sZGVyLmFkZCh0cmlnUGFyYW1zLCAnd2lkdGgnLCA1LCA1MCkubmFtZSgnVHJpZ2dlciBXaWR0aCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfVFJJR0dFUl9XSURUSCA9IHY7CiAgICAgICAgICAgIGR2LnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1vZGVsIERpbWVuc2lvbnMKICAgICAgICBjb25zdCBtb2RGb2xkZXIgPSBnRm9sZGVyLmFkZEZvbGRlcignTW9kZWwgRGltZW5zaW9ucycpOwogICAgICAgIGNvbnN0IG1vZFBhcmFtcyA9IHsKICAgICAgICAgICAgc2NhbGU6IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9TQ0FMRSB8fCA0NS4wLAogICAgICAgICAgICBzeDogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggfHwgMS4wLAogICAgICAgICAgICBzeTogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgfHwgMS4wLAogICAgICAgICAgICBzejogd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogfHwgMS4wLAogICAgICAgICAgICB5T2ZmOiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfWV9PRkZTRVQgfHwgLTE4LjAKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBzID0gbW9kUGFyYW1zLnNjYWxlOwogICAgICAgICAgICBjb25zdCBzeCA9IG1vZFBhcmFtcy5zeDsKICAgICAgICAgICAgY29uc3Qgc3kgPSBtb2RQYXJhbXMuc3k7CiAgICAgICAgICAgIGNvbnN0IHN6ID0gbW9kUGFyYW1zLnN6OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFID0gczsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ggPSBzeDsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1kgPSBzeTsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1NDQUxFX1ogPSBzejsKICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX1lfT0ZGU0VUID0gbW9kUGFyYW1zLnlPZmY7CgogICAgICAgICAgICBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXS5mb3JFYWNoKGcgPT4gewogICAgICAgICAgICAgICAgaWYoZykgewogICAgICAgICAgICAgICAgICAgIGcuc2NhbGUuc2V0KHMgKiBzeCwgcyAqIHN5LCBzICogc3opOwogICAgICAgICAgICAgICAgICAgIGcucG9zaXRpb24ueSA9IG1vZFBhcmFtcy55T2ZmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3NjYWxlJywgMS4wLCAxMDAuMCkubmFtZSgnQmFzZSBTY2FsZScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N4JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFggKFdpZHRoKScpLm9uQ2hhbmdlKHVwZGF0ZU1vZGVsKTsKICAgICAgICBtb2RGb2xkZXIuYWRkKG1vZFBhcmFtcywgJ3N5JywgMC4xLCAzLjApLm5hbWUoJ1NjYWxlIFkgKEhlaWdodCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICdzeicsIDAuMSwgMy4wKS5uYW1lKCdTY2FsZSBaIChEZXB0aCknKS5vbkNoYW5nZSh1cGRhdGVNb2RlbCk7CiAgICAgICAgbW9kRm9sZGVyLmFkZChtb2RQYXJhbXMsICd5T2ZmJywgLTUwLjAsIDIwLjApLm5hbWUoJ1kgT2Zmc2V0Jykub25DaGFuZ2UodXBkYXRlTW9kZWwpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7Ci8vIER1cGxpY2F0ZSByZW1vdmVkCiAgICAgICAgfTsKCiAgICAgICAgRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHBwID0gdGhpcy5nYW1lLnBvc3RQcm9jZXNzaW5nOwogICAgICAgICAgICBpZiAoIXBwIHx8ICFwcC51bmlmb3JtcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQb3N0LVByb2Nlc3NpbmcgKFJldHJvIEZYKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgZW5hYmxlZDogcHAuZW5hYmxlZCwKICAgICAgICAgICAgICAgIHNjYW5saW5lOiBwcC51bmlmb3Jtcy51U2NhbmxpbmVJbnRlbnNpdHkudmFsdWUsCiAgICAgICAgICAgICAgICB2aWduZXR0ZTogcHAudW5pZm9ybXMudVZpZ25ldHRlLnZhbHVlLAogICAgICAgICAgICAgICAgbm9pc2U6IHBwLnVuaWZvcm1zLnVOb2lzZS52YWx1ZSwKICAgICAgICAgICAgICAgIGFiZXJyYXRpb246IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlLAogICAgICAgICAgICAgICAgY29udHJhc3Q6IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSwKICAgICAgICAgICAgICAgIHNhdHVyYXRpb246IHBwLnVuaWZvcm1zLnVTYXR1cmF0aW9uLnZhbHVlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgUFAnKS5vbkNoYW5nZSh2ID0+IHBwLmVuYWJsZWQgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzY2FubGluZScsIDAuMCwgMS4wKS5uYW1lKCdTY2FubGluZSBJbnRlbnNpdHknKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVTY2FubGluZUludGVuc2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZpZ25ldHRlJywgMC4wLCAyLjApLm5hbWUoJ1ZpZ25ldHRlJykub25DaGFuZ2UodiA9PiBwcC51bmlmb3Jtcy51VmlnbmV0dGUudmFsdWUgPSB2KTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdub2lzZScsIDAuMCwgMC41KS5uYW1lKCdOb2lzZScpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudU5vaXNlLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnYWJlcnJhdGlvbicsIDAuMCwgMTAuMCkubmFtZSgnQ2hyb21hdGljIEFiZXJyYXRpb24nKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVBYmVycmF0aW9uLnZhbHVlID0gdik7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnY29udHJhc3QnLCAwLjAsIDIuMCkubmFtZSgnQ29udHJhc3QnKS5vbkNoYW5nZSh2ID0+IHBwLnVuaWZvcm1zLnVDb250cmFzdC52YWx1ZSA9IHYpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3NhdHVyYXRpb24nLCAwLjAsIDIuMCkubmFtZSgnU2F0dXJhdGlvbicpLm9uQ2hhbmdlKHYgPT4gcHAudW5pZm9ybXMudVNhdHVyYXRpb24udmFsdWUgPSB2KTsKICAgICAgICB9Owp9KSgpOw==","DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","./DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","/DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCi8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBUcmlhbmd1bGFyIFByaXNtKQogICAgICAgICAgICAvLyBNYXRjaGVzIEZGWCBHb2FsIFNoYXBlOiBJbnZlcnRlZCBUcmlhbmdsZQogICAgICAgICAgICAvLyBUb3AgV2lkdGg6IDI4LCBCb3R0b20gV2lkdGg6IDAsIEhlaWdodDogMTgsIERlcHRoOiAxMAogICAgICAgICAgICAvLyBDZW50ZXJlZCBhdCBZPTMgKE1pZHBvaW50IG9mIDEyIGFuZCAtNikKICAgICAgICAgICAgY29uc3QgZ29hbEdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoWwogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IDUpCi8vIEZyb250IEZhY2UgKFogPSA1KQotMTQsIDIsIDUsICAvLyAwOiBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LCAyLCA1LCAgLy8gMTogVG9wIFJpZ2h0CiAgICAgICAgICAgICAgICAgIDAsIC0xOCwgNSwgLy8gMjogQm90dG9tCiAgICAgICAgICAgICAgICAvLyBCYWNrIEZhY2UgKFogPSAtNSkKICAgICAgICAgICAgICAgIC0xNCwgMiwgLTUsIC8vIDM6IFRvcCBMZWZ0CiAgICAgICAgICAgICAgICAgMTQsIDIsIC01LCAvLyA0OiBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMCwgLTE4LCAtNSAvLyA1OiBCb3R0b20KICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICAgICAgICAgICAgICAwLCAyLCAxLCAgICAgICAgICAvLyBGcm9udAogICAgICAgICAgICAgICAgMywgNCwgNSwgICAgICAgICAgLy8gQmFjawogICAgICAgICAgICAgICAgMCwgMSwgNCwgMCwgNCwgMywgLy8gVG9wCiAgICAgICAgICAgICAgICAxLCAyLCA1LCAxLCA1LCA0LCAvLyBSaWdodCBTaWRlCiAgICAgICAgICAgICAgICAwLCAzLCA1LCAwLCA1LCAyICAvLyBMZWZ0IFNpZGUKICAgICAgICAgICAgXTsKICAgICAgICAgICAgZ29hbEdlby5zZXRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgICAgICBnb2FsR2VvLnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICBnb2FsR2VvLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCk7CgogICAgICAgICAgICBjb25zdCBnb2FsTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHhmZjAwMDAsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4yNSwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlIAogICAgICAgICAgICB9KTsKCnRoaXMuZ29hbFZvbDEgPSBuZXcgVEhSRUUuTWVzaChnb2FsR2VvLCBnb2FsTWF0KTsKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdvYWxWb2x1bWVzKCk7CiAgICAgICAgfQogICAgICAgIAp1cGRhdGVHb2FsVm9sdW1lcygpIHsKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IGdvYWxEaXN0ID0gQy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJPZmZzZXQgPSAoQy5HT0FMX1RSSUdHRVJfT0ZGU0VUICE9PSB1bmRlZmluZWQpID8gQy5HT0FMX1RSSUdHRVJfT0ZGU0VUIDogMS4wOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBEaW1lbnNpb25zCiAgICAgICAgICAgIGNvbnN0IHRvcFkgPSAoQy5HT0FMX1RSSUdHRVJfVE9QX1kgIT09IHVuZGVmaW5lZCkgPyBDLkdPQUxfVFJJR0dFUl9UT1BfWSA6IDIuMDsKICAgICAgICAgICAgY29uc3QgYm90WSA9IChDLkdPQUxfVFJJR0dFUl9CT1RUT01fWSAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX0JPVFRPTV9ZIDogLTE4LjA7CiAgICAgICAgICAgIGNvbnN0IGhhbGZXID0gKChDLkdPQUxfVFJJR0dFUl9XSURUSCAhPT0gdW5kZWZpbmVkKSA/IEMuR09BTF9UUklHR0VSX1dJRFRIIDogMjguMCkgLyAyLjA7CiAgICAgICAgICAgIGNvbnN0IGRlcHRoID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgaGFsZkRlcHRoID0gZGVwdGggLyAyLjA7CgogICAgICAgICAgICAvLyBWb2x1bWUgcmVwcmVzZW50cyB0aGUgdHJpZ2dlciBhcmVhLgogICAgICAgICAgICAvLyBUcmlnZ2VyIHN0YXJ0cyBhdCAoZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0KSBhbmQgZ29lcyBvdXR3YXJkcy4KICAgICAgICAgICAgY29uc3QgelN0YXJ0ID0gZ29hbERpc3QgLSB0cmlnZ2VyT2Zmc2V0OwogICAgICAgICAgICBjb25zdCB6Q2VudGVyID0gelN0YXJ0ICsgaGFsZkRlcHRoOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEdlb21ldHJ5IFZlcnRpY2VzCiAgICAgICAgICAgIC8vIDA6IFRvcCBMZWZ0IEZyb250ICgtWCwgVG9wWSwgK1opCiAgICAgICAgICAgIC8vIDE6IFRvcCBSaWdodCBGcm9udCAoK1gsIFRvcFksICtaKQogICAgICAgICAgICAvLyAyOiBCb3R0b20gRnJvbnQgKDAsIEJvdFksICtaKQogICAgICAgICAgICAvLyAzOiBUb3AgTGVmdCBCYWNrICgtWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDQ6IFRvcCBSaWdodCBCYWNrICgrWCwgVG9wWSwgLVopCiAgICAgICAgICAgIC8vIDU6IEJvdHRvbSBCYWNrICgwLCBCb3RZLCAtWikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUdlbyA9IChtZXNoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW1lc2ggfHwgIW1lc2guZ2VvbWV0cnkpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IG1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHBvcy5hcnJheTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRnJvbnQgRmFjZSAoWiA9IGhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFyclswXSA9IC1oYWxmVzsgYXJyWzFdID0gdG9wWTsgYXJyWzJdID0gaGFsZkRlcHRoOwogICAgICAgICAgICAgICAgYXJyWzNdID0gaGFsZlc7ICBhcnJbNF0gPSB0b3BZOyBhcnJbNV0gPSBoYWxmRGVwdGg7CiAgICAgICAgICAgICAgICBhcnJbNl0gPSAwOyAgICAgIGFycls3XSA9IGJvdFk7IGFycls4XSA9IGhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFjayBGYWNlIChaID0gLWhhbGZEZXB0aCkKICAgICAgICAgICAgICAgIGFycls5XSA9IC1oYWxmVzsgIGFyclsxMF0gPSB0b3BZOyBhcnJbMTFdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxMl0gPSBoYWxmVzsgIGFyclsxM10gPSB0b3BZOyBhcnJbMTRdID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIGFyclsxNV0gPSAwOyAgICAgIGFyclsxNl0gPSBib3RZOyBhcnJbMTddID0gLWhhbGZEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcG9zLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgewogICAgICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgMCwgLXpDZW50ZXIpOwogICAgICAgICAgICAgICAgdXBkYXRlR2VvKHRoaXMuZ29hbFZvbDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmdvYWxWb2wyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAwLCB6Q2VudGVyKTsKICAgICAgICAgICAgICAgIC8vIEZsaXAgWiBmb3IgZ29hbCAyPyBObywgdGhlIGJveCBpcyBzeW1tZXRyaWMgaW4gWiBsb2NhbCBzcGFjZSwganVzdCBwb3NpdGlvbiBoYW5kbGVzIGl0LgogICAgICAgICAgICAgICAgLy8gQnV0IEdvYWwgMiBmYWNlcyBvcHBvc2l0ZSB3YXkuIFRoZSB0cmlnZ2VyIGxvZ2ljIHVzZXMgYWJzKHgpIGFuZCB5IHJhbmdlLCBzbyBvcmllbnRhdGlvbiBkb2Vzbid0IG1hdHRlciBmb3IgbG9naWMuCiAgICAgICAgICAgICAgICAvLyBWaXN1YWxpemVyIGlzIGp1c3QgYSBib3guCiAgICAgICAgICAgICAgICB1cGRhdGVHZW8odGhpcy5nb2FsVm9sMik7CiAgICAgICAgICAgIH0KfQoKdXBkYXRlKCkgewovLyBVcGRhdGUgc3RhdGljIGRlYnVncwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gdGhpcy5zaG93R29hbFZvbHVtZTsKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDIpIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCmhhbmRsZVNlbGVjdGlvbihhY3Rpb24pIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CiAgICAgICAgICAgIC8vIFBsYXkgU0ZYIGZvciBhbnkgc2VsZWN0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyKSB0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ21lbnUnLCB7IHZvbHVtZTogMS4wIH0pOwoKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","./MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCmhhbmRsZVNlbGVjdGlvbihhY3Rpb24pIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CiAgICAgICAgICAgIC8vIFBsYXkgU0ZYIGZvciBhbnkgc2VsZWN0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyKSB0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ21lbnUnLCB7IHZvbHVtZTogMS4wIH0pOwoKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","/MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCmhhbmRsZVNlbGVjdGlvbihhY3Rpb24pIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CiAgICAgICAgICAgIC8vIFBsYXkgU0ZYIGZvciBhbnkgc2VsZWN0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyKSB0aGlzLmdhbWUuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ21lbnUnLCB7IHZvbHVtZTogMS4wIH0pOwoKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","./PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","/PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc3RvcmUgQXdheSBUZWFtIFZpc2liaWxpdHkgZm9yIE5vcm1hbCBNYXRjaAovLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICAgICAgcC5jYW5DYXRjaCA9IHRydWU7IC8vIFJlc3RvcmUgY2F0Y2hpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdvYWwgRGV0ZWN0aW9uIChJbnZlcnRlZCBUcmlhbmdsZSBIaXRib3gpCmNvbnN0IHRyaVRvcFkgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpQm90dG9tWSA9IC02LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpTWF4SGFsZldpZHRoID0gMTQuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnkgPD0gdHJpVG9wWSAmJiBwb3MueSA+PSB0cmlCb3R0b21ZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAocG9zLnkgLSB0cmlCb3R0b21ZKSAvICh0cmlUb3BZIC0gdHJpQm90dG9tWSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRYID0gdCAqIHRyaU1heEhhbGZXaWR0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gYWxsb3dlZFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgcG9zLCB7IHNjYWxlOiA1LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCmZvcihsZXQgaz0wOyBrPDU7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUsIHJvdGF0aW9uU3BlZWQ6IChNYXRoLnJhbmRvbSgpLTAuNSkqMTAsIGZyYW1lOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfc2V0dXBFdmVudHMoKSB7CgogICAgICAgICAgICAvLyBNaW5pbWl6ZSAvIFJlc3RvcmUKICAgICAgICAgICAgY29uc3QgbWluQnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1taW5pbWl6ZScpOwogICAgICAgICAgICBpZiAobWluQnRuKSB7CiAgICAgICAgICAgICAgICBtaW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Jlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByZXN0b3JlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChyZXN0b3JlQnRuKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJpbGwgQnV0dG9ucwogICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChidG4uZGF0YXNldC5kcmlsbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBSZXNldCBCYWxsCiAgICAgICAgICAgIGNvbnN0IHJlc2V0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1yZXNldC1iYWxsJyk7CiAgICAgICAgICAgIGlmIChyZXNldEJ0bikgewogICAgICAgICAgICAgICAgcmVzZXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeGl0CiAgICAgICAgICAgIGNvbnN0IGV4aXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLWV4aXQnKTsKICAgICAgICAgICAgaWYgKGV4aXRCdG4pIHsKICAgICAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT3B0aW9ucyBUb2dnbGVzCiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1pbmYtc3RhdCcsICdpbmZTdGF0cycpOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtYWktZHVtbXknLCAnYWlEdW1teScsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBBSSBEdW1teSBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXZhbDsgLy8gSWYgZHVtbXkgaXMgVFJVRSwgQUkgaXMgRkFMU0UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1oaXRib3hlcycsICdzaG93SGl0Ym94ZXMnLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCi8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdW5uaW5nICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdyJyAmJiAhZS5yZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfYmluZFRvZ2dsZShpZCwgb3B0aW9uS2V5LCBjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcihgIyR7aWR9YCk7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEhlbHBlciB0byB1cGRhdGUgdmlzdWFscwogICAgICAgICAgICBjb25zdCB1cGRhdGVWaXN1YWwgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgaXNBY3RpdmUpOwogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gZWwucXVlcnlTZWxlY3RvcignLmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoYm94KSBib3guaW5uZXJUZXh0ID0gaXNBY3RpdmUgPyAn4pajJyA6ICfilqEnOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB2aXN1YWwgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW29wdGlvbktleV0gPSAhdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5vcHRpb25zW29wdGlvbktleV0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBfc2V0dXBCYWxsTGFiKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiQkFMTCBMQUI6IE9wZW4gRGV2VG9vbHMg4oaSIEJhbGwgTGFiLiBVc2UgU2hvdCBDYW5ub24gKyB0cmFqZWN0b3J5IHByZXZpZXcgKyByZWNvcmQvcmVwbGF5LiIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CiAgICAgICAgICAgIGNvbnN0IHAgPSBob21lID8gaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNvbG8gbW9kZTogaGlkZSBldmVyeW9uZSBleGNlcHQgdGhlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKGhvbWUgJiYgaG9tZS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5tZXNoKSBtYXRlLm1lc2gudmlzaWJsZSA9IChtYXRlID09PSBwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhd2F5ICYmIGF3YXkucGxheWVycykgewogICAgICAgICAgICAgICAgYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAob3BwLm1lc2gpIG9wcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQbGFjZSBhY3RpdmUgcGxheWVyIGF0IGNlbnRlciBmYWNpbmcgdGhlIGF3YXkgZ29hbAogICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJpZyBzdGF0cyBzbyB5b3UgY2FuIHRlc3QgZXh0cmVtZXMKICAgICAgICAgICAgaWYgKHAuc3RhdHMpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU0ggPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuUEEgPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSA5OTsKICAgICAgICAgICAgICAgIHAuc3RhdHMubWF4SFAgPSBNYXRoLm1heChwLnN0YXRzLm1heEhQIHx8IDk5OSwgOTk5KTsKICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIGNsZWFyIHRhcmdldCBtYXJrZXIgKHB1cmVseSB2aXN1YWwpCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTgpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDBmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKICAgICAgICBfbG9vcEJhbGxMYWIoZHQpIHsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBpZiAoIWIgfHwgIXApIHJldHVybjsKCiAgICAgICAgICAgIC8vIEF1dG8tcmVzZXQgYmFsbCBiYWNrIHRvIHBsYXllciBvbmNlIGl0IGNvbWVzIHRvIHJlc3QsCiAgICAgICAgICAgIC8vIHNvIHlvdSBjYW4gc3BhbSB2YXJpYXRpb25zIHdpdGhvdXQgdG91Y2hpbmcgYW55dGhpbmcuCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BwZWQgPSAoYi52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgJiYgKGIucG93ZXIgPD0gMC4wMSk7CiAgICAgICAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciB8fCAwKSArIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID4gMC40NSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNsaWdodCB0YXJnZXQgYm9iIChoZWxwcyBkZXB0aCBwZXJjZXB0aW9uKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMykgKiAwLjA1OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbmZpbml0ZVN0YXRzKCkgewogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGlmIChob21lKSB7CiAgICAgICAgICAgICAgICBob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jbGVhckRyaWxsKCkgewoKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBHbHlwaHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIpIHRoaXMuZ2FtZS5nbHlwaE1hbmFnZXIuY2xlYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwoKLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAwLCAwKTsgLy8gTW92ZSBXQVkgYXdheSB0byBwcmV2ZW50IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gZmFsc2U7IC8vIERpc2FibGUgY2F0Y2hpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgpfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gUmVzdG9yZSBjYXBhYmlsaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnICYmIGcubWVzaCkgewogICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjcpOwogICAgICAgICAgICAgICAgZy5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGcudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CiAgICAgICAgCl9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIFNhdmUgKEJhbGwgc3RvcHBlZCBvciBtb3ZpbmcgYXdheSBmcm9tIGdvYWwgd2l0aG91dCBzY29yaW5nKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJhbGwgJiYgZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhnLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyBjbG9zZSB0byBnb2FsaWUgYW5kIHN0b3BwZWQvY2F1Z2h0CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDMuMCAmJiAoYmFsbC5ob2xkZXIgPT09IGcgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGgoKSA8IDEuMCkpIHsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKY29uc3QgZ29hbERpc3QgPSAod2luZG93LmZsdXguQmFsbENvbmZpZyAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UpIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsRGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGRpciA9IGdvYWxQb3MuY2xvbmUoKS5zdWIoYXR0YWNrZXIubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgUmluZyBvbiBBdHRhY2tlcgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weShhdHRhY2tlci5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7IC8vIFJlZCBmb3IgZW5lbXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGF0dGFja2VyLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLnNldElucHV0KGRpci54LCBkaXIueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBCYWxsIGxvc3QgKFRhY2tsZWQpCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsIHx8IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUT1BQRUQhIiwgcC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmFpbCBjb25kaXRpb246IEF0dGFja2VyIHNjb3JlcyAoR2FtZU1hbmFnZXIgaGFuZGxlcyBnb2FsIGNoZWNrKQogICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KfQoKICAgICAgICBfc2V0dXBDdXJ2ZSgpIHsKdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlN3aXBlIGEgQ1VSVkUgKCApICkgdG8gYnlwYXNzIHRoZSBkZWZlbmRlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gU2hvdyBnZXN0dXJlIGhpbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQXV0byBoaWRlIGFmdGVyIDRzCiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIC8vIFVzZSBhIGRlZmVuZGVyIGR1bW15CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEQnKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyID0gZGVmZW5kZXI7CgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxNSk7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","./WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","/WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","./GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","/GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CnRoaXMuYmdtLnNyYyA9ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2wwcGhsMWxmdGQ4YTR2NnV2dGprZC9mZngtU291bmR0cmFja18tYmxpdHotb2ZmLWJsaXR6YmFsbC10aGVtZS0xLUNvdmVyLTIubXAzP3Jsa2V5PWp5bjlxaDI4bTRjeGVjdWgycXFtOTdhdWwmcmF3PTEnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gMC44OwogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIER5bmFtaWMgU3RhdGUgKFBpdGNoL1ZvbHVtZSBtb2R1bGF0aW9uKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlID0gMS4wOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREeW5hbWljVm9sID0gMS4wOwogICAgICAgICAgICB0aGlzLm1hdGNoVGVuc2lvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KdGhpcy5zZnhMaWJyYXJ5ID0gewogICAgICAgICAgICAgICAgJ3doaXN0bGUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zYzI1YWFyOHFtZjNibDBhb2pjbnEvV2hpc3RsZV9WYXItMS5tcDM/cmxrZXk9MTNhZ2IycXkwMHI2NzZlZ2x5djhwNzZyMiZyYXc9MScsCiAgICAgICAgICAgICAgICAnd2hpc3RsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS96NW83emtoMDF2NDkyYml3aDh1MzUvV2hpc3RsZV9WYXItMy5tcDM/cmxrZXk9bGpvZmdibGhzMTB0NWllY3B6ZmZueGtjNSZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvajA0NWpobGIyN3I1Y2xwYnJldmxnL3dhdGVybW92ZW1lbnRfcXVpY2sxLm1wMz9ybGtleT1vM3dpbzBqYXplc290czNvMTMyNTR3YmpqJnJhdz0xJywKICAgICAgICAgICAgICAgICdzd2ltMic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2Q5aWRtd2t3YmtsdW84OHNxbmpvcS93YXRlcm1vdmVtZW50X3F1aWNrMi5tcDM/cmxrZXk9ODR5OW1od2ZuYXg0bGE1ZnhxYTZnNnd4cyZyYXc9MScsCiAgICAgICAgICAgICAgICAnc3dpbTMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS80cWRzMmI1NWx1OGJxdTB5aHRkOXUvd2F0ZXJtb3ZlbWVudF9xdWljazMubXAzP3Jsa2V5PWc4ODF3dXc1YnQwdzVja2Z3eWsxNWhzcGkmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW00JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdXljMHZmZ3M4b2hicG1xcDJ1MXl2L1N3aW1fVmFyLTMubXAzP3Jsa2V5PTgzdDVqbHJnbHZ2cjV1dDE0NHdyZzMyNmMmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW01JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvamdzOG1vZmgyNnByeHptNzBxeWlxL1N3aW1fVmFyLTIubXAzP3Jsa2V5PXhrZHFjMnNjaTBjNHFiM2FjaHU5eGM4ZnUmcmF3PTEnLAoKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvNGltMHpjdnFhdmt4Zmg2amV4dnlhL3dhdGVyZGFzaC5tcDM/cmxrZXk9bjd4eDF0cW1kOHI3c2lheW00dHVheTc2ZiZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8waXhxbW9nbXU5YW9xYjR6dHVuaTkvRGFzaF9WYXItMy5tcDM/cmxrZXk9MGZmNjZtaDRqNWFubnh2dHY3NXdieW1icyZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9nMzZzZXhzcWRmZ2FqYnl6d2dzbXgvRGFzaF9WYXItMi5tcDM/cmxrZXk9dGswdGk1Zmg3ZndycnB1OWx3azFrMXBubCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2ltcGFjdCc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2QwNDdlcmpvNnBwcDIxNnNjNmRoOS93YXRlcl9pbXBhY3QubXAzP3Jsa2V5PWt1ZGNlbmtiaW5keHFsenhtMXB4dmRhcGImcmF3PTEnLAogICAgICAgICAgICAgICAgJ2ltcGFjdDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8wenVjbTR3MXNiMzk1OTNzam80am4vSW1wYWN0X1Zhci0zLm1wMz9ybGtleT1ya25obmoxNDJ4cXd4amsyMGpmbmg0NXU5JnJhdz0xJywKICAgICAgICAgICAgICAgICdpbXBhY3RfaGVhdnknOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9pOXNmZ2h4dTdmdm80c2szNmNwYXkvSW1wYWN0X01peGVkLUxheWVyLm1wMz9ybGtleT1xNmh3MDB1am1id28wMGlic2JweWFsaGhhJnJhdz0xJywKCiAgICAgICAgICAgICAgICAndGhyb3cnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9rb2Zhc3IzajByaDhkOW51bDNndTkvdGhyb3cubXAzP3Jsa2V5PW5wa3UxYXpqZWRxa21kcjY3MzlnZG90Z2wmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3Rocm93Mic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3o2b2l1aXVqZTdrNnAyNHR4amdidi9UaHJvd19WYXItMi5tcDM/cmxrZXk9dTFqMXphY2g2aXY3Y2VxczBsdjRyMGE5OCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ3RhY2tsZSc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3l6ZW1yNHczd2s5Ynk0ZDg4ZG0zYy9UYWNrbGVfVmFyLTIubXAzP3Jsa2V5PW40ZHgwY3BhZmpldWU5MzE3c2E2Z21yM2kmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3RhY2tsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS91aXI0N2poeXo3Z21wZnZsMmpsNzgvVGFja2xlX1Zhci0zLm1wMz9ybGtleT1hbDdjMjZ0YWY5dzV1c3V0d3ZkNTN2YmE5JnJhdz0xJywKCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zaGMzaWdtNGRhZDMzbG5idnFseHQvY2F0Y2gubXAzP3Jsa2V5PTZ5ZG5heGs4OW5mN2tlbm41Nnl1dW5sdWwmcmF3PTEnLAogICAgICAgICAgICAgICAgJ2NhdGNoX2p1bXAnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS95NmN5dGdmNXVtY3Z1eHg2M3k5cXAvQ2F0Y2hfSnVtcF9WYXItMS5tcDM/cmxrZXk9Y3B4aWozMmZhbTFrM3l2ZzBnbG93bm9paiZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2dvYWwnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS81NnhmM3kzbGVpNTgydWowcGZwaWUvR29hbF9WYXItMy5tcDM/cmxrZXk9Njd0eTN0eW5yY2oxb20zajAxMml4YmhxdCZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdjaGFyZ2UnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9oaXk4NWg2MGlseHY3aDllbWpqbHgvQ2hhcmdlX1Zhci0zLm1wMz9ybGtleT12d2Z2cmN3bTR2dmswemdkZHZ2cTJ3NGN3JnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ21lbnUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9raGd2NHk5Y3JyOXU5Nmlmam1qbGQvTWVudV9NYW5hZ2VyLkpzX1Zhci0xLm1wMz9ybGtleT1heHhkeTQwbXdzdTFjd2xwd3cwY3RrMTAxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3JlYWN0JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvbGxsbXgxZnRpenJnbzVkNGRtajY0L1JlYWN0X1Zhci0yLm1wMz9ybGtleT13ZDh3YnY5d3B2ZHNkM25xODB4eWh1dXRxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3RlY2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS84M2o3ZngwNnBsMXg4OW0wZjJ1MnAvR2x5cGhfTWFuYWdlci5Kc19WYXItMy5tcDM/cmxrZXk9emVweTl6ZnNneHNidncyaXA1bjlwdDhtcyZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdhbWJpZW50JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdjVpZTJ4a3JzZnhsdG16cWpvaGExL1N0YWRpdW0uSnNfVmFyLTEubXAzP3Jsa2V5PXdhMm9pMjhwem1scXloOGZ6djQ3anlqejYmcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAndWlfZ2VuZXJpYyc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2NmaGVocXRpN3YzdnBuZjBxcnJyZi9HYW1lX01hbmFnZXIuSnNfVmFyLTIubXAzP3Jsa2V5PTAyODkybDBiaW9lZnB0ZzhtMDF0dnppY2smcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAnYnViYmxlJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdDh5dGR0ZG9rbjlpNmNkY2MyeDQxL0lkbGVfVmFyLTIubXAzP3Jsa2V5PXE2cGVkcjBicHh3MmN1bTRtcXRycm01NnomcmF3PTEnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICAgICAgdGhpcy5faW5pdFdhdGNoZG9ncygpOwogICAgICAgIH0KCiAgICAgICAgX2luaXRXYXRjaGRvZ3MoKSB7CiAgICAgICAgICAgIC8vIEJHTSBMb29wICYgUmVzdW1lIExvZ2ljCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGUgPT4gY29uc29sZS53YXJuKCJCR00gUmVwbGF5IGZhaWw6IiwgZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJvYnVzdCBVbmxvY2sgU3RyYXRlZ3kgZm9yIE1vYmlsZSAoaU9TL0FuZHJvaWQpCiAgICAgICAgICAgIGNvbnN0IHVubG9jayA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eC5zdGF0ZSAhPT0gJ3J1bm5pbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgucmVzdW1lKCkudGhlbigoKSA9PiB7fSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgWydjbGljaycsICd0b3VjaHN0YXJ0JywgJ3RvdWNoZW5kJywgJ2tleWRvd24nLCAnbW91c2Vkb3duJ10uZm9yRWFjaChldnQgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIHRydWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTsKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c31gKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF1ZGlvQnVmZmVyID0gYXdhaXQgdGhpcy5jdHguZGVjb2RlQXVkaW9EYXRhKGFycmF5QnVmZmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycy5zZXQoaWQsIGF1ZGlvQnVmZmVyKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBdWRpb01hbmFnZXI6IExvYWRlZCBTRlggJyR7aWR9J2ApOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEF1ZGlvTWFuYWdlcjogRmFpbGVkIHRvIGxvYWQgU0ZYICcke2lkfScgZnJvbSAke3VybH0uIFVzaW5nIGZhbGxiYWNrLmAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcGxheVNGWChpZCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5jdHgucmVzdW1lKCkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICAgICAgLy8gLS0tIFNQRUNJQUwgSEFORExJTkcgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBXaGlzdGxlOiBMb3dlciB2b2x1bWUgJiBMYXllcmluZwogICAgICAgICAgICBpZiAoaWQgPT09ICd3aGlzdGxlJykgewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gKG9wdGlvbnMudm9sdW1lIHx8IDEuMCkgKiAwLjI7IC8vIFdheSBkb3duCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IE1haW4KICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVBbmRQbGF5KCd3aGlzdGxlJywgeyAuLi5vcHRpb25zLCB2b2x1bWU6IHZvbCB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTGF5ZXIgMjogRWNoby9TdGFkaXVtIFJldmVyYiAoU2xpZ2h0bHkgZGVsYXllZCwgbG93ZXIgcGl0Y2gpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheSgnd2hpc3RsZScsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsIAogICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWU6IHZvbCAqIDAuNiwgCiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IChvcHRpb25zLnJhdGUgfHwgMS4wKSAqIDAuOTUgCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCA4MCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERhc2g6IEJvb3N0IFZvbHVtZSAoVXNlciByZXBvcnRlZCBub3QgaGVhcmluZyBpdCkKICAgICAgICAgICAgaWYgKGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIC8vIENsb25lIG9wdGlvbnMgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgcmVmZXJlbmNlIGlmIHJldXNlZAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgdm9sdW1lOiAob3B0aW9ucy52b2x1bWUgfHwgMS4wKSAqIDIuNSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheShpZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcmVzb2x2ZUFuZFBsYXkoaWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgbGV0IHRhcmdldElkID0gaWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemF0aW9uIExvZ2ljCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ3N3aW0nKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydzd2ltJywgJ3N3aW0yJywgJ3N3aW0zJywgJ3N3aW00JywgJ3N3aW01J107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2Rhc2gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydkYXNoJywgJ2Rhc2gyJywgJ2Rhc2gzJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2ltcGFjdCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ2ltcGFjdCcsICdpbXBhY3QyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3Rocm93JykgewogICAgICAgICAgICAgICAgY29uc3QgdmFycyA9IFsndGhyb3cnLCAndGhyb3cyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3RhY2tsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ3RhY2tsZScsICd0YWNrbGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3doaXN0bGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWyd3aGlzdGxlJywgJ3doaXN0bGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcGxheVJhdyh0YXJnZXRJZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcGxheVJhdyhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCBidWZmZXIgPSB0aGlzLnNmeEJ1ZmZlcnMuZ2V0KGlkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBGQUxMQkFDSyBTWU5USEVTSVMgLS0tCiAgICAgICAgICAgIGlmICghYnVmZmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBzb3VyY2UuYnVmZmVyID0gYnVmZmVyOwoKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSBvcHRpb25zLnZhcmlhbmNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZhcmlhbmNlIDogMC4xOwogICAgICAgICAgICBsZXQgcmF0ZSA9IG9wdGlvbnMucmF0ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5yYXRlIDogMS4wOwoKICAgICAgICAgICAgaWYgKHZhcmlhbmNlID4gMCkgewogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UucGxheWJhY2tSYXRlLnZhbHVlID0gTWF0aC5tYXgoMC4xLCBNYXRoLm1pbig0LjAsIHJhdGUpKTsKCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIF9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5jdHguY3VycmVudFRpbWU7CiAgICAgICAgICAgIGNvbnN0IG9zYyA9IHRoaXMuY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICAgICAgICAgICAgY29uc3QgZ2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgICAgICBnYWluLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZvbCA9IG9wdGlvbnMudm9sdW1lICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZvbHVtZSA6IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoODAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg0MDAsIHQgKyAwLjEpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKHZvbCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjAxLCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlkID09PSAndGhyb3cnIHx8IGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIG9zYy50eXBlID0gJ3RyaWFuZ2xlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMzAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg1MCwgdCArIDAuMyk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjMpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdpbXBhY3QnIHx8IGlkID09PSAndGFja2xlJyB8fCBpZCA9PT0gJ2NhdGNoJykgewogICAgICAgICAgICAgICAgb3NjLnR5cGUgPSAnc3F1YXJlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMTUwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgxMCwgdCArIDAuMik7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjIpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdjaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzYXd0b290aCc7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKDEwMCwgdCk7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKDQwMCwgdCArIDAuNSk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUodm9sICogMC41LCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgwLCB0ICsgMC41KTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR2VuZXJpYyBibGlwCiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoNDQwLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSh2b2wsIHQpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4wMSwgdCArIDAuMSk7CiAgICAgICAgICAgICAgICBvc2Muc3RhcnQodCk7CiAgICAgICAgICAgICAgICBvc2Muc3RvcCh0ICsgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheUJHTSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUubG9nKCJCR00gQXV0b3BsYXkgcHJldmVudGVkLCB3YWl0aW5nIGZvciBpbnRlcmFjdGlvbi4iKSk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQgJiYgdGhpcy5zaG91bGRCZVBsYXlpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IHt9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0TWFzdGVyVm9sdW1lKHZvbHVtZSkgewogICAgICAgICAgICB0aGlzLm1hc3RlclZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRCR01MZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRTRlhMZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVm9sdW1lcygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYmdtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBNYXRoLm1pbigxLCB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnNmeEdhaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gdGhpcy5tYXN0ZXJWb2x1bWUgKiB0aGlzLnNmeExldmVsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRNYXRjaFN0YXRlKHRlbnNpb24sIGlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSB0ZW5zaW9uOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBpc092ZXJ0aW1lOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iZ20gfHwgdGhpcy5pc011dGVkKSByZXR1cm47CgovLyBVc2VyIHJlcXVlc3RlZCBCR00gdG8gc3RheSBhdCAxeCBzcGVlZCBhbHdheXMKICAgICAgICAgICAgLy8gV2Uga2VlcCB2b2x1bWUgbW9kdWxhdGlvbiBmb3IgdGVuc2lvbiwgYnV0IHJlbW92ZSByYXRlIG1vZHVsYXRpb24uCiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdGFyZ2V0RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKDEuMCwgdGhpcy5tYXRjaFRlbnNpb24gfHwgMCk7CiAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gdCAqIDAuMzsgLy8gTG91ZGVyIHdoZW4gdGVuc2UKCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gMC4xOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBsZXJwU3BlZWQgPSBNYXRoLm1pbigxLjAsIGR0ICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHluYW1pY1ZvbCArPSAodGFyZ2V0RHluYW1pY1ZvbCAtIHRoaXMuY3VycmVudER5bmFtaWNWb2wpICogbGVycFNwZWVkOwoKICAgICAgICAgICAgLy8gRm9yY2UgMS4wIHJhdGUKICAgICAgICAgICAgaWYgKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAhPT0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5YmFja1JhdGUgPSAxLjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","./AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CnRoaXMuYmdtLnNyYyA9ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2wwcGhsMWxmdGQ4YTR2NnV2dGprZC9mZngtU291bmR0cmFja18tYmxpdHotb2ZmLWJsaXR6YmFsbC10aGVtZS0xLUNvdmVyLTIubXAzP3Jsa2V5PWp5bjlxaDI4bTRjeGVjdWgycXFtOTdhdWwmcmF3PTEnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gMC44OwogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIER5bmFtaWMgU3RhdGUgKFBpdGNoL1ZvbHVtZSBtb2R1bGF0aW9uKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlID0gMS4wOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREeW5hbWljVm9sID0gMS4wOwogICAgICAgICAgICB0aGlzLm1hdGNoVGVuc2lvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KdGhpcy5zZnhMaWJyYXJ5ID0gewogICAgICAgICAgICAgICAgJ3doaXN0bGUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zYzI1YWFyOHFtZjNibDBhb2pjbnEvV2hpc3RsZV9WYXItMS5tcDM/cmxrZXk9MTNhZ2IycXkwMHI2NzZlZ2x5djhwNzZyMiZyYXc9MScsCiAgICAgICAgICAgICAgICAnd2hpc3RsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS96NW83emtoMDF2NDkyYml3aDh1MzUvV2hpc3RsZV9WYXItMy5tcDM/cmxrZXk9bGpvZmdibGhzMTB0NWllY3B6ZmZueGtjNSZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvajA0NWpobGIyN3I1Y2xwYnJldmxnL3dhdGVybW92ZW1lbnRfcXVpY2sxLm1wMz9ybGtleT1vM3dpbzBqYXplc290czNvMTMyNTR3YmpqJnJhdz0xJywKICAgICAgICAgICAgICAgICdzd2ltMic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2Q5aWRtd2t3YmtsdW84OHNxbmpvcS93YXRlcm1vdmVtZW50X3F1aWNrMi5tcDM/cmxrZXk9ODR5OW1od2ZuYXg0bGE1ZnhxYTZnNnd4cyZyYXc9MScsCiAgICAgICAgICAgICAgICAnc3dpbTMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS80cWRzMmI1NWx1OGJxdTB5aHRkOXUvd2F0ZXJtb3ZlbWVudF9xdWljazMubXAzP3Jsa2V5PWc4ODF3dXc1YnQwdzVja2Z3eWsxNWhzcGkmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW00JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdXljMHZmZ3M4b2hicG1xcDJ1MXl2L1N3aW1fVmFyLTMubXAzP3Jsa2V5PTgzdDVqbHJnbHZ2cjV1dDE0NHdyZzMyNmMmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW01JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvamdzOG1vZmgyNnByeHptNzBxeWlxL1N3aW1fVmFyLTIubXAzP3Jsa2V5PXhrZHFjMnNjaTBjNHFiM2FjaHU5eGM4ZnUmcmF3PTEnLAoKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvNGltMHpjdnFhdmt4Zmg2amV4dnlhL3dhdGVyZGFzaC5tcDM/cmxrZXk9bjd4eDF0cW1kOHI3c2lheW00dHVheTc2ZiZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8waXhxbW9nbXU5YW9xYjR6dHVuaTkvRGFzaF9WYXItMy5tcDM/cmxrZXk9MGZmNjZtaDRqNWFubnh2dHY3NXdieW1icyZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9nMzZzZXhzcWRmZ2FqYnl6d2dzbXgvRGFzaF9WYXItMi5tcDM/cmxrZXk9dGswdGk1Zmg3ZndycnB1OWx3azFrMXBubCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2ltcGFjdCc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2QwNDdlcmpvNnBwcDIxNnNjNmRoOS93YXRlcl9pbXBhY3QubXAzP3Jsa2V5PWt1ZGNlbmtiaW5keHFsenhtMXB4dmRhcGImcmF3PTEnLAogICAgICAgICAgICAgICAgJ2ltcGFjdDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8wenVjbTR3MXNiMzk1OTNzam80am4vSW1wYWN0X1Zhci0zLm1wMz9ybGtleT1ya25obmoxNDJ4cXd4amsyMGpmbmg0NXU5JnJhdz0xJywKICAgICAgICAgICAgICAgICdpbXBhY3RfaGVhdnknOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9pOXNmZ2h4dTdmdm80c2szNmNwYXkvSW1wYWN0X01peGVkLUxheWVyLm1wMz9ybGtleT1xNmh3MDB1am1id28wMGlic2JweWFsaGhhJnJhdz0xJywKCiAgICAgICAgICAgICAgICAndGhyb3cnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9rb2Zhc3IzajByaDhkOW51bDNndTkvdGhyb3cubXAzP3Jsa2V5PW5wa3UxYXpqZWRxa21kcjY3MzlnZG90Z2wmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3Rocm93Mic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3o2b2l1aXVqZTdrNnAyNHR4amdidi9UaHJvd19WYXItMi5tcDM/cmxrZXk9dTFqMXphY2g2aXY3Y2VxczBsdjRyMGE5OCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ3RhY2tsZSc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3l6ZW1yNHczd2s5Ynk0ZDg4ZG0zYy9UYWNrbGVfVmFyLTIubXAzP3Jsa2V5PW40ZHgwY3BhZmpldWU5MzE3c2E2Z21yM2kmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3RhY2tsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS91aXI0N2poeXo3Z21wZnZsMmpsNzgvVGFja2xlX1Zhci0zLm1wMz9ybGtleT1hbDdjMjZ0YWY5dzV1c3V0d3ZkNTN2YmE5JnJhdz0xJywKCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zaGMzaWdtNGRhZDMzbG5idnFseHQvY2F0Y2gubXAzP3Jsa2V5PTZ5ZG5heGs4OW5mN2tlbm41Nnl1dW5sdWwmcmF3PTEnLAogICAgICAgICAgICAgICAgJ2NhdGNoX2p1bXAnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS95NmN5dGdmNXVtY3Z1eHg2M3k5cXAvQ2F0Y2hfSnVtcF9WYXItMS5tcDM/cmxrZXk9Y3B4aWozMmZhbTFrM3l2ZzBnbG93bm9paiZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2dvYWwnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS81NnhmM3kzbGVpNTgydWowcGZwaWUvR29hbF9WYXItMy5tcDM/cmxrZXk9Njd0eTN0eW5yY2oxb20zajAxMml4YmhxdCZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdjaGFyZ2UnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9oaXk4NWg2MGlseHY3aDllbWpqbHgvQ2hhcmdlX1Zhci0zLm1wMz9ybGtleT12d2Z2cmN3bTR2dmswemdkZHZ2cTJ3NGN3JnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ21lbnUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9raGd2NHk5Y3JyOXU5Nmlmam1qbGQvTWVudV9NYW5hZ2VyLkpzX1Zhci0xLm1wMz9ybGtleT1heHhkeTQwbXdzdTFjd2xwd3cwY3RrMTAxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3JlYWN0JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvbGxsbXgxZnRpenJnbzVkNGRtajY0L1JlYWN0X1Zhci0yLm1wMz9ybGtleT13ZDh3YnY5d3B2ZHNkM25xODB4eWh1dXRxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3RlY2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS84M2o3ZngwNnBsMXg4OW0wZjJ1MnAvR2x5cGhfTWFuYWdlci5Kc19WYXItMy5tcDM/cmxrZXk9emVweTl6ZnNneHNidncyaXA1bjlwdDhtcyZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdhbWJpZW50JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdjVpZTJ4a3JzZnhsdG16cWpvaGExL1N0YWRpdW0uSnNfVmFyLTEubXAzP3Jsa2V5PXdhMm9pMjhwem1scXloOGZ6djQ3anlqejYmcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAndWlfZ2VuZXJpYyc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2NmaGVocXRpN3YzdnBuZjBxcnJyZi9HYW1lX01hbmFnZXIuSnNfVmFyLTIubXAzP3Jsa2V5PTAyODkybDBiaW9lZnB0ZzhtMDF0dnppY2smcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAnYnViYmxlJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdDh5dGR0ZG9rbjlpNmNkY2MyeDQxL0lkbGVfVmFyLTIubXAzP3Jsa2V5PXE2cGVkcjBicHh3MmN1bTRtcXRycm01NnomcmF3PTEnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICAgICAgdGhpcy5faW5pdFdhdGNoZG9ncygpOwogICAgICAgIH0KCiAgICAgICAgX2luaXRXYXRjaGRvZ3MoKSB7CiAgICAgICAgICAgIC8vIEJHTSBMb29wICYgUmVzdW1lIExvZ2ljCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGUgPT4gY29uc29sZS53YXJuKCJCR00gUmVwbGF5IGZhaWw6IiwgZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJvYnVzdCBVbmxvY2sgU3RyYXRlZ3kgZm9yIE1vYmlsZSAoaU9TL0FuZHJvaWQpCiAgICAgICAgICAgIGNvbnN0IHVubG9jayA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eC5zdGF0ZSAhPT0gJ3J1bm5pbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgucmVzdW1lKCkudGhlbigoKSA9PiB7fSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgWydjbGljaycsICd0b3VjaHN0YXJ0JywgJ3RvdWNoZW5kJywgJ2tleWRvd24nLCAnbW91c2Vkb3duJ10uZm9yRWFjaChldnQgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIHRydWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTsKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c31gKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF1ZGlvQnVmZmVyID0gYXdhaXQgdGhpcy5jdHguZGVjb2RlQXVkaW9EYXRhKGFycmF5QnVmZmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycy5zZXQoaWQsIGF1ZGlvQnVmZmVyKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBdWRpb01hbmFnZXI6IExvYWRlZCBTRlggJyR7aWR9J2ApOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEF1ZGlvTWFuYWdlcjogRmFpbGVkIHRvIGxvYWQgU0ZYICcke2lkfScgZnJvbSAke3VybH0uIFVzaW5nIGZhbGxiYWNrLmAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcGxheVNGWChpZCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5jdHgucmVzdW1lKCkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICAgICAgLy8gLS0tIFNQRUNJQUwgSEFORExJTkcgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBXaGlzdGxlOiBMb3dlciB2b2x1bWUgJiBMYXllcmluZwogICAgICAgICAgICBpZiAoaWQgPT09ICd3aGlzdGxlJykgewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gKG9wdGlvbnMudm9sdW1lIHx8IDEuMCkgKiAwLjI7IC8vIFdheSBkb3duCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IE1haW4KICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVBbmRQbGF5KCd3aGlzdGxlJywgeyAuLi5vcHRpb25zLCB2b2x1bWU6IHZvbCB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTGF5ZXIgMjogRWNoby9TdGFkaXVtIFJldmVyYiAoU2xpZ2h0bHkgZGVsYXllZCwgbG93ZXIgcGl0Y2gpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheSgnd2hpc3RsZScsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsIAogICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWU6IHZvbCAqIDAuNiwgCiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IChvcHRpb25zLnJhdGUgfHwgMS4wKSAqIDAuOTUgCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCA4MCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERhc2g6IEJvb3N0IFZvbHVtZSAoVXNlciByZXBvcnRlZCBub3QgaGVhcmluZyBpdCkKICAgICAgICAgICAgaWYgKGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIC8vIENsb25lIG9wdGlvbnMgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgcmVmZXJlbmNlIGlmIHJldXNlZAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgdm9sdW1lOiAob3B0aW9ucy52b2x1bWUgfHwgMS4wKSAqIDIuNSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheShpZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcmVzb2x2ZUFuZFBsYXkoaWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgbGV0IHRhcmdldElkID0gaWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemF0aW9uIExvZ2ljCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ3N3aW0nKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydzd2ltJywgJ3N3aW0yJywgJ3N3aW0zJywgJ3N3aW00JywgJ3N3aW01J107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2Rhc2gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydkYXNoJywgJ2Rhc2gyJywgJ2Rhc2gzJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2ltcGFjdCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ2ltcGFjdCcsICdpbXBhY3QyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3Rocm93JykgewogICAgICAgICAgICAgICAgY29uc3QgdmFycyA9IFsndGhyb3cnLCAndGhyb3cyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3RhY2tsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ3RhY2tsZScsICd0YWNrbGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3doaXN0bGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWyd3aGlzdGxlJywgJ3doaXN0bGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcGxheVJhdyh0YXJnZXRJZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcGxheVJhdyhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCBidWZmZXIgPSB0aGlzLnNmeEJ1ZmZlcnMuZ2V0KGlkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBGQUxMQkFDSyBTWU5USEVTSVMgLS0tCiAgICAgICAgICAgIGlmICghYnVmZmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBzb3VyY2UuYnVmZmVyID0gYnVmZmVyOwoKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSBvcHRpb25zLnZhcmlhbmNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZhcmlhbmNlIDogMC4xOwogICAgICAgICAgICBsZXQgcmF0ZSA9IG9wdGlvbnMucmF0ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5yYXRlIDogMS4wOwoKICAgICAgICAgICAgaWYgKHZhcmlhbmNlID4gMCkgewogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UucGxheWJhY2tSYXRlLnZhbHVlID0gTWF0aC5tYXgoMC4xLCBNYXRoLm1pbig0LjAsIHJhdGUpKTsKCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIF9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5jdHguY3VycmVudFRpbWU7CiAgICAgICAgICAgIGNvbnN0IG9zYyA9IHRoaXMuY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICAgICAgICAgICAgY29uc3QgZ2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgICAgICBnYWluLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZvbCA9IG9wdGlvbnMudm9sdW1lICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZvbHVtZSA6IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoODAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg0MDAsIHQgKyAwLjEpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKHZvbCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjAxLCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlkID09PSAndGhyb3cnIHx8IGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIG9zYy50eXBlID0gJ3RyaWFuZ2xlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMzAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg1MCwgdCArIDAuMyk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjMpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdpbXBhY3QnIHx8IGlkID09PSAndGFja2xlJyB8fCBpZCA9PT0gJ2NhdGNoJykgewogICAgICAgICAgICAgICAgb3NjLnR5cGUgPSAnc3F1YXJlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMTUwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgxMCwgdCArIDAuMik7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjIpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdjaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzYXd0b290aCc7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKDEwMCwgdCk7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKDQwMCwgdCArIDAuNSk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUodm9sICogMC41LCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgwLCB0ICsgMC41KTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR2VuZXJpYyBibGlwCiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoNDQwLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSh2b2wsIHQpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4wMSwgdCArIDAuMSk7CiAgICAgICAgICAgICAgICBvc2Muc3RhcnQodCk7CiAgICAgICAgICAgICAgICBvc2Muc3RvcCh0ICsgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheUJHTSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUubG9nKCJCR00gQXV0b3BsYXkgcHJldmVudGVkLCB3YWl0aW5nIGZvciBpbnRlcmFjdGlvbi4iKSk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQgJiYgdGhpcy5zaG91bGRCZVBsYXlpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IHt9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0TWFzdGVyVm9sdW1lKHZvbHVtZSkgewogICAgICAgICAgICB0aGlzLm1hc3RlclZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRCR01MZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRTRlhMZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVm9sdW1lcygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYmdtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBNYXRoLm1pbigxLCB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnNmeEdhaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gdGhpcy5tYXN0ZXJWb2x1bWUgKiB0aGlzLnNmeExldmVsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRNYXRjaFN0YXRlKHRlbnNpb24sIGlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSB0ZW5zaW9uOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBpc092ZXJ0aW1lOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iZ20gfHwgdGhpcy5pc011dGVkKSByZXR1cm47CgovLyBVc2VyIHJlcXVlc3RlZCBCR00gdG8gc3RheSBhdCAxeCBzcGVlZCBhbHdheXMKICAgICAgICAgICAgLy8gV2Uga2VlcCB2b2x1bWUgbW9kdWxhdGlvbiBmb3IgdGVuc2lvbiwgYnV0IHJlbW92ZSByYXRlIG1vZHVsYXRpb24uCiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdGFyZ2V0RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKDEuMCwgdGhpcy5tYXRjaFRlbnNpb24gfHwgMCk7CiAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gdCAqIDAuMzsgLy8gTG91ZGVyIHdoZW4gdGVuc2UKCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gMC4xOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBsZXJwU3BlZWQgPSBNYXRoLm1pbigxLjAsIGR0ICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHluYW1pY1ZvbCArPSAodGFyZ2V0RHluYW1pY1ZvbCAtIHRoaXMuY3VycmVudER5bmFtaWNWb2wpICogbGVycFNwZWVkOwoKICAgICAgICAgICAgLy8gRm9yY2UgMS4wIHJhdGUKICAgICAgICAgICAgaWYgKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAhPT0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5YmFja1JhdGUgPSAxLjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","/AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CnRoaXMuYmdtLnNyYyA9ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2wwcGhsMWxmdGQ4YTR2NnV2dGprZC9mZngtU291bmR0cmFja18tYmxpdHotb2ZmLWJsaXR6YmFsbC10aGVtZS0xLUNvdmVyLTIubXAzP3Jsa2V5PWp5bjlxaDI4bTRjeGVjdWgycXFtOTdhdWwmcmF3PTEnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gLS0tIFNGWCBTWVNURU0gKFdlYiBBdWRpbyBBUEkgZm9yIHByZWNpc2lvbiAmIHZhcmlhbmNlKSAtLS0KICAgICAgICAgICAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBHYWluIGZvciBTRlgKICAgICAgICAgICAgdGhpcy5zZnhHYWluID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gMC41OwoKICAgICAgICAgICAgLy8gVm9sdW1lIFN0YXRlCiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gMC44OwogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIER5bmFtaWMgU3RhdGUgKFBpdGNoL1ZvbHVtZSBtb2R1bGF0aW9uKQogICAgICAgICAgICB0aGlzLmN1cnJlbnRSYXRlID0gMS4wOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREeW5hbWljVm9sID0gMS4wOwogICAgICAgICAgICB0aGlzLm1hdGNoVGVuc2lvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuaXNPdmVydGltZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KdGhpcy5zZnhMaWJyYXJ5ID0gewogICAgICAgICAgICAgICAgJ3doaXN0bGUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zYzI1YWFyOHFtZjNibDBhb2pjbnEvV2hpc3RsZV9WYXItMS5tcDM/cmxrZXk9MTNhZ2IycXkwMHI2NzZlZ2x5djhwNzZyMiZyYXc9MScsCiAgICAgICAgICAgICAgICAnd2hpc3RsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS96NW83emtoMDF2NDkyYml3aDh1MzUvV2hpc3RsZV9WYXItMy5tcDM/cmxrZXk9bGpvZmdibGhzMTB0NWllY3B6ZmZueGtjNSZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvajA0NWpobGIyN3I1Y2xwYnJldmxnL3dhdGVybW92ZW1lbnRfcXVpY2sxLm1wMz9ybGtleT1vM3dpbzBqYXplc290czNvMTMyNTR3YmpqJnJhdz0xJywKICAgICAgICAgICAgICAgICdzd2ltMic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2Q5aWRtd2t3YmtsdW84OHNxbmpvcS93YXRlcm1vdmVtZW50X3F1aWNrMi5tcDM/cmxrZXk9ODR5OW1od2ZuYXg0bGE1ZnhxYTZnNnd4cyZyYXc9MScsCiAgICAgICAgICAgICAgICAnc3dpbTMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS80cWRzMmI1NWx1OGJxdTB5aHRkOXUvd2F0ZXJtb3ZlbWVudF9xdWljazMubXAzP3Jsa2V5PWc4ODF3dXc1YnQwdzVja2Z3eWsxNWhzcGkmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW00JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdXljMHZmZ3M4b2hicG1xcDJ1MXl2L1N3aW1fVmFyLTMubXAzP3Jsa2V5PTgzdDVqbHJnbHZ2cjV1dDE0NHdyZzMyNmMmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3N3aW01JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvamdzOG1vZmgyNnByeHptNzBxeWlxL1N3aW1fVmFyLTIubXAzP3Jsa2V5PXhrZHFjMnNjaTBjNHFiM2FjaHU5eGM4ZnUmcmF3PTEnLAoKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvNGltMHpjdnFhdmt4Zmg2amV4dnlhL3dhdGVyZGFzaC5tcDM/cmxrZXk9bjd4eDF0cW1kOHI3c2lheW00dHVheTc2ZiZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8waXhxbW9nbXU5YW9xYjR6dHVuaTkvRGFzaF9WYXItMy5tcDM/cmxrZXk9MGZmNjZtaDRqNWFubnh2dHY3NXdieW1icyZyYXc9MScsCiAgICAgICAgICAgICAgICAnZGFzaDMnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9nMzZzZXhzcWRmZ2FqYnl6d2dzbXgvRGFzaF9WYXItMi5tcDM/cmxrZXk9dGswdGk1Zmg3ZndycnB1OWx3azFrMXBubCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2ltcGFjdCc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2QwNDdlcmpvNnBwcDIxNnNjNmRoOS93YXRlcl9pbXBhY3QubXAzP3Jsa2V5PWt1ZGNlbmtiaW5keHFsenhtMXB4dmRhcGImcmF3PTEnLAogICAgICAgICAgICAgICAgJ2ltcGFjdDInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS8wenVjbTR3MXNiMzk1OTNzam80am4vSW1wYWN0X1Zhci0zLm1wMz9ybGtleT1ya25obmoxNDJ4cXd4amsyMGpmbmg0NXU5JnJhdz0xJywKICAgICAgICAgICAgICAgICdpbXBhY3RfaGVhdnknOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9pOXNmZ2h4dTdmdm80c2szNmNwYXkvSW1wYWN0X01peGVkLUxheWVyLm1wMz9ybGtleT1xNmh3MDB1am1id28wMGlic2JweWFsaGhhJnJhdz0xJywKCiAgICAgICAgICAgICAgICAndGhyb3cnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9rb2Zhc3IzajByaDhkOW51bDNndTkvdGhyb3cubXAzP3Jsa2V5PW5wa3UxYXpqZWRxa21kcjY3MzlnZG90Z2wmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3Rocm93Mic6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3o2b2l1aXVqZTdrNnAyNHR4amdidi9UaHJvd19WYXItMi5tcDM/cmxrZXk9dTFqMXphY2g2aXY3Y2VxczBsdjRyMGE5OCZyYXc9MScsCgogICAgICAgICAgICAgICAgJ3RhY2tsZSc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL3l6ZW1yNHczd2s5Ynk0ZDg4ZG0zYy9UYWNrbGVfVmFyLTIubXAzP3Jsa2V5PW40ZHgwY3BhZmpldWU5MzE3c2E2Z21yM2kmcmF3PTEnLAogICAgICAgICAgICAgICAgJ3RhY2tsZTInOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS91aXI0N2poeXo3Z21wZnZsMmpsNzgvVGFja2xlX1Zhci0zLm1wMz9ybGtleT1hbDdjMjZ0YWY5dzV1c3V0d3ZkNTN2YmE5JnJhdz0xJywKCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9zaGMzaWdtNGRhZDMzbG5idnFseHQvY2F0Y2gubXAzP3Jsa2V5PTZ5ZG5heGs4OW5mN2tlbm41Nnl1dW5sdWwmcmF3PTEnLAogICAgICAgICAgICAgICAgJ2NhdGNoX2p1bXAnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS95NmN5dGdmNXVtY3Z1eHg2M3k5cXAvQ2F0Y2hfSnVtcF9WYXItMS5tcDM/cmxrZXk9Y3B4aWozMmZhbTFrM3l2ZzBnbG93bm9paiZyYXc9MScsCgogICAgICAgICAgICAgICAgJ2dvYWwnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS81NnhmM3kzbGVpNTgydWowcGZwaWUvR29hbF9WYXItMy5tcDM/cmxrZXk9Njd0eTN0eW5yY2oxb20zajAxMml4YmhxdCZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdjaGFyZ2UnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9oaXk4NWg2MGlseHY3aDllbWpqbHgvQ2hhcmdlX1Zhci0zLm1wMz9ybGtleT12d2Z2cmN3bTR2dmswemdkZHZ2cTJ3NGN3JnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ21lbnUnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS9raGd2NHk5Y3JyOXU5Nmlmam1qbGQvTWVudV9NYW5hZ2VyLkpzX1Zhci0xLm1wMz9ybGtleT1heHhkeTQwbXdzdTFjd2xwd3cwY3RrMTAxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3JlYWN0JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvbGxsbXgxZnRpenJnbzVkNGRtajY0L1JlYWN0X1Zhci0yLm1wMz9ybGtleT13ZDh3YnY5d3B2ZHNkM25xODB4eWh1dXRxJnJhdz0xJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJ3RlY2gnOiAnaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3NjbC9maS84M2o3ZngwNnBsMXg4OW0wZjJ1MnAvR2x5cGhfTWFuYWdlci5Kc19WYXItMy5tcDM/cmxrZXk9emVweTl6ZnNneHNidncyaXA1bjlwdDhtcyZyYXc9MScsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICdhbWJpZW50JzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdjVpZTJ4a3JzZnhsdG16cWpvaGExL1N0YWRpdW0uSnNfVmFyLTEubXAzP3Jsa2V5PXdhMm9pMjhwem1scXloOGZ6djQ3anlqejYmcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAndWlfZ2VuZXJpYyc6ICdodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vc2NsL2ZpL2NmaGVocXRpN3YzdnBuZjBxcnJyZi9HYW1lX01hbmFnZXIuSnNfVmFyLTIubXAzP3Jsa2V5PTAyODkybDBiaW9lZnB0ZzhtMDF0dnppY2smcmF3PTEnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAnYnViYmxlJzogJ2h0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS9zY2wvZmkvdDh5dGR0ZG9rbjlpNmNkY2MyeDQxL0lkbGVfVmFyLTIubXAzP3Jsa2V5PXE2cGVkcjBicHh3MmN1bTRtcXRycm01NnomcmF3PTEnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICAgICAgdGhpcy5faW5pdFdhdGNoZG9ncygpOwogICAgICAgIH0KCiAgICAgICAgX2luaXRXYXRjaGRvZ3MoKSB7CiAgICAgICAgICAgIC8vIEJHTSBMb29wICYgUmVzdW1lIExvZ2ljCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGUgPT4gY29uc29sZS53YXJuKCJCR00gUmVwbGF5IGZhaWw6IiwgZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJvYnVzdCBVbmxvY2sgU3RyYXRlZ3kgZm9yIE1vYmlsZSAoaU9TL0FuZHJvaWQpCiAgICAgICAgICAgIGNvbnN0IHVubG9jayA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eC5zdGF0ZSAhPT0gJ3J1bm5pbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgucmVzdW1lKCkudGhlbigoKSA9PiB7fSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgWydjbGljaycsICd0b3VjaHN0YXJ0JywgJ3RvdWNoZW5kJywgJ2tleWRvd24nLCAnbW91c2Vkb3duJ10uZm9yRWFjaChldnQgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIHRydWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTsKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c31gKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF1ZGlvQnVmZmVyID0gYXdhaXQgdGhpcy5jdHguZGVjb2RlQXVkaW9EYXRhKGFycmF5QnVmZmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4QnVmZmVycy5zZXQoaWQsIGF1ZGlvQnVmZmVyKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBdWRpb01hbmFnZXI6IExvYWRlZCBTRlggJyR7aWR9J2ApOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEF1ZGlvTWFuYWdlcjogRmFpbGVkIHRvIGxvYWQgU0ZYICcke2lkfScgZnJvbSAke3VybH0uIFVzaW5nIGZhbGxiYWNrLmAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcGxheVNGWChpZCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuY3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgdGhpcy5jdHgucmVzdW1lKCkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICAgICAgLy8gLS0tIFNQRUNJQUwgSEFORExJTkcgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBXaGlzdGxlOiBMb3dlciB2b2x1bWUgJiBMYXllcmluZwogICAgICAgICAgICBpZiAoaWQgPT09ICd3aGlzdGxlJykgewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gKG9wdGlvbnMudm9sdW1lIHx8IDEuMCkgKiAwLjI7IC8vIFdheSBkb3duCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IE1haW4KICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVBbmRQbGF5KCd3aGlzdGxlJywgeyAuLi5vcHRpb25zLCB2b2x1bWU6IHZvbCB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTGF5ZXIgMjogRWNoby9TdGFkaXVtIFJldmVyYiAoU2xpZ2h0bHkgZGVsYXllZCwgbG93ZXIgcGl0Y2gpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheSgnd2hpc3RsZScsIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsIAogICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWU6IHZvbCAqIDAuNiwgCiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGU6IChvcHRpb25zLnJhdGUgfHwgMS4wKSAqIDAuOTUgCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCA4MCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERhc2g6IEJvb3N0IFZvbHVtZSAoVXNlciByZXBvcnRlZCBub3QgaGVhcmluZyBpdCkKICAgICAgICAgICAgaWYgKGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIC8vIENsb25lIG9wdGlvbnMgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgcmVmZXJlbmNlIGlmIHJldXNlZAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgdm9sdW1lOiAob3B0aW9ucy52b2x1bWUgfHwgMS4wKSAqIDIuNSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNvbHZlQW5kUGxheShpZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcmVzb2x2ZUFuZFBsYXkoaWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgbGV0IHRhcmdldElkID0gaWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemF0aW9uIExvZ2ljCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ3N3aW0nKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydzd2ltJywgJ3N3aW0yJywgJ3N3aW0zJywgJ3N3aW00JywgJ3N3aW01J107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2Rhc2gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWydkYXNoJywgJ2Rhc2gyJywgJ2Rhc2gzJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ2ltcGFjdCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ2ltcGFjdCcsICdpbXBhY3QyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3Rocm93JykgewogICAgICAgICAgICAgICAgY29uc3QgdmFycyA9IFsndGhyb3cnLCAndGhyb3cyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3RhY2tsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcnMgPSBbJ3RhY2tsZScsICd0YWNrbGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpZCA9PT0gJ3doaXN0bGUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJzID0gWyd3aGlzdGxlJywgJ3doaXN0bGUyJ107CiAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHZhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFycy5sZW5ndGgpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcGxheVJhdyh0YXJnZXRJZCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICBfcGxheVJhdyhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCBidWZmZXIgPSB0aGlzLnNmeEJ1ZmZlcnMuZ2V0KGlkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBGQUxMQkFDSyBTWU5USEVTSVMgLS0tCiAgICAgICAgICAgIGlmICghYnVmZmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBzb3VyY2UuYnVmZmVyID0gYnVmZmVyOwoKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSBvcHRpb25zLnZhcmlhbmNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZhcmlhbmNlIDogMC4xOwogICAgICAgICAgICBsZXQgcmF0ZSA9IG9wdGlvbnMucmF0ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5yYXRlIDogMS4wOwoKICAgICAgICAgICAgaWYgKHZhcmlhbmNlID4gMCkgewogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UucGxheWJhY2tSYXRlLnZhbHVlID0gTWF0aC5tYXgoMC4xLCBNYXRoLm1pbig0LjAsIHJhdGUpKTsKCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIF9wbGF5U3ludGhGYWxsYmFjayhpZCwgb3B0aW9ucykgewogICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5jdHguY3VycmVudFRpbWU7CiAgICAgICAgICAgIGNvbnN0IG9zYyA9IHRoaXMuY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICAgICAgICAgICAgY29uc3QgZ2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgICAgICBnYWluLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZvbCA9IG9wdGlvbnMudm9sdW1lICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZvbHVtZSA6IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpZCA9PT0gJ21lbnUnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoODAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg0MDAsIHQgKyAwLjEpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKHZvbCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjAxLCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlkID09PSAndGhyb3cnIHx8IGlkID09PSAnZGFzaCcpIHsKICAgICAgICAgICAgICAgIG9zYy50eXBlID0gJ3RyaWFuZ2xlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMzAwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSg1MCwgdCArIDAuMyk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjMpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdpbXBhY3QnIHx8IGlkID09PSAndGFja2xlJyB8fCBpZCA9PT0gJ2NhdGNoJykgewogICAgICAgICAgICAgICAgb3NjLnR5cGUgPSAnc3F1YXJlJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMTUwLCB0KTsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgxMCwgdCArIDAuMik7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUodm9sLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDEsIHQgKyAwLjIpOwogICAgICAgICAgICAgICAgb3NjLnN0YXJ0KHQpOwogICAgICAgICAgICAgICAgb3NjLnN0b3AodCArIDAuMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaWQgPT09ICdjaGFyZ2UnKSB7CiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzYXd0b290aCc7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKDEwMCwgdCk7CiAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKDQwMCwgdCArIDAuNSk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMCwgdCk7CiAgICAgICAgICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUodm9sICogMC41LCB0ICsgMC4xKTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgwLCB0ICsgMC41KTsKICAgICAgICAgICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICAgICAgICAgIG9zYy5zdG9wKHQgKyAwLjUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR2VuZXJpYyBibGlwCiAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoNDQwLCB0KTsKICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSh2b2wsIHQpOwogICAgICAgICAgICAgICAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4wMSwgdCArIDAuMSk7CiAgICAgICAgICAgICAgICBvc2Muc3RhcnQodCk7CiAgICAgICAgICAgICAgICBvc2Muc3RvcCh0ICsgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheUJHTSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUubG9nKCJCR00gQXV0b3BsYXkgcHJldmVudGVkLCB3YWl0aW5nIGZvciBpbnRlcmFjdGlvbi4iKSk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQgJiYgdGhpcy5zaG91bGRCZVBsYXlpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IHt9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0TWFzdGVyVm9sdW1lKHZvbHVtZSkgewogICAgICAgICAgICB0aGlzLm1hc3RlclZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRCR01MZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLmJnbUxldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBzZXRTRlhMZXZlbChsZXZlbCkgewogICAgICAgICAgICB0aGlzLnNmeExldmVsID0gTWF0aC5tYXgoMCwgbGV2ZWwpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVWb2x1bWVzKCk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlVm9sdW1lcygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYmdtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBNYXRoLm1pbigxLCB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnNmeEdhaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Z4R2Fpbi5nYWluLnZhbHVlID0gdGhpcy5tYXN0ZXJWb2x1bWUgKiB0aGlzLnNmeExldmVsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRNYXRjaFN0YXRlKHRlbnNpb24sIGlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgdGhpcy5tYXRjaFRlbnNpb24gPSB0ZW5zaW9uOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSBpc092ZXJ0aW1lOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iZ20gfHwgdGhpcy5pc011dGVkKSByZXR1cm47CgovLyBVc2VyIHJlcXVlc3RlZCBCR00gdG8gc3RheSBhdCAxeCBzcGVlZCBhbHdheXMKICAgICAgICAgICAgLy8gV2Uga2VlcCB2b2x1bWUgbW9kdWxhdGlvbiBmb3IgdGVuc2lvbiwgYnV0IHJlbW92ZSByYXRlIG1vZHVsYXRpb24uCiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdGFyZ2V0RHluYW1pY1ZvbCA9IDEuMDsKICAgICAgICAgICAgY29uc3QgdCA9IE1hdGgubWluKDEuMCwgdGhpcy5tYXRjaFRlbnNpb24gfHwgMCk7CiAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gdCAqIDAuMzsgLy8gTG91ZGVyIHdoZW4gdGVuc2UKCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRhcmdldER5bmFtaWNWb2wgKz0gMC4xOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBsZXJwU3BlZWQgPSBNYXRoLm1pbigxLjAsIGR0ICogMi4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHluYW1pY1ZvbCArPSAodGFyZ2V0RHluYW1pY1ZvbCAtIHRoaXMuY3VycmVudER5bmFtaWNWb2wpICogbGVycFNwZWVkOwoKICAgICAgICAgICAgLy8gRm9yY2UgMS4wIHJhdGUKICAgICAgICAgICAgaWYgKHRoaXMuYmdtLnBsYXliYWNrUmF0ZSAhPT0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5YmFja1JhdGUgPSAxLjA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhc2VWb2wgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuYmdtTGV2ZWw7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsVm9sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMS4wLCBiYXNlVm9sICogdGhpcy5jdXJyZW50RHluYW1pY1ZvbCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuYmdtLnZvbHVtZSAtIGZpbmFsVm9sKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS52b2x1bWUgPSBmaW5hbFZvbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZykgdGhpcy5iZ20ucGxheSgpLmNhdGNoKGU9Pnt9KTsKICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzTXV0ZWQ7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlciA9IEF1ZGlvTWFuYWdlcjsKfSkoKTs=","LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","./LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","/LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzID0ge307IC8vIFN0b3JlIG1hdGVyaWFscyBmb3IgdGhlbWluZwogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAp0aGlzLmNyb3dkID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRHb2FsQmFycmllcnMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CmNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLmJvd2wgPSBib3dsTWF0OwogICAgICAgICAgICBjb25zdCBib3dsID0gbmV3IFRIUkVFLk1lc2goYm93bEdlbywgYm93bE1hdCk7CiAgICAgICAgICAgIGJvd2wucG9zaXRpb24ueSA9IDIwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoYm93bCk7CgogICAgICAgICAgICAvLyAyLiBTZWF0aW5nIFRpZXJzIChDb25jZW50cmljIFJpbmdzKQpjb25zdCB0aWVyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MTExYTIyLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICBjb25zdCByaW1NYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMDQ0NjYgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnRpZXIgPSB0aWVyTWF0OwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscy5yaW0gPSByaW1NYXQ7CgogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy50aWVyczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKGkgKiB0aGlzLmNvbmZpZy50aWVySGVpZ2h0KSAtIDMwOwogICAgICAgICAgICAgICAgY29uc3QgcklubmVyID0gdGhpcy5jb25maWcucmFkaXVzICsgKGkgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSk7CiAgICAgICAgICAgICAgICBjb25zdCByT3V0ZXIgPSBySW5uZXIgKyB0aGlzLmNvbmZpZy50aWVyRGVwdGg7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZsb29yIFJpbmcKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KHJJbm5lciwgck91dGVyLCA2NCk7CiAgICAgICAgICAgICAgICByaW5nR2VvLnJvdGF0ZVgoLU1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCB0aWVyTWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdsb3dpbmcgUmltIChUaGUgIlRlY2giIGZlZWwpCiAgICAgICAgICAgICAgICBjb25zdCByaW1HZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeShySW5uZXIsIDAuOCwgNCwgNjQpOwogICAgICAgICAgICAgICAgcmltR2VvLnJvdGF0ZVgoTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgcmltID0gbmV3IFRIUkVFLk1lc2gocmltR2VvLCByaW1NYXQpOwogICAgICAgICAgICAgICAgcmltLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIE1hc3NpdmUgUGlsbGFycyAoVGhlICJIZXJjdWxlYW4iIFN1cHBvcnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg4LCAyMDAsIDgpOwpjb25zdCBwaWxsYXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwNTA1MDUgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnBpbGxhciA9IHBpbGxhck1hdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCi8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIHNwcml0ZS5wb3NpdGlvbi5zZXQoeCwgeVBvcywgeik7CiAgICAgICAgICAgICAgICBzcHJpdGUuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBMYXJnZSBnbG93CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLnB1c2goc3ByaXRlKTsKCi8vIDMuIEFjdHVhbCBQb2ludCBMaWdodCAtIFJFTU9WRUQgZm9yIG9wdGltaXphdGlvbgogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgdXNlIE1lc2hCYXNpY01hdGVyaWFsIChVbmxpdCksIHJlYWwgbGlnaHRzIHdhc3RlIENQVS9HUFUgcmVzb3VyY2VzLgogICAgICAgICAgICAgICAgLy8gVGhlIHNwcml0ZSBnbG93IGFib3ZlIHByb3ZpZGVzIHRoZSB2aXN1YWwgZWZmZWN0LgogICAgICAgICAgICB9Cn0KCiAgICAgICAgX2J1aWxkR29hbEJhcnJpZXJzKCkgewogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBJbnZlcnRlZCBUcmlhbmdsZSAoTWF0Y2hlcyBHb2FsIEhpdGJveCkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KFsKLTE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMC4wLCAtMTguMCwgMC4wICAvLyBCb3R0b20gQ2VudGVyCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVVZzIGZvciBzaGFkZXIgZWZmZWN0cwogICAgICAgICAgICBjb25zdCB1dnMgPSBuZXcgRmxvYXQzMkFycmF5KFsKICAgICAgICAgICAgICAgIDAuMCwgMS4wLAogICAgICAgICAgICAgICAgMS4wLCAxLjAsCiAgICAgICAgICAgICAgICAwLjUsIDAuMAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW9tZXRyeS5jb21wdXRlVmVydGV4Tm9ybWFscygpOwoKICAgICAgICAgICAgLy8gRm9yY2VmaWVsZCBTaGFkZXIKLy8gRm9yY2VmaWVsZCBTaGFkZXIKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4NDRhYWZmKSB9LCAvLyBDeWFuL0JsdWUgRW5lcmd5CiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9IC8vIEludmlzaWJsZSBieSBkZWZhdWx0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUNvbG9yOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIZXggUGF0dGVybiBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2ICogMTUuMDsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICB1di55ICs9IHVUaW1lICogMC41OyAvLyBTY3JvbGwgZG93bgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxleC1saWtlIGdyaWQgZm9yIGhleCBhcHByb3hpbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgciA9IHZlYzIoMS4wLCAxLjczKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBoID0gciAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBhID0gbW9kKHV2LCByKSAtIGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgYiA9IG1vZCh1diAtIGgsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBnID0gZG90KGEsIGEpIDwgZG90KGIsIGIpID8gYSA6IGI7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBsZW5ndGgoZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGluIGxpbmVzCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGhleCA9IHNtb290aHN0ZXAoMC40NSwgMC40OCwgZGlzdCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2NhbiA9IHNpbih2VXYueSAqIDMwLjAgLSB1VGltZSAqIDIuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBFZGdlIEdsb3cgKEZyZXNuZWwtaXNoKQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gcG93KGFicyh2VXYueCAtIDAuNSkgKiAyLjAsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcGF0dGVybiA9ICgxLjAgLSBoZXgpICogMC41OyAvLyBTdHJvbmdlciBncmlkCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm4gKz0gc2NhbiAqIDAuMjsgICAgICAgICAgICAgLy8gU3Ryb25nZXIgc2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBlZGdlICogMC42OyAgICAgICAgICAgICAvLyBTdHJvbmdlciBlZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXN0ZXIgT3BhY2l0eSBDb250cm9sICgwID0gSW52aXNpYmxlLCAxID0gVmlzaWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBmaWxsIDAuMSArIHBhdHRlcm4sIHNjYWxlZCBieSB1T3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9ICgwLjEgKyBwYXR0ZXJuKSAqIHVPcGFjaXR5OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGludAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQmFycmllciBBIChBd2F5IEdvYWwgLyAtWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQS5wb3NpdGlvbi5zZXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuYmFycmllckEpOwoKICAgICAgICAgICAgLy8gQmFycmllciBCIChIb21lIEdvYWwgLyArWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQi5wb3NpdGlvbi5zZXQoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOyAvLyBGYWNlIGlud2FyZAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmJhcnJpZXJzID0gW3RoaXMuYmFycmllckEsIHRoaXMuYmFycmllckJdOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQp0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldFRoZW1lKHZpc3VhbHMpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWxzLmJvd2wpIHRoaXMubWF0ZXJpYWxzLmJvd2wuY29sb3Iuc2V0SGV4KHZpc3VhbHMuc3RydWN0dXJlQ29sb3IpOwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMudGllcikgdGhpcy5tYXRlcmlhbHMudGllci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIGlmICh0aGlzLm1hdGVyaWFscy5waWxsYXIpIHRoaXMubWF0ZXJpYWxzLnBpbGxhci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBSaW0vQWNjZW50IENvbG9ycwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMucmltKSB0aGlzLm1hdGVyaWFscy5yaW0uY29sb3Iuc2V0SGV4KHZpc3VhbHMucmltQ29sb3IpOwoKICAgICAgICAgICAgLy8gMy4gTGlnaHRzIChHbG9iYWwgU3ByaXRlIE1hdGVyaWFsKQogICAgICAgICAgICBpZiAodmlzdWFscy5saWdodENvbG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIF9nbG93TWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHZpc3VhbHMubGlnaHRDb2xvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhcnJpZXJzIChGb3JjZWZpZWxkcykKICAgICAgICAgICAgaWYgKHRoaXMuYmFycmllcnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFycmllcnMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5tYXRlcmlhbCAmJiBiLm1hdGVyaWFsLnVuaWZvcm1zICYmIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh2aXN1YWxzLmxpZ2h0Q29sb3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyA1LiBSaW5ncyAoSGVyY3VsZWFuKQogICAgICAgICAgICAvLyBBY2Nlc3MgdGhlIG1hdGVyaWFsIGZyb20gdGhlIGZpcnN0IHJpbmcgKHRoZXkgc2hhcmUgaXQpCiAgICAgICAgICAgIGlmICh0aGlzLnJpbmdzLmxlbmd0aCA+IDAgJiYgdGhpcy5yaW5nc1swXS5tZXNoICYmIHRoaXMucmluZ3NbMF0ubWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5yaW5nc1swXS5tZXNoLm1hdGVyaWFsLmNvbG9yLnNldEhleCh2aXN1YWxzLnJpbUNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVGhlbWUodmlzdWFscykgewogICAgICAgICAgICB0aGlzLnNldFRoZW1lKHZpc3VhbHMpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","./Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzID0ge307IC8vIFN0b3JlIG1hdGVyaWFscyBmb3IgdGhlbWluZwogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAp0aGlzLmNyb3dkID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRHb2FsQmFycmllcnMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CmNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLmJvd2wgPSBib3dsTWF0OwogICAgICAgICAgICBjb25zdCBib3dsID0gbmV3IFRIUkVFLk1lc2goYm93bEdlbywgYm93bE1hdCk7CiAgICAgICAgICAgIGJvd2wucG9zaXRpb24ueSA9IDIwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoYm93bCk7CgogICAgICAgICAgICAvLyAyLiBTZWF0aW5nIFRpZXJzIChDb25jZW50cmljIFJpbmdzKQpjb25zdCB0aWVyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MTExYTIyLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICBjb25zdCByaW1NYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMDQ0NjYgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnRpZXIgPSB0aWVyTWF0OwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscy5yaW0gPSByaW1NYXQ7CgogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy50aWVyczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKGkgKiB0aGlzLmNvbmZpZy50aWVySGVpZ2h0KSAtIDMwOwogICAgICAgICAgICAgICAgY29uc3QgcklubmVyID0gdGhpcy5jb25maWcucmFkaXVzICsgKGkgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSk7CiAgICAgICAgICAgICAgICBjb25zdCByT3V0ZXIgPSBySW5uZXIgKyB0aGlzLmNvbmZpZy50aWVyRGVwdGg7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZsb29yIFJpbmcKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KHJJbm5lciwgck91dGVyLCA2NCk7CiAgICAgICAgICAgICAgICByaW5nR2VvLnJvdGF0ZVgoLU1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCB0aWVyTWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdsb3dpbmcgUmltIChUaGUgIlRlY2giIGZlZWwpCiAgICAgICAgICAgICAgICBjb25zdCByaW1HZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeShySW5uZXIsIDAuOCwgNCwgNjQpOwogICAgICAgICAgICAgICAgcmltR2VvLnJvdGF0ZVgoTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgcmltID0gbmV3IFRIUkVFLk1lc2gocmltR2VvLCByaW1NYXQpOwogICAgICAgICAgICAgICAgcmltLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIE1hc3NpdmUgUGlsbGFycyAoVGhlICJIZXJjdWxlYW4iIFN1cHBvcnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg4LCAyMDAsIDgpOwpjb25zdCBwaWxsYXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwNTA1MDUgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnBpbGxhciA9IHBpbGxhck1hdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCi8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIHNwcml0ZS5wb3NpdGlvbi5zZXQoeCwgeVBvcywgeik7CiAgICAgICAgICAgICAgICBzcHJpdGUuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBMYXJnZSBnbG93CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLnB1c2goc3ByaXRlKTsKCi8vIDMuIEFjdHVhbCBQb2ludCBMaWdodCAtIFJFTU9WRUQgZm9yIG9wdGltaXphdGlvbgogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgdXNlIE1lc2hCYXNpY01hdGVyaWFsIChVbmxpdCksIHJlYWwgbGlnaHRzIHdhc3RlIENQVS9HUFUgcmVzb3VyY2VzLgogICAgICAgICAgICAgICAgLy8gVGhlIHNwcml0ZSBnbG93IGFib3ZlIHByb3ZpZGVzIHRoZSB2aXN1YWwgZWZmZWN0LgogICAgICAgICAgICB9Cn0KCiAgICAgICAgX2J1aWxkR29hbEJhcnJpZXJzKCkgewogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBJbnZlcnRlZCBUcmlhbmdsZSAoTWF0Y2hlcyBHb2FsIEhpdGJveCkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KFsKLTE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMC4wLCAtMTguMCwgMC4wICAvLyBCb3R0b20gQ2VudGVyCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVVZzIGZvciBzaGFkZXIgZWZmZWN0cwogICAgICAgICAgICBjb25zdCB1dnMgPSBuZXcgRmxvYXQzMkFycmF5KFsKICAgICAgICAgICAgICAgIDAuMCwgMS4wLAogICAgICAgICAgICAgICAgMS4wLCAxLjAsCiAgICAgICAgICAgICAgICAwLjUsIDAuMAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW9tZXRyeS5jb21wdXRlVmVydGV4Tm9ybWFscygpOwoKICAgICAgICAgICAgLy8gRm9yY2VmaWVsZCBTaGFkZXIKLy8gRm9yY2VmaWVsZCBTaGFkZXIKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4NDRhYWZmKSB9LCAvLyBDeWFuL0JsdWUgRW5lcmd5CiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9IC8vIEludmlzaWJsZSBieSBkZWZhdWx0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUNvbG9yOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIZXggUGF0dGVybiBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2ICogMTUuMDsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICB1di55ICs9IHVUaW1lICogMC41OyAvLyBTY3JvbGwgZG93bgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxleC1saWtlIGdyaWQgZm9yIGhleCBhcHByb3hpbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgciA9IHZlYzIoMS4wLCAxLjczKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBoID0gciAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBhID0gbW9kKHV2LCByKSAtIGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgYiA9IG1vZCh1diAtIGgsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBnID0gZG90KGEsIGEpIDwgZG90KGIsIGIpID8gYSA6IGI7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBsZW5ndGgoZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGluIGxpbmVzCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGhleCA9IHNtb290aHN0ZXAoMC40NSwgMC40OCwgZGlzdCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2NhbiA9IHNpbih2VXYueSAqIDMwLjAgLSB1VGltZSAqIDIuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBFZGdlIEdsb3cgKEZyZXNuZWwtaXNoKQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gcG93KGFicyh2VXYueCAtIDAuNSkgKiAyLjAsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcGF0dGVybiA9ICgxLjAgLSBoZXgpICogMC41OyAvLyBTdHJvbmdlciBncmlkCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm4gKz0gc2NhbiAqIDAuMjsgICAgICAgICAgICAgLy8gU3Ryb25nZXIgc2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBlZGdlICogMC42OyAgICAgICAgICAgICAvLyBTdHJvbmdlciBlZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXN0ZXIgT3BhY2l0eSBDb250cm9sICgwID0gSW52aXNpYmxlLCAxID0gVmlzaWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBmaWxsIDAuMSArIHBhdHRlcm4sIHNjYWxlZCBieSB1T3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9ICgwLjEgKyBwYXR0ZXJuKSAqIHVPcGFjaXR5OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGludAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQmFycmllciBBIChBd2F5IEdvYWwgLyAtWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQS5wb3NpdGlvbi5zZXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuYmFycmllckEpOwoKICAgICAgICAgICAgLy8gQmFycmllciBCIChIb21lIEdvYWwgLyArWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQi5wb3NpdGlvbi5zZXQoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOyAvLyBGYWNlIGlud2FyZAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmJhcnJpZXJzID0gW3RoaXMuYmFycmllckEsIHRoaXMuYmFycmllckJdOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQp0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldFRoZW1lKHZpc3VhbHMpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWxzLmJvd2wpIHRoaXMubWF0ZXJpYWxzLmJvd2wuY29sb3Iuc2V0SGV4KHZpc3VhbHMuc3RydWN0dXJlQ29sb3IpOwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMudGllcikgdGhpcy5tYXRlcmlhbHMudGllci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIGlmICh0aGlzLm1hdGVyaWFscy5waWxsYXIpIHRoaXMubWF0ZXJpYWxzLnBpbGxhci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBSaW0vQWNjZW50IENvbG9ycwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMucmltKSB0aGlzLm1hdGVyaWFscy5yaW0uY29sb3Iuc2V0SGV4KHZpc3VhbHMucmltQ29sb3IpOwoKICAgICAgICAgICAgLy8gMy4gTGlnaHRzIChHbG9iYWwgU3ByaXRlIE1hdGVyaWFsKQogICAgICAgICAgICBpZiAodmlzdWFscy5saWdodENvbG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIF9nbG93TWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHZpc3VhbHMubGlnaHRDb2xvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhcnJpZXJzIChGb3JjZWZpZWxkcykKICAgICAgICAgICAgaWYgKHRoaXMuYmFycmllcnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFycmllcnMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5tYXRlcmlhbCAmJiBiLm1hdGVyaWFsLnVuaWZvcm1zICYmIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh2aXN1YWxzLmxpZ2h0Q29sb3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyA1LiBSaW5ncyAoSGVyY3VsZWFuKQogICAgICAgICAgICAvLyBBY2Nlc3MgdGhlIG1hdGVyaWFsIGZyb20gdGhlIGZpcnN0IHJpbmcgKHRoZXkgc2hhcmUgaXQpCiAgICAgICAgICAgIGlmICh0aGlzLnJpbmdzLmxlbmd0aCA+IDAgJiYgdGhpcy5yaW5nc1swXS5tZXNoICYmIHRoaXMucmluZ3NbMF0ubWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5yaW5nc1swXS5tZXNoLm1hdGVyaWFsLmNvbG9yLnNldEhleCh2aXN1YWxzLnJpbUNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVGhlbWUodmlzdWFscykgewogICAgICAgICAgICB0aGlzLnNldFRoZW1lKHZpc3VhbHMpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","/Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LApjcm93ZENvdW50OiAzMDAsIC8vIE9wdGltaXplZCBkZW5zaXR5ICh3YXMgMTUwMCkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzID0ge307IC8vIFN0b3JlIG1hdGVyaWFscyBmb3IgdGhlbWluZwogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcyA9IFtdOyAvLyBTdG9yZSBsaWdodCBzcHJpdGVzIGZvciBjaW5lbWF0aWMgY29udHJvbAp0aGlzLmNyb3dkID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRHb2FsQmFycmllcnMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CmNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLmJvd2wgPSBib3dsTWF0OwogICAgICAgICAgICBjb25zdCBib3dsID0gbmV3IFRIUkVFLk1lc2goYm93bEdlbywgYm93bE1hdCk7CiAgICAgICAgICAgIGJvd2wucG9zaXRpb24ueSA9IDIwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoYm93bCk7CgogICAgICAgICAgICAvLyAyLiBTZWF0aW5nIFRpZXJzIChDb25jZW50cmljIFJpbmdzKQpjb25zdCB0aWVyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MTExYTIyLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICBjb25zdCByaW1NYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMDQ0NjYgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnRpZXIgPSB0aWVyTWF0OwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscy5yaW0gPSByaW1NYXQ7CgogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy50aWVyczsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKGkgKiB0aGlzLmNvbmZpZy50aWVySGVpZ2h0KSAtIDMwOwogICAgICAgICAgICAgICAgY29uc3QgcklubmVyID0gdGhpcy5jb25maWcucmFkaXVzICsgKGkgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSk7CiAgICAgICAgICAgICAgICBjb25zdCByT3V0ZXIgPSBySW5uZXIgKyB0aGlzLmNvbmZpZy50aWVyRGVwdGg7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZsb29yIFJpbmcKICAgICAgICAgICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KHJJbm5lciwgck91dGVyLCA2NCk7CiAgICAgICAgICAgICAgICByaW5nR2VvLnJvdGF0ZVgoLU1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCB0aWVyTWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdsb3dpbmcgUmltIChUaGUgIlRlY2giIGZlZWwpCiAgICAgICAgICAgICAgICBjb25zdCByaW1HZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeShySW5uZXIsIDAuOCwgNCwgNjQpOwogICAgICAgICAgICAgICAgcmltR2VvLnJvdGF0ZVgoTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgcmltID0gbmV3IFRIUkVFLk1lc2gocmltR2VvLCByaW1NYXQpOwogICAgICAgICAgICAgICAgcmltLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIE1hc3NpdmUgUGlsbGFycyAoVGhlICJIZXJjdWxlYW4iIFN1cHBvcnQpCiAgICAgICAgICAgIGNvbnN0IHBpbGxhckdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg4LCAyMDAsIDgpOwpjb25zdCBwaWxsYXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwNTA1MDUgfSk7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWxzLnBpbGxhciA9IHBpbGxhck1hdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCi8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIHNwcml0ZS5wb3NpdGlvbi5zZXQoeCwgeVBvcywgeik7CiAgICAgICAgICAgICAgICBzcHJpdGUuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBMYXJnZSBnbG93CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLnB1c2goc3ByaXRlKTsKCi8vIDMuIEFjdHVhbCBQb2ludCBMaWdodCAtIFJFTU9WRUQgZm9yIG9wdGltaXphdGlvbgogICAgICAgICAgICAgICAgLy8gU2luY2Ugd2UgdXNlIE1lc2hCYXNpY01hdGVyaWFsIChVbmxpdCksIHJlYWwgbGlnaHRzIHdhc3RlIENQVS9HUFUgcmVzb3VyY2VzLgogICAgICAgICAgICAgICAgLy8gVGhlIHNwcml0ZSBnbG93IGFib3ZlIHByb3ZpZGVzIHRoZSB2aXN1YWwgZWZmZWN0LgogICAgICAgICAgICB9Cn0KCiAgICAgICAgX2J1aWxkR29hbEJhcnJpZXJzKCkgewogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9ICh3aW5kb3cuZmx1eC5CYWxsQ29uZmlnICYmIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSkgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBJbnZlcnRlZCBUcmlhbmdsZSAoTWF0Y2hlcyBHb2FsIEhpdGJveCkKICAgICAgICAgICAgLy8gVG9wIFk6IDEyLjAsIEJvdHRvbSBZOiAtNi4wLiBXaWR0aCBhdCB0b3A6IDI4LjAgKCsvLSAxNC4wKS4KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KFsKLTE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgTGVmdAogICAgICAgICAgICAgICAgIDE0LjAsIDIuMCwgMC4wLCAvLyBUb3AgUmlnaHQKICAgICAgICAgICAgICAgICAgMC4wLCAtMTguMCwgMC4wICAvLyBCb3R0b20gQ2VudGVyCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVVZzIGZvciBzaGFkZXIgZWZmZWN0cwogICAgICAgICAgICBjb25zdCB1dnMgPSBuZXcgRmxvYXQzMkFycmF5KFsKICAgICAgICAgICAgICAgIDAuMCwgMS4wLAogICAgICAgICAgICAgICAgMS4wLCAxLjAsCiAgICAgICAgICAgICAgICAwLjUsIDAuMAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgndXYnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW9tZXRyeS5jb21wdXRlVmVydGV4Tm9ybWFscygpOwoKICAgICAgICAgICAgLy8gRm9yY2VmaWVsZCBTaGFkZXIKLy8gRm9yY2VmaWVsZCBTaGFkZXIKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVDb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4NDRhYWZmKSB9LCAvLyBDeWFuL0JsdWUgRW5lcmd5CiAgICAgICAgICAgICAgICAgICAgdU9wYWNpdHk6IHsgdmFsdWU6IDAuMCB9IC8vIEludmlzaWJsZSBieSBkZWZhdWx0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUNvbG9yOwogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdU9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCiAgICAgICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIZXggUGF0dGVybiBMb2dpYwogICAgICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2ICogMTUuMDsgLy8gRGVuc2l0eQogICAgICAgICAgICAgICAgICAgICAgICB1di55ICs9IHVUaW1lICogMC41OyAvLyBTY3JvbGwgZG93bgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxleC1saWtlIGdyaWQgZm9yIGhleCBhcHByb3hpbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgciA9IHZlYzIoMS4wLCAxLjczKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBoID0gciAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBhID0gbW9kKHV2LCByKSAtIGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgYiA9IG1vZCh1diAtIGgsIHIpIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiBnID0gZG90KGEsIGEpIDwgZG90KGIsIGIpID8gYSA6IGI7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBsZW5ndGgoZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGluIGxpbmVzCiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IGhleCA9IHNtb290aHN0ZXAoMC40NSwgMC40OCwgZGlzdCk7IAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2NhbiA9IHNpbih2VXYueSAqIDMwLjAgLSB1VGltZSAqIDIuMCkgKiAwLjUgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBFZGdlIEdsb3cgKEZyZXNuZWwtaXNoKQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBlZGdlID0gcG93KGFicyh2VXYueCAtIDAuNSkgKiAyLjAsIDMuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NlIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgcGF0dGVybiA9ICgxLjAgLSBoZXgpICogMC41OyAvLyBTdHJvbmdlciBncmlkCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm4gKz0gc2NhbiAqIDAuMjsgICAgICAgICAgICAgLy8gU3Ryb25nZXIgc2NhbmxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybiArPSBlZGdlICogMC42OyAgICAgICAgICAgICAvLyBTdHJvbmdlciBlZGdlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXN0ZXIgT3BhY2l0eSBDb250cm9sICgwID0gSW52aXNpYmxlLCAxID0gVmlzaWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBmaWxsIDAuMSArIHBhdHRlcm4sIHNjYWxlZCBieSB1T3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBhbHBoYSA9ICgwLjEgKyBwYXR0ZXJuKSAqIHVPcGFjaXR5OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGludAogICAgICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciwgYWxwaGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQmFycmllciBBIChBd2F5IEdvYWwgLyAtWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQSA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQS5wb3NpdGlvbi5zZXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuYmFycmllckEpOwoKICAgICAgICAgICAgLy8gQmFycmllciBCIChIb21lIEdvYWwgLyArWikKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQiA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbC5jbG9uZSgpKTsKICAgICAgICAgICAgdGhpcy5iYXJyaWVyQi5wb3NpdGlvbi5zZXQoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICB0aGlzLmJhcnJpZXJCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOyAvLyBGYWNlIGlud2FyZAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5iYXJyaWVyQik7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmJhcnJpZXJzID0gW3RoaXMuYmFycmllckEsIHRoaXMuYmFycmllckJdOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQp0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBCYXJyaWVyIFVuaWZvcm1zCiAgICAgICAgICAgIGlmICh0aGlzLmJhcnJpZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhcnJpZXJzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIubWF0ZXJpYWwudW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYi5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQp9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldFRoZW1lKHZpc3VhbHMpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWxzLmJvd2wpIHRoaXMubWF0ZXJpYWxzLmJvd2wuY29sb3Iuc2V0SGV4KHZpc3VhbHMuc3RydWN0dXJlQ29sb3IpOwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMudGllcikgdGhpcy5tYXRlcmlhbHMudGllci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIGlmICh0aGlzLm1hdGVyaWFscy5waWxsYXIpIHRoaXMubWF0ZXJpYWxzLnBpbGxhci5jb2xvci5zZXRIZXgodmlzdWFscy5zdHJ1Y3R1cmVDb2xvcik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBSaW0vQWNjZW50IENvbG9ycwogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbHMucmltKSB0aGlzLm1hdGVyaWFscy5yaW0uY29sb3Iuc2V0SGV4KHZpc3VhbHMucmltQ29sb3IpOwoKICAgICAgICAgICAgLy8gMy4gTGlnaHRzIChHbG9iYWwgU3ByaXRlIE1hdGVyaWFsKQogICAgICAgICAgICBpZiAodmlzdWFscy5saWdodENvbG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIF9nbG93TWF0ZXJpYWwuY29sb3Iuc2V0SGV4KHZpc3VhbHMubGlnaHRDb2xvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhcnJpZXJzIChGb3JjZWZpZWxkcykKICAgICAgICAgICAgaWYgKHRoaXMuYmFycmllcnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFycmllcnMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5tYXRlcmlhbCAmJiBiLm1hdGVyaWFsLnVuaWZvcm1zICYmIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIubWF0ZXJpYWwudW5pZm9ybXMudUNvbG9yLnZhbHVlLnNldEhleCh2aXN1YWxzLmxpZ2h0Q29sb3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyA1LiBSaW5ncyAoSGVyY3VsZWFuKQogICAgICAgICAgICAvLyBBY2Nlc3MgdGhlIG1hdGVyaWFsIGZyb20gdGhlIGZpcnN0IHJpbmcgKHRoZXkgc2hhcmUgaXQpCiAgICAgICAgICAgIGlmICh0aGlzLnJpbmdzLmxlbmd0aCA+IDAgJiYgdGhpcy5yaW5nc1swXS5tZXNoICYmIHRoaXMucmluZ3NbMF0ubWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5yaW5nc1swXS5tZXNoLm1hdGVyaWFsLmNvbG9yLnNldEhleCh2aXN1YWxzLnJpbUNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVGhlbWUodmlzdWFscykgewogICAgICAgICAgICB0aGlzLnNldFRoZW1lKHZpc3VhbHMpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","./PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","/PostProcessing.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQb3N0UHJvY2Vzc2luZyB7CiAgICAgICAgY29uc3RydWN0b3IocmVuZGVyZXIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gUmVuZGVyIFRhcmdldCBmb3IgdGhlIHNjZW5lIChJbnRlcm5hbCBSZXNvbHV0aW9uKQogICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCh3aWR0aCwgaGVpZ2h0LCB7CiAgICAgICAgICAgICAgICBtaW5GaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBtYWdGaWx0ZXI6IFRIUkVFLk5lYXJlc3RGaWx0ZXIsCiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRIUkVFLlJHQkFGb3JtYXQsCiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogdHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gRlNRIFNldHVwCiAgICAgICAgICAgIHRoaXMub3J0aG9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0xLCAxLCAxLCAtMSwgMCwgMSk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKCiAgICAgICAgICAgIC8vIFNoYWRlcgogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdERpZmZ1c2U6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgICAgICAgICAgIHVUaW1lOiB7IHZhbHVlOiAwIH0sCiAgICAgICAgICAgICAgICB1UmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IFRIUkVFLlZlY3RvcjIod2lkdGgsIGhlaWdodCkgfSwKICAgICAgICAgICAgICAgIC8vIFJldHJvIFNldHRpbmdzCnVTY2FubGluZUludGVuc2l0eTogeyB2YWx1ZTogMC4wIH0sIC8vIERpc2FibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgIHVTY2FubGluZUNvdW50OiB7IHZhbHVlOiBoZWlnaHQgKiAwLjUgfSwgLy8gSGFsZiByZXNvbHV0aW9uIHNjYW5saW5lcwogICAgICAgICAgICAgICAgdVZpZ25ldHRlOiB7IHZhbHVlOiAwLjYgfSwKICAgICAgICAgICAgICAgIHVOb2lzZTogeyB2YWx1ZTogMC4wNCB9LAogICAgICAgICAgICAgICAgdUFiZXJyYXRpb246IHsgdmFsdWU6IDEuNSB9LCAvLyBQaXhlbCBvZmZzZXQgYW1vdW50CiAgICAgICAgICAgICAgICB1Q29udHJhc3Q6IHsgdmFsdWU6IDEuMSB9LAogICAgICAgICAgICAgICAgdVNhdHVyYXRpb246IHsgdmFsdWU6IDEuMSB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdERpZmZ1c2U7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMyIHVSZXNvbHV0aW9uOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1U2NhbmxpbmVJbnRlbnNpdHk7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVTY2FubGluZUNvdW50OwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VmlnbmV0dGU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVOb2lzZTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUFiZXJyYXRpb247CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVDb250cmFzdDsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVNhdHVyYXRpb247CgogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKCmZsb2F0IHJhbmRvbSh2ZWMyIHApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJhY3Qoc2luKGRvdChwLnh5LCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgeCA9IGZsb29yKG1vZCh1di54LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB5ID0gZmxvb3IobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMC4wKSB7IGlmICh4ID09IDAuMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMi4wOyBlbHNlIHYgPSAxMC4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAxLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA0LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyLjApIHsgaWYgKHggPT0gMC4wKSB2ID0gMy4wOyBlbHNlIGlmICh4ID09IDEuMCkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsgaWYgKHggPT0gMC4wKSB2ID0gMTUuMDsgZWxzZSBpZiAoeCA9PSAxLjApIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMi4wKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgLyAxNi4wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENocm9tYXRpYyBBYmVycmF0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMiBkaXN0ID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgLy8gT2Zmc2V0IGJhc2VkIG9uIGRpc3RhbmNlIGZyb20gY2VudGVyCiAgICAgICAgICAgICAgICAgICAgdmVjMiBvZmZzZXQgPSBkaXN0ICogKHVBYmVycmF0aW9uIC8gdVJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2IC0gb2Zmc2V0KS5yOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGcgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2KS5nOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGIgPSB0ZXh0dXJlMkQodERpZmZ1c2UsIHV2ICsgb2Zmc2V0KS5iOwogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKHIsIGcsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTYXR1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZ3JheSA9IGRvdChjb2xvciwgdmVjMygwLjI5OSwgMC41ODcsIDAuMTE0KSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBtaXgodmVjMyhncmF5KSwgY29sb3IsIHVTYXR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29udHJhc3QKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IChjb2xvciAtIDAuNSkgKiB1Q29udHJhc3QgKyAwLjU7CgovLyBTY2FubGluZXMgKERJU0FCTEVEKQogICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIHVTY2FubGluZUNvdW50ICogNi4yOCArIHVUaW1lICogMi4wKTsKICAgICAgICAgICAgICAgICAgICAvLyBjb2xvciAtPSAoc2NhbiAqIDAuNSArIDAuNSkgKiB1U2NhbmxpbmVJbnRlbnNpdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpdGhlcmluZyAoSW5jcmVhc2VkKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGRpdGhlciA9IGJheWVyNHg0KGdsX0ZyYWdDb29yZC54eSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7IC8vIDUtYml0IGNvbG9yIHNpbXVsYXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGRpdGhlcmVkID0gY29sb3IgKyAoZGl0aGVyIC0gMC41KSAqICgxLjUgLyBjb2xvckRlcHRoKTsgLy8gMS41eCBzdHJlbmd0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZmxvb3IoZGl0aGVyZWQgKiBjb2xvckRlcHRoKSAvIGNvbG9yRGVwdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vaXNlCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IHJhbmRvbSh1diArIG1vZCh1VGltZSwgMS4wKSk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKG4gLSAwLjUpICogdU5vaXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQgPSBkb3QoZGlzdCwgZGlzdCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKj0gKDEuMCAtIGQgKiB1VmlnbmV0dGUpOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogdGhpcy51bmlmb3JtcywKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5xdWFkID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMiksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnF1YWQpOwogICAgICAgIH0KCiAgICAgICAgc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGFyZ2V0LnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMudVJlc29sdXRpb24udmFsdWUuc2V0KHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnVTY2FubGluZUNvdW50LnZhbHVlID0gaGVpZ2h0ICogMC41OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVyKHNjZW5lLCBjYW1lcmEsIGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKCiAgICAgICAgICAgIC8vIFBhc3MgMTogU2NlbmUgLT4gVGFyZ2V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KHRoaXMucmVuZGVyVGFyZ2V0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpOwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIFBhc3MgMjogVGFyZ2V0IC0+IFNjcmVlbgogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFJlbmRlclRhcmdldChudWxsKTsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy50RGlmZnVzZS52YWx1ZSA9IHRoaXMucmVuZGVyVGFyZ2V0LnRleHR1cmU7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMub3J0aG9DYW1lcmEpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Qb3N0UHJvY2Vzc2luZyA9IFBvc3RQcm9jZXNzaW5nOwp9KSgpOw==","PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCmNvbnN0IE9SQl9UWVBFUyA9IHsKICAgICAgICAnSEVBTCc6IHsgY29sb3I6IDB4MDBmZjAwLCBsYWJlbDogJ0hQIFVQJywgY2hhbmNlOiAwLjIgfSwKICAgICAgICAnQ0hBUkdFJzogeyBjb2xvcjogMHhmZmFhMDAsIGxhYmVsOiAnRU4gVVAnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdURUNIJzogeyBjb2xvcjogMHgwMGZmZmYsIGxhYmVsOiAnVEVDSCcsIGNoYW5jZTogMC4xNSB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjE1IH0sCiAgICAgICAgJ0ZJUkUnOiB7IGNvbG9yOiAweGZmNDQwMCwgbGFiZWw6ICdGSVJFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnSUNFJzogeyBjb2xvcjogMHhhYWRkZmYsIGxhYmVsOiAnSUNFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnVk9MVCc6IHsgY29sb3I6IDB4ZmZmZjAwLCBsYWJlbDogJ1ZPTFQnLCBjaGFuY2U6IDAuMSB9CiAgICB9OwoKICAgIGNsYXNzIFBvd2VyVXBNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5vcmJzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnNwYXduSW50ZXJ2YWwgPSAxMC4wOyAvLyBTcGF3biBldmVyeSAxMCBzZWNvbmRzCiAgICAgICAgICAgIHRoaXMubWF4T3JicyA9IDU7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gT25seSBzcGF3bi91cGRhdGUgZHVyaW5nIGFjdGl2ZSBwbGF5CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zcGF3blRpbWVyID49IHRoaXMuc3Bhd25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3Jicy5sZW5ndGggPCB0aGlzLm1heE9yYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGF3blJhbmRvbU9yYigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2ldOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIG9yYi5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucG9zaXRpb24ueSA9IG9yYi5iYXNlWSArIE1hdGguc2luKG9yYi5hZ2UgKiAyLjApICogMC41OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnkgKz0gZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucm90YXRpb24ueiArPSBkdCAqIDEuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG9yYi5hZ2UgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb24ob3JiLCBpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25SYW5kb21PcmIoKSB7CiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhPUkJfVFlQRVMpOwogICAgICAgICAgICBjb25zdCB0eXBlS2V5ID0ga2V5c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBrZXlzLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCB0eXBlRGF0YSA9IE9SQl9UWVBFU1t0eXBlS2V5XTsKCiAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDM1LjA7CiAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpICogNC4wKSAtIDIuMDsKCiAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChfb3JiR2VvLCBfb3JiTWF0QmFzZS5jbG9uZSgpKTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbC5jb2xvci5zZXRIZXgodHlwZURhdGEuY29sb3IpOwogICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5LCB6KTsKCiAgICAgICAgICAgIGNvbnN0IGNvcmVHZW8gPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC43LCA4LCA4KTsKICAgICAgICAgICAgY29uc3QgY29yZU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgY29uc3QgY29yZSA9IG5ldyBUSFJFRS5NZXNoKGNvcmVHZW8sIGNvcmVNYXQpOwogICAgICAgICAgICBtZXNoLmFkZChjb3JlKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgIHRoaXMub3Jicy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IG1lc2gsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlS2V5LAogICAgICAgICAgICAgICAgZGF0YTogdHlwZURhdGEsCiAgICAgICAgICAgICAgICBiYXNlWTogeSwKICAgICAgICAgICAgICAgIGFnZTogMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNwYXduIGVmZmVjdAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LHkseiksIHsgc2NhbGU6IDIuMCwgY29sb3I6IHR5cGVEYXRhLmNvbG9yIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjaGVja0NvbGxpc2lvbihvcmIsIGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IHBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5ob21lKSBwbGF5ZXJzLnB1c2goLi4udGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwoKICAgICAgICAgICAgY29uc3QgY29sbGlzaW9uUmFkaXVzU3EgPSAyLjUgKiAyLjU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQob3JiLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IGNvbGxpc2lvblJhZGl1c1NxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsZWN0T3JiKG9yYiwgcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnRklSRSc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmVsZW1lbnRhbEluZnVzaW9uID0geyB0eXBlOiAnZmlyZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdJQ0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5lbGVtZW50YWxJbmZ1c2lvbiA9IHsgdHlwZTogJ2ljZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdWT0xUJzoKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZWxlbWVudGFsSW5mdXNpb24gPSB7IHR5cGU6ICd2b2x0JywgZHVyYXRpb246IDE1LjAgfTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24ob3JiLmRhdGEubGFiZWwsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBvcmIubWVzaC5wb3NpdGlvbiwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBvcmIuZGF0YS5jb2xvciAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDEuNSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVtb3ZlT3JiKGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpbmRleF07CiAgICAgICAgICAgIGlmIChvcmIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlKG9yYi5tZXNoKTsKICAgICAgICAgICAgICAgIGlmIChvcmIubWVzaC5tYXRlcmlhbCkgb3JiLm1lc2gubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgLy8gRGlzcG9zZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgb3JiLm1lc2gudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmdlb21ldHJ5KSBjLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIGMubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3Jicy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldCgpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUG93ZXJVcE1hbmFnZXIgPSBQb3dlclVwTWFuYWdlcjsKfSkoKTs=","./PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCmNvbnN0IE9SQl9UWVBFUyA9IHsKICAgICAgICAnSEVBTCc6IHsgY29sb3I6IDB4MDBmZjAwLCBsYWJlbDogJ0hQIFVQJywgY2hhbmNlOiAwLjIgfSwKICAgICAgICAnQ0hBUkdFJzogeyBjb2xvcjogMHhmZmFhMDAsIGxhYmVsOiAnRU4gVVAnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdURUNIJzogeyBjb2xvcjogMHgwMGZmZmYsIGxhYmVsOiAnVEVDSCcsIGNoYW5jZTogMC4xNSB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjE1IH0sCiAgICAgICAgJ0ZJUkUnOiB7IGNvbG9yOiAweGZmNDQwMCwgbGFiZWw6ICdGSVJFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnSUNFJzogeyBjb2xvcjogMHhhYWRkZmYsIGxhYmVsOiAnSUNFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnVk9MVCc6IHsgY29sb3I6IDB4ZmZmZjAwLCBsYWJlbDogJ1ZPTFQnLCBjaGFuY2U6IDAuMSB9CiAgICB9OwoKICAgIGNsYXNzIFBvd2VyVXBNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5vcmJzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnNwYXduSW50ZXJ2YWwgPSAxMC4wOyAvLyBTcGF3biBldmVyeSAxMCBzZWNvbmRzCiAgICAgICAgICAgIHRoaXMubWF4T3JicyA9IDU7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gT25seSBzcGF3bi91cGRhdGUgZHVyaW5nIGFjdGl2ZSBwbGF5CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zcGF3blRpbWVyID49IHRoaXMuc3Bhd25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3Jicy5sZW5ndGggPCB0aGlzLm1heE9yYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGF3blJhbmRvbU9yYigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2ldOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIG9yYi5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucG9zaXRpb24ueSA9IG9yYi5iYXNlWSArIE1hdGguc2luKG9yYi5hZ2UgKiAyLjApICogMC41OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnkgKz0gZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucm90YXRpb24ueiArPSBkdCAqIDEuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG9yYi5hZ2UgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb24ob3JiLCBpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25SYW5kb21PcmIoKSB7CiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhPUkJfVFlQRVMpOwogICAgICAgICAgICBjb25zdCB0eXBlS2V5ID0ga2V5c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBrZXlzLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCB0eXBlRGF0YSA9IE9SQl9UWVBFU1t0eXBlS2V5XTsKCiAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDM1LjA7CiAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpICogNC4wKSAtIDIuMDsKCiAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChfb3JiR2VvLCBfb3JiTWF0QmFzZS5jbG9uZSgpKTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbC5jb2xvci5zZXRIZXgodHlwZURhdGEuY29sb3IpOwogICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5LCB6KTsKCiAgICAgICAgICAgIGNvbnN0IGNvcmVHZW8gPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC43LCA4LCA4KTsKICAgICAgICAgICAgY29uc3QgY29yZU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgY29uc3QgY29yZSA9IG5ldyBUSFJFRS5NZXNoKGNvcmVHZW8sIGNvcmVNYXQpOwogICAgICAgICAgICBtZXNoLmFkZChjb3JlKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgIHRoaXMub3Jicy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IG1lc2gsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlS2V5LAogICAgICAgICAgICAgICAgZGF0YTogdHlwZURhdGEsCiAgICAgICAgICAgICAgICBiYXNlWTogeSwKICAgICAgICAgICAgICAgIGFnZTogMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNwYXduIGVmZmVjdAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LHkseiksIHsgc2NhbGU6IDIuMCwgY29sb3I6IHR5cGVEYXRhLmNvbG9yIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjaGVja0NvbGxpc2lvbihvcmIsIGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IHBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5ob21lKSBwbGF5ZXJzLnB1c2goLi4udGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwoKICAgICAgICAgICAgY29uc3QgY29sbGlzaW9uUmFkaXVzU3EgPSAyLjUgKiAyLjU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQob3JiLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IGNvbGxpc2lvblJhZGl1c1NxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsZWN0T3JiKG9yYiwgcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnRklSRSc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmVsZW1lbnRhbEluZnVzaW9uID0geyB0eXBlOiAnZmlyZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdJQ0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5lbGVtZW50YWxJbmZ1c2lvbiA9IHsgdHlwZTogJ2ljZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdWT0xUJzoKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZWxlbWVudGFsSW5mdXNpb24gPSB7IHR5cGU6ICd2b2x0JywgZHVyYXRpb246IDE1LjAgfTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24ob3JiLmRhdGEubGFiZWwsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBvcmIubWVzaC5wb3NpdGlvbiwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBvcmIuZGF0YS5jb2xvciAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDEuNSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVtb3ZlT3JiKGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpbmRleF07CiAgICAgICAgICAgIGlmIChvcmIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlKG9yYi5tZXNoKTsKICAgICAgICAgICAgICAgIGlmIChvcmIubWVzaC5tYXRlcmlhbCkgb3JiLm1lc2gubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgLy8gRGlzcG9zZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgb3JiLm1lc2gudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmdlb21ldHJ5KSBjLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIGMubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3Jicy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldCgpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUG93ZXJVcE1hbmFnZXIgPSBQb3dlclVwTWFuYWdlcjsKfSkoKTs=","/PowerUpManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfb3JiR2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDEuNSwgMTYsIDE2KTsKICAgIGNvbnN0IF9vcmJNYXRCYXNlID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICBjb2xvcjogMHhmZmZmZmYsCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCmNvbnN0IE9SQl9UWVBFUyA9IHsKICAgICAgICAnSEVBTCc6IHsgY29sb3I6IDB4MDBmZjAwLCBsYWJlbDogJ0hQIFVQJywgY2hhbmNlOiAwLjIgfSwKICAgICAgICAnQ0hBUkdFJzogeyBjb2xvcjogMHhmZmFhMDAsIGxhYmVsOiAnRU4gVVAnLCBjaGFuY2U6IDAuMiB9LAogICAgICAgICdURUNIJzogeyBjb2xvcjogMHgwMGZmZmYsIGxhYmVsOiAnVEVDSCcsIGNoYW5jZTogMC4xNSB9LAogICAgICAgICdTUEVFRCc6IHsgY29sb3I6IDB4ZmYwMGZmLCBsYWJlbDogJ0hBU1RFJywgY2hhbmNlOiAwLjE1IH0sCiAgICAgICAgJ0ZJUkUnOiB7IGNvbG9yOiAweGZmNDQwMCwgbGFiZWw6ICdGSVJFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnSUNFJzogeyBjb2xvcjogMHhhYWRkZmYsIGxhYmVsOiAnSUNFJywgY2hhbmNlOiAwLjEgfSwKICAgICAgICAnVk9MVCc6IHsgY29sb3I6IDB4ZmZmZjAwLCBsYWJlbDogJ1ZPTFQnLCBjaGFuY2U6IDAuMSB9CiAgICB9OwoKICAgIGNsYXNzIFBvd2VyVXBNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5vcmJzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLnNwYXduSW50ZXJ2YWwgPSAxMC4wOyAvLyBTcGF3biBldmVyeSAxMCBzZWNvbmRzCiAgICAgICAgICAgIHRoaXMubWF4T3JicyA9IDU7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gT25seSBzcGF3bi91cGRhdGUgZHVyaW5nIGFjdGl2ZSBwbGF5CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXduVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zcGF3blRpbWVyID49IHRoaXMuc3Bhd25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3Jicy5sZW5ndGggPCB0aGlzLm1heE9yYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGF3blJhbmRvbU9yYigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5vcmJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JiID0gdGhpcy5vcmJzW2ldOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIG9yYi5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucG9zaXRpb24ueSA9IG9yYi5iYXNlWSArIE1hdGguc2luKG9yYi5hZ2UgKiAyLjApICogMC41OwogICAgICAgICAgICAgICAgICAgIG9yYi5tZXNoLnJvdGF0aW9uLnkgKz0gZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3JiLm1lc2gucm90YXRpb24ueiArPSBkdCAqIDEuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG9yYi5hZ2UgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlT3JiKGkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb24ob3JiLCBpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25SYW5kb21PcmIoKSB7CiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhPUkJfVFlQRVMpOwogICAgICAgICAgICBjb25zdCB0eXBlS2V5ID0ga2V5c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBrZXlzLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCB0eXBlRGF0YSA9IE9SQl9UWVBFU1t0eXBlS2V5XTsKCiAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDM1LjA7CiAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByOwogICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcjsKICAgICAgICAgICAgY29uc3QgeSA9IChNYXRoLnJhbmRvbSgpICogNC4wKSAtIDIuMDsKCiAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChfb3JiR2VvLCBfb3JiTWF0QmFzZS5jbG9uZSgpKTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbC5jb2xvci5zZXRIZXgodHlwZURhdGEuY29sb3IpOwogICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5LCB6KTsKCiAgICAgICAgICAgIGNvbnN0IGNvcmVHZW8gPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoMC43LCA4LCA4KTsKICAgICAgICAgICAgY29uc3QgY29yZU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKICAgICAgICAgICAgY29uc3QgY29yZSA9IG5ldyBUSFJFRS5NZXNoKGNvcmVHZW8sIGNvcmVNYXQpOwogICAgICAgICAgICBtZXNoLmFkZChjb3JlKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgIHRoaXMub3Jicy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IG1lc2gsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlS2V5LAogICAgICAgICAgICAgICAgZGF0YTogdHlwZURhdGEsCiAgICAgICAgICAgICAgICBiYXNlWTogeSwKICAgICAgICAgICAgICAgIGFnZTogMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNwYXduIGVmZmVjdAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LHkseiksIHsgc2NhbGU6IDIuMCwgY29sb3I6IHR5cGVEYXRhLmNvbG9yIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjaGVja0NvbGxpc2lvbihvcmIsIGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IHBsYXllcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5ob21lKSBwbGF5ZXJzLnB1c2goLi4udGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgcGxheWVycy5wdXNoKC4uLnRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMpOwoKICAgICAgICAgICAgY29uc3QgY29sbGlzaW9uUmFkaXVzU3EgPSAyLjUgKiAyLjU7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQob3JiLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IGNvbGxpc2lvblJhZGl1c1NxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsZWN0T3JiKG9yYiwgcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmNvbGxlY3RPcmIob3JiLCBwbGF5ZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChvcmIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnSEVBTCc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQID0gTWF0aC5taW4ocGxheWVyLnN0YXRzLkhQICsgNTAsIHBsYXllci5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFSR0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5jdXJyZW50RU4gPSBNYXRoLm1pbihwbGF5ZXIuY3VycmVudEVOICsgMzAsIHBsYXllci5nZXRTdGF0KCdFTicpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1RFQ0gnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nYWluRXhwKDIwKTsgLy8gR2l2ZSBFWFAgZm9yIG5vdwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1BFRUQnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5hcHBseVN0YXR1cygnaGFzdGUnLCA4LjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnRklSRSc6CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmVsZW1lbnRhbEluZnVzaW9uID0geyB0eXBlOiAnZmlyZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdJQ0UnOgogICAgICAgICAgICAgICAgICAgIHBsYXllci5lbGVtZW50YWxJbmZ1c2lvbiA9IHsgdHlwZTogJ2ljZScsIGR1cmF0aW9uOiAxNS4wIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdWT0xUJzoKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZWxlbWVudGFsSW5mdXNpb24gPSB7IHR5cGU6ICd2b2x0JywgZHVyYXRpb246IDE1LjAgfTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24ob3JiLmRhdGEubGFiZWwsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBvcmIubWVzaC5wb3NpdGlvbiwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEuNSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBvcmIuZGF0YS5jb2xvciAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDEuNSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVtb3ZlT3JiKGluZGV4KSB7CiAgICAgICAgICAgIGNvbnN0IG9yYiA9IHRoaXMub3Jic1tpbmRleF07CiAgICAgICAgICAgIGlmIChvcmIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlKG9yYi5tZXNoKTsKICAgICAgICAgICAgICAgIGlmIChvcmIubWVzaC5tYXRlcmlhbCkgb3JiLm1lc2gubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgLy8gRGlzcG9zZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgb3JiLm1lc2gudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmdlb21ldHJ5KSBjLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIGMubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3Jicy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldCgpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMub3Jicy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcmIoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zcGF3blRpbWVyID0gMDsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUG93ZXJVcE1hbmFnZXIgPSBQb3dlclVwTWFuYWdlcjsKfSkoKTs=","ArenaThemeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBUSEVNRVMgPSB7CiAgICAgICAgJ1NUQU5EQVJEJzogewogICAgICAgICAgICBuYW1lOiAnQkVTQUlEIFNQSEVSRSBQT09MJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAwMDEsCiAgICAgICAgICAgICAgICBzdHJ1Y3R1cmVDb2xvcjogMHgwODBjMTAsCiAgICAgICAgICAgICAgICByaW1Db2xvcjogMHgwMDQ0NjYsCiAgICAgICAgICAgICAgICBsaWdodENvbG9yOiAweDAwYWFmZgogICAgICAgICAgICB9LAogICAgICAgICAgICBwaHlzaWNzOiB7CiAgICAgICAgICAgICAgICB3YXRlckRyYWc6IDAuMTUsCiAgICAgICAgICAgICAgICBkZXB0aFNwcmluZzogMS4wCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhemFyZHM6IFtdCiAgICAgICAgfSwKICAgICAgICAnREVFUF9TRUEnOiB7CiAgICAgICAgICAgIG5hbWU6ICdCQUFKIFJVSU5TJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAyNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDAyMDUwOCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDAwMjIzMywKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBmZmFhCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4yNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogWwogICAgICAgICAgICAgICAgeyB0eXBlOiAnY3VycmVudCcsIGZvcmNlOiBuZXcgVEhSRUUuVmVjdG9yMyg4LCAwLCAwKSwgZnJlcXVlbmN5OiAwLjUgfQogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAnVk9MQ0FOSUMnOiB7CiAgICAgICAgICAgIG5hbWU6ICdLSUxJS0EgVEVNUExFJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAxNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDFhMDUwMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MTEwMCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmY0NDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4xLAogICAgICAgICAgICAgICAgZGVwdGhTcHJpbmc6IDEuMgogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXphcmRzOiBbCiAgICAgICAgICAgICAgICB7IHR5cGU6ICd2ZW50JywgcG9zaXRpb246IG5ldyBUSFJFRS5WZWN0b3IzKDAsIC0xNSwgMCksIHJhZGl1czogMTUsIGZvcmNlOiA0MC4wIH0KICAgICAgICAgICAgXQogICAgICAgIH0sCiAgICAgICAgJ0NFTEVTVElBTCc6IHsKICAgICAgICAgICAgbmFtZTogJ01BQ0FMQU5JQSBXT09EUycsCiAgICAgICAgICAgIHZpc3VhbHM6IHsKICAgICAgICAgICAgICAgIGJnQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogMC4wMSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDEwMDAyMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MDA4OCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmYwMGZmCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4wNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogW10KICAgICAgICB9CiAgICB9OwoKICAgIGNsYXNzIEFyZW5hVGhlbWVNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSAnU1RBTkRBUkQnOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5oYXphcmRUaW1lciA9IDA7CiAgICAgICAgfQoKICAgICAgICBzZXRUaGVtZSh0aGVtZUtleSkgewogICAgICAgICAgICBpZiAoIVRIRU1FU1t0aGVtZUtleV0pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSB0aGVtZUtleTsKICAgICAgICAgICAgY29uc3QgdGhlbWUgPSBUSEVNRVNbdGhlbWVLZXldOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYFNldHRpbmcgQXJlbmEgVGhlbWU6ICR7dGhlbWUubmFtZX1gKTsKCiAgICAgICAgICAgIC8vIDEuIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcih0aGVtZS52aXN1YWxzLmJnQ29sb3IpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUuZm9nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5mb2cuY29sb3Iuc2V0SGV4KHRoZW1lLnZpc3VhbHMuZm9nQ29sb3IpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuZm9nLmRlbnNpdHkgPSB0aGVtZS52aXN1YWxzLmZvZ0RlbnNpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS51cGRhdGVUaGVtZSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWRpdW0udXBkYXRlVGhlbWUodGhlbWUudmlzdWFscyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBoeXNpY3MKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIgPSB0aGVtZS5waHlzaWNzLndhdGVyRHJhZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuREVQVEhfU1BSSU5HID0gdGhlbWUucGh5c2ljcy5kZXB0aFNwcmluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSGF6YXJkcwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSB0aGVtZS5oYXphcmRzIHx8IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQodGhlbWUubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2ggfHwgYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBmb3JjZXMgaWYgYmFsbCBpcyBoZWxkIG9yIGludmFsaWQKICAgICAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSkgYmFsbC5zZXRFeHRlcm5hbEZvcmNlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwwKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgdGhpcy5hY3RpdmVIYXphcmRzLmZvckVhY2goaCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoaC50eXBlID09PSAnY3VycmVudCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBQZXJpb2RpYyBwdXNoCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZW5ndGggPSBNYXRoLnNpbih0aGlzLmhhemFyZFRpbWVyICogaC5mcmVxdWVuY3kpICogMC41ICsgMC41OyAKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZW5ndGggPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWNjdW11bGF0ZSBmb3JjZSAoQWNjZWxlcmF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEZvcmNlLmFkZFNjYWxlZFZlY3RvcihoLmZvcmNlLCBzdHJlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzIGZvciBjdXJyZW50IChrZWVwIGhlcmUgZm9yIGFtYmllbnQgZWZmZWN0IGFyb3VuZCBiYWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyMCwgKE1hdGgucmFuZG9tKCktMC41KSoxMCwgKE1hdGgucmFuZG9tKCktMC41KSoyMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IGguZm9yY2UuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyLjApIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGgudHlwZSA9PT0gJ3ZlbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGgucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgaC5yYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgVXB3YXJkIEZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRm9yY2UueSArPSBoLmZvcmNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAwLjUsIGNvbG9yOiAweGZmNDQwMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcHBseSBjYWxjdWxhdGVkIGVudmlyb25tZW50YWwgZm9yY2VzIHRvIHRoZSBiYWxsCiAgICAgICAgICAgIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSh0b3RhbEZvcmNlKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIgPSBBcmVuYVRoZW1lTWFuYWdlcjsKICAgIHdpbmRvdy5mbHV4LlRIRU1FUyA9IFRIRU1FUzsKfSkoKTs=","./ArenaThemeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBUSEVNRVMgPSB7CiAgICAgICAgJ1NUQU5EQVJEJzogewogICAgICAgICAgICBuYW1lOiAnQkVTQUlEIFNQSEVSRSBQT09MJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAwMDEsCiAgICAgICAgICAgICAgICBzdHJ1Y3R1cmVDb2xvcjogMHgwODBjMTAsCiAgICAgICAgICAgICAgICByaW1Db2xvcjogMHgwMDQ0NjYsCiAgICAgICAgICAgICAgICBsaWdodENvbG9yOiAweDAwYWFmZgogICAgICAgICAgICB9LAogICAgICAgICAgICBwaHlzaWNzOiB7CiAgICAgICAgICAgICAgICB3YXRlckRyYWc6IDAuMTUsCiAgICAgICAgICAgICAgICBkZXB0aFNwcmluZzogMS4wCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhemFyZHM6IFtdCiAgICAgICAgfSwKICAgICAgICAnREVFUF9TRUEnOiB7CiAgICAgICAgICAgIG5hbWU6ICdCQUFKIFJVSU5TJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAyNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDAyMDUwOCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDAwMjIzMywKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBmZmFhCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4yNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogWwogICAgICAgICAgICAgICAgeyB0eXBlOiAnY3VycmVudCcsIGZvcmNlOiBuZXcgVEhSRUUuVmVjdG9yMyg4LCAwLCAwKSwgZnJlcXVlbmN5OiAwLjUgfQogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAnVk9MQ0FOSUMnOiB7CiAgICAgICAgICAgIG5hbWU6ICdLSUxJS0EgVEVNUExFJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAxNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDFhMDUwMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MTEwMCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmY0NDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4xLAogICAgICAgICAgICAgICAgZGVwdGhTcHJpbmc6IDEuMgogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXphcmRzOiBbCiAgICAgICAgICAgICAgICB7IHR5cGU6ICd2ZW50JywgcG9zaXRpb246IG5ldyBUSFJFRS5WZWN0b3IzKDAsIC0xNSwgMCksIHJhZGl1czogMTUsIGZvcmNlOiA0MC4wIH0KICAgICAgICAgICAgXQogICAgICAgIH0sCiAgICAgICAgJ0NFTEVTVElBTCc6IHsKICAgICAgICAgICAgbmFtZTogJ01BQ0FMQU5JQSBXT09EUycsCiAgICAgICAgICAgIHZpc3VhbHM6IHsKICAgICAgICAgICAgICAgIGJnQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogMC4wMSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDEwMDAyMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MDA4OCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmYwMGZmCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4wNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogW10KICAgICAgICB9CiAgICB9OwoKICAgIGNsYXNzIEFyZW5hVGhlbWVNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSAnU1RBTkRBUkQnOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5oYXphcmRUaW1lciA9IDA7CiAgICAgICAgfQoKICAgICAgICBzZXRUaGVtZSh0aGVtZUtleSkgewogICAgICAgICAgICBpZiAoIVRIRU1FU1t0aGVtZUtleV0pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSB0aGVtZUtleTsKICAgICAgICAgICAgY29uc3QgdGhlbWUgPSBUSEVNRVNbdGhlbWVLZXldOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYFNldHRpbmcgQXJlbmEgVGhlbWU6ICR7dGhlbWUubmFtZX1gKTsKCiAgICAgICAgICAgIC8vIDEuIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcih0aGVtZS52aXN1YWxzLmJnQ29sb3IpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUuZm9nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5mb2cuY29sb3Iuc2V0SGV4KHRoZW1lLnZpc3VhbHMuZm9nQ29sb3IpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuZm9nLmRlbnNpdHkgPSB0aGVtZS52aXN1YWxzLmZvZ0RlbnNpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS51cGRhdGVUaGVtZSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWRpdW0udXBkYXRlVGhlbWUodGhlbWUudmlzdWFscyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBoeXNpY3MKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIgPSB0aGVtZS5waHlzaWNzLndhdGVyRHJhZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuREVQVEhfU1BSSU5HID0gdGhlbWUucGh5c2ljcy5kZXB0aFNwcmluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSGF6YXJkcwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSB0aGVtZS5oYXphcmRzIHx8IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQodGhlbWUubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2ggfHwgYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBmb3JjZXMgaWYgYmFsbCBpcyBoZWxkIG9yIGludmFsaWQKICAgICAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSkgYmFsbC5zZXRFeHRlcm5hbEZvcmNlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwwKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgdGhpcy5hY3RpdmVIYXphcmRzLmZvckVhY2goaCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoaC50eXBlID09PSAnY3VycmVudCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBQZXJpb2RpYyBwdXNoCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZW5ndGggPSBNYXRoLnNpbih0aGlzLmhhemFyZFRpbWVyICogaC5mcmVxdWVuY3kpICogMC41ICsgMC41OyAKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZW5ndGggPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWNjdW11bGF0ZSBmb3JjZSAoQWNjZWxlcmF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEZvcmNlLmFkZFNjYWxlZFZlY3RvcihoLmZvcmNlLCBzdHJlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzIGZvciBjdXJyZW50IChrZWVwIGhlcmUgZm9yIGFtYmllbnQgZWZmZWN0IGFyb3VuZCBiYWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyMCwgKE1hdGgucmFuZG9tKCktMC41KSoxMCwgKE1hdGgucmFuZG9tKCktMC41KSoyMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IGguZm9yY2UuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyLjApIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGgudHlwZSA9PT0gJ3ZlbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGgucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgaC5yYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgVXB3YXJkIEZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRm9yY2UueSArPSBoLmZvcmNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAwLjUsIGNvbG9yOiAweGZmNDQwMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcHBseSBjYWxjdWxhdGVkIGVudmlyb25tZW50YWwgZm9yY2VzIHRvIHRoZSBiYWxsCiAgICAgICAgICAgIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSh0b3RhbEZvcmNlKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIgPSBBcmVuYVRoZW1lTWFuYWdlcjsKICAgIHdpbmRvdy5mbHV4LlRIRU1FUyA9IFRIRU1FUzsKfSkoKTs=","/ArenaThemeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBUSEVNRVMgPSB7CiAgICAgICAgJ1NUQU5EQVJEJzogewogICAgICAgICAgICBuYW1lOiAnQkVTQUlEIFNQSEVSRSBQT09MJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAwMDEsCiAgICAgICAgICAgICAgICBzdHJ1Y3R1cmVDb2xvcjogMHgwODBjMTAsCiAgICAgICAgICAgICAgICByaW1Db2xvcjogMHgwMDQ0NjYsCiAgICAgICAgICAgICAgICBsaWdodENvbG9yOiAweDAwYWFmZgogICAgICAgICAgICB9LAogICAgICAgICAgICBwaHlzaWNzOiB7CiAgICAgICAgICAgICAgICB3YXRlckRyYWc6IDAuMTUsCiAgICAgICAgICAgICAgICBkZXB0aFNwcmluZzogMS4wCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhemFyZHM6IFtdCiAgICAgICAgfSwKICAgICAgICAnREVFUF9TRUEnOiB7CiAgICAgICAgICAgIG5hbWU6ICdCQUFKIFJVSU5TJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgwMDA1MTAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAyNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDAyMDUwOCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDAwMjIzMywKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBmZmFhCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4yNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogWwogICAgICAgICAgICAgICAgeyB0eXBlOiAnY3VycmVudCcsIGZvcmNlOiBuZXcgVEhSRUUuVmVjdG9yMyg4LCAwLCAwKSwgZnJlcXVlbmN5OiAwLjUgfQogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAnVk9MQ0FOSUMnOiB7CiAgICAgICAgICAgIG5hbWU6ICdLSUxJS0EgVEVNUExFJywKICAgICAgICAgICAgdmlzdWFsczogewogICAgICAgICAgICAgICAgYmdDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dDb2xvcjogMHgyMjA1MDAsCiAgICAgICAgICAgICAgICBmb2dEZW5zaXR5OiAwLjAxNSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDFhMDUwMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MTEwMCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmY0NDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4xLAogICAgICAgICAgICAgICAgZGVwdGhTcHJpbmc6IDEuMgogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXphcmRzOiBbCiAgICAgICAgICAgICAgICB7IHR5cGU6ICd2ZW50JywgcG9zaXRpb246IG5ldyBUSFJFRS5WZWN0b3IzKDAsIC0xNSwgMCksIHJhZGl1czogMTUsIGZvcmNlOiA0MC4wIH0KICAgICAgICAgICAgXQogICAgICAgIH0sCiAgICAgICAgJ0NFTEVTVElBTCc6IHsKICAgICAgICAgICAgbmFtZTogJ01BQ0FMQU5JQSBXT09EUycsCiAgICAgICAgICAgIHZpc3VhbHM6IHsKICAgICAgICAgICAgICAgIGJnQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nQ29sb3I6IDB4MTAwMDIwLAogICAgICAgICAgICAgICAgZm9nRGVuc2l0eTogMC4wMSwKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDEwMDAyMCwKICAgICAgICAgICAgICAgIHJpbUNvbG9yOiAweDQ0MDA4OCwKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4ZmYwMGZmCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBoeXNpY3M6IHsKICAgICAgICAgICAgICAgIHdhdGVyRHJhZzogMC4wNSwKICAgICAgICAgICAgICAgIGRlcHRoU3ByaW5nOiAwLjIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGF6YXJkczogW10KICAgICAgICB9CiAgICB9OwoKICAgIGNsYXNzIEFyZW5hVGhlbWVNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSAnU1RBTkRBUkQnOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5oYXphcmRUaW1lciA9IDA7CiAgICAgICAgfQoKICAgICAgICBzZXRUaGVtZSh0aGVtZUtleSkgewogICAgICAgICAgICBpZiAoIVRIRU1FU1t0aGVtZUtleV0pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGhlbWUgPSB0aGVtZUtleTsKICAgICAgICAgICAgY29uc3QgdGhlbWUgPSBUSEVNRVNbdGhlbWVLZXldOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYFNldHRpbmcgQXJlbmEgVGhlbWU6ICR7dGhlbWUubmFtZX1gKTsKCiAgICAgICAgICAgIC8vIDEuIFZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcih0aGVtZS52aXN1YWxzLmJnQ29sb3IpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NlbmUuZm9nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5mb2cuY29sb3Iuc2V0SGV4KHRoZW1lLnZpc3VhbHMuZm9nQ29sb3IpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuZm9nLmRlbnNpdHkgPSB0aGVtZS52aXN1YWxzLmZvZ0RlbnNpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS51cGRhdGVUaGVtZSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWRpdW0udXBkYXRlVGhlbWUodGhlbWUudmlzdWFscyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFBoeXNpY3MKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuV0FURVJfRFJBR19MSU5FQVIgPSB0aGVtZS5waHlzaWNzLndhdGVyRHJhZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGxDb25maWcuREVQVEhfU1BSSU5HID0gdGhlbWUucGh5c2ljcy5kZXB0aFNwcmluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSGF6YXJkcwogICAgICAgICAgICB0aGlzLmFjdGl2ZUhhemFyZHMgPSB0aGVtZS5oYXphcmRzIHx8IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQodGhlbWUubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2ggfHwgYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBmb3JjZXMgaWYgYmFsbCBpcyBoZWxkIG9yIGludmFsaWQKICAgICAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSkgYmFsbC5zZXRFeHRlcm5hbEZvcmNlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwwKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRvdGFsRm9yY2UgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgdGhpcy5hY3RpdmVIYXphcmRzLmZvckVhY2goaCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoaC50eXBlID09PSAnY3VycmVudCcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBQZXJpb2RpYyBwdXNoCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyZW5ndGggPSBNYXRoLnNpbih0aGlzLmhhemFyZFRpbWVyICogaC5mcmVxdWVuY3kpICogMC41ICsgMC41OyAKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZW5ndGggPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWNjdW11bGF0ZSBmb3JjZSAoQWNjZWxlcmF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEZvcmNlLmFkZFNjYWxlZFZlY3RvcihoLmZvcmNlLCBzdHJlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWxzIGZvciBjdXJyZW50IChrZWVwIGhlcmUgZm9yIGFtYmllbnQgZWZmZWN0IGFyb3VuZCBiYWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyMCwgKE1hdGgucmFuZG9tKCktMC41KSoxMCwgKE1hdGgucmFuZG9tKCktMC41KSoyMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC41LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0dGVyVmVsb2NpdHk6IGguZm9yY2UuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigyLjApIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGgudHlwZSA9PT0gJ3ZlbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGgucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgaC5yYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgVXB3YXJkIEZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRm9yY2UueSArPSBoLmZvcmNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAwLjUsIGNvbG9yOiAweGZmNDQwMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBcHBseSBjYWxjdWxhdGVkIGVudmlyb25tZW50YWwgZm9yY2VzIHRvIHRoZSBiYWxsCiAgICAgICAgICAgIGJhbGwuc2V0RXh0ZXJuYWxGb3JjZSh0b3RhbEZvcmNlKTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguQXJlbmFUaGVtZU1hbmFnZXIgPSBBcmVuYVRoZW1lTWFuYWdlcjsKICAgIHdpbmRvdy5mbHV4LlRIRU1FUyA9IFRIRU1FUzsKfSkoKTs="}}</script></head>
<body>
<div id="game-container">
<img id="screen-overlay-gif" src="https://i.postimg.cc/htrkgHTr/grok-video-2026-01-09-06-22-47-ezgif-com-resize.gif">
<div id="ui-layer">
            <div id="ui-particles">
                <div class="ui-mote layer-1"></div>
                <div class="ui-mote layer-2"></div>
                <div class="ui-mote layer-3"></div>
            </div>
            <!-- Cinematic Letterboxing -->
            <div id="cinematic-bars">
                <div class="bar top"></div>
                <div class="bar bottom"></div>
            </div>

            <!-- Tech Copy / Event Flash System -->
            <div id="tech-flash-overlay">
                <div class="flash-line top"></div>
                <div class="tech-content-wrapper">
                    <div class="tech-text">TECHCOPY!</div>
                    <div class="tech-sub-text"></div>
                    <div class="tech-timer-track">
                        <div class="tech-timer-fill"></div>
                    </div>
                </div>
                <div class="flash-line bottom"></div>
            </div>

            <div id="loading">Loading Blitzball...</div>

            <!-- Top HUD -->
<!-- Top HUD: Herculean Scoreboard -->
            <div id="hud-top" class="herculean-hud">
                
                <!-- Left Wing: Home Team -->
                <div class="sb-wing home">
                    <div class="sb-wing-bg"></div>
                    <div class="sb-content-container">
                        <div class="sb-team-info">
                            <span class="sb-team-name">BESAID</span>
                            <span class="sb-team-sub">AUROCHS</span>
                        </div>
                        <div class="sb-score-wrapper">
                            <div id="score-player" class="sb-score">0</div>
                        </div>
                    </div>
                    <div class="sb-crystal-deco"></div>
                    <div class="sb-energy-conduit"></div>
                </div>

                <!-- Center: Chronosphere -->
                <div class="sb-chronosphere">
                    <div class="chrono-ring outer"></div>
                    <div class="chrono-ring mid"></div>
                    <div class="chrono-ring inner"></div>
                    <div class="chrono-core">
                        <div id="half-indicator">1ST</div>
                        <div id="timer-display">00:00</div>
                    </div>
                    <div class="chrono-gem top"></div>
                    <div class="chrono-gem bottom"></div>
                </div>

                <!-- Right Wing: Away Team -->
                <div class="sb-wing away">
                    <div class="sb-wing-bg"></div>
                    <div class="sb-content-container">
                        <div class="sb-score-wrapper">
                            <div id="score-cpu" class="sb-score">0</div>
                        </div>
                        <div class="sb-team-info">
                            <span class="sb-team-name">LUCA</span>
                            <span class="sb-team-sub">GOERS</span>
                        </div>
                    </div>
                    <div class="sb-crystal-deco"></div>
                    <div class="sb-energy-conduit"></div>
                </div>

            </div>

            <!-- NEW: Goal Distance Indicator -->
            <div id="goal-distance-container">
                <div class="distance-label">GOAL</div>
                <div id="goal-distance">0m</div>
            </div>

            <!-- Mini-Map -->
            <div id="minimap-container">
                <div class="radar-rim"></div>
                <div id="minimap"></div>
                <div class="radar-label">SPHERE POOL</div>
            </div>

            <!-- Player Status Panel -->
            <div id="player-status-panel">
                <div class="char-name">TIDUS</div>
                <div class="hp-gauge-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar-track">
                        <div class="hp-bar-fill" style="width: 100%;"></div>
                    </div>
                    <div class="hp-value">120/120</div>
                </div>
                <div class="tech-gauge-container">
                    <div class="tech-label">EXP</div>
                    <div class="tech-bar-track">
                        <div class="tech-bar-fill" style="width: 45%;"></div>
                    </div>
                </div>
            </div>
<!-- 3. Renderer -->
            <!-- NEW: Charge Power Meter -->
            <div id="charge-meter-container">
                <div class="charge-label">POWER</div>
                <div class="charge-meter-track">
                    <div id="charge-meter-fill"></div>
                </div>
                <div class="charge-hint">RELEASE!</div>
            </div>

            <!-- Announcement -->
            <div id="announcement">GOAL!</div>
<!-- Controls -->
            <!-- Controls -->
            <!-- Movement Joystick (Left) -->
            <div id="joystick-hit-zone"></div>
            <div id="joystick-visual-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>

            <!-- NEW: Aim Joystick (Right) -->
            <div id="aim-joystick-zone"></div>
            <div id="aim-joystick-visual">
                <div id="aim-joystick-base"></div>
                <div id="aim-joystick-knob"></div>
            </div>

            <div id="camera-zone"></div>

            <!-- Action Command -->
            <div id="action-container">
                <div class="command-menu-bg"></div>
                <div class="command-ring"></div>
                <div id="action-label">COMMAND</div>
                <div id="action-buttons-wrapper" style="position: relative; width: 100px; height: 100px;">
<div id="action-button">
                        <!-- Layer 1: Outer Ornate Ring (Metal/Gold) -->
                        <div class="ab-outer-ring"></div>
                        <!-- Layer 2: Rune Ring (Spinning Text/Symbols) -->
                        <div class="ab-rune-ring"></div>
                        <!-- Layer 3: Inner Crystal Housing -->
                        <div class="ab-inner-crystal"></div>
                        <!-- Layer 4: Liquid Core (The button surface) -->
                        <div class="ab-liquid-core"></div>
                        <!-- Layer 5: Limit Break / Overdrive Ring -->
                        <div class="limit-ring"></div>
                        <!-- Layer 6: Text Label -->
                        <span class="btn-text">WAIT</span>
                        <!-- Layer 7: Glare/Shine Overlay -->
                        <div class="btn-glare"></div>
                        <!-- Layer 8: Particle Emitter Anchor -->
                        <div class="ab-particles"></div>
                    </div>
                    <div id="pass-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">PASS</span>
                        <div class="btn-glare"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Tackle Button -->
            <div id="tackle-button">
                <span class="btn-text">TACKLE</span>
                <div class="btn-glare"></div>
            </div>

            <!-- Auto/Demo Toggle -->
            <div id="auto-toggle" class="glass-btn">MANUAL</div>

            <!-- NEW: Settings Button -->
            <div id="settings-button" class="glass-btn">SETTINGS</div>

            <div id="practice-restore-btn">MENU</div>
<div id="controls-hint">WASD or Drag to Swim | Swipe to Dash</div>

            <!-- Gesture Hint Overlay -->
            <div id="gesture-hint">
                <svg width="200" height="300" viewBox="0 0 200 300" style="overflow: visible;">
                    <path class="curve-arrow" d="M100 250 Q 180 150 100 50" stroke="#00ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="15 15"></path>
                    <polygon points="100,40 115,65 85,65" fill="#00ffff" filter="drop-shadow(0 0 5px #00ffff)"></polygon>
                </svg>
                <div class="gesture-text">SWIPE CURVE</div>
                <div class="gesture-hand"></div>
<div class="gesture-hand"></div>
            </div>

            <!-- Offscreen Player Indicator -->
            <div id="offscreen-indicator">
                <div class="arrow"></div>
            </div>

            <!-- NEW: Settings Panel -->
<!-- NEW: Settings Panel -->
<div id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <span>SETTINGS</span>
                    <button id="settings-close">X</button>
                </div>
                <div class="settings-content">
                    <div class="setting-row">
                        <label>Sensitivity</label>
                        <input type="range" id="sensitivity-slider" min="50" max="150" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Aim Assist</label>
                        <input type="checkbox" id="aim-assist-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Camera Shake</label>
                        <input type="checkbox" id="shake-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" value="50">
                    </div>
                    <div class="setting-row" style="justify-content: center; margin-top: 20px; background: transparent;">
                        <button id="exit-to-menu-btn" class="glass-btn" style="width: 100%; border-color: #ff4444; color: #ff4444;">EXIT TO MENU</button>
                    </div>
                </div>
            </div>


            <!-- Practice Overlay -->
            <div id="practice-overlay">
                <div class="practice-panel">
                    <div class="panel-header">
                        <div class="panel-minimize-btn" id="p-minimize">-</div>
                        <div class="panel-title-group">
                            <span class="panel-title">BLITZ TRAINING</span>
                            <span class="panel-subtitle">SPHERE POOL SIMULATION</span>
                        </div>
                        <div class="panel-deco-line"></div>
                    </div>

                    <div class="panel-content">
                        <div class="panel-section">
                            <div class="section-label">DRILL SELECTION</div>
                            <div class="drill-list">
<div class="drill-btn active" data-drill="free">
                                    <span class="icon"></span> FREE ROAM
                                </div>
                                <div class="drill-btn" data-drill="ball_lab">
                                    <span class="icon"></span> BALL LAB
                                </div>
                                <div class="drill-btn" data-drill="shooting">
                                    <span class="icon"></span> SHOOTING
                                </div>
                                <div class="drill-btn" data-drill="passing">
                                    <span class="icon"></span> PASSING
                                </div>
<div class="drill-btn" data-drill="defense">
                                    <span class="icon"></span> DEFENSE
                                </div>
                                <div class="drill-btn" data-drill="curve">
<span class="icon"></span> CURVE BALL
                                </div>
                                <div class="drill-btn" data-drill="rapid_fire">
                                    <span class="icon"></span> RAPID FIRE
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="section-label">SYSTEM OVERRIDE</div>
                            <div class="option-list">
<div class="option-toggle active" id="opt-inf-stat">
                                    <span class="checkbox"></span> INF STATS
                                </div>
                                <div class="option-toggle active" id="opt-ai-dummy">
                                    <span class="checkbox"></span> AI DUMMY
                                </div>
                                <div class="option-toggle" id="opt-hitboxes">
                                    <span class="checkbox"></span> HITBOXES
                                </div>
                            </div>

                            <div class="section-label" style="margin-top: 15px;">COMMANDS</div>
                            <div class="action-btn" id="p-reset-ball">RESET BALL (R)</div>
                            <div class="action-btn" id="p-exit">EXIT PRACTICE</div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <div id="drill-instruction">SELECT A DRILL TO BEGIN SIMULATION</div>
                        <div id="drill-score">SCORE: 0</div>
                    </div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="active">
                <div class="menu-bg-overlay"></div>
                <div class="ffx-logo-container">
                    <div class="ffx-logo-main">BLITZBALL</div>
                    <div class="ffx-logo-sub">REMASTERED</div>
                </div>
                <div class="menu-options">
                    <div class="menu-item" data-action="normal">
                        <span class="cursor">&gt;</span>
                        <span class="label">NORMAL MATCH</span>
                    </div>
                    <div class="menu-item" data-action="practice">
                        <span class="cursor">&gt;</span>
                        <span class="label">PRACTICE</span>
                    </div>
                    <div class="menu-item" data-action="ball_lab">
                        <span class="cursor">&gt;</span>
                        <span class="label">BALL LAB</span>
                    </div>
                    <div class="menu-item" data-action="options">
                        <span class="cursor">&gt;</span>
                        <span class="label">OPTIONS</span>
                    </div>
                </div>
                <div class="menu-footer">FLUX ENGINE v2.0</div>
</div>

            <!-- NEW: End Game Menu -->
            <div id="end-game-menu">
                <div class="end-bg-layer"></div>
                <div class="end-content">
                    <div class="result-header">
                        <div class="result-title" id="end-result-title">VICTORY</div>
                        <div class="result-subtitle">MATCH COMPLETE</div>
                    </div>
                    
                    <div class="final-score-container">
                        <div class="final-team home">
                            <div class="final-score-digit" id="end-score-home">3</div>
                            <div class="final-team-name">BESAID</div>
                        </div>
                        <div class="final-vs">
                            <div class="vs-line"></div>
                            <span>VS</span>
                            <div class="vs-line"></div>
                        </div>
                        <div class="final-team away">
                            <div class="final-score-digit" id="end-score-away">1</div>
                            <div class="final-team-name">LUCA</div>
                        </div>
                    </div>

                    <div class="end-options">
                        <div class="menu-item" id="end-btn-rematch">
                            <span class="cursor">&gt;</span>
                            <span class="label">REMATCH</span>
                        </div>
                        <div class="menu-item" id="end-btn-exit">
                            <span class="cursor">&gt;</span>
                            <span class="label">EXIT TO MENU</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script>(function() {
    window.flux = window.flux || {};

    const _loader = new THREE.GLTFLoader();

    // Helper to convert a single material to Basic (Unlit/PSX)
// Helper to convert a single material to Basic (Unlit/PSX)
    function convertMaterial(oldMat, isSkinned) {
        
        // Preserve texture: Check map, then emissiveMap
        const texture = oldMat.map || oldMat.emissiveMap || null;

        // FORCE OPAQUE VISIBILITY
        // We override transparency to ensure models are always visible (fixing the "invisible model" issue).
        const params = {
            map: texture,
            color: 0xffffff,        // FORCE WHITE: Remove any tint from GLTF
            skinning: isSkinned,
            side: THREE.DoubleSide, // Render both sides to prevent backface culling invisibility
            transparent: false,     // Disable transparency to prevent sorting issues
            opacity: 1.0,           // Force full opacity
            alphaTest: 0.5,         // Strong alpha test for cutouts (nets/grates)
            vertexColors: oldMat.vertexColors, // Preserve vertex colors
            depthTest: true,
            depthWrite: true,       // Force depth write so it occludes properly
            fog: true
        };

        // Ensure texture encoding is correct for Three.js
        if (params.map) params.map.encoding = THREE.sRGBEncoding;

        return new THREE.MeshBasicMaterial(params);
    }

    window.flux.AssetLoader = {
        loadModel: function(url, onLoad, onProgress, onError) {
            _loader.load(url, function(gltf) {
                gltf.scene.traverse(function(node) {
                    if (node.isMesh) {
node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // Prevent invisibility
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material = node.material.map(m => convertMaterial(m, node.isSkinnedMesh));
                            } else {
                                node.material = convertMaterial(node.material, node.isSkinnedMesh);
                            }
                        }
                    }
                });
                if (onLoad) onLoad(gltf);
            }, onProgress, onError);
        }
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Ball Lab / DevTools: throw & curve mapping knobs
window.flux.ThrowConfig = window.flux.ThrowConfig || {
        SWIPE_MIN_PX: 20,
        AIM_DX_SCALE: 1,
        AIM_DY_SCALE: 1,

        POWER_BASE: 1,
        POWER_RANGE: 0.8,
        POWER_MAX_BONUS_RATIO: 0.95,
        POWER_MAX_MULTIPLIER: 2.5,

        CURVE_ENABLED: true,
        CURVE_INTENSITY_THRESHOLD: 0.25,
        CURVE_SPIN_SCALE: 1000,
        CURVE_SPEED_MULT: 1.5,
        CURVE_SPIN_CAP: 1500,
        CURVE_PERFECT_SPIN: 500
    };

    // Reusable math objects
    const _pVec = new THREE.Vector3();
    const _pVec2 = new THREE.Vector3();
    const _pQuat = new THREE.Quaternion();
    const _pQuat2 = new THREE.Quaternion();
    const _pTargetQuat = new THREE.Quaternion();
    const _pEuler = new THREE.Euler();
    const _pAxisY = new THREE.Vector3(0, 1, 0);
    const _pAxisZ = new THREE.Vector3(0, 0, 1);
    const _pInvQuat = new THREE.Quaternion();
    const _pTmpQuat = new THREE.Quaternion();
    const _pTmpEuler = new THREE.Euler();


    // --- NEW: Reticle Texture for Pass Indicator ---
    const _reticleTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 256; c.height = 256;
        const ctx = c.getContext('2d');
        const cx = 128, cy = 128;
        
        ctx.clearRect(0,0,256,256);
        
        // Glow
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#ffffff';
        
        // 1. Outer Ring Segments
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        
        for(let i=0; i<3; i++) {
            const start = (i * (Math.PI*2)/3) + 0.2;
            const end = ((i+1) * (Math.PI*2)/3) - 0.2;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, start, end);
            ctx.stroke();
        }
        
        // 2. Inner Brackets
        ctx.lineWidth = 4;
        const r = 60;
        const len = 20;
        // Corners
        const drawCorner = (x, y, dx, dy) => {
            ctx.beginPath();
            ctx.moveTo(x, y-dy*len);
            ctx.lineTo(x, y);
            ctx.lineTo(x-dx*len, y);
            ctx.stroke();
        };
        drawCorner(cx-r, cy-r, -1, -1); // TL
        drawCorner(cx+r, cy-r, 1, -1);  // TR
        drawCorner(cx+r, cy+r, 1, 1);   // BR
        drawCorner(cx-r, cy+r, -1, 1);  // BL

        // 3. Center Dot
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(cx, cy, 10, 0, Math.PI*2);
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    class Player {
        constructor(scene, role = 'MF') {
            this.scene = scene;
            this.role = role;
            this.team = null; // Assigned by Team.addPlayer
            this.homePosition = new THREE.Vector3();

            this.mesh = null;
            this.mixer = null;
            this.actions = {};
            this.activeAction = null;
            this.state = 'idle';
            this._animLocked = false;
            this._lockedState = null;
            this._lastLocomotion = 'idle';
            this.inputVector = new THREE.Vector3(0, 0, 0);

            // Physics (Drift/Inertia Model)
            this.velocity = new THREE.Vector3(0, 0, 0);
this.acceleration = 18.0; // Snappier movement (was 12.0)
            this.drag = 3.0;
            this.maxSpeed = 8.0;
            // Bone reference for holding ball
            this.handBone = null;
            // Procedural animation bone refs (filled in setMesh)
            this.bones = {
                hips: null,
                spine: null,
                chest: null,
                neck: null,
                head: null,
                rUpperArm: null,
                rForeArm: null,
                rHand: null,
                lUpperArm: null,
                lForeArm: null,
                lHand: null
            };
            this._boneBaseQuats = null; // Optional future use
            this._procAnimTime = 0;
            this._smoothedSpeed = 0;
            this._movingLatch = false;

            this.canCatch = true;
            this.catchCooldown = 0; // Replaces setTimeout for safety

            // Blitzball Stats
            this.stats = {
                HP: 100,
                maxHP: 100,
                EN: 30,
                AT: 10,
                PA: 15,
                BL: 10,
                SH: 15,
                CA: 10,
                SP: 60
            };

            // Leveling System
            this.level = 1;
            this.exp = 0;
            this.nextLevelExp = 100;

            // Status Effects & Techniques
this.status = {
                venom: 0,
                nap: 0,
                wither: { PA: 0, SH: 0, AT: 0, BL: 0, CA: 0, SP: 0 },
                blind: 0,
                silence: 0,
                shield: 0,
                haste: 0,
                slow: 0,
                burn: 0,
                shock: 0
            };

            this.marking = null;
            this.learnedTechs = [];

this.techs = {
                tackle: null,
                shoot: null,
                pass: null,
                passive: null
            };

            this.elementalInfusion = null; // { type: 'fire'|'ice'|'volt', duration: number }

            // Visuals
            this.baseColorHex = 0xffffff;
            this.originalMaterials = [];
            this.auraMesh = null;
            this.rotationOffset = 0;
            this.baseScale = 1.17; // Increased ~8%

            // Real-time Stats
            this.currentEN = this.stats.EN;
            this.tackleRadius = 2.0; // Reduced from 2.5 to reduce swarm lock

            this.speed = 4.0;
            this._updateDerivedStats();

            this.hasBall = false;
            this.isThrowing = false;

            // Dash State
            this.isDashing = false;
            this.dashTime = 0;
            this.dashTotalTime = 0.5;
            this.dashCooldown = 0;
            this.dashVec = new THREE.Vector3();

            // Feedback Accumulators
            this._accumulatedDamage = 0;
            this._damageTimer = 0;

            // HP Bar
            this.hpBar = null;
            this.hpBarFill = null;

            // Gameplay Flow Timers
            this.stunTimer = 0;
            this.immunityTimer = 0;

            // Banking & Verticality
            this.bankingAmount = 0;
            this.targetY = 0;

            // Encounter System
            this.isEngaged = false;
this.clashTimer = 0;
            this.encounterTimer = 0; // Track duration of current engagement
            // Charge Mechanic
            this.isCharging = false;
            this.chargeTime = 0;
            this.maxChargeTime = 1.5;

            // FIXED: Improved Rotation State with hysteresis
            this.currentYaw = 0;
            this.targetYaw = 0;
            this.lastValidYaw = 0; // Store last known good yaw for deadzone handling
            this.pitchAmount = 0;
            this.bankingAmount = 0;
            this.facingDeadzone = 0.3; // Minimum input/velocity magnitude to update facing

            // Particle Emission Timers
this._particleTimers = {
                venom: 0,
                nap: 0,
                wither: 0,
                blind: 0,
                silence: 0,
                shield: 0,
                haste: 0,
                slow: 0,
                burn: 0,
                shock: 0
            };

            // DevTools Flags
            this.isGodMode = false;

            // Pass Target Indicator
            this.passTargetIndicator = null;
            
            // Bubble Trail Timer
            this._bubbleTimer = 0;

this._dashParticleTimer = 0;
            this._swimSfxTimer = 0; // Timer for swim sound effects
            this.struggleIntensity = 0; // Continuous pressure factor (0.0 to 1.0)

            // --- JUICE: Visual Feedback ---
            this.flashTimer = 0;
            this.flashDuration = 0;
            this.flashColor = new THREE.Color(0xffffff);

            this.currentSquash = new THREE.Vector3(1, 1, 1);
            this.squashVelocity = new THREE.Vector3(0, 0, 0);
            
            // HP Bar FX State
            this.hpShake = 0;
            this.hpFlash = 0;


// --- NEW: Evasion & Charged Tackle ---
            this.isEvading = false;
            this.evadeTime = 0;
            this.evadeCooldown = 0;
            
            this.isTackleCharging = false;
            this.tackleChargeTime = 0;
            this.maxTackleChargeTime = 1.5;
            this.tackleChargeBonus = 0;

            // --- NEW: Tackle Mechanics (Phase 1) ---
            this.isTackling = false;
            this.tackleTime = 0;
            this.isRecovering = false;
            this.recoveryTime = 0;
            this._hasHitTackle = false;
            
            // --- NEW: Blocking ---
            this.isBlocking = false;
        }

        syncRotation() {
            if (!this.mesh) return;
            const euler = new THREE.Euler().setFromQuaternion(this.mesh.quaternion, 'YXZ');
            this.currentYaw = euler.y - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.lastValidYaw = this.currentYaw;
            this.bankingAmount = 0;
            this.pitchAmount = 0;
        }

getStat(name) {
            let val = this.stats[name];
            if (this.status.wither[name] > 0) {
                val *= 0.5;
            }
            // Blocking Bonus
            if (this.isBlocking && name === 'BL') {
                val *= 2.0;
            }
            return val;
        }

        applyStatus(type, duration, subType = null) {
            if (type === 'venom') {
                const wasActive = this.status.venom > 1.0;
                this.status.venom = Math.max(this.status.venom, duration);

                if (!wasActive) {
                    console.log(`${this.role} poisoned!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("POISON", this.mesh.position, "status");
                }
            } else if (type === 'nap') {
                const wasActive = this.status.nap > 1.0;
                this.status.nap = Math.max(this.status.nap, duration);

                if (!wasActive) {
                    if (this.hasBall) this.fumble();
                    console.log(`${this.role} fell asleep!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("SLEEP", this.mesh.position, "status");
                }
            } else if (type === 'wither' && subType) {
                const currentVal = this.status.wither[subType] || 0;
                const wasActive = currentVal > 1.0;
                this.status.wither[subType] = Math.max(currentVal, duration);

                if (!wasActive) {
                    console.log(`${this.role} withered ${subType}!`);
if (window.flux.gameInstance && window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn(`WITHER ${subType}`, this.mesh.position, "status");

                }
            } else if (type === 'blind') {
                this.status.blind = Math.max(this.status.blind, duration);
                    window.flux.gameInstance.floatingText.spawn("BLIND", this.mesh.position, "status");
            } else if (type === 'silence') {
                this.status.silence = Math.max(this.status.silence, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCE", this.mesh.position, "status");
            } else if (type === 'shield') {
                this.status.shield = Math.max(this.status.shield, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SHIELD", this.mesh.position, "heal");
            } else if (type === 'haste') {
                this.status.haste = Math.max(this.status.haste, duration);
                this.status.slow = 0; // Overwrite slow
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("HASTE", this.mesh.position, "heal");

            } else if (type === 'slow') {
                this.status.slow = Math.max(this.status.slow, duration);
                this.status.haste = 0; // Overwrite haste
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SLOW", this.mesh.position, "status");
            } else if (type === 'burn') {
                this.status.burn = Math.max(this.status.burn, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("BURN", this.mesh.position, "status");
            } else if (type === 'shock') {
                this.status.shock = Math.max(this.status.shock, duration);
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SHOCK", this.mesh.position, "status");
            }
        }

_updateDerivedStats() {
            const sp = this.getStat('SP');
this.maxSpeed = 6.0 + (sp / 15.0); // Increased base speed (was 5.0)
            this.currentEN = this.getStat('EN');
        }

        setMesh(sourceMesh, animations) {
            this.mesh = sourceMesh;
            this.scene.add(this.mesh);
this.scene.add(this.mesh);
            this._createHPBar();
            this._createStatusRing(); // NEW: Status Ring
            this._createAura();
            this._createAura();
            this._createPassTargetIndicator();

            // Custom Character Scaling
            if (this.characterName) {
                if (this.characterName.includes('Tidus')) this.baseScale = 1.6;
                else if (this.characterName.includes('Wakka')) this.baseScale = 1.4;
            }

            this.mesh.scale.setScalar(this.baseScale);

            this.mesh.traverse((node) => {
                if (node.isMesh && node.material) {
                    const convertOne = (mat) => {
                        const m = new THREE.MeshBasicMaterial({
                            map: mat.map || null,
                            color: new THREE.Color(0xffffff), // FORCE WHITE: Ignore source color
                            transparent: !!mat.transparent,
                            opacity: (mat.opacity !== undefined ? mat.opacity : 1),
                            alphaTest: (mat.alphaTest !== undefined ? mat.alphaTest : 0),
                            side: mat.side,
                            depthTest: mat.depthTest,
                            depthWrite: mat.depthWrite,
                            fog: true,
                            skinning: !!node.isSkinnedMesh
                        });
                        this.originalMaterials.push({ material: m, baseColor: m.color.clone() });
                        return m;
                    };
                    node.material = Array.isArray(node.material)
                        ? node.material.map(convertOne)
                        : convertOne(node.material);
                }

                if (node.isBone) {
                    const name = (node.name || '').toLowerCase();

                    // Core spine/head chain (Mixamo-friendly)
                    if (!this.bones.hips && name.includes('hips')) this.bones.hips = node;
                    if (!this.bones.spine && name.includes('spine') && !name.includes('spine2') && !name.includes('spine_2')) this.bones.spine = node;
                    if (!this.bones.chest && (name.includes('chest') || name.includes('spine2') || name.includes('spine_2'))) this.bones.chest = node;
                    if (!this.bones.neck && name.includes('neck')) this.bones.neck = node;
                    if (!this.bones.head && name.includes('head')) this.bones.head = node;

                    const isRight = name.includes('right') || name.endsWith('r') || name.includes('_r') || name.includes('.r');
                    const isLeft  = name.includes('left')  || name.endsWith('l') || name.includes('_l') || name.includes('.l');

                    // Arms/hands (Mixamo: mixamorigRightArm/RightForeArm/RightHand)
                    if (!this.bones.rUpperArm && (name.includes('rightarm') || (isRight && name.includes('upperarm')))) this.bones.rUpperArm = node;
                    if (!this.bones.rForeArm && (name.includes('rightforearm') || (isRight && name.includes('forearm')))) this.bones.rForeArm = node;
                    if (!this.bones.rHand && ((name.includes('hand') && isRight) || name.includes('righthand'))) this.bones.rHand = node;

                    if (!this.bones.lUpperArm && (name.includes('leftarm') || (isLeft && name.includes('upperarm')))) this.bones.lUpperArm = node;
                    if (!this.bones.lForeArm && (name.includes('leftforearm') || (isLeft && name.includes('forearm')))) this.bones.lForeArm = node;
                    if (!this.bones.lHand && ((name.includes('hand') && isLeft) || name.includes('lefthand'))) this.bones.lHand = node;

                    // Back-compat: ball attachment uses handBone
                    if (!this.handBone && this.bones.rHand) this.handBone = this.bones.rHand;
                }
            });

            this.mixer = new THREE.AnimationMixer(this.mesh);

            if (animations) {
                const _normClipName = (s) => (s || '')
                    .toLowerCase()
                    .replace(/[_\-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Helper to strip leg tracks from action clips
                const _stripLegs = (clip) => {
                    const tracks = [];
                    clip.tracks.forEach(t => {
                        // Regex to match leg bones (Mixamo style: RightUpLeg, RightLeg, RightFoot, RightToeBase)
                        // Also generic "Leg", "Foot"
                        if (!t.name.match(/(UpLeg|Leg|Foot|Toe)/i)) {
                            tracks.push(t);
                        }
                    });
                    clip.tracks = tracks;
                    return clip;
                };

                animations.forEach((clip) => {
                    const name = _normClipName(clip.name);
                    const has = (re) => re.test(name);
                    
                    let isLocomotion = false;
                    let actionKey = null;

                    // --- Core locomotion ---
                    if (has(/tread|treading|idle|float/)) {
                        actionKey = 'idle';
                        isLocomotion = true;
                    } else if (has(/dash|sprint|burst|fast\s*swim|swim\s*fast/)) {
                        actionKey = 'dash';
                        isLocomotion = true;
                    } else if (has(/swim|freestyle|crawl/)) {
                        actionKey = 'swim';
                        isLocomotion = true;
                    
                    // --- Throwing (pass/shot variants if present) ---
                    } else if (has(/throw|toss|pitch/)) {
                        if (has(/shoot|shot|goal/)) actionKey = 'throw_shot';
                        else if (has(/pass/)) actionKey = 'throw_pass';
                        else actionKey = 'throw';

                    // --- Catching (jump/air variants if present) ---
                    } else if (has(/catch|receive|grab|intercept/)) {
                        if (has(/jump|leap|air|dive/)) actionKey = 'catch_jump';
                        else actionKey = 'catch';

                    // --- Hit / React ---
                    } else if (has(/react|hit|hurt|damage|stagger|knock/)) {
                        actionKey = 'react';

                    // --- Optional states ---
                    } else if (has(/charge|aim|ready|windup|hold/)) {
                        actionKey = 'charge';
                    } else if (has(/tackle|check|ram/)) {
                        actionKey = 'tackle';
                    } else if (has(/block|save/)) {
                        actionKey = 'block';
                    } else if (has(/celebrate|victory|cheer/)) {
                        actionKey = 'celebrate';
                    } else {
                        actionKey = clip.name;
                    }

                    // Strip legs from non-locomotion clips to allow treading water overlay
                    if (!isLocomotion && actionKey) {
                        _stripLegs(clip);
                    }

                    if (actionKey) {
                        this.actions[actionKey] = this.mixer.clipAction(clip);
                    }
                });
            }

            // Start default locomotion
            if (this.actions['idle']) {
                this.playLocomotion('idle');
            } else {
                // Fallback
                const first = Object.values(this.actions)[0];
                if(first) first.play();
            }

            // One-shot animation listener
            if (this.mixer) {
                this.mixer.addEventListener('finished', (e) => {
                    if (!this._animLocked) return;
                    if (!e || !e.action) return;
                    
                    // Check if the finished action is our current one-shot
                    if (e.action === this.activeOneShot) {
                        this._animLocked = false;
                        this._lockedState = null;
                        this.activeOneShot = null;

                        // Return to locomotion updates
                        if (!this.isThrowing) {
                            this._updateLocomotionAnim(0.15);
                        }
                    }
                });
            }
        }

        // New method for base layer (legs/body movement)
        playLocomotion(actionName, duration = 0.5) {
            const newAction = this.actions[actionName];
            if (!newAction || newAction === this.activeLocomotion) return;

            if (this.activeLocomotion) {
                this.activeLocomotion.fadeOut(duration);
            }

            newAction.reset();
            newAction.fadeIn(duration);
            newAction.play();
            this.activeLocomotion = newAction;
            this._lastLocomotion = actionName;
        }

        // Overhauled play method to handle layering
        play(actionName, duration = 0.5) {
            // If it's a locomotion state, route to playLocomotion
            if (['idle', 'swim', 'dash'].includes(actionName)) {
                this.playLocomotion(actionName, duration);
                return;
            }

            // Otherwise treat as an action layer
            const newAction = this.actions[actionName];
            if (!newAction) return;

            // If we have an active one-shot, fade it out
            if (this.activeOneShot && this.activeOneShot !== newAction) {
                this.activeOneShot.fadeOut(0.1);
            }

            newAction.reset();
            newAction.fadeIn(0.1); // Fast transition for actions
            newAction.play();
            
            this.activeOneShot = newAction;
            this.state = actionName;
        }

        _updateLocomotionAnim(duration = 0.2) {
            // Note: We NO LONGER check _animLocked here.
            // Locomotion should update continuously based on speed, 
            // running underneath the upper body action.
            
            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;
            const speed = Math.sqrt(vx * vx + vz * vz);

            // Smooth speed
            const smoothK = 1.0 - Math.pow(0.001, duration);
            this._smoothedSpeed += (speed - this._smoothedSpeed) * smoothK;

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;

            // Hysteresis
            const enterMove = 0.18;
            const exitMove = 0.10;

            const inputMoving = this.inputVector && this.inputVector.lengthSq() > 0.06;
            const velMoving = this._smoothedSpeed > (this._movingLatch ? exitMove : enterMove);

            this._movingLatch = inputMoving || velMoving;

            let target = this._movingLatch ? 'swim' : 'idle';
            if (this._movingLatch && this.isDashing && this.actions['dash']) target = 'dash';

            // Update playback rate
            const applyRate = (key) => {
                const a = this.actions[key];
                if (!a) return;
if (key === 'swim') a.timeScale = THREE.MathUtils.lerp(0.85, 1.70, speedNorm);
                else if (key === 'dash') a.timeScale = THREE.MathUtils.lerp(1.10, 2.20, speedNorm);
                else if (key === 'idle') a.timeScale = THREE.MathUtils.lerp(0.95, 1.05, speedNorm);

                // Haste/Slow Animation Scaling
                if (this.status.haste > 0) a.timeScale *= 1.5;
                if (this.status.slow > 0) a.timeScale *= 0.6;
};

applyRate(target);
                const a = this.actions[target];
                if (a) {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                }
                this.playLocomotion(target, duration);
}

        playOneShot(actionName, duration = 0.1, opts = {}) {
            const a = this.actions[actionName];
            if (!a) return false;

            this._animLocked = true;
            this._lockedState = actionName;

            try {
                a.reset();
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.timeScale = (opts.timeScale !== undefined ? opts.timeScale : 1.0);
            } catch (_) {}

            // Use the new play method which handles layering
            this.play(actionName, duration);
            return true;
        }

        setInput(x, z) {
            if (this.status.nap > 0) {
                this.inputVector.set(0, 0, 0);
                return;
            }
            this.inputVector.set(x, 0, z);
        }
applyExternalForce(vec) {
            if (!this.mesh || this.status.nap > 0) return;
            this.velocity.add(vec);
        }
        receiveBall() {
            this.canCatch = false;
            
            // CRITICAL FIX: Reset states that might prevent shooting
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();

            if (this.status.nap > 0) {
                this.status.nap = 0;
            }

            this.hasBall = true;
            this.immunityTimer = 2.0;

const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            
            if (ball && ball.lastHolder && ball.lastHolder !== this) {
                ball.lastHolder.gainExp(2);
                this.gainExp(1);
            }

            const ballY = (this.ballRef && this.ballRef.mesh) ? this.ballRef.mesh.position.y : 0;
            const catchKey = (ballY > 0.25 && this.actions['catch_jump']) ? 'catch_jump' : 'catch';

            this.playOneShot(catchKey, 0.1);
            
            // JUICE: Catch Squash
            this.squash(1.1, 0.9, 1.1); // Slight compression on catch

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch');
            }

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SNAP!", this.mesh.position, "comic-action");
            }
        }

        throwBall(ball, forcedType = null, powerMultiplier = 1.0, forcedSpin = null) {
            if (!this.hasBall || this.isThrowing) return;
            if (this.status.nap > 0) return;

            this.isThrowing = true;

            // Lock aim direction at start of throw
            this.lockedAimVector = new THREE.Vector3();

            if (this.inputVector.lengthSq() > 0.1) {
                this.lockedAimVector.copy(this.inputVector).normalize();
            } else {
                this.lockedAimVector.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
            }

const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            let type = forcedType;
            if (!type) {
                type = (distToGoal < 25) ? 'SH' : 'PA';
            }

            const isFinisher = (type === 'SH' && distToGoal < 12.0);

            let techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;

if ((this.status.venom > 0 || this.status.silence > 0) && techName) {
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCED", this.mesh.position, "status");
                techName = null;
            }

// Snappier throws: Drastically reduced windup times for instant response
            let windupTime = 20; 
            let animSpeed = 3.0; 

            if (powerMultiplier > 1.1) {
                windupTime += 60; 
            }

            if (isFinisher && !techName) {
                windupTime = 0;
                animSpeed = 5.0;
            }

            if (techName) {
                windupTime = 250; 
                animSpeed = 1.5;

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.playCinematic(techName, this.mesh, 1.2);
                }

                this.immunityTimer = 1.5;

                if (window.flux.gameInstance.floatingText) {
                    const label = techName.replace('_', ' ').toUpperCase();
                    window.flux.gameInstance.floatingText.spawn(label, this.mesh.position, "tech");
                }

                // NEW: Spawn Tech Glyph (Vertical Casting Circle)
                if (window.flux.gameInstance.glyphManager) {
                    window.flux.gameInstance.glyphManager.spawn('tech', this.mesh.position, {
                        parent: this,
                        life: 1.2,
                        rotationSpeed: 4.0,
                        scaleSpeed: 1.5,
                        offsetY: 1.2,
                        faceCamera: true
                    });
                }
            }

            // Pick best throw clip (pass/shot variants if present)
            const throwKey =
                (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' :
                (type === 'PA' && this.actions['throw_pass']) ? 'throw_pass' :
                'throw';

            this.playOneShot(throwKey, 0.1, { timeScale: animSpeed });
            
            // JUICE: Throw Stretch
            this.squash(0.8, 1.2, 0.8); // Stretch on release

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('throw');
            }

            if (window.flux.gameInstance.floatingText && !techName) {
                window.flux.gameInstance.floatingText.spawn("WHOOSH", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                // Safety: If ball holder is still us, proceed. If hasBall is false but holder is us, assume sync lag and proceed.
                if (this.hasBall || (ball && ball.holder === this)) {
                    const throwAction = this.actions[throwKey];
                    if (throwAction) throwAction.timeScale = 1.0;

                    let finalDir = new THREE.Vector3();
                    let referenceDir = new THREE.Vector3();

                    if (this.overrideAimVector) {
                        finalDir.copy(this.overrideAimVector).normalize();
                        referenceDir.copy(finalDir);
                    } else {
                        finalDir.copy(this.lockedAimVector);
                        referenceDir.copy(this.lockedAimVector);
                    }

                    const spin = new THREE.Vector3(0, 0, 0);

                    if (forcedSpin) {
                        spin.copy(forcedSpin);
                    } else if (this.inputVector.lengthSq() > 0.1) {
                        const inputDir = this.inputVector.clone().normalize();
                        const crossY = new THREE.Vector3().crossVectors(referenceDir, inputDir).y;

                        if (Math.abs(crossY) > 0.1) {
                            spin.set(0, crossY * 12.0, 0);
                        }
                    }

                    let baseCost = (type === 'SH') ? 20 : 10;
                    let techCost = 0;
                    let techBonus = 0;
                    let techPayload = null;

                    if (techName) {
                        switch (techName) {
                            case 'venom':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'venom', level: 1 };
                                break;
                            case 'wither':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'wither', level: 1 };
                                break;
                            case 'nap':
                                techCost = (type === 'SH' ? 35 : 30);
                                techBonus = 3;
                                techPayload = { type: 'nap', level: 1 };
                                break;
                            case 'sphere':
                                if (type === 'SH') {
                                    techCost = 25;
                                    const rng = Math.floor(Math.random() * 11) + 5;
                                    techBonus = rng;
                                    techPayload = { type: 'sphere', level: 1, bonus: rng };
                                    if (window.flux.gameInstance.floatingText)
                                        window.flux.gameInstance.floatingText.spawn(`SPHERE +${rng}`, this.mesh.position, "goal");
                                }
                                break;
                            case 'jecht':
                                if (type === 'SH') {
                                    techCost = 40;
                                    techBonus = 5;
                                    techPayload = { type: 'jecht', level: 1 };
                                    this._performJechtKnockback();
                                }
                                break;
                            case 'invisible':
                                if (type === 'SH') {
                                    techCost = 25;
                                    techBonus = 2;
                                    techPayload = { type: 'invisible', level: 1 };
                                }
                                break;
                        }
                    }

                    const totalCost = baseCost + techCost;

                    let powerFactor = 1.0;
                    if (this.stats.HP < totalCost) {
                        powerFactor = 0.5;
                        this.stats.HP = 0;
                        techPayload = null;
                        techBonus = 0;
                        if (window.flux.gameInstance.floatingText)
                            window.flux.gameInstance.floatingText.spawn("TIRED", this.mesh.position, "damage");
                    } else {
                        this.stats.HP -= totalCost;
                    }

                    let statVal = this.getStat(type);
                    statVal += techBonus;
                    statVal *= powerFactor;
                    statVal *= powerMultiplier;

                    const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
                    const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
                    const goalDot = finalDir.dot(goalDir);

                    if (type === 'SH') {
                        const goalPos = new THREE.Vector3(0, 2, goalZ);
                        const toGoal = goalPos.clone().sub(this.mesh.position).normalize();

                        const sh = this.getStat('SH');
                        let assistFactor = Math.min(0.9, Math.max(0.1, sh / 100.0));

                        if (this.overrideAimVector) {
                            assistFactor *= 0.1;
                        }

if (goalDot > 0.2 && this.status.blind <= 0) {
                            finalDir.lerp(toGoal, assistFactor);
                        }

                        if (isFinisher) {
                            finalDir.y += 0.05;
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn("SLAM!", this.mesh.position, "comic-impact");
                            }
                        } else {
                            finalDir.y += 0.25;
                        }
                        
                        // Goalie Loft Bonus (Prevent interception by immediate defender)
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance

                    } else {
                        const target = this._findPassTargetInCone(finalDir);

                        if (target) {
                            const toMate = target.mesh.position.clone().sub(this.mesh.position);
                            if (target.velocity.lengthSq() > 0.1) {
                                toMate.addScaledVector(target.velocity, 0.5);
                            }
                            toMate.normalize();

                            const pa = this.getStat('PA');
                            let assistFactor = Math.min(1.0, 0.3 + (pa / 80.0));

if (this.overrideAimVector) {
                                assistFactor *= 0.1;
                            }
                            
                            // Blind disables assist
                            if (this.status.blind > 0) assistFactor = 0;

finalDir.lerp(toMate, assistFactor);
const dist = this.mesh.position.distanceTo(target.mesh.position);
} else {
                            finalDir.y += 0.2;
                        }
                        
                        // Goalie Loft Bonus for Passing
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance
                    }

// Blind Randomization
                    if (this.status.blind > 0) {
                        finalDir.x += (Math.random() - 0.5) * 0.8;
                        finalDir.y += (Math.random() - 0.5) * 0.4;
                        finalDir.z += (Math.random() - 0.5) * 0.8;
                    }

finalDir.normalize();

                    // ELEMENTAL INFUSION INJECTION
                    if (this.elementalInfusion && this.elementalInfusion.duration > 0) {
                        if (!techPayload) {
                            // If no tech selected, infusion becomes the tech
                            techPayload = { type: this.elementalInfusion.type, level: 1 };
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn(this.elementalInfusion.type.toUpperCase() + " SHOT", this.mesh.position, "tech");
                            }
                        } else {
                            // If tech exists (e.g. Jecht Shot), add element property
                            techPayload.element = this.elementalInfusion.type;
                        }
                    }

                    if (techPayload && window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, techName);
                    }

                    ball.shoot(finalDir, statVal, type, techPayload, spin);

                    // Camera Recoil
                    if (window.flux.gameInstance.cameraManager) {
                        const recoilForce = (type === 'SH' ? 2.5 : 1.0) * (powerMultiplier || 1.0);
                        window.flux.gameInstance.cameraManager.addRecoil(
                            -finalDir.x * recoilForce, 
                            -finalDir.y * recoilForce * 0.5, 
                            -finalDir.z * recoilForce
                        );
                    }
                    
                    // Extra grace period for Goalie to prevent point-blank interceptions
                    if (this.role === 'GL') {
                        ball.catchGracePeriod = 0.6; // 0.6s immunity (approx 10-12m travel)
                    }

this.loseBall(1.0);
                }
            }, windupTime);

            setTimeout(() => {
                this.isThrowing = false;
                this.overrideAimVector = null;
                this._updateLocomotionAnim(0.2);
            }, windupTime + 500);
        }

        _findPassTargetInCone(aimDir) {
            if (!this.team) return null;

            let bestTarget = null;
            let maxScore = -Infinity;

            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;

                const toMate = mate.mesh.position.clone().sub(this.mesh.position).normalize();
                const dot = aimDir.dot(toMate);

                if (dot > 0.7) {
                    const dist = this.mesh.position.distanceTo(mate.mesh.position);
                    const score = (dot * 10) - (dist * 0.1);

                    if (score > maxScore) {
                        maxScore = score;
                        bestTarget = mate;
                    }
                }
            }
            return bestTarget;
        }

        startCharge() {
            if (!this.hasBall || this.isThrowing || this.status.nap > 0) return;
            this.isCharging = true;
            this.chargeTime = 0;

            // Visuals handled in update

            // Show charge UI
            this._updateChargeUI(0);

            // NEW: Spawn Charge Glyph (Ground Ring)
// NEW: Spawn Charge Glyph (Ground Ring)
            if (window.flux.gameInstance && window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: this.maxChargeTime,
                    rotationSpeed: 3.0,
                    scaleSpeed: 0.2,
                    offsetY: 0.1
                });
            }
            
            // SOUND: Charge Up
            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                // Use a synthesized charge sound if 'charge' sfx isn't loaded
                window.flux.gameInstance.audioManager.playSFX('charge', { volume: 0.4, rate: 1.0 });
            }
        }

        releaseCharge(dx, dy, curveInput = null) {
            if (!this.isCharging) return;
            this.isCharging = false;

            // Power Calculation
            const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
            const TC = window.flux.ThrowConfig || {};

            // Base multiplier (defaults: 1.0 to 1.8)
            let multiplier = (TC.POWER_BASE !== undefined ? TC.POWER_BASE : 1.0) + (ratio * (TC.POWER_RANGE !== undefined ? TC.POWER_RANGE : 0.8));
            
            // MAX POWER BONUS: If held near max, significant boost
            if (ratio > (TC.POWER_MAX_BONUS_RATIO !== undefined ? TC.POWER_MAX_BONUS_RATIO : 0.95)) {
                multiplier = (TC.POWER_MAX_MULTIPLIER !== undefined ? TC.POWER_MAX_MULTIPLIER : 2.5); // Critical Power
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("MAX POWER!", this.mesh.position, "comic-impact");
                }
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-10);
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            this._hideChargeUI();

            // Aim Vector Calculation
            let aimVec = null;
            const swipeLen = Math.sqrt(dx*dx + dy*dy);

            if (swipeLen > (TC.SWIPE_MIN_PX !== undefined ? TC.SWIPE_MIN_PX : 20)) {
                const camera = window.flux.gameInstance.camera;
                const fwd = new THREE.Vector3();
                const right = new THREE.Vector3();

                if (camera) {
                    camera.getWorldDirection(fwd);
                    fwd.y = 0;
                    if (fwd.lengthSq() < 0.001) fwd.set(0, 0, -1);
                    else fwd.normalize();

                    right.crossVectors(fwd, new THREE.Vector3(0, 1, 0)).normalize();

                    const worldVec = new THREE.Vector3();
                    worldVec.addScaledVector(right, dx * (TC.AIM_DX_SCALE !== undefined ? TC.AIM_DX_SCALE : 1.0));
                    worldVec.addScaledVector(fwd, -dy * (TC.AIM_DY_SCALE !== undefined ? TC.AIM_DY_SCALE : 1.0));
                    worldVec.normalize();

                    aimVec = worldVec;
                    this.overrideAimVector = aimVec;
                } else {
                    aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    this.overrideAimVector = null;
                }
            } else {
                aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                this.overrideAimVector = null;
            }

// --- ANALOG CURVE LOGIC ---
            // Detect LOB (Vertical Up Swipe)
// Detect LOB (Vertical Up Swipe)
            let isLob = false;
            /* DISABLED: User feedback indicates accidental triggers preventing forward throws.
            if (dy < -80 && Math.abs(dx) < Math.abs(dy) * 0.6) {
                isLob = true;
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("LOB!", this.mesh.position, "tech");
                }
            }
            */

            // Formula: Curve = Intensity * Speed
            // Formula: Curve = Intensity * Speed
            let spinVec = null;
            
            if ((TC.CURVE_ENABLED !== false) && curveInput && Math.abs(curveInput.intensity) > (TC.CURVE_INTENSITY_THRESHOLD !== undefined ? TC.CURVE_INTENSITY_THRESHOLD : 0.25)) {
                const rawIntensity = Math.abs(curveInput.intensity);
                const sign = Math.sign(curveInput.intensity); // Positive = Right Hump = Left Curve
                const swipeSpeed = curveInput.speed || 1.0;

                // 1. Base Spin from Arc (Herculean Boost)
                let spinMag = rawIntensity * (TC.CURVE_SPIN_SCALE !== undefined ? TC.CURVE_SPIN_SCALE : 1000.0);

                // 2. Speed Bonus (Quickness adds RPM)
                const speedBonus = Math.max(1.0, swipeSpeed * (TC.CURVE_SPEED_MULT !== undefined ? TC.CURVE_SPEED_MULT : 1.5));
                spinMag *= speedBonus;

                // Cap (Increased to 1500 for massive arcs)
                spinMag = Math.min((TC.CURVE_SPIN_CAP !== undefined ? TC.CURVE_SPIN_CAP : 1500.0), spinMag);

                // Apply Spin
                // Right Hump (Positive Intensity) -> Left Curve (Positive Spin Y)
                spinVec = new THREE.Vector3(0, spinMag * sign, 0);
                
                if (spinMag > (TC.CURVE_PERFECT_SPIN !== undefined ? TC.CURVE_PERFECT_SPIN : 500.0) && window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("PERFECT CURVE", this.mesh.position, "tech");
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addShake(0.5);
                        window.flux.gameInstance.cameraManager.addRollImpulse(sign * -0.3); // Tilt camera into the curve
                    }
                }
            }

            // Determine Type (Pass vs Shoot)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
            const dotGoal = aimVec.dot(goalDir);

let type = 'PA';
            if (isLob) {
                type = 'LOB';
            } else {
                const distToGoal = Math.abs(this.mesh.position.z - goalZ);
                if (dotGoal > 0.8 && distToGoal < 35.0) {
                    type = 'SH';
                } else if (dotGoal > 0.5 && distToGoal < 20.0) {
                    type = 'SH';
                }
            }

            // Smart Pass Override
            const targetMate = this._findPassTargetInCone(aimVec);
            if (targetMate && type === 'SH') {
                const distMate = this.mesh.position.distanceTo(targetMate.mesh.position);
                if (distMate < 12.0) type = 'PA';
            }

const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
                this.throwBall(ball, type, multiplier, spinVec);
            }

        // NEW: Charge UI methods
        _updateChargeUI(ratio) {
            const meter = document.getElementById('charge-meter-fill');
            if (meter) {
                meter.style.width = `${ratio * 100}%`;
                if (ratio > 0.9) {
                    meter.style.background = 'linear-gradient(90deg, #ff0, #f80)';
                } else if (ratio > 0.5) {
                    meter.style.background = 'linear-gradient(90deg, #0f0, #ff0)';
                } else {
                    meter.style.background = 'linear-gradient(90deg, #0af, #0f0)';
                }
            }
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'block';
        }

        _hideChargeUI() {
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'none';
        }

        setOverrideAim(x, z) {
            if (!this.overrideAimVector) this.overrideAimVector = new THREE.Vector3();
            this.overrideAimVector.set(x, 0, z).normalize();
        }

loseBall(cooldown = 1.0) {
            this.hasBall = false;
            this._hidePassTargetIndicators();
            
            // Enforce cooldown to prevent instant re-grab
            this.catchCooldown = cooldown;
            this.canCatch = false;

            // Safety: Reset states to prevent locking
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();
        }

        update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

updatePhysics(dt) {
            if (!this.mesh) return;

            // Safety: NaN Check
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                console.warn("Player position NaN detected. Resetting.", this.role);
                this.mesh.position.copy(this.homePosition || new THREE.Vector3());
                this.velocity.set(0, 0, 0);
            }
            // SYNC FIX: If ball thinks I hold it, but I don't, force receive
            if (this.ballRef && this.ballRef.holder === this && !this.hasBall) {
                console.warn("Syncing ball possession to player");
                this.receiveBall();
            }

            if (this.isGodMode) {
                this.stats.HP = this.stats.maxHP;
                this.currentEN = this.getStat('EN');
                this.status.venom = 0;
                this.status.nap = 0;
            }

            this._updateStatusLogic(dt);

            // Charge Logic (Physics part - Timer)
            if (this.isCharging) {
                if (!this.hasBall || this.status.nap > 0 || this.stunTimer > 0) {
                    this.isCharging = false;
                    // Reset physics props that might have been altered
                    // Visual reset happens in updateVisuals
                } else {
                    this.chargeTime += dt;
                    // AUTO-RELEASE: If held too long (3s), force release
                    if (this.chargeTime > 3.0) {
                        this.releaseCharge(0, 0); 
                        return;
                    }
                }
            }

if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            if (this.evadeCooldown > 0) this.evadeCooldown -= dt;

            if (this.catchCooldown > 0) {
                this.catchCooldown -= dt;
                if (this.catchCooldown <= 0) this.canCatch = true;
            }

            // Evasion Logic (Spin Move)
            if (this.isEvading) {
                this.evadeTime -= dt;
                
                // Spin visual handled in updateVisuals, but we apply movement here
                // Frictionless movement during evade
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                
                // Slight drag
                this.velocity.multiplyScalar(0.95);

                if (this.evadeTime <= 0) {
                    this.isEvading = false;
                    this.velocity.multiplyScalar(0.5); // Slow down after spin
                }
                return; // Skip normal physics
            }

// Tackle Charge Logic
            if (this.isTackleCharging) {
                this.tackleChargeTime += dt;
                // Auto-release if held too long
                if (this.tackleChargeTime > this.maxTackleChargeTime + 0.5) {
                    this.releaseTackle();
                    return;
                }
            }

            // --- TACKLE STATE (Slide & Commit) ---
            if (this.isTackling) {
                this.tackleTime -= dt;
                
                // Physics: High Drag (Slide to stop)
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (3.0 * dt))); 
                
                _pVec.copy(this.velocity).multiplyScalar(dt);
this.mesh.position.add(_pVec);
                this._applyArenaBoundary(dt);

                // Collision Check
                // Collision Check
                this._checkTackleCollision();
                
if (this._hasHitTackle) {
                    // Successful Hit
                    this.isTackling = false;
                    this.velocity.multiplyScalar(0.1); // Stop momentum
                    this.isRecovering = true;
                    this.recoveryTime = 0.5; // Quick recovery
                } else if (this.tackleTime <= 0) {
                    // Missed Tackle (Whiff)
                    this.isTackling = false;
                    this.isRecovering = true;
                    this.recoveryTime = 1.6; // Punishment (Stumble)
                    this.velocity.multiplyScalar(0.5);
                    this.play('react', 0.2); // Stumble animation
                    
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("MISS", this.mesh.position, "default");
                    }
                }
                return;
            }

            // --- RECOVERY STATE (Stumble/Punishment) ---
            if (this.isRecovering) {
                this.recoveryTime -= dt;
                this.velocity.multiplyScalar(0.9); // Heavy friction
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                
                if (this.recoveryTime <= 0) {
                    this.isRecovering = false;
                    this.play('idle', 0.2);
                }
                return;
            }
            // Dash Logic
            if (this.isDashing) {
                this.dashTime -= dt;
                
                // Smooth Rotation during Dash (Logic affecting transform)
                let diff = this.targetYaw - this.currentYaw;
                while (diff > Math.PI) diff -= Math.PI * 2;
                while (diff < -Math.PI) diff += Math.PI * 2;
                
                const turnSpeed = 15.0; 
                const change = Math.max(-turnSpeed * dt, Math.min(turnSpeed * dt, diff));
                this.currentYaw += change;

                this._checkTackleCollision();
                
if (this.dashTime <= 0) {
                    this.isDashing = false;
                    this.dashType = null;
                    this.tackleChargeBonus = 0; // Reset charge bonus
                } else {
                    if (this.dashType === 'vertical') {
                        _pVec.copy(this.dashVec).multiplyScalar(dt);
_pVec.copy(this.dashVec).multiplyScalar(dt);
                        // Y position calculation is visual/physics hybrid, keeping here for collision consistency
                        // Y position calculation is visual/physics hybrid, keeping here for collision consistency
                        const t = 1 - (this.dashTime / this.dashTotalTime);
                        this.mesh.position.y = Math.sin(t * Math.PI) * 3.0;
                    } else {
                        // Horizontal Dash Movement
                        _pVec.copy(this.velocity).multiplyScalar(dt);
this.mesh.position.add(_pVec);
                        this._applyArenaBoundary(dt);
                        this.mesh.position.y = 0;

                        // Rotation update
                        _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                        // Visual lean is calculated in updateVisuals, but we set base orientation here
                        this.mesh.quaternion.copy(_pQuat);

                        this.velocity.multiplyScalar(0.96);
                    }
                }
                return;
            }

// Orphaned else block removed

            if (this.isThrowing) {
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (2.0 * dt)));
                this._applySoftCollision(dt);
                this._applyGoalCrease(dt);
                _pVec.copy(this.velocity).multiplyScalar(dt);
this.mesh.position.add(_pVec);
                this._applyArenaBoundary(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt); 
            } else {
                this._updatePhysics(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt);
// Vertical Drag (Environment aware)
            const vDrag = (window.flux.BallConfig && window.flux.BallConfig.WATER_DRAG_LINEAR) 
                ? window.flux.BallConfig.WATER_DRAG_LINEAR * 8.0 
                : 2.0;
this.velocity.y *= Math.max(0, 1.0 - (vDrag * dt));
        }
    }
        updateVisuals(dt) {
            if (!this.mesh) return;

            if (this.mixer) {
                this.mixer.update(dt);
            }
            
            this._updateLocomotionAnim(dt); // Animation state logic driven by physics state
            this._updateStatusVisuals(dt);

            // Charge Visuals
            if (this.isCharging) {
                if (this.hasBall && this.status.nap <= 0 && this.stunTimer <= 0) {
                    const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
                    
                    // Levitation
                    const hover = (Math.sin(Date.now() * 0.02) * 0.1) + (ratio * 0.8);
                    const shake = 0.05 + (0.1 * ratio);
                    
                    this.mesh.position.y = hover + (Math.random() - 0.5) * shake;
                    
                    // Visual Jitter
                    this.bankingAmount += (Math.random() - 0.5) * shake;
                    this.pitchAmount += (Math.random() - 0.5) * shake;

                    this.mesh.scale.setScalar(this.baseScale);
                    this._updateChargeUI(ratio);
                } else {
                    // Reset visuals if charge cancelled
                    this.mesh.position.y = 0;
                    this.mesh.scale.setScalar(this.baseScale);
                    this._hideChargeUI();
                }
            }

// Dash Visuals (Particles & Lean)
            if (this.isDashing) {
                this._dashParticleTimer -= dt;
                if (this._dashParticleTimer <= 0) {
                    this._dashParticleTimer = 0.01;
                    if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                        const back = this.velocity.clone().normalize().negate();
                        if (back.lengthSq() < 0.1) back.set(0, 0, 1);
                        for(let i=0; i<2; i++) {
                            const pos = this.mesh.position.clone().add(back.multiplyScalar(0.5));
                            pos.y += 1.0 + (Math.random() - 0.5) * 0.5;
                            pos.x += (Math.random() - 0.5) * 0.5;
                            pos.z += (Math.random() - 0.5) * 0.5;
                            window.flux.gameInstance.particleManager.spawn('dash_stream', pos, { scale: 2.0 + Math.random(), emitterVelocity: this.velocity, momentumScale: 0.1 });
                        }
                    }
                }

                // Visual Lean for Dash
                if (this.dashType === 'horizontal' || this.dashType === 'break' || this.dashType === 'sprint') {
                    const t = 1 - (this.dashTime / this.dashTotalTime);
                    const lean = Math.sin(t * Math.PI);
                    
                    _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                    
                    let pitch = 0, yaw = 0, roll = 0, lungeAmt = 0;
                    if (this.dashType !== 'sprint') {
                         pitch = 1.2 * lean; yaw = 0.8 * lean; roll = -0.6 * lean; lungeAmt = 0.8 * lean;
                    } else {
                         pitch = 0.5 * lean; lungeAmt = 0.2 * lean;
                    }

                    if (lungeAmt > 0) {
                         _pVec.set(0, 0, lungeAmt).applyQuaternion(_pQuat);
                         this.mesh.position.add(_pVec);
                    }

_pEuler.set(pitch, yaw, roll);
                    _pQuat2.setFromEuler(_pEuler);
                    this.mesh.quaternion.multiplyQuaternions(_pQuat, _pQuat2);
                }
            }

            if (this.isEvading) {
                this.mesh.rotation.y += 25.0 * dt;
                
                // Trail
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    if (Math.random() < 0.5) {
                        const pm = window.flux.gameInstance.particleManager;
                        const pos = this.mesh.position.clone();
                        pos.y += 1.0;
                        pos.x += (Math.random()-0.5);
                        pos.z += (Math.random()-0.5);
                        pm.spawn('dash_stream', pos, { scale: 1.0, life: 0.2 });
                    }
                }
            }

// Tackle Charge Visuals
            if (this.isTackleCharging) {
                const ratio = Math.min(this.tackleChargeTime / this.maxTackleChargeTime, 1.0);
                // Shake mesh
// Red tint pulse
                const pulse = Math.sin(Date.now() * 0.02) * 0.5 + 0.5;
                this.originalMaterials.forEach(entry => {
                    entry.material.color.lerpColors(entry.baseColor, new THREE.Color(0xff0000), 0.5 * pulse);
                });

                // HERCULEAN: Gather Particles
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    if (Math.random() < 0.3) { // Density
                        const pm = window.flux.gameInstance.particleManager;
                        // Spawn in a sphere around player
                        const r = 2.0;
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.acos(2 * Math.random() - 1);
                        const x = r * Math.sin(phi) * Math.cos(theta);
                        const y = r * Math.sin(phi) * Math.sin(theta);
                        const z = r * Math.cos(phi);
                        
                        const spawnPos = this.mesh.position.clone().add(new THREE.Vector3(x, y + 1.0, z));
                        const centerPos = this.mesh.position.clone().add(new THREE.Vector3(0, 1.0, 0));
                        
                        // Velocity towards center
                        const vel = centerPos.sub(spawnPos).normalize().multiplyScalar(4.0); // Suck in speed
                        
                        pm.spawn('gather', spawnPos, { 
                            velocity: vel, 
                            life: 0.5, 
                            scale: 1.5,
color: 0xff0000 
                        });
                    }
                }
            } else if (this.isTackling) {
                    // High density trail
                    const pm = window.flux.gameInstance.particleManager;
                    const pos = this.mesh.position.clone();
                    pos.y += 0.8;
                    // Offset slightly behind
                    const back = this.velocity.clone().normalize().negate().multiplyScalar(0.5);
                    pos.add(back);
                    
                    pm.spawn('dash_stream', pos, { 
                        scale: 2.5, 
                        life: 0.3,
                        color: 0xff4400 // Fiery orange trail
                    });
                    
                    // Side streams
                    for(let i=0; i<2; i++) {
                        const sidePos = pos.clone();
                        sidePos.x += (Math.random()-0.5) * 1.5;
                        sidePos.y += (Math.random()-0.5) * 1.0;
                        sidePos.z += (Math.random()-0.5) * 1.5;
                        pm.spawn('dash_stream', sidePos, { 
                            scale: 1.5, 
                            life: 0.2,
                            color: 0xffaa00
                        });
                    }
                }
else if (this.isBlocking) {
                const pulse = Math.sin(Date.now() * 0.02) * 0.5 + 0.5;
                this.originalMaterials.forEach(entry => {
                    entry.material.color.lerpColors(entry.baseColor, new THREE.Color(0x00ffff), 0.5 * pulse);
                });
            } else {
                 // Reset color if not charging/dashing/flashing/blocking
                 this.originalMaterials.forEach(entry => {
                    entry.material.color.copy(entry.baseColor);
                });
            }

            // Stun/Nap Visual Reset
            if (this.status.nap > 0 || this.stunTimer > 0) {
                if (!this._animLocked && this.state !== 'idle' && this.state !== 'catch') this.play('idle', 0.5);
            }

this._updateHPBar(dt);
            this._updateStatusRing(dt); // NEW: Update Ring
            this._updatePassTargetIndicators();
            this._updatePassTargetIndicators();

            // Bubble Trail
            const speedSq = this.velocity.lengthSq();
            if (speedSq > 1.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                this._bubbleTimer -= dt;
                if (this._bubbleTimer <= 0) {
                    const pm = window.flux.gameInstance.particleManager;
                    const backDir = this.velocity.clone().normalize().negate();
                    
                    const offset = backDir.clone().multiplyScalar(0.8);
                    offset.y = 0.5 + Math.random() * 0.5; 
                    offset.x += (Math.random()-0.5) * 0.5;
                    offset.z += (Math.random()-0.5) * 0.5;
                    pm.spawn('bubble', this.mesh.position.clone().add(offset), { 
                        scale: 0.15 + Math.random() * 0.25,
                        emitterVelocity: this.velocity,
                        momentumScale: 0.2
                    });

                    if (speedSq > 40.0) {
                        for(let i=0; i<3; i++) {
                            const mOffset = backDir.clone().multiplyScalar(0.5 + Math.random()*0.5);
                            mOffset.x += (Math.random()-0.5)*0.8;
                            mOffset.y = 0.5 + (Math.random()-0.5)*0.8; 
                            mOffset.z += (Math.random()-0.5)*0.8;
                            pm.spawn('bubble_micro', this.mesh.position.clone().add(mOffset), { 
                                scale: 0.06 + Math.random()*0.08,
                                emitterVelocity: this.velocity,
                                momentumScale: 0.3
                            });
                        }
                        this._bubbleTimer = 0.03; 
} else {
                        this._bubbleTimer = 0.1; 
                    }
                }
            }
            // Swim Sound Effect Logic
            if (speedSq > 2.0 && this.state === 'swim' && !this.isDashing) {
                this._swimSfxTimer -= dt;
                if (this._swimSfxTimer <= 0) {
                    if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                        // Play swim sound with slight pitch variance
                        window.flux.gameInstance.audioManager.playSFX('swim', { volume: 0.3, variance: 0.2 });
                    }
                    // Reset timer (0.4s to 0.7s interval)
                    this._swimSfxTimer = 0.4 + Math.random() * 0.3;
                }
            } else {
                this._swimSfxTimer = 0; // Reset if stopped
            }

            this._applyProceduralPose(dt);
        }
        _applyProceduralPose(dt) {
            // Advance local time (used for subtle sways)
            this._procAnimTime += dt;

            const b = this.bones;
            if (!b) return;

            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;

            let shouldApply = false;

            // Build a desired world-space direction we want the torso/head to bias toward.
            // NOTE: We apply this AFTER the animation mixer has posed bones, as a small additive offset.
            _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();

            if (this.hasBall) {
                // Aim direction (prefer explicit aim vector)
                if (this.overrideAimVector) {
                    _pVec.copy(this.overrideAimVector).normalize();
                } else if (this.lockedAimVector) {
                    _pVec.copy(this.lockedAimVector).normalize();
                } else if (this.inputVector && this.inputVector.lengthSq() > 0.08) {
                    _pVec.copy(this.inputVector).normalize();
                } else {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                }
                shouldApply = true;
            } else if (ball && ball.mesh) {
                // Look at the ball if it's in the "awareness" radius
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 20.0) {
                    _pVec.subVectors(ball.mesh.position, this.mesh.position);
                    shouldApply = true;
                }
            }

            if (!shouldApply) return;

            // Convert the direction into the player's local space so yaw/pitch are stable.
            _pInvQuat.copy(this.mesh.quaternion).invert();
            _pVec.applyQuaternion(_pInvQuat).normalize();

            const lx = _pVec.x, ly = _pVec.y, lz = _pVec.z;
            const yaw = Math.atan2(lx, lz);
            const pitch = Math.atan2(ly, Math.sqrt(lx * lx + lz * lz) + 1e-6);

            const yawC = THREE.MathUtils.clamp(yaw, -0.9, 0.9);
            const pitchC = THREE.MathUtils.clamp(pitch, -0.6, 0.6);

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;
            const aimW = (this.hasBall ? (this.isCharging ? 1.0 : 0.65) : 0.35) * (1.0 - 0.35 * speedNorm);
            const headW = (this.hasBall ? 0.55 : 0.75) * (1.0 - 0.25 * speedNorm);

            // Torso bias (spine/chest)
            if (b.chest) {
                _pTmpEuler.set(-pitchC * 0.20 * aimW, yawC * 0.35 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.chest.quaternion.multiply(_pTmpQuat);
            } else if (b.spine) {
                _pTmpEuler.set(-pitchC * 0.15 * aimW, yawC * 0.25 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.spine.quaternion.multiply(_pTmpQuat);
            }

            // Head/neck look
            if (b.neck) {
                _pTmpEuler.set(-pitchC * 0.25 * headW, yawC * 0.45 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.neck.quaternion.multiply(_pTmpQuat);
            }
            if (b.head) {
                _pTmpEuler.set(-pitchC * 0.30 * headW, yawC * 0.55 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.head.quaternion.multiply(_pTmpQuat);
            }

            // Ball-hold / aim arm pose (keeps "swim" animation but reads as holding/aiming)
            if (this.hasBall && !this.isThrowing && !this._animLocked) {
                const t = this._procAnimTime;
                const lift = THREE.MathUtils.clamp(0.35 + (this.isCharging ? 0.55 : 0.25) - speedNorm * 0.2, 0.15, 0.95);
                const sway = Math.sin(t * 5.0) * 0.05 * (0.5 + lift);

                const raiseX = -0.55 * lift + sway;
                const raiseZ = -0.25 * lift;

                if (b.rUpperArm) {
                    _pTmpEuler.set(raiseX, yawC * 0.10 * lift, raiseZ);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rUpperArm.quaternion.multiply(_pTmpQuat);
                }
                if (b.rForeArm) {
                    _pTmpEuler.set(-0.35 * lift + sway * 0.5, 0, 0);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rForeArm.quaternion.multiply(_pTmpQuat);
                }

                // Counterbalance left arm slightly for a more dynamic silhouette
                if (b.lUpperArm) {
                    _pTmpEuler.set(0.15 * lift, -yawC * 0.05 * lift, 0.15 * lift);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.lUpperArm.quaternion.multiply(_pTmpQuat);
                }
            }
        }

        _updateStatus(dt) {
            this._updateStatusLogic(dt);
            this._updateStatusVisuals(dt);
        }

_updateStatusLogic(dt) {
            // HP Regeneration (When not holding ball and not poisoned)
            if (this.status.venom > 0) {
                this.status.venom -= dt;
                this.stats.HP -= 5 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            } else {
                if (!this.hasBall && this.stats.HP < this.stats.maxHP) {
                    this.stats.HP += 5 * dt;
                    if (this.stats.HP > this.stats.maxHP) this.stats.HP = this.stats.maxHP;
                }
            }

            // EN Regeneration (Stamina)
            // Regenerate if not currently spending it (Dashing/Tackling)
            if (!this.isDashing && !this.isTackling && !this.isEvading && !this.isTackleCharging) {
                const maxEN = this.getStat('EN');
                if (this.currentEN < maxEN) {
                    let regenRate = 10.0; // Fast regen (recover tackle cost in ~0.8s)
                    
                    // Disable regen if struggling (being tackled) to prevent infinite stalling
                    if (this.isEngaged) {
                        regenRate = 0;
                    } else if (this.hasBall) {
                        regenRate = 5.0; // Slower regen while carrying ball
                    }

                    this.currentEN += regenRate * dt;
                    if (this.currentEN > maxEN) this.currentEN = maxEN;
                }
            }

            // HP Drain while holding ball (Fatigue)
            if (this.hasBall) {
                this.stats.HP -= 2.0 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            }

            if (this.status.nap > 0) {
                this.status.nap -= dt;
            }

            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) {
                    this.status.wither[key] -= dt;
                }
            }

            if (this.status.blind > 0) this.status.blind -= dt;
            if (this.status.silence > 0) this.status.silence -= dt;
            if (this.status.shield > 0) this.status.shield -= dt;
            if (this.status.haste > 0) this.status.haste -= dt;
            if (this.status.slow > 0) this.status.slow -= dt;

            if (this.status.burn > 0) {
                this.status.burn -= dt;
                this.stats.HP -= 8.0 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            }

            if (this.status.shock > 0) {
                this.status.shock -= dt;
                if (Math.random() < dt * 1.5) { 
                    this.stunTimer = 0.3;
                    if (window.flux.gameInstance.floatingText)
                         window.flux.gameInstance.floatingText.spawn("BZRT!", this.mesh.position, "damage");
                }
            }

            if (this.elementalInfusion && this.elementalInfusion.duration > 0) {
                this.elementalInfusion.duration -= dt;
                if (this.elementalInfusion.duration <= 0) {
                    this.elementalInfusion = null;
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("INFUSION END", this.mesh.position, "default");
                }
            }
        }

        _updateStatusVisuals(dt) {
            const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;

            if (this.status.venom > 0) {
                this._particleTimers.venom -= dt;
                if (this._particleTimers.venom <= 0 && pm) {
                    pm.spawn('venom', this.mesh.position);
                    this._particleTimers.venom = 0.15;
                }
            }

            if (this.status.nap > 0) {
                this._particleTimers.nap -= dt;
                if (this._particleTimers.nap <= 0 && pm) {
                    pm.spawn('nap', this.mesh.position);
                    this._particleTimers.nap = 0.8;
                }
            }

            let isWithering = false;
            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) isWithering = true;
            }

            if (isWithering) {
                this._particleTimers.wither -= dt;
                if (this._particleTimers.wither <= 0 && pm) {
                    pm.spawn('wither', this.mesh.position);
                    this._particleTimers.wither = 0.2;
                }
            }

            if (this.status.blind > 0) {
                this._particleTimers.blind -= dt;
                if (this._particleTimers.blind <= 0 && pm) {
                    pm.spawn('blind', this.mesh.position);
                    this._particleTimers.blind = 0.3;
                }
            }

            if (this.status.silence > 0) {
                this._particleTimers.silence -= dt;
                if (this._particleTimers.silence <= 0 && pm) {
                    pm.spawn('silence', this.mesh.position);
                    this._particleTimers.silence = 0.5;
                }
            }

            if (this.status.shield > 0) {
                this._particleTimers.shield = (this._particleTimers.shield || 0) - dt;
                if (this._particleTimers.shield <= 0 && pm) {
                    pm.spawn('shield', this.mesh.position);
                    this._particleTimers.shield = 0.4;
                }
            }

            if (this.status.haste > 0) {
                this._particleTimers.haste = (this._particleTimers.haste || 0) - dt;
                if (this._particleTimers.haste <= 0 && pm) {
                    pm.spawn('haste', this.mesh.position);
                    this._particleTimers.haste = 0.2;
                }
            }

            if (this.status.slow > 0) {
                this._particleTimers.slow = (this._particleTimers.slow || 0) - dt;
                if (this._particleTimers.slow <= 0 && pm) {
                    pm.spawn('slow', this.mesh.position);
                    this._particleTimers.slow = 0.4;
                }
            }

            if (this.status.burn > 0) {
                this._particleTimers.burn = (this._particleTimers.burn || 0) - dt;
                if (this._particleTimers.burn <= 0 && pm) {
                    pm.spawn('fire', this.mesh.position);
                    this._particleTimers.burn = 0.15;
                }
            }

            if (this.status.shock > 0) {
                this._particleTimers.shock = (this._particleTimers.shock || 0) - dt;
                if (this._particleTimers.shock <= 0 && pm) {
                    pm.spawn('volt', this.mesh.position);
                    this._particleTimers.shock = 0.2;
                }
            }

            this._updateVisuals(dt);
        }

        _updateVisuals(dt) {
            // --- 1. FLASH EFFECT ---
            let flashRatio = 0;
            if (this.flashTimer > 0) {
                // Use passed dt if available, otherwise assume 16ms (safety)
                const delta = dt || 0.016;
                this.flashTimer -= delta;
                flashRatio = Math.max(0, this.flashTimer / this.flashDuration);
            }

            this.originalMaterials.forEach(entry => {
                if (flashRatio > 0) {
                    // Lerp towards flash color
                    entry.material.color.lerpColors(entry.baseColor, this.flashColor, flashRatio);
                } else {
                    entry.material.color.copy(entry.baseColor);
                }
            });

            // --- 2. PROCEDURAL SQUASH & STRETCH (Spring Physics) ---
            if (this.mesh) {
                const delta = dt || 0.016;
                const stiffness = 200.0;
                const damping = 15.0;
                const target = 1.0;

                // X Axis
                const forceX = (target - this.currentSquash.x) * stiffness;
                this.squashVelocity.x += forceX * delta;
                this.squashVelocity.x *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.x += this.squashVelocity.x * delta;

                // Y Axis
                const forceY = (target - this.currentSquash.y) * stiffness;
                this.squashVelocity.y += forceY * delta;
                this.squashVelocity.y *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.y += this.squashVelocity.y * delta;

                // Z Axis
                const forceZ = (target - this.currentSquash.z) * stiffness;
                this.squashVelocity.z += forceZ * delta;
                this.squashVelocity.z *= Math.max(0, 1.0 - damping * delta);
                this.currentSquash.z += this.squashVelocity.z * delta;

                // Apply to Mesh Scale (Multiplicative with baseScale)
                this.mesh.scale.set(
                    this.baseScale * this.currentSquash.x,
                    this.baseScale * this.currentSquash.y,
                    this.baseScale * this.currentSquash.z
                );
            }
        }

        flash(colorHex, duration) {
            this.flashColor.setHex(colorHex);
            this.flashDuration = duration;
            this.flashTimer = duration;
        }

        squash(x, y, z) {
            this.currentSquash.set(x, y, z);
            // Reset velocity for snap feel
            this.squashVelocity.set(0, 0, 0);
        }

        _createAura() {
            // Aura removed per user request
            this.auraMesh = null;
        }

        // NEW: Pass target indicator (Enhanced Reticle)
        _createPassTargetIndicator() {
            this.passTargetIndicator = new THREE.Group();
            this.scene.add(this.passTargetIndicator);
            this.passTargetIndicator.visible = false;

            // 1. Ground Reticle (Rotating)
            const mat = new THREE.MeshBasicMaterial({
                map: _reticleTexture,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                color: 0x00ff00 // Green for pass
            });
            const geo = new THREE.PlaneGeometry(3.0, 3.0);
            this.reticleMesh = new THREE.Mesh(geo, mat);
            this.reticleMesh.rotation.x = -Math.PI / 2;
            this.passTargetIndicator.add(this.reticleMesh);

            // 2. Vertical Pillar (Light Shaft)
            const pillarGeo = new THREE.CylinderGeometry(1.0, 1.0, 6, 16, 1, true);
            const pillarMat = new THREE.MeshBasicMaterial({
                color: 0x44ff44,
                transparent: true,
                opacity: 0.15,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            this.reticlePillar = new THREE.Mesh(pillarGeo, pillarMat);
            this.reticlePillar.position.y = 3.0;
            this.passTargetIndicator.add(this.reticlePillar);
            
            // 3. Floating Icon (Above Head)
            const iconGeo = new THREE.PlaneGeometry(1.0, 1.0);
            this.reticleIcon = new THREE.Mesh(iconGeo, mat); // Reuse texture
            this.reticleIcon.position.y = 4.5;
            // Billboard behavior handled in update
            this.passTargetIndicator.add(this.reticleIcon);
        }

        _updatePassTargetIndicators() {
            if (!this.hasBall || !this.team) {
                this._hidePassTargetIndicators();
                return;
            }

            // Find best pass target
            const aimDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const target = this._findPassTargetInCone(aimDir);

            if (target && target.mesh) {
                // Smoothly move to target
                const dest = target.mesh.position;
                
                if (this.passTargetIndicator) {
                    this.passTargetIndicator.visible = true;
                    
                    // If distance is large (switched target), snap. Else lerp.
                    const dist = this.passTargetIndicator.position.distanceTo(dest);
                    if (dist > 5.0) {
                        this.passTargetIndicator.position.copy(dest);
                    } else {
                        this.passTargetIndicator.position.lerp(dest, 0.3);
                    }
                    
                    // Keep Y at ground level
                    this.passTargetIndicator.position.y = 0.05;

                    // Animation
                    const time = Date.now() * 0.001;
                    
                    // Spin ground reticle
                    if (this.reticleMesh) {
                        this.reticleMesh.rotation.z = -time * 2.0;
                        const s = 1.0 + Math.sin(time * 5.0) * 0.1;
                        this.reticleMesh.scale.set(s, s, s);
                    }
                    
                    // Pulse pillar
                    if (this.reticlePillar) {
                        this.reticlePillar.material.opacity = 0.1 + Math.sin(time * 8.0) * 0.05;
                        this.reticlePillar.rotation.y = time;
                    }

                    // Billboard Icon
                    if (this.reticleIcon) {
                        if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                            this.reticleIcon.lookAt(window.flux.gameInstance.camera.position);
                        }
                        this.reticleIcon.rotation.z = time * 3.0; // Spin icon
                    }
                }
            } else {
                this._hidePassTargetIndicators();
            }
        }

        _hidePassTargetIndicators() {
            if (this.passTargetIndicator) {
                this.passTargetIndicator.visible = false;
            }
        }

_applyArenaBoundary(dt) {
            const C = window.flux.BallConfig || {};
            const radius = C.BOUNDARY_RADIUS || 46.0;
            const heightLimit = C.BOUNDARY_HEIGHT || 20.0;
            
            const pos = this.mesh.position;
            const distSq = pos.x * pos.x + pos.z * pos.z;
            
            // Radial Boundary (Sphere/Cylinder walls)
            if (distSq > radius * radius) {
                const dist = Math.sqrt(distSq);
                const penetration = dist - radius;
                
                // Direction back to center
                const nx = -pos.x / dist;
                const nz = -pos.z / dist;
                
                // Spring Force (Hooke's Law) - "Suck back" effect
                // Softened to allow "stretching" out of bounds
                const k = 30.0; // Was 150.0 - Much softer spring
                const force = penetration * k;
                
                // Apply acceleration
                this.velocity.x += nx * force * dt;
                this.velocity.z += nz * force * dt;
                
                // Damping (Drag) to prevent infinite oscillation
                // Reduced damping to allow momentum to carry player deeper into the "wall"
                const damping = 1.0 - Math.min(1.0, 3.0 * dt); // Was 8.0
                this.velocity.x *= damping;
                this.velocity.z *= damping;
                
                // Visuals: Trigger Arena Distortion
                if (window.flux.triggerArenaImpact) {
                    // Impact point on the boundary surface
                    _pVec.set(pos.x, pos.y, pos.z).normalize().multiplyScalar(radius);
                    
                    // Intensity based on penetration depth - Boosted for visual "stretch"
                    const intensity = Math.min(penetration * 5.0 + this.velocity.length() * 0.1, 25.0);
                    window.flux.triggerArenaImpact(_pVec, intensity);

                    // --- NEW: Boundary Breach FX (Suck-back distortion) ---
                    if (penetration > 0.5 && window.flux.gameInstance) {
                        const game = window.flux.gameInstance;
                        
                        // 1. Camera Distortion (Aberration + Shake)
                        if (game.cameraManager) {
                            // Glitch effect scales with penetration
                            game.cameraManager.addAberration(penetration * 0.2); 
                            if (penetration > 2.0) game.cameraManager.addShake(penetration * 0.05);
                        }

                        // 2. Particles (Water displacement)
                        if (game.particleManager && Math.random() < 0.3) {
                            // Shockwave on the wall
                            game.particleManager.spawn('shockwave', _pVec, { 
                                scale: 3.0 + penetration, 
                                life: 0.3,
                                color: 0xaaffff 
                            });
                            
                            // "Suck back" bubbles moving inward violently
                            const inwardVel = new THREE.Vector3(nx, 0, nz).multiplyScalar(10.0 + penetration * 3.0);
                            inwardVel.y = (Math.random() - 0.5) * 5.0; // Vertical splash
                            
                            game.particleManager.spawn('bubble', _pVec, {
                                velocity: inwardVel,
                                scale: 0.4 + Math.random() * 0.4,
                                life: 0.6,
                                color: 0xffffff
                            });
                        }
                    }
                }
            }
            
            // Vertical Boundary
            if (Math.abs(pos.y) > heightLimit) {
                const sign = Math.sign(pos.y);
                const penetration = Math.abs(pos.y) - heightLimit;
                
                // Spring back - Softened
                this.velocity.y -= sign * penetration * 30.0 * dt; // Was 150.0
                this.velocity.y *= Math.max(0, 1.0 - (3.0 * dt)); // Was 8.0
                
                // Visuals
                if (window.flux.triggerArenaImpact) {
                    _pVec.copy(pos);
                    _pVec.y = sign * heightLimit;
                    window.flux.triggerArenaImpact(_pVec, penetration * 5.0);

                    // --- NEW: Vertical Breach FX ---
                    if (penetration > 0.5 && window.flux.gameInstance) {
                        const game = window.flux.gameInstance;
                        if (game.cameraManager) game.cameraManager.addAberration(penetration * 0.2);
                        
                        if (game.particleManager && Math.random() < 0.3) {
                            game.particleManager.spawn('shockwave', _pVec, { scale: 3.0 + penetration, life: 0.3 });
                            // Splash inward
                            const inwardVel = new THREE.Vector3((Math.random()-0.5)*5, -sign * 10.0, (Math.random()-0.5)*5);
                            game.particleManager.spawn('bubble', _pVec, { velocity: inwardVel, scale: 0.5, life: 0.5 });
                        }
                    }
                }
            }
        }

        _applySoftCollision(dt) {
            const game = window.flux.gameInstance;
            if (!this.mesh || !game || !game.teams) return;

            const teams = [game.teams.home, game.teams.away];
            const repulsionRadius = 0.5; // Reduced to 0.5 to fix invisible wall issues
            const stiffness = 15.0;

            teams.forEach(team => {
                if (!team) return;
                team.players.forEach(other => {
                    if (other === this || !other.mesh) return;

                    const dx = this.mesh.position.x - other.mesh.position.x;
                    const dy = this.mesh.position.y - other.mesh.position.y;
                    const dz = this.mesh.position.z - other.mesh.position.z;

                    const distSq = dx*dx + dy*dy + dz*dz;
                    const minDist = repulsionRadius * 2.0;

                    if (distSq < minDist * minDist && distSq > 0.0001) {
                        const dist = Math.sqrt(distSq);
                        const overlap = minDist - dist;

                        const force = overlap * stiffness;

                        const nx = dx / dist;
                        const ny = dy / dist;
                        const nz = dz / dist;

                        this.velocity.x += nx * force * dt;
                        this.velocity.y += ny * force * dt;
                        this.velocity.z += nz * force * dt;
                    }
                });
            });
        }

        _updatePhysics(dt) {
            this._applySoftCollision(dt);
            this._applyGoalCrease(dt);

            const inputLenSq = this.inputVector.lengthSq();
            const isInputActive = inputLenSq > 0.01;

            let currentMaxSpeed = this.maxSpeed;
            
            // STRUGGLE STATE: Hinder movement based on pressure
            // Instead of a binary 0.8 multiplier, we scale based on intensity.
            // Max struggle (1.0) reduces speed to 40%.
            if (this.struggleIntensity > 0) {
                currentMaxSpeed *= (1.0 - (this.struggleIntensity * 0.6));
            } else if (this.isEngaged) {
                // Fallback slight reduction if engaged but low pressure
                currentMaxSpeed *= 0.9;
            }
            
if (this.isCharging || this.isTackleCharging || this.isBlocking) currentMaxSpeed *= 0.4; // Slow down when charging/blocking
            
            // Haste / Slow
            if (this.status.haste > 0) currentMaxSpeed *= 1.5;
            if (this.status.slow > 0) currentMaxSpeed *= 0.5;

            if (isInputActive) {
                _pVec.copy(this.inputVector).normalize();

                // Apply Struggle Jitter to direction
                // Simulates wrestling for control
                if (this.struggleIntensity > 0.3) {
                    const jitter = (Math.random() - 0.5) * this.struggleIntensity * 0.8;
                    _pVec.x += jitter;
                    _pVec.z += jitter;
                    _pVec.normalize();
                }

                const targetVelX = _pVec.x * currentMaxSpeed;
                const targetVelZ = _pVec.z * currentMaxSpeed;

                const currentSpeed = this.velocity.length();
                const speedRatio = Math.min(1.0, currentSpeed / this.maxSpeed);

                // Agility is reduced when struggling
                let agility = THREE.MathUtils.lerp(10.0, 2.0, speedRatio);
                if (this.struggleIntensity > 0) agility *= 0.5;

                const t = 1.0 - Math.pow(0.01, dt * agility);

                this.velocity.x += (targetVelX - this.velocity.x) * t;
                this.velocity.z += (targetVelZ - this.velocity.z) * t;

            } else {
                const brakeFactor = 2.0;
                const t = 1.0 - Math.pow(0.1, dt * brakeFactor);

                this.velocity.x += (0 - this.velocity.x) * t;
                this.velocity.z += (0 - this.velocity.z) * t;

                if (this.velocity.lengthSq() < 0.01) {
                    this.velocity.set(0, this.velocity.y, 0);
                }
            }

            this.velocity.y *= Math.max(0, 1.0 - (2.0 * dt));

            _pVec.copy(this.velocity).multiplyScalar(dt);
this.mesh.position.add(_pVec);
        }

        _updateVerticality(dt) {


            let targetY = 0;

            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            if (ball && ball.mesh && !this.hasBall) {
                const distToBall = this.mesh.position.distanceTo(ball.mesh.position);
                if (distToBall < 15.0) {
                    targetY = ball.mesh.position.y;
                }
            }

            if (this.hasBall) {
                targetY = 0.5;
            }

            const yDiff = targetY - this.mesh.position.y;

            const lift = yDiff * 10.0 * dt;
            this.velocity.y += lift;

            if (this.mesh.position.y > 8.0) {
                this.mesh.position.y = 8.0;
                this.velocity.y *= -0.5;
            } else if (this.mesh.position.y < -8.0) {
                this.mesh.position.y = -8.0;
                this.velocity.y *= -0.5;
            }
        }

        // FIXED: Improved banking with hysteresis to prevent facing flips
        _updateBanking(dt) {
            const inputLenSq = this.inputVector.lengthSq();
            const velLenSq = this.velocity.lengthSq();

            let targetYaw = this.targetYaw;
            let shouldUpdateYaw = false;

            // PRIORITY 1: Explicit Aim (Aim Stick / Swipe)
            if (this.overrideAimVector) {
                targetYaw = Math.atan2(this.overrideAimVector.x, this.overrideAimVector.z);
                shouldUpdateYaw = true;
            }
            // PRIORITY 2: Movement Input
            else if (inputLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.inputVector.x, this.inputVector.z);
                shouldUpdateYaw = true;
            } 
            // PRIORITY 3: Velocity (Drifting)
            else if (velLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.velocity.x, this.velocity.z);
                shouldUpdateYaw = true;
            }

            // If we should update, do so. Otherwise keep last valid yaw
            if (shouldUpdateYaw) {
                this.lastValidYaw = targetYaw;
            } else {
                targetYaw = this.lastValidYaw;
            }

            // Smooth Yaw with wrap-around handling
            let diff = targetYaw - this.currentYaw;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;

            const speedRatio = Math.min(1.0, this.velocity.length() / this.maxSpeed);
            const turnSpeed = THREE.MathUtils.lerp(8.0, 4.0, speedRatio); // Reduced from 12.0/6.0 to reduce flipping

            // Prevent sudden snaps when diff is very large (teleport/reset scenarios)
            const maxYawChange = Math.PI * dt * turnSpeed;
            const yawChange = Math.max(-maxYawChange, Math.min(maxYawChange, diff * dt * turnSpeed));

            this.currentYaw += yawChange;
            this.targetYaw = targetYaw;

            // Banking
            const bankSensitivity = 0.8;
            const maxBank = 0.75;

            let targetBank = -diff * bankSensitivity;
            targetBank = Math.max(-maxBank, Math.min(maxBank, targetBank));

            const bankLerp = 1.0 - Math.pow(0.02, dt);
            this.bankingAmount += (targetBank - this.bankingAmount) * bankLerp;

            // Pitch
            const pitchSensitivity = 0.1;
            const maxPitch = 1.0;

            let targetPitch = -this.velocity.y * pitchSensitivity;
            targetPitch = Math.max(-maxPitch, Math.min(maxPitch, targetPitch));

            const pitchLerp = 1.0 - Math.pow(0.05, dt);
            this.pitchAmount += (targetPitch - this.pitchAmount) * pitchLerp;

            // Apply Rotation
            const finalYaw = this.currentYaw + this.rotationOffset;

            this.mesh.quaternion.setFromAxisAngle(_pAxisY, finalYaw);

            _pQuat.setFromAxisAngle(new THREE.Vector3(1, 0, 0), this.pitchAmount);
            this.mesh.quaternion.multiply(_pQuat);

            _pQuat.setFromAxisAngle(new THREE.Vector3(0, 0, 1), this.bankingAmount);
            this.mesh.quaternion.multiply(_pQuat);

            // Idle Bob
            if (velLenSq < 0.1 && !this.isEngaged) {
                const time = Date.now() * 0.0015;
                const bobPitch = Math.sin(time) * 0.03;
                const bobRoll = Math.cos(time * 0.7) * 0.02;

                _pEuler.set(bobPitch, 0, bobRoll);
                _pQuat.setFromEuler(_pEuler);
                this.mesh.quaternion.multiply(_pQuat);
            }
        }

        _checkTacklePressure(dt) {
            this.struggleIntensity = 0;
            
            if (!this.hasBall) {
                this.isEngaged = false;
                this.encounterTimer = 0;
                return;
            }

            if (this.immunityTimer > 0) return;
            if (this.isDashing) return;

            const game = window.flux.gameInstance;
if (!game || !game.teams || !this.team) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];
            if (!opponentTeam) return;

            let totalPressure = 0;
            let engagedCount = 0;
            const effectiveRadius = this.tackleRadius; 

            // Forward vector for shielding check
            _pVec.copy(_pAxisZ).applyQuaternion(this.mesh.quaternion); 

            for (const entity of opponentTeam.players) {
                if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(entity.mesh.position);
                if (dist < effectiveRadius) {
                    engagedCount++;
                    
                    // Calculate Pressure Intensity (0 to 1 based on distance)
                    const proximity = 1.0 - (dist / effectiveRadius);
                    
                    // Base Pressure from AT stat
                    let pressure = entity.getStat('AT') * proximity;

                    // Directional Shielding (Continuous)
                    const toOpp = entity.mesh.position.clone().sub(this.mesh.position).normalize();
                    const dot = _pVec.dot(toOpp);
                    
                    // If opponent is BEHIND (dot < -0.2), pressure is reduced (Shielding)
                    let isShielded = false;
                    if (dot < -0.2) {
                        pressure *= 0.5;
                        isShielded = true;
                    }

                    // Tech Modifiers (Continuous application chance)
                    if (entity.techs.tackle === 'venom') {
                        if (Math.random() < dt * 0.5) this.applyStatus('venom', 5.0);
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'wither') {
                        if (Math.random() < dt * 0.5) this.applyStatus('wither', 5.0, 'EN');
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'drain') {
                        const drainAmt = pressure * dt * 0.5;
                        this.stats.HP -= drainAmt;
                        entity.stats.HP += drainAmt;
                    }

                    totalPressure += pressure;

                    // Visuals: Sparks occasionally based on pressure
                    if (Math.random() < dt * 4.0 * proximity) { 
                         if (game.spawnClash) {
                            const mid = this.mesh.position.clone().lerp(entity.mesh.position, 0.5);
                            mid.y += 1.0;
                            game.spawnClash(mid, 0.5);
                        }
                    }
                }
            }

            this.isEngaged = (engagedCount > 0);

            if (this.isEngaged) {
                this.encounterTimer += dt;

                // Apply EN Drain (Continuous)
                // Scaling: 20 AT pressure -> approx 10 EN lost per second
                const drainRate = totalPressure * 0.5; 
                this.currentEN -= drainRate * dt;
                
                // Update Struggle Intensity for Physics (0.0 to 1.0)
                // Max struggle at roughly 30 pressure
                this.struggleIntensity = Math.min(1.0, totalPressure / 30.0);

                // Visual Feedback for Drain (Accumulate to avoid spam)
                this._accumulatedDamage += drainRate * dt;
                if (this._accumulatedDamage > 5.0) {
                    if (game.floatingText) {
                        game.floatingText.spawn(`-${Math.floor(this._accumulatedDamage)}`, this.mesh.position, "damage");
                    }
                    this._accumulatedDamage = 0;
                }
                
                // Hint for player if engaged too long
                if (this.encounterTimer > 1.0 && this.encounterTimer < 1.1 && this.team.isHuman && this.team.activePlayer === this) {
                     if (game.floatingText) game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
            } else {
                this.encounterTimer = 0;
            }

            if (this.currentEN <= 0) {
                this.fumble();
            }
        }

        _performJechtKnockback() {
            if (!this.team) return;
            const game = window.flux.gameInstance;
            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            const range = 6.0;
            const force = 25.0;

            if (game.floatingText) {
                game.floatingText.spawn("JECHT SHOT!", this.mesh.position, "goal");
            }

            opponentTeam.players.forEach(p => {
                if (!p.mesh) return;
                const dist = this.mesh.position.distanceTo(p.mesh.position);
                if (dist < range) {
                    const dir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                    dir.y = 0.5;
                    dir.normalize();

                    p.velocity.add(dir.multiplyScalar(force));

                    p.stunTimer = 2.0; // Ensure they stay down
                    p.isDashing = false;
                    const reactAction = p.actions && p.actions['react'];
                    if (reactAction) {
                        reactAction.setLoop(THREE.LoopOnce);
                        reactAction.clampWhenFinished = true;
                        p.playOneShot('react', 0.1);
                    } else {
                        p.play('catch', 0.5);
                    }

                    if (game.floatingText) {
                        game.floatingText.spawn("SMACK!", p.mesh.position, "damage");
                    }
                    if (game.triggerImpact) game.triggerImpact(0.15, 'shatter');
                }
            });
        }

        fumble() {
            console.log("FUMBLE! EN Depleted.");
            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("CRASH!", this.mesh.position, "comic-impact");
            }

            this.stunTimer = 1.5;

            const backDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize().negate();
            backDir.x += (Math.random() - 0.5) * 0.5;
            backDir.z += (Math.random() - 0.5) * 0.5;
            backDir.normalize();

            this.velocity.add(backDir.multiplyScalar(12.0));

            if (this.hasBall) {
                const ball = window.flux.gameInstance.entities.ball;
                if (ball) {
                    const ejectDir = new THREE.Vector3(Math.random()-0.5, 0.8, Math.random()-0.5).normalize();
                    ball.shoot(ejectDir, 6.0, 'none');
                    this.loseBall();
// Duplicate removed
                    this.currentEN = 0;
                }
            }
        }

        dash(x, z) {
            if (this.isDashing || this.dashCooldown > 0) return;
            if (this.status.nap > 0) return;

            // OFFENSE: BREAK TACKLE
            if (this.hasBall && this.isEngaged) {
                const cost = 15;

                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("FAILED!", this.mesh.position, "damage");
                    }
                    this.fumble();
                    return;
                }

this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.5;
                this.dashType = 'break';

                _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                this.velocity.add(_pVec.multiplyScalar(10.0)); // Nerfed from 15.0 for realism

                const game = window.flux.gameInstance;
                const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
                const opponentTeam = game.teams[opponentTeamId];

                opponentTeam.players.forEach(p => {
                    if (!p.mesh) return;
                    const dist = this.mesh.position.distanceTo(p.mesh.position);
                    if (dist < this.tackleRadius * 1.5) {
                        const pushDir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                        pushDir.y = 0.5;
                        p.velocity.add(pushDir.multiplyScalar(15.0));

                        p.stunTimer = 2.0;
                        p.play('catch', 0.2);

                        if (game.floatingText) {
                            game.floatingText.spawn("STUN!", p.mesh.position, "damage");
                        }
                    }
                });

                if (game.floatingText) {
                    game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
                
                // NEW: Spawn Break Glyph (Explosive Burst)
                if (game.glyphManager) {
                    game.glyphManager.spawn('status', this.mesh.position, {
                        parent: this,
                        life: 0.5,
                        rotationSpeed: 8.0,
                        scaleSpeed: 3.0,
                        offsetY: 0.5
                    });
                }
                
                // Particle Burst (Break Tackle)
                if (game.particleManager) {
                    for(let i=0; i<30; i++) {
                        game.particleManager.spawn('flash', this.mesh.position, { scale: 2.5 });
                        // Bubble Burst
                        const bubblePos = this.mesh.position.clone().add(new THREE.Vector3((Math.random()-0.5)*2, (Math.random()-0.5)*2, (Math.random()-0.5)*2));
                        game.particleManager.spawn('bubble', bubblePos, { scale: 0.2 + Math.random() * 0.4 });
                    }
                }

                if (game.triggerImpact) game.triggerImpact(0.15, 'heavy');

                return;
            }
            // OFFENSE: SPRINT
            if (this.hasBall) {
                const cost = 5;
                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                    }
                    return;
                }

this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.0;
                this.dashType = 'sprint';

                const burstDir = this.velocity.clone().normalize();
                if (burstDir.lengthSq() < 0.1) burstDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);

                this.velocity.add(burstDir.multiplyScalar(12.0)); // Nerfed from 15.0
                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(20);
                }
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("DASH!", this.mesh.position, "tech");
                }
                return;
            }

            // DEFENSE: BLOCK / TACKLE
// DEFENSE: BLOCK / TACKLE
            let isBlockContext = false;
            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;
            if (ball && ball.mesh) {
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 8.0 && ball.mesh.position.y > 2.5) {
                    isBlockContext = true;
                }
            }
this.isDashing = true;
            this.dashTime = this.dashTotalTime;
            this.dashCooldown = 2.0;

            const len = Math.sqrt(x*x + z*z);
            const nx = (len > 0) ? x/len : 0;
            const nz = (len > 0) ? z/len : 0;

            if (len > 0) {
                // Smooth turn for dash instead of snap
                this.targetYaw = Math.atan2(nx, nz);
            }
            if (isBlockContext) {
                this.dashType = 'vertical';

                const dirToBall = ball.mesh.position.clone().sub(this.mesh.position);
                dirToBall.y = 0;

                if (dirToBall.lengthSq() > 0.01) {
                    dirToBall.normalize();
                    this.dashVec.copy(dirToBall).multiplyScalar(8.0);
                } else {
                    this.dashVec.set(0, 0, 0);
                }

                const catchAction = this.actions['catch'];
                if (catchAction) {
                    catchAction.setLoop(THREE.LoopOnce);
                    catchAction.clampWhenFinished = true;
                    catchAction.timeScale = 1.5;
                }
                this.play('catch', 0.1);

                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "default");
                }

            } else {
                this.dashType = 'horizontal';
                this._hasHitTackle = false;

                // Apply velocity impulse in dash direction
                _pVec.set(nx, 0, nz);
                if (_pVec.lengthSq() < 0.1) {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                }
                this.velocity.add(_pVec.multiplyScalar(14.0)); // Nerfed from 20.0

                const lungeAction = this.actions['throw'];
                if (lungeAction) {
                    lungeAction.setLoop(THREE.LoopOnce);
                    lungeAction.clampWhenFinished = true;
                    lungeAction.timeScale = 2.0;
                }
                this.play('throw', 0.1);

                // JUICE: Stretch on Dash
                this.squash(0.7, 1.4, 0.7);

                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.05, 'default');
            }

            if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addFovImpulse(10);
                window.flux.gameInstance.cameraManager.addShake(0.3); 
                
                // Dash Recoil (Kickback)
                const dashDir = this.velocity.clone().normalize();
                window.flux.gameInstance.cameraManager.addRecoil(-dashDir.x * 1.5, -0.5, -dashDir.z * 1.5);
            }
            // Dash Effect
            if (window.flux.gameInstance.particleManager) {
                const dashPos = this.mesh.position.clone();
                dashPos.y += 1.0;
                window.flux.gameInstance.particleManager.spawn('shockwave', dashPos, { scale: 1.5, life: 0.3 });
                // Speed lines
                const back = this.velocity.clone().normalize().negate();
                for(let i=0; i<3; i++) {
                    const p = dashPos.clone().add(back.multiplyScalar(Math.random()));
                    p.x += (Math.random()-0.5);
                    window.flux.gameInstance.particleManager.spawn('dash_stream', p, { scale: 1.5 });
                }
            }
        }

_createHPBar() {
            // Holographic HP Bar Shader with Juice (Shake & Flash)
            const geometry = new THREE.PlaneGeometry(1.4, 0.18);
            
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uFill: { value: 1.0 },
                    uColor: { value: new THREE.Color(0x00ff00) },
                    uTime: { value: 0.0 },
                    uOpacity: { value: 0.9 },
                    uShake: { value: 0.0 },
                    uFlash: { value: 0.0 }
                },
                vertexShader: `
                    uniform float uTime;
                    uniform float uShake;
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        vec3 pos = position;
                        
                        // Juice: Shake Effect
                        if (uShake > 0.001) {
                            float t = uTime * 30.0;
                            pos.x += sin(t) * uShake;
                            pos.y += cos(t * 0.8) * uShake;
                        }
                        
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uFill;
                    uniform vec3 uColor;
                    uniform float uTime;
                    uniform float uOpacity;
                    uniform float uFlash;
                    varying vec2 vUv;

                    void main() {
                        // Frame dimensions (UV space)
                        float borderY = 0.15;
                        float borderX = 0.02;
                        
                        // Inner content mask
                        float inY = step(borderY, vUv.y) * step(vUv.y, 1.0 - borderY);
                        float inX = step(borderX, vUv.x) * step(vUv.x, 1.0 - borderX);
                        float contentMask = inY * inX;

                        // Background (Tech Grid)
                        vec3 bgCol = vec3(0.0, 0.1, 0.2);
                        float grid = step(0.9, fract(vUv.x * 20.0 + vUv.y * 10.0)) * 0.2;
                        bgCol += grid;

                        // Fill Logic
                        float fillMask = step(vUv.x, uFill) * contentMask;

                        // Energy Pulse Pattern
                        float pulse = sin(vUv.x * 10.0 - uTime * 3.0) * 0.5 + 0.5;
                        vec3 barCol = mix(uColor, uColor + vec3(0.4), pulse * 0.6);

                        // Hot Edge
                        float edge = smoothstep(uFill - 0.05, uFill, vUv.x) * fillMask;
                        barCol += vec3(1.0) * edge;

                        // Scanline (Hologram effect)
                        float scan = sin(vUv.y * 80.0 + uTime * 5.0) * 0.05;
                        
                        // Border Glow
                        float borderMask = (1.0 - contentMask);
                        vec3 borderCol = vec3(0.0, 0.6, 1.0) * 0.6; // Cyan tech border

                        // Compose
                        vec3 finalCol = mix(bgCol, barCol, fillMask);
                        finalCol = mix(finalCol, borderCol, borderMask);
                        finalCol += scan;

                        // Juice: Flash (Damage/Impact)
                        if (uFlash > 0.001) {
                            finalCol = mix(finalCol, vec3(1.0, 1.0, 1.0), uFlash);
                        }

                        // Opacity
                        float alpha = uOpacity;
                        // Fade background areas slightly
                        if (fillMask < 0.5 && borderMask < 0.5) alpha *= 0.5;

                        gl_FragColor = vec4(finalCol, alpha);
                    }
                `,
                transparent: true,
                depthTest: false, // Render on top
                depthWrite: false,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending
            });

            this.hpBar = new THREE.Mesh(geometry, material);
            this.hpBar.renderOrder = 900; // Ensure it renders above most things
            this.scene.add(this.hpBar);
        }

_createStatusRing() {
            // Compact Aesthetic Ring (2.0 size)
            const geometry = new THREE.PlaneGeometry(2.0, 2.0);
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uHP: { value: 1.0 },
                    uEN: { value: 1.0 },
                    uTime: { value: 0.0 },
                    uColor: { value: new THREE.Color(0x00ffff) },
                    uOpacity: { value: 0.0 }
                },
                vertexShader: `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uHP;
                    uniform float uEN;
                    uniform float uTime;
                    uniform vec3 uColor;
                    uniform float uOpacity;
                    varying vec2 vUv;
                    #define PI 3.14159265359

                    void main() {
                        vec2 center = vec2(0.5);
                        vec2 p = vUv - center;
                        float dist = length(p);
                        
                        // Config: Compact Ring
                        float rMain = 0.35;
                        float wMain = 0.03; // Thinner bars
                        
                        float alpha = 0.0;
                        vec3 color = vec3(0.0);
                        
                        // 1. Background Track (Dark)
                        float bgRing = 1.0 - smoothstep(wMain, wMain + 0.01, abs(dist - rMain));
                        
                        // Gap at top/bottom (center axis)
                        float gap = smoothstep(0.0, 0.05, abs(p.x)); 
                        
                        if (bgRing > 0.1) {
                            color = vec3(0.0, 0.05, 0.1); // Dark backing
                            alpha = 0.3 * gap;
                            
                            // Vertical progress: Bottom (-0.35) to Top (0.35)
                            float fillPos = (p.y + rMain) / (rMain * 2.0); 
                            
                            // Left Side: HP (Green -> Red)
                            if (p.x < 0.0) {
                                if (fillPos < uHP) {
                                    vec3 hpCol = mix(vec3(1.0, 0.0, 0.0), vec3(0.0, 1.0, 0.4), smoothstep(0.2, 0.5, uHP));
                                    if (uHP < 0.3) hpCol += sin(uTime * 20.0) * 0.3; // Pulse warning
                                    color = hpCol;
                                    alpha = 0.9 * gap;
                                    // Tip glow
                                    if (fillPos > uHP - 0.05) color += vec3(0.4);
                                }
                            } 
                            // Right Side: EN (Gold)
                            else {
                                if (fillPos < uEN) {
                                    color = vec3(1.0, 0.8, 0.0);
                                    alpha = 0.9 * gap;
                                    if (fillPos > uEN - 0.05) color += vec3(0.4);
                                }
                            }
                        }
                        
                        // 2. Outer Team Indicator (Thin pulsing ring)
                        float rTeam = 0.45;
                        float wTeam = 0.008;
                        float teamRing = 1.0 - smoothstep(wTeam, wTeam + 0.005, abs(dist - rTeam));
                        
                        if (teamRing > 0.1) {
                            float angle = atan(p.y, p.x);
                            float seg = sin(angle * 3.0 + uTime * 2.0); // Rotating segments
                            if (seg > 0.0) {
                                color = uColor;
                                alpha = 0.6;
                            } else {
                                color = uColor * 0.2;
                                alpha = 0.2;
                            }
                        }

                        gl_FragColor = vec4(color, alpha * uOpacity);
                    }
                `,
                transparent: true,
                depthWrite: false,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending
            });
            
            this.statusRing = new THREE.Mesh(geometry, material);
            this.statusRing.rotation.x = -Math.PI / 2;
            this.statusRing.renderOrder = 10; // Above floor
            this.scene.add(this.statusRing);
        }

        _updateStatusRing(dt) {
            if (!this.statusRing) return;
            
            // Visibility Logic
            let targetOpacity = 0.0;
            const game = window.flux.gameInstance;
            
            if (game && (game.state === 'active' || game.gameMode === 'practice')) {
                // Find the player currently controlled by the human (Home Active Player)
                const activeP = (game.teams.home && game.teams.home.isHuman) ? game.teams.home.activePlayer : null;
                
                // 1. Always show for ME (Active Player)
                if (this === activeP) {
                    targetOpacity = 1.0;
                }
                // 2. Always show for BALL CARRIER (Friend or Foe)
                else if (this.hasBall) {
                    targetOpacity = 1.0;
                }
                // 3. Show for anyone in PROXIMITY to Active Player
                else if (activeP && activeP.mesh) {
                    const dist = this.mesh.position.distanceTo(activeP.mesh.position);
                    const range = 25.0;
                    if (dist < range) {
                        // Fade out as they get further away
                        targetOpacity = Math.max(0.0, 1.0 - (dist / range));
                        // Clamp min opacity for visibility if reasonably close
                        if (dist < 15.0) targetOpacity = Math.max(0.3, targetOpacity);
                    }
                }
            }
            
            // Smooth Opacity Transition
            const cur = this.statusRing.material.uniforms.uOpacity.value;
            const lerpSpeed = 5.0;
            this.statusRing.material.uniforms.uOpacity.value += (targetOpacity - cur) * dt * lerpSpeed;
            
            // Optimization: Hide if invisible
            if (this.statusRing.material.uniforms.uOpacity.value < 0.01) {
                this.statusRing.visible = false;
                return;
            }
            this.statusRing.visible = true;
            
            // Update Transforms
            this.statusRing.position.copy(this.mesh.position);
            this.statusRing.position.y = 0.05; // Just above floor
            
            // Rotate to match player facing (Yaw only) so bars stay relative to player orientation
            // Left is always Player's Left
            this.statusRing.rotation.z = -(this.currentYaw + this.rotationOffset);
            
            // Update Uniforms
            const mat = this.statusRing.material;
            mat.uniforms.uTime.value += dt;
            
            // Stats
            mat.uniforms.uHP.value = this.stats.HP / this.stats.maxHP;
            const maxEN = this.stats.EN || 1;
            mat.uniforms.uEN.value = this.currentEN / maxEN;
            
            // Team Color
            if (this.team) {
                mat.uniforms.uColor.value.setHex(this.team.color);
            }
        }

        _updateHPBar(dt = 0.016) {
            if (!this.hpBar || !this.mesh) return;

            // Visibility Check: Only show if mesh is visible AND in Active/Practice states
            if (!this.mesh.visible) {
                this.hpBar.visible = false;
                return;
            }

            const game = window.flux.gameInstance;
            const allowedState = game && (game.state === 'active' || game.state === 'kickoff' || game.gameMode === 'practice');
            
            if (!allowedState) {
                this.hpBar.visible = false;
                return;
            }
            this.hpBar.position.copy(this.mesh.position);
            this.hpBar.position.y += 2.2;

            if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                this.hpBar.lookAt(window.flux.gameInstance.camera.position);
            }

            // --- JUICE: Damage Reaction ---
            // Initialize _lastHP if undefined (first run)
            if (this._lastHP === undefined) this._lastHP = this.stats.HP;

            const delta = this._lastHP - this.stats.HP;
            if (delta > 0.1) {
                // HP Decreased
                if (this.isThrowing || this.isCharging) {
                    // Voluntary exertion (Ability cost) -> Small Flash
                    this.hpFlash = Math.min(this.hpFlash + 0.4, 0.6);
                } else {
                    // Involuntary damage (Venom, Drain, etc) -> Shake + Flash
                    this.hpShake = Math.min(this.hpShake + 0.05, 0.15);
                    this.hpFlash = 1.0;
                }
            }
            this._lastHP = this.stats.HP;

            // Decay FX
            this.hpShake *= Math.max(0, 1.0 - dt * 8.0);
            this.hpFlash *= Math.max(0, 1.0 - dt * 5.0);

            const pct = Math.max(0, this.stats.HP / this.stats.maxHP);
            
            // Update Shader Uniforms
            const mat = this.hpBar.material;
            if (mat.uniforms) {
                mat.uniforms.uFill.value = pct;
                mat.uniforms.uTime.value += dt;
                mat.uniforms.uShake.value = this.hpShake;
                mat.uniforms.uFlash.value = this.hpFlash;
                
                const col = mat.uniforms.uColor.value;
                if (pct > 0.5) col.setHex(0x00ff00);
                else if (pct > 0.25) col.setHex(0xffff00);
                else col.setHex(0xff0000);
            }

            // Hide if full HP to reduce clutter, unless in practice mode
            // NEW: Also hide if status ring is fully visible (opacity > 0.8) to avoid redundancy
            const ringVisible = this.statusRing && this.statusRing.material.uniforms.uOpacity.value > 0.8;
            const alwaysShow = game && game.gameMode === 'practice';
            
            this.hpBar.visible = ((pct < 0.98 || alwaysShow || this.hpFlash > 0.1) && !ringVisible);
        }

        gainExp(amount) {
            if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            this.exp += amount;

            if (this.exp >= this.nextLevelExp) {
                this.levelUp();
            }
        }

        levelUp() {
            this.level++;
            this.exp -= this.nextLevelExp;
            this.nextLevelExp = Math.floor(this.nextLevelExp * 1.5);

            const keys = ['HP', 'EN', 'AT', 'PA', 'BL', 'SH', 'CA', 'SP'];

            const hpGain = Math.floor(Math.random() * 20) + 10;
            this.stats.maxHP += hpGain;
            this.stats.HP = this.stats.maxHP;

            keys.forEach(k => {
                if (k === 'HP') return;
                if (Math.random() > 0.4) {
                    const gain = Math.floor(Math.random() * 2) + 1;
                    this.stats[k] += gain;
                }
            });

            this._updateDerivedStats();

            console.log(`${this.role} reached Level ${this.level}!`);

            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("LEVEL UP!", this.mesh.position, "tech");
            }
        }

_checkTackleCollision() {
            if (!this.team || this._hasHitTackle) return;

            const game = window.flux.gameInstance;
            if (!game) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            // Use velocity as tackle direction (since tackle imparts velocity)
            // Fallback to facing if velocity is negligible
            let tackleDir = this.velocity.clone();
            tackleDir.y = 0;
            if (tackleDir.lengthSq() < 0.1) {
                tackleDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            }
            tackleDir.normalize();

            for (const opp of opponentTeam.players) {
                if (!opp.mesh) continue;
                
                // Vector to opponent
                const toOpp = opp.mesh.position.clone().sub(this.mesh.position);
                toOpp.y = 0; // Ignore height difference for hit detection cylinder
                
                const dist = toOpp.length();

                const reach = 4.5; // Increased reach (was 3.5)

                if (dist < reach) {
                    toOpp.normalize();
                    const dot = tackleDir.dot(toOpp);
                    
                    // Cone Check: Widened to ~60 degrees (dot > 0.5)
                    // Was 0.7 (~45 deg). This makes landing tackles easier.
                    if (dot > 0.5) {
                        // Calculate Impact Quality (0.0 to 1.0)
                        // 1.0 = Dead center hit, 0.0 = Glancing blow at edge of cone
                        let quality = (dot - 0.5) / 0.5; 
                        quality = Math.max(0, Math.min(1, quality));
                        
                        this._resolveTackleHit(opp, quality);
                        this._hasHitTackle = true;
                        return; // Only hit one target per tackle frame
                    }
                }
            }
        }

_resolveTackleHit(opp, quality) {
            this.play('idle', 0.2); // Stop tackle animation
            
            const isCleanHit = quality > 0.6; // Threshold for "Clean Hit"
            
            // JUICE: Impact Flash & Squash (Attacker)
            this.flash(0xffffff, 0.15);
            this.squash(1.2, 0.8, 1.2); // Impact compression

            // HERCULEAN IMPACT FX
            if (isCleanHit) {
                // 1. Freeze Frame (Impact Stop)
                if (window.flux.gameInstance.triggerImpact) {
                    window.flux.gameInstance.triggerImpact(0.25, 'shatter'); // Heavy freeze
                }
                
                // 2. Camera Zoom Snap & Aberration
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-20); // Zoom IN
                    window.flux.gameInstance.cameraManager.addShake(3.0);
                    window.flux.gameInstance.cameraManager.addAberration(15.0); // Massive glitch
                }

                // 3. Directional Debris (Cone behind victim)
                if (window.flux.gameInstance.particleManager) {
                    const pm = window.flux.gameInstance.particleManager;
                    const impactPos = opp.mesh.position.clone().add(new THREE.Vector3(0, 1, 0));
                    const tackleDir = this.velocity.clone().normalize();
                    
                    // Shockwave
                    pm.spawn('shockwave', impactPos, { scale: 6.0, life: 0.4, color: 0xffffff });
                    pm.spawn('flash', impactPos, { scale: 5.0 });

                    // Debris Cone
for(let i=0; i<8; i++) { // Reduced from 15
                        const debrisDir = tackleDir.clone();
                        // Spread
                        debrisDir.x += (Math.random()-0.5) * 1.5;
                        debrisDir.y += (Math.random()) * 1.0; // Upward bias
                        debrisDir.z += (Math.random()-0.5) * 1.5;
                        debrisDir.normalize().multiplyScalar(10.0 + Math.random() * 10.0);
                        
pm.spawn('impact_shard', impactPos, {
                            velocity: debrisDir,
                            life: 0.8 + Math.random() * 0.5,
                            scale: 0.5 + Math.random() * 0.5,
                            gravity: 25.0,
                            drag: 1.0,
                            rotationSpeed: (Math.random() - 0.5) * 15.0,
                            frame: Math.floor(Math.random() * 4)
                        });
                    }
                }
            } else {
                // Glancing Hit FX
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            if (window.flux.gameInstance.audioManager) {
                // Pitch shift based on quality (Higher pitch = cleaner hit)
                window.flux.gameInstance.audioManager.playSFX('tackle', { rate: 0.8 + quality * 0.4 });
                if (isCleanHit) {
                    window.flux.gameInstance.audioManager.playSFX('impact', { volume: 1.0, rate: 0.5 }); // Deep boom
                }
            }

            let damage = this.getStat('AT');
            if (isCleanHit) damage *= 1.5;

            if (opp.hasBall) {
                // SHIELD CHECK
                let fumbleChance = isCleanHit ? 1.0 : 0.3; // Glancing hits rarely cause fumbles unless EN depleted
                
                if (opp.status.shield > 0) {
                    damage *= 0.5;
                    fumbleChance = 0.0; // Shield prevents fumble
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SHIELDED", opp.mesh.position, "block");
                    }
                }

                opp.currentEN -= damage;

                if (window.flux.gameInstance.floatingText) {
                    const label = isCleanHit ? "CRITICAL!" : "GLANCING";
                    const style = isCleanHit ? "comic-impact" : "default";
                    
                    window.flux.gameInstance.floatingText.spawn(`${Math.floor(damage)}`, opp.mesh.position, "damage");
                    // Delay label slightly for readability
                    setTimeout(() => {
                        if(window.flux.gameInstance.floatingText) 
                            window.flux.gameInstance.floatingText.spawn(label, opp.mesh.position, style);
                    }, 100);
                }

                if (opp.currentEN <= 0 && Math.random() < fumbleChance) {
                    opp.fumble();
                } else {
                    // Stun logic: Clean hits stun longer
                    opp.stunTimer = isCleanHit ? 1.0 : 0.3;
                    opp.playOneShot('react', 0.1);

                    // JUICE: Impact Flash & Squash (Victim)
                    opp.flash(0xff0000, isCleanHit ? 0.3 : 0.1); 
                    opp.squash(1.3, 0.6, 1.3); 
                }

                if (this.techs.tackle && window.flux.gameInstance.triggerTechEvent && isCleanHit) {
                    window.flux.gameInstance.triggerTechEvent(this, this.techs.tackle);
                }

            } else {
                // Hit player without ball
                opp.stunTimer = isCleanHit ? 1.5 : 0.5;
                opp.flash(0xffaa00, 0.2);
                opp.squash(1.2, 0.7, 1.2);
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn(isCleanHit ? "SMACK!" : "BUMP", opp.mesh.position, "comic-impact");
                }
            }

            // Physics Knockback
            const pushDir = opp.mesh.position.clone().sub(this.mesh.position).normalize();
            pushDir.y = 0.2;
            const knockbackForce = isCleanHit ? 18.0 : 8.0;
            opp.velocity.add(pushDir.multiplyScalar(knockbackForce));

            // Camera Shake & Impact
            if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addShake(isCleanHit ? 1.5 : 0.5);
            }
            if (window.flux.gameInstance.triggerImpact) {
                window.flux.gameInstance.triggerImpact(isCleanHit ? 0.15 : 0.05, isCleanHit ? 'heavy' : 'default');
            }
            
            // Particles
            if (window.flux.gameInstance.spawnClash) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                window.flux.gameInstance.spawnClash(mid, quality);
            }
            
            if (window.flux.gameInstance.particleManager) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                const impactVel = this.velocity.clone().multiplyScalar(0.5);
                
                const count = isCleanHit ? 30 : 10;
                for(let i=0; i<count; i++) {
                    const bubblePos = mid.clone().add(new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5));
                    window.flux.gameInstance.particleManager.spawn('bubble', bubblePos, { 
                        scale: 0.15 + Math.random() * 0.35,
                        emitterVelocity: impactVel,
                        momentumScale: 0.5
                    });
                }
                
                if (isCleanHit) {
                    window.flux.gameInstance.particleManager.spawn('shockwave', mid, { scale: 3.0 });
                }
            }
        }

        _applyGoalCrease(dt) {
            const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goals = [
                new THREE.Vector3(0, 0, goalDist),
                new THREE.Vector3(0, 0, -goalDist)
            ];

            const radius = 10.0;

            goals.forEach(goal => {
                const dx = this.mesh.position.x - goal.x;
                const dz = this.mesh.position.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < radius * radius) {
                    const dist = Math.sqrt(distSq);
                    const pushX = dist > 0 ? dx / dist : 1;
                    const pushZ = dist > 0 ? dz / dist : 0;

                    const force = 50.0;
                    this.velocity.x += pushX * force * dt;
                    this.velocity.z += pushZ * force * dt;

                    if (dist < radius - 0.5) {
                        const clampRatio = radius / (dist + 0.001);
                        this.mesh.position.x = goal.x + dx * clampRatio;
                        this.mesh.position.z = goal.z + dz * clampRatio;
                    }
                }
});
        }

evade() {
            if (this.isEvading || this.isDashing || this.evadeCooldown > 0 || this.status.nap > 0 || this.stunTimer > 0) return;
            
            const cost = 10;
            if (this.currentEN < cost) {
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                 return;
            }
            this.currentEN -= cost;

this.isEvading = true;
            this.evadeTime = 0.4;
            this.evadeCooldown = 2.0;
            this.immunityTimer = 0.5; // Invulnerability frames

            const game = window.flux.gameInstance;

            // --- PERFECT DODGE CHECK ---
            let isPerfect = false;
            if (game && this.team) {
                const oppTeamId = this.team.id === 'home' ? 'away' : 'home';
                const oppTeam = game.teams[oppTeamId];
                if (oppTeam) {
                    for (const opp of oppTeam.players) {
                        // Check if opponent is dashing (tackling) and close
                        if (opp.isDashing && opp.mesh) {
                            const dist = this.mesh.position.distanceTo(opp.mesh.position);
                            // 5.0 is slightly larger than tackle radius (3.0), creating a window
                            if (dist < 5.0) { 
                                isPerfect = true;
                                break;
                            }
                        }
                    }
                }
            }

            if (isPerfect) {
                // 1. Refund & Bonus
                this.currentEN = Math.min(this.stats.EN, this.currentEN + cost + 10);
                
                // 2. Visuals
                if (game.floatingText) {
                    game.floatingText.spawn("PERFECT!", this.mesh.position, "tech");
                }
                
                // 3. Tech Flash Overlay
                if (game.ui && game.ui.techFlash) {
                    const tf = game.ui.techFlash;
                    tf.style.display = 'flex';
                    const txt = tf.querySelector('.tech-text');
                    const sub = tf.querySelector('.tech-sub-text');
                    if (txt) txt.innerText = "PERFECT DODGE";
                    if (sub) sub.innerText = this.role;
                    tf.style.background = "linear-gradient(90deg, rgba(0,0,0,0), rgba(0, 255, 255, 0.6), rgba(0,0,0,0))";
                    
                    // Auto-hide
                    setTimeout(() => { tf.style.display = 'none'; }, 800);
                }

                // 4. Matrix Time Slow
                const originalTimeScale = window.flux.timeScale || 0.8;
                window.flux.timeScale = 0.1; // Slow motion
                
                // Restore time after 800ms real-time
                setTimeout(() => {
                    window.flux.timeScale = originalTimeScale;
                }, 800);

                // 5. Camera Juice
                if (game.cameraManager) {
                    game.cameraManager.addFovImpulse(-10); // Zoom snap
                    game.cameraManager.addShake(0.5);
                }
                
                // 6. SFX
                if (game.audioManager) {
                    game.audioManager.playSFX('dash', { rate: 0.5, volume: 1.2 }); // Deep whoosh
                }

                // 7. Particle Burst
                if (game.particleManager) {
                    game.particleManager.spawn('shockwave', this.mesh.position, { scale: 3.0, life: 0.5 });
                    game.particleManager.spawn('flash', this.mesh.position, { scale: 2.0 });
                }

            } else {
                // Normal Evade
                if (game.audioManager) game.audioManager.playSFX('dash', { rate: 1.5 });
                if (game.floatingText) game.floatingText.spawn("EVADE!", this.mesh.position, "tech");
            }

            // Momentum Shift: Add velocity perpendicular to current facing or input
            const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const right = new THREE.Vector3(1, 0, 0).applyQuaternion(this.mesh.quaternion);
            
            // Determine dodge direction based on input
            let dodgeDir = right.clone();
            
            // Randomize direction
            if (Math.random() > 0.5) dodgeDir.negate();
            
            this.velocity.add(dodgeDir.multiplyScalar(12.0)); // Boosted speed
            this.velocity.add(fwd.multiplyScalar(4.0)); // Slight forward momentum
        }

startTackleCharge() {
            if (this.hasBall || this.isDashing || this.isEvading || this.isTackling || this.isRecovering || this.status.nap > 0 || this.stunTimer > 0 || this.isTackleCharging) return;
            
            this.isTackleCharging = true;
            this.tackleChargeTime = 0;
            
            // Visual feedback
            if (window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: 2.0,
                    scale: 0.5,
                    offsetY: 0.1
                });
            }
        }

        releaseTackle() {
            if (!this.isTackleCharging) return;
            this.isTackleCharging = false;
            
            const ratio = Math.min(this.tackleChargeTime / this.maxTackleChargeTime, 1.0);
            this.tackleChargeBonus = ratio;
            
            // Calculate direction based on input
            let dx = this.inputVector.x;
            let dz = this.inputVector.z;
            
            // If no input, tackle forward
            if (Math.abs(dx) < 0.1 && Math.abs(dz) < 0.1) {
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                dx = fwd.x;
                dz = fwd.z;
            }
            
            this.startTackle(dx, dz);
            
            // If high charge, add extra juice
            if (ratio > 0.8) {
                 if (window.flux.gameInstance.cameraManager) window.flux.gameInstance.cameraManager.addShake(0.5);
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("MAX TACKLE!", this.mesh.position, "comic-impact");
                 if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('tackle', { rate: 0.8 });
            }
        }

startTackle(dx, dz) {
            if (this.isTackling || this.isRecovering || this.isDashing || this.status.nap > 0 || this.stunTimer > 0) return;

            const cost = 8; // Reduced from 15 to encourage aggression
            if (this.currentEN < cost) {
                 if (window.flux.gameInstance.floatingText) window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                 return;
            }
            this.currentEN -= cost;
            this.isTackling = true;
            this.tackleTime = 0.5; // Slide duration
            this._hasHitTackle = false;
            
            // Calculate Direction
            _pVec.set(dx, 0, dz);
            if (_pVec.lengthSq() < 0.1) {
                _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            }
            _pVec.normalize();

            // Lock Rotation (Commitment)
            const targetAngle = Math.atan2(_pVec.x, _pVec.z);
            this.currentYaw = targetAngle - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.mesh.quaternion.setFromAxisAngle(_pAxisY, targetAngle);

            // Initial Impulse (High Velocity)
            const speed = 25.0; 
            this.velocity.copy(_pVec).multiplyScalar(speed);
            
            // Animation (Reuse throw lunge for now, looks like a shoulder barge)
            this.play('throw', 0.1); 
            
            // Visuals
            if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');
            if (window.flux.gameInstance.particleManager) {
                 const pos = this.mesh.position.clone();
                 pos.y = 0.5;
                 window.flux.gameInstance.particleManager.spawn('shockwave', pos, { scale: 1.5 });
            }
        }

        startBlock() {
            if (this.hasBall || this.isDashing || this.isEvading || this.status.nap > 0 || this.stunTimer > 0) return;
            this.isBlocking = true;
            // Use 'catch' animation for block stance
            this.play('catch', 0.2);
        }

        stopBlock() {
            if (this.isBlocking) {
                this.isBlocking = false;
                this.play('idle', 0.2);
            }
        }
    }

// Export to global scope
    window.flux.Player = Player;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Formation Definitions (Coordinates for Side 1: Defends +Z, Attacks -Z)
    // X: Left(-)/Right(+), Z: Forward(-)/Back(+)
    const FORMATIONS = {
        'Normal': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -10, z: -10 }, 'RF': { x: 10, z: -10 }
        },
        'Center Attack': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -4, z: -15 }, 'RF': { x: 4, z: -15 }
        },
        'Right Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: 0, z: 15 }, 'RD': { x: 12, z: 15 },
            'MF': { x: 10, z: 5 },
            'LF': { x: 5, z: -10 }, 'RF': { x: 15, z: -10 }
        },
        'Left Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -12, z: 15 }, 'RD': { x: 0, z: 15 },
            'MF': { x: -10, z: 5 },
            'LF': { x: -15, z: -10 }, 'RF': { x: -5, z: -10 }
        },
        'All-Out Defense': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -6, z: 20 }, 'RD': { x: 6, z: 20 },
            'MF': { x: 0, z: 10 },
            'LF': { x: -10, z: 5 }, 'RF': { x: 10, z: 5 }
        },
        'Flat Line': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 0 }, 'RD': { x: 8, z: 0 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -15, z: 0 }, 'RF': { x: 15, z: 0 }
        },
        'Counter': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 20 }, 'RD': { x: 8, z: 20 },
            'MF': { x: 0, z: 15 },
            'LF': { x: -12, z: -20 }, 'RF': { x: 12, z: -20 }
        },
        'Double Sides': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -18, z: 15 }, 'RD': { x: 18, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -18, z: -10 }, 'RF': { x: 18, z: -10 }
        }
    };



    // --- Enemy Indicator (Red Arrow Sprite) ---
    // Shared texture/material so we don't create 6 canvases.
const _enemyArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64;
        c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ff0000';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

const _playerArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#00ff00'; // Green
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _teammateArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ffffff'; // White
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _enemyArrowMaterial = new THREE.SpriteMaterial({ map: _enemyArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _playerArrowMaterial = new THREE.SpriteMaterial({ map: _playerArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _teammateArrowMaterial = new THREE.SpriteMaterial({ map: _teammateArrowTexture, transparent: true, depthTest: false, depthWrite: false });
class Team {
        /**
         * Generates and applies stats to a player based on role and level.
         * Centralizes balancing to ensure high-level play feels distinct.
         */
        static generateStats(player, role, level = 1, isHuman = false) {
            // 1. Define Role Baselines (Level 1)
            // Balanced to be weak but functional at Level 1
            const base = {
                HP: 100, SP: 55, EN: 10, AT: 5, PA: 5, BL: 5, SH: 5, CA: 5
            };

            // Role Specializations
            switch(role) {
                case 'LF': case 'RF': // Strikers
                    base.SH += 10; base.SP += 5; base.EN += 5;
                    break;
                case 'MF': // Playmakers
                    base.PA += 10; base.AT += 8; base.EN += 8; base.SP += 2;
                    break;
case 'LD': case 'RD': // Defenders
                    base.AT += 12; base.BL += 10; base.PA += 5; base.EN += 15; // Boost EN for tackling
                    break;
                case 'GL': // Goalie
                    base.CA += 10; base.SP += 5; base.PA += 15; // Strong arm
                    break;
            }

            // 2. Scaling Factors (Per Level)
            // Designed so Level 50 is "God Tier" and Level 1 is "Rookie"
            const growth = {
                HP: 15,    // +1500 HP at Lvl 99
                SP: 0.5,   // +50 SP at Lvl 99 (Speed demon)
                Primary: 0.8, // +80 Stat at Lvl 99
                Secondary: 0.5 // +50 Stat at Lvl 99
            };

            // Helper to scale
            const scale = (val, rate) => Math.floor(val + ((level - 1) * rate));

            // Apply Scaling
            player.stats.HP = scale(base.HP, growth.HP);
            
            // SP: Cap at 99, but ensure high levels feel FAST
            player.stats.SP = Math.min(99, scale(base.SP, growth.SP));

            // Stat distribution based on role priorities
            if (['LF', 'RF'].includes(role)) {
                player.stats.SH = Math.min(99, scale(base.SH, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Secondary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (role === 'MF') {
                player.stats.PA = Math.min(99, scale(base.PA, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.SH = Math.min(99, scale(base.SH, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (['LD', 'RD'].includes(role)) {
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.2)); // Defenders bad at shooting
            } else if (role === 'GL') {
                player.stats.CA = Math.min(99, scale(base.CA, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.3));
            }

            // 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
// 3. Human Player Bonus (The "Hero" Feel)
// 3. Human Player Bonus (The "Hero" Feel)
            if (isHuman) {
                player.stats.HP += 300; // Tankier (was 150)
                player.stats.SP += 8;   // Faster (was 5)
                player.stats.EN += 10;   // Harder to tackle (was 5)
                
                // Key Stat Boost
                if (role === 'LF' || role === 'RF') player.stats.SH += 5;
                if (role === 'MF') player.stats.PA += 5;
                if (role === 'LD' || role === 'RD') player.stats.AT += 5;
                if (role === 'GL') player.stats.CA += 5;
            }

            // 4. Finalize
            player.stats.maxHP = player.stats.HP;
            player.level = level;
            player._updateDerivedStats();
        }

constructor(scene, id, side, color, isHuman) {
            this.scene = scene;
            this.id = id; // 'home' or 'away'
            this.side = side; // 1 (Defends +Z) or -1 (Defends -Z)
            this.color = color;
            this.isHuman = isHuman;
            this.aiEnabled = true; // Master switch for AI logic
            
            this.players = [];
            this.activePlayer = null; // The player currently controlled/focused
            
            // Formation Anchors
this.currentFormation = 'Normal';

            // Auto-Switch Smoothing
            this.lastSwitchTime = 0;
            this.switchCooldown = 0.5; // Seconds before auto-switch can happen again
            // Player Indicator (Green Arrow)
            if (this.isHuman) {
                this.playerArrow = new THREE.Sprite(_playerArrowMaterial);
                this.playerArrow.scale.set(0.8, 0.8, 1.0);
                this.playerArrow.renderOrder = 1000; // On top
            }
        }

        assignMarks(opposingTeam) {
            // Simple auto-assign logic: Mark the player in the "matching" position
            // LF<->RD, RF<->LD, MF<->MF, LD<->RF, RD<->LF, GL<->LF
            this.players.forEach(p => {
                let targetRole = 'MF';
                switch (p.role) {
                    case 'LF': targetRole = 'RD'; break;
                    case 'RF': targetRole = 'LD'; break;
                    case 'MF': targetRole = 'MF'; break;
                    case 'LD': targetRole = 'RF'; break;
                    case 'RD': targetRole = 'LF'; break;
                    case 'GL': targetRole = 'LF'; break;
                }

                const target = opposingTeam.players.find(op => op.role === targetRole);
                if (target) {
                    p.marking = target;
                    // console.log(`${this.id} ${p.role} marked ${target.role}`);
                }
            });
        }

        addPlayer(player) {
            this.players.push(player);
            player.team = this;

            // Calculate Home Position based on Formation
            this._updatePlayerHomePosition(player);

            // Enemy indicator: red arrows over the Away team (so enemies are readable)
// Enemy indicator: red arrows over the Away team
            if (this.id === 'away' && player.mesh) {
                const arrow = new THREE.Sprite(_enemyArrowMaterial);
                arrow.scale.set(0.8, 0.8, 1.0);
                arrow.position.set(0, 3.2, 0); // above head
                arrow.renderOrder = 999;
                player.mesh.add(arrow);
                player.enemyArrow = arrow;
            }

            // Teammate indicator: White arrows for inactive humans
            if (this.isHuman && player.mesh) {
                const arrow = new THREE.Sprite(_teammateArrowMaterial);
                arrow.scale.set(0.6, 0.6, 1.0);
                arrow.position.set(0, 3.2, 0);
                arrow.renderOrder = 999;
                arrow.visible = false; // Hidden by default, managed by setActivePlayer
                player.mesh.add(arrow);
                player.teammateArrow = arrow;
            }
        }

        setFormation(name) {
            if (!FORMATIONS[name]) return;
            this.currentFormation = name;
            // console.log(`Team ${this.id} switched to ${name}`);
            
            this.players.forEach(p => {
                this._updatePlayerHomePosition(p);
            });
        }

_updatePlayerHomePosition(player) {
            const data = FORMATIONS[this.currentFormation];
            if (!data) return;

            const offset = data[player.role];
            if (offset) {
// X Position:
                // Formations: -X is Left, +X is Right.
                // Home Team (Side 1) faces -Z. Left is -X. Use offset.x as is.
                let xPos = offset.x;
                let zPos = offset.z * this.side;

                player.homePosition.set(xPos, 0, zPos);
                
                // Away Team (Side -1) faces +Z. Left is +X. Flip X.
                if (this.side === -1) {
                    player.homePosition.x *= -1; 
                }
            }
            
            // Set initial position
            if (player.mesh) {
                player.mesh.position.copy(player.homePosition);
                // Face center (0,0,0)
                player.mesh.lookAt(0, 0, 0);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updatePhysics) {
                    this.players[i].updatePhysics(dt);
                } else {
                    // Fallback if not split yet
                    this.players[i].update(dt);
                }
            }
            if (this.isHuman) {
                this.updateActivePlayerSelection();
            }
        }

        updateVisuals(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updateVisuals) {
                    this.players[i].updateVisuals(dt);
                }
            }
        }

updateActivePlayerSelection() {
            const ball = window.flux.gameInstance.entities.ball;
            if (!ball || !ball.mesh) return;

            // 1. OFFENSE: If we have the ball, active player MUST be the holder
            if (ball.holder && ball.holder.team === this) {
                if (this.activePlayer !== ball.holder) {
                    this.setActivePlayer(ball.holder);
                }
                return;
            }

            // 2. DEFENSE: Smart Switching
            
            // Cooldown check (Time in seconds)
            const now = Date.now() / 1000;
            if (now - this.lastSwitchTime < this.switchCooldown) return;

            // Action Locking: Don't switch if current player is committing to an action
            if (this.activePlayer) {
                const p = this.activePlayer;
                // If dashing, charging a tackle, evading, or in the middle of a tackle animation
                if (p.isDashing || p.isTackleCharging || p.isEvading || p.isTackling || p.isRecovering) {
                    return;
                }
            }

            let bestCandidate = this.activePlayer;
            let bestScore = Infinity;
            
            // Hysteresis: The current player gets a "virtual distance reduction"
            // This means a new candidate must be significantly closer to override the current one.
            const hysteresis = 5.0; // 5 meters stickiness

            for (const p of this.players) {
                if (p.role === 'GL') continue; // Don't auto-switch to goalie
                if (!p.mesh) continue;
                
                // Don't switch to incapacitated players
                if (p.status.nap > 0 || p.stunTimer > 0) continue;

                const dist = p.mesh.position.distanceTo(ball.mesh.position);
                
                let score = dist;

                // Apply bias to current player
                if (p === this.activePlayer) {
                    score -= hysteresis;
                }

                if (score < bestScore) {
                    bestScore = score;
                    bestCandidate = p;
                }
            }

            if (bestCandidate && bestCandidate !== this.activePlayer) {
                this.setActivePlayer(bestCandidate);
                this.lastSwitchTime = now;
            }
        }

setActivePlayer(player) {
            // Reset input on previous
            if (this.activePlayer) {
                this.activePlayer.setInput(0, 0);
            }
            this.activePlayer = player;

            // Visual Indicators
            if (this.isHuman) {
                // 1. Green Arrow for Active
                if (this.playerArrow && player.mesh) {
                    player.mesh.add(this.playerArrow);
                    this.playerArrow.position.set(0, 3.5, 0); // Float above head
                }

                // 2. White Arrows for Others
                this.players.forEach(p => {
                    if (p.teammateArrow) {
                        p.teammateArrow.visible = (p !== player);
                    }
                });
            }
        }

resetPositions() {
            for (const p of this.players) {
                if (p.mesh) {
                    p.mesh.position.copy(p.homePosition);
                    
                    // Reset Physics
                    p.velocity.set(0, 0, 0);
                    p.inputVector.set(0, 0, 0);
                    p.isDashing = false;
                    p.isThrowing = false;
p.loseBall(); // Drop ball if holding
                    p.canCatch = true; // Force reset capability
                    
                    // Reset Stats
                    p.currentEN = p.stats.EN;
                    
// Orientation: Face Center
                    p.mesh.lookAt(0, 0, 0);
                    if (p.syncRotation) p.syncRotation();
                    
                    // Reset Animation
                    p.play('idle', 0.1);
                }
            }
            // Reset active player to MF
            const mf = this.players.find(p => p.role === 'MF');
            if (mf) this.setActivePlayer(mf);
        }
    }

    window.flux.Team = Team;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors
    const _aiVec = new THREE.Vector3();
    const _targetPos = new THREE.Vector3();
    const _scanDir = new THREE.Vector3();
    const _scanToOpp = new THREE.Vector3();
    const _tempVec1 = new THREE.Vector3();
    const _tempVec2 = new THREE.Vector3();

class AIPlayer extends (window.flux.Player || class {}) {
        constructor(scene, role) {
            super(scene, role);
            this.ballRef = null;
            
            // Stats are managed by Team/Main or default Player values.
            this._updateDerivedStats();

            // State Machine
// State Machine
            this.aiState = 'IDLE';
            this.decisionTimer = 0;
this.decisionInterval = 0.15; // Snappier decisions (was 0.25)

            // Stuck Detection
            this.stuckTimer = 0;
            this.lastStuckPos = new THREE.Vector3();
            this.stuckCheckTimer = 0;
            // --- PERCEPTION SYSTEM (Reaction Time) ---
            this.perceivedTargetPos = new THREE.Vector3();
            this.reactionSpeed = 1.5; 
            this.anticipationTime = 0.2; 
            
            // Role Config
            this.isForward = ['LF', 'RF'].includes(role);
            this.isMidfielder = role === 'MF';
            this.isDefender = ['LD', 'RD'].includes(role);

            this.techImmunityTimer = 0;
            this._assignDefaultTechs();
        }

        _assignDefaultTechs() {
            const tackleTechs = ['venom', 'wither', 'drain'];
            const shootTechs = ['venom', 'sphere', 'invisible'];
            const passTechs = ['venom', 'wither', 'nap'];
            const passiveTechs = ['brawler', 'elite_defense'];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const chance = (prob) => Math.random() < prob;

            if (this.isDefender) {
                if (chance(0.3)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.pass = pick(passTechs);
                if (chance(0.2)) this.techs.passive = pick(passiveTechs);
            } else if (this.isMidfielder) {
                if (chance(0.2)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.2)) this.techs.pass = pick(passTechs);
                if (chance(0.1)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            } else if (this.isForward) {
                if (chance(0.3)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

updatePhysics(dt) {
            // Safety: Auto-link ball if missing
            if (!this.ballRef && window.flux.gameInstance && window.flux.gameInstance.entities) {
                this.ballRef = window.flux.gameInstance.entities.ball;
            }

            const game = window.flux.gameInstance;
            const isPractice = game && game.gameMode === 'practice';
            const isActive = game && game.state === 'active';
            
            if (!isActive && !isPractice) {
                this.setInput(0, 0);
                super.updatePhysics(dt);
                return;
            }

            const isDemo = game && game.isDemoMode;
            const isIncapacitated = (this.stunTimer > 0) || (this.status.nap > 0);
            const isHumanTeam = this.team && this.team.isHuman;
            const isActivePlayer = this.team && (this.team.activePlayer === this);
            const shouldRunAI = (!isHumanTeam || isDemo || (isHumanTeam && !isActivePlayer));
            const isTeamAIEnabled = this.team ? this.team.aiEnabled : true;

            if (isIncapacitated) {
                this.setInput(0, 0);
                this.stuckTimer = 0; // Reset stuck if stunned
            } else if (shouldRunAI && isTeamAIEnabled) {
                // --- STUCK DETECTION ---
                this.stuckCheckTimer += dt;
                if (this.stuckCheckTimer > 0.5) {
                    this.stuckCheckTimer = 0;
                    const dist = this.mesh.position.distanceTo(this.lastStuckPos);
                    // If trying to move (input active) but moved very little
                    if (dist < 0.5 && this.inputVector.lengthSq() > 0.1) {
                        this.stuckTimer += 0.5;
                    } else {
                        this.stuckTimer = 0;
                    }
                    this.lastStuckPos.copy(this.mesh.position);
                }

                // Perception Update
                if (this.ballRef && this.ballRef.mesh) {
                    let realTarget = this.ballRef.mesh.position.clone();
                    if (this.ballRef.holder && this.ballRef.holder.mesh) {
                        realTarget = this.ballRef.holder.mesh.position.clone();
                        if (this.ballRef.holder.velocity) {
                            realTarget.addScaledVector(this.ballRef.holder.velocity, this.anticipationTime);
                        }
                    } else if (this.ballRef.velocity) {
                        realTarget.addScaledVector(this.ballRef.velocity, this.anticipationTime * 0.5);
                    }
                    const alpha = Math.min(1.0, dt * this.reactionSpeed);
                    this.perceivedTargetPos.lerp(realTarget, alpha);
                }

                // Decision
                this.decisionTimer += dt;
                if (this.decisionTimer > this.decisionInterval) {
                    this.decisionTimer = 0;
                    this._evaluateState();
                }

                // Execution
                this._executeState(dt);
                
                // Interception
                if (this.techImmunityTimer > 0) this.techImmunityTimer -= dt;
                this._applyInterceptionPressure(dt);

            } else {
                // Human controlled or disabled
                const isDrivenByHuman = isHumanTeam && isActivePlayer && !isDemo;
                if (!isDrivenByHuman) {
                    this.setInput(0, 0);
                }
                this.stuckTimer = 0;
                this._applyInterceptionPressure(dt);
            }

            super.updatePhysics(dt);
        }

        updateVisuals(dt) {
            super.updateVisuals(dt);
        }

_evaluateState() {
            if (!this.ballRef) return;
            const ball = this.ballRef;

            // 1. Possession
            if (this.hasBall) {
                this.aiState = 'ATTACK_CARRY';
                return;
            }

            // 2. Unstuck Priority
            if (this.stuckTimer > 2.0) {
                this.aiState = 'UNSTUCK';
                return;
            }

            // 3. Determine Context
            const myPos = this.mesh.position;
            const ballPos = ball.mesh.position;
            const myDistSq = myPos.distanceToSquared(ballPos);
            
            // Count teammates closer to ball (Anti-Swarm)
            let closerCount = 0;
            if (this.team && this.team.players) {
                for (const p of this.team.players) {
                    if (p === this || !p.mesh || p.role === 'GL' || p.status.nap > 0 || p.stunTimer > 0) continue;
                    if (p.mesh.position.distanceToSquared(ballPos) < myDistSq) {
                        closerCount++;
                    }
                }
            }

            const amIClosest = (closerCount === 0);
            const side = this.team.side; // 1 (Defends +Z), -1 (Defends -Z)
            // relativeZ > 0 is defensive half, relativeZ < 0 is attacking half
            const relativeZ = ballPos.z * side; 

            // 4. Role-Based Logic
            if (ball.holder) {
                if (ball.holder.team === this.team) {
                    this.aiState = 'SUPPORT';
                } else {
                    // Opponent has ball - Defense Phase
                    
                    // Strict Swarm Control: Max 2 players chasing/pressing
                    const chaseLimit = 2;
                    const canChase = (closerCount < chaseLimit);

                    if (this.isDefender) {
                        // Defenders: Conservative. 
                        // Chase only if ball is in defensive territory (> -10) OR if I am the absolute closest.
                        // Otherwise, hold formation/mark.
                        const inDefensiveZone = (relativeZ > -10); 
                        
                        if ((inDefensiveZone || amIClosest) && canChase) {
                            this.aiState = 'CHASE';
                        } else {
                            this.aiState = 'DEFEND';
                        }
                    } else if (this.isForward) {
                        // Forwards: Press high.
                        // Chase if ball is in attacking territory (< 15). 
                        // If ball goes deep into our defense (relativeZ > 15), stop chasing and stay high/mark.
                        const inPressingZone = (relativeZ < 15);
                        
                        if (inPressingZone && canChase) {
                            this.aiState = 'CHASE';
                        } else {
                            this.aiState = 'DEFEND'; // Will return to home pos/mark
                        }
                    } else {
                        // Midfielders: The Engine.
                        // Can chase anywhere if within limit.
                        if (canChase) {
                            this.aiState = 'CHASE';
                        } else {
                            this.aiState = 'DEFEND';
                        }
                    }
                }
            } else {
                // Ball is Free (Loose Ball)
                // Priority: Closest 2 players go for it regardless of role (scramble)
                if (closerCount < 2) {
                    this.aiState = 'CHASE';
                } else {
                    this.aiState = 'DEFEND'; 
                }
            }
        }

        _executeState(dt) {
            if (!this.ballRef) {
                this.setInput(0, 0);
                return;
            }

            switch (this.aiState) {
case 'ATTACK_CARRY': this._stateAttackCarry(dt); break;
                case 'SUPPORT': this._stateSupport(dt); break;
                case 'DEFEND': this._stateDefend(dt); break;
                case 'CHASE': this._stateChase(dt); break;
                case 'UNSTUCK': this._stateUnstuck(dt); break;
                case 'RETURN_HOME': 
                default: this._stateReturnHome(dt); break;
            }
        }

        _stateUnstuck(dt) {
             // Move in a random direction to break free
             if (Math.random() < 0.1) { 
                 const angle = Math.random() * Math.PI * 2;
                 this.setInput(Math.cos(angle), Math.sin(angle));
                 // Try to dash if stuck
                 if (this.currentEN > 10 && Math.random() < 0.2) {
                     this.dash(Math.cos(angle), Math.sin(angle));
                 }
}
        }

_stateAttackCarry(dt) {
            const attackDir = (this.team.side === 1) ? -1 : 1;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = goalDist * attackDir;
            
            // --- STAT BASED DECISION MAKING ---
            const pa = this.getStat('PA');
            const en = this.getStat('EN');
            const sh = this.getStat('SH');
            const currentEN = this.currentEN;

            // 1. Movement
            _targetPos.set(0, 0, goalZ);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);

            const distToGoal = Math.abs(this.mesh.position.z - goalZ);
            
            // 2. Shooting Decision
            // Base range 20m. High SH extends effective range up to ~40m.
            const shootRange = 20.0 + (sh * 0.2); 
            
            if (distToGoal < shootRange && !this.isThrowing) {
                // If very close, always shoot
                if (distToGoal < 15.0) {
                    this._smartThrow(this.ballRef, 'SH');
                    return;
                }
                // If further out, check if we prefer shooting over dribbling
                // High SH makes us shoot earlier
                if (Math.random() < (sh / 150.0)) {
                    this._smartThrow(this.ballRef, 'SH');
                    return;
                }
            }
            
            // 3. Passing / Dribbling Decision
            const isSurrounded = this._isSurrounded();
            const lowEN = currentEN < 10;
            
            // Tendency to Pass vs Hold
            // High PA relative to EN -> Pass
            // High EN -> Hold
            const passTendency = (pa / (en + 1)) * 1.5; // > 1.0 means prefers passing
            
            let shouldLookForPass = false;
            
            if (isSurrounded) {
                // Under pressure
                // If current EN is low, we must pass
                if (lowEN) {
                    shouldLookForPass = true;
                } else {
                    // If EN is high enough to tank a tackle (e.g. > 30), and we have low Pass tendency, hold.
                    // "Hero Ball" check
                    if (currentEN > 30 && passTendency < 0.8) {
                        shouldLookForPass = false; // Dribble through
                    } else {
                        shouldLookForPass = true; // Panic pass
                    }
                }
            } else {
                // Open play
                // If Playmaker (High PA), look for passes constantly
                if (passTendency > 1.2) {
                    shouldLookForPass = true;
                }
            }

            if (shouldLookForPass && !this.isThrowing) {
                const bestMate = this._findBestPassTarget();
                if (bestMate) {
                    const myDist = Math.abs(this.mesh.position.z - goalZ);
                    const mateDist = Math.abs(bestMate.mesh.position.z - goalZ);
                    
                    // Threshold to pass:
                    // If I'm a shooter (low passTendency), mate must be significantly closer
                    // If I'm a passer, mate just needs to be somewhat better or open
                    let improvementNeeded = 5.0;
                    if (passTendency > 1.5) improvementNeeded = -5.0; // Will pass backwards to reset
                    if (passTendency < 0.5) improvementNeeded = 15.0; // Ball hog
                    
                    if (mateDist < myDist - improvementNeeded) {
                        this.mesh.lookAt(bestMate.mesh.position);
                        this._smartThrow(this.ballRef, 'PA');
                        return;
                    }
                }
            }
            
            // Failsafe: If surrounded and didn't pass (or couldn't), try to shoot if close enough
            if (isSurrounded && !this.isThrowing && distToGoal < 30.0) {
                this._smartThrow(this.ballRef, 'SH');
            }
        }

        _isSurrounded() {
            let count = 0;
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            for(let p of oppTeam.players) {
                if (p.mesh && p.mesh.position.distanceTo(this.mesh.position) < 4.0) {
                    count++;
                }
            }
            return count >= 2;
        }

        _smartThrow(ball, forcedType = null) {
            let type = forcedType;
            if (!type) {
                _tempVec1.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const attackDir = (this.team && this.team.side === 1) ? -1 : 1;
                const isAimingGoal = (_tempVec1.z * attackDir > 0.5);
                type = isAimingGoal ? 'SH' : 'PA';
            }

            const techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;
            let baseCost = (type === 'SH') ? 20 : 10;
            let techCost = 0;
            
            if (techName) {
                if (techName.includes('nap')) techCost = 30;
                else if (techName.includes('sphere') || techName.includes('invisible')) techCost = 25;
                else techCost = 20;
            }

            const totalCost = baseCost + techCost;
            let tempTech = null;
            if (techName && this.stats.HP < totalCost && this.stats.HP >= baseCost) {
                if (type === 'SH') {
                    tempTech = this.techs.shoot;
                    this.techs.shoot = null;
                } else {
                    tempTech = this.techs.pass;
                    this.techs.pass = null;
                }
            }

            this.throwBall(ball, type);

            if (tempTech) {
                if (type === 'SH') this.techs.shoot = tempTech;
                else this.techs.pass = tempTech;
            }
        }

_stateChase(dt) {
            _targetPos.copy(this.perceivedTargetPos);
            const ball = this.ballRef;
            if (ball.velocity.lengthSq() > 1.0) {
                _targetPos.addScaledVector(ball.velocity, 0.3);
            }
            
            // FIX: Allow entering goal crease if ball is inside it (prevent stuck ball)
            const ballInCrease = this._isPosInCrease(_targetPos);
            if (!ballInCrease) {
                this._avoidGoalCrease(_targetPos);
            }
            
            this._moveTo(_targetPos);

            // AI TACKLE LOGIC
            if (ball && ball.holder && ball.holder.team !== this.team) {
                this._attemptTackle(ball.holder);
            }
        }

        _stateReturnHome(dt) {
            _targetPos.copy(this.homePosition);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_stateSupport(dt) {
            const ball = this.ballRef;
            const carrier = ball.holder;
            
            if (!carrier || !carrier.mesh) {
                this._stateReturnHome(dt);
                return;
            }

            const ballPos = carrier.mesh.position;
            const attackDir = (this.team.side === 1) ? -1 : 1;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const targetGoalZ = (this.team.side === 1) ? -goalDist : goalDist;

            const pressure = this._calculatePressureOnPlayer(carrier);

            _targetPos.copy(this.homePosition);

            if (this.isForward) {
                // FORWARDS: Seek Scoring Positions & Open Space
                const time = Date.now() * 0.001;
                // Weave to shake markers
                const weave = Math.sin(time + this.mesh.id) * 8.0;
                
                // Ideal position: Deep in attacking half
                let targetZ = (ballPos.z + targetGoalZ) * 0.55; // Biased towards goal
                
                // Don't run too far ahead of the ball (stay connected)
                const maxLead = 25.0;
                if (Math.abs(targetZ - ballPos.z) > maxLead) {
                    targetZ = ballPos.z + (attackDir * maxLead);
                }

                _targetPos.set(this.homePosition.x + weave * 0.3, 0, targetZ);

                // Raycast Check: Is pass blocked?
                if (this._isPathBlocked(_targetPos, ballPos)) {
                    // Strategy 1: Go Wide
                    _tempVec1.copy(_targetPos);
                    _tempVec1.x = (this.homePosition.x > 0) ? 20 : -20; 
                    
                    // Strategy 2: Check To Ball (Come Short)
                    _tempVec2.copy(_targetPos);
                    _tempVec2.z = ballPos.z + (attackDir * 8.0); 
                    _tempVec2.x = this.homePosition.x;

                    if (!this._isPathBlocked(_tempVec1, ballPos)) {
                        _targetPos.copy(_tempVec1);
                    } else if (!this._isPathBlocked(_tempVec2, ballPos)) {
                        _targetPos.copy(_tempVec2);
                    }
                }

            } else if (this.isMidfielder) {
                // MIDFIELDERS: Link Play
                if (pressure > 0.6) {
                    // Carrier in trouble: Come close to offer an outlet
                    const side = (this.mesh.position.x > ballPos.x) ? 1 : -1;
                    _targetPos.x = ballPos.x + (side * 8.0);
                    _targetPos.z = ballPos.z - (attackDir * 2.0); // Square or slightly back
                } else {
                    // Carrier safe: Push forward into pocket
                    _targetPos.x = this.homePosition.x;
                    _targetPos.z = ballPos.z + (attackDir * 12.0);
                }

                // Avoid crowding the carrier too much
                if (_targetPos.distanceTo(ballPos) < 6.0) {
                    _tempVec1.subVectors(_targetPos, ballPos).normalize().multiplyScalar(6.0);
                    _targetPos.copy(ballPos).add(_tempVec1);
                }

            } else {
                // DEFENDERS: Safety Buffer (Prevent Counters)
                const safetyBuffer = 18.0;
                let targetZ = ballPos.z - (attackDir * safetyBuffer);
                
                // Own goal Z
                const ownGoalZ = -targetGoalZ;
                
                // Clamp so they don't sit on their own goalie if the ball is high up
                if (this.team.side === 1) { // Attacking -Z (Home), Own Goal +Z
                     targetZ = Math.min(ownGoalZ - 15, targetZ); 
                } else { // Attacking +Z (Away), Own Goal -Z
                     targetZ = Math.max(ownGoalZ + 15, targetZ);
                }

                _targetPos.set(this.homePosition.x, 0, targetZ);
                
                // Shift slightly towards ball X to cover center
                _targetPos.x = THREE.MathUtils.lerp(_targetPos.x, ballPos.x, 0.2);
            }

            this._avoidTeammates(_targetPos);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_stateDefend(dt) {
            const ball = this.ballRef;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            // Side 1 defends +Z, Side -1 defends -Z
            const myGoalZ = (this.team.side === 1) ? goalDist : -goalDist;

            // Stats
            const at = this.getStat('AT');
            const bl = this.getStat('BL');
            
            // Normalized factors (0.0 to 1.0, assuming max ~99)
            const aggroFactor = Math.min(1.0, at / 80.0); // High AT = Aggressive
            const laneFactor = Math.min(1.0, bl / 80.0);  // High BL = Smart Positioning

            if (this.marking && this.marking.mesh) {
                // --- MAN MARKING ---
                const markPos = this.marking.mesh.position;
                
                // 1. Base Goal-Side Position
                // Vector from mark to my goal
                _tempVec1.set(0, 0, myGoalZ - markPos.z); 
                // We want direction only on Z for stability? No, full 3D direction to block shot.
                // Actually, staying "goal side" usually means staying on the line between player and goal center.
                _tempVec1.x = 0 - markPos.x; // Goal center X is 0
                // _tempVec1.z is already set
                _tempVec1.y = 0; // Stay on ground plane for positioning logic
                _tempVec1.normalize();
                
                // Distance to keep from mark
                // High AT = Tighter (1.5m), Low AT = Looser (5.0m)
                const markDist = 5.0 - (aggroFactor * 3.5); 
                
                _targetPos.copy(markPos).addScaledVector(_tempVec1, markDist);
                
                // 2. Lane Cutting (BL Stat)
                // If mark doesn't have ball, try to intercept pass from ball holder
                if (ball && ball.mesh && ball.holder !== this.marking) {
                    // Vector from ball to mark
                    _tempVec2.subVectors(markPos, ball.mesh.position).normalize();
                    _tempVec2.y = 0;
                    
                    // Interception point: slightly in front of mark towards ball
                    const interceptPos = markPos.clone().addScaledVector(_tempVec2, -2.5); 
                    
                    // Blend based on BL stat (High BL = prioritize interception lane)
                    _targetPos.lerp(interceptPos, laneFactor * 0.7);
                }
                
                // 3. Pressing (If mark has ball)
                if (ball && ball.holder === this.marking) {
                     // If high AT, get very close to force action
                     _targetPos.lerp(markPos, aggroFactor * 0.6);
                }

            } else {
                // --- ZONE DEFENSE ---
                _targetPos.copy(this.homePosition);
                
                if (ball && ball.mesh) {
                    const ballPos = ball.mesh.position;
                    
                    // Shift formation towards ball (Compression)
                    // Defenders with high BL read the game better and shift more effectively
                    const shiftWeight = 0.2 + (laneFactor * 0.4); // 0.2 to 0.6
                    
                    _targetPos.x = THREE.MathUtils.lerp(this.homePosition.x, ballPos.x, shiftWeight);
                    _targetPos.z = THREE.MathUtils.lerp(this.homePosition.z, ballPos.z, shiftWeight);
                }
            }

            // Common constraints
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);

            // Opportunistic Tackle
            if (ball && ball.holder && ball.holder.team !== this.team) {
                const dist = this.mesh.position.distanceTo(ball.holder.mesh.position);
                // Tackle range increases with AT (Confidence)
                const tackleRange = 8.0 + (aggroFactor * 5.0); 
                
                if (dist < tackleRange) {
                    this._attemptTackle(ball.holder);
                }
            }
        }

_isPosInCrease(pos) {
            const creaseRadius = 10.0;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goals = [{ x: 0, z: -goalDist }, { x: 0, z: goalDist }];
            for (let g of goals) {
                const dx = pos.x - g.x;
                const dz = pos.z - g.z;
                if (dx*dx + dz*dz < creaseRadius*creaseRadius) return true;
            }
            return false;
        }

        _avoidGoalCrease(targetPos) {
            const creaseRadius = 10.0;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goals = [{ x: 0, z: -goalDist }, { x: 0, z: goalDist }];

            goals.forEach(goal => {
                const dx = targetPos.x - goal.x;
                const dz = targetPos.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < creaseRadius * creaseRadius) {
                    const dist = Math.sqrt(distSq);
                    if (dist > 0.001) {
                        const ratio = creaseRadius / dist;
                        targetPos.x = goal.x + dx * ratio;
                        targetPos.z = goal.z + dz * ratio;
                    } else {
                        targetPos.z = goal.z + (goal.z > 0 ? -creaseRadius : creaseRadius);
                    }
                }
            });

            const arenaRadius = 45.0;
            const dSq = targetPos.x * targetPos.x + targetPos.z * targetPos.z;
            if (dSq > arenaRadius*arenaRadius) {
                const d = Math.sqrt(dSq);
                const r = arenaRadius / d;
                targetPos.x *= r;
                targetPos.z *= r;
            }
        }

        _findBestPassTarget() {
            let bestTarget = null;
            let maxScore = -Infinity;
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalZ = (this.team.side === 1) ? -goalDist : goalDist;

            for (const mate of this.team.players) {
                if (mate === this) continue;
                if (!mate.mesh) continue;
                if (mate.status.nap > 0) continue;
                if (mate.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(mate.mesh.position);
                if (dist < 4.0) continue;
                if (dist > 30.0) continue;
                
                if (this._isPathBlocked(mate.mesh.position)) continue; 
                
                let score = 0;
                const myDistToGoal = Math.abs(this.mesh.position.z - goalZ);
                const mateDistToGoal = Math.abs(mate.mesh.position.z - goalZ);
                const progress = myDistToGoal - mateDistToGoal;
                
                score += progress * 1.5; 
                if (mateDistToGoal < 15.0) score += 10.0;
                if (mateDistToGoal < 8.0) score += 15.0;

                const openness = this._calculateOpenness(mate);
                score += openness * 3.0;

                if (mate.isForward) score += 5.0;
                score -= dist * 0.5;

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = mate;
                }
            }
            return bestTarget;
        }

        _calculateOpenness(player) {
            let minDefDist = 999;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const d = player.mesh.position.distanceTo(opp.mesh.position);
                if (d < minDefDist) minDefDist = d;
            }
            return Math.min(minDefDist, 8.0);
        }

        _isPathBlocked(targetPos, startPos = null) {
            const start = startPos || this.mesh.position;
            const end = targetPos;
            const dist = start.distanceTo(end);
            
            _scanDir.subVectors(end, start).normalize();
            
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            const safetyRadius = 2.5; 

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                
                _scanToOpp.subVectors(opp.mesh.position, start);
                const projection = _scanToOpp.dot(_scanDir);
                
                if (projection > 0 && projection < dist) {
                    const perpDistSq = _scanToOpp.lengthSq() - (projection * projection);
                    if (perpDistSq < (safetyRadius * safetyRadius)) {
                        return true;
                    }
                }
            }
            return false;
        }

        _moveTo(target) {
            _aiVec.subVectors(target, this.mesh.position);
            _aiVec.y = 0;
            
            const distSq = _aiVec.lengthSq();
            if (distSq > 1.0) {
                _aiVec.normalize();
                this.setInput(_aiVec.x, _aiVec.z);
            } else {
                this.setInput(0, 0);
                this.velocity.multiplyScalar(0.8);
            }
        }

        _applyInterceptionPressure(dt) {
            const ball = this.ballRef;
            if (!ball || !ball.mesh) return;

            if (ball.state !== 'free' || ball.velocity.lengthSq() < 1.0) return;
            if (ball.isInvisible) return;
            if (this.status.nap > 0 || this.stunTimer > 0) return;

            let range = 2.0;
            if (this.techs.passive === 'brawler' || this.techs.passive === 'elite_defense') {
                range += 1.5;
            }

            const dist = this.mesh.position.distanceTo(ball.mesh.position);
            if (dist > range) return;

            _scanToOpp.subVectors(this.mesh.position, ball.mesh.position).normalize();
            _tempVec1.copy(ball.velocity).normalize();
            
            const headingDot = _tempVec1.dot(_scanToOpp);
            if (headingDot < 0.7) return;

            const distFactor = Math.max(0, 1.0 - (dist / range));
            const pressure = 1.5;

            if (ball.power > 0) {
                ball.power -= pressure;
                this._accumulatedBlock = (this._accumulatedBlock || 0) + pressure;
                if (this._accumulatedBlock >= 5.0) { 
                    const val = Math.floor(this._accumulatedBlock);
                    this._accumulatedBlock -= val;
                    if (window.flux.gameInstance.floatingText) { 
                         window.flux.gameInstance.floatingText.spawn(`-${val}`, ball.mesh.position, "block", ball.mesh);
                    }
                }
            }

            if (Math.random() < (distFactor * 0.8)) { 
                _tempVec2.copy(this.mesh.position).lerp(ball.mesh.position, 0.5 + (Math.random()-0.5)*0.2);
                _tempVec2.x += (Math.random()-0.5) * 0.5;
                _tempVec2.y += (Math.random()-0.5) * 0.5;
                _tempVec2.z += (Math.random()-0.5) * 0.5;
                
                if (window.flux.gameInstance.spawnClash) {
                    window.flux.gameInstance.spawnClash(_tempVec2, 0.6);
                }
            }

            if (ball.power <= 0 && ball.powerType === 'SH') {
                ball.powerType = 'none';
                if (window.flux.gameInstance.floatingText) { 
                    window.flux.gameInstance.floatingText.spawn("BLOCKED", this.mesh.position, "comic-impact");
                }
            }

            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                if (tech.type === 'venom') this.applyStatus('venom', 15.0);
                else if (tech.type === 'nap') this.applyStatus('nap', 8.0);
                else if (tech.type === 'wither') this.applyStatus('wither', 15.0, 'BL');
            }
        }

        _calculatePressureOnPlayer(player) {
            if (!player || !player.mesh) return 0;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            
            const oppTeam = (player.team.id === 'home') ? game.teams.away : game.teams.home;
            let pressure = 0;
            
            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const dist = player.mesh.position.distanceTo(opp.mesh.position);
                if (dist < 10.0) {
                    pressure += (10.0 - dist) / 10.0;
                }
            }
            return pressure;
        }

        _avoidTeammates(targetPos) {
            if (!this.team) return;
            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;
                if (mate.hasBall) continue;
                
                const dist = targetPos.distanceTo(mate.mesh.position);
                if (dist < 5.0) {
                    _tempVec1.subVectors(targetPos, mate.mesh.position).normalize();
                    targetPos.addScaledVector(_tempVec1, 5.0 - dist);
                }
            }
}

_attemptTackle(target) {
            if (this.isTackling || this.isRecovering || this.isDashing || this.stunTimer > 0) return;
            
            // Check EN: Must have enough to tackle (Cost is 8)
            // We add a small buffer (9) to be safe and avoid edge case spam where they try and fail
            if (this.currentEN < 9) return; 

            // 1. Predict Target Position (Lead the target)
            const leadTime = 0.2; 
            const predictedPos = target.mesh.position.clone();
            if (target.velocity) {
                predictedPos.addScaledVector(target.velocity, leadTime);
            }
            
            // 2. Calculate Vector to Predicted Spot
            const toPred = predictedPos.sub(this.mesh.position);
            toPred.y = 0;
            const dist = toPred.length();
            
            // 3. Range Check
            // Increased range to 15.0m
            if (dist < 15.0) {
                toPred.normalize();
                
                // 4. Angle Check
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const dot = fwd.dot(toPred);
                
                // Relaxed angle: Allow tackling if target is generally in front (> 0.2 dot)
                // Slightly stricter than 0.0 to prevent weird side-lunges
                if (dot > 0.2) {
                    // 5. Reaction Check
                    // Intelligent: Don't just spam. Probabilities per frame (assuming ~60fps).
                    // Far (8-15m): ~1 attempt per 1.5s (0.01)
                    // Close (3-8m): ~1 attempt per 0.5s (0.03)
                    // Point Blank (<3m): Aggressive (0.15)
                    let chance = 0.01; 
                    if (dist < 8.0) chance = 0.03; 
                    if (dist < 3.0) chance = 0.15; 

                    if (Math.random() < chance) {
                        // SNAP TURN: AI cheats rotation to face target perfectly before lunging
                        // This ensures the tackle vector is accurate
                        const targetAngle = Math.atan2(toPred.x, toPred.z);
                        this.currentYaw = targetAngle - this.rotationOffset;
                        this.targetYaw = this.currentYaw;
                        this.mesh.quaternion.setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);

                        this.startTackle(toPred.x, toPred.z);
                    }
                }
            }
        }

    }

window.flux.AIPlayer = AIPlayer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};
    
    // Reusable vectors to avoid GC
const _gVec = new THREE.Vector3();
    const _gPos = new THREE.Vector3();
    const _ballPos = new THREE.Vector3();
    const _faceVec = new THREE.Vector3();
    const _goalCenter = new THREE.Vector3();
    const _tempVecG = new THREE.Vector3();

class Goalie extends (window.flux.Player || class {}) {
constructor(scene, role) {
            super(scene, role);
            
            // Goalie Specific Stats (Buffed for Playability)
            this.stats.CA = 30; // Catch
            this.stats.SP = 40; // Speed
            this.stats.EN = 50;
            
            // BUFFED: Strong arm for clearing the zone
            this.stats.PA = 45; // Was 20 - Now strong enough to reach midfield
            this.stats.SH = 35; // Was 10 - Decent clearance kick
            
            this._updateDerivedStats();

            // Goal Dimensions (Save Box) - Matches GameManager detection
            this.goalWidth = 22.0; 
            this.goalHeight = 18.0; 
            
            // Save Mechanics
// Config for "Herculean" scale
            this.pressureMultiplier = 5.0; 
            
            // Techs
            this.techs = {
                active: null, 
                passive: null 
            };
            
            // AI State
            this.throwTimer = 0;
            this._accumulatedSave = 0;
            
            // Super Goalie State
            this.isSuperGoalie = false;
            this.superGoalieTimer = 0;

// Perception Smoothing (Reaction Delay)
            this.perceivedBallPos = new THREE.Vector3();
            this.reactionSpeed = 4.0; // Lower = more delay/smoothing
            this.techImmunityTimer = 0;
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            // 1. Super Goalie Timer
            if (this.isSuperGoalie) {
                this.superGoalieTimer -= dt;
                if (this.superGoalieTimer <= 0) {
                    this.isSuperGoalie = false;
                }
            }
            
            // 2. Possession Logic (Ball Held)
            if (this.hasBall) {
                this._checkTacklePressure(dt);
                
const game = window.flux.gameInstance;
                const isHumanControlled = game && this.team && this.team.isHuman && this.team.activePlayer === this && !game.isDemoMode;
                
                if (isHumanControlled) {
                    super.updatePhysics(dt);
                } else {
                    if (!this.isThrowing) {
                        this._aiPossessionLogic(dt);
                    }
                    this.setInput(0, 0);
                    super.updatePhysics(dt);
                }
                this._constrainBounds();
                return; 
            }

            // 3. Defense / Save Logic (No Ball)
            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            
            this._updateStatusLogic(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                this._constrainBounds();
                return;
            }

            this._defenseLogic(dt);
            this._constrainBounds();
        }

        updateVisuals(dt) {
            if (this.hasBall) {
                super.updateVisuals(dt);
                return;
            }

            this._updateStatusVisuals(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                if (this.mixer) this.mixer.update(dt);
                this._updateHPBar();
                return;
            }

            if (this.mixer) this.mixer.update(dt);
            this._updateHPBar();
        }

_constrainBounds() {
            if (!this.mesh) return;
            const pos = this.mesh.position;
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;

            const side = this.team ? this.team.side : 1;
            // X Bounds (Width of penalty area +/- 10m) -> Increased for massive goal
const xLimit = 20.0; // Reduced width of goalie movement
            if (pos.x > xLimit) { pos.x = xLimit; this.velocity.x = 0; }
            if (pos.x < -xLimit) { pos.x = -xLimit; this.velocity.x = 0; }
            
            // Y Bounds
// Y Bounds (Expanded for deeper goal)
            const yLimit = 18.0; 
            if (pos.y > yLimit) { pos.y = yLimit; this.velocity.y = 0; }
            if (pos.y < -yLimit) { pos.y = -yLimit; this.velocity.y = 0; }
            
            // Z Bounds (Depth)
// Z Bounds (Depth)
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (side === 1) {
                if (pos.z > goalDist - 0.5) { pos.z = goalDist - 0.5; this.velocity.z = 0; }
                if (pos.z < 20.0) { pos.z = 20.0; this.velocity.z = 0; }
            } else {
                if (pos.z < -goalDist + 0.5) { pos.z = -goalDist + 0.5; this.velocity.z = 0; }
                if (pos.z > -20.0) { pos.z = -20.0; this.velocity.z = 0; }
            }
        }

// Override throwBall to fix "weak throw" issue
// Override throwBall to fix "weak throw" issue and reduce loft
        throwBall(ball, forcedType = null, powerMultiplier = 1.0) {
            if (!this.hasBall || this.isThrowing) return;
            
            this.isThrowing = true;
            const type = forcedType || 'PA';
            const boost = 1.2;
            const finalPower = powerMultiplier * boost;

            // Animation
            const throwKey = (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' : 'throw_pass';
            this.playOneShot(throwKey, 0.1, { timeScale: 1.2 });

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CLEAR!", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                if (this.hasBall || (ball && ball.holder === this)) {
                    // Calculate Direction
                    const finalDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    
                    // REDUCED LOFT: Goalie throws flatter (0.25 instead of 0.8)
                    finalDir.y += 0.25; 
                    finalDir.normalize();

                    // Calculate Stats
                    let statVal = this.getStat(type);
                    statVal *= finalPower;

                    ball.shoot(finalDir, statVal, type);
// Duplicate removed
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addRecoil(
                            -finalDir.x * 2.0, 
                            -0.5, 
                            -finalDir.z * 2.0
                        );
                    }
                    // Extra grace period for Goalie
                    ball.catchGracePeriod = 0.6;

this.loseBall(1.0);
                }
            }, 300); // Windup time

            setTimeout(() => {
                this.isThrowing = false;
                this._updateLocomotionAnim(0.2);
            }, 800);
        }

_defenseLogic(dt) {
            // 0. Game State Check
if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            const ball = (window.flux.gameInstance && window.flux.gameInstance.entities) ? window.flux.gameInstance.entities.ball : null;
            if (!ball || !ball.mesh) return;

            // --- PERCEPTION UPDATE ---
            // Smoothly interpolate perceived position towards real ball position
            // This creates a natural reaction delay and prevents jittery mirroring
            this.perceivedBallPos.lerp(ball.mesh.position, dt * this.reactionSpeed);

            // Determine Threat Source
            let threatPos = _ballPos;
            let isThreat = false;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const myGoalZ = (this.team.side === 1) ? goalDist : -goalDist;

            // Case A: Ball is Held (Pre-throw)
            if (ball.state === 'held' && ball.holder && ball.holder.team !== this.team) {
                // Track holder, but use perceived position if we wanted to simulate reading the player
                // For now, tracking the ball (which is on the player) via perceivedPos is sufficient
                threatPos = this.perceivedBallPos;
                
                // Check if holder is in attacking half or near enough
                const distToGoal = Math.abs(threatPos.z - myGoalZ);
                if (distToGoal < 40.0) { // If they are within 40m, track them
                    isThreat = true;
                }
            } 
            // Case B: Ball is Free (Shot/Pass)
            else if (ball.state === 'free') {
                threatPos = this.perceivedBallPos;
                
                // Direction Check
                const movingTowards = (this.team.side === 1 && ball.velocity.z > 0) || 
                                      (this.team.side === -1 && ball.velocity.z < 0);
                
                // Position Check
                const inFrontOfGoal = (this.team.side === 1 && threatPos.z < 45.0) || 
                                      (this.team.side === -1 && threatPos.z > -45.0);

                isThreat = movingTowards && inFrontOfGoal;
            }
            if (isThreat) {
                // --- POSITIONING: ANGLE CUTTING ---
                _ballPos.copy(threatPos); // Update reference for lookAt
                
                // 1. Calculate Goal Center
// 1. Calculate Goal Center (Adjusted for Y offset)
// 1. Calculate Goal Center (Adjusted for new Y offset -8.0)
                _goalCenter.set(0, -8.0, myGoalZ);
                
                // 2. Vector from Goal to Ball
                _tempVecG.subVectors(_ballPos, _goalCenter);
                const distToBall = _tempVecG.length();
                _tempVecG.normalize(); // Now holds direction
                
                // 3. Determine Extension (How far out to step)
                // Base: 1.5m off line.
                // Max: 6.0m off line (Cutting angle).
                // Scale based on ball proximity: Closer ball = More extension (to a point)
let extension = 1.5;
                if (distToBall < 30.0) {
                    const ratio = 1.0 - (Math.max(0, distToBall - 5.0) / 25.0); 
                    extension = 1.5 + (4.5 * ratio); 
                }
                
// Safety: Don't go past the ball (keep 1m buffer)
                extension = Math.min(extension, distToBall - 1.0);
                
                // 4. Calculate Target Position (Base Interception)
                _gPos.copy(_goalCenter).add(_tempVecG.multiplyScalar(extension));
                
                // 5. Vertical Override (Jump to meet ball)
                // Explicitly set Y to match ball height if it's high
                if (_ballPos.y > 0.5) {
                    _gPos.y = _ballPos.y;
                } else {
                    _gPos.y = 0.5; // Default stance
                }

                // 6. Clamp to Goal Box Dimensions (Lateral/Vertical Limits)
                // Goal Width 22 (+/- 11), Height 18 (+/- 9).
                // Allow slightly outside posts to cover angles.
                const clampX = this.goalWidth * 0.6; // +/- 13.2
const clampY = 18.0; // Increased max jump height
                
                _gPos.x = Math.max(-clampX, Math.min(clampX, _gPos.x));
                _gPos.y = Math.max(-clampY, Math.min(clampY, _gPos.y));
                
                // 6. Lead the ball slightly if it has lateral velocity (Anticipation)
if (ball.velocity.lengthSq() > 1.0) {
                    const anticipation = ball.velocity.clone().multiplyScalar(0.25); // 0.25s lead
                    anticipation.z = 0; // Only lateral lead
                    _gPos.add(anticipation);
                }

                // CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (this.team.side === 1) {
                _gPos.z = Math.min(goalDist - 0.5, _gPos.z);
            } else {
                _gPos.z = Math.max(-goalDist + 0.5, _gPos.z);
            }

                // Move towards target
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                const distToTarget = moveDir.length();
                
                if (distToTarget > 0.1) {
                    moveDir.normalize();
                    // Burst speed for saves if ball is close
                    const urgency = (distToBall < 10.0) ? 1.5 : 1.0;
                    const speed = this.maxSpeed * urgency;
                    
                    this.mesh.position.add(moveDir.multiplyScalar(speed * dt));
                    
                    // Face ball
                    this.mesh.lookAt(_ballPos);
                    
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                    this.mesh.lookAt(_ballPos);
                }

                // --- SAVE MECHANIC ---
                // If ball is within range, apply CA pressure
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < this.saveRadius) { 
                    this._applySavePressure(ball, dt);
                }
            } else {
                // --- IDLE / RETURN TO POST ---
                // Return to home position (usually center of goal)
                _gPos.copy(this.homePosition);
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                
                if (moveDir.length() > 0.5) {
                    moveDir.normalize();
                    this.mesh.position.add(moveDir.multiplyScalar(this.maxSpeed * 0.6 * dt));
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                }
                
                // Face center field
                this.mesh.lookAt(0, 0, 0);
            }
        }

        _applySavePressure(ball, dt) {
            // If Goalie is Asleep, they cannot save.
            if (this.status.nap > 0) return;

            // --- SUPER GOALIE TRIGGER ---
            // Trigger if: Tech equipped, Not active, Ball has power, Ball is close
            if (this.techs.active === 'super_goalie' && !this.isSuperGoalie && ball.power > 5.0) {
                // Chance to trigger (High chance for AI, or check HP)
                // Cost: 10 HP
                if (this.stats.HP >= 10) {
                    this.stats.HP -= 10;
                    this.isSuperGoalie = true;
                    this.superGoalieTimer = 1.5; // Lasts 1.5s
                    
                    console.log(`${this.role} used SUPER GOALIE!`);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SUPER GOALIE!", this.mesh.position, "save");
                    }
                    
                    // Trigger Techcopy Event
                    if (window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, 'super_goalie');
                    }
                }
            }

            // Calculate Effective CA
            let ca = this.getStat('CA');
            
            // Apply Super Goalie Bonus (e.g. +50% + Flat 10)
            if (this.isSuperGoalie) {
                ca = (ca * 1.5) + 10;
            }
            
            // Apply Grip Gloves (Passive)
            if (this.techs.passive === 'grip_gloves') {
                ca += 5;
            }

            // Calculate Pressure
            // Pressure = CA * dt * Multiplier
            const pressure = ca * dt * this.pressureMultiplier;
            
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback
                this._accumulatedSave += pressure;
                // THROTTLE: Increased threshold to 12.0
                if (this._accumulatedSave >= 12.0) { 
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "comic-impact");
                    }
                    this._accumulatedSave = 0;
                }
            }

            // Apply Ball Technique to Goalie (Risk of catching special shots)
// Apply Ball Technique to Goalie (Risk of catching special shots)
            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'CA');
                }
            }

            // Check Result
            if (ball.power <= 0 && this.status.nap <= 0) {
                // CATCH
                this.catchBall(ball);
            }
        }

        catchBall(ball) {
            ball.grab(this);
            this.play('catch', 0.1);
            console.log("SAVED by " + this.role);
            
            // EXP REWARD: Save
            this.gainExp(5);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SAVED!", this.mesh.position, "comic-impact");
            }
            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.15, 'heavy');
            
            // Reset throw timer
            this.throwTimer = 0;
        }

_aiPossessionLogic(dt) {
            this.throwTimer += dt;
            
            // Hold for a moment (1.5s) then throw
            if (this.throwTimer > 1.5) {
                // Find best target: Prefer MF or Defenders, but must be somewhat distant to avoid "handoff" look
                // Filter for teammates > 8 units away if possible
                const validMates = this.team.players.filter(p => 
                    p !== this && 
                    p.mesh && 
                    p.mesh.position.distanceTo(this.mesh.position) > 8.0
                );

                let target = null;

                // Priority 1: Midfielder (Playmaker)
                target = validMates.find(p => p.role === 'MF');
                
                // Priority 2: Defenders
                if (!target) target = validMates.find(p => p.role === 'LD' || p.role === 'RD');
                
                // Priority 3: Anyone open (fallback to close range if no one is far)
                if (!target) target = this.team.players.find(p => p !== this && p.role !== 'GL');

                if (target && target.mesh) {
                    // AIMING LOGIC: Loft the pass
                    // Look at target, but aim slightly up to create an arc
                    const targetPos = target.mesh.position.clone();
                    
                    // Calculate distance
                    const dist = this.mesh.position.distanceTo(targetPos);
                    
                    // Loft factor: The further away, the higher we aim
                    // 20 units away -> Aim 5 units above head
                    const loft = Math.max(1.0, dist * 0.25);
                    targetPos.y += loft;

                    this.mesh.lookAt(targetPos);
                    
                    // Throw
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'PA'); 
                    console.log(`${this.role} throws to ${target.role} (Dist: ${dist.toFixed(1)})`);
                } else {
                    // Clear it forward
                    this.mesh.lookAt(0, 5, 0); // Aim up-center
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'SH'); // Hard clear
                }
                
                this.throwTimer = 0;
            }
        }
    }

    window.flux.Goalie = Goalie;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable math vectors to avoid GC
const _bVec = new THREE.Vector3();
    const _bDir = new THREE.Vector3();
    const _axisY = new THREE.Vector3(0, 1, 0);
    const _tempVec = new THREE.Vector3();
    const _magnusVec = new THREE.Vector3();

// Physics Configuration (Exposed for DevTools)
window.flux.BallConfig = {
        // -----------------------------------------------------------------
        // Core integration
        // -----------------------------------------------------------------
        SUBSTEPS: 2,
        STOP_SPEED: 0.02,

        // -----------------------------------------------------------------
        // Global Physics
        // -----------------------------------------------------------------
        GRAVITY: 0.0, // Default 0 (Neutral buoyancy)

        // -----------------------------------------------------------------
        // Water resistance
        // -----------------------------------------------------------------
        WATER_DRAG_LINEAR: 0.15,
        WATER_DRAG_QUAD: 0.002,

        // -----------------------------------------------------------------
        // Spin & curve
        // -----------------------------------------------------------------
        SPIN_DRAG: 0.4,
        MAGNUS_ENABLED: true,
        MAGNUS_COEFF: 0.08,
        MAGNUS_CAP: 60,

        // -----------------------------------------------------------------
        // Depth constraint
        // -----------------------------------------------------------------
        DEPTH_TARGET_Y: 0,
        DEPTH_SPRING: 1,
        DEPTH_DAMP: 1.5,

        // -----------------------------------------------------------------
        // Arena boundary
        // -----------------------------------------------------------------
        BOUNDARY_RADIUS: 46,
        BOUNDARY_HEIGHT: 20,
        
        // Goal Settings
        GOAL_DISTANCE: 41.5,
        GOAL_Y_OFFSET: -2.31,
        GOAL_SCALE: 45,
        GOAL_SCALE_X: 1.3456,
        GOAL_SCALE_Y: 1,
        GOAL_SCALE_Z: 1,
        
        // Goal Trigger (Hitbox)
        GOAL_TRIGGER_TOP_Y: 9.1555,
        GOAL_TRIGGER_BOTTOM_Y: -4.3555,
        GOAL_TRIGGER_WIDTH: 17.1,
        GOAL_TRIGGER_OFFSET: 1,

        // Goal Pocket
        GOAL_POCKET_ENABLED: true,
        GOAL_POCKET_X: 12,
        GOAL_POCKET_Z: 40,
        GOAL_POCKET_RADIUS: 55,

        // Walls
        WALL_SOFT_BUFFER: 3,
        WALL_SOFT_FORCE: 20,
        WALL_ELASTICITY: 0.3,
        WALL_FRICTION: 0.95,
        FLOOR_ELASTICITY: 0.4,

        // -----------------------------------------------------------------
        // Throw mapping
        // -----------------------------------------------------------------
        LAUNCH_SPEED_SCALE: 1,
        LAUNCH_SPEED_CAP: 85
    };


    
    const C = window.flux.BallConfig; // Local alias for brevity
    // --- TRAIL RENDERER ---
// --- TRAIL RENDERER ---
    class TrailRenderer {
        constructor(scene) {
            this.scene = scene;
            this.segments = 30; // More segments for smoother curves
            this.points = [];
this.baseWidth = 0.8; // Increased width for visibility
            this.currentWidth = 0.8;
            
            // Geometry
            const geometry = new THREE.BufferGeometry();
            const posData = new Float32Array(this.segments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(posData, 3));
            
            // Indices
            const indices = [];
            for (let i=0; i<this.segments-1; i++) {
                const base = i*2;
                indices.push(base, base+1, base+2);
                indices.push(base+1, base+3, base+2);
            }
            geometry.setIndex(indices);
            
            this.material = new THREE.MeshBasicMaterial({
                color: 0x00aaff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.scene.add(this.mesh);
            
            // Init points
            for(let i=0; i<this.segments; i++) this.points.push(new THREE.Vector3());
            this.active = false;

            // Reusable temps (avoid per-frame allocations on mobile)
            this._tmpDir = new THREE.Vector3();
            this._tmpToCam = new THREE.Vector3();
            this._tmpRight = new THREE.Vector3();
        }
        
        reset(pos) {
            for(let i=0; i<this.segments; i++) this.points[i].copy(pos);
            this.updateGeometry();
        }
        
        setColor(hex) {
            this.material.color.setHex(hex);
        }
        
        update(currentPos, speedRatio = 0.0) {
            if (!this.active) {
                this.reset(currentPos);
                return;
            }

// Dynamic Width based on speed AND SPIN (Power Visual)
            // Fast ball = Thicker. Spinning ball = Even Thicker.
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;
            const spinRatio = ball ? Math.min(1.0, ball.angularVelocity.length() / 30.0) : 0;
            
            const targetWidth = this.baseWidth * (0.8 + speedRatio * 1.2 + spinRatio * 2.0);
            this.currentWidth += (targetWidth - this.currentWidth) * 0.2; // Smooth transition

            // Shift points
            for (let i = this.segments - 1; i > 0; i--) {
                this.points[i].copy(this.points[i-1]);
            }
            this.points[0].copy(currentPos);
            
            this.updateGeometry();
        }
        
        updateGeometry() {
            const positions = this.mesh.geometry.attributes.position.array;
            const cam = window.flux.gameInstance ? window.flux.gameInstance.camera : null;
            if (!cam) return;
            const camPos = cam.position;
            const tempDir = this._tmpDir;
            const tempToCam = this._tmpToCam;
            const tempRight = this._tmpRight;
            for (let i=0; i<this.segments; i++) {
                const p = this.points[i];
                
                // Taper width along trail length
                const taper = 1.0 - Math.pow(i / this.segments, 2); // Quadratic taper
                const w = this.currentWidth * taper;
                
                // Calculate direction
                if (i < this.segments - 1) {
                    tempDir.subVectors(this.points[i], this.points[i+1]);
                } else {
                    tempDir.subVectors(this.points[i-1], this.points[i]);
                }
                
                if (tempDir.lengthSq() < 0.0001) tempDir.set(0, 1, 0);
                tempDir.normalize();
                
                tempToCam.subVectors(camPos, p).normalize();
                tempRight.crossVectors(tempDir, tempToCam).normalize().multiplyScalar(w);
                
                // Vert 1
                positions[i*6 + 0] = p.x - tempRight.x;
                positions[i*6 + 1] = p.y - tempRight.y;
                positions[i*6 + 2] = p.z - tempRight.z;
                
                // Vert 2
                positions[i*6 + 3] = p.x + tempRight.x;
                positions[i*6 + 4] = p.y + tempRight.y;
                positions[i*6 + 5] = p.z + tempRight.z;
            }
this.mesh.geometry.attributes.position.needsUpdate = true;
        }
    }

    // C is already defined in the outer scope
    class Ball {

        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.holder = null; 
            this.lastHolder = null; // Track who threw it last (for EXP/Assists)
            
this.velocity = new THREE.Vector3(0, 0, 0);
            this.externalForce = new THREE.Vector3(0, 0, 0); // Environmental forces (Currents, Gravity overrides)
            this.angularVelocity = new THREE.Vector3(0, 0, 0);
            this.state = 'free'; // 'free', 'held', 'magnetized'
this.isInvisible = false;
this.isRicochet = false;
            this.homingTarget = null;
            this.element = null;
            this._elementalTimer = 0;
            // Continuous Stats
            this.power = 0;      // Current PA or SH value
            this.powerType = 'none'; // 'PA' or 'SH'
            this.decayRate = 3.0; // Stat points lost per second (Water resistance)
            this.catchGracePeriod = 0; // Time before ball can be caught again

            // Magnet System
            this.magnetTarget = null;
            this.magnetTimer = 0;
            this.magnetDuration = 0.2; 
            this.magnetStartPos = new THREE.Vector3();
            this.magnetStartVel = new THREE.Vector3();

            // Visuals (Squash & Stretch)
            this.accumulatedRotation = new THREE.Quaternion();
            this.deformNode = null;
            this.spinNode = null;
            this.model = null;

this.initMesh();
this.trail = new TrailRenderer(scene);
            
            // Failsafe Timers
            this.stuckTimer = 0;
this.stuckTimer = 0;
            this._bubbleTimer = 0;
            this.outOfBoundsTimer = 0;
}

        initMesh() {
            // Hierarchy: Mesh (Pos) -> Deform (Squash/Stretch) -> Spin (Rotation) -> Model
            this.mesh = new THREE.Group();
            this.scene.add(this.mesh);

this.deformNode = new THREE.Group();
            this.deformNode.position.y = 0.0; // Reset offset so ball is centered on mesh position
            this.mesh.add(this.deformNode); // Fix: Add deformNode to mesh

            this.spinNode = new THREE.Group();
            this.deformNode.add(this.spinNode);

            // Procedural Placeholder Texture (Blitzball-ish)
            const placeholderTex = (() => {
                const c = document.createElement('canvas');
                c.width = 128; c.height = 64;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0,0,128,64);
                
                // Blue bumps/details
                ctx.fillStyle = '#0088ff';
                for(let i=0; i<6; i++) {
                    ctx.beginPath();
                    ctx.arc(i*25, 32, 10, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#004488';
                ctx.fillRect(0, 28, 128, 8); // Stripe
                
                return new THREE.CanvasTexture(c);
            })();

            // Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
            const geometry = new THREE.SphereGeometry(0.3, 16, 16); // Scaled down ~15%
            const material = new THREE.MeshBasicMaterial({
                map: placeholderTex,
                color: 0xffffff, 
                wireframe: false, // Solid
                transparent: false,
                opacity: 1.0
            });
            this.placeholder = new THREE.Mesh(geometry, material);

            // Load GLB Model
            const url = 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb';
            
            window.flux.AssetLoader.loadModel(url, (gltf) => {
                console.log("DEBUG: Ball GLB loaded.", gltf);
                
                const model = gltf.scene;

                // 1. Reset root transforms
                model.position.set(0, 0, 0);
                model.rotation.set(0, 0, 0);
                model.scale.set(1, 1, 1);
                model.updateMatrixWorld(true);

                // 2. Harden Materials & Visibility
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // CRITICAL: Prevent culling if bounds are off
                        
                        if (node.material) {
                            const mats = Array.isArray(node.material) ? node.material : [node.material];

                            mats.forEach(m => {
                                m.color.setHex(0xffffff); // Force white base
                                m.side = THREE.DoubleSide;
                                m.transparent = false;
                                m.opacity = 1.0;
                                m.alphaTest = 0; // CRITICAL: Disable alpha test to prevent culling
                                m.depthWrite = true;
                                m.depthTest = true;

                                // Inject Jelly Wobble Shader
                                m.onBeforeCompile = (shader) => {
                                    shader.uniforms.uTime = { value: 0 };
                                    m.userData.shader = shader; // Store reference to update time later
                                    
                                    shader.vertexShader = `
                                        uniform float uTime;
                                    ` + shader.vertexShader;
                                    
                                    shader.vertexShader = shader.vertexShader.replace(
                                        '#include <begin_vertex>',
                                        `
                                        #include <begin_vertex>
                                        
                                        // Jelly Effect
                                        float wobble = sin(position.y * 4.0 + uTime * 15.0) * 0.06;
                                        wobble += cos(position.x * 4.0 + uTime * 12.0) * 0.06;
                                        wobble += sin(position.z * 4.0 + uTime * 10.0) * 0.06;
                                        
                                        transformed += normal * wobble;
                                        `
                                    );
                                };
                            });
                        }
                    }
                });

                // 3. Compute Bounding Box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // 4. Validation
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim <= 0.001 || !isFinite(maxDim)) {
                    console.warn("Ball model has invalid dimensions. Keeping placeholder.");
                    return; 
                }

                // 5. Calculate Scale
// 5. Calculate Scale
                const targetDiameter = 0.72; // Reduced scale by ~15% (was 0.85)
                const scaleFactor = targetDiameter / maxDim;

                // 6. Apply Transforms
                model.scale.setScalar(scaleFactor);
                model.position.copy(center).multiplyScalar(-scaleFactor);

                // 7. Swap Placeholder
                if (this.placeholder) {
                    this.spinNode.remove(this.placeholder);
                    if (this.placeholder.geometry) this.placeholder.geometry.dispose();
                    this.placeholder = null;
                }

                this.model = model;
                this.spinNode.add(this.model);
                console.log(`Blitzball model attached. Scale: ${scaleFactor.toFixed(4)}`);

            }, undefined, (err) => {
                console.error("Failed to load Blitzball model:", err);
                // Fallback: Keep placeholder but tint it red to indicate error
                if (this.placeholder) {
                    this.placeholder.material.color.setHex(0xffaaaa);
                }
            });
        }

update(dt) {
            // Wrapper for backward compatibility
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Physics control)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this && typeof __lab.applyReplayFrame === 'function') {
                __lab.applyReplayFrame(this, dt);
                return;
            }

            // Safety: Reset if position corrupted
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                this.reset();
                return;
            }

            // Safety: Fix "Unpickable Ball" Bug
            if (this.state === 'held' && (!this.holder || !this.holder.mesh)) {
                this.drop();
            }
            if (this.state === 'magnetized') {
                if (!this.magnetTarget || !this.magnetTarget.mesh) {
                    this.drop();
                }
                if (this.magnetTimer > 2.0) {
                    console.warn("Ball stuck in magnetized state. Dropping.");
                    this.drop();
                }
            }
            if (this.state === 'free' && this.holder !== null) {
                this.holder = null;
            }
            if (this.state === 'free' && this.velocity.lengthSq() < 0.5) {
                this.catchGracePeriod = 0;
            }

            if (this.state === 'held' && this.holder && this.holder.mesh) {
                this.updateHeld(dt);
            } else if (this.state === 'magnetized') {
                this.updateMagnetized(dt);
            } else {
                this._updateFreePhysics(dt);
            }
            
if (this.catchGracePeriod > 0) {
                this.catchGracePeriod -= dt;
                if (this.catchGracePeriod < 0) this.catchGracePeriod = 0;
            }

            this._checkFailsafes(dt);
        }

        updateVisuals(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Visuals)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this) {
                if (this.trail) this.trail.active = false;
                this._updateVisualTransforms(dt);
                return;
            }

            if (this.trail) {
                const speed = this.velocity.length();
                this.trail.active = (this.state === 'free' && speed > 2.0);
                
                _bVec.copy(this.mesh.position);
                if (this.deformNode) _bVec.y += this.deformNode.position.y;

                const ratio = Math.min(speed / 60.0, 1.0);
                this.trail.update(_bVec, ratio);
            }

            this._updateVisualTransforms(dt);
            this._updateParticles(dt);
            
if (this.mesh && !this.isInvisible) {
                this.mesh.visible = true;
                if (this.model) this.model.visible = true;
                
                // Update Shader Time for Jelly Effect
                if (this.model) {
                    this.model.traverse(c => {
                        if (c.isMesh && c.material) {
                            const mats = Array.isArray(c.material) ? c.material : [c.material];
                            mats.forEach(m => {
                                if (m.userData.shader) {
                                    m.userData.shader.uniforms.uTime.value += dt;
                                }
                            });
                        }
                    });
                }
            }
        }

        magnetize(target) {

            if (this.state === 'magnetized' || this.state === 'held') return;
            
            this.state = 'magnetized';
            this.magnetTarget = target;
            this.holder = target; // Logical possession so AI reacts
            this.magnetTimer = 0;
            this.magnetStartPos.copy(this.mesh.position);
            this.magnetStartVel.copy(this.velocity);
            
            // Dynamic Duration based on distance (Smoother for long range, snappy for close)
            const dist = this.mesh.position.distanceTo(target.mesh.position);
            this.magnetDuration = Math.max(0.15, Math.min(0.4, dist / 15.0));
            
            // Kill physics
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // Notify player immediately so they stop chasing and play animation
            if (target.receiveBall) {
                target.receiveBall();
            }

this.reveal();
            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch', { volume: 0.6 });
            }
        }

updateMagnetized(dt) {
            if (!this.magnetTarget || !this.magnetTarget.mesh) {
                this.drop();
                return;
            }

            this.magnetTimer += dt;
            
            // Normalized Time
            let t = this.magnetTimer / this.magnetDuration;
            if (t > 1.0) t = 1.0;

            // Target "Virtual Hand" Position (Front of Chest)
            const holderPos = this.magnetTarget.mesh.position;
            const holderQuat = this.magnetTarget.mesh.quaternion;
            
            // Offset: Forward 0.6, Up 1.0 (Chest height)
            const offset = _bVec.set(0, 1.0, 0.6).applyQuaternion(holderQuat);
            const targetPos = offset.add(holderPos);

            // --- QUADRATIC BEZIER CURVE ---
            // P0 = Start, P2 = Target
            // P1 = Control Point (Projected along initial velocity to preserve momentum feel)
            
            const p0 = this.magnetStartPos;
            const p2 = targetPos;
            
            // Calculate P1 (Control Point)
            // Project forward from P0 along start velocity vector
            // Distance of projection = 40% of total distance to target
            const dist = p0.distanceTo(p2);
            const p1 = _tempVec.copy(p0);
            
            const velLen = this.magnetStartVel.lengthSq();
            if (velLen > 1.0) {
                // Use velocity tangent
// Use velocity tangent
                _bDir.copy(this.magnetStartVel).normalize();
                p1.add(_bDir.multiplyScalar(dist * 0.4));
            } else {
                // No velocity (stationary ball), arc upwards slightly
                p1.lerp(p2, 0.5);
                p1.y += 1.5; 
            }

            // Bezier: B(t) = (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            const oneMinusT = 1.0 - t;
            const w0 = oneMinusT * oneMinusT;
            const w1 = 2.0 * oneMinusT * t;
            const w2 = t * t;
            
            this.mesh.position.x = (w0 * p0.x) + (w1 * p1.x) + (w2 * p2.x);
            this.mesh.position.y = (w0 * p0.y) + (w1 * p1.y) + (w2 * p2.y);
            this.mesh.position.z = (w0 * p0.z) + (w1 * p1.z) + (w2 * p2.z);

            // Finish
            if (t >= 1.0) {
                this.grab(this.magnetTarget);
            }
        }

updateHeld(dt) {
            // ATTACHED STATE (Virtual Attachment)
            if (!this.holder || !this.holder.mesh) {
                this.drop();
                return;
            }

            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // 1. Try to use Hand Bone if available (Realism)
            if (this.holder.handBone) {
                // Get world position of the hand bone
                this.holder.handBone.getWorldPosition(this.mesh.position);
                
                // Adjust slightly to sit IN the hand rather than ON the wrist
                // We can't easily know "forward" for the bone without more info, 
                // but usually GLTF bones are oriented. For now, exact bone pos is better than chest.
            } else {
                // 2. Fallback: Calculate "Carrying" Position (Right Hand Side)
                // Relative to player: Up 0.8 (Waist/Chest), Right 0.4, Forward 0.5
                const holderPos = this.holder.mesh.position;
                const holderQuat = this.holder.mesh.quaternion;
                
                // Reuse _bVec
// Reuse _bVec
                // Offset: x=0.35 (Right), y=1.3 (Chest/Hands), z=0.5 (Forward)
                _bVec.set(0.35, 1.3, 0.5).applyQuaternion(holderQuat);
                this.mesh.position.copy(holderPos).add(_bVec);
            }

// Visual Flair: Spin the ball slowly
            const rotX = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), 2 * dt);
            const rotY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), 5 * dt);
            this.accumulatedRotation.multiply(rotX).multiply(rotY);
        }


updateFree(dt) {
            // Legacy wrapper
            this._updateFreePhysics(dt);
            this._updateParticles(dt);
            this._updateVisualTransforms(dt);
        }

_updateFreePhysics(dt) {
            // Homing Logic (Steering)
            if (this.homingTarget && this.velocity.lengthSq() > 1.0) {
                _tempVec.subVectors(this.homingTarget, this.mesh.position).normalize();
                const currentSpeed = this.velocity.length();
                const steerRate = 2.5 * dt; // Turn rate
                this.velocity.lerp(_tempVec.multiplyScalar(currentSpeed), steerRate);
                this.velocity.normalize().multiplyScalar(currentSpeed); // Maintain speed
            }

const C = window.flux.BallConfig || {};
const substeps = (C.SUBSTEPS || 1);
            const stepDt = dt / substeps;

            for (let s = 0; s < substeps; s++) {
                // A) Magnus effect
                if (C.MAGNUS_ENABLED && this.angularVelocity && this.velocity) {
                    const spinSq = this.angularVelocity.lengthSq();
                    const velSq = this.velocity.lengthSq();
                    if (spinSq > 0.25 && velSq > 0.25) {
                        _magnusVec.copy(this.angularVelocity).cross(this.velocity).multiplyScalar((C.MAGNUS_COEFF || 0) * stepDt);
                        const cap = (C.MAGNUS_CAP !== undefined ? C.MAGNUS_CAP : 60.0);
                        const magLen = _magnusVec.length();
                        if (magLen > cap) _magnusVec.multiplyScalar(cap / magLen);
                        this.velocity.add(_magnusVec);
                    }
                }

                // B) Spin decay
                if (this.angularVelocity) {
                    const spinDrag = Math.max(0, 1.0 - (C.SPIN_DRAG || 0) * stepDt);
                    this.angularVelocity.multiplyScalar(spinDrag);
                }

                // C) Depth spring
                const targetY = (C.DEPTH_TARGET_Y !== undefined ? C.DEPTH_TARGET_Y : 0.0);
                const yErr = (this.mesh.position.y - targetY);
                this.velocity.y -= yErr * (C.DEPTH_SPRING || 0) * stepDt;
                this.velocity.y *= Math.max(0, 1.0 - (C.DEPTH_DAMP || 0) * stepDt);

                // D) Drag
                const vLen = this.velocity.length();
                if (vLen > 0.00001) {
                    const lin = (C.WATER_DRAG_LINEAR !== undefined ? C.WATER_DRAG_LINEAR : (C.WATER_DRAG || 0)) * stepDt;
                    const quad = (C.WATER_DRAG_QUAD || 0) * vLen * stepDt;
                    const drag = Math.max(0, 1.0 - lin - quad);
                    this.velocity.multiplyScalar(drag);

                    const stop = (C.STOP_SPEED || 0);
                    if (stop > 0 && this.velocity.lengthSq() < stop * stop) {
                        this.velocity.set(0, 0, 0);
                    }
                }
// End of substep loop moved to end of function

                // E) Move
                _tempVec.copy(this.velocity).multiplyScalar(stepDt);
                this.mesh.position.add(_tempVec);

                // F) Gravity (Global Override)
                const gravity = (C.GRAVITY !== undefined ? C.GRAVITY : 0.0);
                if (gravity !== 0) {
                    this.velocity.y -= gravity * stepDt;
                }

                // G) External Environmental Force (Currents, Vents)
                if (this.externalForce.lengthSq() > 0.001) {
                    this.velocity.addScaledVector(this.externalForce, stepDt);
                }

// H) Stat power decay
                if (this.power > 0) {
                    this.power -= this.decayRate * stepDt;
                    if (this.power < 0) this.power = 0;
                }

                // G) Boundary logic
                const pos = this.mesh.position;
                const distXZ = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
                const boundaryRadius = (C.BOUNDARY_RADIUS !== undefined ? C.BOUNDARY_RADIUS : 33.0);
                let effectiveBoundary = boundaryRadius;

                if (C.GOAL_POCKET_ENABLED) {
                    const inGoalPocket = (Math.abs(pos.x) < (C.GOAL_POCKET_X || 12.0) && Math.abs(pos.z) > (C.GOAL_POCKET_Z || 25.0));
                    if (inGoalPocket) effectiveBoundary = (C.GOAL_POCKET_RADIUS || 45.0);
                }

                const softBuffer = Math.max(0.01, (C.WALL_SOFT_BUFFER !== undefined ? C.WALL_SOFT_BUFFER : 3.0));

                if (distXZ > effectiveBoundary - softBuffer) {
                    const penetration = distXZ - (effectiveBoundary - softBuffer);
                    const ratio = Math.max(0, Math.min(1, penetration / softBuffer));
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) {
                        _tempVec.normalize();
                        const force = ratio * ratio * (C.WALL_SOFT_FORCE || 0) * stepDt;
                        this.velocity.addScaledVector(_tempVec, force);
                    }
                }

                if (distXZ > effectiveBoundary) {
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) _tempVec.normalize();
                    const overlap = distXZ - effectiveBoundary;
                    pos.addScaledVector(_tempVec, overlap);
                    const vDotN = this.velocity.dot(_tempVec);
                    if (vDotN < 0) {
                        const impactSpeed = Math.abs(vDotN);
                        if (impactSpeed > 10.0 && window.flux.triggerArenaImpact) {
                            window.flux.triggerArenaImpact(pos, Math.min(impactSpeed * 0.5, 15.0));
                            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                                window.flux.gameInstance.audioManager.playSFX('impact', { volume: Math.min(1.0, impactSpeed * 0.05) });
                            }
                        }
const e = (this.isRicochet ? 0.95 : (C.WALL_ELASTICITY !== undefined ? C.WALL_ELASTICITY : 0.3));
                        const impulse = _tempVec.clone().multiplyScalar(-vDotN * (1.0 + e));
                        this.velocity.add(impulse);
                        
                        // Ricochet Spin Kick
                        if (this.isRicochet && this.angularVelocity.lengthSq() > 1.0) {
                            const spinForce = _tempVec.cross(this.angularVelocity).normalize().multiplyScalar(5.0);
                            this.velocity.add(spinForce);
                        }

const friction = (C.WALL_FRICTION !== undefined ? C.WALL_FRICTION : 0.95);
                        const tangent = this.velocity.clone().projectOnPlane(_tempVec);
                        this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
                        this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
                    }
                }

                const bh = (C.BOUNDARY_HEIGHT !== undefined ? C.BOUNDARY_HEIGHT : 15.0);
                if (Math.abs(pos.y) > bh) {
                    const sign = Math.sign(pos.y) || 1;
                    pos.y = bh * sign;
                    const fe = (C.FLOOR_ELASTICITY !== undefined ? C.FLOOR_ELASTICITY : 0.4);
                    this.velocity.y *= -fe;
                }
// End of substep loop scope
} // End of substep loop
        }


        _updateParticles(dt) {
            if (this._ghost) return;
            
            const speedSq = this.velocity.lengthSq();
            this._bubbleTimer -= dt;

            // --- ELEMENTAL TRAILS ---
            if (this.element && speedSq > 5.0) {
                this._elementalTimer -= dt;
                if (this._elementalTimer <= 0) {
                    const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;
                    if (pm) {
                        const offset = this.velocity.clone().normalize().multiplyScalar(-0.5);
                        const pos = this.mesh.position.clone().add(offset);
                        if (this.deformNode) pos.y += this.deformNode.position.y;
                        
                        // Jitter
                        pos.x += (Math.random() - 0.5) * 0.5;
                        pos.y += (Math.random() - 0.5) * 0.5;
                        pos.z += (Math.random() - 0.5) * 0.5;

                        let pType = null;
                        let pScale = 1.0;
                        let pInterval = 0.1;

                        if (this.element === 'fire') { pType = 'fire'; pScale = 0.8; pInterval = 0.05; }
                        else if (this.element === 'ice') { pType = 'ice'; pScale = 0.6; pInterval = 0.08; }
                        else if (this.element === 'volt') { pType = 'volt'; pScale = 0.7; pInterval = 0.04; }
                        else if (this.element === 'venom') { pType = 'venom'; pScale = 0.4; pInterval = 0.1; }
                        else if (this.element === 'wither') { pType = 'wither'; pScale = 0.5; pInterval = 0.1; }
                        else if (this.element === 'nap') { pType = 'nap'; pScale = 0.4; pInterval = 0.15; }

                        if (pType) {
                            pm.spawn(pType, pos, { scale: pScale, emitterVelocity: this.velocity.clone().multiplyScalar(0.2) });
                            this._elementalTimer = pInterval;
                        }
                    }
                }
            }

            // Continuous Bubble Stream (The "Damn Blitzball" Effect)
            if (speedSq > 1.0 && this._bubbleTimer <= 0) {
                const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;
                if (pm) {
                    // Calculate emission frequency based on speed
                    // Fast = very frequent (0.01s), Slow = less frequent (0.05s)
                    const speedRatio = Math.min(1.0, speedSq / 100.0);
                    this._bubbleTimer = 0.05 - (0.04 * speedRatio); 

                    const offset = this.velocity.clone().normalize().multiplyScalar(-0.6);
                    const basePos = this.mesh.position.clone().add(offset);
                    if (this.deformNode) basePos.y += this.deformNode.position.y;

                    // 1. Micro Bubbles (The tight stream)
                    // Spawn a cluster for density
                    const count = 1 + Math.floor(speedRatio * 3);
                    for(let i=0; i<count; i++) {
                        const jitter = new THREE.Vector3(
                            (Math.random()-0.5) * 0.4,
                            (Math.random()-0.5) * 0.4,
                            (Math.random()-0.5) * 0.4
                        );
                        pm.spawn('bubble_micro', basePos.clone().add(jitter), {
                            scale: 0.05 + Math.random() * 0.08,
                            life: 0.4 + Math.random() * 0.4,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.1
                        });
                    }

                    // 2. Main Bubbles (Occasional larger ones)
                    if (Math.random() < 0.4) {
                        const jitter = new THREE.Vector3(
                            (Math.random()-0.5) * 0.6,
                            (Math.random()-0.5) * 0.6,
                            (Math.random()-0.5) * 0.6
                        );
                        pm.spawn('bubble', basePos.clone().add(jitter), {
                            scale: 0.2 + Math.random() * 0.3,
                            life: 0.8 + Math.random() * 0.6,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.05
                        });
                    }

                    // 3. High Speed Cavitation (Jet Stream)
                    if (speedSq > 80.0) {
                        pm.spawn('dash_stream', basePos, { 
                            scale: 1.5, 
                            life: 0.2,
                            emitterVelocity: this.velocity,
                            momentumScale: 0.02,
                            color: 0xaaccff
                        });
                    }
                }
            }

            // --- VISUAL REACTION TO EXTERNAL FORCES (Currents) ---
            if (this.externalForce.lengthSq() > 5.0 && Math.random() < 0.3) {
                const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;
                if (pm) {
                    const pos = this.mesh.position.clone();
                    pos.x += (Math.random() - 0.5) * 2.0;
                    pos.y += (Math.random() - 0.5) * 2.0;
                    pos.z += (Math.random() - 0.5) * 2.0;
                    
                    // Particles moving with the current
                    pm.spawn('bubble_micro', pos, {
                        life: 0.5,
                        scale: 0.1,
                        emitterVelocity: this.externalForce.clone().multiplyScalar(2.0),
                        momentumScale: 1.0,
                        color: 0x88ffff
                    });
                }
            }
        }

// Stray code block removed

grab(player) {
            this.reveal(); 
            
            // Announcement: Possession (if taking from free state)
            if (this.state === 'free') {
                 if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                     window.flux.gameInstance.showAnnouncement("POSSESSION", "normal");
                 }
            }

            // Check Turnover (Possession Change)
            const previousTeam = this.holder ? this.holder.team : (this.lastHolder ? this.lastHolder.team : null);
            if (previousTeam && previousTeam !== player.team) {
                 if (window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                     window.flux.gameInstance.floatingText.spawn("TURNOVER", player.mesh.position, "tech");
                 }
            }
            
            // If someone else held it, they lose it
            if (this.holder && this.holder !== player) {
                this.holder.loseBall();
            }

            this.holder = player;
            this.state = 'held';
            
            // NOTE: We do NOT parent the mesh to the player anymore.
            // This prevents the ball from flying around due to swim animations.
            // Instead, we update its position manually in updateHeld().
            
            // Notify player
            if (player.receiveBall) {
                player.receiveBall();
            }
            
            console.log("Ball grabbed by " + player.role);
        }

        drop() {
            this.reveal(); // Ensure visible
            
            // No need to detach from scene graph since we aren't parenting to player anymore.
            // Just clear holder.

            if (this.holder) {
                if (this.holder.loseBall) this.holder.loseBall();
                this.holder = null;
            }
            
            this.state = 'free';
        }
// Shoot/Pass
// Shoot/Pass
        shoot(directionVector, force, type = 'SH', technique = null, spinVector = null) {

            this.lastHolder = this.holder; // Record for EXP attribution
            
            // Fumble Detection (Type 'none' is used by Player.fumble)
            if (type === 'none') {
                if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                    window.flux.gameInstance.showAnnouncement("FUMBLE!", "slam");
                }
}

            this.isRicochet = (type === 'RICOCHET' || (technique && technique.type === 'ricochet'));
            this.homingTarget = null;

            this.drop(); // Detach first

// Set Grace Period to prevent instant interceptions/catches
            // Set Grace Period to prevent instant interceptions/catches
            // 0.2s allows ball to clear the thrower's immediate vicinity
            this.catchGracePeriod = 0.2;

            // Physical Velocity (Visual speed)
            const C = window.flux.BallConfig || {};
            const scale = (C.LAUNCH_SPEED_SCALE !== undefined ? C.LAUNCH_SPEED_SCALE : 1.0);
            const cap = (C.LAUNCH_SPEED_CAP !== undefined ? C.LAUNCH_SPEED_CAP : 85.0);
            const speed = Math.min(force * scale, cap);
this.velocity.copy(directionVector).normalize().multiplyScalar(speed);
            
            if (type === 'LOB') {
                this.velocity.multiplyScalar(0.7); // Slower forward
                this.velocity.y = 18.0; // High vertical pop
                if (!spinVector) this.angularVelocity.set(-15, 0, 0); // Backspin
            }

            if (type === 'HOMING' || (technique && technique.type === 'homing')) {
                const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                const targetZ = (this.velocity.z > 0) ? goalDist : -goalDist;
                this.homingTarget = new THREE.Vector3(0, 0, targetZ);
                if (technique && technique.targetPos) {
                    this.homingTarget.copy(technique.targetPos);
                }
            }

            // Apply Spin if provided
            
// Apply Spin if provided
            if (spinVector) {
                this.angularVelocity.copy(spinVector);
            } else {
                this.angularVelocity.set(0, 0, 0);
            }
            
            // Stat Power (Game Logic)
            this.power = force;
            this.powerType = type;
this.powerType = type;
            
            // Determine Element
            this.element = null;
            if (technique) {
                if (technique.element) this.element = technique.element;
                else if (['fire', 'ice', 'volt', 'venom', 'wither', 'nap'].includes(technique.type)) {
                    this.element = technique.type;
                }
            }

            // Update Trail Color
            if (this.trail) {
                let color = 0x00aaff; // Default Blue (Pass)
                
                if (this.element) {
                     if (this.element === 'fire') color = 0xff4400;
                     else if (this.element === 'ice') color = 0xaaddff;
                     else if (this.element === 'volt') color = 0xffff00;
                     else if (this.element === 'venom') color = 0x00ff00;
                     else if (this.element === 'wither') color = 0x888888;
                     else if (this.element === 'nap') color = 0x000088;
                } else if (technique) {
                    if (technique.type === 'sphere') color = 0x00ffff; // Cyan
                    else if (technique.type === 'jecht') color = 0xff0000; // Red
                    else if (technique.type === 'invisible') color = 0x444444; // Dark Grey
                } else if (type === 'SH') {
                    color = 0xff4400; // Orange/Red
                }
                
                this.trail.setColor(color);
            }
            
            // Handle Invisible Shot
            if (technique && technique.type === 'invisible') {
                this.isInvisible = true;
                if (this.mesh) this.mesh.visible = false;
                // FX: Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
                console.log("Invisible Shot!");
            }
            
            console.log(`Ball ${type} with Power: ${this.power.toFixed(1)} Spin: ${this.angularVelocity.length().toFixed(1)}`);
            
            // Visual Feedback for Curve
            if (this.angularVelocity.length() > 15.0 && window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CURVE!", this.mesh.position, "tech");
            }
        }

        reveal() {
            if (this.isInvisible) {
                // FX: Reveal Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager && this.mesh) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
            }
            this.isInvisible = false;
            if (this.mesh) this.mesh.visible = true;
        }


reset() {
            this.reveal();
            this.drop();
            this.mesh.position.set(0, 0, 0);
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.externalForce.set(0, 0, 0);
            this.catchGracePeriod = 0;
            this.power = 0;
            this.element = null;
        }

        setExternalForce(vec) {
            this.externalForce.copy(vec);
        }

        isCatchable() {
            return this.catchGracePeriod <= 0;
        }


_updateVisualTransforms(dt) {
            if (!this.deformNode || !this.spinNode) return;

            // 1. Squash & Stretch based on velocity
            const speed = this.velocity.length();
            
            if (speed > 1.0 && this.state === 'free') {
                const dir = this.velocity.clone().normalize();
                this.deformNode.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), dir);
                
                const factor = Math.min(speed / 40.0, 1.0); 
                const stretch = 1.0 + (factor * 0.8);
                const squash = 1.0 / Math.sqrt(stretch);
                
                this.deformNode.scale.set(squash, squash, stretch);
            } else {
                this.deformNode.quaternion.identity();
                this.deformNode.scale.set(1, 1, 1);
            }

            // 2. Apply Accumulated Spin
            const invDeform = this.deformNode.quaternion.clone().invert();
            this.spinNode.quaternion.copy(invDeform.multiply(this.accumulatedRotation));

            // 3. Visual rotation integration
            const spinSq = this.angularVelocity.lengthSq();
            if (spinSq > 0.01) {
                const spinSpeed = Math.sqrt(spinSq);
                const axis = _tempVec.copy(this.angularVelocity).normalize();
                const q = new THREE.Quaternion().setFromAxisAngle(axis, spinSpeed * dt);
                this.accumulatedRotation.premultiply(q);
            } else {
if (speed > 0.1) {
                    _tempVec.copy(this.velocity).cross(_axisY).normalize();
                    if (_tempVec.lengthSq() > 0.01) {
                        const q = new THREE.Quaternion().setFromAxisAngle(_tempVec, speed * dt);
                        this.accumulatedRotation.premultiply(q);
                    }
                }
            }
        }

        _checkFailsafes(dt) {

            if (!this.mesh) return;
            const C = window.flux.BallConfig || {};
            const maxRadius = (C.BOUNDARY_RADIUS || 46.0) + 15.0; // Generous buffer
            const maxHeight = (C.BOUNDARY_HEIGHT || 20.0) + 15.0;

            const pos = this.mesh.position;
            const distSq = pos.x*pos.x + pos.z*pos.z;

            // 1. Out of Bounds Check
            if (distSq > maxRadius*maxRadius || Math.abs(pos.y) > maxHeight) {
                this.outOfBoundsTimer += dt;
                if (this.outOfBoundsTimer > 1.0) { // 1 second OOB
                    console.warn("Ball OOB detected. Resetting.");
                    this.forceResetToPlay();
                    this.outOfBoundsTimer = 0;
                }
} else {
                this.outOfBoundsTimer = 0;
            }

            // 2. Stuck Check (Free & Stationary)
            // Only check if game is active to avoid resetting during cutscenes/menus
            const game = window.flux.gameInstance;
            if (game && game.state === 'active' && this.state === 'free' && this.velocity.lengthSq() < 0.05) {
                this.stuckTimer += dt;
                if (this.stuckTimer > 4.0) { // 4 seconds stationary
                    console.warn("Ball stuck stationary. Resetting.");
                    this.forceResetToPlay();
                    this.stuckTimer = 0;
                }
            } else {
                this.stuckTimer = 0;
            }
        }

        forceResetToPlay() {
            this.drop();
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.power = 0;

            // Find nearest player to reset to
            let nearest = null;
            let minDst = Infinity;
            const game = window.flux.gameInstance;
            let targetPos = new THREE.Vector3(0, 0, 0); // Default center

            if (game) {
                const allPlayers = [];
                if (game.teams.home) allPlayers.push(...game.teams.home.players);
                if (game.teams.away) allPlayers.push(...game.teams.away.players);
                
                allPlayers.forEach(p => {
                    if (p.mesh) {
                        const d = p.mesh.position.distanceTo(this.mesh.position);
                        if (d < minDst) {
                            minDst = d;
                            nearest = p;
                        }
                    }
                });
            }

            if (nearest && nearest.mesh) {
                // Ensure player is within reasonable bounds before teleporting ball to them
                const pPos = nearest.mesh.position;
if (pPos.lengthSq() < 60*60) { // Within 60m radius
                    const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(nearest.mesh.quaternion).normalize();
                    targetPos.copy(pPos).add(fwd.multiplyScalar(2.0));
                    targetPos.y = Math.max(0, pPos.y + 1.0);
                }
            }

            this.mesh.position.copy(targetPos);
            
            if (game && game.particleManager) {
                game.particleManager.spawn('flash', this.mesh.position, { scale: 3.0 });
            }
            if (game && game.floatingText) {
                game.floatingText.spawn("RESET", this.mesh.position, "tech");
            }
}
    }
window.flux.Ball = Ball;
    window.flux.TrailRenderer = TrailRenderer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MiniMap {
        constructor() {
            this.container = document.getElementById('minimap');
            this.canvas = document.createElement('canvas');
            // Optimization: alpha: true is needed for transparent background
            this.ctx = this.canvas.getContext('2d', { alpha: true });
            
            // High DPI scaling (2x for retina sharpness on 100px container)
            this.size = 200; 
            this.canvas.width = this.size;
            this.canvas.height = this.size;
            
            Object.assign(this.canvas.style, {
                width: '100%',
                height: '100%',
                borderRadius: '50%',
                display: 'block'
            });
            
            if (this.container) {
                // Remove any existing children (e.g. from previous inits)
                while (this.container.firstChild) {
                    this.container.removeChild(this.container.firstChild);
                }
                this.container.appendChild(this.canvas);
            }

            this.worldRadius = 30; // Arena radius
            this.homeTeam = null;
            this.awayTeam = null;
            this.ball = null;
        }

        init(homeTeam, awayTeam, ball) {
            this.homeTeam = homeTeam;
            this.awayTeam = awayTeam;
            this.ball = ball;
        }

        update() {
            if (!this.ctx) return;

            const ctx = this.ctx;
            const size = this.size;
            const center = size / 2;
            // Map world radius (30) to canvas radius (approx 90px to leave padding)
            const scale = (center - 10) / this.worldRadius; 

            ctx.clearRect(0, 0, size, size);

            // Helper to draw entities
            const drawEntity = (entity, color, radius, isRing = false) => {
                if (!entity.mesh) return;
                
                // Skip if explicitly invisible (e.g. Ball invisible shot, or Practice dummies)
                if (entity.isInvisible) return;
                if (entity.mesh.visible === false) return;

                const pos = entity.mesh.position;
                
                // Map Logic: -Z is Top (Home Attack), +Z is Bottom
                // Canvas: 0,0 is Top-Left.
                // Center is 100,100.
                // World X -> Canvas X
                // World Z -> Canvas Y
                
                let dx = pos.x * scale;
                let dy = pos.z * scale;

                // Clamp to circular bounds
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = center - radius - 2;
                
                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }

                const x = center + dx;
                const y = center + dy;

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                
                if (isRing) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else {
                    ctx.fillStyle = color;
                    ctx.fill();
                }
            };

            // Draw Home Team
            if (this.homeTeam) {
                const active = this.homeTeam.activePlayer;
                for (let i = 0; i < this.homeTeam.players.length; i++) {
                    const p = this.homeTeam.players[i];
                    let color = '#60c0d0'; // Cyan
                    let r = 6; // 2x scale of 3px

                    if (p.status && p.status.nap > 0) color = '#333333';
                    
                    if (p === active) {
                        color = '#00ff00';
                        r = 8;
                    } else if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);
                    
                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Away Team
            if (this.awayTeam) {
                for (let i = 0; i < this.awayTeam.players.length; i++) {
                    const p = this.awayTeam.players[i];
                    let color = '#ff4444';
                    let r = 6;

                    if (p.status && p.status.nap > 0) color = '#333333';
                    if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);

                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Ball (if free)
            if (this.ball && this.ball.state === 'free') {
                drawEntity(this.ball, '#ff00cc', 7);
                drawEntity(this.ball, '#ffffff', 9, true);
            }
        }
    }

    window.flux.MiniMap = MiniMap;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Spark Texture (Procedural Burst)
    const _sparkTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,64,64);
        
        // Burst shape
        const cx = 32, cy = 32;
        const spikes = 8;
        const outer = 30;
        const inner = 10;
        
        ctx.beginPath();
        for(let i=0; i<spikes*2; i++){
            const r = (i%2===0)? outer : inner;
            const a = (Math.PI*i)/spikes;
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.closePath();
        ctx.fillStyle = '#ffcc00';
        ctx.fill();
        
        // White Core
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    const _sparkMaterial = new THREE.SpriteMaterial({ 
        map: _sparkTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class GameManager {

        
constructor(scene, uiLayerId, camera, renderer) {
            this.scene = scene;
            this.camera = camera;
            this.uiLayer = document.getElementById(uiLayerId);
            
            this.score = { home: 0, away: 0 };
            this.time = 0;
            this.half = 1;
            this.halfDuration = 300; // 5 minutes (seconds)
            this.isOvertime = false;
            this.isDemoMode = false;
this.gameMode = 'normal'; // 'normal' or 'practice'
            this.isForgeMode = false; // Asset Forge State
            // Impact Frames
this.impactPause = 0;
            // --- HUD Shake System ---
            this.hudShakeIntensity = 0;
this._hudShakeDirty = false;
            
            this.stateTimer = 0;
            this.nextStatePayload = null;

            this.state = 'menu'; // Start in menu
this.teams = {
                home: null,
                away: null
            };
            
            this.entities = {
                ball: null
            };

this.ui = {
                scorePlayer: null,
                scoreCpu: null,
                timer: null,
                half: null,
                announcement: null,
                // Player Status Panel
                statusPanel: {
                    container: null,
                    name: null,
                    hpBar: null,
                    hpText: null,
                    expBar: null
                }
            };

            // Techcopy State
            this.techCopyState = {
                active: false,
                timer: 0,
                tech: null,
                learners: []
            };

this.miniMap = new window.flux.MiniMap();
            
            // Initialize Floating Text
// Initialize Floating Text
            this.floatingText = new window.flux.FloatingTextManager(scene, uiLayerId, camera);
            
            // Reusable vector for UI calculations
            this._tempVec = new THREE.Vector3();

            // Initialize Particle Manager (Status Effects)
            
// Initialize Particle Manager (Status Effects)
            this.particleManager = new window.flux.ParticleManager(scene);
this.glyphManager = null; // Injected by main.js
this._initCinematics();
            this._initParticles(); // 3D Spark System (Legacy/Impact)

this.debugVisualizer = new window.flux.DebugVisualizer(scene);
this.debugVisualizer = new window.flux.DebugVisualizer(scene);
            this.powerUpManager = new window.flux.PowerUpManager(scene, this);
            
            // Initialize Arena Theme Manager & Apply Default
            this.arenaThemeManager = new window.flux.ArenaThemeManager(scene, this);
            this.arenaThemeManager.setTheme('STANDARD');

            this.practiceManager = new window.flux.PracticeManager(this); // Initialize Practice Manager
            this._injectStyles();
this._initUI();
        }

_initCinematics() {
            // Menu Background Shots (B-Roll)
            this.menuShotIndex = 0;
            this.menuShotTimer = 0;
            this.menuShots = [
                { duration: 10.0, update: (t, cam) => { cam.position.set(60, 35, 60).lerp(new THREE.Vector3(40, 25, 40), t); cam.lookAt(0, 0, 0); } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(-25, 6, -25 + 50*t); cam.lookAt(0, 2, (-25 + 50*t)*0.8); } },
                { duration: 8.0, update: (t, cam) => { const a = t+3.5; cam.position.set(-10+Math.cos(a)*10, 4, -10+Math.sin(a)*10); cam.lookAt(-10, 1.5, -10); } },
                { duration: 7.0, update: (t, cam) => { cam.position.set(0, -5, 32).lerp(new THREE.Vector3(0, 8, 20), t); cam.lookAt(0, 15, 45); cam.rotation.z = (t-0.5)*0.15; } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(0, 50, 0).lerp(new THREE.Vector3(0, 10, 0), t*t*(3-2*t)); cam.lookAt(0, 0, 0); cam.rotation.z = t*0.8; } }
            ];

            // Epic Intro Sequence ("Herculean")
            this.introShots = [
                // 1. "The Awakening" - Close on Sphere -> Zoom Out Upside Down -> Lights & Roar
                {
                    duration: 8.0,
                    onStart: () => { 
                        this.showAnnouncement("THE SPHERE POOL", "slam"); 
                        if(this.stadium) this.stadium.resetLights(); // Ensure dark start
                        this._hasRoared = false;
                        
                        // Ambient start sound (Deep hum / Underwater feel)
                        if(this.audioManager) this.audioManager.playSFX('swim', { volume: 1.0, rate: 0.3 });
                    },
                    update: (t, cam) => {
                        // Easing
                        const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        const expT = Math.pow(t, 3.0); // Strong exponential zoom out

                        // Camera Motion: Start INSIDE/CLOSE (0,0,2) -> End FAR BACK/UP (0, 80, 160)
                        const startPos = new THREE.Vector3(0, 0, 2); 
                        const endPos = new THREE.Vector3(0, 80, 160); 
                        
                        cam.position.lerpVectors(startPos, endPos, expT);
                        cam.lookAt(0, 0, 0);

                        // Dynamic Roll: Turn upside down (0 -> PI)
                        cam.rotation.z = ease * Math.PI; 

                        // Light Sequencing & Sound
                        if (this.stadium) {
                            const total = this.stadium.lightCount;
                            const lightProgress = Math.max(0, (t - 0.2) / 0.6);
                            const activeCount = Math.floor(lightProgress * total);
                            
                            // Trigger "Roar to Life"
                            if (lightProgress > 0.5 && !this._hasRoared) {
                                this._hasRoared = true;
                                if(this.audioManager) {
                                    this.audioManager.playSFX('goal', { volume: 1.0, rate: 0.7 }); // Deep roar
                                    this.audioManager.playSFX('dash', { volume: 0.8, rate: 0.5 }); // Whoosh
                                }
                                if (this.cameraManager) this.cameraManager.addShake(1.5);
                            }

                            for(let i=0; i < total; i++) {
                                if (i <= activeCount) {
                                    const sprite = this.stadium.lightSprites[i];
                                    if (sprite && !sprite.visible) {
                                        this.stadium.turnOnLight(i);
                                        
                                        // Industrial Light SFX
                                        if(this.audioManager) {
                                            const pitch = 0.5 + (i / total) * 0.5; 
                                            this.audioManager.playSFX('impact', { volume: 0.4, rate: pitch, variance: 0.0 });
                                        }
                                        if (this.cameraManager) this.cameraManager.addShake(0.2);
                                    }
                                }
                            }
                        }
                    }
                },
                // 2. "The Roar" - Sweeping crowd shot
                {
                    duration: 4.0,
                    onStart: () => {
                        this.showAnnouncement("LEGENDARY ARENA", "normal");
                        if(this.cameraManager) this.cameraManager.addShake(1.0);
                        if(this.audioManager) this.audioManager.playSFX('goal', { volume: 0.7 }); // Crowd cheer
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;
                        
                        const angle = -Math.PI/2 + (t * Math.PI * 0.5);
                        const r = isPortrait ? 85 : 65; // Pull back in portrait
                        
                        cam.position.set(Math.cos(angle)*r, 15, Math.sin(angle)*r);
                        cam.lookAt(0, 5, 0);
                    }
                },
                // 3. "Home Glory" - Orbit Home Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("BESAID AUROCHS", "slam");
                        if(this.teams.home) this.teams.home.players.forEach(p => p.play('celebrate', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Orbit Home Team (Side 1, -Z)
                        const center = new THREE.Vector3(0, 0, -20);
                        const angle = Math.PI + (t * 1.5);
                        const r = isPortrait ? 20 : 12; // Pull back if portrait
                        cam.position.set(center.x + Math.cos(angle)*r, 4, center.z + Math.sin(angle)*r);
                        cam.lookAt(center.x, 2, center.z);
                    }
                },
                // 4. "Enemy Gates" - Tracking Away Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("LUCA GOERS", "slam");
                        if(this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Tracking Away Team (Side -1, +Z)
                        const start = new THREE.Vector3(-15, 2, 25);
                        const end = new THREE.Vector3(15, 2, 25);
                        
                        if (isPortrait) {
                            start.x *= 1.5; end.x *= 1.5;
                            start.z += 10; end.z += 10;
                        }

                        cam.position.lerpVectors(start, end, t);
                        cam.lookAt(0, 3, 25);
                    }
                },
                // 5. "The Sphere" - Zoom to center
                {
                    duration: 2.0,
                    onStart: () => {
                        this.showAnnouncement("BLITZ OFF!", "slam");
                        if(this.stadium) this.stadium.setAllLights(true);
                        if(this.audioManager) this.audioManager.playSFX('whistle', { volume: 0.8 });
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        const p1 = new THREE.Vector3(0, 30, isPortrait ? 70 : 50);
                        const p2 = new THREE.Vector3(0, 14, 22); // Gameplay cam
                        const st = t * t;
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                    }
                }
            ];
        }

        _injectStyles() {
            if (document.getElementById('flux-dynamic-styles')) return;
            const style = document.createElement('style');
            style.id = 'flux-dynamic-styles';
style.textContent = `
                @keyframes textSlam {
                    0% { transform: translate(-50%, -50%) scale(4); opacity: 0; letter-spacing: 50px; }
                    10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 5px; }
                    15% { transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0px); }
                    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(10px); }
                }
                
                .announcement-slam {
                    position: absolute;
                    top: 45%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%;
                    text-align: center;
                    font-family: 'Impact', sans-serif;
                    font-size: 96px;
                    font-style: italic;
                    text-transform: uppercase;
                    background: linear-gradient(to bottom, #ffffff 0%, #ffdd00 45%, #ff8800 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    filter: drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(255, 100, 0, 0.6));
                    z-index: 2000;
                    animation: textSlam 1.8s cubic-bezier(0.1, 0.8, 0.1, 1) forwards;
                    pointer-events: none;
                    white-space: nowrap;
                }

                .modal-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle at center, rgba(10, 25, 60, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
                    display: flex; justify-content: center; align-items: center; flex-direction: column;
                    z-index: 1900;
                    opacity: 0; pointer-events: none; transition: opacity 0.8s;
                    backdrop-filter: blur(8px);
                }
                .modal-overlay.active { opacity: 1; pointer-events: auto; }
                
                .modal-title {
                    font-family: 'Garamond', serif;
                    font-size: 52px; color: #fff;
                    text-transform: uppercase;
                    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #00aaff;
                    padding-bottom: 10px;
                    width: 80%; text-align: center;
                    letter-spacing: 5px;
                }
                
                .modal-score-container {
                    display: flex; align-items: center; gap: 40px;
                    margin-bottom: 40px;
                }
                .modal-score {
                    font-family: 'Impact', sans-serif;
                    font-size: 80px; color: #ffd700;
                    letter-spacing: 5px;
                    text-shadow: 0 0 20px #b8860b;
                }
                .modal-vs {
                    font-family: 'Courier New', monospace;
                    font-size: 24px; color: #00aaff; opacity: 0.7;
                }

                .flash-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: white;
                    z-index: 2100;
                    opacity: 0; pointer-events: none;
                    transition: opacity 0.1s ease-out;
                    mix-blend-mode: overlay;
                }

                @keyframes clashPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
                }

                .clash-spark {
                    position: absolute;
                    width: 60px; height: 60px;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 40%, transparent 70%);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1500;
                    mix-blend-mode: screen;
                    animation: clashPop 0.3s ease-out forwards;
                    box-shadow: 0 0 20px #ffaa00;
                }

                @keyframes wingPulse {
                    0% { filter: brightness(1); }
                    15% { filter: brightness(1.5) drop-shadow(0 0 15px rgba(255,255,255,0.5)); }
                    100% { filter: brightness(1); }
                }
                .wing-pulse {
                    animation: wingPulse 0.4s ease-out;
                }
            `;
            document.head.appendChild(style);
        }

        registerTeams(homeTeam, awayTeam, ball) {
            this.teams.home = homeTeam;
            this.teams.away = awayTeam;
this.entities.ball = ball;
            
            // Initialize MiniMap
            if (this.miniMap) {
                this.miniMap.init(homeTeam, awayTeam, ball);
            }
        }

_initUI() {
            // Bind to existing HTML elements (Herculean HUD)
            this.ui.scorePlayer = document.getElementById('score-player');
            this.ui.scoreCpu = document.getElementById('score-cpu');
            this.ui.timer = document.getElementById('timer-display');
            this.ui.half = document.getElementById('half-indicator');
            
            // Bind Wings for Juice
            this.ui.wingHome = document.querySelector('.sb-wing.home');
            this.ui.wingAway = document.querySelector('.sb-wing.away');
            // Techcopy UI bindings
            this.ui.techFlash = document.getElementById('tech-flash-overlay');
            if (this.ui.techFlash) {
                this.ui.techSub = this.ui.techFlash.querySelector('.tech-sub-text');
                this.ui.techTimerFill = this.ui.techFlash.querySelector('.tech-timer-fill');
            }

            // Bind Player Status Panel
            this.ui.statusPanel.container = document.getElementById('player-status-panel');
            if (this.ui.statusPanel.container) {
                this.ui.statusPanel.name = this.ui.statusPanel.container.querySelector('.char-name');
                this.ui.statusPanel.hpBar = this.ui.statusPanel.container.querySelector('.hp-bar-fill');
                this.ui.statusPanel.hpText = this.ui.statusPanel.container.querySelector('.hp-value');
                this.ui.statusPanel.expBar = this.ui.statusPanel.container.querySelector('.tech-bar-fill');
            }
            
            // End Game Menu Bindings
            this.ui.endMenu = document.getElementById('end-game-menu');
            const btnRematch = document.getElementById('end-btn-rematch');
            const btnExit = document.getElementById('end-btn-exit');

            if (btnRematch) {
                btnRematch.addEventListener('click', () => {
                    this._hideEndMenu();
                    this.startMatch(this.gameMode);
                });
            }
            if (btnExit) {
                btnExit.addEventListener('click', () => {
                    this._hideEndMenu();
                    if (window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        this.state = 'menu';
                    }
                });
            }

            // Create Modal Overlay (For Halftime only now)
            this.ui.modal = document.createElement('div');
            this.ui.modal.className = 'modal-overlay';
            this.ui.modal.innerHTML = `
                <div class="modal-title">HALF TIME</div>
                <div class="modal-score-container">
                    <div class="modal-score" id="modal-score-home">0</div>
                    <div class="modal-vs">-</div>
                    <div class="modal-score" id="modal-score-away">0</div>
                </div>
                <div id="modal-msg" style="color: #00aaff; font-size: 14px; letter-spacing: 2px;">PREPARING 2ND HALF...</div>
            `;
            this.uiLayer.appendChild(this.ui.modal);

            // Create Flash Overlay
            this.ui.flash = document.createElement('div');
            this.ui.flash.className = 'flash-overlay';
            this.uiLayer.appendChild(this.ui.flash);

            // Initial State
            if (this.ui.timer) this.ui.timer.innerText = "00:00";
            if (this.ui.half) this.ui.half.innerText = "1st";
            
            this._updateScoreUI(true); // Force initial render without animation
            this._hideEndMenu();
        }

_updateScoreUI(skipAnimation = false) {
            const homeEl = this.ui.scorePlayer;
            const awayEl = this.ui.scoreCpu;
            const homeWing = this.ui.wingHome;
            const awayWing = this.ui.wingAway;

            // Helper to animate (Slam Effect)
            const updateElement = (el, wing, newVal) => {
                const oldVal = parseInt(el.innerText) || 0;
                
                // Only update if changed or forced
                if (newVal !== oldVal || skipAnimation) {
                    el.innerText = newVal;
                    
                    if (!skipAnimation) {
                        // Trigger Reflow for Animation Restart
                        el.classList.remove('score-update');
                        void el.offsetWidth; // Force reflow
                        el.classList.add('score-update');
                        
                        if (wing) {
                            wing.classList.remove('wing-pulse');
                            void wing.offsetWidth;
                            wing.classList.add('wing-pulse');
                        }
                    } else {
                        // Ensure clean state on init
                        el.classList.remove('score-update');
                        if (wing) wing.classList.remove('wing-pulse');
                    }
                }
            };

            if (homeEl) updateElement(homeEl, homeWing, this.score.home);
            if (awayEl) updateElement(awayEl, awayWing, this.score.away);
        }

updatePractice(dt) {
            // Delegate logic to PracticeManager
            if (this.practiceManager) {
                this.practiceManager.update(dt);
            }
        }

update(dt) {
            // --- STATE TIMER LOGIC ---
            if (this.stateTimer > 0) {
                this.stateTimer -= dt;
if (this.stateTimer <= 0) {
                    this._advanceState();
                }
            }

            // --- PHYSICS & LOGIC UPDATE (Fixed Timestep) ---
            
            // Intro & Menu are purely visual states, handled in updateVisuals
            if (this.state === 'intro' || this.state === 'menu') return;

            if (this.state === 'blitz_charge') {
                this._updateBlitzCharge(dt);
                return;
            }
            if (this.state === 'blitz_launch') {
                this._updateBlitzLaunch(dt);
                return;
            }

if (this.state === 'active') {
                this.time += dt;
                this._updateTimer();
                this._checkHalfTime();
            }

            this._checkGoals();
            
            // Update Techcopy Logic (Timer)
            if (this.techCopyState.active) {
                this.techCopyState.timer -= dt;
                if (this.techCopyState.timer <= 0) {
                    this.endTechCopyWindow(false);
                }
}
            // Update PowerUps
// Update PowerUps
// Update PowerUps
            if (this.powerUpManager) {
                this.powerUpManager.update(dt);
            }
            
            // Update Arena Hazards (Physics)
            if (this.arenaThemeManager) {
                this.arenaThemeManager.update(dt);
            }
        }

        updateVisuals(dt) {

            if (this.state === 'intro') {
                // Player Warmup Animations
                this._updateIntroWarmup(dt);

                if (!this.introShots || this.introShots.length === 0) {
                    this.skipIntro();
                    return;
                }

                const shot = this.introShots[this.introShotIndex];
                this.introShotTimer += dt;

                if (this.introShotTimer >= shot.duration) {
                    this.introShotIndex++;
                    this.introShotTimer = 0;
                    
                    if (this.introShotIndex >= this.introShots.length) {
                        this.skipIntro(); // Done
                        return;
                    } else {
                        // Next shot start
                        const nextShot = this.introShots[this.introShotIndex];
                        if (nextShot.onStart) nextShot.onStart();
                    }
                } else {
                    // Update current shot
                    const t = this.introShotTimer / shot.duration;
                    if (this.camera && shot.update) {
                        shot.update(t, this.camera);
                    }
                }
                return;
            }

            if (this.state === 'menu') {
                // --- POPULATE ARENA FOR B-ROLL ---
                const animateTeam = (team) => {
                    if (!team) return;
                    team.players.forEach(p => {
                        if (p.mesh) {
                            p.mesh.visible = true;
                            // Gentle bobbing to simulate treading water
                            p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.002 + p.mesh.id) * 0.5;
                            // Ensure idle animation is playing
                            if (p.state !== 'idle') p.play('idle', 0.5);
                            if (p.mixer) p.mixer.update(dt);
                        }
                    });
                };
                animateTeam(this.teams.home);
                animateTeam(this.teams.away);

                // --- CINEMATIC B-ROLL ---
                if (this.menuShots && this.menuShots.length > 0) {
                    const shot = this.menuShots[this.menuShotIndex];
                    this.menuShotTimer += dt;
                    
                    if (this.menuShotTimer >= shot.duration) {
                        this.menuShotTimer = 0;
                        this.menuShotIndex = (this.menuShotIndex + 1) % this.menuShots.length;
                    }
                    
                    // Normalize time (0 to 1)
                    const t = this.menuShotTimer / shot.duration;
                    if (this.camera) {
                        shot.update(t, this.camera);
                    }
                }

                // Ambient FX in Menu
                if (this.particleManager && Math.random() < 0.2) {
                    const range = 60;
                    const pos = new THREE.Vector3(
                        (Math.random()-0.5)*range, 
                        -10 + Math.random()*20, 
                        (Math.random()-0.5)*range
                    );
                    this.particleManager.spawn('bubble', pos, { life: 3.0 + Math.random()*2.0, scale: 0.3 + Math.random()*0.4 });
                }

                // Update Background Systems
                if (this.particleManager) this.particleManager.update(dt);
                return;
            }

            // Update Techcopy UI
            if (this.techCopyState.active && this.ui.techTimerFill) {
                const pct = Math.max(0, (this.techCopyState.timer / this.techCopyState.maxTime) * 100);
                this.ui.techTimerFill.style.width = `${pct}%`;
                
                // Color shift based on urgency
                if (pct < 30) this.ui.techTimerFill.style.background = '#ff0000';
                else this.ui.techTimerFill.style.background = 'linear-gradient(90deg, #ffffff, #00ffff)';
            }

            // General Visuals (Always Run except Intro/Menu)
// General Visuals (Always Run except Intro/Menu)
            if (this.state !== 'menu' && this.state !== 'intro') {
                // Update band possession display
                if (window.flux.updateBandPossession && this.entities && this.entities.ball) {
                    const ball = this.entities.ball;
                    const homeHasBall = ball.holder && ball.holder.team && ball.holder.team.isHuman;
                    window.flux.updateBandPossession(homeHasBall);
                }

                if (this.miniMap) this.miniMap.update();
                if (this.floatingText) this.floatingText.update(dt);
                
                // CRITICAL FIX: Update particles during gameplay
// CRITICAL FIX: Update particles during gameplay with safe DT
                if (this.particleManager) this.particleManager.update(Math.max(0.001, dt));

                this._updateAudioState();
this._updateAudioState();
                if (this.audioManager && this.audioManager.update) this.audioManager.update(dt);
                this._updateHUDShake(dt); // Apply HUD Shake
                this._updateEnvironmentalFX(dt); // Ambient Bubbles
            }
        }

    _updateGoalTransparency() {
            if (!this.camera) return;
            
            const goals = [window.flux.goalA, window.flux.goalB];
            const fadeDist = 35.0; // Distance to start fading
            const minFadeDist = 15.0; // Distance where it's most transparent
            const minOpacity = 0.2;

            goals.forEach(goal => {
                if (!goal) return;

                // Calculate distance from camera to goal position
                const dist = this.camera.position.distanceTo(goal.position);
                
                let opacity = 1.0;
                if (dist < fadeDist) {
                    // Linear fade
                    const t = (dist - minFadeDist) / (fadeDist - minFadeDist);
                    opacity = THREE.MathUtils.clamp(t, 0.0, 1.0) * (1.0 - minOpacity) + minOpacity;
                }

                const isTransparent = opacity < 0.99;

                // Apply to all meshes in goal hierarchy
                goal.traverse(child => {
                    if (child.isMesh && child.material) {
                        const mat = child.material;
                        
                        // Only update if changed to minimize overhead
                        if (Math.abs(mat.opacity - opacity) > 0.01 || mat.transparent !== isTransparent) {
                            mat.opacity = opacity;
                            mat.transparent = isTransparent;
                            // Disable depthWrite when transparent so we can see the ball inside the net
                            mat.depthWrite = !isTransparent;
                            mat.needsUpdate = true;
                        }
                    }
                });
            });
}
        _updateOffscreenIndicator() {
            const p = this.teams.home ? this.teams.home.activePlayer : null;
            const indicator = this.ui.offscreenIndicator;
            
            if (!p || !p.mesh || !this.camera || !indicator) return;

            // 1. Get Player Position (Center Mass)
            const pos = p.mesh.position.clone();
            pos.y += 1.0; 
            
            // 2. Project to Normalized Device Coordinates (NDC) [-1, 1]
            this._tempVec.copy(pos).project(this.camera);
            
            // 3. Check if Behind Camera
            const camFwd = new THREE.Vector3();
            this.camera.getWorldDirection(camFwd);
            const toPlayer = pos.clone().sub(this.camera.position).normalize();
            const dot = camFwd.dot(toPlayer);
            const isBehind = dot < 0.2; // Buffer to prevent flipping at edge

            // 4. Check Bounds
            const isOffScreen = (
                this._tempVec.x < -0.9 || this._tempVec.x > 0.9 ||
                this._tempVec.y < -0.9 || this._tempVec.y > 0.9 ||
                isBehind
            );

            if (isOffScreen) {
                indicator.style.display = 'block';
                
                let x = this._tempVec.x;
                let y = this._tempVec.y;

                // If behind, invert coordinates to point correctly
                if (isBehind) {
                    x = -x;
                    y = -y;
                    // Fix singularity if exactly behind center
                    if (Math.abs(x) < 0.01 && Math.abs(y) < 0.01) y = -1; 
                }

                // Clamp to screen edges
                // We want to find the intersection of the vector (x,y) with the box [-0.9, 0.9]
                const padding = 0.9;
                
                // Normalize to get direction
                const mag = Math.sqrt(x*x + y*y);
                const nx = x / mag;
                const ny = y / mag;
                
                // Raycast to box edges
                // Vertical edges: x = +/- padding
                // Horizontal edges: y = +/- padding
                
                // Avoid divide by zero
                const tx = (Math.abs(nx) > 0.001) ? (nx > 0 ? padding : -padding) / nx : 999;
                const ty = (Math.abs(ny) > 0.001) ? (ny > 0 ? padding : -padding) / ny : 999;
                
                // Use the nearest intersection (smallest positive t)
                // Since we are projecting from center (0,0) to (nx,ny), t must be positive.
                const t = Math.min(Math.abs(tx), Math.abs(ty));
                
                const screenX = nx * t;
                const screenY = ny * t;

                // Convert NDC to Pixels
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const px = (screenX * 0.5 + 0.5) * width;
                const py = (-(screenY) * 0.5 + 0.5) * height;

                // Calculate Rotation
                // Arrow points UP by default.
                // We want it to point in direction (nx, ny) on screen.
                // Screen Y is down (inverted from WebGL Y).
                // So (0, 1) in NDC is UP. (0, -1) in NDC is DOWN.
                // atan2(y, x) gives angle from +X.
                // We want angle from +Y (Up).
                // Rotation = PI/2 - angle.
                
                const angle = Math.atan2(ny, nx);
                const rot = (Math.PI / 2) - angle;

                indicator.style.transform = `translate(${px}px, ${py}px) rotate(${rot}rad)`;
                
            } else {

                indicator.style.display = 'none';
            }
        }

        _updateTimer() {
            if (!this.ui.timer) return;
            // Clamp to half duration for display if we go slightly over before tick
            const t = Math.min(this.time, this.halfDuration);
            const minutes = Math.floor(t / 60);
            const seconds = Math.floor(t % 60);
            this.ui.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        _checkHalfTime() {
            if (this.time >= this.halfDuration) {
                this.endHalf();
            }
        }

endHalf() {
            this.state = 'halftime';
            
            // Stop all players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            if (this.half === 1) {
                this._showModal("HALF TIME", "PREPARING 2ND HALF...");
                
                // Optional: Play whistle sound here if available
                if (this.audioManager) this.audioManager.playSFX('whistle');

                this.stateTimer = 4.0;
            } else {
                // End of 2nd Half or Overtime Period
                if (this.score.home === this.score.away) {
                    // TIED - Go to Overtime (Golden Goal / Sudden Death)
                    this._showModal("SUDDEN DEATH", "NEXT GOAL WINS");
                    
                    if (this.audioManager) this.audioManager.playSFX('whistle');

                    this.stateTimer = 4.0;
                } else {
                    // Winner decided
                    this.endGame();
                }
            }
        }
        startSecondHalf() {
            this.half = 2;
            this.time = 0;
            if (this.ui.half) {
                this.ui.half.innerText = "2nd HALF";
                this.ui.half.style.color = ""; // Reset color
                this.ui.half.style.textShadow = "";
            }
            this.resetRound(null); // Neutral Blitz-off for 2nd half start
        }

        startOvertime() {
            this.half++;
            this.time = 0;
            this.isOvertime = true;
            if (this.ui.half) {
                this.ui.half.innerText = "SUDDEN DEATH";
                this.ui.half.style.color = "#ff4444"; // Red for danger/urgency
                this.ui.half.style.textShadow = "0 0 10px #ff0000";
            }
            this.resetRound(null); // Neutral Blitz-off
            
            // Announce start
            this.showAnnouncement("SUDDEN DEATH!", "slam");
        }

endGame() {
            this.state = 'gameover';
            
            // Stop players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            let msg = "DRAW";
            if (this.score.home > this.score.away) msg = "VICTORY";
            if (this.score.away > this.score.home) msg = "DEFEAT";
            
            // Populate End Game Menu
            if (this.ui.endMenu) {
                const titleEl = document.getElementById('end-result-title');
                const homeScoreEl = document.getElementById('end-score-home');
                const awayScoreEl = document.getElementById('end-score-away');
                
                if (titleEl) {
                    titleEl.innerText = msg;
                    titleEl.style.color = (msg === "VICTORY") ? "#00ffff" : ((msg === "DEFEAT") ? "#ff4444" : "#ffffff");
                }
                if (homeScoreEl) homeScoreEl.innerText = this.score.home;
                if (awayScoreEl) awayScoreEl.innerText = this.score.away;

                this.ui.endMenu.classList.add('active');
                this.setMenuMode(true); // Hide HUD
            }

// Keep BGM playing on Game Over
            if (this.audioManager) {
                this.audioManager.playBGM();
            }
        }

        _hideEndMenu() {
            if (this.ui.endMenu) {
                this.ui.endMenu.classList.remove('active');
                this.setMenuMode(false); // Show HUD
            }
        }

        _showModal(title, subtext) {
            if (!this.ui.modal) return;
            
            this.ui.modal.querySelector('.modal-title').innerText = title;
            this.ui.modal.querySelector('#modal-score-home').innerText = this.score.home;
            this.ui.modal.querySelector('#modal-score-away').innerText = this.score.away;
            this.ui.modal.querySelector('#modal-msg').innerText = subtext;
            
            this.ui.modal.classList.add('active');
            
            // Hide HUD elements
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
        }

        _hideModal() {
            if (!this.ui.modal) return;
            this.ui.modal.classList.remove('active');
            
            // Show HUD elements
            document.getElementById('hud-top').style.opacity = '1';
            document.getElementById('player-status-panel').style.opacity = '1';
        }

_checkGoals() {
            const C = window.flux.BallConfig || {};
            const goalDist = C.GOAL_DISTANCE || 41.5;
            
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const pos = ball.mesh.position;

            // Precise Goal Detection (Inverted Triangle Hitbox)
            // Matches FFX Style Goal Model
            const triTopY = (C.GOAL_TRIGGER_TOP_Y !== undefined) ? C.GOAL_TRIGGER_TOP_Y : 2.0;
            const triBottomY = (C.GOAL_TRIGGER_BOTTOM_Y !== undefined) ? C.GOAL_TRIGGER_BOTTOM_Y : -18.0;
            const triMaxHalfWidth = ((C.GOAL_TRIGGER_WIDTH !== undefined) ? C.GOAL_TRIGGER_WIDTH : 28.0) / 2.0;

            const triggerOffset = (C.GOAL_TRIGGER_OFFSET !== undefined) ? C.GOAL_TRIGGER_OFFSET : 1.0;
            const triggerZ = goalDist - triggerOffset;

            if (Math.abs(pos.z) > triggerZ) {
                // PREVENT OWN GOAL BY CARRIER (User Request)
                // If the ball is held by the team defending this goal, do not count it.
                if (ball.holder) {
                    // Home (Side 1) defends +Z. If pos.z > 0 (Home Goal) and holder is Home, ignore.
                    if (pos.z > 0 && ball.holder.team.side === 1) return;
                    // Away (Side -1) defends -Z. If pos.z < 0 (Away Goal) and holder is Away, ignore.
                    if (pos.z < 0 && ball.holder.team.side === -1) return;
                }

                // 2. Check Frame (Inverted Triangle)
                if (pos.y <= triTopY && pos.y >= triBottomY) {
                    // Calculate allowed width at this height (Linear interpolation)
                    // At bottom (-6), width is 0. At top (12), width is max.
                    const t = (pos.y - triBottomY) / (triTopY - triBottomY);
                    const allowedX = t * triMaxHalfWidth;

                    if (Math.abs(pos.x) <= allowedX) {
                        const isHeld = !!ball.holder;
                        
                        if (pos.z < 0) {
                            // Home scoring end (Goal at -Z)
                            // Valid if held (attacker carrying) OR moving towards goal (Negative Z)
                            if (isHeld || ball.velocity.z < -0.1) {
                                this.goalScored('home'); 
                            }
                        } else {
                            // Away scoring end (Goal at +Z)
                            // Valid if held (attacker carrying) OR moving towards goal (Positive Z)
                            if (isHeld || ball.velocity.z > 0.1) {
                                this.goalScored('away'); 
                            }
                        }
                    }
                }
            }
        }

goalScored(scorer) {
            if (this.state !== 'active') return;
            
            // IMPACT FRAME: GOAL
            this.triggerImpact(0.4, 'shatter'); // Massive freeze for goal
            
            // EXP REWARD: Goal
            // Find who scored (Last holder of ball)
            const ball = this.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team.id === scorer) {
                ball.lastHolder.gainExp(10);
            }

            // INCREMENT SCORE
            if (this.score[scorer] !== undefined) {
                this.score[scorer]++;
            }

            this.state = 'goal';
            console.log(`GOAL! ${scorer} scores. New Score: Home ${this.score.home} - Away ${this.score.away}`);
            this._updateScoreUI();
            // 1. VISCERAL SHAKE & PARTICLES
            if (this.cameraManager) {
                this.cameraManager.addShake(2.0); // Heavy shake
                this.addHUDShake(20.0); // HUD Shake
            }

            // BARRIER SHATTER LOGIC
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            // Home scores at -Z (Away Goal), Away scores at +Z (Home Goal)
            const goalZ = (scorer === 'home') ? -goalDist : goalDist;

            if (this.stadium) {
                const barrier = (scorer === 'home') ? this.stadium.barrierA : this.stadium.barrierB;
                if (barrier) barrier.visible = false;
            }

            if (this.particleManager && this.entities.ball && this.entities.ball.mesh) {
                const ballPos = this.entities.ball.mesh.position.clone();
                const ballVel = this.entities.ball.velocity.clone();
                const forward = ballVel.clone().normalize();

                // Calculate Impact Point on Goal Plane (The "Invisible Barrier")
                const impactPos = ballPos.clone();
                // Snap effect to the barrier plane (Z) but keep X/Y of entry
                impactPos.z = goalZ; 
                
                // Trigger Glass Shatter Effect (The Hole)
                this._triggerGlassShatter(impactPos, ballVel);

                // Trigger Triangle Frame Shatter (The Barrier)
                this._spawnTriangleShatter(goalZ, forward);

                // Massive Goal Explosion
                this.particleManager.spawn('shockwave', impactPos, { scale: 20.0, life: 0.6, color: 0x00ffff });
                this.particleManager.spawn('flash', impactPos, { scale: 12.0 });
            }
            // 2. SCREEN FLASH
            if (this.ui.flash) {
                this.ui.flash.style.opacity = '0.8';
                setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 100);
            }

            // 3. GOLDEN GOAL CHECK (Sudden Death)
            if (this.isOvertime) {
                this.showAnnouncement("GOLDEN GOAL!", 'slam');
                
                // Slow motion finish
                if (window.flux) window.flux.timeScale = 0.2;

                // End game after short delay (0.5s game time at 0.2 scale = 2.5s real time)
                this.state = 'golden_goal';
                this.stateTimer = 0.5;
                return;
            }

            // 4. SLAM ANNOUNCEMENT (Normal)
            this.showAnnouncement("GOAL!", 'slam');
            if (this.audioManager) this.audioManager.playSFX('goal');
            
            // Reset sequence
            // Scored-upon team gets ball
            const loser = scorer === 'home' ? 'away' : 'home';
            
            // FASTER FLOW: Reduced delay from 3000ms to 1200ms (2.0s game time)
            this.stateTimer = 2.0;
            this.nextStatePayload = loser;
        }

_spawnTriangleShatter(zPos, forwardDir) {
            if (!this.particleManager) return;

            // Triangle Vertices (Matches Stadium.js geometry)
            // Top Y: 12.0, Bottom Y: -6.0. Width at top: 28.0 (+/- 14.0).
const v1 = { x: -14, y: 9 };
            const v2 = { x: 14, y: 9 };
            const v3 = { x: 0, y: -6 };
            
            const edges = [
                { start: v1, end: v2 },
                { start: v2, end: v3 },
                { start: v3, end: v1 }
            ];

            // Increased density for "appearing" effect
// Increased density for "appearing" effect
const particlesPerEdge = 4; // Reduced from 12 for less clutter
            
            edges.forEach(edge => {
                for (let i = 0; i <= particlesPerEdge; i++) {
                    const t = i / particlesPerEdge;
                    const x = edge.start.x + (edge.end.x - edge.start.x) * t;
                    const y = edge.start.y + (edge.end.y - edge.start.y) * t;
                    
                    const pos = new THREE.Vector3(x, y, zPos);
                    
                    // Add some randomness
                    pos.x += (Math.random() - 0.5) * 0.5;
                    pos.y += (Math.random() - 0.5) * 0.5;
                    pos.z += (Math.random() - 0.5) * 0.5;

                    // Velocity: Outward from center of triangle (approx 0, 4) + Forward
                    const center = { x: 0, y: 1.5 }; // Rough center of mass
                    const dir = new THREE.Vector3(x - center.x, y - center.y, 0).normalize();
                    
                    const vel = dir.multiplyScalar(8.0 + Math.random() * 12.0);
                    vel.add(forwardDir.clone().multiplyScalar(20.0)); // Strong forward momentum

this.particleManager.spawn('shard', pos, {
                        velocity: vel,
                        scale: 4.0 + Math.random() * 6.0, 
                        life: 1.5 + Math.random(),
                        color: 0x44aaff,
                        rotationSpeed: (Math.random() - 0.5) * 10.0, // Spin
                        frame: Math.floor(Math.random() * 4) // Random shape
                    });
                    
                    // Flash on perimeter to outline the shape as it breaks
                    if (Math.random() < 0.5) {
                        this.particleManager.spawn('flash', pos, { scale: 3.0, life: 0.3, color: 0xffffff });
                    }
                }
            });
        }

_triggerGlassShatter(pos, vel) {
            if (!this.particleManager) return;
            
            const forward = vel.clone().normalize();
            const speed = Math.max(20.0, vel.length()); // Ensure minimum explosion speed
            
            // 1. The "Pane" (Radial burst on the goal plane)
            // Simulates the barrier shattering outward
// 1. The "Pane" (Radial burst on the goal plane)
            // Simulates the barrier shattering outward
const shardCount = 15; // Reduced from 50
            for(let i=0; i<shardCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 10.0; // Larger radius
                
                const offset = new THREE.Vector3(Math.cos(angle) * r, Math.sin(angle) * r, 0);
                const p = pos.clone().add(offset);
                
                // Velocity is radial outward from impact center
                const radialDir = offset.clone().normalize();
                const shardVel = radialDir.multiplyScalar(15.0 + Math.random() * 25.0);
                
                // Add forward momentum (The ball punches through)
                shardVel.add(forward.clone().multiplyScalar(speed * 0.8));
                
this.particleManager.spawn('shard', p, {
                    velocity: shardVel,
                    scale: 6.0 + Math.random() * 8.0, 
                    life: 1.2 + Math.random() * 0.8,
                    gravity: 25.0,
                    color: 0xaaffff,
                    rotationSpeed: (Math.random() - 0.5) * 15.0,
                    frame: Math.floor(Math.random() * 4)
                });
            }

            // 2. The "Hole" (High velocity shards moving forward with the ball)
// 2. The "Hole" (High velocity shards moving forward with the ball)
            for(let i=0; i<8; i++) { // Reduced from 20
                const p = pos.clone();
                // Randomize start pos slightly (impact zone)
                p.x += (Math.random() - 0.5) * 4.0;
                p.y += (Math.random() - 0.5) * 4.0;
                
                // Velocity: Mostly forward, some spread
                const shardVel = forward.clone().multiplyScalar(speed * (1.0 + Math.random() * 0.5));
                shardVel.x += (Math.random() - 0.5) * 15.0;
                shardVel.y += (Math.random() - 0.5) * 15.0;
                
this.particleManager.spawn('shard', p, {
                    velocity: shardVel,
                    scale: 5.0 + Math.random() * 7.0,
                    life: 2.0 + Math.random(),
                    gravity: 15.0,
                    color: 0xffffff,
                    rotationSpeed: (Math.random() - 0.5) * 20.0,
                    frame: Math.floor(Math.random() * 4)
                });
            }
            
            // 3. Impact Flash & Sound
            this.particleManager.spawn('flash', pos, { scale: 15.0, color: 0xffffff });
            
            // 3. Impact Flash & Sound
            this.particleManager.spawn('flash', pos, { scale: 10.0, color: 0xffffff });
            
            if (this.audioManager) {
                // High pitch impact to simulate glass breaking
                this.audioManager.playSFX('impact', { volume: 1.0, rate: 2.5 }); 
                this.audioManager.playSFX('dash', { volume: 1.0, rate: 0.5 }); // Deep whoosh
            }
        }

showAnnouncement(text, type = 'normal', duration = 2000) {
            const el = this.ui.announcement;
            if (!el) return;

            // Clear previous timeout
            if (this._announceTimeout) {
                clearTimeout(this._announceTimeout);
                this._announceTimeout = null;
            }

            // Reset Animation by cloning
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            this.ui.announcement = newEl;

            newEl.innerText = text;
            newEl.style.display = 'block';
            
            // Apply Class based on type
            newEl.className = ''; // Reset classes
            if (type === 'slam') {
                newEl.classList.add('announcement-slam');
            } else {
                // Default style
                newEl.style.animation = 'none';
                newEl.offsetHeight; /* trigger reflow */
                newEl.style.animation = 'announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            // Auto-hide
            if (duration > 0) {
                this._announceTimeout = setTimeout(() => {
                    this.hideAnnouncement();
                }, duration);
            }
        }

        hideAnnouncement() {
            if (this.ui.announcement) {
                this.ui.announcement.style.display = 'none';
            }
        }

resetRound(possessionTeamId) {
            this.state = 'reset';
            
            // Clear persistent visuals
            if (this.glyphManager) this.glyphManager.clear();
            if (this.powerUpManager) this.powerUpManager.reset();
            if (this.particleManager) {
                // Optional: Clear particles if needed, though they self-expire quickly
            }
            
            // Restore Barriers
            if (this.stadium) {
                if (this.stadium.barrierA) this.stadium.barrierA.visible = true;
                if (this.stadium.barrierB) this.stadium.barrierB.visible = true;
            }

            // Reset Ball
            if (this.entities.ball) this.entities.ball.reset();
            // Reset Teams
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            
            // Clear ball holder
            if (this.entities.ball) this.entities.ball.drop();

            // CRITICAL: Snap camera to prevent disorientation
            if (this.cameraManager) {
                // Force update target first (usually ball)
                if (this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }

            // FASTER FLOW: Reduced delay from 2000ms to 100ms
            this.state = 'reset';
            this.stateTimer = 0.1;
            this.nextStatePayload = possessionTeamId;
        }


startKickoff(possessionTeamId) {
            // Stop all players immediately
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            // If a team has possession (after goal), standard kickoff
            if (possessionTeamId) {
                this.state = 'kickoff';
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) this.audioManager.playSFX('whistle');

                const team = this.teams[possessionTeamId];
                if (team) {
                    const mf = team.players.find(p => p.role === 'MF');
                    if (mf && this.entities.ball) {
                        this.entities.ball.grab(mf);
                        
                        // Snap camera to new holder
                        if (this.cameraManager) {
                            this.cameraManager.setTarget(mf.mesh, mf.velocity);
                            this.cameraManager.snapToTarget();
                        }
                    }
                }
                
this.state = 'kickoff';
                this.stateTimer = 0.8;
            } else {
                // NEUTRAL KICKOFF: "The Blitz Off" Cinematic Sequence
                this._startNeutralBlitzOff();
            }
        }


_startNeutralBlitzOff() {
            this.state = 'blitz_charge';
            this.blitzTimer = 0;
            
            // 1. Reset Ball to Center (Deep)
            const ball = this.entities.ball;
            if (ball && ball.mesh) {
                ball.drop();
                ball.mesh.position.set(0, -5, 0); // Start DEEP (-5m) for "ground up" rise
                ball.velocity.set(0, 0, 0);
                ball.angularVelocity.set(0, 0, 0);
                // Reset visuals
                if (ball.deformNode) ball.deformNode.scale.set(1, 1, 1);
            }

            // 2. Position Captains (MFs)
            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');

            if (homeMF && homeMF.mesh) {
                homeMF.mesh.position.set(0, 0, 8); // 8m back
                homeMF.mesh.lookAt(0, 0, 0);
                homeMF.play('idle', 0.1);
            }
            if (awayMF && awayMF.mesh) {
                awayMF.mesh.position.set(0, 0, -8); // 8m back
                awayMF.mesh.lookAt(0, 0, 0);
                awayMF.play('idle', 0.1);
            }

            // 3. Camera Focus
            if (this.cameraManager && ball && ball.mesh) {
                this.cameraManager.setTarget(ball.mesh, null);
                this.cameraManager.snapToTarget();
                // Zoom in tight
                this.cameraManager.currentPullBack = -12; 
                this.cameraManager.manualOrbitPitch = 0.4; // Look down steep
            }

            // Build Tension
            this.showAnnouncement("READY...", 'normal');
            if (this.audioManager) this.audioManager.playSFX('swim', { volume: 0.5 });
        }

        _updateBlitzCharge(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const chargeDuration = 2.0; // Longer build up for cinematic feel

            // PHASE 1: CHARGE (Rising from depths)
            if (this.blitzTimer < chargeDuration) {
                const t = this.blitzTimer / chargeDuration;
                const easeT = t * t; // Quadratic ease in
                
                // Rise from -5 to 0 (Ground up effect)
                ball.mesh.position.y = -5.0 + (5.0 * easeT);
                
                // Spin up (Exponential)
                ball.mesh.rotation.y += (10.0 + 50.0 * t) * dt;
                ball.mesh.rotation.x += (5.0 + 20.0 * t) * dt;

                // Squash (Flatten like a disc building energy)
                if (ball.deformNode) {
                    // Extreme squash at the end
                    const squash = 1.0 - (0.7 * easeT); // Flatten Y to 0.3
                    const stretch = 1.0 + (0.5 * easeT); // Expand XZ
                    ball.deformNode.scale.set(stretch, squash, stretch);
                }

                // Camera Shake increasing
                if (this.cameraManager) this.cameraManager.addShake(0.2 * t);

                // Particles: Rising Energy from ground
                if (this.particleManager) {
                    // Bubbles rising fast
                    const count = Math.floor(t * 8) + 1;
                    for(let i=0; i<count; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = 2.0 * (1.0 - t); // Radius shrinks as it gets closer to launch
                        const x = Math.cos(angle) * r;
                        const z = Math.sin(angle) * r;
                        const y = ball.mesh.position.y - 1.0; // Below ball
                        
                        this.particleManager.spawn('bubble', new THREE.Vector3(x, y, z), { 
                            life: 0.4, 
                            scale: 0.2 + t * 0.5 
                        });
                    }
                }
            } 
            // PHASE 2: LAUNCH
            else if (this.state === 'blitz_charge') {
                this.state = 'blitz_launch';
                this.blitzTimer = 0; // Reset for launch phase

                // TIMED ANNOUNCEMENT
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) {
                    this.audioManager.playSFX('impact', { volume: 1.0 }); // Boom
                    this.audioManager.playSFX('dash', { volume: 1.0 });   // Whoosh
                }

                // Launch Ball
                ball.velocity.set(0, 35, 0); // Shoot UP FAST
                if (ball.deformNode) ball.deformNode.scale.set(0.4, 3.0, 0.4); // Extreme stretch vertical

                // FX: Massive Ground Eruption
                if (this.particleManager) {
                    this.particleManager.spawn('shockwave', ball.mesh.position, { scale: 8.0 });
                    this.particleManager.spawn('flash', ball.mesh.position, { scale: 6.0 });
                    // Vertical stream
                    for(let i=0; i<10; i++) {
                        const p = ball.mesh.position.clone();
                        p.y += i * 0.5;
                        this.particleManager.spawn('dash_stream', p, { scale: 3.0 });
                    }
                }
                
                if (this.cameraManager) {
                    this.cameraManager.addShake(3.0); // Heavy shake
                    this.cameraManager.currentPullBack = 10; // Zoom out fast
                    this.cameraManager.manualOrbitPitch = 0.0; // Level out
                }

                // Captains Jump
                const homeMF = this.teams.home.players.find(p => p.role === 'MF');
                const awayMF = this.teams.away.players.find(p => p.role === 'MF');

                const jumpTo = (p) => {
                    if (!p || !p.mesh) return;
                    const dir = ball.mesh.position.clone().sub(p.mesh.position).normalize();
                    dir.y = 1.2; // Steep jump
                    p.velocity.copy(dir).multiplyScalar(18.0); // Fast jump
                    p.play('catch_jump', 0.1);
                };

                jumpTo(homeMF);
                jumpTo(awayMF);
            }
        }

        _updateBlitzLaunch(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            
            // Apply gravity manually for cinematic feel (Increased gravity for snappier arc)
            ball.velocity.y -= 40.0 * dt; 
            ball.mesh.position.addScaledVector(ball.velocity, dt);

            // Move Players manually
            const updateJumper = (p) => {
                if (!p || !p.mesh) return;
                p.velocity.y -= 25.0 * dt; // Gravity
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.lookAt(ball.mesh.position);
            };

            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');
            
            updateJumper(homeMF);
            updateJumper(awayMF);

            // PHASE 3: GRAB (Apex ~0.7s)
            if (this.blitzTimer > 0.7 && this.state === 'blitz_launch') {
                // Determine Winner (50/50 + Stat bias)
                const homeSp = homeMF.getStat('SP');
                const awaySp = awayMF.getStat('SP');
                const total = homeSp + awaySp;
                const roll = Math.random() * total;
                
                const winner = (roll < homeSp) ? homeMF : awayMF;
                
                ball.grab(winner);
                this.hideAnnouncement();
                
                if (this.floatingText) {
                    this.floatingText.spawn("WON!", winner.mesh.position, "tech");
                }

                // Transition to Active
                this.state = 'active';
                
                // Snap camera to winner
                if (this.cameraManager) {
                    this.cameraManager.setTarget(winner.mesh, winner.velocity);
                    // this.cameraManager.snapToTarget(); // Optional: Keep smooth or snap
                }
            }
        }
        
// Initial start
startMatch(mode) {
            console.log("Starting Match in mode:", mode);
            
            // Reset Score
            this.score.home = 0;
            this.score.away = 0;
this._updateScoreUI(true); // Reset score display without slam animation
            
            // Reset Time
            this.time = 0;
            this.half = 1;
            this.isOvertime = false; // Reset Sudden Death flag
            
            if (this.ui.half) {
                this.ui.half.innerText = "1st";
                this.ui.half.style.color = "";
                this.ui.half.style.textShadow = "";
            }
            
            if (mode === 'practice') {
                if (this.ui.half) this.ui.half.innerText = "PRAC";
                
                // Start Practice Manager
                if (this.practiceManager) {
                    this.practiceManager.start();
                }

                // In practice, ensure AI is enabled for sparring
                if (this.teams.away) {
                    this.teams.away.aiEnabled = true;
                }
                
                // Start BGM immediately for practice
                if (this.audioManager) {
                    this.audioManager.playBGM();
                }

                // Skip intro for practice
                this.resetRound();
            } else {
                // Ensure Practice Manager is stopped if normal game
                if (this.practiceManager) this.practiceManager.stop();
                
                // Safety: Ensure all players are visible (in case Practice hid them)
                if (this.teams.away) {
                    this.teams.away.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                    this.teams.away.aiEnabled = true; 
                }
                if (this.teams.home) {
                    this.teams.home.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                }

                // Start Cinematic Intro
                this.startIntroSequence();
            }
        }

skipIntro() {
            if (this.state !== 'intro') return;
            console.log("Intro Complete/Skipped");
            
            this.hideAnnouncement();
            
// RESTORE UI ELEMENTS
            const uiElements = [
                'hud-top',
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'auto-toggle', 
                'settings-button',
                'controls-hint'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = ''; // Revert to CSS default
            });

            // Hide Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '0');
            }
            
// Lights on
            if (this.stadium) this.stadium.setAllLights(true);
            
            // Reset players to idle
            if (this.teams.home) this.teams.home.players.forEach(p => p.play('idle', 0.1));
            if (this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.1));
            
            // Start BGM after intro
            if (this.audioManager) {
                this.audioManager.playBGM();
            }

            this.resetRound(null);
        }

startIntroSequence() {

            this.state = 'intro';
            this.introShotIndex = 0;
            this.introShotTimer = 0;
            this._hasRoared = false; // Reset roar flag
            // Stop BGM for cinematic intro (let SFX shine)
            if (this.audioManager) {
                this.audioManager.stopBGM();
                // Ensure context is running for intro SFX
                if (this.audioManager.ctx.state === 'suspended') this.audioManager.ctx.resume();
            }
            
            // Initial setup
            // HIDE ALL UI ELEMENTS
            const uiElements = [
                'hud-top', 
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'tackle-button', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'joystick-visual-container',
                'aim-joystick-visual',
                'auto-toggle', 
                'settings-button',
                'controls-hint',
                'charge-meter-container',
                'practice-restore-btn'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Show Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '10%');
            }
            
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            if (this.entities.ball) this.entities.ball.reset();
            
            // Trigger first shot start
            if (this.introShots && this.introShots.length > 0) {
                if (this.introShots[0].onStart) this.introShots[0].onStart();
            } else {
                this.skipIntro();
            }
        }
_updateIntroWarmup(dt) {
            const allPlayers = [];
            if (this.teams.home) allPlayers.push(...this.teams.home.players);
            if (this.teams.away) allPlayers.push(...this.teams.away.players);

            allPlayers.forEach(p => {
                if (!p.mesh) return;

                // Ensure mixer updates (since game loop might skip player.update in intro state)
                if (p.mixer) p.mixer.update(dt);

                // Initialize warmup timer if needed
                if (p._warmupTimer === undefined) p._warmupTimer = Math.random() * 2.0;
                
                p._warmupTimer -= dt;

                if (p._warmupTimer <= 0) {
                    // Pick next action time (2s to 5s)
                    p._warmupTimer = 2.0 + Math.random() * 3.0;
                    
                    const rand = Math.random();
                    if (rand < 0.4) {
                        p.play('idle', 0.5);
                    } else if (rand < 0.6) {
                        p.play('swim', 0.5);
                    } else if (rand < 0.8) {
                        // "Stretch" / Celebrate
                        p.play('celebrate', 0.5);
                    } else if (rand < 0.9) {
                        p.play('catch', 0.5); // Checking gloves
                    } else {
                        p.play('react', 0.5); // Shake off
                    }
                }

                // Gentle bobbing (treading water)
                if (p.homePosition) {
                    p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.003 + p.mesh.id) * 0.3;
                }
            });
        }

setMenuMode(isActive) {
            this.state = isActive ? 'menu' : 'active';
            
            if (isActive && this.audioManager) {
                // Play BGM in menu
                this.audioManager.playBGM();
                // Reset match tension
                if (this.audioManager.setMatchState) {
                    this.audioManager.setMatchState(0, false);
                }
            }

            const staticUI = [
                'hud-top',
                'player-status-panel',
                'action-container',
                'joystick-hit-zone',
                'aim-joystick-zone',
                'minimap-container',
                'goal-distance-container',
                'settings-button',
                'auto-toggle',
                'tackle-button',
                'controls-hint'
            ];

            // List of dynamic elements to FORCE HIDE in menu
            const dynamicUI = [
                'joystick-visual-container',
                'aim-joystick-visual',
                'charge-meter-container',
                'tech-flash-overlay',
                'practice-restore-btn'
            ];

            if (isActive) {
                // HIDE ALL
                [...staticUI, ...dynamicUI].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            } else {
                // SHOW STATIC ONLY
                staticUI.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'hud-top' || id === 'action-container') el.style.display = 'flex';
                        else el.style.display = 'block';
                    }
                });
                // Dynamic ones remain hidden/controlled by their logic
            }
        }
toggleDemoMode() {
            this.isDemoMode = !this.isDemoMode;
            console.log("Demo Mode:", this.isDemoMode);
            
            // Update UI Button
            const btn = document.getElementById('auto-toggle');
            if (btn) {
                btn.innerText = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
                if (this.isDemoMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // Announcement
            const text = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
            this.showAnnouncement(text);
            
            // Visual Flair: Spawn text above active player
            if (this.isDemoMode && this.floatingText && this.teams.home && this.teams.home.activePlayer && this.teams.home.activePlayer.mesh) {
                this.floatingText.spawn("AI ENGAGED", this.teams.home.activePlayer.mesh.position, "goal");
            }

            // Auto-hide announcement
setTimeout(() => {
                if (this.ui.announcement && this.ui.announcement.innerText === text) {
                    this.hideAnnouncement();
                }
            }, 1500);
        }

        // --- TECHCOPY SYSTEM ---

        triggerTechEvent(sourcePlayer, techName) {
            if (!sourcePlayer || !sourcePlayer.team) return;

            // Find opposing team
            const oppTeamId = sourcePlayer.team.id === 'home' ? 'away' : 'home';
            const oppTeam = this.teams[oppTeamId];
            if (!oppTeam) return;

            // Find who is marking this source
            const learners = oppTeam.players.filter(p => p.marking === sourcePlayer);
            
            if (learners.length === 0) return;

            // Only show UI if the learning team is Human (Home)
            // (Or if we are in Demo mode and want to see it happen for Home team)
            if (oppTeam.isHuman) {
                // Filter out those who already know it
                const validLearners = learners.filter(p => !p.learnedTechs.includes(techName));
                if (validLearners.length > 0) {
                    this.startTechCopyWindow(techName, validLearners);
                }
            }
        }

startTechCopyWindow(techName, learners) {
            this.techCopyState.active = true;
            this.techCopyState.maxTime = 0.6; // 0.6s window
            this.techCopyState.timer = this.techCopyState.maxTime;
            this.techCopyState.tech = techName;
            this.techCopyState.learners = learners;
            
            // Show UI
if (this.ui.techFlash) {
                if (this.audioManager) {
                    this.audioManager.playBGM();
                    // Ensure context is running
                    if (this.audioManager.ctx.state === 'suspended') this.audioManager.ctx.resume();
                }
                this.ui.techFlash.style.background = ""; // Reset background
                this.ui.techFlash.querySelector('.tech-text').innerText = "TECHCOPY!";
                
                if (this.ui.techSub) {
                    this.ui.techSub.innerText = techName.replace('_', ' ');
                }
                
                // Reset bar
                if (this.ui.techTimerFill) {
                    this.ui.techTimerFill.style.width = '100%';
                }
            }
        }

attemptTechCopy() {
            if (!this.techCopyState.active) return false;
            
            // Success!
            const tech = this.techCopyState.tech;
            const learners = this.techCopyState.learners;
            
            learners.forEach(p => {
                // Double check to prevent duplicates
                if (!p.learnedTechs.includes(tech)) {
                    p.learnedTechs.push(tech);
                    console.log(`${p.role} learned ${tech}!`);
                    
                    // 1. Floating Text
                    if (this.floatingText && p.mesh) {
                        this.floatingText.spawn(`LEARNED!`, p.mesh.position, "tech");
                    }
                    
                    // 2. Particle Effect (Spiral)
                    if (this.particleManager && p.mesh) {
                        // Spawn multiple particles for a swirl effect
                        for(let i=0; i<10; i++) {
                            setTimeout(() => {
                                this.particleManager.spawn('learned', p.mesh.position);
                            }, i * 50);
                        }
                    }
                }
            });
            
            this.endTechCopyWindow(true);
            return true;
        }

endTechCopyWindow(success) {
            this.techCopyState.active = false;
            if (this.ui.techFlash) {
                if (success) {
                    this.ui.techFlash.querySelector('.tech-text').innerText = "SUCCESS!";
                    // Flash success color (White flash)
                    this.ui.techFlash.style.background = "rgba(255, 255, 255, 0.8)";
                    
                    // Hide after short delay to show the success flash
                    setTimeout(() => { 
                        this.ui.techFlash.style.display = 'none'; 
                    }, 300);
                } else {
                    // Failed / Missed
                    this.ui.techFlash.style.display = 'none';
                }
            }
        }
_updatePlayerStatusUI() {
            if (!this.teams.home || !this.teams.home.activePlayer) return;
            
            const p = this.teams.home.activePlayer;
            const ui = this.ui.statusPanel;
            
// UI Updates (Action Button Context)
                ui.container.style.display = 'block';
                
                // Name & Level
                if (ui.name) ui.name.innerText = `${p.characterName || p.role} LV${p.level}`;
                
                // HP
                if (ui.hpBar) {
                    const hpPct = Math.max(0, Math.min(100, (p.stats.HP / p.stats.maxHP) * 100));
                    ui.hpBar.style.width = `${hpPct}%`;
                    // Color shift
                    if (hpPct < 25) ui.hpBar.style.background = 'linear-gradient(90deg, #ff0000, #ff4444)';
                    else if (hpPct < 50) ui.hpBar.style.background = 'linear-gradient(90deg, #ffff00, #ffff88)';
                    else ui.hpBar.style.background = 'linear-gradient(90deg, #00ff00, #ccffcc)';
                }
                if (ui.hpText) ui.hpText.innerText = `${Math.floor(p.stats.HP)}/${p.stats.maxHP}`;
                
                // EXP
                if (ui.expBar) {
                    const expPct = Math.max(0, Math.min(100, (p.exp / p.nextLevelExp) * 100));
                    ui.expBar.style.width = `${expPct}%`;

                }
        }

_initParticles() {
            this.activeSparks = [];
            this.sparkPool = [];
            const poolSize = 40; // Sufficient for continuous grinding
            
            for (let i = 0; i < poolSize; i++) {
                const sprite = new THREE.Sprite(_sparkMaterial.clone());
                sprite.visible = false;
                this.scene.add(sprite);
                this.sparkPool.push(sprite);
            }
        }

        spawnClash(pos, intensity = 1.0) {
            // Find free spark
            const spark = this.sparkPool.find(s => !s.visible);
            if (!spark) return; // Pool exhausted
            
            spark.position.copy(pos);
            spark.visible = true;
            
            // Randomize rotation
            spark.material.rotation = Math.random() * Math.PI;
            
            // Initialize Active State
            this.activeSparks.push({
                mesh: spark,
                age: 0,
                life: 0.15 + Math.random() * 0.15, // Fast, punchy sparks
                maxScale: 2.5 * intensity,
                velocity: new THREE.Vector3(
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8
                )
            });
        }

        _updateParticles(dt) {
            for (let i = this.activeSparks.length - 1; i >= 0; i--) {
                const p = this.activeSparks[i];
                p.age += dt;
                
                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    this.activeSparks.splice(i, 1);
                    continue;
                }
                
                const t = p.age / p.life;
                
                // Expand
                const currentScale = 0.5 + (p.maxScale - 0.5) * t;
                p.mesh.scale.setScalar(currentScale);
                
                // Fade out
                p.mesh.material.opacity = 1.0 - (t * t); // Quadratic fade
                
                // Move
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.material.rotation += 10.0 * dt;
            }
        }

// Helper for impact frames

triggerImpact(duration, type = 'default') {
            this.impactPause = 0; // Hit stop disabled per user request
            
            // Trigger HUD Shake based on impact type
            let shakeAmount = 5.0;
            if (type === 'heavy') shakeAmount = 15.0;
            if (type === 'shatter') shakeAmount = 30.0;
            this.addHUDShake(shakeAmount);

            const container = document.getElementById('game-container');
            if (!container) return;

            // Clear any existing timeout to prevent early removal of new class
            if (this._impactTimeout) {
                clearTimeout(this._impactTimeout);
                this._impactTimeout = null;
            }

            // Reset classes to ensure animation restarts (reflow trick)
            container.classList.remove('impact-fx', 'impact-heavy', 'impact-shatter');
            
            // Force reflow
            void container.offsetWidth;

            let className = 'impact-fx';
            if (type === 'heavy') className = 'impact-heavy';
            if (type === 'shatter') className = 'impact-shatter';

            container.classList.add(className);

            // Auto-remove class after duration + buffer for animation tail
            // We add a bit more time than the pause duration to let the CSS animation finish
            const animDuration = (type === 'shatter' ? 500 : (type === 'heavy' ? 250 : 150));
            
            this._impactTimeout = setTimeout(() => {
                container.classList.remove(className);
                this._impactTimeout = null;
            }, animDuration);
        }

        addHUDShake(amount) {
            this.hudShakeIntensity = Math.min(this.hudShakeIntensity + amount, 50.0);
        }

        _updateHUDShake(dt) {
            if (this.hudShakeIntensity > 0) {
                // Decay
                this.hudShakeIntensity -= dt * 60.0; // Decay approx 60px per second
                if (this.hudShakeIntensity < 0) this.hudShakeIntensity = 0;

                const x = (Math.random() - 0.5) * this.hudShakeIntensity;
                const y = (Math.random() - 0.5) * this.hudShakeIntensity;
                
                const transform = `translate(${x.toFixed(1)}px, ${y.toFixed(1)}px)`;
                
                // Apply to main HUD containers
                const hudTop = document.getElementById('hud-top');
                if (hudTop) hudTop.style.transform = transform;
                
                const statusPanel = document.getElementById('player-status-panel');
                // Preserve existing skew
                if (statusPanel) statusPanel.style.transform = `skewX(-10deg) ${transform}`;
                
                const actionContainer = document.getElementById('action-container');
                if (actionContainer) actionContainer.style.transform = transform;
                
                const minimap = document.getElementById('minimap-container');
                if (minimap) minimap.style.transform = transform;

                this._hudShakeDirty = true;
            } else if (this._hudShakeDirty) {
                // Reset to clean state
                const hudTop = document.getElementById('hud-top');
                if (hudTop) hudTop.style.transform = '';
                
                const statusPanel = document.getElementById('player-status-panel');
                if (statusPanel) statusPanel.style.transform = 'skewX(-10deg)';
                
                const actionContainer = document.getElementById('action-container');
                if (actionContainer) actionContainer.style.transform = '';
                
                const minimap = document.getElementById('minimap-container');
                if (minimap) minimap.style.transform = '';
                
                this._hudShakeDirty = false;
            }
        }
_updateAudioState() {
            if (!this.audioManager) return;

            let tension = 0;

            // 1. Ball Threat
            const ball = this.entities.ball;
            if (ball && ball.mesh && (this.state === 'active' || this.state === 'blitz_launch')) {
                const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                const z = ball.mesh.position.z;
                const distToGoal = Math.min(Math.abs(z - goalDist), Math.abs(z + goalDist));
                const threatRange = 35.0;
                const ballThreat = Math.max(0, 1.0 - (distToGoal / threatRange));
                tension += ballThreat * ballThreat; // Quadratic ramp
            }

            // 2. Score Pressure (Close game)
            const diff = Math.abs(this.score.home - this.score.away);
            if (diff <= 1) tension += 0.15;

            // 3. Time Pressure (Last minute)
            const timeLeft = this.halfDuration - this.time;
            if (timeLeft < 60 && this.state === 'active') {
                tension += 0.2 * (1.0 - (timeLeft / 60));
            }

            if (this.audioManager.setMatchState) {
                this.audioManager.setMatchState(tension, this.isOvertime);
            }
}

        _updateEnvironmentalFX(dt) {
            // Only in active game or menu
            if (this.state === 'intro') return;

            this._envBubbleTimer = (this._envBubbleTimer || 0) - dt;
            
            if (this._envBubbleTimer <= 0) {
                // Random interval: 0.2s to 0.8s (Frequent streams)
                this._envBubbleTimer = 0.2 + Math.random() * 0.6;
                
                if (this.particleManager) {
                    // Pick a random spot on the floor
                    const x = (Math.random() - 0.5) * 70;
                    const z = (Math.random() - 0.5) * 90;
                    const yBase = -20; // Deep
                    
                    // Spawn a "Stream" (Burst of bubbles rising together)
                    const count = 3 + Math.floor(Math.random() * 5);
                    const streamSpeed = 3.0 + Math.random() * 4.0;
                    
                    for(let i=0; i<count; i++) {
                        const pos = new THREE.Vector3(
                            x + (Math.random()-0.5) * 1.0,
                            yBase - (Math.random() * 5.0), // Staggered start depth
                            z + (Math.random()-0.5) * 1.0
                        );
                        
                        this.particleManager.spawn('bubble_micro', pos, {
                            life: 4.0 + Math.random() * 2.0, // Long life to reach top
                            scale: 0.08 + Math.random() * 0.15, // Shimmery size
                            velocity: new THREE.Vector3(
                                (Math.random()-0.5) * 0.5, 
                                streamSpeed + (Math.random() * 2.0), 
                                (Math.random()-0.5) * 0.5
                            ),
                            drag: 0.1
                        });
                    }
                }
            }
        }
_advanceState() {
            switch (this.state) {
                case 'goal':
                    this.resetRound(this.nextStatePayload);
                    break;
                case 'reset':
                    this.startKickoff(this.nextStatePayload);
                    break;
                case 'kickoff':
                    this.hideAnnouncement();
                    this.state = 'active';
                    break;
                case 'halftime':
                    this._hideModal();
                    if (this.half === 1) {
                        this.startSecondHalf();
                    } else {
                        // Check for OT or End
                        if (this.score.home === this.score.away) {
                             this.startOvertime();
                        } else {
                             this.endGame();
                        }
                    }
                    break;
                case 'golden_goal':
                    if (window.flux) window.flux.timeScale = 0.8; // Restore speed
                    this.endGame();
                    break;
            }
        }
    }

    window.flux.GameManager = GameManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class FloatingTextManager {
        constructor(scene, containerId, camera) {
            this.scene = scene;
            this.camera = camera;
            this.container = document.getElementById(containerId);
            this.texts = []; // Active instances
            this.pool = [];  // Inactive instances
            
            // Reusable vector for projection
            this._tempV = new THREE.Vector3();

            // Pre-allocate pool (30 elements)
            this._expandPool(30);
        }

        _expandPool(count) {
            if (!this.container) return;
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'floating-text-wrapper';
                wrapper.style.display = 'none';
                // Force hardware acceleration hint
                wrapper.style.willChange = 'transform, opacity';
                
                const inner = document.createElement('span');
                inner.className = 'floating-text-inner';
                wrapper.appendChild(inner);
                this.container.appendChild(wrapper);

                this.pool.push({
                    el: wrapper,
                    inner: inner,
                    worldPos: new THREE.Vector3(),
                    offset: new THREE.Vector3(),
                    velocity: new THREE.Vector3(),
                    gravity: 0,
                    drag: 0,
                    elasticity: 0.6,
                    floorY: -999,
                    life: 0,
                    maxLife: 1.0,
                    target: null
                });
            }
        }

        spawn(text, worldPos, type = 'default', target = null) {
            if (!this.container || !this.camera) return;

            let instance = this.pool.pop();
            if (!instance) {
                this._expandPool(5);
                instance = this.pool.pop();
            }

            // Reset State
            instance.worldPos.copy(worldPos);
            instance.offset.set(0, 0, 0);
            instance.velocity.set(0, 0, 0);
            instance.gravity = 0;
            instance.drag = 0;
            instance.elasticity = 0.6;
            instance.floorY = -999;
            instance.target = target;
            instance.el.style.display = 'block';
            instance.el.style.opacity = '1';
            // Move offscreen initially to prevent flash
            instance.el.style.transform = 'translate3d(-9999px, -9999px, 0)'; 

            // Update Text & Classes
            instance.inner.innerText = text;
            
            // Smart Class Assignment
            let classes = ['floating-text-inner'];
            classes.push(type);

            const upper = text.toString().toUpperCase();
            if (upper.includes('POISON') || upper.includes('VENOM')) classes.push('venom');
            else if (upper.includes('SLEEP') || upper.includes('NAP') || upper.includes('ZZZ')) classes.push('sleep');
            else if (upper.includes('WITHER')) classes.push('wither');
            else if (type === 'tech' || upper.includes('SHOT') || upper.includes('JECHT') || upper.includes('TACKLE')) classes.push('tech');
            else if (type === 'comic-impact') classes.push('comic-impact');
            else if (type === 'comic-action') classes.push('comic-action');
            else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage');
else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage');
            else if (type === 'save' || type === 'block') classes.push('save');
            
            // New Statuses
            else if (upper.includes('BLIND')) classes.push('blind');
            else if (upper.includes('SILENCE')) classes.push('silence');
            else if (upper.includes('SHIELD')) classes.push('shield');
            else if (upper.includes('HASTE')) classes.push('haste');
else if (upper.includes('SLOW')) classes.push('slow');
            else if (upper.includes('BURN')) classes.push('burn');
            else if (upper.includes('FREEZE') || upper.includes('FROZEN')) classes.push('freeze');
            else if (upper.includes('SHOCK')) classes.push('shock');

            instance.inner.className = classes.join(' ');

            // Physics Setup
            if (classes.includes('damage') || classes.includes('save') || classes.includes('block')) {
                instance.target = null;
                instance.gravity = 40.0;
                instance.drag = 0.5;
// Initialize Floating Text
                const spread = 6.0;
                instance.velocity.set(
                    (Math.random() - 0.5) * spread,
                    15.0 + Math.random() * 5.0,
                    (Math.random() - 0.5) * spread
                );
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('comic-impact')) {
                instance.gravity = 0;
                instance.velocity.set((Math.random()-0.5)*2, 1.0, (Math.random()-0.5)*2);
                instance.life = 0.5;
                instance.maxLife = 0.5;
            } else if (classes.includes('comic-action')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 0.4;
                instance.maxLife = 0.4;
            } else if (classes.includes('tech')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 2.5;
                instance.maxLife = 2.5;
                instance.offset.y = 2.0;
            } else if (classes.includes('sleep')) {
                instance.gravity = -0.5;
                instance.velocity.set(0, 0.5, 0);
                instance.life = 3.0;
                instance.maxLife = 3.0;
instance.maxLife = 3.0;
            } else if (classes.includes('blind')) {
                instance.gravity = 0;
                instance.velocity.set(0, 1.0, 0);
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('silence')) {
                instance.gravity = 0;
                instance.velocity.set(0, 1.0, 0);
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('shield')) {
                instance.gravity = -10.0; // Float up fast
                instance.velocity.set(0, 2.0, 0);
                instance.life = 1.5;
                instance.maxLife = 1.5;
            } else if (classes.includes('haste')) {
                instance.gravity = -20.0;
                instance.velocity.set(0, 5.0, 0);
                instance.life = 1.0;
                instance.maxLife = 1.0;
            } else if (classes.includes('slow')) {
                instance.gravity = 20.0; // Heavy drop
                instance.velocity.set(0, -2.0, 0);
                instance.life = 1.5;
                instance.maxLife = 1.5;
instance.maxLife = 1.5;
            } else if (classes.includes('burn')) {
                instance.gravity = -8.0; // Float up like fire
                instance.velocity.set((Math.random()-0.5)*1.0, 3.0, 0);
                instance.life = 1.5;
                instance.maxLife = 1.5;
            } else if (classes.includes('freeze')) {
                instance.gravity = 0; // Suspended
                instance.velocity.set(0, 0, 0);
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('shock')) {
                instance.gravity = 0;
                instance.velocity.set(0, 0.5, 0); // Slow rise
                instance.life = 1.2;
                instance.maxLife = 1.2;
            } else {
                instance.velocity.set(0, 3.0, 0);
                instance.gravity = 5.0;
                instance.life = 1.0;
                instance.maxLife = 1.0;
            }

            if (!target) {
                instance.worldPos.x += (Math.random() - 0.5) * 0.5;
                instance.worldPos.z += (Math.random() - 0.5) * 0.5;
            }
            instance.worldPos.y += 1.0;

            this.texts.push(instance);
            this.updatePosition(instance);
        }

        update(dt) {
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.life -= dt;

                if (t.target && t.target.parent) { 
                    t.worldPos.copy(t.target.position);
                    t.worldPos.y += 1.0; 
                }

                if (t.gravity !== 0 || t.velocity.lengthSq() > 0) {
                    t.velocity.y -= t.gravity * dt;
                    if (t.drag > 0) {
                        t.velocity.multiplyScalar(Math.max(0, 1.0 - (t.drag * dt)));
                    }
                    t.offset.addScaledVector(t.velocity, dt);

                    if (t.offset.y < t.floorY) {
                        t.offset.y = t.floorY;
                        t.velocity.y *= -t.elasticity;
                        t.velocity.x *= 0.7;
                        t.velocity.z *= 0.7;
                        if (Math.abs(t.velocity.y) < 2.0) t.velocity.y = 0;
                    }
                }

                if (t.life <= 0) {
                    t.el.style.display = 'none';
                    this.pool.push(t);
                    this.texts.splice(i, 1);
                } else {
                    this.updatePosition(t);
                    if (t.life < t.maxLife * 0.3) {
                        t.el.style.opacity = t.life / (t.maxLife * 0.3);
                    }
                }
            }
        }

        updatePosition(t) {
            this._tempV.copy(t.worldPos).add(t.offset);
            this._tempV.project(this.camera);

            // Optimization: Check bounds before setting style to avoid unnecessary paint
            if (this._tempV.z > 1 || Math.abs(this._tempV.x) > 1.1 || Math.abs(this._tempV.y) > 1.1) {
                 // Offscreen
                 if (t.el.style.display !== 'none') t.el.style.display = 'none';
            } else {
                if (t.el.style.display === 'none') t.el.style.display = 'block';
                
                const x = (this._tempV.x * .5 + .5) * this.container.clientWidth;
                const y = (-(this._tempV.y * .5) + .5) * this.container.clientHeight;
                
                // Use translate3d for GPU acceleration
                t.el.style.transform = `translate3d(${x.toFixed(1)}px, ${y.toFixed(1)}px, 0)`;
            }
        }
    }

    window.flux.FloatingTextManager = FloatingTextManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATORS ---
    
    // 1. Venom Bubble (Green, shiny, sharp)
    const _venomTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 4, 32, 32, 30);
        g.addColorStop(0, 'rgba(150, 255, 100, 0.9)');
        g.addColorStop(0.8, 'rgba(0, 200, 0, 0.5)');
        g.addColorStop(1, 'rgba(0, 50, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 2. Sleep Zzz
    const _napTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.font = 'bold italic 48px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#0000ff';
        ctx.shadowBlur = 4;
        ctx.fillText('Z', 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 3. Wither Smoke (Optimized to 32x32)
    const _witherTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(80, 80, 80, 0.8)');
        g.addColorStop(0.5, 'rgba(40, 40, 40, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 4. Shockwave Ring (Optimized to 64x64)
    const _shockwaveTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const cx = 32, cy = 32;
        const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 30);
        g.addColorStop(0, 'rgba(255, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    // 5. Flash Star (Optimized to 32x32)
    const _flashTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const cx = 16, cy = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        for(let i=0; i<4; i++) {
            const a = (i * Math.PI / 2);
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*15, cy + Math.sin(a)*15);
            ctx.lineTo(cx + Math.cos(a + 0.2)*5, cy + Math.sin(a + 0.2)*5);
        }
        ctx.fill();
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 10);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

// 6. Debris Shard (Atlas 2x2)
    const _debrisTex = (() => {
        const c = document.createElement('canvas');
        c.width = 128; c.height = 128; // 64x64 slots
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff';
        
        const drawPoly = (ox, oy, pts) => {
            ctx.save();
            ctx.translate(ox, oy);
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        };

        // Slot 0: Jagged
        drawPoly(0, 0, [[32, 5], [50, 60], [20, 45], [10, 55], [5, 10]]);
        // Slot 1: Triangle
        drawPoly(64, 0, [[32, 5], [60, 60], [5, 50]]);
        // Slot 2: Chunk
        drawPoly(0, 64, [[10, 10], [55, 15], [50, 50], [15, 55]]);
        // Slot 3: Sliver
        drawPoly(64, 64, [[20, 5], [40, 60], [30, 20]]);

        return new THREE.CanvasTexture(c);
    })();

    // 7. Bubble Texture (New: Aesthetic & Subtle)
    const _bubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, 64, 64);

        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 28);
        g.addColorStop(0, 'rgba(255, 255, 255, 0.95)'); 
        g.addColorStop(0.3, 'rgba(200, 240, 255, 0.4)');
        g.addColorStop(0.8, 'rgba(100, 200, 255, 0.1)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
        ctx.beginPath(); 
        ctx.arc(20, 20, 4, 0, Math.PI * 2); 
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    // 8. Micro Bubble (New: Sharp, high-vis cavitation)
    const _microBubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, 32, 32);
        
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
        g.addColorStop(0.3, 'rgba(220, 255, 255, 0.8)');
        g.addColorStop(0.6, 'rgba(100, 200, 255, 0.3)');
        g.addColorStop(1.0, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 16, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 9. Dash Stream (Square for Points)
    const _dashStreamTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        // Draw a streak in the middle
        const g = ctx.createLinearGradient(0, 0, 64, 0);
        g.addColorStop(0, 'rgba(0, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(200, 255, 255, 0.8)');
        g.addColorStop(1, 'rgba(0, 255, 255, 0)');
        
        ctx.fillStyle = g;
        ctx.fillRect(0, 28, 64, 8); // Centered vertically
        
return new THREE.CanvasTexture(c);
    })();

    // 10. Blind (Dark Cloud)
    const _blindTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(20, 20, 20, 0.9)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 14, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 11. Silence (Mute X)
    const _silenceTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.strokeStyle = '#ff00ff';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(8, 8); ctx.lineTo(24, 24);
        ctx.moveTo(24, 8); ctx.lineTo(8, 24);
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    // 12. Shield (Ring)
    const _shieldTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(16, 16, 12, 0, Math.PI*2); ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    // 13. Haste (Arrow)
    const _hasteTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.moveTo(8, 24); ctx.lineTo(16, 8); ctx.lineTo(24, 24);
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 14. Slow (Square)
    const _slowTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#888888';
        ctx.fillRect(8, 8, 16, 16);
        return new THREE.CanvasTexture(c);
    })();
// 15. Fire (Orb)
    const _fireTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 200, 1)');
        g.addColorStop(0.2, 'rgba(255, 200, 0, 0.8)');
        g.addColorStop(0.6, 'rgba(255, 50, 0, 0.4)');
        g.addColorStop(1, 'rgba(100, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 16. Ice (Shard)
    const _iceTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#aaddff';
        ctx.beginPath();
        ctx.moveTo(32, 0);
        ctx.lineTo(48, 32);
        ctx.lineTo(32, 64);
        ctx.lineTo(16, 32);
        ctx.closePath();
        ctx.fill();
        // Inner glint
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(32, 10);
        ctx.lineTo(40, 32);
        ctx.lineTo(32, 54);
        ctx.lineTo(24, 32);
        ctx.closePath();
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 17. Volt (Spark)
    const _voltTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(32, 4);
        ctx.lineTo(16, 24);
        ctx.lineTo(48, 32);
        ctx.lineTo(16, 40);
        ctx.lineTo(32, 60);
        ctx.stroke();
        ctx.shadowColor = '#aa00ff';
        ctx.shadowBlur = 10;
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();
            
// 17. Volt (Spark)
// Duplicate _voltTex removed

class ParticleBatch {
        constructor(scene, texture, maxParticles, blending, grid) {
            this.scene = scene;
            this.maxParticles = maxParticles;
            this.activeCount = 0;
            
            // CPU State
            this.particles = [];
            for(let i=0; i<maxParticles; i++) {
                this.particles.push({
                    active: false,
                    pos: new THREE.Vector3(),
                    vel: new THREE.Vector3(),
                    life: 0,
                    maxLife: 1,
                    scale: 1,
                    startScale: 1,
                    rotation: 0,
                    rotationSpeed: 0, // NEW: Individual rotation speed
                    gravity: 0,
                    drag: 0,
                    color: new THREE.Color(1,1,1),
                    opacity: 1,
                    frame: 0 // NEW: Texture frame index
                });
            }

            // GPU Buffers
            this.positions = new Float32Array(maxParticles * 3);
            this.sizes = new Float32Array(maxParticles);
            this.rotations = new Float32Array(maxParticles);
            this.opacities = new Float32Array(maxParticles);
            this.colors = new Float32Array(maxParticles * 3);
            this.frames = new Float32Array(maxParticles); // NEW

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
            geo.setAttribute('size', new THREE.BufferAttribute(this.sizes, 1));
            geo.setAttribute('rotation', new THREE.BufferAttribute(this.rotations, 1));
            geo.setAttribute('opacity', new THREE.BufferAttribute(this.opacities, 1));
            geo.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));
            geo.setAttribute('frame', new THREE.BufferAttribute(this.frames, 1)); // NEW

            // Shader Material
            const mat = new THREE.ShaderMaterial({
                uniforms: {
                    map: { value: texture },
                    uGrid: { value: grid || new THREE.Vector2(1, 1) }
                },
                vertexShader: `
                    attribute float size;
                    attribute float rotation;
                    attribute float opacity;
                    attribute vec3 color;
                    attribute float frame;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    varying float vFrame;
                    void main() {
                        vRotation = rotation;
                        vOpacity = opacity;
                        vColor = color;
                        vFrame = frame;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_Position = projectionMatrix * mvPosition;
                        // Size attenuation
                        gl_PointSize = size * (300.0 / -mvPosition.z);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D map;
                    uniform vec2 uGrid;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    varying float vFrame;
                    void main() {
                        vec2 uv = gl_PointCoord;
                        vec2 centered = uv - 0.5;
                        float c = cos(vRotation);
                        float s = sin(vRotation);
                        vec2 rotated = vec2(centered.x * c - centered.y * s, centered.x * s + centered.y * c) + 0.5;
                        
                        // Atlas Logic
                        float fx = mod(vFrame, uGrid.x);
                        float fy = floor(vFrame / uGrid.x);
                        
                        // Map to grid cell
                        // Standard UV (0,0 bottom-left). We assume row 0 is top.
                        // Flip row index for GL coords if needed, but let's assume standard grid order.
                        // Row 0 = Top (High V), Row 1 = Bottom (Low V).
                        
                        float glRow = (uGrid.y - 1.0) - fy;
                        
                        vec2 cellUV = rotated / uGrid;
                        vec2 offset = vec2(fx / uGrid.x, glRow / uGrid.y);
                        
                        vec4 tex = texture2D(map, cellUV + offset);
                        
                        gl_FragColor = vec4(tex.rgb * vColor, tex.a * vOpacity);
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: blending
            });

            this.mesh = new THREE.Points(geo, mat);
            this.mesh.frustumCulled = false;
            scene.add(this.mesh);
            
            // Logic hook
            this.updateLogic = null;
        }

        spawn(pos, options) {
            // Find first inactive
            let p = null;
            for(let i=0; i<this.maxParticles; i++) {
                if(!this.particles[i].active) {
                    p = this.particles[i];
                    break;
                }
            }
            
            if (!p) return; // Pool full

            p.active = true;
            p.pos.copy(pos);
            p.life = options.life || 1.0;
            p.maxLife = p.life;
            p.startScale = options.scale || 1.0;
            p.scale = p.startScale;
            p.rotation = options.rotation || 0;
            p.rotationSpeed = options.rotationSpeed || 0; // NEW
            p.vel.copy(options.velocity || new THREE.Vector3());
            p.gravity = options.gravity || 0;
            p.drag = options.drag || 0;
            if (options.color) p.color.set(options.color);
            else p.color.setHex(0xffffff);
            p.opacity = 1.0;
            p.frame = options.frame || 0; // NEW
        }

        update(dt) {
            let activeCount = 0;
            
            for(let i=0; i<this.maxParticles; i++) {
                const p = this.particles[i];
                
                // Safety check for NaN life
                if (isNaN(p.life)) p.life = 0;

                if (!p.active) {
                    this.sizes[i] = 0; // Hide
                    continue;
                }

p.life -= dt;
                
                // Failsafe: Force kill if life is NaN or unreasonably high (stuck particle)
                if (isNaN(p.life) || p.life > 10.0) p.life = 0;

                if (p.life <= 0) {
                    p.active = false;
                    this.sizes[i] = 0;
                    continue;
                }

                // Physics
                if (p.gravity !== 0) p.vel.y -= p.gravity * dt;
                if (p.drag !== 0) p.vel.multiplyScalar(Math.max(0, 1.0 - p.drag * dt));
                p.pos.addScaledVector(p.vel, dt);
                p.rotation += p.rotationSpeed * dt; // Apply rotation speed

                // Logic
const t = Math.max(0, Math.min(1.0, 1.0 - (p.life / p.maxLife)));
                if (this.updateLogic) {
                    this.updateLogic(p, t, dt);
                } else {
                    p.opacity = 1.0 - t;
                }

                // Update Buffers
                this.positions[i*3] = p.pos.x;
                this.positions[i*3+1] = p.pos.y;
                this.positions[i*3+2] = p.pos.z;
                
                this.sizes[i] = p.scale;
                this.rotations[i] = p.rotation;
                this.opacities[i] = p.opacity;
                this.frames[i] = p.frame; // Update frame buffer
                
                this.colors[i*3] = p.color.r;
                this.colors[i*3+1] = p.color.g;
                this.colors[i*3+2] = p.color.b;

                activeCount++;
            }

            if (activeCount > 0 || this.activeCount > 0) {
                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.mesh.geometry.attributes.size.needsUpdate = true;
                this.mesh.geometry.attributes.rotation.needsUpdate = true;
                this.mesh.geometry.attributes.opacity.needsUpdate = true;
                this.mesh.geometry.attributes.color.needsUpdate = true;
                this.mesh.geometry.attributes.frame.needsUpdate = true; // Update frame buffer
            }
            this.activeCount = activeCount;
        }
    }

    class ParticleManager {
        constructor(scene) {
            this.scene = scene;
            this.batches = {};
            
            // Initialize Batches
// Initialize Batches (Optimized Counts)
this._createBatch('venom', _venomTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.y) * 0.05;
                p.opacity = 0.8 * (1.0 - Math.pow(t, 3));
            });

            this._createBatch('nap', _napTex, 10, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (0.5 + t * 1.5);
                p.opacity = 1.0 - Math.pow(t, 2);
                p.pos.x += Math.sin(t * 5) * 0.02;
            });

            this._createBatch('wither', _witherTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 0.6 * (1.0 - t);
                p.rotation += 0.05;
            });

            this._createBatch('learned', _venomTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.color.setHex(0x00ffff);
            });

            this._createBatch('shockwave', _shockwaveTex, 5, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * Math.pow(t, 0.5) * 5.0;
                p.opacity = 1.0 - Math.pow(t, 2);
            });

this._createBatch('flash', _flashTex, 300, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.opacity = 1.0 - t; // Explicit fade out
                p.rotation += 0.2;
            });

this._createBatch('debris', _debrisTex, 200, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
            }, new THREE.Vector2(2, 2)); // 2x2 Grid

this._createBatch('bubble', _bubbleTex, 300, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.z) * 0.02;
                p.scale = p.startScale * (1.0 + t * 0.2);
                p.opacity = 0.6 * (1.0 - Math.pow(t, 2));
                p.color.setHex(0xaaccff);
            });

this._createBatch('bubble_micro', _microBubbleTex, 1000, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t * 0.5);
                p.opacity = 0.9 * (1.0 - t);
                p.pos.x += Math.sin(t * 25.0 + p.pos.y * 0.5) * 0.015; // High freq shimmer
                p.pos.z += Math.cos(t * 20.0 + p.pos.y * 0.5) * 0.015;
            });

            this._createBatch('dash_stream', _dashStreamTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 0.8 * (1.0 - t);
            });

            this._createBatch('blind', _blindTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 0.8 * (1.0 - t);
                p.scale = p.startScale * (1.0 + t);
                p.pos.y += t * 0.5;
            });

            this._createBatch('silence', _silenceTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y += t * 0.5;
            });

            this._createBatch('shield', _shieldTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.scale = p.startScale * (1.0 + t * 0.5);
            });

            this._createBatch('haste', _hasteTex, 10, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y += t * 1.0; // Fast rise
            });

this._createBatch('slow', _slowTex, 10, THREE.NormalBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.pos.y -= t * 0.5; // Sink
            });

            this._createBatch('fire', _fireTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.opacity = 1.0 - t;
                p.pos.y += t * 2.0; // Rise
                p.rotation += 5.0 * t;
            });

            this._createBatch('ice', _iceTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t * 0.5);
                p.opacity = 1.0 - t;
                p.rotation += p.rotationSpeed * 0.1;
            });

            this._createBatch('volt', _voltTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (0.5 + Math.random() * 0.5); // Flicker size
                p.opacity = Math.random(); // Flicker opacity
                p.rotation = Math.random() * Math.PI * 2; // Jitter rotation
            });
this._createBatch('shard', _debrisTex, 500, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.opacity = 1.0 - t;
            }, new THREE.Vector2(2, 2));
            // --- HERCULEAN TACKLE FX ---
            this._createBatch('gather', _flashTex, 50, THREE.AdditiveBlending, (p, t) => {
                // Particles sucking in
                p.opacity = Math.sin(t * Math.PI); // Fade in/out
                p.scale = p.startScale * (0.2 + t * 0.8); // Shrink as they die (t goes 1->0? No, t is 1.0 - life/maxLife. Wait.
                // In update(), t = 1.0 - (p.life / p.maxLife). So t goes 0 -> 1.
                // Actually let's check update(): const t = 1.0 - (p.life / p.maxLife);
                // Yes, t goes 0 to 1.
                // We want gather particles to start far and move in. Physics handles pos.
                // We want them to shrink as they reach center?
                p.scale = p.startScale * (1.0 - t * 0.5); 
                p.rotation += 0.2;
            });

this._createBatch('impact_shard', _debrisTex, 100, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t); // Shrink over time
                p.opacity = 1.0 - t;
            }, new THREE.Vector2(2, 2)); // 2x2 Grid
        }

_createBatch(name, tex, count, blending, logic, grid) {
            const batch = new ParticleBatch(this.scene, tex, count, blending, grid);
            if (logic) batch.updateLogic = logic;
            this.batches[name] = batch;
        }

        spawn(type, pos, options = {}) {
            const batch = this.batches[type];
            if (batch) {
                // Default physics params if not provided
                const opts = { ...options };
                
                // Initialize base velocity from options or zero
                let baseVel = (opts.velocity) ? opts.velocity.clone() : new THREE.Vector3();

                if (type === 'venom') {
                    opts.life = opts.life || 1.0 + Math.random() * 0.5;
                    baseVel.set(0, 1.0 + Math.random(), 0);
                    opts.scale = 0.3 + Math.random() * 0.2;
                } else if (type === 'nap') {
                    opts.life = 2.0;
                    baseVel.set((Math.random()-0.5)*0.2, 0.5, (Math.random()-0.5)*0.2);
                    opts.scale = 0.4;
                } else if (type === 'wither') {
                    opts.life = 1.5;
                    baseVel.set((Math.random()-0.5)*0.5, 0.5, (Math.random()-0.5)*0.5);
                    opts.rotation = Math.random() * Math.PI;
                } else if (type === 'shockwave') {
                    opts.life = opts.life || 0.4;
                    opts.scale = opts.scale || 2.0;
                } else if (type === 'flash') {
                    opts.life = 0.2;
                    opts.scale = opts.scale || 3.0;
                    opts.rotation = Math.random() * Math.PI;
} else if (type === 'debris') {
                    opts.life = 1.5;
                    const speed = 5.0 + Math.random() * 10.0;
                    baseVel.set(
                        (Math.random()-0.5) * speed,
                        (Math.random() * speed * 0.5) + 2.0,
                        (Math.random()-0.5) * speed
                    );
                    opts.gravity = 20.0;
                    opts.drag = 1.0;
                    opts.scale = (opts.scale || 0.3) * (0.5 + Math.random());
                    opts.rotation = Math.random() * Math.PI;
                    opts.rotationSpeed = (Math.random() - 0.5) * 10.0; // Random spin
                    opts.frame = Math.floor(Math.random() * 4); // Random shape
                } else if (type === 'bubble') {
                    opts.life = 1.0 + Math.random() * 1.0;
                    baseVel.set(
                        (Math.random() - 0.5) * 0.5,
                        0.5 + Math.random() * 1.0,
                        (Math.random() - 0.5) * 0.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.4);
                } else if (type === 'bubble_micro') {
                    opts.life = 0.4 + Math.random() * 0.4;
                    baseVel.set(
                        (Math.random() - 0.5) * 1.5,
                        1.5 + Math.random() * 2.0,
                        (Math.random() - 0.5) * 1.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.5);
                } else if (type === 'dash_stream') {
                    opts.life = 0.3;
                    opts.scale = opts.scale || 2.0;
                    opts.rotation = Math.random() * Math.PI;
// Duplicate removed
                } else if (type === 'blind') {
                    opts.life = 1.0;
                    opts.scale = 0.5;
                } else if (type === 'silence') {
                    opts.life = 1.0;
                    opts.scale = 0.4;
                } else if (type === 'shield') {
                    opts.life = 0.8;
                    opts.scale = 0.6;
                } else if (type === 'haste') {
                    opts.life = 0.5;
                    opts.scale = 0.4;
} else if (type === 'slow') {
                    opts.life = 1.0;
                    opts.scale = 0.4;
                } else if (type === 'fire') {
                    opts.life = 0.5 + Math.random() * 0.5;
                    opts.scale = 1.0 + Math.random();
                    baseVel.add(new THREE.Vector3((Math.random()-0.5), 1.0 + Math.random(), (Math.random()-0.5)));
                } else if (type === 'ice') {
                    opts.life = 1.0 + Math.random();
                    opts.scale = 0.5 + Math.random() * 0.5;
                    opts.rotation = Math.random() * Math.PI;
                    opts.rotationSpeed = (Math.random() - 0.5) * 10.0;
                    baseVel.add(new THREE.Vector3((Math.random()-0.5)*2, (Math.random()-0.5)*2, (Math.random()-0.5)*2));
                } else if (type === 'volt') {
                    opts.life = 0.2 + Math.random() * 0.2;
                    opts.scale = 0.8 + Math.random() * 0.5;
                    baseVel.add(new THREE.Vector3((Math.random()-0.5)*3, (Math.random()-0.5)*3, (Math.random()-0.5)*3));
                }
                // --- MOMENTUM INHERITANCE ---
                if (opts.emitterVelocity) {
                    const momentumScale = (opts.momentumScale !== undefined) ? opts.momentumScale : 0.2;
                    if (momentumScale !== 0) {
                        baseVel.addScaledVector(opts.emitterVelocity, momentumScale);
                    }
                }

                opts.velocity = baseVel;

                batch.spawn(pos, opts);
            }
}

        update(dt) {
            for (const key in this.batches) {
                this.batches[key].update(dt);
            }
        }
    }

    window.flux.ParticleManager = ParticleManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATION ---
    const _createGlyphTexture = (colorStr, type) => {
        const size = 256;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, size, size);
        
        // Glow settings
        ctx.shadowBlur = 15;
        ctx.shadowColor = colorStr;
        ctx.strokeStyle = colorStr;
        ctx.fillStyle = colorStr;
        ctx.lineCap = 'round';

        const cx = size / 2;
        const cy = size / 2;

        if (type === 'ring') {
            // Outer Ring
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, 0, Math.PI * 2);
            ctx.stroke();

            // Inner Ring
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 90, 0, Math.PI * 2);
            ctx.stroke();

            // Runes
ctx.font = '24px Spira, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 100;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                // Draw a simple rune-like shape
                ctx.beginPath();
                ctx.moveTo(-5, -5); ctx.lineTo(5, 0); ctx.lineTo(-5, 5);
                ctx.stroke();
                ctx.restore();
            }
        } else if (type === 'rune') {
            // Central Complex Rune
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - 60);
            ctx.lineTo(cx, cy + 60);
            ctx.moveTo(cx - 60, cy);
            ctx.lineTo(cx + 60, cy);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        const tex = new THREE.CanvasTexture(c);
        return tex;
    };

    const _techTexture = _createGlyphTexture('#00ffff', 'ring'); // Cyan Ring
    const _statusTexture = _createGlyphTexture('#ff00ff', 'rune'); // Magenta Rune
    const _chargeTexture = _createGlyphTexture('#ffff00', 'ring'); // Gold Ring

    class GlyphManager {
        constructor(scene) {
            this.scene = scene;
            this.glyphs = [];
            
            // Materials
            this.materials = {
                tech: new THREE.MeshBasicMaterial({ 
                    map: _techTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                status: new THREE.MeshBasicMaterial({ 
                    map: _statusTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                charge: new THREE.MeshBasicMaterial({ 
                    map: _chargeTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                })
            };

            // Pool
            this.pool = [];
            this.poolSize = 30;
            const geo = new THREE.PlaneGeometry(1, 1);
            
            for(let i=0; i<this.poolSize; i++) {
                const mesh = new THREE.Mesh(geo, this.materials.tech);
                mesh.visible = false;
                mesh.renderOrder = 2000; // Draw on top of water/arena
                this.scene.add(mesh);
                this.pool.push(mesh);
            }
        }

        spawn(type, pos, options = {}) {
            const mesh = this.pool.find(m => !m.visible);
            if (!mesh) return;

            mesh.visible = true;
            mesh.material = this.materials[type] || this.materials.tech;
            mesh.position.copy(pos);
            
            // Reset Material Opacity
            mesh.material.opacity = 1.0;

            // Defaults
            const scale = options.scale || 1.0;
            mesh.scale.set(scale, scale, scale);
            
            // Orientation
            if (options.faceCamera) {
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    mesh.lookAt(window.flux.gameInstance.camera.position);
                }
            } else if (options.orientation === 'vertical') {
                mesh.rotation.set(0, 0, 0);
                // Face camera Y-axis rotation only
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    const camPos = window.flux.gameInstance.camera.position;
                    const angle = Math.atan2(camPos.x - pos.x, camPos.z - pos.z);
                    mesh.rotation.y = angle;
                }
            } else {
                // Horizontal (Ground)
                mesh.rotation.set(-Math.PI / 2, 0, Math.random() * Math.PI);
            }

            if (options.offsetY) {
                mesh.position.y += options.offsetY;
            }

            this.glyphs.push({
                mesh: mesh,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                rotationSpeed: options.rotationSpeed || 1.0,
                scaleSpeed: options.scaleSpeed || 0,
                fade: options.fade !== undefined ? options.fade : true,
                followTarget: options.parent || null,
                offsetY: options.offsetY || 0
            });
        }
update(dt) {
            for (let i = this.glyphs.length - 1; i >= 0; i--) {
                const g = this.glyphs[i];
                g.age += dt;

                if (g.age >= g.life) {
                    g.mesh.visible = false;
                    this.glyphs.splice(i, 1);
                    continue;
                }

                const t = g.age / g.maxLife;

                // Follow target
                if (g.followTarget && g.followTarget.mesh) {
                    g.mesh.position.copy(g.followTarget.mesh.position);
                    g.mesh.position.y += g.offsetY;
                    
                    // If ground oriented, keep near floor
                    if (g.mesh.rotation.x === -Math.PI/2) {
                         g.mesh.position.y = 0.1 + g.offsetY;
                    }
                }

                // Animation
                g.mesh.rotation.z += g.rotationSpeed * dt;
                
                if (g.scaleSpeed !== 0) {
                    const s = g.mesh.scale.x + g.scaleSpeed * dt;
                    g.mesh.scale.set(s, s, s);
                }

                // Fade
                if (g.fade) {
                    let opacity = 1.0;
                    if (t < 0.1) opacity = t / 0.1;
                    else if (t > 0.7) opacity = 1.0 - ((t - 0.7) / 0.3);
                    g.mesh.material.opacity = opacity;
                }
            }
        }

        clear() {
            // Hide all active glyphs and reset list
            for (const g of this.glyphs) {
                if (g.mesh) g.mesh.visible = false;
            }
            this.glyphs = [];
        }
    }

    window.flux.GlyphManager = GlyphManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors to avoid Garbage Collection
    const _idealPos = new THREE.Vector3();
    const _idealLook = new THREE.Vector3();
    const _currentPos = new THREE.Vector3();
    const _currentLook = new THREE.Vector3();
    const _velocity = new THREE.Vector3();
    const _targetWorldPos = new THREE.Vector3();
    const _camOffset = new THREE.Vector3();
    const _lookAhead = new THREE.Vector3();
    const _goalPos = new THREE.Vector3();
    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();

    class CameraManager {
        constructor(camera, scene) {
            this.camera = camera;
            this.scene = scene;

            // --- IMPROVED CONFIGURATION ---
// --- IMPROVED CONFIGURATION ---
this.config = {
                // FIXED PERSPECTIVE SETTINGS
                baseDistance: 14.0,   // Closer for immersion (was 20.0)
                baseHeight: 8.0,      // Lower angle for chase feel (was 12.0)

                // IMPROVED: Faster, more responsive smoothing
                followSpeed: 6.0,     // Snappier follow
                lookSpeed: 4.0,       // Responsive look-at

                // Dynamic FOV
                fovBase: 65,          // Higher base FOV (was 50)
                fovMax: 85,           // Higher max for speed sensation (was 70)

                // IMPROVED: Look-ahead settings
                lookAheadDistance: 10.0, // Look further ahead
                lookAheadSmoothing: 4.0,

                // Smart framing
                ballTrackWeight: 0.15, 
                threatAwareness: true
            };

            // State
            this.target = null;
            this.ball = null; // Direct ball reference for smart framing
            this.targetVel = new THREE.Vector3();
            this.targetInput = new THREE.Vector3();
            this.smoothedInput = new THREE.Vector3();
            this.smoothedLookAhead = new THREE.Vector3();

            // Camera State
            this.pos = camera.position.clone();
            this.lookAt = new THREE.Vector3(0, 0, 0);

            // Orbit State
            this.currentYaw = Math.PI;
            this.targetYaw = Math.PI;

            // IMPROVED: Manual orbit from touch (right side of screen)
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
            this.orbitSensitivity = 0.004;
            this.autoRecenterTimer = 0;
            this.autoRecenterDelay = 3.0;

// Shake
            this.shakeIntensity = 0;
            this.shakeRoll = 0; // NEW: Rotational shake
this.shakeOffset = new THREE.Vector3();
            this.fovImpulse = 0;
this.rollImpulse = 0; // NEW: Dynamic tilt for curves
            this.recoilOffset = new THREE.Vector3(); // NEW: Directional Recoil
this.recoilOffset = new THREE.Vector3(); // NEW: Directional Recoil
            this.aberrationImpulse = 0; // NEW: Chromatic Aberration Kick
            // Cinematic State
            this.isCinematic = false;
            this.cinematicTimer = 0;
            this.cinematicDuration = 0;
            this.cinematicType = 'default';
            this.cinematicStartPos = new THREE.Vector3();
            this.cinematicStartLook = new THREE.Vector3();
            this.cinematicEndPos = new THREE.Vector3();

            // IMPROVED: Dynamic pull-back based on action
            this.currentPullBack = 0;
            this.maxPullBack = 8;
        }

        // NEW: Set ball reference for smart framing
        setBall(ball) {
            this.ball = ball;
        }

        // IMPROVED: Get camera-relative input transformation
        getCameraRelativeInput(inputX, inputZ) {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), _camFwd).normalize();

            // Transform input to world space
            const worldX = (inputX * _camRight.x) + (inputZ * _camFwd.x);
            const worldZ = (inputX * _camRight.z) + (inputZ * _camFwd.z);

            return { x: worldX, z: worldZ };
        }

        // NEW: Manual orbit input from touch
        handleOrbitInput(dx, dy) {
            this.manualOrbitYaw += dx * this.orbitSensitivity;
            this.manualOrbitPitch += dy * this.orbitSensitivity * 0.5;

            // Clamp pitch
            this.manualOrbitPitch = Math.max(-0.3, Math.min(0.5, this.manualOrbitPitch));

            // Reset auto-recenter timer
            this.autoRecenterTimer = 0;
        }

        // NEW: Recenter camera
        recenter() {
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
        }

        playCinematic(type, target, duration = 1.5) {
            this.isCinematic = true;
            this.cinematicTimer = 0;
            this.cinematicDuration = duration;
            this.target = target;
            this.cinematicType = type;

            this.cinematicStartPos.copy(this.pos);
            this.cinematicStartLook.copy(this.lookAt);

            this.addFovImpulse(-15);
        }

        _updateCinematic(dt) {
            this.cinematicTimer += dt;
            const progress = Math.min(1.0, this.cinematicTimer / this.cinematicDuration);

            const t = 1 - Math.pow(1 - progress, 3);

            let activeTarget = this.target;
            let isBallTracking = false;
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;

            if (ball && ball.mesh && ball.state === 'free' && ball.velocity.lengthSq() > 2.0) {
                activeTarget = ball.mesh;
                isBallTracking = true;
            }

            if (!activeTarget) {
                this.isCinematic = false;
                return;
            }

            activeTarget.getWorldPosition(_targetWorldPos);

            const endLook = _targetWorldPos.clone();
            let fwd = new THREE.Vector3();
            let right = new THREE.Vector3();

            if (isBallTracking) {
                endLook.addScaledVector(ball.velocity, 0.3);

                fwd.copy(ball.velocity).normalize();
                fwd.y = 0;
                if (fwd.lengthSq() < 0.01) fwd.set(0,0,1);
                fwd.normalize();

                right.crossVectors(new THREE.Vector3(0,1,0), fwd).normalize();
            } else {
                endLook.y += 1.5;
                fwd.set(0, 0, 1).applyQuaternion(activeTarget.quaternion);
                right.set(1, 0, 0).applyQuaternion(activeTarget.quaternion);
            }

            const endPos = _targetWorldPos.clone();

            if (this.cinematicType === 'jecht') {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist).add(right.clone().multiplyScalar(3.0));
                endPos.add(offset);
                endPos.y += 6.0;
            } else if (this.cinematicType === 'sphere') {
                const dist = isBallTracking ? 16.0 : 12.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 10.0;
            } else if (this.cinematicType === 'invisible') {
                const dist = 12.0;
                const offset = fwd.clone().multiplyScalar(-dist * 0.5).add(right.clone().multiplyScalar(dist));
                endPos.add(offset);
                endPos.y += 5.0;
            } else {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 5.0;
            }

            this.pos.lerp(endPos, dt * 4.0);
            this.lookAt.lerp(endLook, dt * 6.0);

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            if (this.cinematicTimer >= this.cinematicDuration) {
                this.isCinematic = false;
            }
        }

setTarget(mesh, velocity, input, isAiming = false) {
            this.target = mesh;
            if (velocity) this.targetVel.copy(velocity);
            if (input) this.targetInput.copy(input);
            else this.targetInput.set(0, 0, 0);
            this.isAiming = isAiming;
        }

        // Keep for compatibility
        handleInput(dx, dy) {
            this.handleOrbitInput(dx, dy);
        }

        getYaw() { return this.currentYaw; }

        addShake(amount) {

            this.shakeIntensity = Math.min(this.shakeIntensity + amount, 4.0); // Increased cap
            this.shakeRoll = Math.min(this.shakeRoll + amount * 0.2, 0.8); // Add roll
        }
        addFovImpulse(amount) {
            this.fovImpulse = Math.min(this.fovImpulse + amount, 30);

        }
        addRollImpulse(amount) {
            this.rollImpulse += amount;
this.rollImpulse = Math.max(-0.5, Math.min(0.5, this.rollImpulse));
        }

addRecoil(x, y, z) {
            this.recoilOffset.x += x;
            this.recoilOffset.y += y;
            this.recoilOffset.z += z;
        }

        addAberration(amount) {
            this.aberrationImpulse = Math.max(this.aberrationImpulse, amount);
        }

snapToTarget() {
            if (!this.target) return;
            this.target.getWorldPosition(_targetWorldPos);

            this._calculateIdealState(0);

            this.pos.copy(_idealPos);
            this.lookAt.copy(_idealLook);
            this.currentYaw = this.targetYaw;

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            this.smoothedInput.set(0, 0, 0);
            this.smoothedLookAhead.set(0, 0, 0);
        }

        update(dt) {
            if (this.isCinematic) {
                this._updateCinematic(dt);
                return;
            }

            if (!this.target) return;

            const safeDt = Math.min(dt, 0.05);

            // IMPROVED: Auto-recenter logic (Only if not aiming)
            if (!this.isAiming) {
                this.autoRecenterTimer += safeDt;
                if (this.autoRecenterTimer > this.autoRecenterDelay) {
                    const recenterSpeed = 2.0 * safeDt;
                    this.manualOrbitYaw *= (1.0 - recenterSpeed);
                    this.manualOrbitPitch *= (1.0 - recenterSpeed);
                }
            }

            // IMPROVED: Smart pull-back based on ball speed
            if (this.ball && this.ball.velocity) {
                const ballSpeed = this.ball.velocity.length();
                const targetPullBack = Math.min(this.maxPullBack, ballSpeed * 0.3);
                this.currentPullBack += (targetPullBack - this.currentPullBack) * safeDt * 3.0;
            } else {
                this.currentPullBack *= (1.0 - safeDt * 2.0);
            }

            // 1. Update Target Info
            this.target.getWorldPosition(_targetWorldPos);

            // 2. Calculate Ideal State
            this._calculateIdealState(safeDt);

            // 3. IMPROVED: Faster, more responsive smoothing
// 3. IMPROVED: Faster, more responsive smoothing
            // Dynamic follow speed based on distance error (Catch-up logic)
            const distError = this.pos.distanceTo(_idealPos);
            const dynamicFollow = this.config.followSpeed + (distError * 0.2);
            
            const speedMult = this.isAiming ? 2.0 : 1.0;
            const lookFactor = 1.0 - Math.exp(-this.config.lookSpeed * speedMult * safeDt);
            const posFactor = 1.0 - Math.exp(-dynamicFollow * speedMult * safeDt);

this.pos.lerp(_idealPos, posFactor);
            this.lookAt.lerp(_idealLook, lookFactor);

            // 4. Screen Shake (Position & Rotation)
            if (this.shakeIntensity > 0) {
                const decay = 8.0 * safeDt; // Fast decay for snappy feel
                this.shakeIntensity -= decay;
                if (this.shakeIntensity < 0) this.shakeIntensity = 0;

                const shakeMag = this.shakeIntensity * 0.5;
                this.shakeOffset.set(
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag
                );
            } else {
                this.shakeOffset.set(0, 0, 0);
            }

            // Roll Shake
            if (this.shakeRoll > 0) {
                this.shakeRoll -= 5.0 * safeDt;
                if (this.shakeRoll < 0) this.shakeRoll = 0;
                this.camera.rotation.z = (Math.random() - 0.5) * this.shakeRoll;
} else {
                this.camera.rotation.z = 0;
            }
            
            // Apply Curve Tilt (Roll Impulse)
            if (Math.abs(this.rollImpulse) > 0.001) {
                this.camera.rotation.z += this.rollImpulse;
this.rollImpulse *= (1.0 - 4.0 * safeDt); // Decay
            }

            // Recoil Decay
this.recoilOffset.multiplyScalar(Math.max(0, 1.0 - (8.0 * safeDt)));

            // Aberration Decay & Apply
            if (this.aberrationImpulse > 0) {
                this.aberrationImpulse *= Math.max(0, 1.0 - (5.0 * safeDt));
                if (this.aberrationImpulse < 0.1) this.aberrationImpulse = 0;
                
                if (window.flux.gameInstance && window.flux.gameInstance.postProcessing) {
                    // Base 1.5 + Impulse
                    window.flux.gameInstance.postProcessing.uniforms.uAberration.value = 1.5 + this.aberrationImpulse;
                }
            } else if (window.flux.gameInstance && window.flux.gameInstance.postProcessing) {
                // Reset to base if no impulse (and not dirty)
                if (window.flux.gameInstance.postProcessing.uniforms.uAberration.value > 1.6) {
                     window.flux.gameInstance.postProcessing.uniforms.uAberration.value = 1.5;
                }
            }
            // 5. Dynamic FOV
// 5. Dynamic FOV
            const speed = this.targetVel.length();
            const speedRatio = Math.min(speed / 25.0, 1.0);
            const warp = speedRatio * speedRatio;

            // Zoom in slightly when aiming
            const aimZoom = this.isAiming ? -10 : 0;
            const targetFov = this.config.fovBase + (this.config.fovMax - this.config.fovBase) * warp + this.fovImpulse + aimZoom;

            this.fovImpulse *= Math.max(0, 1.0 - (6.0 * safeDt));

            this.camera.fov += (targetFov - this.camera.fov) * 4.0 * safeDt;
            this.camera.updateProjectionMatrix();

// 6. Apply to Camera
            this.camera.position.copy(this.pos).add(this.shakeOffset).add(this.recoilOffset);
            this.camera.lookAt(this.lookAt);
        }

_calculateIdealState(dt) {
            const tPos = _targetWorldPos;

            // --- AIM MODE OVERRIDE ---
            if (this.isAiming) {
                // Relaxed Aim Mode: Zoom in but maintain orientation
                const aimDist = 14.0; 
                const aimHeight = 6.0;
                
                // Use Manual Orbit Logic (Consistent with Standard Mode)
                const effectiveDistance = aimDist;
                const effectiveHeight = aimHeight + this.manualOrbitPitch * 10;
                
                // Base Z offset (Camera defaults to +Z)
                const camZ = effectiveDistance;
                
                // Apply Orbit Rotation
                const finalX = camZ * Math.sin(this.manualOrbitYaw);
                const finalZ = camZ * Math.cos(this.manualOrbitYaw);
                
                _idealPos.set(tPos.x + finalX, tPos.y + effectiveHeight, tPos.z + finalZ);
                
                _idealLook.copy(tPos);
                _idealLook.y += 1.0; // Look at player center
                
                // Disable look-ahead to keep framing stable while aiming
                this.smoothedLookAhead.set(0,0,0);
                
                return;
            }

            // --- STANDARD MODE ---

            // 0. Threat Assessment (Dynamic Pull-back)
            let threatPullback = 0;
            if (this.config.threatAwareness) {
                const threat = this._calculateThreatLevel(tPos);
                threatPullback = threat * 6.0; // Pull back up to 6 units
            }

// IMPROVED: Apply manual orbit & Portrait Adjustment
// IMPROVED: Apply manual orbit & Portrait Adjustment
            const aspect = this.camera.aspect;
            // 9:16 is ~0.56. We trigger adjustment if narrower than square.
            const isPortrait = aspect < 0.85; 
            const portraitMult = isPortrait ? 1.7 : 1.0; // Pull back 70% more in portrait to see the field
            // 1. Calculate Ideal Position with pull-back
            const effectiveDistance = (this.config.baseDistance + this.currentPullBack + threatPullback) * portraitMult;
            const effectiveHeight = (this.config.baseHeight + this.currentPullBack * 0.3 + threatPullback * 0.5 + this.manualOrbitPitch * 10) * portraitMult;

            // Base offset (Camera usually sits at +Z relative to target)
            const camZ = effectiveDistance;

            // Apply Orbit Rotation
            const finalCamX = camZ * Math.sin(this.manualOrbitYaw);
            const finalCamZ = camZ * Math.cos(this.manualOrbitYaw);

            _idealPos.set(tPos.x + finalCamX, tPos.y + effectiveHeight, tPos.z + finalCamZ);

            // Clamp to arena bounds (roughly) to prevent clipping through walls
            if (_idealPos.z > 48.0) _idealPos.z = 48.0;
            if (_idealPos.z < -48.0) _idealPos.z = -48.0;

            // 2. Calculate Ideal LookAt with IMPROVED look-ahead
            _idealLook.copy(tPos);

            // IMPROVED: Velocity-based look-ahead
            if (this.targetVel.lengthSq() > 0.5) {
                const speed = this.targetVel.length();
                const lookAheadFactor = Math.min(1.0, speed / 15.0) * this.config.lookAheadDistance;

                const velDir = this.targetVel.clone().normalize();
                _lookAhead.copy(velDir).multiplyScalar(lookAheadFactor);

                // Smooth the look-ahead
                this.smoothedLookAhead.lerp(_lookAhead, dt * this.config.lookAheadSmoothing);
                _idealLook.add(this.smoothedLookAhead);
            } else {
                this.smoothedLookAhead.multiplyScalar(1.0 - dt * 3.0);
                _idealLook.add(this.smoothedLookAhead);
            }

            _idealLook.y *= 0.5; // Look slightly lower than actual target height

            // IMPROVED: Include ball in framing when nearby
            if (this.ball && this.ball.mesh && this.config.ballTrackWeight > 0) {
                const ballPos = this.ball.mesh.position;
                const distToBall = tPos.distanceTo(ballPos);

                if (distToBall < 25 && distToBall > 2) {
                    const ballWeight = Math.max(0, 1 - distToBall / 25) * this.config.ballTrackWeight;
                    _idealLook.lerp(ballPos, ballWeight);
                }
            }

            // 3. Input Anticipation (Smoothed)
            this.smoothedInput.lerp(this.targetInput, dt * 3.0);

            if (this.smoothedInput.lengthSq() > 0.01) {
                _idealLook.x += this.smoothedInput.x * 4.0;
                _idealLook.z += this.smoothedInput.z * 4.0;
            }
        }

        _calculateThreatLevel(centerPos) {
            if (!window.flux.gameInstance) return 0;
const game = window.flux.gameInstance;
            if (!game.teams) return 0;
            
            let density = 0;
            const checkTeam = (team) => {
                if (!team) return;
                for (let i = 0; i < team.players.length; i++) {
                    const p = team.players[i];
                    if (p.mesh && p.mesh !== this.target) {
                        const dSq = p.mesh.position.distanceToSquared(centerPos);
                        if (dSq < 64.0) { // 8m radius
                            density += 1.0;
                        }
                    }
                }
            };
            checkTeam(game.teams.home);
            checkTeam(game.teams.away);
            
            return Math.min(1.0, density / 4.0); // Cap at 4 players
        }

        // NEW: Get forward direction for UI reference
        getForwardDirection() {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;
            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }
            return _camFwd.clone();
        }

        // NEW: Get right direction
        getRightDirection() {
            const fwd = this.getForwardDirection();
            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), fwd).normalize();
            return _camRight.clone();
        }
    }

    window.flux.CameraManager = CameraManager;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Tooltip Descriptions for Long-Press
    const TOOLTIP_DESCRIPTIONS = {
        'SUBSTEPS': "Physics iterations per frame. Higher = more stable, more CPU.",
        'STOP_SPEED': "Velocity threshold below which the ball snaps to a halt.",
        'WATER_DRAG_LINEAR': "Base water resistance. Slows ball linearly.",
        'WATER_DRAG_QUAD': "Quadratic drag. Slows high-speed balls significantly.",
        'SPIN_DRAG': "How fast the ball's spin decays over time.",
        'MAGNUS_ENABLED': "Enables the Magnus effect (curve from spin).",
        'MAGNUS_COEFF': "Strength of the curve force relative to spin/speed.",
        'MAGNUS_CAP': "Maximum curve force allowed (prevents physics explosions).",
        'DEPTH_TARGET_Y': "Ideal Y height the ball tries to float at.",
        'DEPTH_SPRING': "Strength of the force pulling ball to Target Y.",
        'DEPTH_DAMP': "Damping on vertical movement to prevent oscillation.",
        'BOUNDARY_RADIUS': "Radius of the circular arena wall.",
        'BOUNDARY_HEIGHT': "Height of the arena ceiling/floor.",
        'WALL_SOFT_BUFFER': "Distance from wall where soft repulsion begins.",
        'WALL_SOFT_FORCE': "Force pushing ball away from wall before impact.",
        'WALL_ELASTICITY': "Bounciness of the wall (0 = dead thud, 1 = perfect bounce).",
        'WALL_FRICTION': "Friction when sliding along the wall.",
        'FLOOR_ELASTICITY': "Bounciness of the floor/ceiling.",
        'GOAL_POCKET_ENABLED': "Enables the extended corridor for the goal.",
        'GOAL_POCKET_X': "Half-width of the goal pocket corridor.",
        'GOAL_POCKET_Z': "Z-depth where the pocket starts.",
        'GOAL_POCKET_RADIUS': "Effective radius inside the pocket.",
        'LAUNCH_SPEED_SCALE': "Multiplier for converting Stat Power to Physics Velocity.",
        'LAUNCH_SPEED_CAP': "Maximum physical speed the ball can be thrown.",
        'SWIPE_MIN_PX': "Minimum swipe distance to register a throw.",
        'AIM_DX_SCALE': "Sensitivity of horizontal aim from swipe.",
        'AIM_DY_SCALE': "Sensitivity of vertical aim from swipe.",
        'POWER_BASE': "Base power multiplier for a quick tap.",
        'POWER_RANGE': "Additional power multiplier at full charge.",
        'POWER_MAX_BONUS_RATIO': "Charge threshold for 'Max Power' bonus.",
        'POWER_MAX_MULTIPLIER': "Multiplier applied when hitting Max Power.",
        'CURVE_ENABLED': "Enables curve shots via curved swipes.",
        'CURVE_INTENSITY_THRESHOLD': "How curved a swipe must be to trigger spin.",
        'CURVE_SPIN_SCALE': "Multiplier for converting swipe curve to ball spin.",
        'CURVE_SPEED_MULT': "Multiplier for spin based on swipe speed.",
        'CURVE_SPIN_CAP': "Maximum spin allowed from a curve throw.",
        'CURVE_PERFECT_SPIN': "Spin threshold to trigger 'Perfect Curve' FX.",
        'timeScale': "Global game speed multiplier.",
        'demoMode': "Toggle AI vs AI auto-play.",
        'resolution': "Internal render resolution scale (0.5 = half res).",
        'arenaOpacity': "Opacity of the outer arena grid.",
'arena2Opacity': "Opacity of the inner hex grid.",

'GOAL_DISTANCE': "Distance of the goals from the center (Z-axis).",
        'scanline': "Strength of the CRT scanline effect.",
        'vignette': "Darkening of the screen corners.",
        'noise': "Film grain intensity.",
        'aberration': "RGB color separation offset (Chromatic Aberration).",
        'contrast': "Global contrast adjustment.",
        'saturation': "Global color saturation adjustment."
    };
    class DevTools {
        constructor(gameManager) {
            this.game = gameManager;
            
            // lil-gui attaches to window.lil by default in UMD build
            if (!window.lil || !window.lil.GUI) {
                console.warn("DevTools: lil-gui not found.");
                return;
            }

const container = document.getElementById('game-container');
            this.gui = new window.lil.GUI({ title: 'Flux DevTools', container: container });
            
            // Position as a collapsed tab on the right frame
// Position as a sliding tab on the right frame
// Position as a sliding tab on the right frame
// Wrapper for sliding animation
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '100px';
            wrapper.style.right = '-260px';
            wrapper.style.width = '260px';
            wrapper.style.transition = 'right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0)';
            wrapper.style.zIndex = '9999';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            container.appendChild(wrapper);

            const dom = this.gui.domElement;
            dom.style.width = '100%';
            dom.style.setProperty('--width', '100%');
            dom.style.maxHeight = '80vh';
            dom.style.overflowY = 'auto';
            dom.style.overflowX = 'hidden';
            
            // Move GUI into wrapper
            wrapper.appendChild(dom);
            
            // Create Toggle Handle
            const handle = document.createElement('div');
            handle.style.position = 'absolute';
            handle.style.left = '-40px'; // Protrude to the left
            handle.style.top = '0';
            handle.style.width = '40px';
            handle.style.height = '40px';
            handle.style.backgroundColor = 'rgba(0, 20, 40, 0.9)';
            handle.style.border = '1px solid #00ffff';
            handle.style.borderRight = 'none';
            handle.style.borderTopLeftRadius = '8px';
            handle.style.borderBottomLeftRadius = '8px';
            handle.style.cursor = 'pointer';
            handle.style.display = 'flex';
            handle.style.justifyContent = 'center';
            handle.style.alignItems = 'center';
            handle.style.color = '#00ffff';
            handle.style.fontSize = '20px';
            handle.innerHTML = '';
            handle.style.boxShadow = '-5px 0 10px rgba(0,0,0,0.5)';
            
            wrapper.appendChild(handle);
            
            // Toggle Logic
            let isOpen = false;
            handle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent game inputs
                isOpen = !isOpen;
                wrapper.style.right = isOpen ? '0px' : '-260px';
                handle.innerHTML = isOpen ? '' : '';
            });
            // Default global timeScale if not set
if (window.flux.timeScale === undefined) window.flux.timeScale = 0.8;

this._setupGeneral();
            this._setupGameState();
this._setupOverlays();
this._setupTeams();
            this._setupThemes();
            this._setupPlayerInspector();
            this._setupPlayerInspector();
            this._setupBallSandbox();
this._setupFXLab();
this._setupVisualDebug();
            this._setupVisuals();
            this._setupAudio();
            this._setupPostProcessing();
// Duplicate removed
            this._setupRuntimeMonitor();
            this._setupTooltips();

}
        _setupRuntimeMonitor() {
            const folder = this.gui.addFolder('Runtime Monitor');
            
            // Create DOM Overlay
            this.monitorEl = document.createElement('div');
            Object.assign(this.monitorEl.style, {
                position: 'absolute',
                top: '80px', 
                left: '10px',
                padding: '8px',
                background: 'rgba(0, 0, 0, 0.8)',
                border: '1px solid #00ff00',
                color: '#00ff00',
                fontFamily: 'monospace',
                fontSize: '11px',
                lineHeight: '1.4',
                pointerEvents: 'none',
                zIndex: '10000',
                display: 'none',
                minWidth: '150px',
                borderRadius: '4px',
                textShadow: '1px 1px 0 #000'
            });
            document.body.appendChild(this.monitorEl);

            const params = {
                showOverlay: false
            };

            folder.add(params, 'showOverlay').name('Show Overlay').onChange(v => {
                this.monitorEl.style.display = v ? 'block' : 'none';
            });
            
            // Start update loop
            setInterval(() => {
                if (params.showOverlay) this._updateMonitor();
            }, 50);
        }

        _updateMonitor() {
            if (!this.game) return;
            const gm = this.game;
            const ball = gm.entities.ball;

            let html = `<div style="border-bottom:1px solid #444; margin-bottom:4px; font-weight:bold; color:#fff">GAME STATE</div>`;
            html += `State: <span style="color:#fff">${gm.state}</span><br>`;
            html += `State Timer: ${gm.stateTimer.toFixed(2)}s<br>`;
            html += `Match Time: ${Math.floor(gm.time/60)}:${Math.floor(gm.time%60).toString().padStart(2,'0')} (H${gm.half})<br>`;
            
            html += `<div style="border-bottom:1px solid #444; margin-bottom:4px; margin-top:8px; font-weight:bold; color:#fff">BALL</div>`;
            if (ball && ball.mesh) {
                const stateColor = ball.state === 'free' ? '#0af' : (ball.state === 'held' ? '#fa0' : '#f0f');
                html += `State: <span style="color:${stateColor}">${ball.state}</span><br>`;
                
                let holderStr = 'None';
                if (ball.holder) {
                    const name = ball.holder.characterName || ball.holder.role;
                    const team = ball.holder.team ? ball.holder.team.id.toUpperCase() : '?';
                    holderStr = `${name} (${team})`;
                }
                html += `Holder: <span style="color:#fff">${holderStr}</span><br>`;
                
                const p = ball.mesh.position;
                html += `Pos: ${p.x.toFixed(1)}, ${p.y.toFixed(1)}, ${p.z.toFixed(1)}<br>`;
                html += `Speed: ${ball.velocity.length().toFixed(1)}<br>`;
                
                if (ball.power > 0) {
                    html += `Power: ${ball.power.toFixed(1)} (${ball.powerType})<br>`;
                }
            } else {
                html += `OFFLINE<br>`;
            }

            this.monitorEl.innerHTML = html;
        }

        _setupTooltips() {
            // Create Tooltip DOM
            this.tooltipEl = document.createElement('div');
            Object.assign(this.tooltipEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                backgroundColor: 'rgba(0, 10, 30, 0.95)',
                border: '2px solid #00ffff',
                padding: '20px',
                color: '#fff',
                fontFamily: 'monospace',
                fontSize: '14px',
                maxWidth: '300px',
                zIndex: '10000',
                display: 'none',
                pointerEvents: 'none',
                boxShadow: '0 0 20px rgba(0, 255, 255, 0.3)',
                borderRadius: '8px',
                textAlign: 'center'
            });
            document.body.appendChild(this.tooltipEl);

            // Recursive function to attach listeners
            const attach = (gui) => {
                // Controllers
                if (gui.controllers) {
                    gui.controllers.forEach(c => {
                        const dom = c.domElement.closest('.controller'); // lil-gui structure
                        if(dom) {
                            const label = dom.querySelector('.name');
                            if(label) {
                                this._addLongPress(label, c.property, c._name);
                            }
                        }
                    });
                }
                // Sub-folders
                if(gui.folders) {
                    gui.folders.forEach(f => attach(f));
                }
            };

            // Wait a tick for GUI to fully render DOM
            setTimeout(() => attach(this.gui), 100);
        }

        _addLongPress(element, property, name) {
            let timer = null;
            const duration = 500; // 0.5s

            const start = (e) => {
                timer = setTimeout(() => {
                    this._showTooltip(property, name);
                }, duration);
            };

            const end = () => {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                this._hideTooltip();
            };

            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start, {passive: true});
            
            element.addEventListener('mouseup', end);
            element.addEventListener('mouseleave', end);
            element.addEventListener('touchend', end);
            element.addEventListener('touchcancel', end);
        }

        _showTooltip(prop, name) {
            const desc = TOOLTIP_DESCRIPTIONS[prop];
            if(desc) {
                this.tooltipEl.innerHTML = `<strong style="color:#00ffff; font-size:16px;">${name || prop}</strong><br><br>${desc}`;
                this.tooltipEl.style.display = 'block';
            }
        }

        _hideTooltip() {
            if (this.tooltipEl) this.tooltipEl.style.display = 'none';
        }


_setupGeneral() {
            const folder = this.gui.addFolder('General');
            
const params = {
                timeScale: window.flux.timeScale,
                demoMode: this.game.isDemoMode,
                toggleHUD: true,
                resolution: 0.50,
arenaOpacity: 0.3,
                arena2Opacity: 0.25
            };

            folder.add(params, 'timeScale', 0.0, 5.0).name('Game Speed').onChange(v => {
                window.flux.timeScale = v;
            });

            folder.add(params, 'demoMode').name('Demo Mode').listen().onChange(v => {
                if (this.game.isDemoMode !== v) {
                    this.game.toggleDemoMode();
                }
            });

            folder.add(params, 'toggleHUD').name('Show HUD').onChange(v => {
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    hud.style.visibility = v ? 'visible' : 'hidden';
                }
            });

            folder.add(params, 'resolution', 0.1, 2.0).name('Resolution Scale').onChange(v => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const renderer = this.game.renderer;
                if (renderer) {
                    renderer.setSize(w * v, h * v, false);
                }
            });

folder.add(params, 'arenaOpacity', 0.0, 1.0).name('Arena 1 Opacity').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.opacity = v;
                }
            });

            const blendModes = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'NoBlending': THREE.NoBlending
            };
params.arenaBlend = 'Normal';

            folder.add(params, 'arenaBlend', Object.keys(blendModes)).name('Arena 1 Blend').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.blending = blendModes[v];
                    window.flux.arenaMesh.material.needsUpdate = true;
                }
            });

            // Arena 2 Controls
folder.add(params, 'arena2Opacity', 0.0, 1.0).name('Arena 2 Opacity').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material && window.flux.arenaMesh2.material.uniforms.uOpacity) {
                    window.flux.arenaMesh2.material.uniforms.uOpacity.value = v;
                }
            });

params.arena2Blend = 'Additive';
            folder.add(params, 'arena2Blend', Object.keys(blendModes)).name('Arena 2 Blend').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                    window.flux.arenaMesh2.material.blending = blendModes[v];
                    window.flux.arenaMesh2.material.needsUpdate = true;
                }
            });
            
            // Apply defaults
            if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                window.flux.arenaMesh.material.opacity = params.arenaOpacity;
            }
            if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                window.flux.arenaMesh2.material.opacity = params.arena2Opacity;
            }

            // --- Arena Graphics Controls ---
            this._setupArenaGraphics();
        }

        _setupArenaGraphics() {
            const folder = this.gui.addFolder('Arena Graphics');

            const threeBlends = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'NoBlending': THREE.NoBlending
            };

            // --- Blue Band ---
            if (window.flux.blueBandMat) {
                const blueFolder = folder.addFolder('Blue Band');
                const blueParams = {
                    visible: window.flux.blueBandMesh ? window.flux.blueBandMesh.visible : true,
                    opacity: window.flux.blueBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                blueFolder.add(blueParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.blueBandMesh) window.flux.blueBandMesh.visible = v;
                });
                blueFolder.add(blueParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.blueBandMat) window.flux.blueBandMat.opacity = v;
                });
                blueFolder.add(blueParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.blueBandMat) {
                        window.flux.blueBandMat.blending = threeBlends[v];
                        window.flux.blueBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Gold Band ---
            if (window.flux.goldBandMat) {
                const goldFolder = folder.addFolder('Gold Band');
                const goldParams = {
                    visible: window.flux.goldBandMesh ? window.flux.goldBandMesh.visible : false,
                    opacity: window.flux.goldBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                goldFolder.add(goldParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.goldBandMesh) window.flux.goldBandMesh.visible = v;
                });
                goldFolder.add(goldParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.goldBandMat) window.flux.goldBandMat.opacity = v;
                });
                goldFolder.add(goldParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.goldBandMat) {
                        window.flux.goldBandMat.blending = threeBlends[v];
                        window.flux.goldBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Yellow Arrows ---
            if (window.flux.arrowMat) {
                const arrowFolder = folder.addFolder('Yellow Arrows');
                const arrowParams = {
                    visible: window.flux.arrowGroup ? window.flux.arrowGroup.visible : true,
                    opacity: window.flux.arrowMat.opacity || 0.8,
                    blend: 'Additive'
                };
                arrowFolder.add(arrowParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.arrowGroup) window.flux.arrowGroup.visible = v;
                });
                arrowFolder.add(arrowParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.arrowMat) window.flux.arrowMat.opacity = v;
                });
                arrowFolder.add(arrowParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.arrowMat) {
                        window.flux.arrowMat.blending = threeBlends[v];
                        window.flux.arrowMat.needsUpdate = true;
                    }
                });
            }

            // --- Floor Glyph ---
            if (window.flux.floorGlyphMat) {
                const floorFolder = folder.addFolder('Floor Glyph');
                const floorParams = {
                    visible: window.flux.floorGlyphMesh ? window.flux.floorGlyphMesh.visible : true,
                    opacity: window.flux.floorGlyphMat.opacity || 0.35,
                    blend: 'Additive'
                };
                floorFolder.add(floorParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.floorGlyphMesh) window.flux.floorGlyphMesh.visible = v;
                });
                floorFolder.add(floorParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.floorGlyphMat) window.flux.floorGlyphMat.opacity = v;
                });
                floorFolder.add(floorParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.floorGlyphMat) {
                        window.flux.floorGlyphMat.blending = threeBlends[v];
                        window.flux.floorGlyphMat.needsUpdate = true;
                    }
                });
            }
        }

_setupOverlays() {
            const folder = this.gui.addFolder('Overlays & FX');
            
            // 1. GIF Overlay
            const gifEl = document.getElementById('screen-overlay-gif');
            if (gifEl) {
                const gifParams = {
                    visible: true,
opacity: 0.62,
                    blend: 'overlay'
                };
                
                const gFolder = folder.addFolder('Screen GIF');
                gFolder.add(gifParams, 'visible').onChange(v => gifEl.style.display = v ? 'block' : 'none');
                gFolder.add(gifParams, 'opacity', 0.0, 1.0).onChange(v => gifEl.style.opacity = v);
                
                const blendModes = [
                    'normal', 'multiply', 'screen', 'overlay', 
                    'darken', 'lighten', 'color-dodge', 'color-burn', 
                    'hard-light', 'soft-light', 'difference', 'exclusion', 
                    'hue', 'saturation', 'color', 'luminosity'
                ];
                gFolder.add(gifParams, 'blend', blendModes).onChange(v => gifEl.style.mixBlendMode = v);
            }

            // 2. Water Overlay
            const wo = this.game.waterOverlay;
            if (wo && wo.mesh) {
                const wFolder = folder.addFolder('Water Shader');
                const wParams = { 
                    visible: true,
                    opacity: wo.material.uniforms.uOpacity ? wo.material.uniforms.uOpacity.value : 0.5,
                    blend: 'Additive'
                };
                
                wFolder.add(wParams, 'visible').onChange(v => wo.mesh.visible = v);
                
                if (wo.material.uniforms.uOpacity) {
                    wFolder.add(wParams, 'opacity', 0.0, 2.0).onChange(v => wo.material.uniforms.uOpacity.value = v);
                }

                const threeBlends = {
                    'Normal': THREE.NormalBlending,
                    'Additive': THREE.AdditiveBlending,
                    'Subtractive': THREE.SubtractiveBlending,
                    'Multiply': THREE.MultiplyBlending,
                    'NoBlending': THREE.NoBlending
                };
                
                wFolder.add(wParams, 'blend', Object.keys(threeBlends)).onChange(v => {
                    wo.material.blending = threeBlends[v];
                    wo.material.needsUpdate = true;
                });
            }

            // 3. Light Shafts
            const ls = this.game.lightShafts;
            if (ls && ls.container) {
                const lParams = { visible: true };
                folder.add(lParams, 'visible').name('Light Shafts').onChange(v => ls.container.visible = v);
            }
        }

_setupGameState() {
            const folder = this.gui.addFolder('Game State');
            const gm = this.game;
            
            const params = {
                forceHomeGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('home'); 
                    else console.warn("Game must be active to trigger goal");
                },
                forceAwayGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('away');
                    else console.warn("Game must be active to trigger goal");
                },
                forceHalftime: () => {
                    if(gm.state === 'active') gm.endHalf();
                },
                resetRound: () => gm.resetRound(),
                exitToMenu: () => {
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        // Stop practice if running
                        if (window.flux.gameInstance.practiceManager) {
                            window.flux.gameInstance.practiceManager.stop();
                        }
                    }
                }
            };

            folder.add(params, 'forceHomeGoal').name('Trigger Home Goal');
            folder.add(params, 'forceAwayGoal').name('Trigger Away Goal');
            folder.add(params, 'forceHalftime').name('Force Halftime');
            folder.add(params, 'resetRound').name('Reset Round');
            folder.add(params, 'exitToMenu').name('Exit to Menu');
        }

        _setupTeams() {
            const folder = this.gui.addFolder('Teams');
            if (!this.game.teams.home || !this.game.teams.away) return;

            const home = this.game.teams.home;
            const away = this.game.teams.away;

            // Home
            const hFolder = folder.addFolder('Home Team');
            hFolder.add(home, 'isHuman').name('Is Human Controlled').listen();
            hFolder.add(home, 'aiEnabled').name('AI Logic Enabled').listen();

            // Away
            const aFolder = folder.addFolder('Away Team');
            aFolder.add(away, 'isHuman').name('Is Human Controlled').listen();
            aFolder.add(away, 'aiEnabled').name('AI Logic Enabled').listen();

}

        _setupThemes() {
            const folder = this.gui.addFolder('Arena Themes');
            const atm = this.game.arenaThemeManager;
            if (!atm) return;

            const themes = Object.keys(window.flux.THEMES || {});
            const params = {
                theme: atm.currentTheme,
                fogDensity: this.game.scene.fog ? this.game.scene.fog.density : 0.0001,
                waterDrag: (window.flux.BallConfig) ? window.flux.BallConfig.WATER_DRAG_LINEAR : 0.15
            };

            folder.add(params, 'theme', themes).name('Select Theme').onChange(v => {
                atm.setTheme(v);
                // Sync params to new theme defaults
                if (this.game.scene.fog) params.fogDensity = this.game.scene.fog.density;
                if (window.flux.BallConfig) params.waterDrag = window.flux.BallConfig.WATER_DRAG_LINEAR;
            });

            const live = folder.addFolder('Live Tweaks');
            live.add(params, 'fogDensity', 0, 0.05).name('Fog Density').listen().onChange(v => {
                if (this.game.scene.fog) this.game.scene.fog.density = v;
            });
            live.add(params, 'waterDrag', 0, 1.0).name('Water Drag').listen().onChange(v => {
                if (window.flux.BallConfig) window.flux.BallConfig.WATER_DRAG_LINEAR = v;
            });
        }
_setupPlayerInspector() {
            const folder = this.gui.addFolder('Player Inspector (Home Active)');
            
            // Helper to get current active player safely
            const getActive = () => {
                return (this.game.teams.home && this.game.teams.home.activePlayer) 
                    ? this.game.teams.home.activePlayer 
                    : null;
            };

            // Proxy object to bind GUI to dynamic target
            const proxy = {
                get Role() { 
                    const p = getActive();
                    return p ? p.role : '-'; 
                },
                
                get GodMode() { 
                    const p = getActive();
                    return p ? p.isGodMode : false; 
                },
                set GodMode(v) { 
                    const p = getActive();
                    if(p) p.isGodMode = v; 
                },

                // Runtime Values
                get HP() { 
                    const p = getActive();
                    return p ? p.stats.HP : 0; 
                },
                set HP(v) { 
                    const p = getActive();
                    if(p) p.stats.HP = v; 
                },
                
                get CurrentEN() { 
                    const p = getActive();
                    return p ? p.currentEN : 0; 
                },
                set CurrentEN(v) { 
                    const p = getActive();
                    if(p) p.currentEN = v; 
                },

                // Base Stats
                get MaxHP() { 
                    const p = getActive();
                    return p ? p.stats.maxHP : 0; 
                },
                set MaxHP(v) { 
                    const p = getActive();
                    if(p) p.stats.maxHP = v; 
                },

                get SP() { 
                    const p = getActive();
                    return p ? p.stats.SP : 0; 
                },
                set SP(v) { 
                    const p = getActive();
                    if(p) { 
                        p.stats.SP = v; 
                        p._updateDerivedStats(); 
                    } 
                },

                get EN() { 
                    const p = getActive();
                    return p ? p.stats.EN : 0; 
                }, 
                set EN(v) { 
                    const p = getActive();
                    if(p) {
                        p.stats.EN = v;
                    }
                },

                get AT() { 
                    const p = getActive();
                    return p ? p.stats.AT : 0; 
                },
                set AT(v) { 
                    const p = getActive();
                    if(p) p.stats.AT = v; 
                },

                get PA() { 
                    const p = getActive();
                    return p ? p.stats.PA : 0; 
                },
                set PA(v) { 
                    const p = getActive();
                    if(p) p.stats.PA = v; 
                },

                get BL() { 
                    const p = getActive();
                    return p ? p.stats.BL : 0; 
                },
                set BL(v) { 
                    const p = getActive();
                    if(p) p.stats.BL = v; 
                },

                get SH() { 
                    const p = getActive();
                    return p ? p.stats.SH : 0; 
                },
                set SH(v) { 
                    const p = getActive();
                    if(p) p.stats.SH = v; 
                },

                get CA() { 
                    const p = getActive();
                    return p ? p.stats.CA : 0; 
                },
                set CA(v) { 
                    const p = getActive();
                    if(p) p.stats.CA = v; 
                },

                // Actions
                LevelUp: () => { 
                    const p = getActive();
                    if(p) p.levelUp(); 
                },
                FullHeal: () => { 
                    const p = getActive(); 
                    if(p) { 
                        p.stats.HP = p.stats.maxHP; 
                        p.currentEN = p.getStat('EN'); 
                        p.status.venom = 0; 
                        p.status.nap = 0; 
                        for(let k in p.status.wither) p.status.wither[k] = 0;
                        if(window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("FULL HEAL", p.mesh.position, "heal");
                        }
                    } 
                },
                DrainEN: () => { 
                    const p = getActive();
                    if(p) {
                        p.currentEN = 0;
                        p.fumble(); // Trigger fumble logic
                    }
                }
            };

            folder.add(proxy, 'Role').listen().disable();
            folder.add(proxy, 'GodMode').name('God Mode (Inf HP/EN)').listen();

            const rtFolder = folder.addFolder('Runtime Status');
            rtFolder.add(proxy, 'HP', 0, 9999).listen();
            rtFolder.add(proxy, 'CurrentEN', 0, 100).name('Current EN').listen();

            const statFolder = folder.addFolder('Base Stats');
            statFolder.add(proxy, 'MaxHP', 100, 9999).listen();
            statFolder.add(proxy, 'EN', 0, 99).name('Max EN').listen();
            statFolder.add(proxy, 'SP', 0, 99).listen();
            statFolder.add(proxy, 'AT', 0, 99).listen();
            statFolder.add(proxy, 'PA', 0, 99).listen();
            statFolder.add(proxy, 'BL', 0, 99).listen();
            statFolder.add(proxy, 'SH', 0, 99).listen();
            statFolder.add(proxy, 'CA', 0, 99).listen();

            const actionFolder = folder.addFolder('Actions');
            actionFolder.add(proxy, 'LevelUp').name('Instant Level Up');
            actionFolder.add(proxy, 'FullHeal').name('Full Heal & Cure');
            actionFolder.add(proxy, 'DrainEN').name('Drain EN (Fumble)');
        }

_setupBallSandbox() {
    const root = this.gui.addFolder('Ball Lab (Throw & Physics)');

    // ------------------------------------------------------------
    // Shared state object (lives on window.flux so it survives reloads)
    // ------------------------------------------------------------
    const lab = window.flux.ballLab = window.flux.ballLab || {};
    lab.game = this.game;

    const C = window.flux.BallConfig;
    const TC = window.flux.ThrowConfig;

    if (!C || !TC) {
        console.warn("Ball Lab: Missing BallConfig or ThrowConfig.");
        return;
    }

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    const getBall = () => this.game && this.game.entities ? this.game.entities.ball : null;
    const getActive = () => this.game && this.game.teams && this.game.teams.home ? this.game.teams.home.activePlayer : null;

    const ensurePreviewLine = () => {
        if (lab.previewLine) return;
        if (!this.game || !this.game.scene) return;

        const geom = new THREE.BufferGeometry();
        const mat = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.95 });
        const line = new THREE.Line(geom, mat);
        line.frustumCulled = false;
        line.renderOrder = 999;
        this.game.scene.add(line);
        lab.previewLine = line;
    };

    const clearPreviewLine = () => {
        if (lab.previewLine && lab.previewLine.geometry) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry();
        }
    };

    // A safe "ghost ball" that can use Ball.updateFree without spawning FX
    const makeGhostBall = (pos, vel, spin) => {
        const gb = {
            mesh: { position: pos.clone() },
            velocity: vel.clone(),
            angularVelocity: (spin ? spin.clone() : new THREE.Vector3()),
            accumulatedRotation: new THREE.Quaternion(),
            power: 0,
            decayRate: 0,
            _bubbleTimer: 999,
            _ghost: true,
            deformNode: null
        };
        return gb;
    };

    // Use Ball.updateFree for faithful trajectory prediction
    const simulate = (ghostBall, steps, stepDt) => {
        const pts = [];
        pts.push(ghostBall.mesh.position.clone());
        const proto = window.flux.Ball && window.flux.Ball.prototype;
        if (!proto || typeof proto.updateFree !== 'function') return pts;

        for (let i = 0; i < steps; i++) {
            proto.updateFree.call(ghostBall, stepDt);
            pts.push(ghostBall.mesh.position.clone());
        }
        return pts;
    };

    // ------------------------------------------------------------
    // Preview + record/replay runtime loop
    // ------------------------------------------------------------
lab.preview = lab.preview || {
        enabled: false,
        source: 'Cannon',
        steps: 120,
        stepDt: 1/60,
        refreshHz: 10,
        showOnHeldOnly: false
    };

lab.cannon = lab.cannon || {
        yaw: 0,
        pitch: 0,
        power: 20,
        type: 'SH',
        element: 'none',
        spinX: 0,
        spinY: 0,
        spinZ: 0,
        fireBurst: 1,
        spreadDeg: 0
    };
    if (lab.cannon.element === undefined) lab.cannon.element = 'none';

    lab.recording = lab.recording || {
        isRecording: false,
        frames: [],
        maxSeconds: 12
    };

    lab.replay = lab.replay || {
        isReplaying: false,
        frames: [],
        idx: 0,
        loop: true,
        speed: 1.0
    };

    lab.isReplaying = false;
    lab.targetBall = null;

    lab.applyReplayFrame = (ball, dt) => {
        const rep = lab.replay;
        if (!rep || !rep.isReplaying || !rep.frames || rep.frames.length === 0) {
            lab.isReplaying = false;
            return;
        }

        // Advance time by stepping indices (frame-based)
        const step = Math.max(1, Math.floor(rep.speed));
        rep.idx += step;

        if (rep.idx >= rep.frames.length) {
            if (rep.loop) rep.idx = 0;
            else { rep.isReplaying = false; lab.isReplaying = false; return; }
        }

        const f = rep.frames[rep.idx];
        if (!f) return;

        ball.drop(); // ensure no holder logic fights us
        ball.state = 'free';
        ball.mesh.position.set(f.px, f.py, f.pz);
        ball.velocity.set(f.vx, f.vy, f.vz);
        ball.angularVelocity.set(f.sx, f.sy, f.sz);
    };

    lab._previewTimer = lab._previewTimer || 0;

    lab.update = (dt) => {
        // --- recording ---
        const b = getBall();
        if (b && lab.recording && lab.recording.isRecording) {
            const r = lab.recording;
            const maxFrames = Math.floor((r.maxSeconds || 12) / (dt || (1/60)));
            if (r.frames.length > maxFrames) r.frames.shift();
            r.frames.push({
                px: b.mesh.position.x, py: b.mesh.position.y, pz: b.mesh.position.z,
                vx: b.velocity.x, vy: b.velocity.y, vz: b.velocity.z,
                sx: b.angularVelocity.x, sy: b.angularVelocity.y, sz: b.angularVelocity.z
            });
        }

        // --- preview refresh ---
        lab._previewTimer += dt;
        const refreshInterval = 1.0 / Math.max(1, (lab.preview.refreshHz || 10));
        if (lab.preview.enabled && lab._previewTimer >= refreshInterval) {
            lab._previewTimer = 0;
            lab.refreshPreview();
        }
    };

    lab.refreshPreview = () => {
        if (!lab.preview.enabled) { clearPreviewLine(); return; }
        ensurePreviewLine();

        const b = getBall();
        const p = getActive();
        if (!b || !b.mesh) return;

        if (lab.preview.showOnHeldOnly && b.state !== 'held') {
            clearPreviewLine();
            return;
        }

        // Decide preview source
        let startPos = b.mesh.position;
        let startVel = b.velocity;
        let startSpin = b.angularVelocity;

        if (lab.preview.source === 'Cannon') {
            // Cannon always launches from ball position (or player if held)
            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const dir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const cap = (window.flux.BallConfig.LAUNCH_SPEED_CAP !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_CAP : 85.0);
            const scale = (window.flux.BallConfig.LAUNCH_SPEED_SCALE !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_SCALE : 1.0);
            const speed = Math.min((lab.cannon.power || 20) * scale, cap);

            startPos = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();
            startVel = dir.multiplyScalar(speed);
            startSpin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
        }

        const ghost = makeGhostBall(startPos.clone(), startVel.clone(), startSpin);
        const pts = simulate(ghost, Math.floor(lab.preview.steps || 120), (lab.preview.stepDt || (1/60)));

        if (lab.previewLine) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry().setFromPoints(pts);
        }
    };

    // ------------------------------------------------------------
    // Folder: Ball Physics (BallConfig)
    // ------------------------------------------------------------
    const phys = root.addFolder('Ball Physics (BallConfig)');

    const integ = phys.addFolder('Integration');
    integ.add(C, 'SUBSTEPS', 1, 12, 1).name('Substeps');
    integ.add(C, 'STOP_SPEED', 0.0, 0.2).name('Stop Speed');

    const drag = phys.addFolder('Water Drag');
    drag.add(C, 'WATER_DRAG_LINEAR', 0.0, 2.0).name('Linear Drag');
    drag.add(C, 'WATER_DRAG_QUAD', 0.0, 0.05).name('Quadratic Drag');

    const spin = phys.addFolder('Spin');
    spin.add(C, 'SPIN_DRAG', 0.0, 3.0).name('Spin Decay');

    const magnus = phys.addFolder('Magnus');
    magnus.add(C, 'MAGNUS_ENABLED').name('Enabled');
    magnus.add(C, 'MAGNUS_COEFF', 0.0, 0.5).name('Coeff');
    magnus.add(C, 'MAGNUS_CAP', 0.0, 200.0).name('Cap');

    const depth = phys.addFolder('Depth Constraint');
    depth.add(C, 'DEPTH_TARGET_Y', -5.0, 5.0).name('Target Y');
    depth.add(C, 'DEPTH_SPRING', 0.0, 10.0).name('Spring');
    depth.add(C, 'DEPTH_DAMP', 0.0, 6.0).name('Damp');

    const arena = phys.addFolder('Arena Boundary');
    arena.add(C, 'BOUNDARY_RADIUS', 10.0, 120.0).name('Radius');
    arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
    arena.add(C, 'GOAL_DISTANCE', 20.0, 60.0).name('Goal Distance').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.position.z = -v;
        if (window.flux.goalB) window.flux.goalB.position.z = v;
        // Update Debug Visuals if active
        if (window.flux.gameInstance && window.flux.gameInstance.debugVisualizer) {
            window.flux.gameInstance.debugVisualizer.updateGoalVolumes();
        }
});
    arena.add(C, 'GOAL_Y_OFFSET', -50.0, 20.0).name('Goal Y Pos').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.position.y = v;
        if (window.flux.goalB) window.flux.goalB.position.y = v;
    });
    arena.add(C, 'GOAL_SCALE', 1.0, 100.0).name('Goal Scale').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.scale.setScalar(v);
        if (window.flux.goalB) window.flux.goalB.scale.setScalar(v);
    });
    arena.add(C, 'WALL_SOFT_BUFFER', 0.0, 20.0).name('Soft Buffer');
    arena.add(C, 'WALL_SOFT_FORCE', 0.0, 200.0).name('Soft Force');
    arena.add(C, 'WALL_ELASTICITY', 0.0, 1.0).name('Wall Bounce');
    arena.add(C, 'WALL_FRICTION', 0.0, 1.0).name('Wall Friction');
    arena.add(C, 'FLOOR_ELASTICITY', 0.0, 1.0).name('Ceil/Floor Bounce');

    const pocket = arena.addFolder('Goal Pocket');
    pocket.add(C, 'GOAL_POCKET_ENABLED').name('Enabled');
    pocket.add(C, 'GOAL_POCKET_X', 0.0, 40.0).name('Pocket Half-X');
    pocket.add(C, 'GOAL_POCKET_Z', 0.0, 50.0).name('Pocket Start |Z|');
    pocket.add(C, 'GOAL_POCKET_RADIUS', 10.0, 120.0).name('Pocket Radius');

    const launch = phys.addFolder('Launch Mapping');
    launch.add(C, 'LAUNCH_SPEED_SCALE', 0.1, 5.0).name('Speed Scale');
    launch.add(C, 'LAUNCH_SPEED_CAP', 10.0, 200.0).name('Speed Cap');

    // ------------------------------------------------------------
    // Folder: Throw mapping (Player.releaseCharge -> Ball.shoot)
    // ------------------------------------------------------------
    const throwMap = root.addFolder('Throw Mapping (ThrowConfig)');
    throwMap.add(TC, 'SWIPE_MIN_PX', 0, 120, 1).name('Swipe Min PX');
    throwMap.add(TC, 'AIM_DX_SCALE', 0.1, 5.0).name('Aim X Scale');
    throwMap.add(TC, 'AIM_DY_SCALE', 0.1, 5.0).name('Aim Y Scale');
    throwMap.add(TC, 'POWER_BASE', 0.1, 3.0).name('Power Base');
    throwMap.add(TC, 'POWER_RANGE', 0.0, 3.0).name('Power Range');
    throwMap.add(TC, 'POWER_MAX_BONUS_RATIO', 0.0, 1.0).name('Max Bonus Ratio');
    throwMap.add(TC, 'POWER_MAX_MULTIPLIER', 1.0, 6.0).name('Max Multiplier');

    const curveMap = throwMap.addFolder('Curve');
    curveMap.add(TC, 'CURVE_ENABLED').name('Enabled');
    curveMap.add(TC, 'CURVE_INTENSITY_THRESHOLD', 0.0, 1.0).name('Input Threshold');
    curveMap.add(TC, 'CURVE_SPIN_SCALE', 0.0, 4000.0).name('Spin Scale');
    curveMap.add(TC, 'CURVE_SPEED_MULT', 0.0, 5.0).name('Swipe Speed Mult');
    curveMap.add(TC, 'CURVE_SPIN_CAP', 0.0, 6000.0).name('Spin Cap');
    curveMap.add(TC, 'CURVE_PERFECT_SPIN', 0.0, 2000.0).name('Perfect Threshold');

    // ------------------------------------------------------------
    // Folder: Teleport / State tools
    // ------------------------------------------------------------
    const tp = root.addFolder('Teleport / Reset');
    const tpParams = {
        ToCenter: () => { const b = getBall(); if (b) b.reset(); },
        ToActivePlayer: () => { const b = getBall(); const p = getActive(); if (b && p) b.grab(p); },
        ToHomeGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, 25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToAwayGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, -25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToSky: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 10, 0); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ClearPreview: () => clearPreviewLine()
    };
    tp.add(tpParams, 'ToCenter');
    tp.add(tpParams, 'ToActivePlayer');
    tp.add(tpParams, 'ToHomeGoal');
    tp.add(tpParams, 'ToAwayGoal');
    tp.add(tpParams, 'ToSky');
    tp.add(tpParams, 'ClearPreview');

    // ------------------------------------------------------------
    // Folder: Shot Cannon (force fire with params)
    // ------------------------------------------------------------
const cannon = root.addFolder('Shot Cannon');
    cannon.add(lab.cannon, 'yaw', -180, 180, 1).name('Yaw (deg)');
    cannon.add(lab.cannon, 'pitch', -89, 89, 1).name('Pitch (deg)');
    cannon.add(lab.cannon, 'power', 0, 120, 0.1).name('Power');
    cannon.add(lab.cannon, 'type', ['PA','SH']).name('Type');
    
    const elemTypes = ['none', 'fire', 'ice', 'volt', 'venom', 'wither', 'nap', 'sphere', 'jecht', 'invisible'];
    cannon.add(lab.cannon, 'element', elemTypes).name('Element');

    cannon.add(lab.cannon, 'spinX', -3000, 3000, 1).name('Spin X');
    cannon.add(lab.cannon, 'spinY', -3000, 3000, 1).name('Spin Y');
    cannon.add(lab.cannon, 'spinZ', -3000, 3000, 1).name('Spin Z');
    cannon.add(lab.cannon, 'fireBurst', 1, 10, 1).name('Burst Count');
    cannon.add(lab.cannon, 'spreadDeg', 0, 30, 0.5).name('Spread (deg)');

    const fireParams = {
        Fire: () => {
            const b = getBall();
            const p = getActive();
            if (!b) return;

            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const baseDir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const start = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();

            for (let i = 0; i < (lab.cannon.fireBurst || 1); i++) {
                const dir = baseDir.clone();
                if (lab.cannon.spreadDeg > 0) {
                    const spread = (lab.cannon.spreadDeg * Math.PI / 180);
                    dir.x += (Math.random()-0.5) * spread;
                    dir.y += (Math.random()-0.5) * spread;
                    dir.z += (Math.random()-0.5) * spread;
                    dir.normalize();
                }

                b.drop();
                b.mesh.position.copy(start);
                b.velocity.set(0,0,0);
                b.angularVelocity.set(0,0,0);

                const spin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
                
                let tech = null;
                if (lab.cannon.element && lab.cannon.element !== 'none') {
                    tech = { type: lab.cannon.element, level: 1 };
                }

                b.shoot(dir, lab.cannon.power || 20, lab.cannon.type || 'SH', tech, spin);
            }
        }
    };
    cannon.add(fireParams, 'Fire');

    // ------------------------------------------------------------
    // Folder: Trajectory Preview
    // ------------------------------------------------------------
    const preview = root.addFolder('Trajectory Preview');
    preview.add(lab.preview, 'enabled').name('Enabled').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'source', ['Cannon', 'Live Ball']).name('Source').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'steps', 10, 600, 1).name('Steps').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'stepDt', 1/240, 1/15, 1/240).name('Step dt').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'refreshHz', 1, 60, 1).name('Refresh Hz');
    preview.add(lab.preview, 'showOnHeldOnly').name('Only when Held').onChange(() => lab.refreshPreview());

    const previewBtns = {
        Refresh: () => lab.refreshPreview(),
        Hide: () => { lab.preview.enabled = false; clearPreviewLine(); }
    };
    preview.add(previewBtns, 'Refresh');
    preview.add(previewBtns, 'Hide');

    // ------------------------------------------------------------
    // Folder: Record / Replay
    // ------------------------------------------------------------
    const rr = root.addFolder('Record / Replay');
    const rrParams = {
        Record: () => {
            lab.recording.isRecording = true;
            lab.recording.frames = [];
        },
        Stop: () => {
            lab.recording.isRecording = false;
        },
        UseRecordingForReplay: () => {
            lab.replay.frames = (lab.recording.frames || []).slice();
            lab.replay.idx = 0;
        },
        Play: () => {
            const b = getBall();
            if (!b) return;
            lab.replay.isReplaying = true;
            lab.isReplaying = true;
            lab.targetBall = b;
            lab.replay.idx = 0;
        },
        Pause: () => {
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        },
        Clear: () => {
            lab.recording.frames = [];
            lab.replay.frames = [];
            lab.replay.idx = 0;
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        }
    };
    rr.add(rrParams, 'Record');
    rr.add(rrParams, 'Stop');
    rr.add(rrParams, 'UseRecordingForReplay').name('Copy Rec -> Replay');
    rr.add(lab.replay, 'loop').name('Loop');
    rr.add(lab.replay, 'speed', 0.25, 6.0, 0.25).name('Replay Speed');
    rr.add(rrParams, 'Play');
    rr.add(rrParams, 'Pause');
    rr.add(rrParams, 'Clear');

    // ------------------------------------------------------------
    // Folder: Presets
    // ------------------------------------------------------------
    const presets = root.addFolder('Presets');
    const P = {
        Vanilla: () => {
            Object.assign(C, {
                SUBSTEPS: 2,
                STOP_SPEED: 0.02,
                WATER_DRAG_LINEAR: 0.15,
                WATER_DRAG_QUAD: 0.002,
                SPIN_DRAG: 0.40,
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.08,
                MAGNUS_CAP: 60.0,
                DEPTH_TARGET_Y: 0.0,
                DEPTH_SPRING: 1.0,
                DEPTH_DAMP: 1.5,
                BOUNDARY_RADIUS: 33.0,
                BOUNDARY_HEIGHT: 15.0,
                WALL_SOFT_BUFFER: 3.0,
                WALL_SOFT_FORCE: 20.0,
                WALL_ELASTICITY: 0.30,
                WALL_FRICTION: 0.95,
                FLOOR_ELASTICITY: 0.40,
                GOAL_POCKET_ENABLED: true,
                GOAL_POCKET_X: 12.0,
                GOAL_POCKET_Z: 25.0,
                GOAL_POCKET_RADIUS: 45.0,
                LAUNCH_SPEED_SCALE: 1.0,
                LAUNCH_SPEED_CAP: 85.0
            });
            lab.refreshPreview();
        },
        ArcadeCurve: () => {
            Object.assign(C, {
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.16,
                MAGNUS_CAP: 90.0,
                SPIN_DRAG: 0.25,
                WATER_DRAG_LINEAR: 0.12,
                WATER_DRAG_QUAD: 0.001,
                WALL_SOFT_FORCE: 35.0,
                LAUNCH_SPEED_CAP: 110.0
            });
            Object.assign(TC, {
                CURVE_ENABLED: true,
                CURVE_SPIN_SCALE: 1500.0,
                CURVE_SPIN_CAP: 3000.0,
                CURVE_PERFECT_SPIN: 700.0
            });
            lab.refreshPreview();
        },
        SnappyRealistic: () => {
            Object.assign(C, {
                WATER_DRAG_LINEAR: 0.25,
                WATER_DRAG_QUAD: 0.006,
                MAGNUS_COEFF: 0.05,
                MAGNUS_CAP: 40.0,
                SPIN_DRAG: 0.75,
                STOP_SPEED: 0.05,
                LAUNCH_SPEED_CAP: 70.0
            });
            lab.refreshPreview();
        }
    };
    presets.add(P, 'Vanilla');
    presets.add(P, 'ArcadeCurve');
    presets.add(P, 'SnappyRealistic');

    // ------------------------------------------------------------
    // Folder: Snapshot / Export
    // ------------------------------------------------------------
    const snapshot = root.addFolder('Snapshot / Export');

    const _round = (n, places = 4) => {
        if (!Number.isFinite(n)) return null;
        const p = Math.pow(10, places);
        return Math.round(n * p) / p;
    };

    const _v3 = (v, places = 4) => {
        if (!v) return null;
        return [_round(v.x, places), _round(v.y, places), _round(v.z, places)];
    };

    const _cloneJson = (obj) => {
        if (!obj) return null;
        try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return null; }
    };

    const _playerSnap = (p) => {
        if (!p) return null;
        const anim = (p.activeAction && p.activeAction._clip) ? p.activeAction._clip.name : (p.state || null);
        return {
            name: p.characterName || p.name || null,
            role: p.role || null,
            state: p.state || null,
            hasBall: !!p.hasBall,
            isThrowing: !!p.isThrowing,
            isCharging: !!p.isCharging,
            isDashing: !!p.isDashing,
            dashCooldown: _round(p.dashCooldown, 4),
            pos: _v3(p.mesh && p.mesh.position),
            vel: _v3(p.velocity),
            input: _v3(p.inputVector),
            stats: p.stats ? _cloneJson(p.stats) : null,
            anim
        };
    };

    const _teamSnap = (t) => {
        if (!t) return null;
        const active = t.activePlayer ? _playerSnap(t.activePlayer) : null;
        return {
            id: t.id || null,
            side: t.side,
            isHuman: !!t.isHuman,
            aiEnabled: !!t.aiEnabled,
            currentFormation: t.currentFormation || null,
            activePlayer: active,
            players: Array.isArray(t.players) ? t.players.map(_playerSnap) : []
        };
    };

    const buildSnapshot = () => {
        const game = this.game || window.flux.gameInstance || null;
        const ball = game && game.entities ? game.entities.ball : null;
        const camMgr = game ? game.cameraManager : null;
        const cam = (camMgr && camMgr.camera) ? camMgr.camera : (game ? game.camera : null);

        const ballSnap = ball ? {
            state: ball.state || null,
            isInvisible: !!ball.isInvisible,
            holder: ball.holder ? (ball.holder.characterName || ball.holder.name || null) : null,
            lastHolder: ball.lastHolder ? (ball.lastHolder.characterName || ball.lastHolder.name || null) : null,
            pos: _v3(ball.mesh && ball.mesh.position),
            vel: _v3(ball.velocity),
            angVel: _v3(ball.angularVelocity),
            power: _round(ball.power, 4),
            shotType: ball.shotType || null
        } : null;

        const cameraSnap = cam ? {
            pos: _v3(cam.position),
            rot: cam.rotation ? [_round(cam.rotation.x, 4), _round(cam.rotation.y, 4), _round(cam.rotation.z, 4)] : null,
            fov: _round(cam.fov, 4),
            near: _round(cam.near, 6),
            far: _round(cam.far, 4)
        } : null;

        const camMgrSnap = camMgr ? {
            mode: camMgr.mode || null,
            targetName: (camMgr.target && (camMgr.target.characterName || camMgr.target.name)) || null,
            settings: camMgr.settings ? _cloneJson(camMgr.settings) : null
        } : null;

        const debugIO = window.flux && window.flux._debugIO ? window.flux._debugIO : null;
        const inputSnap = debugIO ? {
            settings: debugIO.settings ? _cloneJson(debugIO.settings) : null,
            perf: debugIO.perf ? _cloneJson(debugIO.perf) : null,
            move: (debugIO.input && debugIO.input.move) ? {
                touchId: debugIO.input.move.touchId ?? null,
                dragging: !!debugIO.input.move.dragging,
                vector: debugIO.input.move.vector ? _cloneJson(debugIO.input.move.vector) : null
            } : null,
            aim: (debugIO.input && debugIO.input.aim) ? {
                touchId: debugIO.input.aim.touchId ?? null,
                dragging: !!debugIO.input.aim.dragging,
                vector: debugIO.input.aim.vector ? _cloneJson(debugIO.input.aim.vector) : null
            } : null,
            swipe: (debugIO.input && debugIO.input.swipe) ? {
                touchId: debugIO.input.swipe.touchId ?? null,
                start: debugIO.input.swipe.start ? _cloneJson(debugIO.input.swipe.start) : null,
                points: Array.isArray(debugIO.input.swipe.points) ? debugIO.input.swipe.points.slice(-32).map(_cloneJson) : []
            } : null
        } : null;

        return {
            meta: {
                timestampISO: new Date().toISOString(),
                href: (typeof location !== 'undefined' && location.href) ? location.href : null,
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : null
            },
            game: game ? {
                score: game.score ? _cloneJson(game.score) : null,
                time: _round(game.time, 4),
                half: game.half ?? null,
                halfDuration: _round(game.halfDuration, 4),
                isOvertime: !!game.isOvertime,
                isDemoMode: !!game.isDemoMode
            } : null,
            config: {
                BallConfig: (window.flux && window.flux.BallConfig) ? _cloneJson(window.flux.BallConfig) : null,
                ThrowConfig: (window.flux && window.flux.ThrowConfig) ? _cloneJson(window.flux.ThrowConfig) : null
            },
            camera: cameraSnap,
            cameraManager: camMgrSnap,
            ball: ballSnap,
            teams: game ? {
                home: _teamSnap(game.teams && game.teams.home),
                away: _teamSnap(game.teams && game.teams.away)
            } : null,
            input: inputSnap
        };
    };

    const _copyText = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // Fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {}
        return false;
    };

    const _downloadText = (filename, text) => {
        try {
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Snapshot download failed:', e);
        }
    };

const snapshotActions = {
        CopySnapshot: async () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            const ok = await _copyText(text);
            console.log('[Snapshot]', snap);
            if (!ok) console.warn('Snapshot: copy failed (see console).');
        },
        DownloadSnapshot: () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            _downloadText('snapshot.json', text);
            console.log('[Snapshot]', snap);
        },
        CopyConfigs: async () => {
            const cfg = {
                BallConfig: window.flux.BallConfig,
                ThrowConfig: window.flux.ThrowConfig
            };
            const text = JSON.stringify(cfg, null, 4);
            const ok = await _copyText(text);
            if (ok) {
                console.log("Configs copied to clipboard!");
                alert("Configs copied to clipboard!");
            } else {
                console.warn("Copy failed");
                alert("Copy failed. Check console.");
            }
        }
    };

    snapshot.add(snapshotActions, 'CopySnapshot').name('Copy JSON Snapshot');
    snapshot.add(snapshotActions, 'DownloadSnapshot').name('Download snapshot.json');
    snapshot.add(snapshotActions, 'CopyConfigs').name('Copy Configs (For Dev)');

}
    }

    window.flux.DevTools = DevTools;

    DevTools.prototype._setupVisualDebug = function() {
        const folder = this.gui.addFolder('Visual Debugging');
        const dv = this.game.debugVisualizer;
        if (!dv) return;

const params = {
            enabled: dv.enabled,
            hitboxes: dv.showHitboxes,
            vectors: dv.showVectors,
            ai: dv.showAI,
            goalVolume: dv.showGoalVolume,
            goalDist: window.flux.BallConfig.GOAL_DISTANCE || 41.5,
            triggerOffset: window.flux.BallConfig.GOAL_TRIGGER_OFFSET || 1.0
        };

        folder.add(params, 'enabled').name('Enable Entity Viz').onChange(v => dv.enabled = v);
        folder.add(params, 'hitboxes').name('Show Hitboxes').onChange(v => dv.showHitboxes = v);
        folder.add(params, 'vectors').name('Show Vectors').onChange(v => dv.showVectors = v);
        folder.add(params, 'ai').name('Show AI Perception').onChange(v => dv.showAI = v);
        
const gFolder = folder.addFolder('Goal Volume Settings');
        gFolder.add(params, 'goalVolume').name('Show Goal Volume').onChange(v => {
            dv.showGoalVolume = v;
            if (dv.goalVol1) dv.goalVol1.visible = v;
            if (dv.goalVol2) dv.goalVol2.visible = v;
        });
        
        gFolder.add(params, 'goalDist', 20.0, 60.0).name('Goal Distance').onChange(v => {
            window.flux.BallConfig.GOAL_DISTANCE = v;
            if (window.flux.goalA) window.flux.goalA.position.z = -v;
            if (window.flux.goalB) window.flux.goalB.position.z = v;
            dv.updateGoalVolumes();
        });

        gFolder.add(params, 'triggerOffset', -5.0, 10.0).name('Trigger Offset').onChange(v => {
            window.flux.BallConfig.GOAL_TRIGGER_OFFSET = v;
            dv.updateGoalVolumes();
        });

        // Trigger Dimensions
// Trigger Dimensions & Position
        const trigParams = {
            width: window.flux.BallConfig.GOAL_TRIGGER_WIDTH || 28.0,
            centerY: ((window.flux.BallConfig.GOAL_TRIGGER_TOP_Y || 2.0) + (window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y || -18.0)) / 2,
            height: (window.flux.BallConfig.GOAL_TRIGGER_TOP_Y || 2.0) - (window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y || -18.0)
        };

        const updateTriggerFromCenter = () => {
            const half = trigParams.height / 2;
            window.flux.BallConfig.GOAL_TRIGGER_TOP_Y = trigParams.centerY + half;
            window.flux.BallConfig.GOAL_TRIGGER_BOTTOM_Y = trigParams.centerY - half;
            dv.updateGoalVolumes();
        };

        gFolder.add(trigParams, 'centerY', -30, 30).name('Trigger Center Y').onChange(updateTriggerFromCenter);
        gFolder.add(trigParams, 'height', 1, 60).name('Trigger Height').onChange(updateTriggerFromCenter);
        
        gFolder.add(trigParams, 'width', 5, 50).name('Trigger Width').onChange(v => {
            window.flux.BallConfig.GOAL_TRIGGER_WIDTH = v;
            dv.updateGoalVolumes();
        });

        // Model Dimensions
        const modFolder = gFolder.addFolder('Model Dimensions');
        const modParams = {
            scale: window.flux.BallConfig.GOAL_SCALE || 45.0,
            sx: window.flux.BallConfig.GOAL_SCALE_X || 1.0,
            sy: window.flux.BallConfig.GOAL_SCALE_Y || 1.0,
            sz: window.flux.BallConfig.GOAL_SCALE_Z || 1.0,
            yOff: window.flux.BallConfig.GOAL_Y_OFFSET || -18.0
        };
        
        const updateModel = () => {
            const s = modParams.scale;
            const sx = modParams.sx;
            const sy = modParams.sy;
            const sz = modParams.sz;
            
            window.flux.BallConfig.GOAL_SCALE = s;
            window.flux.BallConfig.GOAL_SCALE_X = sx;
            window.flux.BallConfig.GOAL_SCALE_Y = sy;
            window.flux.BallConfig.GOAL_SCALE_Z = sz;
            window.flux.BallConfig.GOAL_Y_OFFSET = modParams.yOff;

            [window.flux.goalA, window.flux.goalB].forEach(g => {
                if(g) {
                    g.scale.set(s * sx, s * sy, s * sz);
                    g.position.y = modParams.yOff;
                }
            });
        };

        modFolder.add(modParams, 'scale', 1.0, 100.0).name('Base Scale').onChange(updateModel);
        modFolder.add(modParams, 'sx', 0.1, 3.0).name('Scale X (Width)').onChange(updateModel);
        modFolder.add(modParams, 'sy', 0.1, 3.0).name('Scale Y (Height)').onChange(updateModel);
        modFolder.add(modParams, 'sz', 0.1, 3.0).name('Scale Z (Depth)').onChange(updateModel);
        modFolder.add(modParams, 'yOff', -50.0, 20.0).name('Y Offset').onChange(updateModel);
    };

    DevTools.prototype._setupFXLab = function() {
        const folder = this.gui.addFolder('FX Lab & UI Test');
        
        const getTargetPos = () => {
            const p = this.game.teams.home.activePlayer;
            return p && p.mesh ? p.mesh.position : new THREE.Vector3(0, 2, 0);
        };

        const fxParams = {
            SpawnVenom: () => this.game.particleManager.spawn('venom', getTargetPos()),
            SpawnNap: () => this.game.particleManager.spawn('nap', getTargetPos()),
            SpawnWither: () => this.game.particleManager.spawn('wither', getTargetPos()),
            SpawnLearned: () => this.game.particleManager.spawn('learned', getTargetPos()),
            SpawnClash: () => this.game.spawnClash(getTargetPos()),
        };

        const fxSub = folder.addFolder('Particles');
        fxSub.add(fxParams, 'SpawnVenom');
        fxSub.add(fxParams, 'SpawnNap');
        fxSub.add(fxParams, 'SpawnWither');
        fxSub.add(fxParams, 'SpawnLearned');
        fxSub.add(fxParams, 'SpawnClash');

        const txtParams = {
            Text: "TEST",
            Type: "damage",
            Spawn: () => {
                if(this.game.floatingText) 
                    this.game.floatingText.spawn(txtParams.Text, getTargetPos(), txtParams.Type);
            }
        };
        
        const txtSub = folder.addFolder('Floating Text');
        txtSub.add(txtParams, 'Text');
        txtSub.add(txtParams, 'Type', ['damage', 'heal', 'status', 'tech', 'comic-impact', 'comic-action', 'save', 'block', 'default']);
        txtSub.add(txtParams, 'Spawn').name('Spawn Text');

        const camParams = {
            ShakeSmall: () => this.game.cameraManager.addShake(0.5),
            ShakeBig: () => this.game.cameraManager.addShake(2.0),
            ImpactLight: () => this.game.triggerImpact(0.1, 'default'),
            ImpactHeavy: () => this.game.triggerImpact(0.2, 'heavy'),
            ImpactShatter: () => this.game.triggerImpact(0.4, 'shatter'),
        };

        const camSub = folder.addFolder('Camera & Impact');
        camSub.add(camParams, 'ShakeSmall');
        camSub.add(camParams, 'ShakeBig');
        camSub.add(camParams, 'ImpactLight');
        camSub.add(camParams, 'ImpactHeavy');
        camSub.add(camParams, 'ImpactShatter');
    };


DevTools.prototype._setupVisuals = function() {
        const folder = this.gui.addFolder('Asset Forge');
        
        const forgeState = {
            active: false,
            assetName: 'Tidus',
            animName: 'idle',
            posX: 0, posY: 0, posZ: 0,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1.0,
            camDist: 5, camHeight: 1.5, camRot: 0
        };

        const assets = {
            'Tidus': 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb',
            'Wakka': 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb',
            'Letty': 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb',
            'Datto': 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb',
            'Jassu': 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb',
            'Botta': 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb',
            'Ball': 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb',
            'Goal': 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb'
        };

        let currentAsset = null;

        const updateTransform = () => {
            if (currentAsset) {
                currentAsset.position.set(forgeState.posX, forgeState.posY, forgeState.posZ);
                currentAsset.rotation.set(forgeState.rotX, forgeState.rotY, forgeState.rotZ);
                currentAsset.scale.setScalar(forgeState.scale);
            }
        };

        const updateCamera = () => {
            if (!forgeState.active) return;
            // Orbit around (1000, Y, 1000)
            const cx = 1000 + Math.sin(forgeState.camRot) * forgeState.camDist;
            const cz = 1000 + Math.cos(forgeState.camRot) * forgeState.camDist;
            this.game.camera.position.set(cx, forgeState.camHeight, cz);
            this.game.camera.lookAt(1000, forgeState.posY + 1, 1000);
        };

        const playAnimation = () => {
            if (!this.vizMixer || !this.vizClips) return;
            this.vizMixer.stopAllAction();
            if (forgeState.animName === 'none') return;
            
            let clip = this.vizClips.find(c => c.name === forgeState.animName);
            if (!clip) clip = this.vizClips.find(c => c.name.toLowerCase().includes(forgeState.animName.toLowerCase()));
            if (clip) this.vizMixer.clipAction(clip).play();
        };

        const spawnAsset = () => {
            if (!this.vizGroup) return;
            
            // Clear previous
            while(this.vizGroup.children.length > 0) {
                const child = this.vizGroup.children[0];
                this.vizGroup.remove(child);
            }
            
            this.vizMixer = null;
            currentAsset = null;

            const url = assets[forgeState.assetName];
            if (!url) return;

            console.log("Forge: Spawning", forgeState.assetName);

            window.flux.AssetLoader.loadModel(url, (gltf) => {
                // Check if we are still in forge mode before adding
                if (!forgeState.active) return;

                const model = gltf.scene;
                this.vizGroup.add(model);
                currentAsset = model;
                
                // Reset model transform relative to group
                model.position.set(0,0,0);
                model.rotation.set(0,0,0);
                
                updateTransform();

                if (gltf.animations && gltf.animations.length > 0) {
                    this.vizMixer = new THREE.AnimationMixer(model);
                    this.vizClips = gltf.animations;
                    playAnimation();
                }
            });
        };

        const toggleForge = (isActive) => {
            forgeState.active = isActive;
            this.game.isForgeMode = isActive; // Critical: Tell main.js to stop game loop
            
            // Toggle Game Visibility (Hide everything in the main arena)
            const gameLayer = [this.game.teams.home, this.game.teams.away, this.game.entities.ball];
            gameLayer.forEach(t => {
                if(t && t.players) t.players.forEach(p => { if(p.mesh) p.mesh.visible = !isActive; });
                else if(t && t.mesh) t.mesh.visible = !isActive;
            });
            if(window.flux.arenaMesh) window.flux.arenaMesh.visible = !isActive;
            if(window.flux.arenaMesh2) window.flux.arenaMesh2.visible = !isActive;
            if(this.game.stadium && this.game.stadium.container) this.game.stadium.container.visible = !isActive;
            if(this.game.waterOverlay && this.game.waterOverlay.mesh) this.game.waterOverlay.mesh.visible = !isActive;
            
            // Hide UI
            const ui = document.getElementById('ui-layer');
            if(ui) ui.style.display = isActive ? 'none' : 'flex';

            if (isActive) {
                // Initialize Forge Scene if needed
                if (!this.vizGroupParent) {
                    this.vizGroupParent = new THREE.Group();
                    this.game.scene.add(this.vizGroupParent);
                    
                    this.vizGroup = new THREE.Group();
                    this.vizGroup.position.set(1000, 0, 1000); // Far away from arena
                    this.vizGroupParent.add(this.vizGroup);

                    const grid = new THREE.GridHelper(20, 20, 0x00ffff, 0x444444);
                    grid.position.set(1000, 0, 1000);
                    this.vizGroupParent.add(grid);

                    this.vizLight = new THREE.DirectionalLight(0xffffff, 1.0);
                    this.vizLight.position.set(1005, 10, 1005);
                    this.game.scene.add(this.vizLight);
                    
                    this.vizAmbient = new THREE.AmbientLight(0x404040);
                    this.game.scene.add(this.vizAmbient);
                }
                
                this.vizGroupParent.visible = true;
                this.vizLight.visible = true;
                this.vizAmbient.visible = true;
                
                spawnAsset();
                updateCamera();
                
            } else {
                // Restore Game
                if (this.vizGroupParent) this.vizGroupParent.visible = false;
                if (this.vizLight) this.vizLight.visible = false;
                if (this.vizAmbient) this.vizAmbient.visible = false;
                
                // Snap camera back to game target
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        };

        folder.add(forgeState, 'active').name('Enable Forge').onChange(toggleForge);
        folder.add(forgeState, 'assetName', Object.keys(assets)).name('Select Asset').onChange(spawnAsset);
        
        const tf = folder.addFolder('Transform');
        tf.add(forgeState, 'posX', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posY', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posZ', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'rotX', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotY', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotZ', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'scale', 0.1, 3.0).onChange(updateTransform);

        folder.add(forgeState, 'animName', ['none', 'idle', 'swim', 'throw', 'catch', 'react']).name('Animation').onChange(playAnimation);

        const cf = folder.addFolder('Camera');
        cf.add(forgeState, 'camDist', 2, 15).onChange(updateCamera);
        cf.add(forgeState, 'camHeight', 0, 10).onChange(updateCamera);
        cf.add(forgeState, 'camRot', 0, 6.28).onChange(updateCamera);

        // Hook Game Loop
        const originalUpdate = this.game.update.bind(this.game);
        this.game.update = (dt) => {
            if (forgeState.active) {
                // Forge Mode: Only update forge components and render
                if (this.vizMixer) this.vizMixer.update(dt);
                
                // Force Camera Update here since main.js loop is skipped
                updateCamera();

                if (this.game.renderer && this.game.scene && this.game.camera) {
                    this.game.renderer.render(this.game.scene, this.game.camera);
                }
            } else {
                // Normal Mode: Run standard game update
                originalUpdate(dt);
            }
};
        };

        DevTools.prototype._setupAudio = function() {
            const folder = this.gui.addFolder('Audio Settings');
            const am = this.game.audioManager;
            if (!am) return;

            const params = {
                master: am.masterVolume,
                bgm: am.bgmLevel,
                sfx: am.sfxLevel,
                mute: am.isMuted
            };

            folder.add(params, 'master', 0.0, 1.0).name('Master Volume').onChange(v => am.setMasterVolume(v));
            folder.add(params, 'bgm', 0.0, 2.0).name('BGM Level').onChange(v => am.setBGMLevel(v));
            folder.add(params, 'sfx', 0.0, 2.0).name('SFX Level').onChange(v => am.setSFXLevel(v));
            folder.add(params, 'mute').name('Mute').onChange(v => {
                am.toggleMute();
            });
// Duplicate removed
        };

        DevTools.prototype._setupPostProcessing = function() {
            const pp = this.game.postProcessing;
            if (!pp || !pp.uniforms) return;

            const folder = this.gui.addFolder('Post-Processing (Retro FX)');
            
            const params = {
                enabled: pp.enabled,
                scanline: pp.uniforms.uScanlineIntensity.value,
                vignette: pp.uniforms.uVignette.value,
                noise: pp.uniforms.uNoise.value,
                aberration: pp.uniforms.uAberration.value,
                contrast: pp.uniforms.uContrast.value,
                saturation: pp.uniforms.uSaturation.value
            };

            folder.add(params, 'enabled').name('Enable PP').onChange(v => pp.enabled = v);
            folder.add(params, 'scanline', 0.0, 1.0).name('Scanline Intensity').onChange(v => pp.uniforms.uScanlineIntensity.value = v);
            folder.add(params, 'vignette', 0.0, 2.0).name('Vignette').onChange(v => pp.uniforms.uVignette.value = v);
            folder.add(params, 'noise', 0.0, 0.5).name('Noise').onChange(v => pp.uniforms.uNoise.value = v);
            folder.add(params, 'aberration', 0.0, 10.0).name('Chromatic Aberration').onChange(v => pp.uniforms.uAberration.value = v);
            folder.add(params, 'contrast', 0.0, 2.0).name('Contrast').onChange(v => pp.uniforms.uContrast.value = v);
            folder.add(params, 'saturation', 0.0, 2.0).name('Saturation').onChange(v => pp.uniforms.uSaturation.value = v);
        };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class DebugVisualizer {
constructor(scene) {
            this.scene = scene;
            this.enabled = false;
            this.showHitboxes = false;
            this.showVectors = false;
            this.showAI = false;
            this.showGoalVolume = false;

            this.visuals = new Map();
            
            // Materials
            this.matTackle = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true, transparent: true, opacity: 0.2 });
            this.matCatch = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.2 });
            this.matVel = new THREE.LineBasicMaterial({ color: 0xffff00 }); // Yellow Velocity
            this.matInput = new THREE.LineBasicMaterial({ color: 0x00ffff }); // Cyan Input
            this.matAI = new THREE.LineBasicMaterial({ color: 0xff00ff }); // Magenta AI Perception
            
            // Geometries
            this.geoCylinder = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            this.geoCylinder.translate(0, 0.05, 0);

// Goal Volume Visualization (Red Transparent Triangular Prism)
            // Matches FFX Goal Shape: Inverted Triangle
            // Top Width: 28, Bottom Width: 0, Height: 18, Depth: 10
            // Centered at Y=3 (Midpoint of 12 and -6)
            const goalGeo = new THREE.BufferGeometry();
            const vertices = new Float32Array([
                // Front Face (Z = 5)
// Front Face (Z = 5)
-14, 2, 5,  // 0: Top Left
                 14, 2, 5,  // 1: Top Right
                  0, -18, 5, // 2: Bottom
                // Back Face (Z = -5)
                -14, 2, -5, // 3: Top Left
                 14, 2, -5, // 4: Top Right
                  0, -18, -5 // 5: Bottom
            ]);
            const indices = [
                0, 2, 1,          // Front
                3, 4, 5,          // Back
                0, 1, 4, 0, 4, 3, // Top
                1, 2, 5, 1, 5, 4, // Right Side
                0, 3, 5, 0, 5, 2  // Left Side
            ];
            goalGeo.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            goalGeo.setIndex(indices);
            goalGeo.computeVertexNormals();

            const goalMat = new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                transparent: true, 
                opacity: 0.25, 
                side: THREE.DoubleSide, 
                depthWrite: false 
            });

this.goalVol1 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol1.visible = false;
            this.scene.add(this.goalVol1);

            this.goalVol2 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol2.visible = false;
            this.scene.add(this.goalVol2);
            
            this.updateGoalVolumes();
        }
        
updateGoalVolumes() {
            const C = window.flux.BallConfig || {};
            const goalDist = C.GOAL_DISTANCE || 41.5;
            const triggerOffset = (C.GOAL_TRIGGER_OFFSET !== undefined) ? C.GOAL_TRIGGER_OFFSET : 1.0;
            
            // Trigger Dimensions
            const topY = (C.GOAL_TRIGGER_TOP_Y !== undefined) ? C.GOAL_TRIGGER_TOP_Y : 2.0;
            const botY = (C.GOAL_TRIGGER_BOTTOM_Y !== undefined) ? C.GOAL_TRIGGER_BOTTOM_Y : -18.0;
            const halfW = ((C.GOAL_TRIGGER_WIDTH !== undefined) ? C.GOAL_TRIGGER_WIDTH : 28.0) / 2.0;
            const depth = 10.0;
            const halfDepth = depth / 2.0;

            // Volume represents the trigger area.
            // Trigger starts at (goalDist - triggerOffset) and goes outwards.
            const zStart = goalDist - triggerOffset;
            const zCenter = zStart + halfDepth;

            // Update Geometry Vertices
            // 0: Top Left Front (-X, TopY, +Z)
            // 1: Top Right Front (+X, TopY, +Z)
            // 2: Bottom Front (0, BotY, +Z)
            // 3: Top Left Back (-X, TopY, -Z)
            // 4: Top Right Back (+X, TopY, -Z)
            // 5: Bottom Back (0, BotY, -Z)
            
            const updateGeo = (mesh) => {
                if (!mesh || !mesh.geometry) return;
                const pos = mesh.geometry.attributes.position;
                const arr = pos.array;
                
                // Front Face (Z = halfDepth)
                arr[0] = -halfW; arr[1] = topY; arr[2] = halfDepth;
                arr[3] = halfW;  arr[4] = topY; arr[5] = halfDepth;
                arr[6] = 0;      arr[7] = botY; arr[8] = halfDepth;
                
                // Back Face (Z = -halfDepth)
                arr[9] = -halfW;  arr[10] = topY; arr[11] = -halfDepth;
                arr[12] = halfW;  arr[13] = topY; arr[14] = -halfDepth;
                arr[15] = 0;      arr[16] = botY; arr[17] = -halfDepth;
                
                pos.needsUpdate = true;
                mesh.geometry.computeBoundingSphere();
            };

            if (this.goalVol1) {
                this.goalVol1.position.set(0, 0, -zCenter);
                updateGeo(this.goalVol1);
            }
            if (this.goalVol2) {
                this.goalVol2.position.set(0, 0, zCenter);
                // Flip Z for goal 2? No, the box is symmetric in Z local space, just position handles it.
                // But Goal 2 faces opposite way. The trigger logic uses abs(x) and y range, so orientation doesn't matter for logic.
                // Visualizer is just a box.
                updateGeo(this.goalVol2);
            }
}

update() {
// Update static debugs
            if (this.goalVol1) this.goalVol1.visible = this.showGoalVolume;
            if (this.goalVol2) this.goalVol2.visible = this.showGoalVolume;

            if (!this.enabled) {
                if (this.visuals.size > 0) this.clear();
                return;
            }

            const game = window.flux.gameInstance;
            if (!game || !game.teams.home) return;

            const entities = [
                ...game.teams.home.players,
                ...game.teams.away.players,
                game.entities.ball
            ];

            entities.forEach(e => {
                if (!e || !e.mesh) return;
                
                let v = this.visuals.get(e);
                if (!v) {
                    v = this.createVisual(e);
                    this.visuals.set(e, v);
                }
                this.updateVisual(e, v);
            });
        }

        createVisual(entity) {
            const group = new THREE.Group();
            this.scene.add(group);

            // Hitboxes
            const tackle = new THREE.Mesh(this.geoCylinder, this.matTackle);
            const catchR = new THREE.Mesh(this.geoCylinder, this.matCatch);
            group.add(tackle);
            group.add(catchR);

            // Lines
            const velLine = this.createLine(this.matVel);
            const inputLine = this.createLine(this.matInput);
            const aiLine = this.createLine(this.matAI); // Line to perceived target
            
            group.add(velLine);
            group.add(inputLine);
            group.add(aiLine);

            return { group, tackle, catchR, velLine, inputLine, aiLine };
        }

        createLine(mat) {
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
            return new THREE.Line(geo, mat);
        }

        updateLine(line, start, end) {
            const pos = line.geometry.attributes.position.array;
            pos[0] = start.x; pos[1] = start.y; pos[2] = start.z;
            pos[3] = end.x; pos[4] = end.y; pos[5] = end.z;
            line.geometry.attributes.position.needsUpdate = true;
            line.visible = true;
        }

        updateVisual(e, v) {
            v.group.visible = true;
            
            // Hitboxes (Local to entity position)
            v.tackle.position.copy(e.mesh.position);
            v.catchR.position.copy(e.mesh.position);
            
            if (this.showHitboxes && e.role) {
                v.tackle.visible = true;
                const rT = e.tackleRadius || 2.5;
                v.tackle.scale.set(rT, 1, rT);

                v.catchR.visible = true;
                // Logic from main.js checkBallGrab
                const rC = e.isDashing ? 4.0 : 2.5; 
                v.catchR.scale.set(rC, 1, rC);
                v.catchR.position.y = e.mesh.position.y + 0.1;
            } else {
                v.tackle.visible = false;
                v.catchR.visible = false;
            }

            // Vectors (Global lines)
            const origin = e.mesh.position.clone();
            origin.y += 1.0; // Lift up

            if (this.showVectors) {
                // Velocity
                if (e.velocity) {
                    const end = origin.clone().add(e.velocity);
                    this.updateLine(v.velLine, origin, end);
                }
                // Input
                if (e.inputVector && e.inputVector.lengthSq() > 0) {
                    const end = origin.clone().add(e.inputVector.clone().multiplyScalar(3.0));
                    this.updateLine(v.inputLine, origin, end);
                } else {
                    v.inputLine.visible = false;
                }
            } else {
                v.velLine.visible = false;
                v.inputLine.visible = false;
            }

            // AI
            if (this.showAI && e.perceivedTargetPos) {
                // Draw line to perceived target
                this.updateLine(v.aiLine, origin, e.perceivedTargetPos);
            } else {
                v.aiLine.visible = false;
            }
        }

        clear() {
            this.visuals.forEach(v => {
                this.scene.remove(v.group);
            });
            this.visuals.clear();
        }
    }
    window.flux.DebugVisualizer = DebugVisualizer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MenuManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.container = document.getElementById('main-menu');
            this.items = document.querySelectorAll('.menu-item');
            
            this.setupEvents();
        }

        setupEvents() {
            this.items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click-through
                    this.handleSelection(item.dataset.action);
                });
                
item.addEventListener('mouseenter', () => {
                    // Optional: Play hover sound
                    if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 0.5, variance: 0.05 });
                });
            });
        }

handleSelection(action) {
            console.log("Menu Selection:", action);
            // Play SFX for any selection
            if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 1.0 });

            if (action === 'normal') {
                this.hide();
                this.game.startMatch('normal');
} else if (action === 'practice') {
                this.hide();
                this.game.startMatch('practice');
            } else if (action === 'ball_lab') {
                this.hide();
                window.flux = window.flux || {};
                window.flux.requestedPracticeDrill = 'ball_lab';
                this.game.startMatch('practice');
            } else if (action === 'options') {
                console.log("Options clicked (Not implemented)");
            }
        }

        show() {
            if (this.container) {
                this.container.classList.add('active');
                this.game.setMenuMode(true);
            }
        }

        hide() {
            if (this.container) {
                this.container.classList.remove('active');
                this.game.setMenuMode(false);
            }
        }
    }

    window.flux.MenuManager = MenuManager;
})();</script>

    <script>(function() {
    window.flux = window.flux || {};

    const _orbGeo = new THREE.SphereGeometry(1.5, 16, 16);
    const _orbMatBase = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

const ORB_TYPES = {
        'HEAL': { color: 0x00ff00, label: 'HP UP', chance: 0.2 },
        'CHARGE': { color: 0xffaa00, label: 'EN UP', chance: 0.2 },
        'TECH': { color: 0x00ffff, label: 'TECH', chance: 0.15 },
        'SPEED': { color: 0xff00ff, label: 'HASTE', chance: 0.15 },
        'FIRE': { color: 0xff4400, label: 'FIRE', chance: 0.1 },
        'ICE': { color: 0xaaddff, label: 'ICE', chance: 0.1 },
        'VOLT': { color: 0xffff00, label: 'VOLT', chance: 0.1 }
    };

    class PowerUpManager {
        constructor(scene, gameManager) {
            this.scene = scene;
            this.game = gameManager;
            this.orbs = [];
            
            this.spawnTimer = 0;
            this.spawnInterval = 10.0; // Spawn every 10 seconds
            this.maxOrbs = 5;

            this.container = new THREE.Group();
            this.scene.add(this.container);
        }

        update(dt) {
            // Only spawn/update during active play
            if (this.game.state === 'active') {
                this.spawnTimer += dt;
                if (this.spawnTimer >= this.spawnInterval) {
                    this.spawnTimer = 0;
                    if (this.orbs.length < this.maxOrbs) {
                        this.spawnRandomOrb();
                    }
                }

                for (let i = this.orbs.length - 1; i >= 0; i--) {
                    const orb = this.orbs[i];
                    
                    orb.age += dt;
                    orb.mesh.position.y = orb.baseY + Math.sin(orb.age * 2.0) * 0.5;
                    orb.mesh.rotation.y += dt * 2.0;
                    orb.mesh.rotation.z += dt * 1.0;

                    if (orb.age > 20.0) {
                        this.removeOrb(i);
                        continue;
                    }

                    this.checkCollision(orb, i);
                }
            }
        }

        spawnRandomOrb() {
            const keys = Object.keys(ORB_TYPES);
            const typeKey = keys[Math.floor(Math.random() * keys.length)];
            const typeData = ORB_TYPES[typeKey];

            const angle = Math.random() * Math.PI * 2;
            const r = Math.random() * 35.0;
            const x = Math.cos(angle) * r;
            const z = Math.sin(angle) * r;
            const y = (Math.random() * 4.0) - 2.0;

            const mesh = new THREE.Mesh(_orbGeo, _orbMatBase.clone());
            mesh.material.color.setHex(typeData.color);
            mesh.position.set(x, y, z);

            const coreGeo = new THREE.SphereGeometry(0.7, 8, 8);
            const coreMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const core = new THREE.Mesh(coreGeo, coreMat);
            mesh.add(core);

            this.container.add(mesh);

            this.orbs.push({
                mesh: mesh,
                type: typeKey,
                data: typeData,
                baseY: y,
                age: 0
            });
            
            // Spawn effect
            if (this.game.particleManager) {
                this.game.particleManager.spawn('flash', new THREE.Vector3(x,y,z), { scale: 2.0, color: typeData.color });
            }
        }

        checkCollision(orb, index) {
            const players = [];
            if (this.game.teams.home) players.push(...this.game.teams.home.players);
            if (this.game.teams.away) players.push(...this.game.teams.away.players);

            const collisionRadiusSq = 2.5 * 2.5;

            for (const p of players) {
                if (!p.mesh) continue;
                
                const distSq = p.mesh.position.distanceToSquared(orb.mesh.position);
                if (distSq < collisionRadiusSq) {
                    this.collectOrb(orb, p);
                    this.removeOrb(index);
                    return;
                }
            }
        }

collectOrb(orb, player) {
            switch (orb.type) {
                case 'HEAL':
                    player.stats.HP = Math.min(player.stats.HP + 50, player.stats.maxHP);
                    break;
                case 'CHARGE':
                    player.currentEN = Math.min(player.currentEN + 30, player.getStat('EN'));
                    break;
                case 'TECH':
                    player.gainExp(20); // Give EXP for now
                    break;
                case 'SPEED':
                    player.applyStatus('haste', 8.0);
                    break;
                case 'FIRE':
                    player.elementalInfusion = { type: 'fire', duration: 15.0 };
                    break;
                case 'ICE':
                    player.elementalInfusion = { type: 'ice', duration: 15.0 };
                    break;
                case 'VOLT':
                    player.elementalInfusion = { type: 'volt', duration: 15.0 };
                    break;
            }

            if (this.game.floatingText) {
                this.game.floatingText.spawn(orb.data.label, player.mesh.position, "heal");
            }
            
            if (this.game.particleManager) {
                for(let i=0; i<5; i++) {
                    this.game.particleManager.spawn('flash', orb.mesh.position, { 
                        scale: 1.5, 
                        color: orb.data.color 
                    });
                }
            }

            if (this.game.audioManager) {
                this.game.audioManager.playSFX('menu', { volume: 0.8, rate: 1.5 });
            }
        }

        removeOrb(index) {
            const orb = this.orbs[index];
            if (orb.mesh) {
                this.container.remove(orb.mesh);
                if (orb.mesh.material) orb.mesh.material.dispose();
                // Dispose children
                orb.mesh.traverse(c => {
                    if (c.isMesh) {
                        if (c.geometry) c.geometry.dispose();
                        if (c.material) c.material.dispose();
                    }
                });
            }
            this.orbs.splice(index, 1);
        }
        
        reset() {
            for (let i = this.orbs.length - 1; i >= 0; i--) {
                this.removeOrb(i);
            }
            this.spawnTimer = 0;
        }
    }

    window.flux.PowerUpManager = PowerUpManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class PracticeManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.isRunning = false;
            this.currentDrill = null;
            this.drillState = {}; 
            
this.drills = {
                'free': { name: 'FREE ROAM', setup: this._setupFree.bind(this), loop: this._loopFree.bind(this) },
                'ball_lab': { name: 'BALL LAB', setup: this._setupBallLab.bind(this), loop: this._loopBallLab.bind(this) },
                'shooting': { name: 'SHOOTING DRILL', setup: this._setupShooting.bind(this), loop: this._loopShooting.bind(this) },
                'passing': { name: 'PASSING DRILL', setup: this._setupPassing.bind(this), loop: this._loopPassing.bind(this) },
                'defense': { name: 'DEFENSE DRILL', setup: this._setupDefense.bind(this), loop: this._loopDefense.bind(this) },
                'curve': { name: 'CURVE SHOT', setup: this._setupCurve.bind(this), loop: this._loopCurve.bind(this) },
                'rapid_fire': { name: 'RAPID FIRE', setup: this._setupRapidFire.bind(this), loop: this._loopRapidFire.bind(this) }
            };

this.ui = document.getElementById('practice-overlay');
            this.gestureHint = document.getElementById('gesture-hint');
            
            this.options = {
                infStats: true,
                aiDummy: true,
                showHitboxes: false
            };
            
this.targetRing = null;
            this.ghostBalls = []; // Array to track visual copies of thrown balls
            this._initVisuals();
            this._setupEvents();
        }

        _initVisuals() {
            // Create a glowing ring for targets
            const geometry = new THREE.RingGeometry(1.5, 1.8, 32);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                side: THREE.DoubleSide, 
                transparent: true, 
                opacity: 0.6,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            this.targetRing = new THREE.Mesh(geometry, material);
            this.targetRing.visible = false;
            // Add to scene via game manager reference
            if (this.game.scene) this.game.scene.add(this.targetRing);
        }

        start() {
this.isRunning = true;
            this._showPanel();
            // If menu requested a specific drill (e.g., Ball Lab), honor it once.
            const req = window.flux && window.flux.requestedPracticeDrill;
            if (req && this.drills[req]) {
                this.setDrill(req);
                window.flux.requestedPracticeDrill = null;
            } else {
                this.setDrill('free');
            }
            
            // Ensure HUD is visible
            const hud = document.getElementById('ui-layer');
            if(hud) hud.style.visibility = 'visible';
        }

        stop() {

            this.isRunning = false;
            this._hidePanel();
            this._hideRestoreBtn();
this._clearDrill();
            
// Clear Ghost Balls
            this.ghostBalls.forEach(b => {
                if (b.mesh) this.game.scene.remove(b.mesh);
                if (b.trail) {
                    this.game.scene.remove(b.trail.mesh);
                    if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                }
            });
            if (this.targetRing) this.targetRing.visible = false;

            // Restore Away Team Visibility for Normal Match
// Restore Away Team Visibility for Normal Match
            if (this.game.teams.away) {
                this.game.teams.away.players.forEach(p => {
                    if(p.mesh) {
                        p.mesh.visible = true;
                        p.mesh.position.y = 0; // Ensure they aren't stuck under floor
                        p.canCatch = true; // Restore catching
                    }
                });
            }

            // Disable debug visuals if they were on
            if (this.game.debugVisualizer) {
                this.game.debugVisualizer.enabled = false;
                this.game.debugVisualizer.showHitboxes = false;
            }
        }

        setDrill(key) {
            if (!this.drills[key]) return;
            this._clearDrill();
            this.currentDrill = key;
            
            // Update UI
            if (this.ui) {
                this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.drill === key);
                });
            }

            // Run Setup
            this.drills[key].setup();
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(this.drills[key].name, 'normal');
            }
        }

update(dt) {
            if (!this.isRunning) return;

            // Common Practice Logic (Infinite Stats)
            if (this.options.infStats) {
                this._applyInfiniteStats();
            }

            // Drill Logic
            if (this.currentDrill && this.drills[this.currentDrill].loop) {
                this.drills[this.currentDrill].loop(dt);
            }
            
            // Visuals Animation
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.rotation.z += dt; // Spin
                const s = 1.0 + Math.sin(Date.now() * 0.005) * 0.1;
                this.targetRing.scale.set(s, s, s);
            }

            // Update Ghost Balls
            for (let i = this.ghostBalls.length - 1; i >= 0; i--) {
                const b = this.ghostBalls[i];
                b.life -= dt;
                
                // --- PHYSICS & VISUALS DELEGATION ---
                if (window.flux.Ball && window.flux.Ball.prototype.updateFree) {
                    window.flux.Ball.prototype.updateFree.call(b, dt);
                    window.flux.Ball.prototype.updateVisuals.call(b, dt);
                }

                // Update Trail
                if (b.trail) {
                    const trailPos = b.mesh.position.clone();
                    if (b.deformNode) trailPos.y += b.deformNode.position.y;
                    b.trail.update(trailPos);
                }

                // --- GOAL DETECTION FOR GHOST BALLS ---
                const pos = b.mesh.position;
                // Check Z depth (Goal is at +/- 28, trigger at 29)
                if (Math.abs(pos.z) > 40.0) {
                    // Goal Detection (Inverted Triangle Hitbox)
const triTopY = 9.0;
                    const triBottomY = -6.0;
                    const triMaxHalfWidth = 14.0;
                    
                    if (pos.y <= triTopY && pos.y >= triBottomY) {
                        const t = (pos.y - triBottomY) / (triTopY - triBottomY);
                        const allowedX = t * triMaxHalfWidth;

                        if (Math.abs(pos.x) <= allowedX) {
                            // GOAL!
                            if (this.game.particleManager) {
                                // Spawn Goal FX
                                this.game.particleManager.spawn('shockwave', pos, { scale: 8.0, life: 0.5 });
                                this.game.particleManager.spawn('flash', pos, { scale: 5.0 });
                                // Debris
for(let k=0; k<5; k++) this.game.particleManager.spawn('debris', pos, { scale: 0.5, rotationSpeed: (Math.random()-0.5)*10, frame: Math.floor(Math.random()*4) });
                            }
                            if (this.game.floatingText) {
                                this.game.floatingText.spawn("GOAL", pos, "goal");
                            }
                            // Kill ball immediately
                            b.life = 0;
                        }
                    }
                }

                // Cleanup
                if (b.life <= 0 || b.mesh.position.y < -10) {
                    this.game.scene.remove(b.mesh);
                    if (b.trail) {
                        this.game.scene.remove(b.trail.mesh);
                        if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                    }
                    this.ghostBalls.splice(i, 1);
                }
            }
        }
        _setupEvents() {

            // Minimize / Restore
            const minBtn = this.ui.querySelector('#p-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._hidePanel();
                    this._showRestoreBtn();
                });
            }

            const restoreBtn = document.getElementById('practice-restore-btn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._showPanel();
                    this._hideRestoreBtn();
                });
            }

            // Drill Buttons
            this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setDrill(btn.dataset.drill);
                });
            });

            // Reset Ball
            const resetBtn = this.ui.querySelector('#p-reset-ball');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._resetBallToPlayer();
                });
            }

            // Exit
            const exitBtn = this.ui.querySelector('#p-exit');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        this.stop();
                    }
                });
            }

            // Options Toggles
            this._bindToggle('opt-inf-stat', 'infStats');
            this._bindToggle('opt-ai-dummy', 'aiDummy', (val) => {
                // Update AI Dummy state immediately
                if (this.game.teams.away) {
                    this.game.teams.away.aiEnabled = !val; // If dummy is TRUE, AI is FALSE
                }
            });
            this._bindToggle('opt-hitboxes', 'showHitboxes', (val) => {
                if (this.game.debugVisualizer) {
                    this.game.debugVisualizer.enabled = val;
                    this.game.debugVisualizer.showHitboxes = val;
                }
            });

            // Keyboard Shortcut for Reset (R)
// Keyboard Shortcut for Reset (R)
            window.addEventListener('keydown', (e) => {
                if (this.isRunning && e.key.toLowerCase() === 'r' && !e.repeat) {
                    this._resetBallToPlayer();
                }
            });
        }

_bindToggle(id, optionKey, callback) {
            const el = this.ui.querySelector(`#${id}`);
            if (!el) return;

            // Helper to update visuals
            const updateVisual = () => {
                const isActive = this.options[optionKey];
                el.classList.toggle('active', isActive);
                const box = el.querySelector('.checkbox');
                if (box) box.innerText = isActive ? '' : '';
            };

            // Initialize visual state immediately
            updateVisual();

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                this.options[optionKey] = !this.options[optionKey];
                
                updateVisual();

                if (callback) callback(this.options[optionKey]);
            });
        }


        _setupBallLab() {
            this._setInstruction("BALL LAB: Open DevTools  Ball Lab. Use Shot Cannon + trajectory preview + record/replay.");
            this.drillState.resetting = false;
            this.drillState._autoResetTimer = 0;

            const home = this.game.teams.home;
            const away = this.game.teams.away;
            const p = home ? home.activePlayer : null;
            if (!p) return;

            // Solo mode: hide everyone except the active player
            if (home && home.players) {
                home.players.forEach(mate => {
                    if (mate.mesh) mate.mesh.visible = (mate === p);
                });
            }
            if (away && away.players) {
                away.players.forEach(opp => {
                    if (opp.mesh) opp.mesh.visible = false;
                });
            }

            // Place active player at center facing the away goal
            if (p.mesh) {
                p.mesh.position.set(0, 0, 0);
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0, 0, 0);
                if (p.syncRotation) p.syncRotation();
            }

            // Big stats so you can test extremes
            if (p.stats) {
                p.stats.SH = 99;
                p.stats.PA = 99;
                p.stats.EN = 99;
                p.stats.maxHP = Math.max(p.stats.maxHP || 999, 999);
                p.stats.HP = p.stats.maxHP;
            }

            // A clear target marker (purely visual)
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -18);
                this.targetRing.material.color.setHex(0xff00ff);
            }

            this._resetBallToPlayer();
        }

        _loopBallLab(dt) {
            const b = this.game.entities.ball;
            const p = this.game.teams.home.activePlayer;
            if (!b || !p) return;

            // Auto-reset ball back to player once it comes to rest,
            // so you can spam variations without touching anything.
            if (b.state === 'free') {
                const stopped = (b.velocity.lengthSq() < 0.01) && (b.power <= 0.01);
                if (stopped) {
                    this.drillState._autoResetTimer = (this.drillState._autoResetTimer || 0) + dt;
                    if (this.drillState._autoResetTimer > 0.45) {
                        this._resetBallToPlayer();
                        this.drillState._autoResetTimer = 0;
                    }
                } else {
                    this.drillState._autoResetTimer = 0;
                }
            } else {
                this.drillState._autoResetTimer = 0;
            }

            // Slight target bob (helps depth perception)
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            }
        }

        _applyInfiniteStats() {
            const home = this.game.teams.home;
            if (home) {
                home.players.forEach(p => {
                    p.stats.HP = p.stats.maxHP;
                    p.currentEN = p.stats.EN;
                    p.status.venom = 0;
                    p.status.nap = 0;
                    p.stunTimer = 0;
                });
            }
        }

        _clearDrill() {

            // Reset positions, clear dummies, reset score
            if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
            this.drillState = { score: 0, timer: 0, stage: 0, resetting: false };
            if (this.gestureHint) this.gestureHint.style.display = 'none';
            this._updateScoreUI(0);
            
            // Clear Glyphs
            if (this.game.glyphManager) this.game.glyphManager.clear();
            
            if (this.targetRing) this.targetRing.visible = false;

            // Reset teams to default positions

// Reset teams to default positions
            this.game.teams.home.resetPositions();
            this.game.teams.away.resetPositions();
            
            // Apply AI Dummy setting
            if (this.game.teams.away) {
                this.game.teams.away.aiEnabled = !this.options.aiDummy;
            }
// Hide away team by default in drills unless specified
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = false;
                p.mesh.position.set(0, -1000, 0); // Move WAY away to prevent interaction
                p.velocity.set(0,0,0);
                p.canCatch = false; // Disable catching
            });
            
            // Ensure Home team is visible
            this.game.teams.home.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
            });
        }

        _resetBallToPlayer() {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;
            if (p && b) {
                b.reset();
                b.grab(p);
                if (this.game.floatingText) this.game.floatingText.spawn("RESET", p.mesh.position, "tech");
                
                // Snap camera
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        }

        _updateScoreUI(val) {
            const el = this.ui.querySelector('#drill-score');
            if (el) el.innerText = `SCORE: ${val}`;
        }

        _setInstruction(text) {
             const el = this.ui.querySelector('#drill-instruction');
             if (el) el.innerText = text;
        }

        // --- DRILLS ---

_setupFree() {
            this._setInstruction("Free practice. Infinite HP/EN.");
            // Show everyone
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
                p.mesh.position.copy(p.homePosition);
                p.canCatch = true; // Restore capability
            });
            this._resetBallToPlayer();
        }
        _loopFree(dt) {}

        _setupShooting() {

            this._setInstruction("Score on the Goalie!");
            this.drillState.resetting = false; // Clear reset flag
            
            // Setup: Active Player at 18m, Goalie in net.
            const p = this.game.teams.home.activePlayer;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (p && p.mesh) {
                p.mesh.position.set(0, 0, -10); // 18m out (Home attacks -Z)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }
            if (g && g.mesh) {
                g.mesh.visible = true;
                g.mesh.position.set(0, 0, -27);
                g.mesh.lookAt(0, 0, 0);
                g.velocity.set(0,0,0);
            }
            
            this._resetBallToPlayer();
        }
        
_loopShooting(dt) {
            if (this.drillState.resetting) return;

            // Check if goal scored (GameManager handles the actual goal event, but we track reset)
            if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                this.game.state = 'active'; // Hijack state back
                setTimeout(() => this._setupShooting(), 1000);
                return;
            }

            // Check for Save (Ball stopped or moving away from goal without scoring)
            const ball = this.game.entities.ball;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (ball && g && g.mesh) {
                const dist = ball.mesh.position.distanceTo(g.mesh.position);
                // If ball is close to goalie and stopped/caught
                if (dist < 3.0 && (ball.holder === g || ball.velocity.length() < 1.0)) {
                     this.drillState.resetting = true;
                     if (this.game.floatingText) this.game.floatingText.spawn("SAVED", g.mesh.position, "damage");
                     setTimeout(() => this._setupShooting(), 1000);
                }
            }
        }

        _setupPassing() {

             this._setInstruction("Pass to the moving target!");
             this.drillState.resetting = false;

             // Setup: Active Player center. 1 Teammate running patterns.
             const p = this.game.teams.home.activePlayer;
             const target = this.game.teams.home.players.find(x => x !== p && x.role !== 'GL');
             
             this.drillState.target = target;
             
             if (p) {
                 p.mesh.position.set(0, 0, 10);
                 p.velocity.set(0,0,0);
             }
             if (target) {
                 target.mesh.position.set(0, 0, -10);
                 target.mesh.visible = true;
                 target.velocity.set(0,0,0);
             }
             
             this._resetBallToPlayer();
        }

        _loopPassing(dt) {
            if (this.drillState.resetting) return;

            const target = this.drillState.target;
            if (!target) return;
            
            // Move target in circle
            this.drillState.timer += dt;
            target.mesh.position.x = Math.sin(this.drillState.timer) * 10;
            target.mesh.position.z = -10 + Math.cos(this.drillState.timer * 0.5) * 5;
            target.mesh.lookAt(0,0,10);

            // Update Ring
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(target.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0x00ffff); // Cyan
            }

            if (target.hasBall) {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                if (this.game.floatingText) this.game.floatingText.spawn("NICE PASS!", target.mesh.position, "heal");
                
                // Reset
                setTimeout(() => {
                    target.loseBall();
                    this._setupPassing(); // Re-setup to reset positions
                }, 800);
            }
        }
        
        _setupDefense() {

            this._setInstruction("Tackle the attacker!");
            this.drillState.resetting = false;

            const p = this.game.teams.home.activePlayer;
            const attacker = this.game.teams.away.players.find(x => x.role === 'MF');
            
            this.drillState.attacker = attacker;
            
            if (p) {
                p.mesh.position.set(0, 0, 20); // Near own goal
                p.velocity.set(0,0,0);
            }
            if (attacker) {
                attacker.mesh.visible = true;
                attacker.mesh.position.set(0, 0, -10);
                attacker.velocity.set(0,0,0);
                // Give ball to attacker
                const b = this.game.entities.ball;
                b.reset();
                b.grab(attacker);
            }
        }
        
        _loopDefense(dt) {
            if (this.drillState.resetting) return;

            const attacker = this.drillState.attacker;
            const p = this.game.teams.home.activePlayer;
            
            if (!attacker || !p) return;
            
            // Attacker runs to goal (+Z)
// Attacker runs to goal (+Z)
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalPos = new THREE.Vector3(0, 0, goalDist);
            const dir = goalPos.clone().sub(attacker.mesh.position).normalize();
            
            // Update Ring on Attacker
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(attacker.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0xff0000); // Red for enemy
            }

            if (attacker.hasBall) {
                attacker.setInput(dir.x, dir.z);
            } else {
                // Ball lost (Tackled)
                if (p.hasBall || this.game.entities.ball.state === 'free') {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("STOPPED!", p.mesh.position, "block");
                    setTimeout(() => this._setupDefense(), 1000);
                }
            }
            
            // Fail condition: Attacker scores (GameManager handles goal check)
             if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.game.state = 'active';
                if (this.game.floatingText) this.game.floatingText.spawn("FAILED", p.mesh.position, "damage");
                setTimeout(() => this._setupDefense(), 1000);
            }
}

        _setupCurve() {
this._setInstruction("Swipe a CURVE ( ) ) to bypass the defender!");
            this.drillState.resetting = false;

            // Show gesture hint
            if (this.gestureHint) {
                this.gestureHint.style.display = 'flex';
                this.gestureHint.classList.add('active');
                
                // Clear any existing timeout
                if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
                
                // Auto hide after 4s
                this.drillState.hintTimeout = setTimeout(() => {
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'none';
                        this.gestureHint.classList.remove('active');
                    }
                }, 4000);
            }

            const p = this.game.teams.home.activePlayer;
            // Use a defender dummy
            const defender = this.game.teams.away.players.find(x => x.role === 'LD');
            this.drillState.defender = defender;

            if (p) {
                p.mesh.position.set(0, 0, 15);
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }

            if (defender) {
                defender.mesh.visible = true;
                defender.mesh.position.set(0, 0, 5); // 10m in front of player
                defender.mesh.lookAt(0, 0, 15); // Face player
                defender.velocity.set(0,0,0);
                // Boost BL to ensure straight shots are blocked
                defender.stats.BL = 99; 
                // Ensure they don't move
                defender.aiState = 'IDLE';
            }

            // Target Ring behind defender
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -10);
                this.targetRing.material.color.setHex(0x00ffff);
            }

            this._resetBallToPlayer();
        }

_loopCurve(dt) {
            if (this.drillState.resetting) return;

            const ball = this.game.entities.ball;
            const defender = this.drillState.defender;

            // Check if ball passed the defender line (z < 0)
            if (ball.mesh.position.z < 0) {
                // Success zone (Within 5m width)
                if (Math.abs(ball.mesh.position.x) < 5) {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("CURVED!", ball.mesh.position, "tech");
                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Check if blocked (Ball stopped or power drained significantly near defender)
            if (defender && ball.mesh.position.distanceTo(defender.mesh.position) < 3.0) {
                if (ball.power <= 0 || ball.velocity.length() < 1.0) {
                    this.drillState.resetting = true;
                    if (this.game.floatingText) this.game.floatingText.spawn("BLOCKED", defender.mesh.position, "damage");
                    
                    // Re-show hint on failure to guide player
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'flex';
                        this.gestureHint.classList.add('active');
                        clearTimeout(this.drillState.hintTimeout);
                        this.drillState.hintTimeout = setTimeout(() => {
                            if (this.gestureHint) {
                                this.gestureHint.style.display = 'none';
                                this.gestureHint.classList.remove('active');
                            }
                        }, 4000);
                    }

                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Missed / Out of bounds
            if (ball.mesh.position.z < -15) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("MISSED", ball.mesh.position, "damage");
                 
                 // Re-show hint on miss
                 if (this.gestureHint) {
                    this.gestureHint.style.display = 'flex';
                    this.gestureHint.classList.add('active');
                    clearTimeout(this.drillState.hintTimeout);
                    this.drillState.hintTimeout = setTimeout(() => {
                        if (this.gestureHint) {
                            this.gestureHint.style.display = 'none';
                            this.gestureHint.classList.remove('active');
                        }
                    }, 4000);
                 }

                 setTimeout(() => this._setupCurve(), 1000);
            }
        }

_setupRapidFire() {
            this._setInstruction("UNLIMITED AMMO! Spam throws!");
            this.drillState.resetting = false;

            // Find Tidus or default to LF
            let p = this.game.teams.home.players.find(x => x.characterName && x.characterName.includes('Tidus'));
            if (!p) p = this.game.teams.home.players.find(x => x.role === 'LF');
            
            // Set active player
            if (p) {
                this.game.teams.home.setActivePlayer(p);
                p.mesh.position.set(0, 0, 0);
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
                
                // Boost stats for fun
                p.stats.SH = 99;
                p.stats.PA = 99;
            }

            // HIDE EVERYONE (Alone Mode)
            this.game.teams.home.players.forEach(mate => {
                if (mate !== p && mate.mesh) mate.mesh.visible = false;
            });
            this.game.teams.away.players.forEach(opp => {
                if (opp.mesh) opp.mesh.visible = false;
            });

            this._resetBallToPlayer();
        }

_loopRapidFire(dt) {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;

            if (!p || !b) return;

            // Detect if ball was just thrown (is free)
            if (b.state === 'free') {
                // 1. Spawn Ghost Ball (Visual Copy)
                // Clone the mesh hierarchy to preserve Deform/Spin nodes
                const ghostMesh = b.mesh.clone();
                
                // Ensure visibility and add to scene
                this.game.scene.add(ghostMesh);
                
                // Re-bind internal references for the physics engine
                // Hierarchy: Mesh -> DeformNode -> SpinNode
                const deformNode = ghostMesh.children[0];
                const spinNode = deformNode ? deformNode.children[0] : null;

                // Determine Trail Color based on Tech
                let trailColor = 0xff4400; // Default SH (Orange)
                if (b.technique) {
                    if (b.technique.type === 'venom') trailColor = 0xaa00ff;
                    else if (b.technique.type === 'wither') trailColor = 0x888888;
                    else if (b.technique.type === 'nap') trailColor = 0x000088;
                    else if (b.technique.type === 'sphere') trailColor = 0x00ffff;
                    else if (b.technique.type === 'jecht') trailColor = 0xff0000;
                    else if (b.technique.type === 'invisible') trailColor = 0x444444;
                } else if (b.powerType === 'PA') {
                    trailColor = 0x00aaff; // Pass (Blue)
                }

                // Create Trail
                const trail = new window.flux.TrailRenderer(this.game.scene);
                trail.active = true;
                trail.setColor(trailColor);
                trail.reset(ghostMesh.position);

                // Create a "Mock" Ball object that satisfies Ball.js physics requirements
                const ghostBall = {
                    mesh: ghostMesh,
                    deformNode: deformNode,
                    spinNode: spinNode,
                    velocity: b.velocity.clone(),
                    angularVelocity: b.angularVelocity ? b.angularVelocity.clone() : new THREE.Vector3(),
                    accumulatedRotation: b.accumulatedRotation ? b.accumulatedRotation.clone() : new THREE.Quaternion(),
                    state: 'free',
                    power: b.power,
                    powerType: b.powerType,
                    technique: b.technique,
                    isInvisible: b.isInvisible,
                    life: 5.0, // Enough time to reach goal
                    trail: trail,
                    _bubbleTimer: 0,
                    _ghost: true,
                    // Mock methods
                    reset: () => {}, 
                    drop: () => {},
                    reveal: () => {}
                };

                // Apply visibility
                ghostMesh.visible = !b.isInvisible;

                this.ghostBalls.push(ghostBall);

// 2. Reset Real Ball to Player INSTANTLY
                b.velocity.set(0, 0, 0);
                b.angularVelocity.set(0, 0, 0);
                
                // FIX: Force ball position to be explicitly in front of the player
                // This prevents any logic from thinking the ball is behind and triggering a turn
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                b.mesh.position.copy(p.mesh.position).add(fwd.multiplyScalar(0.8));
                b.mesh.position.y += 1.0;

                // Manual Attach (Bypass 'catch' animation)
                b.holder = p;
                b.state = 'held';
                p.hasBall = true;
                
                // Reset Player Throw State so they can fire again immediately
                p.isThrowing = false;
                p.catchCooldown = 0;

                // Sync rotation to prevent snapping
                if (p.syncRotation) p.syncRotation();
            }
            
            // Ensure infinite stats
            p.currentEN = p.stats.EN;
            p.stats.HP = p.stats.maxHP;
        }

        _showPanel() {
            if (this.ui) this.ui.classList.add('active');
        }

        _hidePanel() {
            if (this.ui) this.ui.classList.remove('active');
        }

        _showRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'block';
        }

        _hideRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'none';
        }
    }
window.flux.PracticeManager = PracticeManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- High-Quality Noise Texture Generator ---
    window.flux.noiseTexture = (() => {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        
        // Generate seamless noise (Perlin-ish via layered random circles/gradients)
        const drawNoiseLayer = (scale, alpha) => {
            ctx.globalAlpha = alpha;
            ctx.globalCompositeOperation = 'lighter'; // Additive
            const count = 300 * scale;
            for(let i=0; i<count; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const r = (Math.random() * 30 + 10) / scale;
                
                const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                g.addColorStop(0, '#888888');
                g.addColorStop(1, 'transparent');
                
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                
                // Wrap around for seamless tiling
                [[x-size, y], [x+size, y], [x, y-size], [x, y+size]].forEach(pos => {
                    const g2 = ctx.createRadialGradient(pos[0], pos[1], 0, pos[0], pos[1], r);
                    g2.addColorStop(0, '#888888');
                    g2.addColorStop(1, 'transparent');
                    ctx.fillStyle = g2;
                    ctx.beginPath(); ctx.arc(pos[0], pos[1], r, 0, Math.PI*2); ctx.fill();
                });
            }
        };
        
        drawNoiseLayer(1.0, 0.3);
        drawNoiseLayer(2.0, 0.2);
        drawNoiseLayer(4.0, 0.1);
        
        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = THREE.RepeatWrapping;
        tex.wrapT = THREE.RepeatWrapping;
        return tex;
    })();

    class WaterOverlay {
        constructor(camera) {
            this.camera = camera;
            
            // Fullscreen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
            const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                precision mediump float;
                uniform float uTime;
                uniform float uOpacity;
                uniform sampler2D tNoise;
                varying vec2 vUv;

                // FFX Palette (Additive Friendly)
                const vec3 C_DEEP = vec3(0.0, 0.05, 0.2);     // Deep Blue
                const vec3 C_GLOW = vec3(0.0, 0.6, 0.9);      // Cyan Glow
                const vec3 C_RAY  = vec3(0.5, 0.8, 1.0);      // Light Shafts
                const vec3 C_PYRE = vec3(1.0, 0.85, 0.5);     // Pyrefly Gold

                // 4x4 Bayer Matrix for Ordered Dithering
                float bayer4x4(vec2 uv) {
                    int x = int(mod(uv.x, 4.0));
                    int y = int(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0) { if (x == 0) v = 0.0; else if (x == 1) v = 8.0; else if (x == 2) v = 2.0; else v = 10.0; }
                    else if (y == 1) { if (x == 0) v = 12.0; else if (x == 1) v = 4.0; else if (x == 2) v = 14.0; else v = 6.0; }
                    else if (y == 2) { if (x == 0) v = 3.0; else if (x == 1) v = 11.0; else if (x == 2) v = 1.0; else v = 9.0; }
                    else { if (x == 0) v = 15.0; else if (x == 1) v = 7.0; else if (x == 2) v = 13.0; else v = 5.0; }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    float t = uTime * 0.12;

                    // 1. Distortion (Lookup 1)
                    float warp = texture2D(tNoise, uv * 0.4 + vec2(t * 0.04, t * 0.02)).r;
                    
                    // 2. Caustics (Lookup 2)
                    vec2 cUV = uv * 2.0 + vec2(warp * 0.5, warp * 0.2) - vec2(t * 0.05);
                    float c = texture2D(tNoise, cUV).r;
                    
                    c = (c - 0.4) * 2.5;
                    c = max(0.0, c);
                    c = pow(c, 3.0); // Sharper caustics
                    
                    float caustic = c * 10.0;
                    vec3 causticColor = vec3(caustic * 0.7, caustic, caustic * 1.3);

                    // 3. Rays (Lookup 3)
                    vec2 rayUV = vec2(uv.x + warp * 0.1, uv.y * 0.15 - t * 0.05);
                    float rays = texture2D(tNoise, rayUV).r;
                    rays = rays * rays;
                    
                    float rayMask = 1.0 - abs(uv.y * 2.0 - 1.0);
                    rays *= max(0.0, rayMask);

                    // 4. Pyreflies
                    vec2 p = uv * 6.0;
                    vec2 id = floor(p);
                    vec2 sub = fract(p) - 0.5;
                    
                    float n = fract(sin(dot(id, vec2(12.9898, 78.233))) * 43758.5453);
                    float px = fract(n * 13.0 + t * 0.3) - 0.5;
                    float py = fract(n * 7.0 + t * 0.2) - 0.5;
                    
                    vec2 flyPos = vec2(px, py);
                    float d2 = dot(sub - flyPos, sub - flyPos);
                    
                    float fly = 0.0006 / (d2 + 0.0005);
                    fly *= step(0.6, n); 
                    fly *= 0.5 + 0.5 * sin(t * 5.0 + n * 10.0);

                    // Composition
                    vec3 finalCol = vec3(0.0);

                    // Vignette
                    vec2 vd = uv - 0.5;
                    float vSq = dot(vd, vd);
                    float vig = vSq * 1.5; 
                    finalCol += C_DEEP * vig;

                    finalCol += causticColor * C_GLOW * 0.5;
                    finalCol += rays * C_RAY * 0.4;
                    finalCol += fly * C_PYRE;

                    // --- PSX DITHERING & QUANTIZATION ---
                    
                    // 1. Get Dither Value (Screen Space)
                    float dither = bayer4x4(gl_FragCoord.xy);
                    
                    // 2. Color Depth Reduction (e.g. 32 levels = 5 bit)
                    float colorDepth = 32.0;
                    
                    // 3. Apply Dither to Color
                    // We add noise before quantization to smooth bands
                    // The magnitude is 1/Depth centered around 0
                    vec3 dithered = finalCol + (dither - 0.5) * (1.0 / colorDepth);
                    
                    // 4. Quantize
                    dithered = floor(dithered * colorDepth) / colorDepth;
                    
                    // 5. Dithered Alpha/Intensity
                    // Instead of simple alpha blending, we can use dither to break up faint details
                    // This gives that "crunchy" look in dark areas
                    float intensity = length(dithered);
                    // Boost shadows with dither noise
                    dithered += (dither - 0.5) * 0.02;

                    gl_FragColor = vec4(dithered, uOpacity);
                }
            `;

            this.material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uOpacity: { value: 0.5 },
                    tNoise: { value: window.flux.noiseTexture }
                },
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthTest: false,
                depthWrite: false,
                blending: THREE.AdditiveBlending // Additive blending prevents dark occlusion
            });

            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.mesh.renderOrder = 9999;
            
            // Add to camera so it stays on screen
            this.camera.add(this.mesh);
        }
        
        update(dt) {
            if (this.material) {
                this.material.uniforms.uTime.value += dt;
            }
        }
    }
    
    window.flux.WaterOverlay = WaterOverlay;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class LightShafts {
        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.uniforms = {
                uTime: { value: 0 },
                tNoise: { value: null }
            };

            this._init();
        }

_init() {
            // Geometry: A cluster of cones/cylinders
            // We use a single geometry with instancing or merged geometry for performance,
            // but for simplicity and aesthetic control, let's use a few large planes or a cylinder.
            // A large cylinder with open ends works well for a "pool" shaft effect.
            
            // Increased length to 90 to accommodate tilt without clipping top/bottom
            const geometry = new THREE.CylinderGeometry(30, 20, 90, 32, 1, true);
            
            // Shader
            const vert = `
                varying vec2 vUv;
                varying vec3 vPos;
                void main() {
                    vUv = uv;
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform float uTime;
                uniform sampler2D tNoise;
                varying vec2 vUv;
                varying vec3 vPos;

                void main() {
                    // Vertical fade (Soft top and bottom)
                    float alpha = smoothstep(0.0, 0.3, vUv.y) * smoothstep(1.0, 0.6, vUv.y);

                    // Scrolling Rays
                    // Layer 1: Slow, broad rays
                    float n1 = texture2D(tNoise, vec2(vUv.x * 2.0 + uTime * 0.02, vUv.y * 0.5 - uTime * 0.05)).r;
                    
                    // Layer 2: Fast, interference rays
                    float n2 = texture2D(tNoise, vec2(vUv.x * 3.0 - uTime * 0.03, vUv.y * 0.5 - uTime * 0.1)).r;

                    float rays = n1 * n2;
                    // Boost intensity significantly (Removed pow to prevent crushing)
                    rays = rays * 3.0; 

                    // Glistening Sparkles (High frequency noise)
                    float sparkle = texture2D(tNoise, vUv * vec2(8.0, 2.0) + vec2(uTime * 0.1, uTime * 0.3)).r;
                    sparkle = pow(sparkle, 5.0) * 10.0; // Sharp points

                    // Color: Cyan/Blue/White (Brighter base)
                    vec3 color = vec3(0.6, 0.9, 1.0);
                    
                    // Combine (Higher multipliers)
                    float finalAlpha = (rays * 0.8 + sparkle * 0.4) * alpha;
                    
                    // Distance fade (optional, handled by fog usually but we want additive)
                    gl_FragColor = vec4(color, finalAlpha);
                }
            `;

            const material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                side: THREE.DoubleSide
            });

            // Container for the angle (Realistic Light Source)
            this.container = new THREE.Group();
            // Angle: Coming from top-left (simulating surface sun penetrating deep water)
            this.container.rotation.z = Math.PI / 5; // ~36 degrees tilt
            this.container.rotation.x = Math.PI / 10; // ~18 degrees forward
            this.container.position.set(12, 8, 0); // Offset source to hit arena center
            this.scene.add(this.container);

            this.mesh = new THREE.Mesh(geometry, material);
            this.mesh.renderOrder = 100; 
            this.mesh.position.set(0, 0, 0);
            this.container.add(this.mesh);

            // Add a second layer for core intensity
            const coreGeo = new THREE.CylinderGeometry(12, 8, 90, 16, 1, true);
            this.coreMesh = new THREE.Mesh(coreGeo, material);
            this.coreMesh.renderOrder = 100;
            this.container.add(this.coreMesh);
        }

        update(dt) {
            this.uniforms.uTime.value += dt;
            
            // Lazy load texture
            if (!this.uniforms.tNoise.value && window.flux.noiseTexture) {
                this.uniforms.tNoise.value = window.flux.noiseTexture;
                // Ensure wrapping is correct for the cylinder UVs
                window.flux.noiseTexture.wrapS = THREE.RepeatWrapping;
                window.flux.noiseTexture.wrapT = THREE.RepeatWrapping;
            }

            // Slowly rotate shafts for dynamic feel
            if (this.mesh) this.mesh.rotation.y += dt * 0.02;
            if (this.coreMesh) this.coreMesh.rotation.y -= dt * 0.03;
        }
    }

    window.flux.LightShafts = LightShafts;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

// Reusable Glow for Lights
    const _glowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(0.4, 'rgba(0, 170, 255, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    const _glowMaterial = new THREE.SpriteMaterial({ 
        map: _glowTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class Stadium {
        constructor(scene) {
            this.scene = scene;
            this.container = new THREE.Group();
            this.scene.add(this.container);

            // Config for "Herculean" scale
// Config for "Herculean" scale
            this.config = {
                radius: 60,       // Start outside the arena (48 radius)
                tiers: 6,         // Number of seating rings
                tierHeight: 12,
                tierDepth: 15,
crowdCount: 300, // Optimized density (was 1500)
                structureColor: 0x080c10, // Deep dark blue/black
                lightColor: 0x00aaff
            };

this.rings = [];
            this.materials = {}; // Store materials for theming
            this.lightSprites = []; // Store light sprites for cinematic control
            this.lightSprites = []; // Store light sprites for cinematic control
this.crowd = null;

            this._buildArchitecture();
            this._buildCrowd();
            this._buildHerculeanRings();
            this._buildStadiumLights();
            this._buildGoalBarriers();
        }

        _buildArchitecture() {
            // 1. The Void Bowl (Background Occluder)
            // Massive cylinder to block the void
            const bowlGeo = new THREE.CylinderGeometry(180, 50, 120, 32, 1, true);
const bowlMat = new THREE.MeshBasicMaterial({ 
                color: this.config.structureColor, 
                side: THREE.BackSide,
                fog: true 
            });
            this.materials.bowl = bowlMat;
            const bowl = new THREE.Mesh(bowlGeo, bowlMat);
            bowl.position.y = 20;
            this.container.add(bowl);

            // 2. Seating Tiers (Concentric Rings)
const tierMat = new THREE.MeshBasicMaterial({ color: 0x111a22, side: THREE.DoubleSide });
            const rimMat = new THREE.MeshBasicMaterial({ color: 0x004466 });
            this.materials.tier = tierMat;
            this.materials.rim = rimMat;

            for(let i=0; i<this.config.tiers; i++) {
                const y = (i * this.config.tierHeight) - 30;
                const rInner = this.config.radius + (i * (this.config.tierDepth * 0.8));
                const rOuter = rInner + this.config.tierDepth;
                
                // Floor Ring
                const ringGeo = new THREE.RingGeometry(rInner, rOuter, 64);
                ringGeo.rotateX(-Math.PI / 2);
                const mesh = new THREE.Mesh(ringGeo, tierMat);
                mesh.position.y = y;
                this.container.add(mesh);
                
                // Glowing Rim (The "Tech" feel)
                const rimGeo = new THREE.TorusGeometry(rInner, 0.8, 4, 64);
                rimGeo.rotateX(Math.PI / 2);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.position.y = y;
                this.container.add(rim);
            }

            // 3. Massive Pillars (The "Herculean" Support)
            const pillarGeo = new THREE.BoxGeometry(8, 200, 8);
const pillarMat = new THREE.MeshBasicMaterial({ color: 0x050505 });
            this.materials.pillar = pillarMat;
            
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 140; // Far out
                const mesh = new THREE.Mesh(pillarGeo, pillarMat);
                mesh.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                mesh.lookAt(0,0,0);
                this.container.add(mesh);
            }
        }

_buildCrowd() {
            // Instanced Mesh for Crowd (Low Poly, High Count)
            // Using a simple vertical plane that faces center
            const geo = new THREE.PlaneGeometry(1.2, 2.5);
            
            // --- CROWD SHADER IMPLEMENTATION ---
            // Add instance-specific random offset for animation variation
            const offsets = new Float32Array(this.config.crowdCount);
            for(let i=0; i<this.config.crowdCount; i++) {
                offsets[i] = Math.random();
            }
            geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(offsets, 1));

            // Custom Shader via onBeforeCompile
            const mat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide });
            
            mat.onBeforeCompile = (shader) => {
                shader.uniforms.uTime = { value: 0 };
                this.crowdUniforms = shader.uniforms;

                shader.vertexShader = `
                    uniform float uTime;
                    attribute float aOffset;
                    varying float vJump; // Pass to fragment for color variation
                ` + shader.vertexShader;

                shader.vertexShader = shader.vertexShader.replace(
                    '#include <begin_vertex>',
                    `
                    #include <begin_vertex>
                    
                    // Animation Logic
                    float speed = 8.0;
                    float t = uTime * speed + (aOffset * 100.0);
                    
                    // Jump (Sine wave clipped)
                    float jump = max(0.0, sin(t));
                    jump = pow(jump, 2.0); // Sharpen the jump curve
                    
                    // Randomize jump height slightly
                    float height = 0.5 + 0.5 * aOffset;
                    
                    transformed.y += jump * height;
                    
                    // Sway (Side to side)
                    transformed.x += cos(t * 0.5) * 0.1;
                    
                    vJump = jump;
                    `
                );

                shader.fragmentShader = `
                    varying float vJump;
                ` + shader.fragmentShader;

                shader.fragmentShader = shader.fragmentShader.replace(
                    'vec4 diffuseColor = vec4( diffuse, opacity );',
                    `
                    vec4 diffuseColor = vec4( diffuse, opacity );
                    
                    // Brighten when jumping (Cheering effect)
                    diffuseColor.rgb += vec3(0.2) * vJump;
                    `
                );
            };
            
this.crowd = new THREE.InstancedMesh(geo, mat, this.config.crowdCount);
            this.crowd.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            
            // Optimization: Enable culling and manually set bounding sphere to cover the whole stadium
            // This prevents GPU from processing 2500 instances when the entire structure is out of view
            this.crowd.frustumCulled = true;
            this.crowd.geometry.boundingSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), 150);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
// 1. Calculate Total Circumference for distribution to ensure all tiers get people
            let totalCirc = 0;
            const tierRadii = [];
            for(let t=0; t<this.config.tiers; t++) {
                const rMin = this.config.radius + (t * (this.config.tierDepth * 0.8)) + 2;
                const circ = 2 * Math.PI * rMin;
                totalCirc += circ;
                tierRadii.push({ rMin: rMin, circ: circ });
            }

            let idx = 0;
            for(let t=0; t<this.config.tiers; t++) {
                const yBase = (t * this.config.tierHeight) - 30;
                const { rMin, circ } = tierRadii[t];
                const rMax = rMin + this.config.tierDepth - 2;
                
                // Distribute proportionally so upper rows don't get cut off
                const countPerTier = Math.floor(this.config.crowdCount * (circ / totalCirc));
                
                for(let i=0; i<countPerTier; i++) {
                    if (idx >= this.config.crowdCount) break;

                    const angle = Math.random() * Math.PI * 2;
                    const r = rMin + Math.random() * (rMax - rMin);
                    
                    dummy.position.set(
                        Math.cos(angle) * r,
                        yBase + 1.25, // Center of quad
                        Math.sin(angle) * r
                    );
                    
                    // Face center
                    dummy.lookAt(0, yBase, 0);
                    dummy.updateMatrix();
                    
                    this.crowd.setMatrixAt(idx, dummy.matrix);
                    
                    // Random Team Colors (Simulating fans)
                    const rand = Math.random();
                    if (rand < 0.45) color.setHex(0x0088ff); // Home Blue
                    else if (rand < 0.9) color.setHex(0xff4444); // Away Red
                    else color.setHex(0xffffff); // Neutral/Flash
                    
                    // Vary brightness for depth
                    color.multiplyScalar(0.5 + Math.random() * 0.5);
                    
                    this.crowd.setColorAt(idx, color);
                    idx++;
                }
            }
            
            this.container.add(this.crowd);
        }

        _buildHerculeanRings() {
            // Massive floating rings that rotate slowly
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x445566, 
                transparent: true, 
                opacity: 0.3,
                wireframe: true // Tech/Holographic feel
            });

            // 1. Equatorial Ring (Massive)
            const geo1 = new THREE.TorusGeometry(110, 1, 16, 100);
            const ring1 = new THREE.Mesh(geo1, mat);
            ring1.rotation.x = Math.PI / 2;
            this.container.add(ring1);
            this.rings.push({ mesh: ring1, axis: 'z', speed: 0.01 });

            // 2. Tilted Ring
            const geo2 = new THREE.TorusGeometry(130, 2, 16, 100);
            const ring2 = new THREE.Mesh(geo2, mat);
            ring2.rotation.x = Math.PI / 3;
            this.container.add(ring2);
            this.rings.push({ mesh: ring2, axis: 'y', speed: -0.008 });
            
            // 3. Vertical Ring
            const geo3 = new THREE.TorusGeometry(150, 3, 16, 100);
const ring3 = new THREE.Mesh(geo3, mat);
            this.container.add(ring3);
            this.rings.push({ mesh: ring3, axis: 'y', speed: 0.005 });
        }

        _buildStadiumLights() {
            const count = 16; // Number of lights around the equator
            const radius = 36; // Just outside the arena boundary (32)
            const yPos = 0; // Middle of the sphere
            
            const lightGeo = new THREE.SphereGeometry(0.4, 8, 8);
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

            for(let i=0; i<count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // 1. Physical Fixture (The bulb)
                const mesh = new THREE.Mesh(lightGeo, lightMat);
                mesh.position.set(x, yPos, z);
                this.container.add(mesh);

                // 2. Visual Glow (Flare)
                const sprite = new THREE.Sprite(_glowMaterial);
// 2. Visual Glow (Flare)
// 2. Visual Glow (Flare)
                sprite.position.set(x, yPos, z);
                sprite.scale.set(8, 8, 1); // Large glow
                this.container.add(sprite);
                this.lightSprites.push(sprite);

// 3. Actual Point Light - REMOVED for optimization
                // Since we use MeshBasicMaterial (Unlit), real lights waste CPU/GPU resources.
                // The sprite glow above provides the visual effect.
            }
}

        _buildGoalBarriers() {
            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            
            // Geometry: Inverted Triangle (Matches Goal Hitbox)
            // Top Y: 12.0, Bottom Y: -6.0. Width at top: 28.0 (+/- 14.0).
            const geometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
-14.0, 2.0, 0.0, // Top Left
                 14.0, 2.0, 0.0, // Top Right
                  0.0, -18.0, 0.0  // Bottom Center
            ]);
            
            // UVs for shader effects
            const uvs = new Float32Array([
                0.0, 1.0,
                1.0, 1.0,
                0.5, 0.0
            ]);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
            geometry.computeVertexNormals();

            // Forcefield Shader
// Forcefield Shader
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uColor: { value: new THREE.Color(0x44aaff) }, // Cyan/Blue Energy
                    uOpacity: { value: 0.0 } // Invisible by default
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vPos;
                    void main() {
                        vUv = uv;
                        vPos = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uTime;
                    uniform vec3 uColor;
                    uniform float uOpacity;
                    varying vec2 vUv;

                    void main() {
                        // Hex Pattern Logic
                        vec2 uv = vUv * 15.0; // Density
                        uv.y += uTime * 0.5; // Scroll down
                        
                        // Simplex-like grid for hex approximation
                        vec2 r = vec2(1.0, 1.73);
                        vec2 h = r * 0.5;
                        vec2 a = mod(uv, r) - h;
                        vec2 b = mod(uv - h, r) - h;
                        vec2 g = dot(a, a) < dot(b, b) ? a : b;
                        float dist = length(g);
                        
                        // Thin lines
                        float hex = smoothstep(0.45, 0.48, dist); 
                        
                        // Scanline
                        float scan = sin(vUv.y * 30.0 - uTime * 2.0) * 0.5 + 0.5;
                        
                        // Edge Glow (Fresnel-ish)
                        float edge = pow(abs(vUv.x - 0.5) * 2.0, 3.0);
                        
                        // Compose Pattern
                        float pattern = (1.0 - hex) * 0.5; // Stronger grid
                        pattern += scan * 0.2;             // Stronger scanline
                        pattern += edge * 0.6;             // Stronger edge
                        
                        // Master Opacity Control (0 = Invisible, 1 = Visible)
                        // Base fill 0.1 + pattern, scaled by uOpacity
                        float alpha = (0.1 + pattern) * uOpacity;

                        // Tint
                        gl_FragColor = vec4(uColor, alpha);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            // Barrier A (Away Goal / -Z)
            this.barrierA = new THREE.Mesh(geometry, material.clone());
            this.barrierA.position.set(0, 0, -goalDist);
            this.container.add(this.barrierA);

            // Barrier B (Home Goal / +Z)
            this.barrierB = new THREE.Mesh(geometry, material.clone());
            this.barrierB.position.set(0, 0, goalDist);
            this.barrierB.rotation.y = Math.PI; // Face inward
            this.container.add(this.barrierB);
            
            this.barriers = [this.barrierA, this.barrierB];
        }

update(dt) {
            // Animate Rings
            this.rings.forEach(r => {
                if (r.mesh && r.axis) {
                    r.mesh.rotation[r.axis] += r.speed * dt;
                }
            });

            // Update Crowd Shader
            if (this.crowdUniforms) {
                this.crowdUniforms.uTime.value += dt;
            }

            // Update Light Pops (Cinematic)
this.lightSprites.forEach(s => {
                if (s.visible && s.scale.x > 8.0) {
                    // Decay pop effect
                    s.scale.x -= dt * 30.0;
                    s.scale.y -= dt * 30.0;
                    if (s.scale.x < 8.0) s.scale.set(8, 8, 1);
                }
            });

            // Update Barrier Uniforms
            if (this.barriers) {
                this.barriers.forEach(b => {
                    if (b.material.uniforms) {
                        b.material.uniforms.uTime.value += dt;
                    }
                });
            }
}

setAllLights(visible) {
            this.lightSprites.forEach(s => {
                s.visible = visible;
                s.scale.set(8, 8, 1); // Reset scale
            });
        }

        get lightCount() {
            return this.lightSprites.length;
        }

        resetLights() {
            this.setAllLights(false);
        }

        turnOnLight(index) {

            if (this.lightSprites[index]) {
                const s = this.lightSprites[index];
                s.visible = true;
                s.material.opacity = 1.0;
                s.scale.set(20, 20, 1); // Pop effect
            }
        }
turnOnLight(index) {
            if (this.lightSprites[index]) {
                const s = this.lightSprites[index];
                s.visible = true;
                s.material.opacity = 1.0;
                s.scale.set(20, 20, 1); // Pop effect
            }
        }

        setTheme(visuals) {
            if (this.materials.bowl) this.materials.bowl.color.setHex(visuals.structureColor);
            if (this.materials.tier) this.materials.tier.color.setHex(visuals.structureColor);
            if (this.materials.pillar) this.materials.pillar.color.setHex(visuals.structureColor);
            
            // 2. Rim/Accent Colors
            if (this.materials.rim) this.materials.rim.color.setHex(visuals.rimColor);

            // 3. Lights (Global Sprite Material)
            if (visuals.lightColor !== undefined) {
                _glowMaterial.color.setHex(visuals.lightColor);
            }

            // 4. Barriers (Forcefields)
            if (this.barriers) {
                this.barriers.forEach(b => {
                    if (b.material && b.material.uniforms && b.material.uniforms.uColor) {
                        b.material.uniforms.uColor.value.setHex(visuals.lightColor);
                    }
                });
            }
            
            // 5. Rings (Herculean)
            // Access the material from the first ring (they share it)
            if (this.rings.length > 0 && this.rings[0].mesh && this.rings[0].mesh.material) {
                this.rings[0].mesh.material.color.setHex(visuals.rimColor);
            }
        }

        updateTheme(visuals) {
            this.setTheme(visuals);
        }
    }

    window.flux.Stadium = Stadium;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    const THEMES = {
        'STANDARD': {
            name: 'BESAID SPHERE POOL',
            visuals: {
                bgColor: 0x001e36,
                fogColor: 0x001e36,
                fogDensity: 0.0001,
                structureColor: 0x080c10,
                rimColor: 0x004466,
                lightColor: 0x00aaff
            },
            physics: {
                waterDrag: 0.15,
                depthSpring: 1.0
            },
            hazards: []
        },
        'DEEP_SEA': {
            name: 'BAAJ RUINS',
            visuals: {
                bgColor: 0x000510,
                fogColor: 0x000510,
                fogDensity: 0.025,
                structureColor: 0x020508,
                rimColor: 0x002233,
                lightColor: 0x00ffaa
            },
            physics: {
                waterDrag: 0.25,
                depthSpring: 0.5
            },
            hazards: [
                { type: 'current', force: new THREE.Vector3(8, 0, 0), frequency: 0.5 }
            ]
        },
        'VOLCANIC': {
            name: 'KILIKA TEMPLE',
            visuals: {
                bgColor: 0x220500,
                fogColor: 0x220500,
                fogDensity: 0.015,
                structureColor: 0x1a0500,
                rimColor: 0x441100,
                lightColor: 0xff4400
            },
            physics: {
                waterDrag: 0.1,
                depthSpring: 1.2
            },
            hazards: [
                { type: 'vent', position: new THREE.Vector3(0, -15, 0), radius: 15, force: 40.0 }
            ]
        },
        'CELESTIAL': {
            name: 'MACALANIA WOODS',
            visuals: {
                bgColor: 0x100020,
                fogColor: 0x100020,
                fogDensity: 0.01,
                structureColor: 0x100020,
                rimColor: 0x440088,
                lightColor: 0xff00ff
            },
            physics: {
                waterDrag: 0.05,
                depthSpring: 0.2
            },
            hazards: []
        }
    };

    class ArenaThemeManager {
        constructor(scene, gameManager) {
            this.scene = scene;
            this.game = gameManager;
            this.currentTheme = 'STANDARD';
            this.activeHazards = [];
            this.hazardTimer = 0;
        }

        setTheme(themeKey) {
            if (!THEMES[themeKey]) return;
            this.currentTheme = themeKey;
            const theme = THEMES[themeKey];

            console.log(`Setting Arena Theme: ${theme.name}`);

            // 1. Visuals
            if (this.scene) {
                this.scene.background = new THREE.Color(theme.visuals.bgColor);
                if (this.scene.fog) {
                    this.scene.fog.color.setHex(theme.visuals.fogColor);
                    this.scene.fog.density = theme.visuals.fogDensity;
                }
            }

            if (this.game.stadium && this.game.stadium.updateTheme) {
                this.game.stadium.updateTheme(theme.visuals);
            }

            // 2. Physics
            if (window.flux.BallConfig) {
                window.flux.BallConfig.WATER_DRAG_LINEAR = theme.physics.waterDrag;
                window.flux.BallConfig.DEPTH_SPRING = theme.physics.depthSpring;
            }

            // 3. Hazards
            this.activeHazards = theme.hazards || [];
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(theme.name, 'normal');
            }
        }

        update(dt) {

            const ball = this.game.entities.ball;
            if (!ball || !ball.mesh || ball.state !== 'free') {
                // Clear forces if ball is held or invalid
                if (ball && ball.setExternalForce) ball.setExternalForce(new THREE.Vector3(0,0,0));
                return;
            }

            const totalForce = new THREE.Vector3();

            this.activeHazards.forEach(h => {
                if (h.type === 'current') {
                    // Periodic push
                    const strength = Math.sin(this.hazardTimer * h.frequency) * 0.5 + 0.5; 
                    if (strength > 0.1) {
                        // Accumulate force (Acceleration)
                        totalForce.addScaledVector(h.force, strength);
                        
                        // Visuals for current (keep here for ambient effect around ball)
                         if (this.game.particleManager && Math.random() < 0.1) {
                            const offset = new THREE.Vector3((Math.random()-0.5)*20, (Math.random()-0.5)*10, (Math.random()-0.5)*20);
                            this.game.particleManager.spawn('bubble', ball.mesh.position.clone().add(offset), { 
                                scale: 0.5, 
                                emitterVelocity: h.force.clone().multiplyScalar(2.0) 
                            });
                        }
                    }
                } else if (h.type === 'vent') {
                    const dist = ball.mesh.position.distanceTo(h.position);
                    if (dist < h.radius) {
                        // Apply Upward Force
                        totalForce.y += h.force;
                        
                        if (this.game.particleManager && Math.random() < 0.3) {
                            this.game.particleManager.spawn('bubble', ball.mesh.position, { scale: 0.5, color: 0xff4400 });
                        }
                    }
                }
            });

            // Apply calculated environmental forces to the ball
            ball.setExternalForce(totalForce);
        }
    }

    window.flux.ArenaThemeManager = ArenaThemeManager;
    window.flux.THEMES = THEMES;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class PostProcessing {
        constructor(renderer, width, height) {
            this.renderer = renderer;
            this.enabled = true;

            // Render Target for the scene (Internal Resolution)
            this.renderTarget = new THREE.WebGLRenderTarget(width, height, {
                minFilter: THREE.NearestFilter,
                magFilter: THREE.NearestFilter,
                format: THREE.RGBAFormat,
                depthBuffer: true,
                stencilBuffer: false
            });

            // FSQ Setup
            this.orthoCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            this.scene = new THREE.Scene();

            // Shader
            this.uniforms = {
                tDiffuse: { value: null },
                uTime: { value: 0 },
                uResolution: { value: new THREE.Vector2(width, height) },
                // Retro Settings
uScanlineIntensity: { value: 0.0 }, // Disabled by default
                uScanlineCount: { value: height * 0.5 }, // Half resolution scanlines
                uVignette: { value: 0.6 },
                uNoise: { value: 0.04 },
                uAberration: { value: 1.5 }, // Pixel offset amount
                uContrast: { value: 1.1 },
                uSaturation: { value: 1.1 }
            };

            const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform sampler2D tDiffuse;
                uniform float uTime;
                uniform vec2 uResolution;
                uniform float uScanlineIntensity;
                uniform float uScanlineCount;
                uniform float uVignette;
                uniform float uNoise;
                uniform float uAberration;
                uniform float uContrast;
                uniform float uSaturation;

                varying vec2 vUv;

float random(vec2 p) {
                    return fract(sin(dot(p.xy, vec2(12.9898, 78.233))) * 43758.5453);
                }

                // 4x4 Bayer Matrix for Ordered Dithering
                float bayer4x4(vec2 uv) {
                    float x = floor(mod(uv.x, 4.0));
                    float y = floor(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0.0) { if (x == 0.0) v = 0.0; else if (x == 1.0) v = 8.0; else if (x == 2.0) v = 2.0; else v = 10.0; }
                    else if (y == 1.0) { if (x == 0.0) v = 12.0; else if (x == 1.0) v = 4.0; else if (x == 2.0) v = 14.0; else v = 6.0; }
                    else if (y == 2.0) { if (x == 0.0) v = 3.0; else if (x == 1.0) v = 11.0; else if (x == 2.0) v = 1.0; else v = 9.0; }
                    else { if (x == 0.0) v = 15.0; else if (x == 1.0) v = 7.0; else if (x == 2.0) v = 13.0; else v = 5.0; }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    
                    // Chromatic Aberration
                    vec2 dist = uv - 0.5;
                    // Offset based on distance from center
                    vec2 offset = dist * (uAberration / uResolution);
                    
                    float r = texture2D(tDiffuse, uv - offset).r;
                    float g = texture2D(tDiffuse, uv).g;
                    float b = texture2D(tDiffuse, uv + offset).b;
                    vec3 color = vec3(r, g, b);

                    // Saturation
                    float gray = dot(color, vec3(0.299, 0.587, 0.114));
                    color = mix(vec3(gray), color, uSaturation);

                    // Contrast
                    color = (color - 0.5) * uContrast + 0.5;

// Scanlines (DISABLED)
                    // float scan = sin(uv.y * uScanlineCount * 6.28 + uTime * 2.0);
                    // color -= (scan * 0.5 + 0.5) * uScanlineIntensity;

                    // Dithering (Increased)
                    float dither = bayer4x4(gl_FragCoord.xy);
                    float colorDepth = 32.0; // 5-bit color simulation
                    vec3 dithered = color + (dither - 0.5) * (1.5 / colorDepth); // 1.5x strength
                    color = floor(dithered * colorDepth) / colorDepth;

                    // Noise
                    float n = random(uv + mod(uTime, 1.0));
                    color += (n - 0.5) * uNoise;

                    // Vignette
                    float d = dot(dist, dist);
                    color *= (1.0 - d * uVignette);

                    gl_FragColor = vec4(color, 1.0);
                }
            `;

            this.material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                depthWrite: false,
                depthTest: false
            });

            this.quad = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), this.material);
            this.scene.add(this.quad);
        }

        setSize(width, height) {
            this.renderTarget.setSize(width, height);
            this.uniforms.uResolution.value.set(width, height);
            this.uniforms.uScanlineCount.value = height * 0.5;
        }

        render(scene, camera, dt) {
            if (!this.enabled) {
                this.renderer.render(scene, camera);
                return;
            }

            this.uniforms.uTime.value += dt;

            // Pass 1: Scene -> Target
            this.renderer.setRenderTarget(this.renderTarget);
            this.renderer.clear();
            this.renderer.render(scene, camera);

            // Pass 2: Target -> Screen
            this.renderer.setRenderTarget(null);
            this.uniforms.tDiffuse.value = this.renderTarget.texture;
            this.renderer.render(this.scene, this.orthoCamera);
        }
    }

    window.flux.PostProcessing = PostProcessing;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class AudioManager {
        constructor() {
            // --- BGM SYSTEM (HTML5 Audio for streaming) ---
            this.bgm = new Audio();
this.bgm.src = 'https://dl.dropboxusercontent.com/scl/fi/l0phl1lftd8a4v6uvtjkd/ffx-Soundtrack_-blitz-off-blitzball-theme-1-Cover-2.mp3?rlkey=jyn9qh28m4cxecuh2qqm97aul&raw=1';
            this.bgm.loop = true;
            this.bgm.volume = 0.5;
            
            // --- SFX SYSTEM (Web Audio API for precision & variance) ---
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            
            this.sfxBuffers = new Map();
            
            // Master Gain for SFX
            this.sfxGain = this.ctx.createGain();
            this.sfxGain.connect(this.ctx.destination);
            this.sfxGain.gain.value = 0.5;

            // Volume State
            this.masterVolume = 0.8;
            this.bgmLevel = 1.0;
            this.sfxLevel = 1.0;
            this.isMuted = false;
            this.shouldBePlaying = false;

            // Dynamic State (Pitch/Volume modulation)
            this.currentRate = 1.0;
            this.currentDynamicVol = 1.0;
            this.matchTension = 0;
            this.isOvertime = false;

            // --- SFX DICTIONARY (Public Domain / CC0) ---
this.sfxLibrary = {
                'whistle': 'https://dl.dropboxusercontent.com/scl/fi/sc25aar8qmf3bl0aojcnq/Whistle_Var-1.mp3?rlkey=13agb2qy00r676eglyv8p76r2&raw=1',
                'whistle2': 'https://dl.dropboxusercontent.com/scl/fi/z5o7zkh01v492biwh8u35/Whistle_Var-3.mp3?rlkey=ljofgblhs10t5iecpzffnxkc5&raw=1',
                
                'swim': 'https://dl.dropboxusercontent.com/scl/fi/j045jhlb27r5clpbrevlg/watermovement_quick1.mp3?rlkey=o3wio0jazesots3o13254wbjj&raw=1',
                'swim2': 'https://dl.dropboxusercontent.com/scl/fi/d9idmwkwbkluo88sqnjoq/watermovement_quick2.mp3?rlkey=84y9mhwfnax4la5fxqa6g6wxs&raw=1',
                'swim3': 'https://dl.dropboxusercontent.com/scl/fi/4qds2b55lu8bqu0yhtd9u/watermovement_quick3.mp3?rlkey=g881wuw5bt0w5ckfwyk15hspi&raw=1',
                'swim4': 'https://dl.dropboxusercontent.com/scl/fi/uyc0vfgs8ohbpmqp2u1yv/Swim_Var-3.mp3?rlkey=83t5jlrglvvr5ut144wrg326c&raw=1',
                'swim5': 'https://dl.dropboxusercontent.com/scl/fi/jgs8mofh26prxzm70qyiq/Swim_Var-2.mp3?rlkey=xkdqc2sci0c4qb3achu9xc8fu&raw=1',

                'dash': 'https://dl.dropboxusercontent.com/scl/fi/4im0zcvqavkxfh6jexvya/waterdash.mp3?rlkey=n7xx1tqmd8r7siaym4tuay76f&raw=1',
                'dash2': 'https://dl.dropboxusercontent.com/scl/fi/0ixqmogmu9aoqb4ztuni9/Dash_Var-3.mp3?rlkey=0ff66mh4j5annxvtv75wbymbs&raw=1',
                'dash3': 'https://dl.dropboxusercontent.com/scl/fi/g36sexsqdfgajbyzwgsmx/Dash_Var-2.mp3?rlkey=tk0ti5fh7fwrrpu9lwk1k1pnl&raw=1',

                'impact': 'https://dl.dropboxusercontent.com/scl/fi/d047erjo6ppp216sc6dh9/water_impact.mp3?rlkey=kudcenkbindxqlzxm1pxvdapb&raw=1',
                'impact2': 'https://dl.dropboxusercontent.com/scl/fi/0zucm4w1sb39593sjo4jn/Impact_Var-3.mp3?rlkey=rknhnj142xqwxjk20jfnh45u9&raw=1',
                'impact_heavy': 'https://dl.dropboxusercontent.com/scl/fi/i9sfghxu7fvo4sk36cpay/Impact_Mixed-Layer.mp3?rlkey=q6hw00ujmbwo00ibsbpyalhha&raw=1',

                'throw': 'https://dl.dropboxusercontent.com/scl/fi/kofasr3j0rh8d9nul3gu9/throw.mp3?rlkey=npku1azjedqkmdr6739gdotgl&raw=1',
                'throw2': 'https://dl.dropboxusercontent.com/scl/fi/z6oiuiuje7k6p24txjgbv/Throw_Var-2.mp3?rlkey=u1j1zach6iv7ceqs0lv4r0a98&raw=1',

                'tackle': 'https://dl.dropboxusercontent.com/scl/fi/yzemr4w3wk9by4d88dm3c/Tackle_Var-2.mp3?rlkey=n4dx0cpafjeue9317sa6gmr3i&raw=1',
                'tackle2': 'https://dl.dropboxusercontent.com/scl/fi/uir47jhyz7gmpfvl2jl78/Tackle_Var-3.mp3?rlkey=al7c26taf9w5usutwvd53vba9&raw=1',

                'catch': 'https://dl.dropboxusercontent.com/scl/fi/shc3igm4dad33lnbvqlxt/catch.mp3?rlkey=6ydnaxk89nf7kenn56yuunlul&raw=1',
                'catch_jump': 'https://dl.dropboxusercontent.com/scl/fi/y6cytgf5umcvuxx63y9qp/Catch_Jump_Var-1.mp3?rlkey=cpxij32fam1k3yvg0glownoij&raw=1',

                'goal': 'https://dl.dropboxusercontent.com/scl/fi/56xf3y3lei582uj0pfpie/Goal_Var-3.mp3?rlkey=67ty3tynrcj1om3j012ixbhqt&raw=1',
                
                'charge': 'https://dl.dropboxusercontent.com/scl/fi/hiy85h60ilxv7h9emjjlx/Charge_Var-3.mp3?rlkey=vwfvrcwm4vvk0zgddvvq2w4cw&raw=1',
                
                'menu': 'https://dl.dropboxusercontent.com/scl/fi/khgv4y9crr9u96ifjmjld/Menu_Manager.Js_Var-1.mp3?rlkey=axxdy40mwsu1cwlpww0ctk101&raw=1',
                
                'react': 'https://dl.dropboxusercontent.com/scl/fi/lllmx1ftizrgo5d4dmj64/React_Var-2.mp3?rlkey=wd8wbv9wpvdsd3nq80xyhuutq&raw=1',
                
                'tech': 'https://dl.dropboxusercontent.com/scl/fi/83j7fx06pl1x89m0f2u2p/Glyph_Manager.Js_Var-3.mp3?rlkey=zepy9zfsgxsbvw2ip5n9pt8ms&raw=1',
                
                'ambient': 'https://dl.dropboxusercontent.com/scl/fi/v5ie2xkrsfxltmzqjoha1/Stadium.Js_Var-1.mp3?rlkey=wa2oi28pzmlqyh8fzv47jyjz6&raw=1',
                
                'ui_generic': 'https://dl.dropboxusercontent.com/scl/fi/cfhehqti7v3vpnf0qrrrf/Game_Manager.Js_Var-2.mp3?rlkey=02892l0bioefptg8m01tvzick&raw=1',
                
                'bubble': 'https://dl.dropboxusercontent.com/scl/fi/t8ytdtdokn9i6cdcc2x41/Idle_Var-2.mp3?rlkey=q6pedr0bpxw2cum4mqtrrm56z&raw=1'
            };

            this._preloadSFX();
            this._updateVolumes();
            this._initWatchdogs();
        }

        _initWatchdogs() {
            // BGM Loop & Resume Logic
            this.bgm.addEventListener('ended', () => {
                if (this.shouldBePlaying && !this.isMuted) {
                    this.bgm.currentTime = 0;
                    this.bgm.play().catch(e => console.warn("BGM Replay fail:", e));
                }
            });

            // Robust Unlock Strategy for Mobile (iOS/Android)
            const unlock = () => {
                if (this.ctx.state !== 'running') {
                    this.ctx.resume().then(() => {}).catch(e => console.warn("AudioContext Resume fail:", e));
                }
                try {
                    const buffer = this.ctx.createBuffer(1, 1, 22050);
                    const source = this.ctx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(this.ctx.destination);
                    source.start(0);
                } catch (e) {}

                if (this.shouldBePlaying && this.bgm.paused && !this.isMuted) {
                    this.bgm.play().catch(e => {});
                }

                ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                    document.removeEventListener(evt, unlock, true);
                });
            };

            const opts = { capture: true, passive: true };
            ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                document.addEventListener(evt, unlock, opts);
            });
        }

        _preloadSFX() {
            for (const [id, url] of Object.entries(this.sfxLibrary)) {
                this.loadSFX(id, url);
            }
        }

        async loadSFX(id, url) {

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);
                this.sfxBuffers.set(id, audioBuffer);
                console.log(`AudioManager: Loaded SFX '${id}'`);
            } catch (e) {
                console.warn(`AudioManager: Failed to load SFX '${id}' from ${url}. Using fallback.`, e);
            }
        }

playSFX(id, options = {}) {
            if (this.isMuted) return;
            if (this.ctx.state === 'suspended') this.ctx.resume().catch(() => {});

            // --- SPECIAL HANDLING ---
            
            // 1. Whistle: Lower volume & Layering
            if (id === 'whistle') {
                const vol = (options.volume || 1.0) * 0.2; // Way down
                
                // Layer 1: Main
                this._resolveAndPlay('whistle', { ...options, volume: vol });
                
                // Layer 2: Echo/Stadium Reverb (Slightly delayed, lower pitch)
                setTimeout(() => {
                    this._resolveAndPlay('whistle', { 
                        ...options, 
                        volume: vol * 0.6, 
                        rate: (options.rate || 1.0) * 0.95 
                    });
                }, 80);
                return;
            }

            // 2. Dash: Boost Volume (User reported not hearing it)
            if (id === 'dash') {
                // Clone options to avoid mutating original reference if reused
                options = { ...options, volume: (options.volume || 1.0) * 2.5 };
            }

            this._resolveAndPlay(id, options);
        }

        _resolveAndPlay(id, options) {
            let targetId = id;
            
            // Randomization Logic
            if (id === 'swim') {
                const vars = ['swim', 'swim2', 'swim3', 'swim4', 'swim5'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            } else if (id === 'dash') {
                const vars = ['dash', 'dash2', 'dash3'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            } else if (id === 'impact') {
                const vars = ['impact', 'impact2'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            } else if (id === 'throw') {
                const vars = ['throw', 'throw2'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            } else if (id === 'tackle') {
                const vars = ['tackle', 'tackle2'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            } else if (id === 'whistle') {
                const vars = ['whistle', 'whistle2'];
                targetId = vars[Math.floor(Math.random() * vars.length)];
            }

            this._playRaw(targetId, options);
        }

        _playRaw(id, options) {
            const buffer = this.sfxBuffers.get(id);
            
            // --- FALLBACK SYNTHESIS ---
            if (!buffer) {
                this._playSynthFallback(id, options);
                return;
            }

            const source = this.ctx.createBufferSource();
            source.buffer = buffer;

            const variance = options.variance !== undefined ? options.variance : 0.1;
            let rate = options.rate !== undefined ? options.rate : 1.0;

            if (variance > 0) {
                rate += (Math.random() * variance * 2 - variance);
            }
            source.playbackRate.value = Math.max(0.1, Math.min(4.0, rate));

            const gainNode = this.ctx.createGain();
            const vol = options.volume !== undefined ? options.volume : 1.0;
            gainNode.gain.value = vol;

            source.connect(gainNode);
            gainNode.connect(this.sfxGain);

            source.start(0);
        }

        _playSynthFallback(id, options) {
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.connect(gain);
            gain.connect(this.sfxGain);
            
            const vol = options.volume !== undefined ? options.volume : 0.5;
            
            if (id === 'menu') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, t);
                osc.frequency.exponentialRampToValueAtTime(400, t + 0.1);
                gain.gain.setValueAtTime(vol, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t);
                osc.stop(t + 0.1);
            } else if (id === 'throw' || id === 'dash') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, t);
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.3);
                gain.gain.setValueAtTime(vol, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                osc.start(t);
                osc.stop(t + 0.3);
            } else if (id === 'impact' || id === 'tackle' || id === 'catch') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.exponentialRampToValueAtTime(10, t + 0.2);
                gain.gain.setValueAtTime(vol, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                osc.start(t);
                osc.stop(t + 0.2);
            } else if (id === 'charge') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, t);
                osc.frequency.linearRampToValueAtTime(400, t + 0.5);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(vol * 0.5, t + 0.1);
                gain.gain.linearRampToValueAtTime(0, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.5);
            } else {
                // Generic blip
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, t);
                gain.gain.setValueAtTime(vol, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t);
                osc.stop(t + 0.1);
            }
        }

        playBGM() {
            if (this.isMuted) return;
            this.shouldBePlaying = true;
            this.bgm.play().catch(e => console.log("BGM Autoplay prevented, waiting for interaction."));
        }

        stopBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }

        pauseBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
        }

        resumeBGM() {
            if (!this.isMuted && this.shouldBePlaying) {
                this.bgm.play().catch(e => {});
            }
        }

        setMasterVolume(volume) {
            this.masterVolume = Math.max(0, Math.min(1, volume));
            this._updateVolumes();
        }

        setBGMLevel(level) {
            this.bgmLevel = Math.max(0, level);
            this._updateVolumes();
        }

        setSFXLevel(level) {
            this.sfxLevel = Math.max(0, level);
            this._updateVolumes();
        }

        _updateVolumes() {
            if (this.bgm) {
                this.bgm.volume = Math.min(1, this.masterVolume * this.bgmLevel);
            }
            if (this.sfxGain) {
                this.sfxGain.gain.value = this.masterVolume * this.sfxLevel;
            }
        }

        setMatchState(tension, isOvertime) {
            this.matchTension = tension;
            this.isOvertime = isOvertime;
        }

        update(dt) {
            if (!this.bgm || this.isMuted) return;

// User requested BGM to stay at 1x speed always
            // We keep volume modulation for tension, but remove rate modulation.
            
            let targetDynamicVol = 1.0;
            const t = Math.min(1.0, this.matchTension || 0);
            targetDynamicVol += t * 0.3; // Louder when tense

            if (this.isOvertime) {
                targetDynamicVol += 0.1;
            }

            const lerpSpeed = Math.min(1.0, dt * 2.0);
            this.currentDynamicVol += (targetDynamicVol - this.currentDynamicVol) * lerpSpeed;

            // Force 1.0 rate
            if (this.bgm.playbackRate !== 1.0) {
                this.bgm.playbackRate = 1.0;
            }

            const baseVol = this.masterVolume * this.bgmLevel;
            const finalVol = Math.max(0, Math.min(1.0, baseVol * this.currentDynamicVol));
            
            if (Math.abs(this.bgm.volume - finalVol) > 0.001) {
                this.bgm.volume = finalVol;
            }
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            if (this.isMuted) {
                this.bgm.pause();
                this.ctx.suspend();
            } else {
                if (this.shouldBePlaying) this.bgm.play().catch(e=>{});
                this.ctx.resume();
            }
            return this.isMuted;
        }
    }

    window.flux.AudioManager = AudioManager;
})();</script>
    <script>(function() {
    // Namespace
    window.flux = window.flux || {};
    window.flux._runtimeUpdaters = window.flux._runtimeUpdaters || [];

    // Config
const _config = {
        internalWidth: 360,
        internalHeight: 640,
        bgColor: 0x001e36,
        fogColor: 0x001e36,
        fogDensity: 0.0001, // Drastically reduced to ensure visibility
        arenaRadius: 48.0
    };

    // Globals
// Globals
    const _input = { x: 0, y: 0 }; // Input state
    
    // Shader Uniforms
    const _arenaUniforms = {
        uTime: { value: 0 },
        uImpactPos: { value: new THREE.Vector3() },
        uImpactStr: { value: 0.0 }
    };
    const _particleUniforms = {
        uTime: { value: 0 }
    };

    // Expose Impact Trigger
// Expose Impact Trigger
    window.flux.triggerArenaImpact = function(pos, strength) {
        // Smoothly move impact center to new position (Liquid feel)
        _arenaUniforms.uImpactPos.value.lerp(pos, 0.3);
        // Sustain strength (Accumulate max to handle continuous pressure)
        _arenaUniforms.uImpactStr.value = Math.max(_arenaUniforms.uImpactStr.value, strength * 2.5);
    };

    const _tempVec1 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec2 = new THREE.Vector3(); // Reusable for physics/logic
    let _scene, _camera, _renderer, _clock;
    let _homeTeam, _awayTeam;
    let _ball;
    let _gameManager;
    let _menuManager;

    let _audioManager;
    let _postProcessing;

    let _cameraManager;
    let _waterOverlay;
    let _lightShafts;
    let _stadium;
let _glyphManager;
    let _arenaThemeManager; // Deprecated, now in GameManager
    // IMPROVED: Settings object
    const _settings = {
        joystickSensitivity: 1.0,
        aimAssist: true,
        cameraShake: true,
        hitStop: true,
        invertCamera: false,
        autoRecenter: true
    };

    // ---------------------------------------------------------------------
    // Debug IO Bridge (exposed for DevTools JSON snapshots)
    // ---------------------------------------------------------------------
    const _debugIO = window.flux._debugIO = window.flux._debugIO || {};
    _debugIO.settings = _settings;
    _debugIO.input = _debugIO.input || {};
    _debugIO.perf = _debugIO.perf || { frame: 0, rawDt: 0, dt: 0, fps: 0, avgFps: 0 };


    // ---------------------------------------------------------------------
    // Touch helpers (multi-touch safe)
    // ---------------------------------------------------------------------
    function _findTouchById(touchList, id) {
        if (id === null || id === undefined) return null;
        if (!touchList) return null;
        for (let i = 0; i < touchList.length; i++) {
            const t = touchList[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }

    function _endedTouchById(changedTouches, id) {
        if (id === null || id === undefined) return null;
        if (!changedTouches) return null;
        for (let i = 0; i < changedTouches.length; i++) {
            const t = changedTouches[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }


    function init() {
        _container = document.getElementById('game-container');

        // 1. Scene
        _scene = new THREE.Scene();
        _scene.background = new THREE.Color(_config.bgColor);
        _scene.fog = new THREE.FogExp2(_config.fogColor, _config.fogDensity);

        // 2. Camera
        const aspect = _config.internalWidth / _config.internalHeight;
_camera = new THREE.PerspectiveCamera(65, aspect, 0.1, 500);
_camera.position.set(0, 10, 15);
        _camera.lookAt(0, 0, 0);
        _scene.add(_camera); // Ensure camera is in scene for children to render

        // 3. Renderer
// 3. Renderer
        _renderer = new THREE.WebGLRenderer({
            antialias: false,
            powerPreference: "high-performance",
            precision: "mediump", // Mobile optimization: faster shaders
            stencil: false,       // Disable stencil buffer if not used
            depth: true
        });
        _renderer.setPixelRatio(1); // Force 1:1 pixel ratio, we handle scaling via setSize
        _renderer.autoClear = false; // We manage clearing via background or manual calls if needed (though scene.background handles color)
        // Expose renderer for DevTools
        if (_gameManager) _gameManager.renderer = _renderer; 
else window.flux.gameInstance = { renderer: _renderer, entities: {}, teams: { home: null, away: null } }; // Temp hook
_container.appendChild(_renderer.domElement);

// --- Video Overlay Enforcement ---
        // --- Overlay Video Logic Removed (Switched to GIF) ---
        // 5. Environment
        createParticles();
        createArena();
        createHolographicRings();
// 5.5 Game Manager
_gameManager = new window.flux.GameManager(_scene, 'ui-layer', _camera, _renderer);
        window.flux.gameInstance = _gameManager;
        
        // 5.5.1 Audio Manager
        _audioManager = new window.flux.AudioManager();
_gameManager.audioManager = _audioManager;

        // 5.5.2 Post Processing
_postProcessing = new window.flux.PostProcessing(_renderer, _config.internalWidth, _config.internalHeight);
        _postProcessing.enabled = false; // Disabled by default for performance
        _gameManager.postProcessing = _postProcessing;

        // 5.6 Camera Manager
        _cameraManager = new window.flux.CameraManager(_camera, _scene);
        _gameManager.cameraManager = _cameraManager;

        // 5.7 Dev Tools
if (window.flux.DevTools) {
            new window.flux.DevTools(_gameManager);
        }
// 5.8 Water Overlay, Light Shafts, Stadium, Glyphs
        _waterOverlay = new window.flux.WaterOverlay(_camera);
        _lightShafts = new window.flux.LightShafts(_scene);
        _stadium = new window.flux.Stadium(_scene);
        _glyphManager = new window.flux.GlyphManager(_scene);
        

_arenaThemeManager = null; // Handled by GameManager
            _gameManager.glyphManager = _glyphManager;
            _gameManager.waterOverlay = _waterOverlay;
            _gameManager.lightShafts = _lightShafts;
            _gameManager.stadium = _stadium;

        // 6. Teams Setup
        _homeTeam = new window.flux.Team(_scene, 'home', 1, 0x00aaff, true);
        _awayTeam = new window.flux.Team(_scene, 'away', -1, 0xff6666, false);

        // 7. Ball
        _ball = new window.flux.Ball(_scene);

        // IMPROVED: Link ball to camera for smart framing
        _cameraManager.setBall(_ball);

        // 8. Team Roster Models
        const roles = ['LF', 'RF', 'MF', 'LD', 'RD', 'GL'];
        const homeRoster = {
            LF: { name: 'Tidus', url: 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb' },
            RF: { name: 'Wakka', url: 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb' },
            MF: { name: 'Letty', url: 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb' },
            LD: { name: 'Datto', url: 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb' },
            RD: { name: 'Jassu', url: 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb' },
            GL: { name: 'Botta', url: 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb' }
        };

const applyStats = (p, role, isHome) => {
const teamLevel = isHome ? 25 : 15; // Restored CPU level for competence
            window.flux.Team.generateStats(p, role, teamLevel, isHome);

            if (p.characterName.includes('Tidus')) {
                p.stats.SH += 5;
                p.stats.SP += 3;
            } else if (p.characterName.includes('Wakka')) {
                p.stats.SH += 3;
                p.stats.EN += 5;
            } else if (p.characterName.includes('Brother')) {
                p.stats.SP = 99;
            }

            p._updateDerivedStats();
        };

        let homeLoaded = 0;
        const roleGltfs = {};

        const finalizeTeams = () => {
            roles.forEach(role => {
                const gltf = roleGltfs[role] || roleGltfs.LF;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                const entry = homeRoster[role];
                p.characterName = entry ? `CPU ${entry.name}` : 'CPU';
                applyStats(p, role, false);

                if (gltf && gltf.scene) {
                    const clone = THREE.SkeletonUtils.clone(gltf.scene);
                    p.setMesh(clone, gltf.animations || []);
                } else {
                    console.warn('Missing GLTF for away role:', role);
                }

                _awayTeam.addPlayer(p);
            });

            const allPlayers = [..._homeTeam.players, ..._awayTeam.players];
            allPlayers.forEach(p => {
                if (p.ballRef === null) p.ballRef = _ball;
            });

            _homeTeam.activePlayer = _homeTeam.players.find(p => p.role === 'MF');

            if (_homeTeam.activePlayer) {
                _homeTeam.activePlayer.techs.tackle = 'venom';
                _homeTeam.activePlayer.techs.shoot = 'sphere';
                console.log('Equipped Home MF with Venom Tackle & Sphere Shot');
            }

const awayMF = _awayTeam.players.find(p => p.role === 'MF');
            // Removed guaranteed Wither tackle for Away MF to reduce difficulty
            _awayTeam.setFormation('Counter');

            const awayGL = _awayTeam.players.find(p => p.role === 'GL');
            // Removed guaranteed Super Goalie for Away GL to make scoring easier

            _homeTeam.assignMarks(_awayTeam);
            _awayTeam.assignMarks(_homeTeam);

            document.getElementById('loading').style.display = 'none';
            if (_gameManager) {
                _gameManager.registerTeams(_homeTeam, _awayTeam, _ball);

                _menuManager = new window.flux.MenuManager(_gameManager);
                _menuManager.show();
            }
        };

roles.forEach(role => {
            const entry = homeRoster[role];
            if (!entry) return;

            const onComplete = () => {
                homeLoaded++;
                if (homeLoaded >= roles.length) {
                    finalizeTeams();
                }
            };

            window.flux.AssetLoader.loadModel(entry.url, (gltf) => {
                roleGltfs[role] = gltf;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name;
                applyStats(p, role, true);

                const clone = THREE.SkeletonUtils.clone(gltf.scene);
                p.setMesh(clone, gltf.animations);
                _homeTeam.addPlayer(p);

                onComplete();
            }, undefined, (err) => {
                console.error('Failed to load model', entry.name, entry.url, err);
                
                // Fallback Mesh (Red Box)
                const fallbackGeo = new THREE.BoxGeometry(1, 2, 1);
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const fallbackMesh = new THREE.Mesh(fallbackGeo, fallbackMat);
                
                // Store dummy in roleGltfs for away team cloning
                roleGltfs[role] = { scene: fallbackMesh, animations: [] };

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name + " (Error)";
                applyStats(p, role, true);
                
                p.setMesh(fallbackMesh.clone(), []);
                _homeTeam.addPlayer(p);

                onComplete();
            });
        });

        // 8. Input
        setupInputs();

        // 9. Loop
        _clock = new THREE.Clock();
        requestAnimationFrame(animate);

        // Handle resize
        window.addEventListener('resize', onResize);
        onResize();
    }

function createParticles() {
        const count = 200; // Optimized for performance (was 1500)
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        const offsets = []; // Random offsets for independent bobbing

        for (let i = 0; i < count; i++) {
            vertices.push(
                (Math.random() - 0.5) * 80, // Wider spread X
                (Math.random() - 0.5) * 50, // Wider spread Y
                (Math.random() - 0.5) * 80  // Wider spread Z
            );
            offsets.push(Math.random() * 100);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        const material = new THREE.ShaderMaterial({
            uniforms: _particleUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
vertexShader: `
                uniform float uTime;
                attribute float aOffset;
                varying float vAlpha;
                void main() {
                    vec3 pos = position;
                    // Bobbing motion: Sine wave based on time + random offset
                    float bob = sin(uTime * 0.5 + aOffset) * 2.0;
                    pos.y += bob;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    
                    // Size attenuation - Small and shimmery
                    float sizeBase = 2.0 + sin(uTime * 3.0 + aOffset) * 1.0; 
                    gl_PointSize = sizeBase * (20.0 / -mvPosition.z);
                    
                    // Fade based on distance/height
                    vAlpha = 0.5 + 0.5 * sin(uTime * 2.0 + aOffset);
                }
            `,
            fragmentShader: `
                varying float vAlpha;
                void main() {
                    // Soft glow particle (Dust mote)
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    float dist = length(coord);
                    if(dist > 0.5) discard;
                    
                    // Soft falloff for shimmer
                    float strength = 1.0 - (dist * 2.0);
                    strength = pow(strength, 2.0);
                    
                    // Cyan/Blue tint, additive feel
                    gl_FragColor = vec4(0.7, 0.9, 1.0, vAlpha * strength * 0.8);
                }
            `
        });

        const points = new THREE.Points(geometry, material);
        points.frustumCulled = false;
        _scene.add(points);
    }

function createArena() {
        // Group for rotation
        window.flux.arenaGroup = new THREE.Group();
        _scene.add(window.flux.arenaGroup);

        const geometry = new THREE.SphereGeometry(_config.arenaRadius, 32, 32);
        
        // --- 1. Base Sphere (Faint Grid) ---
        const texLoader = new THREE.TextureLoader();
        const arenaTex = texLoader.load('https://i.postimg.cc/W1LsH68Q/file-0000000023ec71f596593829e8118760-(1).png');
        arenaTex.magFilter = THREE.NearestFilter;
        arenaTex.minFilter = THREE.NearestFilter;
        arenaTex.wrapS = THREE.RepeatWrapping;
        arenaTex.wrapT = THREE.RepeatWrapping;
        arenaTex.repeat.set(6, 4);

        const material = new THREE.MeshBasicMaterial({
            map: arenaTex,
            color: 0x446688,
            wireframe: false,
            transparent: true,
            opacity: 0.15, 
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            depthWrite: false
        });

        // Inject Elastic Shader for Base Arena
        material.onBeforeCompile = (shader) => {
            shader.uniforms.uTime = _arenaUniforms.uTime;
            shader.uniforms.uImpactStr = _arenaUniforms.uImpactStr;
            shader.uniforms.uImpactPos = _arenaUniforms.uImpactPos;

            shader.vertexShader = `
                uniform float uTime;
                uniform float uImpactStr;
                uniform vec3 uImpactPos;
            ` + shader.vertexShader;

            shader.vertexShader = shader.vertexShader.replace(
                '#include <begin_vertex>',
                `
                #include <begin_vertex>
                
                // Elastic Breathing (Ambient)
                float breath = sin(position.y * 0.08 + uTime * 1.2) * 1.2;
                breath += sin(position.x * 0.05 + uTime * 0.8) * 0.8;
                transformed += normal * breath;

                // Impact Ripple (Reactive)
                float dist = distance(position, uImpactPos);
                float ripple = sin(dist * 0.8 - uTime * 15.0) * uImpactStr * 0.8;
                float mask = smoothstep(45.0, 0.0, dist);
                transformed += normal * ripple * mask;
                `
            );
        };
            
        const arena = new THREE.Mesh(geometry, material);
        window.flux.arenaGroup.add(arena);
        window.flux.arenaMesh = arena;

        // --- 2. Inner Hex Grid (Warp Effect) ---
        // Reuse existing hex generation logic but attach to group
        const hexTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            const r = 64;
            const w = r * 2;
            const h = Math.sqrt(3) * r;
            for(let y = -1; y < 512/h + 2; y++) {
                for(let x = -1; x < 512/(w*0.75) + 2; x++) {
                    const cx = x * w * 0.75;
                    const cy = y * h + (x%2===0 ? 0 : h/2);
                    ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const ang = Math.PI/3 * i;
                        ctx.lineTo(cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
            }
            return new THREE.CanvasTexture(c);
        })();
        hexTex.wrapS = THREE.RepeatWrapping;
        hexTex.wrapT = THREE.RepeatWrapping;
        hexTex.repeat.set(4, 2);

        const arenaUniforms = THREE.UniformsUtils.merge([
            THREE.UniformsLib['common'],
            _arenaUniforms,
            { 
                tMap: { value: hexTex },
                uOpacity: { value: 0.1 } 
            }
        ]);

        const material2 = new THREE.ShaderMaterial({
            uniforms: arenaUniforms,
            transparent: true,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                uniform float uTime;
                uniform vec3 uImpactPos;
                uniform float uImpactStr;
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    vec3 pos = position;
                    
                    // Ambient Jelly Wobble
                    float wobble = sin(pos.y * 0.1 + uTime * 2.0) * 1.5;
                    wobble += cos(pos.z * 0.1 + uTime * 1.5) * 1.5;
                    vec3 normal = normalize(pos);
                    pos += normal * wobble;

                    // Impact Distortion
                    float dist = distance(pos, uImpactPos);
                    float radius = 35.0; 
                    if (dist < radius) {
                        float t = dist / radius;
                        // Smooth cubic falloff for organic bulge
                        float bulge = (1.0 - t);
                        bulge = bulge * bulge * (3.0 - 2.0 * bulge);
                        
                        // Ripple effect (Concentric waves)
                        float ripple = sin(dist * 0.8 - uTime * 12.0) * 0.25;
                        
                        // High frequency jitter (Tension/Energy)
                        float jitter = sin(pos.x * 3.0 + uTime * 20.0) * sin(pos.y * 3.0 + uTime * 15.0) * 0.08;
                        
                        // Apply distortion: Bulge out + Ripples + Jitter
                        pos += normal * ((bulge + ripple * bulge + jitter * bulge) * uImpactStr);
                    }
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tMap;
                uniform float uImpactStr;
                uniform float uOpacity;
                varying vec2 vUv;
                void main() {
                    vec4 texColor = texture2D(tMap, vUv);
                    float alpha = uOpacity * texColor.a;
                    alpha += uImpactStr * 0.03; 
                    vec3 color = texColor.rgb * vec3(0.2, 0.8, 1.0);
                    gl_FragColor = vec4(color, alpha);
                }
            `
        });

        const arena2 = new THREE.Mesh(geometry, material2);
        arena2.scale.setScalar(0.98);
        window.flux.arenaGroup.add(arena2);
        window.flux.arenaMesh2 = arena2;
        // --- 3. EQUATOR BANDS (Blue and Gold - possession based) ---
        const bandTexLoader = new THREE.TextureLoader();

        // Blue Band (shown when home team has ball) - thin band, no vertical stretch
        const blueBandTex = bandTexLoader.load('https://i.postimg.cc/SQnFpDHN/Blue-band.png');
        blueBandTex.wrapS = THREE.RepeatWrapping;
        blueBandTex.wrapT = THREE.ClampToEdgeWrapping;
        blueBandTex.repeat.set(1, 1); // Single wrap, image tiles naturally

        const blueBandMat = new THREE.MeshBasicMaterial({
            map: blueBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
// Thin band - height of 3 to avoid stretching
        const blueBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const blueBandMesh = new THREE.Mesh(blueBandGeo, blueBandMat);
        blueBandMesh.position.y = 0;
        blueBandMesh.visible = true;
        _scene.add(blueBandMesh);

        // Gold Band (shown when away team has ball)
        const goldBandTex = bandTexLoader.load('https://i.postimg.cc/MZn28dgq/Gold-band.png');
        goldBandTex.wrapS = THREE.RepeatWrapping;
        goldBandTex.wrapT = THREE.ClampToEdgeWrapping;
        goldBandTex.repeat.set(1, 1);

        const goldBandMat = new THREE.MeshBasicMaterial({
            map: goldBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
const goldBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const goldBandMesh = new THREE.Mesh(goldBandGeo, goldBandMat);
        goldBandMesh.position.y = 0;
        goldBandMesh.visible = false;
        _scene.add(goldBandMesh);

        // Store references
        window.flux.blueBandMesh = blueBandMesh;
        window.flux.goldBandMesh = goldBandMesh;
        window.flux.blueBandMat = blueBandMat;
        window.flux.goldBandMat = goldBandMat;

        window.flux.updateBandPossession = function(homeHasBall) {
            if (window.flux.blueBandMesh && window.flux.goldBandMesh) {
                window.flux.blueBandMesh.visible = homeHasBall;
                window.flux.goldBandMesh.visible = !homeHasBall;
            }
        };

        window.flux.tribalUniforms = {
            uTime: { value: 0 },
            uColor: { value: new THREE.Color(0x00ffff) }
        };

        // --- 4. VERTICAL ARROW STRIPS (Around sphere, above & below band) ---
        const arrowTexLoader = new THREE.TextureLoader();
        const arrowTex = arrowTexLoader.load('https://i.postimg.cc/dQhPK4gQ/Yellowarrows.png');
        arrowTex.wrapS = THREE.ClampToEdgeWrapping;
        arrowTex.wrapT = THREE.ClampToEdgeWrapping;

        const arrowMat = new THREE.MeshBasicMaterial({
            map: arrowTex,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        // Create vertical arrow strips around the sphere (curved to match sphere surface)
        const arrowGroup = new THREE.Group();
        const numArrows = 16;   // Number of arrow strips around circumference
        const arrowHeight = 30; // Height of each arrow strip
        const arrowWidth = 6;   // Width of each strip
        const arrowRadius = _config.arenaRadius * 0.94;

        const makeCurvedStrip = (baseAngle, yCenter, flipV = false) => {
            // More segments = smoother curvature (keep modest for mobile)
            const segW = 6;   // curvature resolution (width)
            const segH = 18;  // vertical resolution (height)

            // Convert desired world-space width into an angular span on the sphere
            const phiSpan = arrowWidth / arrowRadius; // radians (approx at equator)
            const phi0 = baseAngle - phiSpan * 0.5;
            const phi1 = baseAngle + phiSpan * 0.5;

            const y0 = yCenter - arrowHeight * 0.5;
            const y1 = yCenter + arrowHeight * 0.5;

            const positions = [];
            const normals = [];
            const uvs = [];
            const indices = [];

            for (let iy = 0; iy <= segH; iy++) {
                const v = iy / segH;
                const y = THREE.MathUtils.lerp(y0, y1, v);

                // Circle radius at this height on the sphere (x/z shrink as |y| grows)
                const ringR = Math.sqrt(Math.max(0.00001, arrowRadius * arrowRadius - y * y));

                for (let ix = 0; ix <= segW; ix++) {
                    const u = ix / segW;
                    const phi = THREE.MathUtils.lerp(phi0, phi1, u);

                    const x = Math.sin(phi) * ringR;
                    const z = Math.cos(phi) * ringR;

                    positions.push(x, y, z);

                    // Outward normal for a sphere centered at origin
                    const invLen = 1.0 / Math.sqrt(x * x + y * y + z * z);
                    normals.push(x * invLen, y * invLen, z * invLen);

                    const vv = flipV ? (1 - v) : v;
                    uvs.push(u, vv);
                }
            }

            const row = segW + 1;
            for (let iy = 0; iy < segH; iy++) {
                for (let ix = 0; ix < segW; ix++) {
const a = iy * row + ix;
                    const b = iy * row + (ix + 1);
                    const c = (iy + 1) * row + ix;
                    const d = (iy + 1) * row + (ix + 1);
                    indices.push(a, c, b);
                    indices.push(b, c, d);
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setIndex(indices);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
            geo.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));
            geo.computeBoundingSphere();

            return new THREE.Mesh(geo, arrowMat);
        };

        for (let i = 0; i < numArrows; i++) {
            const angle = (i / numArrows) * Math.PI * 2;

            // Upper arrow strip (above band)
            arrowGroup.add(makeCurvedStrip(angle, arrowHeight * 0.5 + 2, false));

            // Lower arrow strip (below band) - flip V so arrows point downward
            arrowGroup.add(makeCurvedStrip(angle, -arrowHeight * 0.5 - 2, true));
        }

        _scene.add(arrowGroup);

        // Store references for DevTools
        window.flux.arrowGroup = arrowGroup;
        window.flux.arrowMat = arrowMat;

        // --- 5. TOP GLYPHS (Dome) --- (Dome) ---
        const topGlyphTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, Math.PI*2);
            ctx.stroke();
            
            // Intricate pattern
            for(let i=0; i<8; i++) {
                const a = (i/8)*Math.PI*2;
                const x = 256 + Math.cos(a)*150;
                const y = 256 + Math.sin(a)*150;
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI*2);
                ctx.stroke();
                // Connector
                ctx.beginPath();
                ctx.moveTo(256, 256);
// Connector
            }
            return new THREE.CanvasTexture(c);
        })();

        const topGlyphMat = new THREE.MeshBasicMaterial({
            map: topGlyphTex,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        const topGlyphGeo = new THREE.PlaneGeometry(60, 60);
        const topGlyph = new THREE.Mesh(topGlyphGeo, topGlyphMat);
        topGlyph.rotation.x = -Math.PI / 2;
        topGlyph.position.y = 35; // Near top of dome
        window.flux.arenaGroup.add(topGlyph);

        // --- NEW: FFX GOAL MODELS ---
        const goalUrl = 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb';
        
const onGoalLoaded = (model, isFallback) => {
            const goalA = model;

            const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            const goalY = (window.flux.BallConfig && window.flux.BallConfig.GOAL_Y_OFFSET) !== undefined ? window.flux.BallConfig.GOAL_Y_OFFSET : -18.0;

            const goalScale = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE) !== undefined ? window.flux.BallConfig.GOAL_SCALE : 45.0;
            const sx = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_X) !== undefined ? window.flux.BallConfig.GOAL_SCALE_X : 1.0;
            const sy = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_Y) !== undefined ? window.flux.BallConfig.GOAL_SCALE_Y : 1.0;
            const sz = (window.flux.BallConfig && window.flux.BallConfig.GOAL_SCALE_Z) !== undefined ? window.flux.BallConfig.GOAL_SCALE_Z : 1.0;
            
goalA.position.set(0, goalY, -goalDist);
            if (!isFallback) {
                goalA.scale.set(goalScale * sx, goalScale * sy, goalScale * sz); 
            }
            // Setup Goal A
            goalA.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false; // CRITICAL: Prevent culling
                    c.renderOrder = 0;
                    
                    // Ensure material is visible and unique
                    if (c.material) {
                        c.material = c.material.clone(); // Clone for independence
                        c.material.color.setHex(0xffffff); // White to show original texture/colors
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.side = THREE.DoubleSide;
                        c.material.depthWrite = true;
                        c.material.depthTest = true;
                    }
                }
            });
            // Add goals to SCENE, not arenaGroup (they shouldn't rotate with the sphere)
            _scene.add(goalA);
            window.flux.goalA = goalA; // Expose for DevTools

            // Setup Goal B
            const goalB = isFallback ? goalA.clone() : THREE.SkeletonUtils.clone(goalA);

goalB.position.set(0, goalY, goalDist);
if (!isFallback) {
                goalB.scale.set(goalScale * sx, goalScale * sy, goalScale * sz);
            }
            goalB.rotation.y = Math.PI;
            // Ensure Goal B meshes are also persistent and have unique materials
            goalB.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false;
                    if (c.material) {
                        c.material = c.material.clone(); // Clone again for B
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.depthWrite = true;
                    }
                }
            });

            _scene.add(goalB);
            window.flux.goalB = goalB; // Expose for DevTools
        };

        window.flux.AssetLoader.loadModel(goalUrl, (gltf) => {
            onGoalLoaded(gltf.scene, false);
        }, undefined, (err) => {
            console.warn("Goal model failed to load. Using fallback.", err);
            const geo = new THREE.BoxGeometry(75, 45, 10); // Fallback massive box (Scaled 1.5x)
            const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            const fallback = new THREE.Mesh(geo, fallbackMat);
            onGoalLoaded(fallback, true);
        });

        // --- NEW: MASSIVE FIELD MARKINGS ---
        createFieldMarkings();
    }

function createFieldMarkings() {
        // Load floor glyph from image
        const texLoader = new THREE.TextureLoader();
        const tex = texLoader.load('https://i.postimg.cc/v8CR85dQ/Floorglyph.png');
        tex.anisotropy = 16;

        // Floor Plane (Deep)
        const geo = new THREE.PlaneGeometry(90, 90);
        const mat = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        const field = new THREE.Mesh(geo, mat);
        field.rotation.x = -Math.PI / 2;
        field.position.y = -8.0; // Sunk deep
        _scene.add(field);

        // Store references for DevTools
        window.flux.floorGlyphMesh = field;
        window.flux.floorGlyphMat = mat;
    }

function createHolographicRings() {
        // Floating Holographic Rings (Mid-height)
        const ringGeo = new THREE.TorusGeometry(20, 0.1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        ring1.rotation.x = Math.PI / 2;
        ring1.position.y = 0;
        _scene.add(ring1);
        
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        ring2.rotation.x = Math.PI / 2;
        ring2.scale.setScalar(1.2);
        ring2.position.y = 4.0;
        _scene.add(ring2);

        // Animate Rings (integrated into main loop to avoid a second RAF on mobile)
let _ringTime = 0;
        const _ringUpdate = (dt) => {
            _ringTime += dt;
            if (ring1) {
                ring1.rotation.z += dt * 0.9;
                ring1.scale.setScalar(1.0 + Math.sin(_ringTime * 0.5) * 0.05);
            }
            if (ring2) {
                ring2.rotation.z -= dt * 0.75;
                ring2.position.y = 4.0 + Math.cos(_ringTime * 0.7) * 1.0;
            }
        };
        if (window.flux && window.flux._runtimeUpdaters) window.flux._runtimeUpdaters.push(_ringUpdate);
    }

    // --- INPUT SYSTEM ---
// --- INPUT SYSTEM ---
const _keys = {};
// Globals moved to below helper

    // Helper: Analyze curve geometry for analog control
    const analyzeSwipeCurve = (points) => {
        if (points.length < 3) return { intensity: 0, speed: 0, dx: 0, dy: 0 };
        
        const pStart = points[0];
        const pEnd = points[points.length - 1];
        const midIdx = Math.floor(points.length / 2);
        const pMid = points[midIdx];

        const dx = pEnd.x - pStart.x;
        const dy = pEnd.y - pStart.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const dt = pEnd.t - pStart.t;
        const speed = (dt > 0) ? dist / dt : 0; // px/ms

        if (dist < 50) return { intensity: 0, speed: speed, dx, dy };

        const vSM_x = pMid.x - pStart.x;
        const vSM_y = pMid.y - pStart.y;

        // Cross product gives signed area/curvature direction
        const cross = (dx * vSM_y) - (dy * vSM_x);
        // Normalize by distance squared to get a curvature ratio independent of scale
const intensity = cross / (dist * dist);

        return { intensity, speed, dx, dy };
    };
    let _swipePoints = []; // Track swipe history for curves
    const _aimInput = { x: 0, y: 0, active: false }; // NEW: Aim joystick

    const _actionBuffer = { active: false, timestamp: 0, duration: 300 };

    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();
    const _upAxis = new THREE.Vector3(0, 1, 0);

function setupInputs() {
        // Skip Intro Listener
        const skipHandler = () => {
            if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') {
                window.flux.gameInstance.skipIntro();
            }
        };
        window.addEventListener('mousedown', skipHandler);
        window.addEventListener('touchstart', skipHandler, {passive: true});

        // Keyboard
        window.addEventListener('keydown', (e) => {
            _keys[e.key] = true;
            if (e.code === 'Space' && _homeTeam && _homeTeam.activePlayer && _ball) {
                _homeTeam.activePlayer.throwBall(_ball);
            }
// NEW: Tackle/Sprint on Shift
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (p.hasBall) {
                        // Offense: Sprint/Break (Instant)
                        p.dash(p.inputVector.x, p.inputVector.z);
                    } else {
                        // Defense: Start Charge
                        if (!p.isTackleCharging && !p.isTackling && !p.isRecovering) {
                            p.startTackleCharge();
                        }
                    }
                }
            }
            // NEW: Evade on 'E'
            if (e.code === 'KeyE') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    _homeTeam.activePlayer.evade();
                }
            }
            updateInputVector();
        });
window.addEventListener('keyup', (e) => { 
            _keys[e.key] = false; 
            
            // NEW: Release Tackle on Shift Up
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (!p.hasBall && p.isTackleCharging) {
                        p.releaseTackle();
                    }
                }
            }

            updateInputVector(); 
        });

        // --- FLOATING JOYSTICK (Movement) ---
        const hitZone = document.getElementById('joystick-hit-zone');
        const visuals = document.getElementById('joystick-visual-container');
        const base = document.getElementById('joystick-base');
        const knob = document.getElementById('joystick-knob');

        let startX = 0, startY = 0;
        let dragging = false;
        const maxDist = 40;

        let moveTouchId = null;
        const moveDeadzonePx = 6;

        // Expose move joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.move = _dbg.input.move || {};
        _dbg.input.move.vector = _input;
        _dbg.input.move.dragging = dragging;
        _dbg.input.move.touchId = moveTouchId;


        const handleStart = (clientX, clientY) => {
            dragging = true;
            startX = clientX;

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
            }

            startY = clientY;

            visuals.style.display = 'block';
            visuals.style.left = `${clientX}px`;
            visuals.style.top = `${clientY}px`;

            knob.style.transform = `translate(-50%, -50%)`;

            createRipple(clientX, clientY);

            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        const handleMove = (clientX, clientY) => {
            if (!dragging) return;

            let dx = clientX - startX;
            let dy = clientY - startY;

            const dist = Math.sqrt(dx*dx + dy*dy);


            // Deadzone to prevent drift from tiny thumb jitter
            if (dist < moveDeadzonePx) {
                dx = 0;
                dy = 0;
            }

            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            _input.x = (dx / maxDist) * _settings.joystickSensitivity;
            _input.y = (dy / maxDist) * _settings.joystickSensitivity;
            updateInputVector();
        };

        const handleEnd = () => {
            if (!dragging) return;
            dragging = false;

            moveTouchId = null;

            visuals.style.display = 'none';

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
                _dbg.input.move.touchId = moveTouchId;
            }


            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        if (hitZone) {
            hitZone.addEventListener('touchstart', (e) => {
                if (e.cancelable) e.preventDefault();
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
                moveTouchId = t ? t.identifier : null;
                if (_dbg && _dbg.input && _dbg.input.move) {
                    _dbg.input.move.touchId = moveTouchId;
                }
                handleStart(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                if (e.cancelable) e.preventDefault();
                const t = _findTouchById(e.touches, moveTouchId);
                if (!t) return;
                handleMove(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchend', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return; // Ignore other fingers lifting
                handleEnd();
            });
            window.addEventListener('touchcancel', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return;
                handleEnd();
            });

            hitZone.addEventListener('mousedown', (e) => {
                handleStart(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (dragging) handleMove(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', handleEnd);
        }

        // --- NEW: AIM JOYSTICK (Right side) ---
        setupAimJoystick();

        // --- NEW: TACKLE BUTTON ---
        setupTackleButton();

        // Swipe Detection
// Swipe Detection
        let swipeStart = { x: 0, y: 0, t: 0 };
        let swipeTouchId = null;
        
        // Expose swipe/throw gesture state for snapshots
        _dbg.input.swipe = _dbg.input.swipe || {};
        _dbg.input.swipe.start = swipeStart;
        _dbg.input.swipe.touchId = swipeTouchId;
        _dbg.input.swipe.points = _swipePoints;
const onSwipeStart = (x, y) => {
            swipeStart.x = x;
            swipeStart.y = y;
            swipeStart.t = Date.now();
            _swipePoints = [{x, y, t: Date.now()}];
        };

const onSwipeMove = (x, y) => {
            if (_swipePoints.length > 0) {
                _swipePoints.push({x, y, t: Date.now()});
                createSwipeTrailDot(x, y); // Visual Feedback
            }
        };

const onSwipeEnd = (x, y) => {
            if (_swipePoints.length < 2) return;
            _swipePoints.push({x, y, t: Date.now()});

            const { intensity, speed, dx, dy } = analyzeSwipeCurve(_swipePoints);
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (_homeTeam && _homeTeam.activePlayer && _camera) {
                const p = _homeTeam.activePlayer;

                // --- CURVE BALL DETECTION (Immediate Throw) ---
// --- CURVE BALL DETECTION (Immediate Throw) ---
                if (p.hasBall && !p.isThrowing && !p.isCharging) {
                    // Analog Curve Check: Threshold 0.25 requires a deliberate arc (The "Feat")
                    if (Math.abs(intensity) > 0.25 && dist > 100) {
                        _camera.getWorldDirection(_camFwd);
                        _camFwd.y = 0; _camFwd.normalize();
                        _camRight.crossVectors(_camFwd, _upAxis).normalize();

                        const worldX = (_camRight.x * dx) + (_camFwd.x * -dy);
                        const worldZ = (_camRight.z * dx) + (_camFwd.z * -dy);
                        const throwDir = new THREE.Vector3(worldX, 0, worldZ).normalize();

                        // Map intensity to spin - Drastically reduced sensitivity
                        const rawSpin = Math.abs(intensity) * 300.0; 
                        const speedFactor = Math.min(1.5, speed / 1.0);
                        const spinPower = Math.min(400.0, rawSpin * speedFactor);
                        const spinSign = Math.sign(intensity); 
                        const spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);


                        p.setOverrideAim(throwDir.x, throwDir.z);
const ball = window.flux.gameInstance && window.flux.gameInstance.entities ? window.flux.gameInstance.entities.ball : null;
                        if (ball) p.throwBall(ball, 'SH', 1.0, spinVec);
                        
                        if (window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("CURVE", p.mesh.position, "tech");
                        }
                        createRipple(x, y);
                        _swipePoints = [];
                        return; 
                    }
                }

                // --- STANDARD DASH / AIM ---
                _camera.getWorldDirection(_camFwd);
                _camFwd.y = 0;
                if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                else _camFwd.normalize();

                _camRight.crossVectors(_camFwd, _upAxis).normalize();

const worldX2 = (_camRight.x * dx) + (_camFwd.x * -dy);
                const worldZ2 = (_camRight.z * dx) + (_camFwd.z * -dy);

                if (p.isThrowing) {
p.setOverrideAim(worldX2, worldZ2);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("AIM!", p.mesh.position, "default");
                    }
                } else {
if (dist > 50) p.dash(worldX2, worldZ2);
                }

                createRipple(x, y);
            }
_swipePoints = [];
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            swipeTouchId = t ? t.identifier : null;
// onSwipeStart(t.clientX, t.clientY); // Fixed syntax error
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
            onSwipeStart(t.clientX, t.clientY);
            createRipple(t.clientX, t.clientY);
        }, { passive: false });

window.addEventListener('touchmove', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            const t = _findTouchById(e.touches, swipeTouchId);
            if (!t) return;
            onSwipeMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        });

                window.addEventListener('touchcancel', (e) => {
if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }

        });
// Mouse Swipe
        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            onSwipeStart(e.clientX, e.clientY);
            createRipple(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
             if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            // Only track if mouse is down (simulating drag)
            if (e.buttons === 1) {
                onSwipeMove(e.clientX, e.clientY);
            }
        });


        window.addEventListener('mouseup', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            onSwipeEnd(e.clientX, e.clientY);
        });

        // Action Button (Shoot/Pass)
        const actionBtn = document.getElementById('action-button');

const setupButton = (btn) => {
            if (!btn) return;

            let btnStartX = 0;
            let btnStartY = 0;
            let isDragging = false;
            let swipePoints = [];
            let actionTouchId = null;

            const attemptAction = () => {
                if (!_homeTeam || !_homeTeam.activePlayer) return false;
                const p = _homeTeam.activePlayer;

                if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                    p.startCharge();
                    btn.classList.add('active');
                    return true;
                }
                
                // DEFENSE: Block
                if (!p.hasBall && !p.isDashing && !p.isEvading && p.status.nap <= 0 && p.stunTimer <= 0) {
                    p.startBlock();
                    btn.classList.add('active');
                    return true;
                }

                return false;
            };

            const handleStart = (e) => {
                if (e.cancelable) e.preventDefault();

                if (_gameManager && _gameManager.techCopyState.active) {
                    _gameManager.attemptTechCopy();
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                    return;
                }

                if (_gameManager && _gameManager.isDemoMode) return;

                let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.changedTouches && e.changedTouches.length) {
                    const t = e.changedTouches[0];
                    actionTouchId = t.identifier;
                    clientX = t.clientX;
                    clientY = t.clientY;
                } else {
                    actionTouchId = null; // mouse
                }

                // Visual Feedback: Input Ripple
                createRipple(clientX, clientY);

                btnStartX = clientX;
                btnStartY = clientY;
                isDragging = true;
                swipePoints = [{x: clientX, y: clientY, t: Date.now()}];

                _actionBuffer.active = true;
                _actionBuffer.timestamp = Date.now();

                if (attemptAction()) {
                    _actionBuffer.active = false;
                }

                // Attach global listeners to track swipe outside button
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('touchcancel', handleEnd);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                // Touch path (multi-touch safe)
                if (e.touches && actionTouchId !== null) {
                    const t = _findTouchById(e.touches, actionTouchId);
                    if (!t) return;
                    swipePoints.push({x: t.clientX, y: t.clientY, t: Date.now()});
                    return;
                }

                // Mouse path
                const clientX = e.clientX;
                const clientY = e.clientY;
                swipePoints.push({x: clientX, y: clientY, t: Date.now()});
            };

const handleEnd = (e) => {
                let dx = 0;
                let dy = 0;
                let validEnd = false;

                // 1. Check Touch
                if (e.changedTouches && actionTouchId !== null) {
                    const tEnd = _endedTouchById(e.changedTouches, actionTouchId);
                    if (tEnd) {
                        dx = tEnd.clientX - btnStartX;
                        dy = tEnd.clientY - btnStartY;
                        swipePoints.push({x: tEnd.clientX, y: tEnd.clientY, t: Date.now()});
                        validEnd = true;
                        actionTouchId = null;
                    }
                }
                // 2. Check Mouse
                else if (isDragging) {
                    dx = e.clientX - btnStartX;
                    dy = e.clientY - btnStartY;
                    swipePoints.push({x: e.clientX, y: e.clientY, t: Date.now()});
                    validEnd = true;
                }

                if (!validEnd) return;

                isDragging = false;
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('touchcancel', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);

                // Analyze Swipe
                const analysis = analyzeSwipeCurve(swipePoints);
                const curveData = { intensity: analysis.intensity, speed: analysis.speed };
                
                // Check if it was a tap (short duration, low movement)
                const isTap = (Date.now() - _actionBuffer.timestamp < 200) && (Math.sqrt(dx*dx + dy*dy) < 20);
                const wasBuffered = _actionBuffer.active;
                _actionBuffer.active = false;

                if (!_homeTeam || !_homeTeam.activePlayer) return;
                const p = _homeTeam.activePlayer;

                // SPIN CALCULATION (If curve is strong enough)
                let spinVec = null;
                const TC = window.flux.ThrowConfig || {};
                if (Math.abs(analysis.intensity) > (TC.CURVE_INTENSITY_THRESHOLD || 0.25)) {
                    const rawSpin = Math.abs(analysis.intensity) * (TC.CURVE_SPIN_SCALE || 1000.0);
                    const speedFactor = Math.min(1.5, analysis.speed / 1.0);
                    const spinPower = Math.min((TC.CURVE_SPIN_CAP || 1500.0), rawSpin * speedFactor);
                    const spinSign = Math.sign(analysis.intensity);
                    spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);
                }

                // EXECUTE
                if (p.isCharging) {
                    // Normal Release
                    if (spinVec) {
                        // Unified spin passing
                        p.releaseCharge(dx, dy, { intensity: analysis.intensity, speed: analysis.speed }); 
                    } else {
                        p.releaseCharge(dx, dy, curveData);
                    }
                    btn.classList.remove('active');
                } 
                else if (wasBuffered && p.hasBall && !p.isThrowing && p.status.nap <= 0) {
                    // Buffered Tap (Instant Shot)
                    // Force start and release immediately
                    p.startCharge();
                    p.releaseCharge(dx, dy, curveData);
                    btn.classList.remove('active');
                }
                else if (p.isBlocking) {
                    p.stopBlock();
                    btn.classList.remove('active');
                }
            };

            btn.addEventListener('touchstart', handleStart, { passive: false });
            btn.addEventListener('mousedown', handleStart);
        };
        setupButton(actionBtn);

        // Auto Toggle
        const autoBtn = document.getElementById('auto-toggle');
        if (autoBtn) {
            const handleToggle = () => {
                if (_gameManager) {
                    _gameManager.toggleDemoMode();
                    if (_homeTeam && _homeTeam.activePlayer) {
                        _homeTeam.activePlayer.setInput(0, 0);
                    }
                }
            };

            autoBtn.addEventListener('click', handleToggle);
            autoBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleToggle();
            }, { passive: false });
        }
        // NEW: Settings Button
        setupSettingsButton();
    }

    // NEW: Aim Joystick Setup
// NEW: Aim Joystick Setup
function setupAimJoystick() {
        const aimKnob = document.getElementById('aim-joystick-knob');
        const aimVisuals = document.getElementById('aim-joystick-visual');
        const aimZone = document.getElementById('aim-joystick-zone');
        if (!aimZone) return;
        let aimStartX = 0, aimStartY = 0;
        let aimDragging = false;
        const aimMaxDist = 35;
        let aimTouchId = null;

        

        // Expose aim joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.aim = _dbg.input.aim || {};
        _dbg.input.aim.vector = _aimInput;
        _dbg.input.aim.dragging = aimDragging;
        _dbg.input.aim.touchId = aimTouchId;
const handleAimStart = (clientX, clientY) => {
            aimDragging = true;
            aimStartX = clientX;

            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.dragging = aimDragging; }

            aimStartY = clientY;
            _aimInput.active = true;

            if (aimVisuals) {
                aimVisuals.style.display = 'block';
                aimVisuals.style.left = `${clientX}px`;
                aimVisuals.style.top = `${clientY}px`;
            }
            if (aimKnob) {
                aimKnob.style.transform = `translate(-50%, -50%)`;
            }
        };

        const handleAimMove = (clientX, clientY) => {
            if (!aimDragging) return;

            let dx = clientX - aimStartX;
            let dy = clientY - aimStartY;

            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > aimMaxDist) {
                dx = (dx / dist) * aimMaxDist;
                dy = (dy / dist) * aimMaxDist;
            }

            if (aimKnob) {
                aimKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            }

            // Normalize and transform to world space
            _aimInput.x = dx / aimMaxDist;
            _aimInput.y = dy / aimMaxDist;

            // Apply aim to player if charging
            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;
                if (p.isCharging || p.isThrowing) {
                    // Transform screen aim to world space
                    _camera.getWorldDirection(_camFwd);
                    _camFwd.y = 0;
                    if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                    else _camFwd.normalize();
                    _camRight.crossVectors(_camFwd, _upAxis).normalize();

                    const worldX = (_camRight.x * _aimInput.x) + (_camFwd.x * -_aimInput.y);
                    const worldZ = (_camRight.z * _aimInput.x) + (_camFwd.z * -_aimInput.y);

                    if (Math.abs(worldX) > 0.1 || Math.abs(worldZ) > 0.1) {
                        p.setOverrideAim(worldX, worldZ);
                    }
                }
            }
        };

const handleAimEnd = () => {
            if (!aimDragging) return;
            aimDragging = false;
            _aimInput.active = false;
            _aimInput.x = 0;
            _aimInput.y = 0;

            if (aimVisuals) {
                aimVisuals.style.display = 'none';
            }

            // Clear player aim override
            if (_homeTeam && _homeTeam.activePlayer) {
                _homeTeam.activePlayer.overrideAimVector = null;
            }
        };

        aimZone.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            aimTouchId = t ? t.identifier : null;
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; }
            handleAimStart(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!aimDragging) return;
            if (e.cancelable) e.preventDefault();
            const t = _findTouchById(e.touches, aimTouchId);
            if (!t) return;
            handleAimMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (!aimDragging) return;
            const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
            if (!tEnd) return;
            aimTouchId = null;
handleAimEnd();
if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
        });

        window.addEventListener('touchcancel', (e) => {
            if (!aimDragging) return;
                        const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
                        if (!tEnd) return;
                        aimTouchId = null;
handleAimEnd();
                        if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
                    });
// Mouse support for desktop testing
        aimZone.addEventListener('mousedown', (e) => {
            handleAimStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
            if (aimDragging) handleAimMove(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', (e) => {
            if (aimDragging) handleAimEnd();
        });
    }

    // NEW: Tackle Button Setup
// NEW: Tackle Button Setup
    function setupTackleButton() {
        const tackleBtn = document.getElementById('tackle-button');
        if (!tackleBtn) return;

        let holdTimer = null;
        let isHolding = false;
        let lastTapTime = 0;
        const HOLD_THRESHOLD = 200; // ms
        const DOUBLE_TAP_THRESHOLD = 300; // ms

        const handleStart = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation(); // Prevent bubbling to joystick

            // Visual Feedback: Input Ripple
            let clientX = e.clientX;
            let clientY = e.clientY;
            if (e.changedTouches && e.changedTouches.length) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            }
            createRipple(clientX, clientY);

            if (_gameManager && _gameManager.isDemoMode) return;
            if (!_homeTeam || !_homeTeam.activePlayer) return;

            const p = _homeTeam.activePlayer;

            // Visual Feedback immediately
            tackleBtn.classList.add('active');

            // Reset Hold State
            isHolding = false;
            if (holdTimer) clearTimeout(holdTimer);

            // Start Hold Timer
            holdTimer = setTimeout(() => {
                isHolding = true;
                // Only charge if we don't have the ball (Defensive Tackle)
                if (!p.hasBall) {
                    p.startTackleCharge();
                    tackleBtn.classList.add('urgent'); // Visual cue for charge
                }
            }, HOLD_THRESHOLD);
        };

        const handleEnd = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation();

            tackleBtn.classList.remove('active');
            tackleBtn.classList.remove('urgent');
            if (holdTimer) clearTimeout(holdTimer);

            if (_gameManager && _gameManager.isDemoMode) return;
            if (!_homeTeam || !_homeTeam.activePlayer) return;

            const p = _homeTeam.activePlayer;

            if (isHolding) {
                // --- HOLD RELEASE (Charged Tackle) ---
                if (!p.hasBall) {
                    p.releaseTackle();
                }
                isHolding = false;
            } else {
                // --- TAP (Tackle / Evade) ---
                const now = Date.now();
                const timeSinceLast = now - lastTapTime;

                if (timeSinceLast < DOUBLE_TAP_THRESHOLD) {
                    // --- DOUBLE TAP: EVADE ---
                    // Force cancel dash if active to allow immediate evade
                    if (p.isDashing || p.dashCooldown > 0) {
                        p.isDashing = false;
                        p.dashCooldown = 0;
                    }
                    p.evade();
                    lastTapTime = 0; // Reset to prevent triple-tap issues
                } else {
                    // --- SINGLE TAP: TACKLE / BREAK ---
                    if (!p.hasBall) {
                        // Defensive Tackle
                        let dashX = p.inputVector.x;
                        let dashZ = p.inputVector.z;

// If not moving, dash forward relative to player facing
                        if (Math.abs(dashX) < 0.1 && Math.abs(dashZ) < 0.1) {
                            const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                            dashX = fwd.x;
                            dashZ = fwd.z;
                        }

                        if (window.flux.gameInstance.floatingText && p.isDashing) {
                            window.flux.gameInstance.floatingText.spawn("TACKLE!", p.mesh.position, "tech");
                        }
                    } else if (p.isEngaged) {
                        // Offensive Break Tackle
                        p.dash(p.inputVector.x, p.inputVector.z);
                    }
                    
                    lastTapTime = now;
                }
            }
        };

        tackleBtn.addEventListener('touchstart', handleStart, { passive: false });
        tackleBtn.addEventListener('touchend', handleEnd, { passive: false });
        
        tackleBtn.addEventListener('mousedown', handleStart);
        tackleBtn.addEventListener('mouseup', handleEnd);
        tackleBtn.addEventListener('mouseleave', (e) => {
             if (isHolding || holdTimer) handleEnd(e);
        });
    }

    // NEW: Settings Button Setup
// NEW: Settings Button Setup
function setupSettingsButton() {
        const settingsBtn = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');

        if (!settingsBtn || !settingsPanel) return;

        settingsBtn.addEventListener('click', () => {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });
        }

        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        if (sensitivitySlider) {
            sensitivitySlider.value = _settings.joystickSensitivity * 100;
            sensitivitySlider.addEventListener('input', (e) => {
                _settings.joystickSensitivity = e.target.value / 100;
            });
        }

        // Aim assist toggle
        const aimAssistToggle = document.getElementById('aim-assist-toggle');
        if (aimAssistToggle) {
            aimAssistToggle.checked = _settings.aimAssist;
            aimAssistToggle.addEventListener('change', (e) => {
                _settings.aimAssist = e.target.checked;
            });
        }

        // Camera shake toggle
        const shakeToggle = document.getElementById('shake-toggle');
        if (shakeToggle) {
            shakeToggle.checked = _settings.cameraShake;
            shakeToggle.addEventListener('change', (e) => {
                _settings.cameraShake = e.target.checked;
            });
        }

        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider && _audioManager) {
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value / 100;
_audioManager.setMasterVolume(vol);
            });
        }

        // Exit to Menu
        const exitBtn = document.getElementById('exit-to-menu-btn');
        if (exitBtn) {
            exitBtn.addEventListener('click', () => {
                if (_menuManager) {
                    _menuManager.show();
                    if (_gameManager) {
                        _gameManager.state = 'menu';
                        // Stop practice if running
                        if (_gameManager.practiceManager) {
                            _gameManager.practiceManager.stop();
                        }
                    }
                    settingsPanel.style.display = 'none';
                }
            });
        }
    }

function updateInputVector() {
        let x = _input.x || 0;
        let z = _input.y || 0;

        if (_keys['w'] || _keys['ArrowUp']) z -= 1;
        if (_keys['s'] || _keys['ArrowDown']) z += 1;
        if (_keys['a'] || _keys['ArrowLeft']) x -= 1;
        if (_keys['d'] || _keys['ArrowRight']) x += 1;

        const lenSq = x*x + z*z;
        if (lenSq > 1) {
            const len = Math.sqrt(lenSq);
            x /= len;
            z /= len;
        }

        if (isNaN(x)) x = 0;
        if (isNaN(z)) z = 0;

        if (_camera) {
            _camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(_camFwd, _upAxis).normalize();
        } else {
            _camFwd.set(0, 0, -1);
            _camRight.set(1, 0, 0);
        }

        let worldX = (_camFwd.x * -z) + (_camRight.x * x);
        let worldZ = (_camFwd.z * -z) + (_camRight.z * x);

        if (isNaN(worldX) || isNaN(worldZ)) {
            worldX = 0;
            worldZ = 0;
        }

if (_homeTeam && _homeTeam.activePlayer) {
            // FIX: Only allow movement if game is active or in practice
            const gm = window.flux.gameInstance;
            const canMove = gm && !gm.isDemoMode && (gm.state === 'active');
            
            if (canMove) {
                _homeTeam.activePlayer.setInput(worldX, worldZ);
            } else {
                _homeTeam.activePlayer.setInput(0, 0);
            }
        }
}

    function createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        document.getElementById('ui-layer').appendChild(ripple);

        setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
        }, 600);

    }

    // NEW: Visual Swipe Trail
    function createSwipeTrailDot(x, y) {
        const dot = document.createElement('div');
        dot.className = 'swipe-trail-dot';
        dot.style.left = `${x - 6}px`; // Center (12px width)
        dot.style.top = `${y - 6}px`;
        document.getElementById('ui-layer').appendChild(dot);
        
        // CSS animation handles removal, but we clean up DOM to be safe
        setTimeout(() => {
            if (dot.parentNode) dot.parentNode.removeChild(dot);
        }, 500);
    }

function onResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        if (_camera) {
            _camera.aspect = width / height;
            _camera.updateProjectionMatrix();
            // Force immediate camera update to prevent jump
            if (_cameraManager) _cameraManager.update(0);
        }
        
        // Strictly 0.50 as requested for performance
// Performance Optimization: Cap resolution
const maxDimension = 480; // Hard cap on internal render resolution (Reduced for performance)
        const currentMax = Math.max(width, height);
        let resScale = 0.50; // Base scale
        
        if (currentMax * resScale > maxDimension) {
            resScale = maxDimension / currentMax;
        }
        
        _config.internalWidth = Math.floor(width * resScale);
        _config.internalHeight = Math.floor(height * resScale);
if (_renderer) {
            _renderer.setSize(_config.internalWidth, _config.internalHeight, false);
            if (_postProcessing) _postProcessing.setSize(_config.internalWidth, _config.internalHeight);
        }
    }

// --- FIXED TIMESTEP VARIABLES ---
    let _accumulator = 0;
    const _fixedStep = 1 / 60;

    function animate() {
        requestAnimationFrame(animate);

        const rawDt = _clock.getDelta();
        // Clamp dt to prevent spirals (max 0.1s)
        const dt = Math.min(rawDt, 0.1) * (window.flux.timeScale !== undefined ? window.flux.timeScale : 0.8);

        // Perf stats for DevTools
        if (window.flux && window.flux._debugIO && window.flux._debugIO.perf) {
            const perf = window.flux._debugIO.perf;
            perf.frame = (perf.frame || 0) + 1;
            perf.rawDt = rawDt;
            perf.dt = dt;
            const fps = dt > 0 ? (1 / dt) : 0;
            perf.fps = fps;
            perf.avgFps = (perf.avgFps && perf.avgFps > 0) ? (perf.avgFps * 0.9 + fps * 0.1) : fps;
        }

        // Impact Frames (Freeze Frame Effect)
// Impact Frames (Freeze Frame Effect) - Disabled
        // if (_gameManager && _gameManager.impactPause > 0) { ... }

        updateInputVector();

        // Action Buffer Processing
        if (_actionBuffer.active) {
            if (Date.now() - _actionBuffer.timestamp > _actionBuffer.duration) {
                _actionBuffer.active = false;
            } else {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                        p.startCharge();
                        const btn = document.getElementById('action-button');
                        if (btn) btn.classList.add('active');
                        _actionBuffer.active = false;
                    }
                }
            }
        }

        // --- FIXED UPDATE LOOP (Physics & Game Logic) ---
        _accumulator += dt;
        // Safety Cap: Prevent spiral of death if frame takes too long
if (_accumulator > 0.1) _accumulator = 0.1; // Cap at 100ms to prevent spiral of death

        while (_accumulator >= _fixedStep) {
            const _sdt = _fixedStep;

            if (_gameManager) _gameManager.update(_sdt);

            // If in Asset Forge mode, skip game logic
            if (_gameManager && _gameManager.isForgeMode) {
                _accumulator = 0; 
                return;
            }

            const gmState = _gameManager ? _gameManager.state : '';
            const isIntro = gmState === 'intro';
            const isMenu = gmState === 'menu';

            // Update Entities (Physics/AI)
            if (_homeTeam && !isIntro && !isMenu) {
                _homeTeam.update(_sdt);
                _homeTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_awayTeam && !isIntro && !isMenu) {
                _awayTeam.update(_sdt);
                _awayTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_ball && !isIntro && !isMenu) {
                _ball.update(_sdt);
            }

            // Ball Lab
            if (window.flux && window.flux.ballLab && typeof window.flux.ballLab.update === 'function') {
                window.flux.ballLab.update(_sdt);
            }

            // Runtime Updaters (e.g. Rings logic)
            if (window.flux && window.flux._runtimeUpdaters && window.flux._runtimeUpdaters.length) {
                for (let ui = 0; ui < window.flux._runtimeUpdaters.length; ui++) {
                    const fn = window.flux._runtimeUpdaters[ui];
                    if (typeof fn === 'function') fn(_sdt);
                }
            }

            _accumulator -= _fixedStep;
        }

        // --- VISUAL UPDATE LOOP (Once Per Frame) ---
        // These systems don't affect gameplay outcome, so we update them with the visual delta `dt`
        // to ensure smooth animation at high refresh rates (90/120Hz) without wasting CPU on physics.

        const gmState = _gameManager ? _gameManager.state : '';
        const isIntro = gmState === 'intro';
        const isMenu = gmState === 'menu';

        // Camera
        if (!isIntro && !isMenu) {
            updateCameraLogic(dt);
        }

        // Visual FX Systems
        if (_waterOverlay) _waterOverlay.update(dt);
        if (_lightShafts) _lightShafts.update(dt);
        if (_stadium) _stadium.update(dt);
        if (_glyphManager) _glyphManager.update(dt);

if (_glyphManager) _glyphManager.update(dt);
        if (_gameManager) _gameManager.updateVisuals(dt);
        
        // ArenaThemeManager updated in GameManager.update() (Physics Loop)
// ArenaThemeManager updated in GameManager.update() (Physics Loop)
_arenaUniforms.uImpactStr.value *= Math.max(0, 1.0 - dt * 3.0); // Slower decay for viscous stretch

        if (window.flux.arenaGroup) {
            window.flux.arenaGroup.rotation.y += dt * 0.05;
        }

        if (window.flux.tribalUniforms) {
            window.flux.tribalUniforms.uTime.value += dt;
            let targetColor = new THREE.Color(0x00ffff);
            if (_ball && _ball.holder) {
                if (_ball.holder.team && _ball.holder.team.side === -1) {
                    targetColor.setHex(0xff8800);
                }
            }
            window.flux.tribalUniforms.uColor.value.lerp(targetColor, dt * 2.0);
        }

        if (_particleUniforms) {
            _particleUniforms.uTime.value += dt;
        }

        // Render
// Render
        if (_renderer && _scene && _camera) {
            if (_postProcessing) {
                _postProcessing.render(_scene, _camera, dt);
            } else {
                _renderer.render(_scene, _camera);
            }
        }
        // UI Updates
        updateUI();
    }

function updateUI() {
        // Prevent UI updates during intro to keep things hidden
        if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') return;

        if (!_homeTeam || !_homeTeam.activePlayer) return;
        const btn = document.getElementById('action-button');
        const lbl = document.getElementById('action-label');
        const tackleBtn = document.getElementById('tackle-button');
        const p = _homeTeam.activePlayer;

        if (btn && lbl) {
            const btnText = btn.querySelector('.btn-text');

            if (p.hasBall) {
                if (btnText && btnText.innerText !== "ACTION") {
                    btnText.innerText = "ACTION";
                    btn.classList.add('shoot-mode');
                    lbl.innerText = "OFFENSE";
                    lbl.classList.add('shoot-label');
                }

                const isHighEnergy = (p.stats.HP / p.stats.maxHP) > 0.4;
                if (isHighEnergy) {
                    if (!btn.classList.contains('limit-ready')) btn.classList.add('limit-ready');
                } else {
                    if (btn.classList.contains('limit-ready')) btn.classList.remove('limit-ready');
                }

} else {
                if (p.isBlocking) {
                    if (btnText && btnText.innerText !== "BLOCK") {
                        btnText.innerText = "BLOCK";
                        btn.classList.add('active'); // Ensure visual feedback
                        lbl.innerText = "DEFENSE";
                    }
                } else {
                    if (btnText && btnText.innerText !== "SWIM") {
                        btnText.innerText = "SWIM";
                        btn.classList.remove('shoot-mode');
                        btn.classList.remove('limit-ready');
                        btn.classList.remove('active');
                        lbl.innerText = "NORMAL";
                        lbl.classList.remove('shoot-label');
                    }
                }
            }
        }

        // Update tackle button visibility
        if (tackleBtn) {
            if (!p.hasBall || p.isEngaged) {
                tackleBtn.style.display = 'flex';
                // Update tackle button text based on context
                const tackleText = tackleBtn.querySelector('.btn-text');
                if (tackleText) {
                    if (p.isEngaged && p.hasBall) {
                        tackleText.innerText = 'BREAK';
                        tackleBtn.classList.add('urgent');
                    } else {
                        tackleText.innerText = 'TACKLE';
                        tackleBtn.classList.remove('urgent');
                    }
                }
            } else {
                tackleBtn.style.display = 'none';
            }
        }

        // Update distance to goal indicator
        const distIndicator = document.getElementById('goal-distance');
        if (distIndicator && p.mesh) {
            const goalZ = (p.team && p.team.side === 1) ? -28 : 28;
            const dist = Math.abs(p.mesh.position.z - goalZ);
            distIndicator.innerText = `${Math.floor(dist)}m`;
        }
    }

function updateCameraLogic(dt) {
        if (!_cameraManager || !_ball) return;

        let targetMesh = _ball.mesh;
        let targetVel = _ball.velocity;
        let targetInput = null;
        let isAiming = false;

        if (_ball.holder && _ball.holder.mesh) {
            targetMesh = _ball.holder.mesh;
            targetVel = _ball.holder.velocity;
            if (_ball.holder.inputVector) {
                targetInput = _ball.holder.inputVector;
            }
// Check aiming state (Charging or Throwing)
            if (_ball.holder.isCharging || _ball.holder.isThrowing) {
                isAiming = true;
            }
        }

        _cameraManager.setTarget(targetMesh, targetVel, targetInput, isAiming);
        _cameraManager.update(dt);
    }

function checkBallGrab(entity) {
        if (!entity.canCatch) return;
        if (_ball && !_ball.isCatchable()) return;
        if (entity.stunTimer > 0 || (entity.status && entity.status.nap > 0)) return;
        if (_ball.state !== 'free') return;
        if (!_ball.mesh || !entity.mesh) return;

        const ballPos = _ball.mesh.position;
        const entPos = entity.mesh.position;

        const dx = ballPos.x - entPos.x;
        const dz = ballPos.z - entPos.z;
        const distXZ = Math.sqrt(dx*dx + dz*dz);
        const distY = Math.abs(ballPos.y - entPos.y);

        // --- RELAXED TOLERANCES FOR EASIER PICKUP ---
        const touchRadius = 1.5; // Increased from 1.0 (Auto-grab radius)
        let magnetRadius = 3.5;  // Increased from 1.8 (Magnetic radius)
        let interactionRadius = 6.0; // Increased from 3.5 (Turn-to radius)
        let catchHeight = 6.0;   // Increased from 3.0 (Vertical reach)

        if (entity.isDashing) {
            magnetRadius = 4.5;
            interactionRadius = 7.0;
            catchHeight = 7.0;
        }

        if (distXZ > interactionRadius || distY > catchHeight) return;

        // Optimization: Use shared vectors to avoid GC
        _tempVec1.copy(ballPos).sub(entPos).normalize(); // toBall
        _tempVec2.set(0, 0, 1).applyQuaternion(entity.mesh.quaternion).normalize(); // playerForward

        const facingDot = _tempVec2.dot(_tempVec1);

        const coneThreshold = -0.4; // More generous cone (was -0.2)
        const isInCone = facingDot > coneThreshold;
        
        // AUTO-TURN: If near but facing wrong way, turn towards ball
        if (distXZ < interactionRadius && !isInCone) {
            const targetAngle = Math.atan2(_tempVec1.x, _tempVec1.z);
            const q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);
            entity.mesh.quaternion.slerp(q, 0.2); // Faster turn (was 0.1)
            if (entity.syncRotation) entity.syncRotation();
        }

        // GRAB LOGIC
        // 1. Touch: Very close (ignore facing - prevents running over ball)
        // 2. Magnet: Close and facing
        const isTouch = distXZ < touchRadius;
        const isMagnet = distXZ < magnetRadius && isInCone;

        if (isTouch || isMagnet) {
            // BLAST THROUGH LOGIC
            const ballSpeed = _ball.velocity.length();
            let catchChance = 1.0;

            // If ball is moving fast (e.g. > 20), check CA
            if (ballSpeed > 20.0) {
                const ca = entity.getStat('CA');
                // Difficulty scales with speed. 
                const difficulty = ballSpeed * 1.2; 
                
                if (difficulty > ca) {
                    catchChance = 0.4 + (ca / difficulty) * 0.6;
                    
                    // Point Blank Penalty: Harder to react if ball is right on top of you moving fast
                    if (distXZ < 1.2) {
                        catchChance *= 0.6; // Blast through likely
                    }
                    
                    if (entity.isDashing) catchChance += 0.2;
                }
            } else if (_ball.powerType === 'SH' && _ball.power > 15.0) {
                // Shot power check
                const ca = entity.getStat('CA');
                if (_ball.power > ca * 1.2) {
                    const chance = Math.min(0.7, (_ball.power - ca) * 0.04);
                    catchChance = 1.0 - chance;
                }
            }

            let fumble = false;
            if (Math.random() > catchChance) {
                fumble = true;
            }

if (fumble) {
                if (window.flux.gameInstance.floatingText) {
                    // Visual feedback for blast through
                    window.flux.gameInstance.floatingText.spawn("BLAST THROUGH!", entPos, "damage");
                }

                // Apply Elemental Status on Fumble
                if (_ball.element) {
                    if (_ball.element === 'fire') entity.applyStatus('burn', 5.0);
                    else if (_ball.element === 'ice') entity.applyStatus('slow', 5.0);
                    else if (_ball.element === 'volt') entity.applyStatus('shock', 3.0);
                    else if (_ball.element === 'venom') entity.applyStatus('venom', 10.0);
                    else if (_ball.element === 'wither') entity.applyStatus('wither', 10.0, 'CA');
                    else if (_ball.element === 'nap') entity.applyStatus('nap', 5.0);
                }
                
                // Deflect slightly but keep moving fast (Blast Through)
                // Don't stop it completely like a block, just perturb it
                _ball.velocity.multiplyScalar(0.85); 
                _ball.velocity.x += (Math.random()-0.5) * 5.0;
                _ball.velocity.y += (Math.random()) * 5.0; // Pop up
                _ball.velocity.z += (Math.random()-0.5) * 5.0;
                
                _ball.power *= 0.7;

                entity.canCatch = false;
                // Stun briefly
                entity.stunTimer = 0.5;
                if(entity.play) entity.play('react', 0.1);
                
                entity.catchCooldown = 1.0;

            } else {
                _ball.magnetize(entity);
            }
        }
    }

    // Start
    init();
})();</script>


</body></html>